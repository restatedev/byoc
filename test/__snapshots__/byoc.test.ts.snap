// Jest Snapshot v1, https://goo.gl/fbAQLP

exports[`BYOC Dashboards can be completely disabled 1`] = `
"Resources:
  testsecuritygroupB015C031:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      GroupDescription: RestateBYOC/test/security-group
      SecurityGroupEgress:
        - CidrIp: 0.0.0.0/0
          Description: Allow all outbound traffic by default
          IpProtocol: '-1'
      Tags:
        - Key: Name
          Value: RestateBYOC/test/security-group
      VpcId:
        'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcA2121C384D1B3CDE'
  testsecuritygroupfromRestateBYOCtestsecuritygroupDC099EC280804D6652A7:
    Type: 'AWS::EC2::SecurityGroupIngress'
    Properties:
      Description: 'from RestateBYOCtestsecuritygroupDC099EC2:8080'
      FromPort: 8080
      GroupId:
        'Fn::GetAtt':
          - testsecuritygroupB015C031
          - GroupId
      IpProtocol: tcp
      SourceSecurityGroupId:
        'Fn::GetAtt':
          - testsecuritygroupB015C031
          - GroupId
      ToPort: 8080
  testsecuritygroupfromRestateBYOCtestsecuritygroupDC099EC2907024D2BE0B:
    Type: 'AWS::EC2::SecurityGroupIngress'
    Properties:
      Description: 'from RestateBYOCtestsecuritygroupDC099EC2:9070'
      FromPort: 9070
      GroupId:
        'Fn::GetAtt':
          - testsecuritygroupB015C031
          - GroupId
      IpProtocol: tcp
      SourceSecurityGroupId:
        'Fn::GetAtt':
          - testsecuritygroupB015C031
          - GroupId
      ToPort: 9070
  testsecuritygroupfromRestateBYOCtestsecuritygroupDC099EC25122D07222D4:
    Type: 'AWS::EC2::SecurityGroupIngress'
    Properties:
      Description: 'from RestateBYOCtestsecuritygroupDC099EC2:5122'
      FromPort: 5122
      GroupId:
        'Fn::GetAtt':
          - testsecuritygroupB015C031
          - GroupId
      IpProtocol: tcp
      SourceSecurityGroupId:
        'Fn::GetAtt':
          - testsecuritygroupB015C031
          - GroupId
      ToPort: 5122
  testbucket731B7DE2:
    Type: 'AWS::S3::Bucket'
    Properties:
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
    UpdateReplacePolicy: Retain
    DeletionPolicy: Retain
  testbucketPolicyB4FDDA54:
    Type: 'AWS::S3::BucketPolicy'
    Properties:
      Bucket:
        Ref: testbucket731B7DE2
      PolicyDocument:
        Statement:
          - Action: 's3:*'
            Condition:
              Bool:
                'aws:SecureTransport': 'false'
            Effect: Deny
            Principal:
              AWS: '*'
            Resource:
              - 'Fn::GetAtt':
                  - testbucket731B7DE2
                  - Arn
              - 'Fn::Join':
                  - ''
                  - - 'Fn::GetAtt':
                        - testbucket731B7DE2
                        - Arn
                    - /*
        Version: '2012-10-17'
  testclusterDBD4D436:
    Type: 'AWS::ECS::Cluster'
    Properties:
      ClusterSettings:
        - Name: containerInsights
          Value: enhanced
      Tags:
        - Key: Name
          Value: RestateBYOC/test/cluster
  testrestatetaskrole4CC243A3:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
        Version: '2012-10-17'
  testrestatetaskroleDefaultPolicy51A222FD:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 's3:GetObject'
              - 's3:PutObject'
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'Fn::GetAtt':
                      - testbucket731B7DE2
                      - Arn
                  - /*
            Sid: ReadWriteBucket
          - Action: 's3:ListBucket'
            Effect: Allow
            Resource:
              'Fn::GetAtt':
                - testbucket731B7DE2
                - Arn
            Sid: ListBucket
        Version: '2012-10-17'
      PolicyName: testrestatetaskroleDefaultPolicy51A222FD
      Roles:
        - Ref: testrestatetaskrole4CC243A3
  testrestateexecutionrole4CD7F161:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
        Version: '2012-10-17'
  testrestateexecutionroleDefaultPolicy04DC59EF:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 'logs:CreateLogStream'
              - 'logs:PutLogEvents'
            Effect: Allow
            Resource:
              'Fn::GetAtt':
                - testrestateloggroup6C0DD0DD
                - Arn
        Version: '2012-10-17'
      PolicyName: testrestateexecutionroleDefaultPolicy04DC59EF
      Roles:
        - Ref: testrestateexecutionrole4CD7F161
  testrestateloggroup6C0DD0DD:
    Type: 'AWS::Logs::LogGroup'
    Properties:
      RetentionInDays: 30
    UpdateReplacePolicy: Retain
    DeletionPolicy: Retain
  testcontrollerloggroupB61E47AC:
    Type: 'AWS::Logs::LogGroup'
    Properties:
      RetentionInDays: 30
    UpdateReplacePolicy: Retain
    DeletionPolicy: Retain
  testsharednlb6BC10CBB:
    Type: 'AWS::ElasticLoadBalancingV2::LoadBalancer'
    Properties:
      LoadBalancerAttributes:
        - Key: deletion_protection.enabled
          Value: 'false'
        - Key: load_balancing.cross_zone.enabled
          Value: 'false'
        - Key: dns_record.client_routing_policy
          Value: availability_zone_affinity
      Scheme: internal
      SecurityGroups:
        - 'Fn::GetAtt':
            - testsecuritygroupB015C031
            - GroupId
      Subnets:
        - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet1Subnet934893E8236E2271'
        - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet2Subnet7031C2BA60DCB1EE'
        - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet3Subnet985AC459F9514491'
      Tags:
        - Key: Name
          Value: RestateBYOC/test/shared-nlb
      Type: network
  testingresssharedlistenerF18D3E56:
    Type: 'AWS::ElasticLoadBalancingV2::Listener'
    Properties:
      DefaultActions:
        - TargetGroupArn:
            Ref: testingresssharedtarget779E3570
          Type: forward
      LoadBalancerArn:
        Ref: testsharednlb6BC10CBB
      Port: 8080
      Protocol: TCP
  testadminsharedlistener6D147D79:
    Type: 'AWS::ElasticLoadBalancingV2::Listener'
    Properties:
      DefaultActions:
        - TargetGroupArn:
            Ref: testadminsharedtarget0C095FA8
          Type: forward
      LoadBalancerArn:
        Ref: testsharednlb6BC10CBB
      Port: 9070
      Protocol: TCP
  testnodesharedlistener98A38BFD:
    Type: 'AWS::ElasticLoadBalancingV2::Listener'
    Properties:
      DefaultActions:
        - TargetGroupArn:
            Ref: testnodesharedtarget6337BC22
          Type: forward
      LoadBalancerArn:
        Ref: testsharednlb6BC10CBB
      Port: 5122
      Protocol: TCP
  teststatelessdefinition64DABAD1:
    Type: 'AWS::ECS::TaskDefinition'
    Properties:
      ContainerDefinitions:
        - Cpu: 16384
          EntryPoint:
            - bash
            - '-c'
            - >

              curl --no-progress-meter $ECS_CONTAINER_METADATA_URI_V4 -o
              container-metadata && \\

              curl --no-progress-meter $ECS_CONTAINER_METADATA_URI_V4/task -o
              task-metadata && \\

              export \\
                RESTATE_NODE_NAME=$(jq -r '.TaskARN' task-metadata) \\
                RESTATE_LOCATION="$AWS_REGION.$(jq -r '.AvailabilityZone' task-metadata)" \\
                RESTATE_ADVERTISED_ADDRESS="http://$(jq -r '.Networks[0].IPv4Addresses[0]' container-metadata):5122"
              exec restate-server
          Environment:
            - Name: RESTATE_LOG_FORMAT
              Value: json
            - Name: RESTATE_CLUSTER_NAME
              Value: RestateBYOC/test
            - Name: RESTATE_ROLES
              Value: '["admin","http-ingress"]'
            - Name: RESTATE_AUTO_PROVISION
              Value: 'true'
            - Name: RESTATE_SHUTDOWN_TIMEOUT
              Value: 100s
            - Name: RESTATE_DEFAULT_NUM_PARTITIONS
              Value: '128'
            - Name: RESTATE_DEFAULT_REPLICATION
              Value: '{zone: 2}'
            - Name: RESTATE_METADATA_CLIENT__TYPE
              Value: object-store
            - Name: RESTATE_METADATA_CLIENT__PATH
              Value:
                'Fn::Join':
                  - ''
                  - - 's3://'
                    - Ref: testbucket731B7DE2
                    - /metadata
            - Name: RESTATE_BIFROST__DEFAULT_PROVIDER
              Value: replicated
            - Name: >-
                RESTATE_INGRESS__EXPERIMENTAL_FEATURE_ENABLE_SEPARATE_INGRESS_ROLE
              Value: 'true'
            - Name: RESTATE_INGRESS__ADVERTISED_INGRESS_ENDPOINT
              Value:
                'Fn::Join':
                  - ''
                  - - 'http://'
                    - 'Fn::GetAtt':
                        - testsharednlb6BC10CBB
                        - DNSName
                    - ':8080'
            - Name: RESTATE_WORKER__SNAPSHOTS__DESTINATION
              Value:
                'Fn::Join':
                  - ''
                  - - 's3://'
                    - Ref: testbucket731B7DE2
                    - /snapshots
          Essential: true
          HealthCheck:
            Command:
              - CMD
              - curl
              - '--fail'
              - 'http://127.0.0.1:8080/restate/health'
            Interval: 30
            Retries: 3
            Timeout: 5
          Image: Any<Object>
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group:
                Ref: testrestateloggroup6C0DD0DD
              awslogs-stream-prefix: restate
              awslogs-region: region
              mode: non-blocking
          Memory: 32768
          Name: restate
          PortMappings:
            - ContainerPort: 8080
              Name: ingress
              Protocol: tcp
            - ContainerPort: 9070
              Name: admin
              Protocol: tcp
            - ContainerPort: 5122
              Name: node
              Protocol: tcp
          StopTimeout: 120
      Cpu: '16384'
      ExecutionRoleArn:
        'Fn::GetAtt':
          - testrestateexecutionrole4CD7F161
          - Arn
      Family: RestateBYOCteststatelessdefinitionA59C4856
      Memory: '32768'
      NetworkMode: awsvpc
      RequiresCompatibilities:
        - FARGATE
      RuntimePlatform:
        CpuArchitecture: ARM64
        OperatingSystemFamily: LINUX
      Tags:
        - Key: Name
          Value: RestateBYOC/test/stateless-definition
      TaskRoleArn:
        'Fn::GetAtt':
          - testrestatetaskrole4CC243A3
          - Arn
  teststatelessserviceService5CDEA5F0:
    Type: 'AWS::ECS::Service'
    Properties:
      AvailabilityZoneRebalancing: ENABLED
      Cluster:
        Ref: testclusterDBD4D436
      DeploymentConfiguration:
        Alarms:
          AlarmNames: []
          Enable: false
          Rollback: false
        MaximumPercent: 200
        MinimumHealthyPercent: 100
      DeploymentController:
        Type: ECS
      DesiredCount: 3
      EnableECSManagedTags: false
      EnableExecuteCommand: false
      HealthCheckGracePeriodSeconds: 60
      LaunchType: FARGATE
      LoadBalancers:
        - ContainerName: restate
          ContainerPort: 8080
          TargetGroupArn:
            Ref: testingresssharedtarget779E3570
        - ContainerName: restate
          ContainerPort: 9070
          TargetGroupArn:
            Ref: testadminsharedtarget0C095FA8
        - ContainerName: restate
          ContainerPort: 5122
          TargetGroupArn:
            Ref: testnodesharedtarget6337BC22
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: DISABLED
          SecurityGroups:
            - 'Fn::GetAtt':
                - testsecuritygroupB015C031
                - GroupId
          Subnets:
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet1Subnet934893E8236E2271'
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet2Subnet7031C2BA60DCB1EE'
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet3Subnet985AC459F9514491'
      PropagateTags: SERVICE
      Tags:
        - Key: Name
          Value: RestateBYOC/test/stateless-service
      TaskDefinition:
        Ref: teststatelessdefinition64DABAD1
    DependsOn:
      - testadminsharedlistener6D147D79
      - testingresssharedlistenerF18D3E56
      - testnodesharedlistener98A38BFD
      - testrestatetaskroleDefaultPolicy51A222FD
      - testrestatetaskrole4CC243A3
  teststatefuldefinitionB92BAA14:
    Type: 'AWS::ECS::TaskDefinition'
    Properties:
      ContainerDefinitions:
        - Cpu: 16384
          EntryPoint:
            - bash
            - '-c'
            - >

              curl --no-progress-meter $ECS_CONTAINER_METADATA_URI_V4 -o
              container-metadata && \\

              curl --no-progress-meter $ECS_CONTAINER_METADATA_URI_V4/task -o
              task-metadata && \\

              export \\
                RESTATE_NODE_NAME=$(jq -r '.TaskARN' task-metadata) \\
                RESTATE_LOCATION="$AWS_REGION.$(jq -r '.AvailabilityZone' task-metadata)" \\
                RESTATE_ADVERTISED_ADDRESS="http://$(jq -r '.Networks[0].IPv4Addresses[0]' container-metadata):5122" \\
                RESTATE_ROCKSDB_TOTAL_MEMORY_SIZE="$(($(jq -r '.Limits.Memory' container-metadata) * 3 / 4))MiB" \\
                RESTATE_WORKER__STORAGE__NUM_PARTITIONS_TO_SHARE_MEMORY_BUDGET=$(("$RESTATE_WORKER__STORAGE__NUM_PARTITIONS_TO_SHARE_MEMORY_BUDGET"))
              exec restate-server
          Environment:
            - Name: RESTATE_LOG_FORMAT
              Value: json
            - Name: RESTATE_CLUSTER_NAME
              Value: RestateBYOC/test
            - Name: RESTATE_ROLES
              Value: '["log-server", "worker"]'
            - Name: RESTATE_AUTO_PROVISION
              Value: 'false'
            - Name: RESTATE_SHUTDOWN_TIMEOUT
              Value: 100s
            - Name: RESTATE_METADATA_CLIENT__TYPE
              Value: object-store
            - Name: RESTATE_METADATA_CLIENT__PATH
              Value:
                'Fn::Join':
                  - ''
                  - - 's3://'
                    - Ref: testbucket731B7DE2
                    - /metadata
            - Name: RESTATE_WORKER__SNAPSHOTS__DESTINATION
              Value:
                'Fn::Join':
                  - ''
                  - - 's3://'
                    - Ref: testbucket731B7DE2
                    - /snapshots
            - Name: RESTATE_WORKER__SNAPSHOTS__SNAPSHOT_INTERVAL_NUM_RECORDS
              Value: '1000000'
            - Name: RESTATE_WORKER__STORAGE__ROCKSDB_DISABLE_DIRECT_IO_FOR_READS
              Value: 'true'
            - Name: RESTATE_WORKER__STORAGE__ROCKSDB_DISABLE_WAL_FSYNC
              Value: 'true'
            - Name: RESTATE_WORKER__STORAGE__NUM_PARTITIONS_TO_SHARE_MEMORY_BUDGET
              Value: (128 * 2) / (3 * 1)
            - Name: RESTATE_LOG_SERVER__ROCKSDB_DISABLE_WAL_FSYNC
              Value: 'true'
            - Name: RESTATE_LOG_SERVER__ROCKSDB_DISABLE_DIRECT_IO_FOR_READS
              Value: 'true'
            - Name: >-
                RESTATE_INGRESS__EXPERIMENTAL_FEATURE_ENABLE_SEPARATE_INGRESS_ROLE
              Value: 'true'
          Essential: true
          HealthCheck:
            Command:
              - CMD
              - curl
              - '--fail'
              - 'http://127.0.0.1:5122/health'
            Interval: 30
            Retries: 3
            Timeout: 5
          Image: Any<Object>
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group:
                Ref: testrestateloggroup6C0DD0DD
              awslogs-stream-prefix: restate
              awslogs-region: region
              mode: non-blocking
          Memory: 32768
          MountPoints:
            - ContainerPath: /restate-data
              ReadOnly: false
              SourceVolume: restate-data
          Name: restate
          PortMappings:
            - ContainerPort: 5122
              Name: node
              Protocol: tcp
          RestartPolicy:
            Enabled: true
            RestartAttemptPeriod: 60
          StopTimeout: 120
      Cpu: '16384'
      EphemeralStorage:
        SizeInGiB: 200
      ExecutionRoleArn:
        'Fn::GetAtt':
          - testrestateexecutionrole4CD7F161
          - Arn
      Family: RestateBYOCteststatefuldefinition9B15D9BA
      Memory: '32768'
      NetworkMode: awsvpc
      RequiresCompatibilities:
        - FARGATE
      RuntimePlatform:
        CpuArchitecture: ARM64
        OperatingSystemFamily: LINUX
      Tags:
        - Key: Name
          Value: RestateBYOC/test/stateful-definition
      TaskRoleArn:
        'Fn::GetAtt':
          - testrestatetaskrole4CC243A3
          - Arn
      Volumes:
        - ConfiguredAtLaunch: false
          Name: restate-data
  testingresssharedtarget779E3570:
    Type: 'AWS::ElasticLoadBalancingV2::TargetGroup'
    Properties:
      HealthCheckEnabled: true
      HealthCheckIntervalSeconds: 5
      HealthCheckPath: /restate/health
      HealthCheckProtocol: HTTP
      HealthCheckTimeoutSeconds: 2
      Port: 8080
      Protocol: TCP
      Tags:
        - Key: Name
          Value: RestateBYOC/test/ingress-shared-target
      TargetType: ip
      VpcId:
        'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcA2121C384D1B3CDE'
  testadminsharedtarget0C095FA8:
    Type: 'AWS::ElasticLoadBalancingV2::TargetGroup'
    Properties:
      HealthCheckEnabled: true
      HealthCheckIntervalSeconds: 5
      HealthCheckPath: /health
      HealthCheckPort: '9070'
      HealthCheckProtocol: HTTP
      HealthCheckTimeoutSeconds: 2
      Port: 9070
      Protocol: TCP
      Tags:
        - Key: Name
          Value: RestateBYOC/test/admin-shared-target
      TargetType: ip
      VpcId:
        'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcA2121C384D1B3CDE'
  testnodesharedtarget6337BC22:
    Type: 'AWS::ElasticLoadBalancingV2::TargetGroup'
    Properties:
      HealthCheckEnabled: true
      HealthCheckIntervalSeconds: 5
      HealthCheckPath: /health
      HealthCheckPort: '5122'
      HealthCheckProtocol: HTTP
      HealthCheckTimeoutSeconds: 2
      Port: 5122
      Protocol: TCP
      Tags:
        - Key: Name
          Value: RestateBYOC/test/node-shared-target
      TargetType: ip
      VpcId:
        'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcA2121C384D1B3CDE'
  testcontrollertaskrole42417C6E:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
        Version: '2012-10-17'
  testcontrollertaskroleDefaultPolicy030D6236:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action: 'ecs:ListTasks'
            Condition:
              ArnEquals:
                'ecs:cluster':
                  'Fn::GetAtt':
                    - testclusterDBD4D436
                    - Arn
            Effect: Allow
            Resource: '*'
            Sid: ECSListActions
          - Action:
              - 'ecs:TagResource'
              - 'ecs:DescribeTasks'
              - 'ecs:StopTask'
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'Fn::Join':
                      - /
                      - - 'Fn::Join':
                            - ':'
                            - - 'Fn::Select':
                                  - 0
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - testclusterDBD4D436
                                                  - Arn
                              - 'Fn::Select':
                                  - 1
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - testclusterDBD4D436
                                                  - Arn
                              - 'Fn::Select':
                                  - 2
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - testclusterDBD4D436
                                                  - Arn
                              - 'Fn::Select':
                                  - 3
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - testclusterDBD4D436
                                                  - Arn
                              - 'Fn::Select':
                                  - 4
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - testclusterDBD4D436
                                                  - Arn
                              - task
                        - 'Fn::Select':
                            - 1
                            - 'Fn::Split':
                                - /
                                - 'Fn::GetAtt':
                                    - testclusterDBD4D436
                                    - Arn
                        - ''
                  - '*'
            Sid: TaskActions
          - Action: 'ecs:RunTask'
            Condition:
              ArnEquals:
                'ecs:cluster':
                  'Fn::GetAtt':
                    - testclusterDBD4D436
                    - Arn
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'Fn::Join':
                      - ':'
                      - - 'Fn::Select':
                            - 0
                            - 'Fn::Split':
                                - ':'
                                - Ref: teststatefuldefinitionB92BAA14
                        - 'Fn::Select':
                            - 1
                            - 'Fn::Split':
                                - ':'
                                - Ref: teststatefuldefinitionB92BAA14
                        - 'Fn::Select':
                            - 2
                            - 'Fn::Split':
                                - ':'
                                - Ref: teststatefuldefinitionB92BAA14
                        - 'Fn::Select':
                            - 3
                            - 'Fn::Split':
                                - ':'
                                - Ref: teststatefuldefinitionB92BAA14
                        - 'Fn::Select':
                            - 4
                            - 'Fn::Split':
                                - ':'
                                - Ref: teststatefuldefinitionB92BAA14
                        - 'Fn::Select':
                            - 5
                            - 'Fn::Split':
                                - ':'
                                - Ref: teststatefuldefinitionB92BAA14
                  - ':*'
            Sid: RunTask
          - Action: 'iam:PassRole'
            Condition:
              StringEquals:
                'iam:PassedToService': ecs-tasks.amazonaws.com
            Effect: Allow
            Resource:
              - 'Fn::GetAtt':
                  - testrestatetaskrole4CC243A3
                  - Arn
              - 'Fn::GetAtt':
                  - testrestateexecutionrole4CD7F161
                  - Arn
            Sid: RunTaskPassRole
          - Action:
              - 'ec2:DescribeVolumes'
              - 'ec2:DescribeSnapshots'
            Effect: Allow
            Resource: '*'
            Sid: EC2ListActions
          - Action: 'ec2:CreateSnapshot'
            Condition:
              ArnEquals:
                'aws:RequestTag/restate:ecsClusterArn':
                  'Fn::GetAtt':
                    - testclusterDBD4D436
                    - Arn
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'arn:'
                  - Ref: 'AWS::Partition'
                  - ':ec2:'
                  - Ref: 'AWS::Region'
                  - '::snapshot/*'
            Sid: CreateSnapshot
          - Action: 'ec2:CreateSnapshot'
            Condition:
              ArnEquals:
                'aws:ResourceTag/restate:ecsClusterArn':
                  'Fn::GetAtt':
                    - testclusterDBD4D436
                    - Arn
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'arn:'
                  - Ref: 'AWS::Partition'
                  - ':ec2:'
                  - Ref: 'AWS::Region'
                  - ':'
                  - Ref: 'AWS::AccountId'
                  - ':volume/*'
            Sid: SnapshotVolume
          - Action: 'ec2:CreateTags'
            Condition:
              StringEquals:
                'ec2:CreateAction': CreateSnapshot
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'arn:'
                  - Ref: 'AWS::Partition'
                  - ':ec2:'
                  - Ref: 'AWS::Region'
                  - '::snapshot/*'
            Sid: TagSnapshots
          - Action:
              - 'ec2:DeleteVolume'
              - 'ec2:DeleteSnapshot'
            Condition:
              ArnEquals:
                'aws:ResourceTag/restate:ecsClusterArn':
                  'Fn::GetAtt':
                    - testclusterDBD4D436
                    - Arn
            Effect: Allow
            Resource:
              - 'Fn::Join':
                  - ''
                  - - 'arn:'
                    - Ref: 'AWS::Partition'
                    - ':ec2:'
                    - Ref: 'AWS::Region'
                    - ':'
                    - Ref: 'AWS::AccountId'
                    - ':volume/*'
              - 'Fn::Join':
                  - ''
                  - - 'arn:'
                    - Ref: 'AWS::Partition'
                    - ':ec2:'
                    - Ref: 'AWS::Region'
                    - '::snapshot/*'
            Sid: DeleteVolumeAndSnapshot
          - Action:
              - 's3:GetObject'
              - 's3:PutObject'
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'Fn::GetAtt':
                      - testbucket731B7DE2
                      - Arn
                  - /*
            Sid: ReadWriteBucket
          - Action: 's3:ListBucket'
            Effect: Allow
            Resource:
              'Fn::GetAtt':
                - testbucket731B7DE2
                - Arn
            Sid: ListBucket
        Version: '2012-10-17'
      PolicyName: testcontrollertaskroleDefaultPolicy030D6236
      Roles:
        - Ref: testcontrollertaskrole42417C6E
  testcontrollerexecutionrole3BE0C8C4:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
        Version: '2012-10-17'
  testcontrollerexecutionroleDefaultPolicy443CB52A:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 'logs:CreateLogStream'
              - 'logs:PutLogEvents'
            Effect: Allow
            Resource:
              'Fn::GetAtt':
                - testcontrollerloggroupB61E47AC
                - Arn
        Version: '2012-10-17'
      PolicyName: testcontrollerexecutionroleDefaultPolicy443CB52A
      Roles:
        - Ref: testcontrollerexecutionrole3BE0C8C4
  testcontrollerdefinition0C4BC223:
    Type: 'AWS::ECS::TaskDefinition'
    Properties:
      ContainerDefinitions:
        - Cpu: 1024
          Environment:
            - Name: RUST_LOG
              Value: 'info,restate_fargate_controller=debug'
            - Name: CONTROLLER_LOG_FORMAT
              Value: json
            - Name: CONTROLLER_METADATA_PATH
              Value:
                'Fn::Join':
                  - ''
                  - - 's3://'
                    - Ref: testbucket731B7DE2
                    - /metadata
            - Name: CONTROLLER_RECONCILE_INTERVAL
              Value: 10s
            - Name: CONTROLLER_CLUSTER__CLUSTER_ARN
              Value:
                'Fn::GetAtt':
                  - testclusterDBD4D436
                  - Arn
            - Name: CONTROLLER_LICENSE_KEY
              Value: foo
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __REGION
              Value:
                Ref: 'AWS::Region'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __CLUSTER_ARN
              Value:
                'Fn::GetAtt':
                  - testclusterDBD4D436
                  - Arn
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __TASK_PREFIX
              Value:
                'Fn::Join':
                  - /
                  - - 'Fn::Join':
                        - ':'
                        - - 'Fn::Select':
                              - 0
                              - 'Fn::Split':
                                  - ':'
                                  - 'Fn::Select':
                                      - 0
                                      - 'Fn::Split':
                                          - /
                                          - 'Fn::GetAtt':
                                              - testclusterDBD4D436
                                              - Arn
                          - 'Fn::Select':
                              - 1
                              - 'Fn::Split':
                                  - ':'
                                  - 'Fn::Select':
                                      - 0
                                      - 'Fn::Split':
                                          - /
                                          - 'Fn::GetAtt':
                                              - testclusterDBD4D436
                                              - Arn
                          - 'Fn::Select':
                              - 2
                              - 'Fn::Split':
                                  - ':'
                                  - 'Fn::Select':
                                      - 0
                                      - 'Fn::Split':
                                          - /
                                          - 'Fn::GetAtt':
                                              - testclusterDBD4D436
                                              - Arn
                          - 'Fn::Select':
                              - 3
                              - 'Fn::Split':
                                  - ':'
                                  - 'Fn::Select':
                                      - 0
                                      - 'Fn::Split':
                                          - /
                                          - 'Fn::GetAtt':
                                              - testclusterDBD4D436
                                              - Arn
                          - 'Fn::Select':
                              - 4
                              - 'Fn::Split':
                                  - ':'
                                  - 'Fn::Select':
                                      - 0
                                      - 'Fn::Split':
                                          - /
                                          - 'Fn::GetAtt':
                                              - testclusterDBD4D436
                                              - Arn
                          - task
                    - 'Fn::Select':
                        - 1
                        - 'Fn::Split':
                            - /
                            - 'Fn::GetAtt':
                                - testclusterDBD4D436
                                - Arn
                    - ''
            - Name: CONTROLLER_EBS_SNAPSHOT_RETENTION_PERIOD
              Value: 24h
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1a__ENABLE_EXECUTE_COMMAND
              Value: 'false'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1a__SECURITY_GROUPS
              Value:
                'Fn::Join':
                  - ''
                  - - '["'
                    - 'Fn::GetAtt':
                        - testsecuritygroupB015C031
                        - GroupId
                    - '"]'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1a__SUBNETS
              Value:
                'Fn::Join':
                  - ''
                  - - '["'
                    - 'Fn::ImportValue': >-
                        VPCStack:ExportsOutputRefvpcPrivateSubnet1Subnet934893E8236E2271
                    - '"]'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1a__TASK_DEFINITION_ARN
              Value:
                Ref: teststatefuldefinitionB92BAA14
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1a__COUNT
              Value: '1'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1b__ENABLE_EXECUTE_COMMAND
              Value: 'false'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1b__SECURITY_GROUPS
              Value:
                'Fn::Join':
                  - ''
                  - - '["'
                    - 'Fn::GetAtt':
                        - testsecuritygroupB015C031
                        - GroupId
                    - '"]'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1b__SUBNETS
              Value:
                'Fn::Join':
                  - ''
                  - - '["'
                    - 'Fn::ImportValue': >-
                        VPCStack:ExportsOutputRefvpcPrivateSubnet2Subnet7031C2BA60DCB1EE
                    - '"]'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1b__TASK_DEFINITION_ARN
              Value:
                Ref: teststatefuldefinitionB92BAA14
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1b__COUNT
              Value: '1'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1c__ENABLE_EXECUTE_COMMAND
              Value: 'false'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1c__SECURITY_GROUPS
              Value:
                'Fn::Join':
                  - ''
                  - - '["'
                    - 'Fn::GetAtt':
                        - testsecuritygroupB015C031
                        - GroupId
                    - '"]'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1c__SUBNETS
              Value:
                'Fn::Join':
                  - ''
                  - - '["'
                    - 'Fn::ImportValue': >-
                        VPCStack:ExportsOutputRefvpcPrivateSubnet3Subnet985AC459F9514491
                    - '"]'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1c__TASK_DEFINITION_ARN
              Value:
                Ref: teststatefuldefinitionB92BAA14
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1c__COUNT
              Value: '1'
          Essential: true
          HealthCheck:
            Command:
              - CMD
              - curl
              - '--fail'
              - 'http://127.0.0.1:8080/health'
            Interval: 30
            Retries: 10
            StartPeriod: 300
            Timeout: 5
          Image: Any<Object>
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group:
                Ref: testcontrollerloggroupB61E47AC
              awslogs-stream-prefix: controller
              awslogs-region: region
              mode: non-blocking
          Memory: 2048
          Name: controller
          StopTimeout: 120
      Cpu: '1024'
      ExecutionRoleArn:
        'Fn::GetAtt':
          - testcontrollerexecutionrole3BE0C8C4
          - Arn
      Family: RestateBYOCtestcontrollerdefinitionA329F74F
      Memory: '2048'
      NetworkMode: awsvpc
      RequiresCompatibilities:
        - FARGATE
      RuntimePlatform:
        CpuArchitecture: ARM64
        OperatingSystemFamily: LINUX
      Tags:
        - Key: Name
          Value: RestateBYOC/test/controller-definition
      TaskRoleArn:
        'Fn::GetAtt':
          - testcontrollertaskrole42417C6E
          - Arn
  testcontrollerserviceService356186D6:
    Type: 'AWS::ECS::Service'
    Properties:
      Cluster:
        Ref: testclusterDBD4D436
      DeploymentConfiguration:
        Alarms:
          AlarmNames: []
          Enable: false
          Rollback: false
        MaximumPercent: 100
        MinimumHealthyPercent: 0
      DeploymentController:
        Type: ECS
      DesiredCount: 1
      EnableECSManagedTags: false
      EnableExecuteCommand: false
      LaunchType: FARGATE
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: DISABLED
          SecurityGroups:
            - 'Fn::GetAtt':
                - testsecuritygroupB015C031
                - GroupId
          Subnets:
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet1Subnet934893E8236E2271'
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet2Subnet7031C2BA60DCB1EE'
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet3Subnet985AC459F9514491'
      Tags:
        - Key: Name
          Value: RestateBYOC/test/controller-service
      TaskDefinition:
        Ref: testcontrollerdefinition0C4BC223
    DependsOn:
      - testcontrollertaskroleDefaultPolicy030D6236
      - testcontrollertaskrole42417C6E
  testrestatectlloggroupC2AAB6C7:
    Type: 'AWS::Logs::LogGroup'
    Properties:
      RetentionInDays: 14
    UpdateReplacePolicy: Retain
    DeletionPolicy: Retain
  testrestatectllambdaexecutionrole9C923F83:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
        Version: '2012-10-17'
  testrestatectllambdaexecutionroleDefaultPolicy93BA3725:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 'logs:CreateLogStream'
              - 'logs:PutLogEvents'
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'arn:'
                  - Ref: 'AWS::Partition'
                  - ':logs:'
                  - Ref: 'AWS::Region'
                  - ':'
                  - Ref: 'AWS::AccountId'
                  - ':log-group:'
                  - Ref: testrestatectlloggroupC2AAB6C7
                  - ':log-stream:*'
            Sid: AWSLambdaLogStreamPermissions
          - Action:
              - 'ec2:CreateNetworkInterface'
              - 'ec2:DescribeNetworkInterfaces'
              - 'ec2:DescribeSubnets'
              - 'ec2:DeleteNetworkInterface'
            Effect: Allow
            Resource: '*'
            Sid: AWSLambdaVPCWildcardPermissions
          - Action:
              - 'ec2:AssignPrivateIpAddresses'
              - 'ec2:UnassignPrivateIpAddresses'
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'arn:'
                  - Ref: 'AWS::Partition'
                  - ':ec2:'
                  - Ref: 'AWS::Region'
                  - ':'
                  - Ref: 'AWS::AccountId'
                  - ':network-interface/*'
            Sid: AWSLambdaVPCNetworkInterfacePermissions
        Version: '2012-10-17'
      PolicyName: testrestatectllambdaexecutionroleDefaultPolicy93BA3725
      Roles:
        - Ref: testrestatectllambdaexecutionrole9C923F83
  testrestatectllambda6F1900FA:
    Type: 'AWS::Lambda::Function'
    Properties:
      Architectures:
        - arm64
      Code: Any<Object>
      Environment:
        Variables:
          RESTATECTL_ADDRESS:
            'Fn::Join':
              - ''
              - - 'http://'
                - 'Fn::GetAtt':
                    - testsharednlb6BC10CBB
                    - DNSName
                - ':5122'
      Handler: restatectl
      LoggingConfig:
        LogGroup:
          Ref: testrestatectlloggroupC2AAB6C7
      Role:
        'Fn::GetAtt':
          - testrestatectllambdaexecutionrole9C923F83
          - Arn
      Runtime: provided.al2023
      Tags:
        - Key: Name
          Value: RestateBYOC/test/restatectl-lambda
      Timeout: 10
      VpcConfig:
        SecurityGroupIds:
          - 'Fn::GetAtt':
              - testsecuritygroupB015C031
              - GroupId
        SubnetIds:
          - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet1Subnet934893E8236E2271'
          - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet2Subnet7031C2BA60DCB1EE'
          - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet3Subnet985AC459F9514491'
    DependsOn:
      - testrestatectllambdaexecutionroleDefaultPolicy93BA3725
      - testrestatectllambdaexecutionrole9C923F83
  testretirementwatcherloggroupBCD89B2E:
    Type: 'AWS::Logs::LogGroup'
    Properties:
      RetentionInDays: 14
    UpdateReplacePolicy: Retain
    DeletionPolicy: Retain
  testretirementwatcherlambdaexecutionrole0BCEB9D0:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
        Version: '2012-10-17'
  testretirementwatcherlambdaexecutionroleDefaultPolicy6E9FBD0D:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 'logs:CreateLogStream'
              - 'logs:PutLogEvents'
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'arn:'
                  - Ref: 'AWS::Partition'
                  - ':logs:'
                  - Ref: 'AWS::Region'
                  - ':'
                  - Ref: 'AWS::AccountId'
                  - ':log-group:'
                  - Ref: testretirementwatcherloggroupBCD89B2E
                  - ':log-stream:*'
            Sid: AWSLambdaLogStreamPermissions
          - Action: 'ecs:TagResource'
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'Fn::Join':
                      - /
                      - - 'Fn::Join':
                            - ':'
                            - - 'Fn::Select':
                                  - 0
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - testclusterDBD4D436
                                                  - Arn
                              - 'Fn::Select':
                                  - 1
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - testclusterDBD4D436
                                                  - Arn
                              - 'Fn::Select':
                                  - 2
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - testclusterDBD4D436
                                                  - Arn
                              - 'Fn::Select':
                                  - 3
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - testclusterDBD4D436
                                                  - Arn
                              - 'Fn::Select':
                                  - 4
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - testclusterDBD4D436
                                                  - Arn
                              - task
                        - 'Fn::Select':
                            - 1
                            - 'Fn::Split':
                                - /
                                - 'Fn::GetAtt':
                                    - testclusterDBD4D436
                                    - Arn
                        - ''
                  - '*'
            Sid: TagTasks
          - Action:
              - 'sqs:ReceiveMessage'
              - 'sqs:ChangeMessageVisibility'
              - 'sqs:GetQueueUrl'
              - 'sqs:DeleteMessage'
              - 'sqs:GetQueueAttributes'
            Effect: Allow
            Resource:
              'Fn::GetAtt':
                - testretirementwatcherqueue71FDBFE9
                - Arn
        Version: '2012-10-17'
      PolicyName: testretirementwatcherlambdaexecutionroleDefaultPolicy6E9FBD0D
      Roles:
        - Ref: testretirementwatcherlambdaexecutionrole0BCEB9D0
  testretirementwatcherlambdaF666308D:
    Type: 'AWS::Lambda::Function'
    Properties:
      Architectures:
        - arm64
      Code: Any<Object>
      Handler: index.handler
      LoggingConfig:
        LogGroup:
          Ref: testretirementwatcherloggroupBCD89B2E
      Role:
        'Fn::GetAtt':
          - testretirementwatcherlambdaexecutionrole0BCEB9D0
          - Arn
      Runtime: nodejs22.x
      Tags:
        - Key: Name
          Value: RestateBYOC/test/retirement-watcher-lambda
      Timeout: 60
    DependsOn:
      - testretirementwatcherlambdaexecutionroleDefaultPolicy6E9FBD0D
      - testretirementwatcherlambdaexecutionrole0BCEB9D0
  testretirementwatcherlambdaSqsEventSourceRestateBYOCtestretirementwatcherqueue805C85E9DF913057:
    Type: 'AWS::Lambda::EventSourceMapping'
    Properties:
      BatchSize: 1
      EventSourceArn:
        'Fn::GetAtt':
          - testretirementwatcherqueue71FDBFE9
          - Arn
      FunctionName:
        Ref: testretirementwatcherlambdaF666308D
      Tags:
        - Key: Name
          Value: RestateBYOC/test/retirement-watcher-lambda
  testretirementwatcherqueue71FDBFE9:
    Type: 'AWS::SQS::Queue'
    Properties:
      Tags:
        - Key: Name
          Value: RestateBYOC/test/retirement-watcher-queue
      VisibilityTimeout: 60
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  testretirementwatcherqueuePolicy7D50DFC3:
    Type: 'AWS::SQS::QueuePolicy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 'sqs:SendMessage'
              - 'sqs:GetQueueAttributes'
              - 'sqs:GetQueueUrl'
            Condition:
              ArnEquals:
                'aws:SourceArn':
                  'Fn::GetAtt':
                    - testretirementwatcherruleBA70D9F7
                    - Arn
            Effect: Allow
            Principal:
              Service: events.amazonaws.com
            Resource:
              'Fn::GetAtt':
                - testretirementwatcherqueue71FDBFE9
                - Arn
        Version: '2012-10-17'
      Queues:
        - Ref: testretirementwatcherqueue71FDBFE9
  testretirementwatcherruleBA70D9F7:
    Type: 'AWS::Events::Rule'
    Properties:
      EventPattern:
        detail:
          eventTypeCode:
            - equals-ignore-case: AWS_ECS_TASK_PATCHING_RETIREMENT
          service:
            - equals-ignore-case: ecs
        resources:
          - prefix:
              'Fn::Join':
                - /
                - - 'Fn::Join':
                      - ':'
                      - - 'Fn::Select':
                            - 0
                            - 'Fn::Split':
                                - ':'
                                - 'Fn::Select':
                                    - 0
                                    - 'Fn::Split':
                                        - /
                                        - 'Fn::GetAtt':
                                            - testclusterDBD4D436
                                            - Arn
                        - 'Fn::Select':
                            - 1
                            - 'Fn::Split':
                                - ':'
                                - 'Fn::Select':
                                    - 0
                                    - 'Fn::Split':
                                        - /
                                        - 'Fn::GetAtt':
                                            - testclusterDBD4D436
                                            - Arn
                        - 'Fn::Select':
                            - 2
                            - 'Fn::Split':
                                - ':'
                                - 'Fn::Select':
                                    - 0
                                    - 'Fn::Split':
                                        - /
                                        - 'Fn::GetAtt':
                                            - testclusterDBD4D436
                                            - Arn
                        - 'Fn::Select':
                            - 3
                            - 'Fn::Split':
                                - ':'
                                - 'Fn::Select':
                                    - 0
                                    - 'Fn::Split':
                                        - /
                                        - 'Fn::GetAtt':
                                            - testclusterDBD4D436
                                            - Arn
                        - 'Fn::Select':
                            - 4
                            - 'Fn::Split':
                                - ':'
                                - 'Fn::Select':
                                    - 0
                                    - 'Fn::Split':
                                        - /
                                        - 'Fn::GetAtt':
                                            - testclusterDBD4D436
                                            - Arn
                        - task
                  - 'Fn::Select':
                      - 1
                      - 'Fn::Split':
                          - /
                          - 'Fn::GetAtt':
                              - testclusterDBD4D436
                              - Arn
                  - ''
        detail-type:
          - equals-ignore-case: AWS Health Event
      State: ENABLED
      Targets:
        - Arn:
            'Fn::GetAtt':
              - testretirementwatcherqueue71FDBFE9
              - Arn
          Id: Target0
  testcloudwatchcustomwidgetloggroupEBFA438D:
    Type: 'AWS::Logs::LogGroup'
    Properties:
      RetentionInDays: 14
    UpdateReplacePolicy: Retain
    DeletionPolicy: Retain
  testcloudwatchcustomwidgetexecutionrole72F32199:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
        Version: '2012-10-17'
  testcloudwatchcustomwidgetexecutionroleDefaultPolicy4D8EC73B:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 'logs:CreateLogStream'
              - 'logs:PutLogEvents'
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'arn:'
                  - Ref: 'AWS::Partition'
                  - ':logs:'
                  - Ref: 'AWS::Region'
                  - ':'
                  - Ref: 'AWS::AccountId'
                  - ':log-group:'
                  - Ref: testcloudwatchcustomwidgetloggroupEBFA438D
                  - ':log-stream:*'
            Sid: AWSLambdaLogStreamPermissions
          - Action: 'lambda:InvokeFunction'
            Effect: Allow
            Resource:
              'Fn::GetAtt':
                - testrestatectllambda6F1900FA
                - Arn
            Sid: InvokeRestatectl
          - Action: 'ecs:DescribeTaskDefinition'
            Effect: Allow
            Resource: '*'
            Sid: ECSReadActions
          - Action: 'ecs:ListTasks'
            Condition:
              StringEquals:
                'ecs:cluster':
                  'Fn::GetAtt':
                    - testclusterDBD4D436
                    - Arn
            Effect: Allow
            Resource: '*'
            Sid: ECSListTasks
          - Action: 'ecs:DescribeTasks'
            Condition:
              StringEquals:
                'ecs:cluster':
                  'Fn::GetAtt':
                    - testclusterDBD4D436
                    - Arn
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'arn:'
                  - Ref: 'AWS::Partition'
                  - ':ecs:'
                  - Ref: 'AWS::Region'
                  - ':'
                  - Ref: 'AWS::AccountId'
                  - ':task/'
                  - Ref: testclusterDBD4D436
                  - /*
            Sid: ECSDescribeTasks
          - Action: 'ecs:DescribeServices'
            Condition:
              StringEquals:
                'ecs:cluster':
                  'Fn::GetAtt':
                    - testclusterDBD4D436
                    - Arn
            Effect: Allow
            Resource:
              - Ref: testcontrollerserviceService356186D6
              - Ref: teststatelessserviceService5CDEA5F0
            Sid: ECSDescribeServices
          - Action: 'cloudwatch:GetMetricData'
            Effect: Allow
            Resource: '*'
            Sid: CloudWatchReadActions
        Version: '2012-10-17'
      PolicyName: testcloudwatchcustomwidgetexecutionroleDefaultPolicy4D8EC73B
      Roles:
        - Ref: testcloudwatchcustomwidgetexecutionrole72F32199
  testcloudwatchcustomwidgetlambdaB0DB8C59:
    Type: 'AWS::Lambda::Function'
    Properties:
      Architectures:
        - arm64
      Code: Any<Object>
      Environment:
        Variables:
          ENABLE_EBS_VOLUMES: 'false'
      Handler: index.handler
      LoggingConfig:
        LogGroup:
          Ref: testcloudwatchcustomwidgetloggroupEBFA438D
      MemorySize: 1024
      Role:
        'Fn::GetAtt':
          - testcloudwatchcustomwidgetexecutionrole72F32199
          - Arn
      Runtime: nodejs22.x
      Tags:
        - Key: Name
          Value: RestateBYOC/test/cloudwatch-custom-widget-lambda
      Timeout: 60
    DependsOn:
      - testcloudwatchcustomwidgetexecutionroleDefaultPolicy4D8EC73B
      - testcloudwatchcustomwidgetexecutionrole72F32199
  testcloudwatchcustomwidgetlambdacloudwatchcustomwidgetlambdaallowdatasource06DF513A:
    Type: 'AWS::Lambda::Permission'
    Properties:
      Action: 'lambda:InvokeFunction'
      FunctionName:
        'Fn::GetAtt':
          - testcloudwatchcustomwidgetlambdaB0DB8C59
          - Arn
      Principal: lambda.datasource.cloudwatch.amazonaws.com
Outputs:
  testSecurityGroups50C338D1:
    Description: The security group IDs of the cluster
    Value:
      'Fn::GetAtt':
        - testsecuritygroupB015C031
        - GroupId
  testIngressNetworkListenerA459AD14:
    Description: The ARN of the network listener for the ingress port
    Value:
      Ref: testingresssharedlistenerF18D3E56
  testIngressNetworkTargetGroup73857B83:
    Description: The ARN of the network target group for the ingress port
    Value:
      Ref: testingresssharedtarget779E3570
  testAdminNetworkListener840296BA:
    Description: The ARN of the network listener for the admin port
    Value:
      Ref: testadminsharedlistener6D147D79
  testAdminNetworkTargetGroup1541C506:
    Description: The ARN of the network target group for the admin port
    Value:
      Ref: testadminsharedtarget0C095FA8
  testNodeNetworkListener743144A9:
    Description: The ARN of the network listener for the node port
    Value:
      Ref: testnodesharedlistener98A38BFD
  testNodeNetworkTargetGroup76D5EEBA:
    Description: The ARN of the network target group for the node port
    Value:
      Ref: testnodesharedtarget6337BC22
"
`;

exports[`BYOC Default parameters 1`] = `
"Resources:
  defaultsecuritygroupE8DEFA55:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      GroupDescription: RestateBYOC/default/security-group
      SecurityGroupEgress:
        - CidrIp: 0.0.0.0/0
          Description: Allow all outbound traffic by default
          IpProtocol: '-1'
      Tags:
        - Key: Name
          Value: RestateBYOC/default/security-group
      VpcId:
        'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcA2121C384D1B3CDE'
  defaultsecuritygroupfromRestateBYOCdefaultsecuritygroup87B50E9980804AEED840:
    Type: 'AWS::EC2::SecurityGroupIngress'
    Properties:
      Description: 'from RestateBYOCdefaultsecuritygroup87B50E99:8080'
      FromPort: 8080
      GroupId:
        'Fn::GetAtt':
          - defaultsecuritygroupE8DEFA55
          - GroupId
      IpProtocol: tcp
      SourceSecurityGroupId:
        'Fn::GetAtt':
          - defaultsecuritygroupE8DEFA55
          - GroupId
      ToPort: 8080
  defaultsecuritygroupfromRestateBYOCdefaultsecuritygroup87B50E99907077632CDC:
    Type: 'AWS::EC2::SecurityGroupIngress'
    Properties:
      Description: 'from RestateBYOCdefaultsecuritygroup87B50E99:9070'
      FromPort: 9070
      GroupId:
        'Fn::GetAtt':
          - defaultsecuritygroupE8DEFA55
          - GroupId
      IpProtocol: tcp
      SourceSecurityGroupId:
        'Fn::GetAtt':
          - defaultsecuritygroupE8DEFA55
          - GroupId
      ToPort: 9070
  defaultsecuritygroupfromRestateBYOCdefaultsecuritygroup87B50E9951227EDECDBD:
    Type: 'AWS::EC2::SecurityGroupIngress'
    Properties:
      Description: 'from RestateBYOCdefaultsecuritygroup87B50E99:5122'
      FromPort: 5122
      GroupId:
        'Fn::GetAtt':
          - defaultsecuritygroupE8DEFA55
          - GroupId
      IpProtocol: tcp
      SourceSecurityGroupId:
        'Fn::GetAtt':
          - defaultsecuritygroupE8DEFA55
          - GroupId
      ToPort: 5122
  defaultbucket65304C97:
    Type: 'AWS::S3::Bucket'
    Properties:
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
    UpdateReplacePolicy: Retain
    DeletionPolicy: Retain
  defaultbucketPolicy7463A49D:
    Type: 'AWS::S3::BucketPolicy'
    Properties:
      Bucket:
        Ref: defaultbucket65304C97
      PolicyDocument:
        Statement:
          - Action: 's3:*'
            Condition:
              Bool:
                'aws:SecureTransport': 'false'
            Effect: Deny
            Principal:
              AWS: '*'
            Resource:
              - 'Fn::GetAtt':
                  - defaultbucket65304C97
                  - Arn
              - 'Fn::Join':
                  - ''
                  - - 'Fn::GetAtt':
                        - defaultbucket65304C97
                        - Arn
                    - /*
        Version: '2012-10-17'
  defaultcluster07071299:
    Type: 'AWS::ECS::Cluster'
    Properties:
      ClusterSettings:
        - Name: containerInsights
          Value: enhanced
      Tags:
        - Key: Name
          Value: RestateBYOC/default/cluster
  defaultrestatetaskrole1A7BDFBB:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
        Version: '2012-10-17'
  defaultrestatetaskroleDefaultPolicy58736B8D:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 's3:GetObject'
              - 's3:PutObject'
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'Fn::GetAtt':
                      - defaultbucket65304C97
                      - Arn
                  - /*
            Sid: ReadWriteBucket
          - Action: 's3:ListBucket'
            Effect: Allow
            Resource:
              'Fn::GetAtt':
                - defaultbucket65304C97
                - Arn
            Sid: ListBucket
        Version: '2012-10-17'
      PolicyName: defaultrestatetaskroleDefaultPolicy58736B8D
      Roles:
        - Ref: defaultrestatetaskrole1A7BDFBB
  defaultrestateexecutionrole4009B294:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
        Version: '2012-10-17'
  defaultrestateexecutionroleDefaultPolicy3E1E0421:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 'logs:CreateLogStream'
              - 'logs:PutLogEvents'
            Effect: Allow
            Resource:
              'Fn::GetAtt':
                - defaultrestateloggroup8EFD0887
                - Arn
        Version: '2012-10-17'
      PolicyName: defaultrestateexecutionroleDefaultPolicy3E1E0421
      Roles:
        - Ref: defaultrestateexecutionrole4009B294
  defaultrestateloggroup8EFD0887:
    Type: 'AWS::Logs::LogGroup'
    Properties:
      RetentionInDays: 30
    UpdateReplacePolicy: Retain
    DeletionPolicy: Retain
  defaultcontrollerloggroupD80898BE:
    Type: 'AWS::Logs::LogGroup'
    Properties:
      RetentionInDays: 30
    UpdateReplacePolicy: Retain
    DeletionPolicy: Retain
  defaultsharednlb5E13F2A0:
    Type: 'AWS::ElasticLoadBalancingV2::LoadBalancer'
    Properties:
      LoadBalancerAttributes:
        - Key: deletion_protection.enabled
          Value: 'false'
        - Key: load_balancing.cross_zone.enabled
          Value: 'false'
        - Key: dns_record.client_routing_policy
          Value: availability_zone_affinity
      Scheme: internal
      SecurityGroups:
        - 'Fn::GetAtt':
            - defaultsecuritygroupE8DEFA55
            - GroupId
      Subnets:
        - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet1Subnet934893E8236E2271'
        - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet2Subnet7031C2BA60DCB1EE'
        - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet3Subnet985AC459F9514491'
      Tags:
        - Key: Name
          Value: RestateBYOC/default/shared-nlb
      Type: network
  defaultingresssharedlistener3AB06661:
    Type: 'AWS::ElasticLoadBalancingV2::Listener'
    Properties:
      DefaultActions:
        - TargetGroupArn:
            Ref: defaultingresssharedtarget501739FD
          Type: forward
      LoadBalancerArn:
        Ref: defaultsharednlb5E13F2A0
      Port: 8080
      Protocol: TCP
  defaultadminsharedlistener2B6E2F69:
    Type: 'AWS::ElasticLoadBalancingV2::Listener'
    Properties:
      DefaultActions:
        - TargetGroupArn:
            Ref: defaultadminsharedtarget04FDBD2A
          Type: forward
      LoadBalancerArn:
        Ref: defaultsharednlb5E13F2A0
      Port: 9070
      Protocol: TCP
  defaultnodesharedlistenerF94E5381:
    Type: 'AWS::ElasticLoadBalancingV2::Listener'
    Properties:
      DefaultActions:
        - TargetGroupArn:
            Ref: defaultnodesharedtarget1C48E466
          Type: forward
      LoadBalancerArn:
        Ref: defaultsharednlb5E13F2A0
      Port: 5122
      Protocol: TCP
  defaultstatelessdefinitionDCB0B7C0:
    Type: 'AWS::ECS::TaskDefinition'
    Properties:
      ContainerDefinitions:
        - Cpu: 16384
          EntryPoint:
            - bash
            - '-c'
            - >

              curl --no-progress-meter $ECS_CONTAINER_METADATA_URI_V4 -o
              container-metadata && \\

              curl --no-progress-meter $ECS_CONTAINER_METADATA_URI_V4/task -o
              task-metadata && \\

              export \\
                RESTATE_NODE_NAME=$(jq -r '.TaskARN' task-metadata) \\
                RESTATE_LOCATION="$AWS_REGION.$(jq -r '.AvailabilityZone' task-metadata)" \\
                RESTATE_ADVERTISED_ADDRESS="http://$(jq -r '.Networks[0].IPv4Addresses[0]' container-metadata):5122"
              exec restate-server
          Environment:
            - Name: RESTATE_LOG_FORMAT
              Value: json
            - Name: RESTATE_CLUSTER_NAME
              Value: RestateBYOC/default
            - Name: RESTATE_ROLES
              Value: '["admin","http-ingress"]'
            - Name: RESTATE_AUTO_PROVISION
              Value: 'true'
            - Name: RESTATE_SHUTDOWN_TIMEOUT
              Value: 100s
            - Name: RESTATE_DEFAULT_NUM_PARTITIONS
              Value: '128'
            - Name: RESTATE_DEFAULT_REPLICATION
              Value: '{zone: 2}'
            - Name: RESTATE_METADATA_CLIENT__TYPE
              Value: object-store
            - Name: RESTATE_METADATA_CLIENT__PATH
              Value:
                'Fn::Join':
                  - ''
                  - - 's3://'
                    - Ref: defaultbucket65304C97
                    - /metadata
            - Name: RESTATE_BIFROST__DEFAULT_PROVIDER
              Value: replicated
            - Name: >-
                RESTATE_INGRESS__EXPERIMENTAL_FEATURE_ENABLE_SEPARATE_INGRESS_ROLE
              Value: 'true'
            - Name: RESTATE_INGRESS__ADVERTISED_INGRESS_ENDPOINT
              Value:
                'Fn::Join':
                  - ''
                  - - 'http://'
                    - 'Fn::GetAtt':
                        - defaultsharednlb5E13F2A0
                        - DNSName
                    - ':8080'
            - Name: RESTATE_WORKER__SNAPSHOTS__DESTINATION
              Value:
                'Fn::Join':
                  - ''
                  - - 's3://'
                    - Ref: defaultbucket65304C97
                    - /snapshots
          Essential: true
          HealthCheck:
            Command:
              - CMD
              - curl
              - '--fail'
              - 'http://127.0.0.1:8080/restate/health'
            Interval: 30
            Retries: 3
            Timeout: 5
          Image: Any<Object>
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group:
                Ref: defaultrestateloggroup8EFD0887
              awslogs-stream-prefix: restate
              awslogs-region: region
              mode: non-blocking
          Memory: 32768
          Name: restate
          PortMappings:
            - ContainerPort: 8080
              Name: ingress
              Protocol: tcp
            - ContainerPort: 9070
              Name: admin
              Protocol: tcp
            - ContainerPort: 5122
              Name: node
              Protocol: tcp
          StopTimeout: 120
      Cpu: '16384'
      ExecutionRoleArn:
        'Fn::GetAtt':
          - defaultrestateexecutionrole4009B294
          - Arn
      Family: RestateBYOCdefaultstatelessdefinitionFF58C79A
      Memory: '32768'
      NetworkMode: awsvpc
      RequiresCompatibilities:
        - FARGATE
      RuntimePlatform:
        CpuArchitecture: ARM64
        OperatingSystemFamily: LINUX
      Tags:
        - Key: Name
          Value: RestateBYOC/default/stateless-definition
      TaskRoleArn:
        'Fn::GetAtt':
          - defaultrestatetaskrole1A7BDFBB
          - Arn
  defaultstatelessserviceService8A7FABFB:
    Type: 'AWS::ECS::Service'
    Properties:
      AvailabilityZoneRebalancing: ENABLED
      Cluster:
        Ref: defaultcluster07071299
      DeploymentConfiguration:
        Alarms:
          AlarmNames: []
          Enable: false
          Rollback: false
        MaximumPercent: 200
        MinimumHealthyPercent: 100
      DeploymentController:
        Type: ECS
      DesiredCount: 3
      EnableECSManagedTags: false
      EnableExecuteCommand: false
      HealthCheckGracePeriodSeconds: 60
      LaunchType: FARGATE
      LoadBalancers:
        - ContainerName: restate
          ContainerPort: 8080
          TargetGroupArn:
            Ref: defaultingresssharedtarget501739FD
        - ContainerName: restate
          ContainerPort: 9070
          TargetGroupArn:
            Ref: defaultadminsharedtarget04FDBD2A
        - ContainerName: restate
          ContainerPort: 5122
          TargetGroupArn:
            Ref: defaultnodesharedtarget1C48E466
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: DISABLED
          SecurityGroups:
            - 'Fn::GetAtt':
                - defaultsecuritygroupE8DEFA55
                - GroupId
          Subnets:
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet1Subnet934893E8236E2271'
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet2Subnet7031C2BA60DCB1EE'
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet3Subnet985AC459F9514491'
      PropagateTags: SERVICE
      Tags:
        - Key: Name
          Value: RestateBYOC/default/stateless-service
      TaskDefinition:
        Ref: defaultstatelessdefinitionDCB0B7C0
    DependsOn:
      - defaultadminsharedlistener2B6E2F69
      - defaultingresssharedlistener3AB06661
      - defaultnodesharedlistenerF94E5381
      - defaultrestatetaskroleDefaultPolicy58736B8D
      - defaultrestatetaskrole1A7BDFBB
  defaultstatefuldefinition4CD55F35:
    Type: 'AWS::ECS::TaskDefinition'
    Properties:
      ContainerDefinitions:
        - Cpu: 16384
          EntryPoint:
            - bash
            - '-c'
            - >

              curl --no-progress-meter $ECS_CONTAINER_METADATA_URI_V4 -o
              container-metadata && \\

              curl --no-progress-meter $ECS_CONTAINER_METADATA_URI_V4/task -o
              task-metadata && \\

              export \\
                RESTATE_NODE_NAME=$(jq -r '.TaskARN' task-metadata) \\
                RESTATE_LOCATION="$AWS_REGION.$(jq -r '.AvailabilityZone' task-metadata)" \\
                RESTATE_ADVERTISED_ADDRESS="http://$(jq -r '.Networks[0].IPv4Addresses[0]' container-metadata):5122" \\
                RESTATE_ROCKSDB_TOTAL_MEMORY_SIZE="$(($(jq -r '.Limits.Memory' container-metadata) * 3 / 4))MiB" \\
                RESTATE_WORKER__STORAGE__NUM_PARTITIONS_TO_SHARE_MEMORY_BUDGET=$(("$RESTATE_WORKER__STORAGE__NUM_PARTITIONS_TO_SHARE_MEMORY_BUDGET"))
              exec restate-server
          Environment:
            - Name: RESTATE_LOG_FORMAT
              Value: json
            - Name: RESTATE_CLUSTER_NAME
              Value: RestateBYOC/default
            - Name: RESTATE_ROLES
              Value: '["log-server", "worker"]'
            - Name: RESTATE_AUTO_PROVISION
              Value: 'false'
            - Name: RESTATE_SHUTDOWN_TIMEOUT
              Value: 100s
            - Name: RESTATE_METADATA_CLIENT__TYPE
              Value: object-store
            - Name: RESTATE_METADATA_CLIENT__PATH
              Value:
                'Fn::Join':
                  - ''
                  - - 's3://'
                    - Ref: defaultbucket65304C97
                    - /metadata
            - Name: RESTATE_WORKER__SNAPSHOTS__DESTINATION
              Value:
                'Fn::Join':
                  - ''
                  - - 's3://'
                    - Ref: defaultbucket65304C97
                    - /snapshots
            - Name: RESTATE_WORKER__SNAPSHOTS__SNAPSHOT_INTERVAL_NUM_RECORDS
              Value: '1000000'
            - Name: RESTATE_WORKER__STORAGE__ROCKSDB_DISABLE_DIRECT_IO_FOR_READS
              Value: 'true'
            - Name: RESTATE_WORKER__STORAGE__ROCKSDB_DISABLE_WAL_FSYNC
              Value: 'true'
            - Name: RESTATE_WORKER__STORAGE__NUM_PARTITIONS_TO_SHARE_MEMORY_BUDGET
              Value: (128 * 2) / (3 * 1)
            - Name: RESTATE_LOG_SERVER__ROCKSDB_DISABLE_WAL_FSYNC
              Value: 'true'
            - Name: RESTATE_LOG_SERVER__ROCKSDB_DISABLE_DIRECT_IO_FOR_READS
              Value: 'true'
            - Name: >-
                RESTATE_INGRESS__EXPERIMENTAL_FEATURE_ENABLE_SEPARATE_INGRESS_ROLE
              Value: 'true'
          Essential: true
          HealthCheck:
            Command:
              - CMD
              - curl
              - '--fail'
              - 'http://127.0.0.1:5122/health'
            Interval: 30
            Retries: 3
            Timeout: 5
          Image: Any<Object>
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group:
                Ref: defaultrestateloggroup8EFD0887
              awslogs-stream-prefix: restate
              awslogs-region: region
              mode: non-blocking
          Memory: 32768
          MountPoints:
            - ContainerPath: /restate-data
              ReadOnly: false
              SourceVolume: restate-data
          Name: restate
          PortMappings:
            - ContainerPort: 5122
              Name: node
              Protocol: tcp
          RestartPolicy:
            Enabled: true
            RestartAttemptPeriod: 60
          StopTimeout: 120
      Cpu: '16384'
      EphemeralStorage:
        SizeInGiB: 200
      ExecutionRoleArn:
        'Fn::GetAtt':
          - defaultrestateexecutionrole4009B294
          - Arn
      Family: RestateBYOCdefaultstatefuldefinition4D62F21B
      Memory: '32768'
      NetworkMode: awsvpc
      RequiresCompatibilities:
        - FARGATE
      RuntimePlatform:
        CpuArchitecture: ARM64
        OperatingSystemFamily: LINUX
      Tags:
        - Key: Name
          Value: RestateBYOC/default/stateful-definition
      TaskRoleArn:
        'Fn::GetAtt':
          - defaultrestatetaskrole1A7BDFBB
          - Arn
      Volumes:
        - ConfiguredAtLaunch: false
          Name: restate-data
  defaultingresssharedtarget501739FD:
    Type: 'AWS::ElasticLoadBalancingV2::TargetGroup'
    Properties:
      HealthCheckEnabled: true
      HealthCheckIntervalSeconds: 5
      HealthCheckPath: /restate/health
      HealthCheckProtocol: HTTP
      HealthCheckTimeoutSeconds: 2
      Port: 8080
      Protocol: TCP
      Tags:
        - Key: Name
          Value: RestateBYOC/default/ingress-shared-target
      TargetType: ip
      VpcId:
        'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcA2121C384D1B3CDE'
  defaultadminsharedtarget04FDBD2A:
    Type: 'AWS::ElasticLoadBalancingV2::TargetGroup'
    Properties:
      HealthCheckEnabled: true
      HealthCheckIntervalSeconds: 5
      HealthCheckPath: /health
      HealthCheckPort: '9070'
      HealthCheckProtocol: HTTP
      HealthCheckTimeoutSeconds: 2
      Port: 9070
      Protocol: TCP
      Tags:
        - Key: Name
          Value: RestateBYOC/default/admin-shared-target
      TargetType: ip
      VpcId:
        'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcA2121C384D1B3CDE'
  defaultnodesharedtarget1C48E466:
    Type: 'AWS::ElasticLoadBalancingV2::TargetGroup'
    Properties:
      HealthCheckEnabled: true
      HealthCheckIntervalSeconds: 5
      HealthCheckPath: /health
      HealthCheckPort: '5122'
      HealthCheckProtocol: HTTP
      HealthCheckTimeoutSeconds: 2
      Port: 5122
      Protocol: TCP
      Tags:
        - Key: Name
          Value: RestateBYOC/default/node-shared-target
      TargetType: ip
      VpcId:
        'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcA2121C384D1B3CDE'
  defaultcontrollertaskrole7B120178:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
        Version: '2012-10-17'
  defaultcontrollertaskroleDefaultPolicy328ED952:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action: 'ecs:ListTasks'
            Condition:
              ArnEquals:
                'ecs:cluster':
                  'Fn::GetAtt':
                    - defaultcluster07071299
                    - Arn
            Effect: Allow
            Resource: '*'
            Sid: ECSListActions
          - Action:
              - 'ecs:TagResource'
              - 'ecs:DescribeTasks'
              - 'ecs:StopTask'
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'Fn::Join':
                      - /
                      - - 'Fn::Join':
                            - ':'
                            - - 'Fn::Select':
                                  - 0
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - defaultcluster07071299
                                                  - Arn
                              - 'Fn::Select':
                                  - 1
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - defaultcluster07071299
                                                  - Arn
                              - 'Fn::Select':
                                  - 2
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - defaultcluster07071299
                                                  - Arn
                              - 'Fn::Select':
                                  - 3
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - defaultcluster07071299
                                                  - Arn
                              - 'Fn::Select':
                                  - 4
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - defaultcluster07071299
                                                  - Arn
                              - task
                        - 'Fn::Select':
                            - 1
                            - 'Fn::Split':
                                - /
                                - 'Fn::GetAtt':
                                    - defaultcluster07071299
                                    - Arn
                        - ''
                  - '*'
            Sid: TaskActions
          - Action: 'ecs:RunTask'
            Condition:
              ArnEquals:
                'ecs:cluster':
                  'Fn::GetAtt':
                    - defaultcluster07071299
                    - Arn
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'Fn::Join':
                      - ':'
                      - - 'Fn::Select':
                            - 0
                            - 'Fn::Split':
                                - ':'
                                - Ref: defaultstatefuldefinition4CD55F35
                        - 'Fn::Select':
                            - 1
                            - 'Fn::Split':
                                - ':'
                                - Ref: defaultstatefuldefinition4CD55F35
                        - 'Fn::Select':
                            - 2
                            - 'Fn::Split':
                                - ':'
                                - Ref: defaultstatefuldefinition4CD55F35
                        - 'Fn::Select':
                            - 3
                            - 'Fn::Split':
                                - ':'
                                - Ref: defaultstatefuldefinition4CD55F35
                        - 'Fn::Select':
                            - 4
                            - 'Fn::Split':
                                - ':'
                                - Ref: defaultstatefuldefinition4CD55F35
                        - 'Fn::Select':
                            - 5
                            - 'Fn::Split':
                                - ':'
                                - Ref: defaultstatefuldefinition4CD55F35
                  - ':*'
            Sid: RunTask
          - Action: 'iam:PassRole'
            Condition:
              StringEquals:
                'iam:PassedToService': ecs-tasks.amazonaws.com
            Effect: Allow
            Resource:
              - 'Fn::GetAtt':
                  - defaultrestatetaskrole1A7BDFBB
                  - Arn
              - 'Fn::GetAtt':
                  - defaultrestateexecutionrole4009B294
                  - Arn
            Sid: RunTaskPassRole
          - Action:
              - 'ec2:DescribeVolumes'
              - 'ec2:DescribeSnapshots'
            Effect: Allow
            Resource: '*'
            Sid: EC2ListActions
          - Action: 'ec2:CreateSnapshot'
            Condition:
              ArnEquals:
                'aws:RequestTag/restate:ecsClusterArn':
                  'Fn::GetAtt':
                    - defaultcluster07071299
                    - Arn
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'arn:'
                  - Ref: 'AWS::Partition'
                  - ':ec2:'
                  - Ref: 'AWS::Region'
                  - '::snapshot/*'
            Sid: CreateSnapshot
          - Action: 'ec2:CreateSnapshot'
            Condition:
              ArnEquals:
                'aws:ResourceTag/restate:ecsClusterArn':
                  'Fn::GetAtt':
                    - defaultcluster07071299
                    - Arn
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'arn:'
                  - Ref: 'AWS::Partition'
                  - ':ec2:'
                  - Ref: 'AWS::Region'
                  - ':'
                  - Ref: 'AWS::AccountId'
                  - ':volume/*'
            Sid: SnapshotVolume
          - Action: 'ec2:CreateTags'
            Condition:
              StringEquals:
                'ec2:CreateAction': CreateSnapshot
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'arn:'
                  - Ref: 'AWS::Partition'
                  - ':ec2:'
                  - Ref: 'AWS::Region'
                  - '::snapshot/*'
            Sid: TagSnapshots
          - Action:
              - 'ec2:DeleteVolume'
              - 'ec2:DeleteSnapshot'
            Condition:
              ArnEquals:
                'aws:ResourceTag/restate:ecsClusterArn':
                  'Fn::GetAtt':
                    - defaultcluster07071299
                    - Arn
            Effect: Allow
            Resource:
              - 'Fn::Join':
                  - ''
                  - - 'arn:'
                    - Ref: 'AWS::Partition'
                    - ':ec2:'
                    - Ref: 'AWS::Region'
                    - ':'
                    - Ref: 'AWS::AccountId'
                    - ':volume/*'
              - 'Fn::Join':
                  - ''
                  - - 'arn:'
                    - Ref: 'AWS::Partition'
                    - ':ec2:'
                    - Ref: 'AWS::Region'
                    - '::snapshot/*'
            Sid: DeleteVolumeAndSnapshot
          - Action:
              - 's3:GetObject'
              - 's3:PutObject'
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'Fn::GetAtt':
                      - defaultbucket65304C97
                      - Arn
                  - /*
            Sid: ReadWriteBucket
          - Action: 's3:ListBucket'
            Effect: Allow
            Resource:
              'Fn::GetAtt':
                - defaultbucket65304C97
                - Arn
            Sid: ListBucket
        Version: '2012-10-17'
      PolicyName: defaultcontrollertaskroleDefaultPolicy328ED952
      Roles:
        - Ref: defaultcontrollertaskrole7B120178
  defaultcontrollerexecutionrole67636991:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
        Version: '2012-10-17'
  defaultcontrollerexecutionroleDefaultPolicy53CE4FA0:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 'logs:CreateLogStream'
              - 'logs:PutLogEvents'
            Effect: Allow
            Resource:
              'Fn::GetAtt':
                - defaultcontrollerloggroupD80898BE
                - Arn
        Version: '2012-10-17'
      PolicyName: defaultcontrollerexecutionroleDefaultPolicy53CE4FA0
      Roles:
        - Ref: defaultcontrollerexecutionrole67636991
  defaultcontrollerdefinition66AD165F:
    Type: 'AWS::ECS::TaskDefinition'
    Properties:
      ContainerDefinitions:
        - Cpu: 1024
          Environment:
            - Name: RUST_LOG
              Value: 'info,restate_fargate_controller=debug'
            - Name: CONTROLLER_LOG_FORMAT
              Value: json
            - Name: CONTROLLER_METADATA_PATH
              Value:
                'Fn::Join':
                  - ''
                  - - 's3://'
                    - Ref: defaultbucket65304C97
                    - /metadata
            - Name: CONTROLLER_RECONCILE_INTERVAL
              Value: 10s
            - Name: CONTROLLER_CLUSTER__CLUSTER_ARN
              Value:
                'Fn::GetAtt':
                  - defaultcluster07071299
                  - Arn
            - Name: CONTROLLER_LICENSE_KEY
              Value: foo
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __REGION
              Value:
                Ref: 'AWS::Region'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __CLUSTER_ARN
              Value:
                'Fn::GetAtt':
                  - defaultcluster07071299
                  - Arn
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __TASK_PREFIX
              Value:
                'Fn::Join':
                  - /
                  - - 'Fn::Join':
                        - ':'
                        - - 'Fn::Select':
                              - 0
                              - 'Fn::Split':
                                  - ':'
                                  - 'Fn::Select':
                                      - 0
                                      - 'Fn::Split':
                                          - /
                                          - 'Fn::GetAtt':
                                              - defaultcluster07071299
                                              - Arn
                          - 'Fn::Select':
                              - 1
                              - 'Fn::Split':
                                  - ':'
                                  - 'Fn::Select':
                                      - 0
                                      - 'Fn::Split':
                                          - /
                                          - 'Fn::GetAtt':
                                              - defaultcluster07071299
                                              - Arn
                          - 'Fn::Select':
                              - 2
                              - 'Fn::Split':
                                  - ':'
                                  - 'Fn::Select':
                                      - 0
                                      - 'Fn::Split':
                                          - /
                                          - 'Fn::GetAtt':
                                              - defaultcluster07071299
                                              - Arn
                          - 'Fn::Select':
                              - 3
                              - 'Fn::Split':
                                  - ':'
                                  - 'Fn::Select':
                                      - 0
                                      - 'Fn::Split':
                                          - /
                                          - 'Fn::GetAtt':
                                              - defaultcluster07071299
                                              - Arn
                          - 'Fn::Select':
                              - 4
                              - 'Fn::Split':
                                  - ':'
                                  - 'Fn::Select':
                                      - 0
                                      - 'Fn::Split':
                                          - /
                                          - 'Fn::GetAtt':
                                              - defaultcluster07071299
                                              - Arn
                          - task
                    - 'Fn::Select':
                        - 1
                        - 'Fn::Split':
                            - /
                            - 'Fn::GetAtt':
                                - defaultcluster07071299
                                - Arn
                    - ''
            - Name: CONTROLLER_EBS_SNAPSHOT_RETENTION_PERIOD
              Value: 24h
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1a__ENABLE_EXECUTE_COMMAND
              Value: 'false'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1a__SECURITY_GROUPS
              Value:
                'Fn::Join':
                  - ''
                  - - '["'
                    - 'Fn::GetAtt':
                        - defaultsecuritygroupE8DEFA55
                        - GroupId
                    - '"]'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1a__SUBNETS
              Value:
                'Fn::Join':
                  - ''
                  - - '["'
                    - 'Fn::ImportValue': >-
                        VPCStack:ExportsOutputRefvpcPrivateSubnet1Subnet934893E8236E2271
                    - '"]'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1a__TASK_DEFINITION_ARN
              Value:
                Ref: defaultstatefuldefinition4CD55F35
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1a__COUNT
              Value: '1'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1b__ENABLE_EXECUTE_COMMAND
              Value: 'false'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1b__SECURITY_GROUPS
              Value:
                'Fn::Join':
                  - ''
                  - - '["'
                    - 'Fn::GetAtt':
                        - defaultsecuritygroupE8DEFA55
                        - GroupId
                    - '"]'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1b__SUBNETS
              Value:
                'Fn::Join':
                  - ''
                  - - '["'
                    - 'Fn::ImportValue': >-
                        VPCStack:ExportsOutputRefvpcPrivateSubnet2Subnet7031C2BA60DCB1EE
                    - '"]'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1b__TASK_DEFINITION_ARN
              Value:
                Ref: defaultstatefuldefinition4CD55F35
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1b__COUNT
              Value: '1'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1c__ENABLE_EXECUTE_COMMAND
              Value: 'false'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1c__SECURITY_GROUPS
              Value:
                'Fn::Join':
                  - ''
                  - - '["'
                    - 'Fn::GetAtt':
                        - defaultsecuritygroupE8DEFA55
                        - GroupId
                    - '"]'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1c__SUBNETS
              Value:
                'Fn::Join':
                  - ''
                  - - '["'
                    - 'Fn::ImportValue': >-
                        VPCStack:ExportsOutputRefvpcPrivateSubnet3Subnet985AC459F9514491
                    - '"]'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1c__TASK_DEFINITION_ARN
              Value:
                Ref: defaultstatefuldefinition4CD55F35
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1c__COUNT
              Value: '1'
          Essential: true
          HealthCheck:
            Command:
              - CMD
              - curl
              - '--fail'
              - 'http://127.0.0.1:8080/health'
            Interval: 30
            Retries: 10
            StartPeriod: 300
            Timeout: 5
          Image: Any<Object>
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group:
                Ref: defaultcontrollerloggroupD80898BE
              awslogs-stream-prefix: controller
              awslogs-region: region
              mode: non-blocking
          Memory: 2048
          Name: controller
          StopTimeout: 120
      Cpu: '1024'
      ExecutionRoleArn:
        'Fn::GetAtt':
          - defaultcontrollerexecutionrole67636991
          - Arn
      Family: RestateBYOCdefaultcontrollerdefinition426584A5
      Memory: '2048'
      NetworkMode: awsvpc
      RequiresCompatibilities:
        - FARGATE
      RuntimePlatform:
        CpuArchitecture: ARM64
        OperatingSystemFamily: LINUX
      Tags:
        - Key: Name
          Value: RestateBYOC/default/controller-definition
      TaskRoleArn:
        'Fn::GetAtt':
          - defaultcontrollertaskrole7B120178
          - Arn
  defaultcontrollerserviceService18139D09:
    Type: 'AWS::ECS::Service'
    Properties:
      Cluster:
        Ref: defaultcluster07071299
      DeploymentConfiguration:
        Alarms:
          AlarmNames: []
          Enable: false
          Rollback: false
        MaximumPercent: 100
        MinimumHealthyPercent: 0
      DeploymentController:
        Type: ECS
      DesiredCount: 1
      EnableECSManagedTags: false
      EnableExecuteCommand: false
      LaunchType: FARGATE
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: DISABLED
          SecurityGroups:
            - 'Fn::GetAtt':
                - defaultsecuritygroupE8DEFA55
                - GroupId
          Subnets:
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet1Subnet934893E8236E2271'
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet2Subnet7031C2BA60DCB1EE'
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet3Subnet985AC459F9514491'
      Tags:
        - Key: Name
          Value: RestateBYOC/default/controller-service
      TaskDefinition:
        Ref: defaultcontrollerdefinition66AD165F
    DependsOn:
      - defaultcontrollertaskroleDefaultPolicy328ED952
      - defaultcontrollertaskrole7B120178
  defaultrestatectlloggroupFAE86DDB:
    Type: 'AWS::Logs::LogGroup'
    Properties:
      RetentionInDays: 14
    UpdateReplacePolicy: Retain
    DeletionPolicy: Retain
  defaultrestatectllambdaexecutionrole68199B2A:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
        Version: '2012-10-17'
  defaultrestatectllambdaexecutionroleDefaultPolicy52B70971:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 'logs:CreateLogStream'
              - 'logs:PutLogEvents'
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'arn:'
                  - Ref: 'AWS::Partition'
                  - ':logs:'
                  - Ref: 'AWS::Region'
                  - ':'
                  - Ref: 'AWS::AccountId'
                  - ':log-group:'
                  - Ref: defaultrestatectlloggroupFAE86DDB
                  - ':log-stream:*'
            Sid: AWSLambdaLogStreamPermissions
          - Action:
              - 'ec2:CreateNetworkInterface'
              - 'ec2:DescribeNetworkInterfaces'
              - 'ec2:DescribeSubnets'
              - 'ec2:DeleteNetworkInterface'
            Effect: Allow
            Resource: '*'
            Sid: AWSLambdaVPCWildcardPermissions
          - Action:
              - 'ec2:AssignPrivateIpAddresses'
              - 'ec2:UnassignPrivateIpAddresses'
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'arn:'
                  - Ref: 'AWS::Partition'
                  - ':ec2:'
                  - Ref: 'AWS::Region'
                  - ':'
                  - Ref: 'AWS::AccountId'
                  - ':network-interface/*'
            Sid: AWSLambdaVPCNetworkInterfacePermissions
        Version: '2012-10-17'
      PolicyName: defaultrestatectllambdaexecutionroleDefaultPolicy52B70971
      Roles:
        - Ref: defaultrestatectllambdaexecutionrole68199B2A
  defaultrestatectllambda05E7B262:
    Type: 'AWS::Lambda::Function'
    Properties:
      Architectures:
        - arm64
      Code: Any<Object>
      Environment:
        Variables:
          RESTATECTL_ADDRESS:
            'Fn::Join':
              - ''
              - - 'http://'
                - 'Fn::GetAtt':
                    - defaultsharednlb5E13F2A0
                    - DNSName
                - ':5122'
      Handler: restatectl
      LoggingConfig:
        LogGroup:
          Ref: defaultrestatectlloggroupFAE86DDB
      Role:
        'Fn::GetAtt':
          - defaultrestatectllambdaexecutionrole68199B2A
          - Arn
      Runtime: provided.al2023
      Tags:
        - Key: Name
          Value: RestateBYOC/default/restatectl-lambda
      Timeout: 10
      VpcConfig:
        SecurityGroupIds:
          - 'Fn::GetAtt':
              - defaultsecuritygroupE8DEFA55
              - GroupId
        SubnetIds:
          - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet1Subnet934893E8236E2271'
          - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet2Subnet7031C2BA60DCB1EE'
          - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet3Subnet985AC459F9514491'
    DependsOn:
      - defaultrestatectllambdaexecutionroleDefaultPolicy52B70971
      - defaultrestatectllambdaexecutionrole68199B2A
  defaultretirementwatcherloggroup3D95DB6F:
    Type: 'AWS::Logs::LogGroup'
    Properties:
      RetentionInDays: 14
    UpdateReplacePolicy: Retain
    DeletionPolicy: Retain
  defaultretirementwatcherlambdaexecutionroleF14BB722:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
        Version: '2012-10-17'
  defaultretirementwatcherlambdaexecutionroleDefaultPolicy6242FE7D:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 'logs:CreateLogStream'
              - 'logs:PutLogEvents'
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'arn:'
                  - Ref: 'AWS::Partition'
                  - ':logs:'
                  - Ref: 'AWS::Region'
                  - ':'
                  - Ref: 'AWS::AccountId'
                  - ':log-group:'
                  - Ref: defaultretirementwatcherloggroup3D95DB6F
                  - ':log-stream:*'
            Sid: AWSLambdaLogStreamPermissions
          - Action: 'ecs:TagResource'
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'Fn::Join':
                      - /
                      - - 'Fn::Join':
                            - ':'
                            - - 'Fn::Select':
                                  - 0
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - defaultcluster07071299
                                                  - Arn
                              - 'Fn::Select':
                                  - 1
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - defaultcluster07071299
                                                  - Arn
                              - 'Fn::Select':
                                  - 2
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - defaultcluster07071299
                                                  - Arn
                              - 'Fn::Select':
                                  - 3
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - defaultcluster07071299
                                                  - Arn
                              - 'Fn::Select':
                                  - 4
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - defaultcluster07071299
                                                  - Arn
                              - task
                        - 'Fn::Select':
                            - 1
                            - 'Fn::Split':
                                - /
                                - 'Fn::GetAtt':
                                    - defaultcluster07071299
                                    - Arn
                        - ''
                  - '*'
            Sid: TagTasks
          - Action:
              - 'sqs:ReceiveMessage'
              - 'sqs:ChangeMessageVisibility'
              - 'sqs:GetQueueUrl'
              - 'sqs:DeleteMessage'
              - 'sqs:GetQueueAttributes'
            Effect: Allow
            Resource:
              'Fn::GetAtt':
                - defaultretirementwatcherqueue17CDF7F2
                - Arn
        Version: '2012-10-17'
      PolicyName: defaultretirementwatcherlambdaexecutionroleDefaultPolicy6242FE7D
      Roles:
        - Ref: defaultretirementwatcherlambdaexecutionroleF14BB722
  defaultretirementwatcherlambda80A1658E:
    Type: 'AWS::Lambda::Function'
    Properties:
      Architectures:
        - arm64
      Code: Any<Object>
      Handler: index.handler
      LoggingConfig:
        LogGroup:
          Ref: defaultretirementwatcherloggroup3D95DB6F
      Role:
        'Fn::GetAtt':
          - defaultretirementwatcherlambdaexecutionroleF14BB722
          - Arn
      Runtime: nodejs22.x
      Tags:
        - Key: Name
          Value: RestateBYOC/default/retirement-watcher-lambda
      Timeout: 60
    DependsOn:
      - defaultretirementwatcherlambdaexecutionroleDefaultPolicy6242FE7D
      - defaultretirementwatcherlambdaexecutionroleF14BB722
  defaultretirementwatcherlambdaSqsEventSourceRestateBYOCdefaultretirementwatcherqueueBDC523A27D939D1D:
    Type: 'AWS::Lambda::EventSourceMapping'
    Properties:
      BatchSize: 1
      EventSourceArn:
        'Fn::GetAtt':
          - defaultretirementwatcherqueue17CDF7F2
          - Arn
      FunctionName:
        Ref: defaultretirementwatcherlambda80A1658E
      Tags:
        - Key: Name
          Value: RestateBYOC/default/retirement-watcher-lambda
  defaultretirementwatcherqueue17CDF7F2:
    Type: 'AWS::SQS::Queue'
    Properties:
      Tags:
        - Key: Name
          Value: RestateBYOC/default/retirement-watcher-queue
      VisibilityTimeout: 60
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  defaultretirementwatcherqueuePolicyFD7DA2DA:
    Type: 'AWS::SQS::QueuePolicy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 'sqs:SendMessage'
              - 'sqs:GetQueueAttributes'
              - 'sqs:GetQueueUrl'
            Condition:
              ArnEquals:
                'aws:SourceArn':
                  'Fn::GetAtt':
                    - defaultretirementwatcherrule3F2F34F3
                    - Arn
            Effect: Allow
            Principal:
              Service: events.amazonaws.com
            Resource:
              'Fn::GetAtt':
                - defaultretirementwatcherqueue17CDF7F2
                - Arn
        Version: '2012-10-17'
      Queues:
        - Ref: defaultretirementwatcherqueue17CDF7F2
  defaultretirementwatcherrule3F2F34F3:
    Type: 'AWS::Events::Rule'
    Properties:
      EventPattern:
        detail:
          eventTypeCode:
            - equals-ignore-case: AWS_ECS_TASK_PATCHING_RETIREMENT
          service:
            - equals-ignore-case: ecs
        resources:
          - prefix:
              'Fn::Join':
                - /
                - - 'Fn::Join':
                      - ':'
                      - - 'Fn::Select':
                            - 0
                            - 'Fn::Split':
                                - ':'
                                - 'Fn::Select':
                                    - 0
                                    - 'Fn::Split':
                                        - /
                                        - 'Fn::GetAtt':
                                            - defaultcluster07071299
                                            - Arn
                        - 'Fn::Select':
                            - 1
                            - 'Fn::Split':
                                - ':'
                                - 'Fn::Select':
                                    - 0
                                    - 'Fn::Split':
                                        - /
                                        - 'Fn::GetAtt':
                                            - defaultcluster07071299
                                            - Arn
                        - 'Fn::Select':
                            - 2
                            - 'Fn::Split':
                                - ':'
                                - 'Fn::Select':
                                    - 0
                                    - 'Fn::Split':
                                        - /
                                        - 'Fn::GetAtt':
                                            - defaultcluster07071299
                                            - Arn
                        - 'Fn::Select':
                            - 3
                            - 'Fn::Split':
                                - ':'
                                - 'Fn::Select':
                                    - 0
                                    - 'Fn::Split':
                                        - /
                                        - 'Fn::GetAtt':
                                            - defaultcluster07071299
                                            - Arn
                        - 'Fn::Select':
                            - 4
                            - 'Fn::Split':
                                - ':'
                                - 'Fn::Select':
                                    - 0
                                    - 'Fn::Split':
                                        - /
                                        - 'Fn::GetAtt':
                                            - defaultcluster07071299
                                            - Arn
                        - task
                  - 'Fn::Select':
                      - 1
                      - 'Fn::Split':
                          - /
                          - 'Fn::GetAtt':
                              - defaultcluster07071299
                              - Arn
                  - ''
        detail-type:
          - equals-ignore-case: AWS Health Event
      State: ENABLED
      Targets:
        - Arn:
            'Fn::GetAtt':
              - defaultretirementwatcherqueue17CDF7F2
              - Arn
          Id: Target0
  defaultcloudwatchcustomwidgetloggroupD709CBDC:
    Type: 'AWS::Logs::LogGroup'
    Properties:
      RetentionInDays: 14
    UpdateReplacePolicy: Retain
    DeletionPolicy: Retain
  defaultcloudwatchcustomwidgetexecutionrole4ED639C0:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
        Version: '2012-10-17'
  defaultcloudwatchcustomwidgetexecutionroleDefaultPolicy61BF3642:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 'logs:CreateLogStream'
              - 'logs:PutLogEvents'
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'arn:'
                  - Ref: 'AWS::Partition'
                  - ':logs:'
                  - Ref: 'AWS::Region'
                  - ':'
                  - Ref: 'AWS::AccountId'
                  - ':log-group:'
                  - Ref: defaultcloudwatchcustomwidgetloggroupD709CBDC
                  - ':log-stream:*'
            Sid: AWSLambdaLogStreamPermissions
          - Action: 'lambda:InvokeFunction'
            Effect: Allow
            Resource:
              'Fn::GetAtt':
                - defaultrestatectllambda05E7B262
                - Arn
            Sid: InvokeRestatectl
          - Action: 'ecs:DescribeTaskDefinition'
            Effect: Allow
            Resource: '*'
            Sid: ECSReadActions
          - Action: 'ecs:ListTasks'
            Condition:
              StringEquals:
                'ecs:cluster':
                  'Fn::GetAtt':
                    - defaultcluster07071299
                    - Arn
            Effect: Allow
            Resource: '*'
            Sid: ECSListTasks
          - Action: 'ecs:DescribeTasks'
            Condition:
              StringEquals:
                'ecs:cluster':
                  'Fn::GetAtt':
                    - defaultcluster07071299
                    - Arn
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'arn:'
                  - Ref: 'AWS::Partition'
                  - ':ecs:'
                  - Ref: 'AWS::Region'
                  - ':'
                  - Ref: 'AWS::AccountId'
                  - ':task/'
                  - Ref: defaultcluster07071299
                  - /*
            Sid: ECSDescribeTasks
          - Action: 'ecs:DescribeServices'
            Condition:
              StringEquals:
                'ecs:cluster':
                  'Fn::GetAtt':
                    - defaultcluster07071299
                    - Arn
            Effect: Allow
            Resource:
              - Ref: defaultcontrollerserviceService18139D09
              - Ref: defaultstatelessserviceService8A7FABFB
            Sid: ECSDescribeServices
          - Action: 'cloudwatch:GetMetricData'
            Effect: Allow
            Resource: '*'
            Sid: CloudWatchReadActions
        Version: '2012-10-17'
      PolicyName: defaultcloudwatchcustomwidgetexecutionroleDefaultPolicy61BF3642
      Roles:
        - Ref: defaultcloudwatchcustomwidgetexecutionrole4ED639C0
  defaultcloudwatchcustomwidgetlambda65C26149:
    Type: 'AWS::Lambda::Function'
    Properties:
      Architectures:
        - arm64
      Code: Any<Object>
      Environment:
        Variables:
          ENABLE_EBS_VOLUMES: 'false'
      Handler: index.handler
      LoggingConfig:
        LogGroup:
          Ref: defaultcloudwatchcustomwidgetloggroupD709CBDC
      MemorySize: 1024
      Role:
        'Fn::GetAtt':
          - defaultcloudwatchcustomwidgetexecutionrole4ED639C0
          - Arn
      Runtime: nodejs22.x
      Tags:
        - Key: Name
          Value: RestateBYOC/default/cloudwatch-custom-widget-lambda
      Timeout: 60
    DependsOn:
      - defaultcloudwatchcustomwidgetexecutionroleDefaultPolicy61BF3642
      - defaultcloudwatchcustomwidgetexecutionrole4ED639C0
  defaultcloudwatchcustomwidgetlambdacloudwatchcustomwidgetlambdaallowdatasource2DAA7122:
    Type: 'AWS::Lambda::Permission'
    Properties:
      Action: 'lambda:InvokeFunction'
      FunctionName:
        'Fn::GetAtt':
          - defaultcloudwatchcustomwidgetlambda65C26149
          - Arn
      Principal: lambda.datasource.cloudwatch.amazonaws.com
  defaultmetrics63974EF8:
    Type: 'AWS::CloudWatch::Dashboard'
    Properties:
      DashboardBody:
        'Fn::Join':
          - ''
          - - >-
              {"widgets":[{"type":"metric","width":12,"height":6,"x":0,"y":0,"properties":{"view":"timeSeries","title":"Stateless
              CPU","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"CPU","expression":"SELECT AVG(CpuUtilized)
              FROM SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOCdefaultstatelessdefinitionFF58C79A' GROUP BY
              TaskId"}]],"annotations":{"horizontal":[{"value":16384,"label":"Limit","yAxis":"left"}]},"yAxis":{"left":{"label":"vCPUs","showUnits":false}}}},{"type":"metric","width":12,"height":6,"x":12,"y":0,"properties":{"view":"timeSeries","title":"Stateless
              Memory","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Memory","expression":"SELECT
              AVG(MemoryUtilized) FROM SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOCdefaultstatelessdefinitionFF58C79A' GROUP BY
              TaskId"}]],"annotations":{"horizontal":[{"value":32768,"label":"Limit","yAxis":"left"}]},"yAxis":{"left":{"label":"MiB","showUnits":false}}}},{"type":"metric","width":12,"height":6,"x":0,"y":6,"properties":{"view":"timeSeries","title":"Stateless
              Network Tx","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Tx","expression":"SELECT
              AVG(NetworkTxBytes) FROM SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOCdefaultstatelessdefinitionFF58C79A' GROUP BY
              TaskId"}]],"yAxis":{"left":{"label":"Bytes/sec","showUnits":false}}}},{"type":"metric","width":12,"height":6,"x":12,"y":6,"properties":{"view":"timeSeries","title":"Stateless
              Network Rx","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Rx","expression":"SELECT
              AVG(NetworkRxBytes) FROM SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOCdefaultstatelessdefinitionFF58C79A' GROUP BY
              TaskId"}]],"yAxis":{"left":{"label":"Bytes/sec","showUnits":false}}}},{"type":"log","width":24,"height":6,"x":0,"y":12,"properties":{"view":"table","title":"Stateless
              Logs","region":"region","query":"SOURCE '
            - Ref: defaultrestateloggroup8EFD0887
            - >-
              ' | fields @logStream, @timestamp, level, fields.message,
              target\\n          | sort @timestamp desc\\n          | limit
              500"}},{"type":"metric","width":12,"height":6,"x":0,"y":18,"properties":{"view":"timeSeries","title":"Stateful
              CPU","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"CPU","expression":"SELECT AVG(CpuUtilized)
              FROM SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOCdefaultstatefuldefinition4D62F21B' GROUP BY
              TaskId"}]],"annotations":{"horizontal":[{"value":16384,"label":"Limit","yAxis":"left"}]},"yAxis":{"left":{"label":"vCPUs","showUnits":false}}}},{"type":"metric","width":12,"height":6,"x":12,"y":18,"properties":{"view":"timeSeries","title":"Stateful
              Memory","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Memory","expression":"SELECT
              AVG(MemoryUtilized) FROM SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOCdefaultstatefuldefinition4D62F21B' GROUP BY
              TaskId"}]],"annotations":{"horizontal":[{"value":32768,"label":"Limit","yAxis":"left"}]},"yAxis":{"left":{"label":"MiB","showUnits":false}}}},{"type":"metric","width":12,"height":6,"x":0,"y":24,"properties":{"view":"timeSeries","title":"Stateful
              Network Tx","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Tx","expression":"SELECT
              AVG(NetworkTxBytes) FROM SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOCdefaultstatefuldefinition4D62F21B' GROUP BY
              TaskId"}]],"yAxis":{"left":{"label":"Bytes/sec","showUnits":false}}}},{"type":"metric","width":12,"height":6,"x":12,"y":24,"properties":{"view":"timeSeries","title":"Stateful
              Network Rx","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Rx","expression":"SELECT
              AVG(NetworkRxBytes) FROM SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOCdefaultstatefuldefinition4D62F21B' GROUP BY
              TaskId"}]],"yAxis":{"left":{"label":"Bytes/sec","showUnits":false}}}},{"type":"log","width":24,"height":6,"x":0,"y":30,"properties":{"view":"table","title":"Stateful
              Logs","region":"region","query":"SOURCE '
            - Ref: defaultrestateloggroup8EFD0887
            - >-
              ' | fields @logStream, @timestamp, level, fields.message,
              target\\n          | sort @timestamp desc\\n          | limit
              500"}},{"type":"metric","width":8,"height":6,"x":0,"y":36,"properties":{"view":"timeSeries","title":"Ephemeral
              Volume Usage (Total size 200GiB)","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Usage","expression":"SELECT
              MAX(EphemeralStorageUtilized) FROM
              SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily) WHERE TaskDefinitionFamily =
              'RestateBYOCdefaultstatefuldefinition4D62F21B'"}]],"annotations":{"horizontal":[{"value":200,"label":"Volume
              size","visible":false,"yAxis":"left"}]},"yAxis":{"left":{"label":"GiB","showUnits":false}},"liveData":false}},{"type":"metric","width":8,"height":6,"x":8,"y":36,"properties":{"view":"timeSeries","title":"Volume
              Write Throughput (Limited to 150 MiB/sec)","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Write","expression":"RATE(count) /
              1048576"}],[{"expression":"SELECT MAX(StorageWriteBytes) FROM
              SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOCdefaultstatefuldefinition4D62F21B' GROUP BY
              TaskId","visible":false,"id":"count"}]],"annotations":{"horizontal":[{"value":150,"label":"Limit","visible":false,"yAxis":"left"}]},"yAxis":{"left":{"label":"MiB/sec","showUnits":false}}}},{"type":"metric","width":8,"height":6,"x":16,"y":36,"properties":{"view":"timeSeries","title":"Volume
              Read Throughput (Limited to 150 MiB/sec)","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Read","expression":"RATE(count) /
              1048576"}],[{"expression":"SELECT MAX(StorageReadBytes) FROM
              SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOCdefaultstatefuldefinition4D62F21B' GROUP BY
              TaskId","visible":false,"id":"count"}]],"annotations":{"horizontal":[{"value":150,"label":"Limit","visible":false,"yAxis":"left"}]},"yAxis":{"left":{"label":"MiB/sec","showUnits":false}}}},{"type":"log","width":24,"height":6,"x":0,"y":42,"properties":{"view":"table","title":"Controller
              Logs","region":"region","query":"SOURCE '
            - Ref: defaultcontrollerloggroupD80898BE
            - >-
              ' | fields @logStream, @timestamp, level, fields.message,
              target\\n          | sort @timestamp desc\\n          | limit
              500"}}]}
      DashboardName: RestateBYOC_default_metrics
  defaultcontrolpanel3C04E2BB:
    Type: 'AWS::CloudWatch::Dashboard'
    Properties:
      DashboardBody:
        'Fn::Join':
          - ''
          - - >-
              {"widgets":[{"type":"custom","width":24,"height":26,"x":0,"y":0,"properties":{"endpoint":"
            - 'Fn::GetAtt':
                - defaultcloudwatchcustomwidgetlambda65C26149
                - Arn
            - '","params":{"command":"controlPanel","input":{"region":"'
            - Ref: 'AWS::Region'
            - >-
              ","summary":{"clusterName":"RestateBYOC/default","restateVersion":"1.4","stackVersion":"0.4.1-dev","metricsDashboardName":"
            - Ref: defaultmetrics63974EF8
            - '"},"resources":{"ecsClusterArn":"'
            - 'Fn::GetAtt':
                - defaultcluster07071299
                - Arn
            - '","statelessServiceArn":"'
            - Ref: defaultstatelessserviceService8A7FABFB
            - '","controllerServiceArn":"'
            - Ref: defaultcontrollerserviceService18139D09
            - '","restatectlLambdaArn":"'
            - 'Fn::GetAtt':
                - defaultrestatectllambda05E7B262
                - Arn
            - >-
              "},"connectivityAndSecurity":{"connectivity":{"loadBalancerArns":{"ingress":["
            - Ref: defaultsharednlb5E13F2A0
            - '"],"admin":["'
            - Ref: defaultsharednlb5E13F2A0
            - '"]},"addresses":{"ingress":"http://'
            - 'Fn::GetAtt':
                - defaultsharednlb5E13F2A0
                - DNSName
            - ':8080","admin":"http://'
            - 'Fn::GetAtt':
                - defaultsharednlb5E13F2A0
                - DNSName
            - ':9070","webUI":"http://'
            - 'Fn::GetAtt':
                - defaultsharednlb5E13F2A0
                - DNSName
            - ':9070/ui"}},"networking":{"vpc":"'
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcA2121C384D1B3CDE'
            - '","availabilityZones":["dummy1a","dummy1b","dummy1c"],"subnets":["'
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet1Subnet934893E8236E2271'
            - '","'
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet2Subnet7031C2BA60DCB1EE'
            - '","'
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet3Subnet985AC459F9514491'
            - '"]},"security":{"securityGroups":["'
            - 'Fn::GetAtt':
                - defaultsecuritygroupE8DEFA55
                - GroupId
            - '"]}},"storage":{"s3":{"bucket":"'
            - Ref: defaultbucket65304C97
            - >-
              "}}}},"title":"","updateOn":{"refresh":true,"resize":true,"timeRange":true}}}]}
      DashboardName: RestateBYOC_default_control-panel
Outputs:
  defaultSecurityGroupsCF504A2A:
    Description: The security group IDs of the cluster
    Value:
      'Fn::GetAtt':
        - defaultsecuritygroupE8DEFA55
        - GroupId
  defaultIngressNetworkListener8FF05F67:
    Description: The ARN of the network listener for the ingress port
    Value:
      Ref: defaultingresssharedlistener3AB06661
  defaultIngressNetworkTargetGroup19AC7829:
    Description: The ARN of the network target group for the ingress port
    Value:
      Ref: defaultingresssharedtarget501739FD
  defaultAdminNetworkListenerE2AFE07B:
    Description: The ARN of the network listener for the admin port
    Value:
      Ref: defaultadminsharedlistener2B6E2F69
  defaultAdminNetworkTargetGroupB2510956:
    Description: The ARN of the network target group for the admin port
    Value:
      Ref: defaultadminsharedtarget04FDBD2A
  defaultNodeNetworkListenerB7066909:
    Description: The ARN of the network listener for the node port
    Value:
      Ref: defaultnodesharedlistenerF94E5381
  defaultNodeNetworkTargetGroupA587B228:
    Description: The ARN of the network target group for the node port
    Value:
      Ref: defaultnodesharedtarget1C48E466
"
`;

exports[`BYOC Log groups can be customized after creation 1`] = `
"Resources:
  testsecuritygroupB015C031:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      GroupDescription: RestateBYOC/test/security-group
      SecurityGroupEgress:
        - CidrIp: 0.0.0.0/0
          Description: Allow all outbound traffic by default
          IpProtocol: '-1'
      Tags:
        - Key: Name
          Value: RestateBYOC/test/security-group
      VpcId:
        'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcA2121C384D1B3CDE'
  testsecuritygroupfromRestateBYOCtestsecuritygroupDC099EC280804D6652A7:
    Type: 'AWS::EC2::SecurityGroupIngress'
    Properties:
      Description: 'from RestateBYOCtestsecuritygroupDC099EC2:8080'
      FromPort: 8080
      GroupId:
        'Fn::GetAtt':
          - testsecuritygroupB015C031
          - GroupId
      IpProtocol: tcp
      SourceSecurityGroupId:
        'Fn::GetAtt':
          - testsecuritygroupB015C031
          - GroupId
      ToPort: 8080
  testsecuritygroupfromRestateBYOCtestsecuritygroupDC099EC2907024D2BE0B:
    Type: 'AWS::EC2::SecurityGroupIngress'
    Properties:
      Description: 'from RestateBYOCtestsecuritygroupDC099EC2:9070'
      FromPort: 9070
      GroupId:
        'Fn::GetAtt':
          - testsecuritygroupB015C031
          - GroupId
      IpProtocol: tcp
      SourceSecurityGroupId:
        'Fn::GetAtt':
          - testsecuritygroupB015C031
          - GroupId
      ToPort: 9070
  testsecuritygroupfromRestateBYOCtestsecuritygroupDC099EC25122D07222D4:
    Type: 'AWS::EC2::SecurityGroupIngress'
    Properties:
      Description: 'from RestateBYOCtestsecuritygroupDC099EC2:5122'
      FromPort: 5122
      GroupId:
        'Fn::GetAtt':
          - testsecuritygroupB015C031
          - GroupId
      IpProtocol: tcp
      SourceSecurityGroupId:
        'Fn::GetAtt':
          - testsecuritygroupB015C031
          - GroupId
      ToPort: 5122
  testbucket731B7DE2:
    Type: 'AWS::S3::Bucket'
    Properties:
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
    UpdateReplacePolicy: Retain
    DeletionPolicy: Retain
  testbucketPolicyB4FDDA54:
    Type: 'AWS::S3::BucketPolicy'
    Properties:
      Bucket:
        Ref: testbucket731B7DE2
      PolicyDocument:
        Statement:
          - Action: 's3:*'
            Condition:
              Bool:
                'aws:SecureTransport': 'false'
            Effect: Deny
            Principal:
              AWS: '*'
            Resource:
              - 'Fn::GetAtt':
                  - testbucket731B7DE2
                  - Arn
              - 'Fn::Join':
                  - ''
                  - - 'Fn::GetAtt':
                        - testbucket731B7DE2
                        - Arn
                    - /*
        Version: '2012-10-17'
  testclusterDBD4D436:
    Type: 'AWS::ECS::Cluster'
    Properties:
      ClusterSettings:
        - Name: containerInsights
          Value: enhanced
      Tags:
        - Key: Name
          Value: RestateBYOC/test/cluster
  testrestatetaskrole4CC243A3:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
        Version: '2012-10-17'
  testrestatetaskroleDefaultPolicy51A222FD:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 's3:GetObject'
              - 's3:PutObject'
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'Fn::GetAtt':
                      - testbucket731B7DE2
                      - Arn
                  - /*
            Sid: ReadWriteBucket
          - Action: 's3:ListBucket'
            Effect: Allow
            Resource:
              'Fn::GetAtt':
                - testbucket731B7DE2
                - Arn
            Sid: ListBucket
        Version: '2012-10-17'
      PolicyName: testrestatetaskroleDefaultPolicy51A222FD
      Roles:
        - Ref: testrestatetaskrole4CC243A3
  testrestateexecutionrole4CD7F161:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
        Version: '2012-10-17'
  testrestateexecutionroleDefaultPolicy04DC59EF:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 'logs:CreateLogStream'
              - 'logs:PutLogEvents'
            Effect: Allow
            Resource:
              'Fn::GetAtt':
                - testrestateloggroup6C0DD0DD
                - Arn
        Version: '2012-10-17'
      PolicyName: testrestateexecutionroleDefaultPolicy04DC59EF
      Roles:
        - Ref: testrestateexecutionrole4CD7F161
  testrestateloggroup6C0DD0DD:
    Type: 'AWS::Logs::LogGroup'
    Properties:
      RetentionInDays: 365
    UpdateReplacePolicy: Retain
    DeletionPolicy: Retain
  testcontrollerloggroupB61E47AC:
    Type: 'AWS::Logs::LogGroup'
    Properties:
      RetentionInDays: 365
    UpdateReplacePolicy: Retain
    DeletionPolicy: Retain
  testcontrollerloggrouperrormetric823876C8:
    Type: 'AWS::Logs::MetricFilter'
    Properties:
      FilterPattern: '[level=ERROR]'
      LogGroupName:
        Ref: testcontrollerloggroupB61E47AC
      MetricTransformations:
        - MetricName: Errors
          MetricNamespace: Restate/Controller
          MetricValue: '1'
  testsharednlb6BC10CBB:
    Type: 'AWS::ElasticLoadBalancingV2::LoadBalancer'
    Properties:
      LoadBalancerAttributes:
        - Key: deletion_protection.enabled
          Value: 'false'
        - Key: load_balancing.cross_zone.enabled
          Value: 'false'
        - Key: dns_record.client_routing_policy
          Value: availability_zone_affinity
      Scheme: internal
      SecurityGroups:
        - 'Fn::GetAtt':
            - testsecuritygroupB015C031
            - GroupId
      Subnets:
        - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet1Subnet934893E8236E2271'
        - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet2Subnet7031C2BA60DCB1EE'
        - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet3Subnet985AC459F9514491'
      Tags:
        - Key: Name
          Value: RestateBYOC/test/shared-nlb
      Type: network
  testingresssharedlistenerF18D3E56:
    Type: 'AWS::ElasticLoadBalancingV2::Listener'
    Properties:
      DefaultActions:
        - TargetGroupArn:
            Ref: testingresssharedtarget779E3570
          Type: forward
      LoadBalancerArn:
        Ref: testsharednlb6BC10CBB
      Port: 8080
      Protocol: TCP
  testadminsharedlistener6D147D79:
    Type: 'AWS::ElasticLoadBalancingV2::Listener'
    Properties:
      DefaultActions:
        - TargetGroupArn:
            Ref: testadminsharedtarget0C095FA8
          Type: forward
      LoadBalancerArn:
        Ref: testsharednlb6BC10CBB
      Port: 9070
      Protocol: TCP
  testnodesharedlistener98A38BFD:
    Type: 'AWS::ElasticLoadBalancingV2::Listener'
    Properties:
      DefaultActions:
        - TargetGroupArn:
            Ref: testnodesharedtarget6337BC22
          Type: forward
      LoadBalancerArn:
        Ref: testsharednlb6BC10CBB
      Port: 5122
      Protocol: TCP
  teststatelessdefinition64DABAD1:
    Type: 'AWS::ECS::TaskDefinition'
    Properties:
      ContainerDefinitions:
        - Cpu: 16384
          EntryPoint:
            - bash
            - '-c'
            - >

              curl --no-progress-meter $ECS_CONTAINER_METADATA_URI_V4 -o
              container-metadata && \\

              curl --no-progress-meter $ECS_CONTAINER_METADATA_URI_V4/task -o
              task-metadata && \\

              export \\
                RESTATE_NODE_NAME=$(jq -r '.TaskARN' task-metadata) \\
                RESTATE_LOCATION="$AWS_REGION.$(jq -r '.AvailabilityZone' task-metadata)" \\
                RESTATE_ADVERTISED_ADDRESS="http://$(jq -r '.Networks[0].IPv4Addresses[0]' container-metadata):5122"
              exec restate-server
          Environment:
            - Name: RESTATE_LOG_FORMAT
              Value: json
            - Name: RESTATE_CLUSTER_NAME
              Value: RestateBYOC/test
            - Name: RESTATE_ROLES
              Value: '["admin","http-ingress"]'
            - Name: RESTATE_AUTO_PROVISION
              Value: 'true'
            - Name: RESTATE_SHUTDOWN_TIMEOUT
              Value: 100s
            - Name: RESTATE_DEFAULT_NUM_PARTITIONS
              Value: '128'
            - Name: RESTATE_DEFAULT_REPLICATION
              Value: '{zone: 2}'
            - Name: RESTATE_METADATA_CLIENT__TYPE
              Value: object-store
            - Name: RESTATE_METADATA_CLIENT__PATH
              Value:
                'Fn::Join':
                  - ''
                  - - 's3://'
                    - Ref: testbucket731B7DE2
                    - /metadata
            - Name: RESTATE_BIFROST__DEFAULT_PROVIDER
              Value: replicated
            - Name: >-
                RESTATE_INGRESS__EXPERIMENTAL_FEATURE_ENABLE_SEPARATE_INGRESS_ROLE
              Value: 'true'
            - Name: RESTATE_INGRESS__ADVERTISED_INGRESS_ENDPOINT
              Value:
                'Fn::Join':
                  - ''
                  - - 'http://'
                    - 'Fn::GetAtt':
                        - testsharednlb6BC10CBB
                        - DNSName
                    - ':8080'
            - Name: RESTATE_WORKER__SNAPSHOTS__DESTINATION
              Value:
                'Fn::Join':
                  - ''
                  - - 's3://'
                    - Ref: testbucket731B7DE2
                    - /snapshots
          Essential: true
          HealthCheck:
            Command:
              - CMD
              - curl
              - '--fail'
              - 'http://127.0.0.1:8080/restate/health'
            Interval: 30
            Retries: 3
            Timeout: 5
          Image: Any<Object>
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group:
                Ref: testrestateloggroup6C0DD0DD
              awslogs-stream-prefix: restate
              awslogs-region: region
              mode: non-blocking
          Memory: 32768
          Name: restate
          PortMappings:
            - ContainerPort: 8080
              Name: ingress
              Protocol: tcp
            - ContainerPort: 9070
              Name: admin
              Protocol: tcp
            - ContainerPort: 5122
              Name: node
              Protocol: tcp
          StopTimeout: 120
      Cpu: '16384'
      ExecutionRoleArn:
        'Fn::GetAtt':
          - testrestateexecutionrole4CD7F161
          - Arn
      Family: RestateBYOCteststatelessdefinitionA59C4856
      Memory: '32768'
      NetworkMode: awsvpc
      RequiresCompatibilities:
        - FARGATE
      RuntimePlatform:
        CpuArchitecture: ARM64
        OperatingSystemFamily: LINUX
      Tags:
        - Key: Name
          Value: RestateBYOC/test/stateless-definition
      TaskRoleArn:
        'Fn::GetAtt':
          - testrestatetaskrole4CC243A3
          - Arn
  teststatelessserviceService5CDEA5F0:
    Type: 'AWS::ECS::Service'
    Properties:
      AvailabilityZoneRebalancing: ENABLED
      Cluster:
        Ref: testclusterDBD4D436
      DeploymentConfiguration:
        Alarms:
          AlarmNames: []
          Enable: false
          Rollback: false
        MaximumPercent: 200
        MinimumHealthyPercent: 100
      DeploymentController:
        Type: ECS
      DesiredCount: 3
      EnableECSManagedTags: false
      EnableExecuteCommand: false
      HealthCheckGracePeriodSeconds: 60
      LaunchType: FARGATE
      LoadBalancers:
        - ContainerName: restate
          ContainerPort: 8080
          TargetGroupArn:
            Ref: testingresssharedtarget779E3570
        - ContainerName: restate
          ContainerPort: 9070
          TargetGroupArn:
            Ref: testadminsharedtarget0C095FA8
        - ContainerName: restate
          ContainerPort: 5122
          TargetGroupArn:
            Ref: testnodesharedtarget6337BC22
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: DISABLED
          SecurityGroups:
            - 'Fn::GetAtt':
                - testsecuritygroupB015C031
                - GroupId
          Subnets:
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet1Subnet934893E8236E2271'
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet2Subnet7031C2BA60DCB1EE'
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet3Subnet985AC459F9514491'
      PropagateTags: SERVICE
      Tags:
        - Key: Name
          Value: RestateBYOC/test/stateless-service
      TaskDefinition:
        Ref: teststatelessdefinition64DABAD1
    DependsOn:
      - testadminsharedlistener6D147D79
      - testingresssharedlistenerF18D3E56
      - testnodesharedlistener98A38BFD
      - testrestatetaskroleDefaultPolicy51A222FD
      - testrestatetaskrole4CC243A3
  teststatefuldefinitionB92BAA14:
    Type: 'AWS::ECS::TaskDefinition'
    Properties:
      ContainerDefinitions:
        - Cpu: 16384
          EntryPoint:
            - bash
            - '-c'
            - >

              curl --no-progress-meter $ECS_CONTAINER_METADATA_URI_V4 -o
              container-metadata && \\

              curl --no-progress-meter $ECS_CONTAINER_METADATA_URI_V4/task -o
              task-metadata && \\

              export \\
                RESTATE_NODE_NAME=$(jq -r '.TaskARN' task-metadata) \\
                RESTATE_LOCATION="$AWS_REGION.$(jq -r '.AvailabilityZone' task-metadata)" \\
                RESTATE_ADVERTISED_ADDRESS="http://$(jq -r '.Networks[0].IPv4Addresses[0]' container-metadata):5122" \\
                RESTATE_ROCKSDB_TOTAL_MEMORY_SIZE="$(($(jq -r '.Limits.Memory' container-metadata) * 3 / 4))MiB" \\
                RESTATE_WORKER__STORAGE__NUM_PARTITIONS_TO_SHARE_MEMORY_BUDGET=$(("$RESTATE_WORKER__STORAGE__NUM_PARTITIONS_TO_SHARE_MEMORY_BUDGET"))
              exec restate-server
          Environment:
            - Name: RESTATE_LOG_FORMAT
              Value: json
            - Name: RESTATE_CLUSTER_NAME
              Value: RestateBYOC/test
            - Name: RESTATE_ROLES
              Value: '["log-server", "worker"]'
            - Name: RESTATE_AUTO_PROVISION
              Value: 'false'
            - Name: RESTATE_SHUTDOWN_TIMEOUT
              Value: 100s
            - Name: RESTATE_METADATA_CLIENT__TYPE
              Value: object-store
            - Name: RESTATE_METADATA_CLIENT__PATH
              Value:
                'Fn::Join':
                  - ''
                  - - 's3://'
                    - Ref: testbucket731B7DE2
                    - /metadata
            - Name: RESTATE_WORKER__SNAPSHOTS__DESTINATION
              Value:
                'Fn::Join':
                  - ''
                  - - 's3://'
                    - Ref: testbucket731B7DE2
                    - /snapshots
            - Name: RESTATE_WORKER__SNAPSHOTS__SNAPSHOT_INTERVAL_NUM_RECORDS
              Value: '1000000'
            - Name: RESTATE_WORKER__STORAGE__ROCKSDB_DISABLE_DIRECT_IO_FOR_READS
              Value: 'true'
            - Name: RESTATE_WORKER__STORAGE__ROCKSDB_DISABLE_WAL_FSYNC
              Value: 'true'
            - Name: RESTATE_WORKER__STORAGE__NUM_PARTITIONS_TO_SHARE_MEMORY_BUDGET
              Value: (128 * 2) / (3 * 1)
            - Name: RESTATE_LOG_SERVER__ROCKSDB_DISABLE_WAL_FSYNC
              Value: 'true'
            - Name: RESTATE_LOG_SERVER__ROCKSDB_DISABLE_DIRECT_IO_FOR_READS
              Value: 'true'
            - Name: >-
                RESTATE_INGRESS__EXPERIMENTAL_FEATURE_ENABLE_SEPARATE_INGRESS_ROLE
              Value: 'true'
          Essential: true
          HealthCheck:
            Command:
              - CMD
              - curl
              - '--fail'
              - 'http://127.0.0.1:5122/health'
            Interval: 30
            Retries: 3
            Timeout: 5
          Image: Any<Object>
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group:
                Ref: testrestateloggroup6C0DD0DD
              awslogs-stream-prefix: restate
              awslogs-region: region
              mode: non-blocking
          Memory: 32768
          MountPoints:
            - ContainerPath: /restate-data
              ReadOnly: false
              SourceVolume: restate-data
          Name: restate
          PortMappings:
            - ContainerPort: 5122
              Name: node
              Protocol: tcp
          RestartPolicy:
            Enabled: true
            RestartAttemptPeriod: 60
          StopTimeout: 120
      Cpu: '16384'
      EphemeralStorage:
        SizeInGiB: 200
      ExecutionRoleArn:
        'Fn::GetAtt':
          - testrestateexecutionrole4CD7F161
          - Arn
      Family: RestateBYOCteststatefuldefinition9B15D9BA
      Memory: '32768'
      NetworkMode: awsvpc
      RequiresCompatibilities:
        - FARGATE
      RuntimePlatform:
        CpuArchitecture: ARM64
        OperatingSystemFamily: LINUX
      Tags:
        - Key: Name
          Value: RestateBYOC/test/stateful-definition
      TaskRoleArn:
        'Fn::GetAtt':
          - testrestatetaskrole4CC243A3
          - Arn
      Volumes:
        - ConfiguredAtLaunch: false
          Name: restate-data
  testingresssharedtarget779E3570:
    Type: 'AWS::ElasticLoadBalancingV2::TargetGroup'
    Properties:
      HealthCheckEnabled: true
      HealthCheckIntervalSeconds: 5
      HealthCheckPath: /restate/health
      HealthCheckProtocol: HTTP
      HealthCheckTimeoutSeconds: 2
      Port: 8080
      Protocol: TCP
      Tags:
        - Key: Name
          Value: RestateBYOC/test/ingress-shared-target
      TargetType: ip
      VpcId:
        'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcA2121C384D1B3CDE'
  testadminsharedtarget0C095FA8:
    Type: 'AWS::ElasticLoadBalancingV2::TargetGroup'
    Properties:
      HealthCheckEnabled: true
      HealthCheckIntervalSeconds: 5
      HealthCheckPath: /health
      HealthCheckPort: '9070'
      HealthCheckProtocol: HTTP
      HealthCheckTimeoutSeconds: 2
      Port: 9070
      Protocol: TCP
      Tags:
        - Key: Name
          Value: RestateBYOC/test/admin-shared-target
      TargetType: ip
      VpcId:
        'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcA2121C384D1B3CDE'
  testnodesharedtarget6337BC22:
    Type: 'AWS::ElasticLoadBalancingV2::TargetGroup'
    Properties:
      HealthCheckEnabled: true
      HealthCheckIntervalSeconds: 5
      HealthCheckPath: /health
      HealthCheckPort: '5122'
      HealthCheckProtocol: HTTP
      HealthCheckTimeoutSeconds: 2
      Port: 5122
      Protocol: TCP
      Tags:
        - Key: Name
          Value: RestateBYOC/test/node-shared-target
      TargetType: ip
      VpcId:
        'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcA2121C384D1B3CDE'
  testcontrollertaskrole42417C6E:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
        Version: '2012-10-17'
  testcontrollertaskroleDefaultPolicy030D6236:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action: 'ecs:ListTasks'
            Condition:
              ArnEquals:
                'ecs:cluster':
                  'Fn::GetAtt':
                    - testclusterDBD4D436
                    - Arn
            Effect: Allow
            Resource: '*'
            Sid: ECSListActions
          - Action:
              - 'ecs:TagResource'
              - 'ecs:DescribeTasks'
              - 'ecs:StopTask'
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'Fn::Join':
                      - /
                      - - 'Fn::Join':
                            - ':'
                            - - 'Fn::Select':
                                  - 0
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - testclusterDBD4D436
                                                  - Arn
                              - 'Fn::Select':
                                  - 1
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - testclusterDBD4D436
                                                  - Arn
                              - 'Fn::Select':
                                  - 2
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - testclusterDBD4D436
                                                  - Arn
                              - 'Fn::Select':
                                  - 3
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - testclusterDBD4D436
                                                  - Arn
                              - 'Fn::Select':
                                  - 4
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - testclusterDBD4D436
                                                  - Arn
                              - task
                        - 'Fn::Select':
                            - 1
                            - 'Fn::Split':
                                - /
                                - 'Fn::GetAtt':
                                    - testclusterDBD4D436
                                    - Arn
                        - ''
                  - '*'
            Sid: TaskActions
          - Action: 'ecs:RunTask'
            Condition:
              ArnEquals:
                'ecs:cluster':
                  'Fn::GetAtt':
                    - testclusterDBD4D436
                    - Arn
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'Fn::Join':
                      - ':'
                      - - 'Fn::Select':
                            - 0
                            - 'Fn::Split':
                                - ':'
                                - Ref: teststatefuldefinitionB92BAA14
                        - 'Fn::Select':
                            - 1
                            - 'Fn::Split':
                                - ':'
                                - Ref: teststatefuldefinitionB92BAA14
                        - 'Fn::Select':
                            - 2
                            - 'Fn::Split':
                                - ':'
                                - Ref: teststatefuldefinitionB92BAA14
                        - 'Fn::Select':
                            - 3
                            - 'Fn::Split':
                                - ':'
                                - Ref: teststatefuldefinitionB92BAA14
                        - 'Fn::Select':
                            - 4
                            - 'Fn::Split':
                                - ':'
                                - Ref: teststatefuldefinitionB92BAA14
                        - 'Fn::Select':
                            - 5
                            - 'Fn::Split':
                                - ':'
                                - Ref: teststatefuldefinitionB92BAA14
                  - ':*'
            Sid: RunTask
          - Action: 'iam:PassRole'
            Condition:
              StringEquals:
                'iam:PassedToService': ecs-tasks.amazonaws.com
            Effect: Allow
            Resource:
              - 'Fn::GetAtt':
                  - testrestatetaskrole4CC243A3
                  - Arn
              - 'Fn::GetAtt':
                  - testrestateexecutionrole4CD7F161
                  - Arn
            Sid: RunTaskPassRole
          - Action:
              - 'ec2:DescribeVolumes'
              - 'ec2:DescribeSnapshots'
            Effect: Allow
            Resource: '*'
            Sid: EC2ListActions
          - Action: 'ec2:CreateSnapshot'
            Condition:
              ArnEquals:
                'aws:RequestTag/restate:ecsClusterArn':
                  'Fn::GetAtt':
                    - testclusterDBD4D436
                    - Arn
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'arn:'
                  - Ref: 'AWS::Partition'
                  - ':ec2:'
                  - Ref: 'AWS::Region'
                  - '::snapshot/*'
            Sid: CreateSnapshot
          - Action: 'ec2:CreateSnapshot'
            Condition:
              ArnEquals:
                'aws:ResourceTag/restate:ecsClusterArn':
                  'Fn::GetAtt':
                    - testclusterDBD4D436
                    - Arn
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'arn:'
                  - Ref: 'AWS::Partition'
                  - ':ec2:'
                  - Ref: 'AWS::Region'
                  - ':'
                  - Ref: 'AWS::AccountId'
                  - ':volume/*'
            Sid: SnapshotVolume
          - Action: 'ec2:CreateTags'
            Condition:
              StringEquals:
                'ec2:CreateAction': CreateSnapshot
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'arn:'
                  - Ref: 'AWS::Partition'
                  - ':ec2:'
                  - Ref: 'AWS::Region'
                  - '::snapshot/*'
            Sid: TagSnapshots
          - Action:
              - 'ec2:DeleteVolume'
              - 'ec2:DeleteSnapshot'
            Condition:
              ArnEquals:
                'aws:ResourceTag/restate:ecsClusterArn':
                  'Fn::GetAtt':
                    - testclusterDBD4D436
                    - Arn
            Effect: Allow
            Resource:
              - 'Fn::Join':
                  - ''
                  - - 'arn:'
                    - Ref: 'AWS::Partition'
                    - ':ec2:'
                    - Ref: 'AWS::Region'
                    - ':'
                    - Ref: 'AWS::AccountId'
                    - ':volume/*'
              - 'Fn::Join':
                  - ''
                  - - 'arn:'
                    - Ref: 'AWS::Partition'
                    - ':ec2:'
                    - Ref: 'AWS::Region'
                    - '::snapshot/*'
            Sid: DeleteVolumeAndSnapshot
          - Action:
              - 's3:GetObject'
              - 's3:PutObject'
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'Fn::GetAtt':
                      - testbucket731B7DE2
                      - Arn
                  - /*
            Sid: ReadWriteBucket
          - Action: 's3:ListBucket'
            Effect: Allow
            Resource:
              'Fn::GetAtt':
                - testbucket731B7DE2
                - Arn
            Sid: ListBucket
        Version: '2012-10-17'
      PolicyName: testcontrollertaskroleDefaultPolicy030D6236
      Roles:
        - Ref: testcontrollertaskrole42417C6E
  testcontrollerexecutionrole3BE0C8C4:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
        Version: '2012-10-17'
  testcontrollerexecutionroleDefaultPolicy443CB52A:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 'logs:CreateLogStream'
              - 'logs:PutLogEvents'
            Effect: Allow
            Resource:
              'Fn::GetAtt':
                - testcontrollerloggroupB61E47AC
                - Arn
        Version: '2012-10-17'
      PolicyName: testcontrollerexecutionroleDefaultPolicy443CB52A
      Roles:
        - Ref: testcontrollerexecutionrole3BE0C8C4
  testcontrollerdefinition0C4BC223:
    Type: 'AWS::ECS::TaskDefinition'
    Properties:
      ContainerDefinitions:
        - Cpu: 1024
          Environment:
            - Name: RUST_LOG
              Value: 'info,restate_fargate_controller=debug'
            - Name: CONTROLLER_LOG_FORMAT
              Value: json
            - Name: CONTROLLER_METADATA_PATH
              Value:
                'Fn::Join':
                  - ''
                  - - 's3://'
                    - Ref: testbucket731B7DE2
                    - /metadata
            - Name: CONTROLLER_RECONCILE_INTERVAL
              Value: 10s
            - Name: CONTROLLER_CLUSTER__CLUSTER_ARN
              Value:
                'Fn::GetAtt':
                  - testclusterDBD4D436
                  - Arn
            - Name: CONTROLLER_LICENSE_KEY
              Value: foo
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __REGION
              Value:
                Ref: 'AWS::Region'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __CLUSTER_ARN
              Value:
                'Fn::GetAtt':
                  - testclusterDBD4D436
                  - Arn
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __TASK_PREFIX
              Value:
                'Fn::Join':
                  - /
                  - - 'Fn::Join':
                        - ':'
                        - - 'Fn::Select':
                              - 0
                              - 'Fn::Split':
                                  - ':'
                                  - 'Fn::Select':
                                      - 0
                                      - 'Fn::Split':
                                          - /
                                          - 'Fn::GetAtt':
                                              - testclusterDBD4D436
                                              - Arn
                          - 'Fn::Select':
                              - 1
                              - 'Fn::Split':
                                  - ':'
                                  - 'Fn::Select':
                                      - 0
                                      - 'Fn::Split':
                                          - /
                                          - 'Fn::GetAtt':
                                              - testclusterDBD4D436
                                              - Arn
                          - 'Fn::Select':
                              - 2
                              - 'Fn::Split':
                                  - ':'
                                  - 'Fn::Select':
                                      - 0
                                      - 'Fn::Split':
                                          - /
                                          - 'Fn::GetAtt':
                                              - testclusterDBD4D436
                                              - Arn
                          - 'Fn::Select':
                              - 3
                              - 'Fn::Split':
                                  - ':'
                                  - 'Fn::Select':
                                      - 0
                                      - 'Fn::Split':
                                          - /
                                          - 'Fn::GetAtt':
                                              - testclusterDBD4D436
                                              - Arn
                          - 'Fn::Select':
                              - 4
                              - 'Fn::Split':
                                  - ':'
                                  - 'Fn::Select':
                                      - 0
                                      - 'Fn::Split':
                                          - /
                                          - 'Fn::GetAtt':
                                              - testclusterDBD4D436
                                              - Arn
                          - task
                    - 'Fn::Select':
                        - 1
                        - 'Fn::Split':
                            - /
                            - 'Fn::GetAtt':
                                - testclusterDBD4D436
                                - Arn
                    - ''
            - Name: CONTROLLER_EBS_SNAPSHOT_RETENTION_PERIOD
              Value: 24h
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1a__ENABLE_EXECUTE_COMMAND
              Value: 'false'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1a__SECURITY_GROUPS
              Value:
                'Fn::Join':
                  - ''
                  - - '["'
                    - 'Fn::GetAtt':
                        - testsecuritygroupB015C031
                        - GroupId
                    - '"]'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1a__SUBNETS
              Value:
                'Fn::Join':
                  - ''
                  - - '["'
                    - 'Fn::ImportValue': >-
                        VPCStack:ExportsOutputRefvpcPrivateSubnet1Subnet934893E8236E2271
                    - '"]'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1a__TASK_DEFINITION_ARN
              Value:
                Ref: teststatefuldefinitionB92BAA14
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1a__COUNT
              Value: '1'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1b__ENABLE_EXECUTE_COMMAND
              Value: 'false'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1b__SECURITY_GROUPS
              Value:
                'Fn::Join':
                  - ''
                  - - '["'
                    - 'Fn::GetAtt':
                        - testsecuritygroupB015C031
                        - GroupId
                    - '"]'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1b__SUBNETS
              Value:
                'Fn::Join':
                  - ''
                  - - '["'
                    - 'Fn::ImportValue': >-
                        VPCStack:ExportsOutputRefvpcPrivateSubnet2Subnet7031C2BA60DCB1EE
                    - '"]'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1b__TASK_DEFINITION_ARN
              Value:
                Ref: teststatefuldefinitionB92BAA14
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1b__COUNT
              Value: '1'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1c__ENABLE_EXECUTE_COMMAND
              Value: 'false'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1c__SECURITY_GROUPS
              Value:
                'Fn::Join':
                  - ''
                  - - '["'
                    - 'Fn::GetAtt':
                        - testsecuritygroupB015C031
                        - GroupId
                    - '"]'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1c__SUBNETS
              Value:
                'Fn::Join':
                  - ''
                  - - '["'
                    - 'Fn::ImportValue': >-
                        VPCStack:ExportsOutputRefvpcPrivateSubnet3Subnet985AC459F9514491
                    - '"]'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1c__TASK_DEFINITION_ARN
              Value:
                Ref: teststatefuldefinitionB92BAA14
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1c__COUNT
              Value: '1'
          Essential: true
          HealthCheck:
            Command:
              - CMD
              - curl
              - '--fail'
              - 'http://127.0.0.1:8080/health'
            Interval: 30
            Retries: 10
            StartPeriod: 300
            Timeout: 5
          Image: Any<Object>
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group:
                Ref: testcontrollerloggroupB61E47AC
              awslogs-stream-prefix: controller
              awslogs-region: region
              mode: non-blocking
          Memory: 2048
          Name: controller
          StopTimeout: 120
      Cpu: '1024'
      ExecutionRoleArn:
        'Fn::GetAtt':
          - testcontrollerexecutionrole3BE0C8C4
          - Arn
      Family: RestateBYOCtestcontrollerdefinitionA329F74F
      Memory: '2048'
      NetworkMode: awsvpc
      RequiresCompatibilities:
        - FARGATE
      RuntimePlatform:
        CpuArchitecture: ARM64
        OperatingSystemFamily: LINUX
      Tags:
        - Key: Name
          Value: RestateBYOC/test/controller-definition
      TaskRoleArn:
        'Fn::GetAtt':
          - testcontrollertaskrole42417C6E
          - Arn
  testcontrollerserviceService356186D6:
    Type: 'AWS::ECS::Service'
    Properties:
      Cluster:
        Ref: testclusterDBD4D436
      DeploymentConfiguration:
        Alarms:
          AlarmNames: []
          Enable: false
          Rollback: false
        MaximumPercent: 100
        MinimumHealthyPercent: 0
      DeploymentController:
        Type: ECS
      DesiredCount: 1
      EnableECSManagedTags: false
      EnableExecuteCommand: false
      LaunchType: FARGATE
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: DISABLED
          SecurityGroups:
            - 'Fn::GetAtt':
                - testsecuritygroupB015C031
                - GroupId
          Subnets:
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet1Subnet934893E8236E2271'
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet2Subnet7031C2BA60DCB1EE'
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet3Subnet985AC459F9514491'
      Tags:
        - Key: Name
          Value: RestateBYOC/test/controller-service
      TaskDefinition:
        Ref: testcontrollerdefinition0C4BC223
    DependsOn:
      - testcontrollertaskroleDefaultPolicy030D6236
      - testcontrollertaskrole42417C6E
  testrestatectlloggroupC2AAB6C7:
    Type: 'AWS::Logs::LogGroup'
    Properties:
      RetentionInDays: 180
    UpdateReplacePolicy: Retain
    DeletionPolicy: Retain
  testrestatectllambdaexecutionrole9C923F83:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
        Version: '2012-10-17'
  testrestatectllambdaexecutionroleDefaultPolicy93BA3725:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 'logs:CreateLogStream'
              - 'logs:PutLogEvents'
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'arn:'
                  - Ref: 'AWS::Partition'
                  - ':logs:'
                  - Ref: 'AWS::Region'
                  - ':'
                  - Ref: 'AWS::AccountId'
                  - ':log-group:'
                  - Ref: testrestatectlloggroupC2AAB6C7
                  - ':log-stream:*'
            Sid: AWSLambdaLogStreamPermissions
          - Action:
              - 'ec2:CreateNetworkInterface'
              - 'ec2:DescribeNetworkInterfaces'
              - 'ec2:DescribeSubnets'
              - 'ec2:DeleteNetworkInterface'
            Effect: Allow
            Resource: '*'
            Sid: AWSLambdaVPCWildcardPermissions
          - Action:
              - 'ec2:AssignPrivateIpAddresses'
              - 'ec2:UnassignPrivateIpAddresses'
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'arn:'
                  - Ref: 'AWS::Partition'
                  - ':ec2:'
                  - Ref: 'AWS::Region'
                  - ':'
                  - Ref: 'AWS::AccountId'
                  - ':network-interface/*'
            Sid: AWSLambdaVPCNetworkInterfacePermissions
        Version: '2012-10-17'
      PolicyName: testrestatectllambdaexecutionroleDefaultPolicy93BA3725
      Roles:
        - Ref: testrestatectllambdaexecutionrole9C923F83
  testrestatectllambda6F1900FA:
    Type: 'AWS::Lambda::Function'
    Properties:
      Architectures:
        - arm64
      Code: Any<Object>
      Environment:
        Variables:
          RESTATECTL_ADDRESS:
            'Fn::Join':
              - ''
              - - 'http://'
                - 'Fn::GetAtt':
                    - testsharednlb6BC10CBB
                    - DNSName
                - ':5122'
      Handler: restatectl
      LoggingConfig:
        LogGroup:
          Ref: testrestatectlloggroupC2AAB6C7
      Role:
        'Fn::GetAtt':
          - testrestatectllambdaexecutionrole9C923F83
          - Arn
      Runtime: provided.al2023
      Tags:
        - Key: Name
          Value: RestateBYOC/test/restatectl-lambda
      Timeout: 10
      VpcConfig:
        SecurityGroupIds:
          - 'Fn::GetAtt':
              - testsecuritygroupB015C031
              - GroupId
        SubnetIds:
          - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet1Subnet934893E8236E2271'
          - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet2Subnet7031C2BA60DCB1EE'
          - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet3Subnet985AC459F9514491'
    DependsOn:
      - testrestatectllambdaexecutionroleDefaultPolicy93BA3725
      - testrestatectllambdaexecutionrole9C923F83
  testretirementwatcherloggroupBCD89B2E:
    Type: 'AWS::Logs::LogGroup'
    Properties:
      RetentionInDays: 180
    UpdateReplacePolicy: Retain
    DeletionPolicy: Retain
  testretirementwatcherlambdaexecutionrole0BCEB9D0:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
        Version: '2012-10-17'
  testretirementwatcherlambdaexecutionroleDefaultPolicy6E9FBD0D:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 'logs:CreateLogStream'
              - 'logs:PutLogEvents'
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'arn:'
                  - Ref: 'AWS::Partition'
                  - ':logs:'
                  - Ref: 'AWS::Region'
                  - ':'
                  - Ref: 'AWS::AccountId'
                  - ':log-group:'
                  - Ref: testretirementwatcherloggroupBCD89B2E
                  - ':log-stream:*'
            Sid: AWSLambdaLogStreamPermissions
          - Action: 'ecs:TagResource'
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'Fn::Join':
                      - /
                      - - 'Fn::Join':
                            - ':'
                            - - 'Fn::Select':
                                  - 0
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - testclusterDBD4D436
                                                  - Arn
                              - 'Fn::Select':
                                  - 1
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - testclusterDBD4D436
                                                  - Arn
                              - 'Fn::Select':
                                  - 2
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - testclusterDBD4D436
                                                  - Arn
                              - 'Fn::Select':
                                  - 3
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - testclusterDBD4D436
                                                  - Arn
                              - 'Fn::Select':
                                  - 4
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - testclusterDBD4D436
                                                  - Arn
                              - task
                        - 'Fn::Select':
                            - 1
                            - 'Fn::Split':
                                - /
                                - 'Fn::GetAtt':
                                    - testclusterDBD4D436
                                    - Arn
                        - ''
                  - '*'
            Sid: TagTasks
          - Action:
              - 'sqs:ReceiveMessage'
              - 'sqs:ChangeMessageVisibility'
              - 'sqs:GetQueueUrl'
              - 'sqs:DeleteMessage'
              - 'sqs:GetQueueAttributes'
            Effect: Allow
            Resource:
              'Fn::GetAtt':
                - testretirementwatcherqueue71FDBFE9
                - Arn
        Version: '2012-10-17'
      PolicyName: testretirementwatcherlambdaexecutionroleDefaultPolicy6E9FBD0D
      Roles:
        - Ref: testretirementwatcherlambdaexecutionrole0BCEB9D0
  testretirementwatcherlambdaF666308D:
    Type: 'AWS::Lambda::Function'
    Properties:
      Architectures:
        - arm64
      Code: Any<Object>
      Handler: index.handler
      LoggingConfig:
        LogGroup:
          Ref: testretirementwatcherloggroupBCD89B2E
      Role:
        'Fn::GetAtt':
          - testretirementwatcherlambdaexecutionrole0BCEB9D0
          - Arn
      Runtime: nodejs22.x
      Tags:
        - Key: Name
          Value: RestateBYOC/test/retirement-watcher-lambda
      Timeout: 60
    DependsOn:
      - testretirementwatcherlambdaexecutionroleDefaultPolicy6E9FBD0D
      - testretirementwatcherlambdaexecutionrole0BCEB9D0
  testretirementwatcherlambdaSqsEventSourceRestateBYOCtestretirementwatcherqueue805C85E9DF913057:
    Type: 'AWS::Lambda::EventSourceMapping'
    Properties:
      BatchSize: 1
      EventSourceArn:
        'Fn::GetAtt':
          - testretirementwatcherqueue71FDBFE9
          - Arn
      FunctionName:
        Ref: testretirementwatcherlambdaF666308D
      Tags:
        - Key: Name
          Value: RestateBYOC/test/retirement-watcher-lambda
  testretirementwatcherqueue71FDBFE9:
    Type: 'AWS::SQS::Queue'
    Properties:
      Tags:
        - Key: Name
          Value: RestateBYOC/test/retirement-watcher-queue
      VisibilityTimeout: 60
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  testretirementwatcherqueuePolicy7D50DFC3:
    Type: 'AWS::SQS::QueuePolicy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 'sqs:SendMessage'
              - 'sqs:GetQueueAttributes'
              - 'sqs:GetQueueUrl'
            Condition:
              ArnEquals:
                'aws:SourceArn':
                  'Fn::GetAtt':
                    - testretirementwatcherruleBA70D9F7
                    - Arn
            Effect: Allow
            Principal:
              Service: events.amazonaws.com
            Resource:
              'Fn::GetAtt':
                - testretirementwatcherqueue71FDBFE9
                - Arn
        Version: '2012-10-17'
      Queues:
        - Ref: testretirementwatcherqueue71FDBFE9
  testretirementwatcherruleBA70D9F7:
    Type: 'AWS::Events::Rule'
    Properties:
      EventPattern:
        detail:
          eventTypeCode:
            - equals-ignore-case: AWS_ECS_TASK_PATCHING_RETIREMENT
          service:
            - equals-ignore-case: ecs
        resources:
          - prefix:
              'Fn::Join':
                - /
                - - 'Fn::Join':
                      - ':'
                      - - 'Fn::Select':
                            - 0
                            - 'Fn::Split':
                                - ':'
                                - 'Fn::Select':
                                    - 0
                                    - 'Fn::Split':
                                        - /
                                        - 'Fn::GetAtt':
                                            - testclusterDBD4D436
                                            - Arn
                        - 'Fn::Select':
                            - 1
                            - 'Fn::Split':
                                - ':'
                                - 'Fn::Select':
                                    - 0
                                    - 'Fn::Split':
                                        - /
                                        - 'Fn::GetAtt':
                                            - testclusterDBD4D436
                                            - Arn
                        - 'Fn::Select':
                            - 2
                            - 'Fn::Split':
                                - ':'
                                - 'Fn::Select':
                                    - 0
                                    - 'Fn::Split':
                                        - /
                                        - 'Fn::GetAtt':
                                            - testclusterDBD4D436
                                            - Arn
                        - 'Fn::Select':
                            - 3
                            - 'Fn::Split':
                                - ':'
                                - 'Fn::Select':
                                    - 0
                                    - 'Fn::Split':
                                        - /
                                        - 'Fn::GetAtt':
                                            - testclusterDBD4D436
                                            - Arn
                        - 'Fn::Select':
                            - 4
                            - 'Fn::Split':
                                - ':'
                                - 'Fn::Select':
                                    - 0
                                    - 'Fn::Split':
                                        - /
                                        - 'Fn::GetAtt':
                                            - testclusterDBD4D436
                                            - Arn
                        - task
                  - 'Fn::Select':
                      - 1
                      - 'Fn::Split':
                          - /
                          - 'Fn::GetAtt':
                              - testclusterDBD4D436
                              - Arn
                  - ''
        detail-type:
          - equals-ignore-case: AWS Health Event
      State: ENABLED
      Targets:
        - Arn:
            'Fn::GetAtt':
              - testretirementwatcherqueue71FDBFE9
              - Arn
          Id: Target0
  testcloudwatchcustomwidgetloggroupEBFA438D:
    Type: 'AWS::Logs::LogGroup'
    Properties:
      RetentionInDays: 180
    UpdateReplacePolicy: Retain
    DeletionPolicy: Retain
  testcloudwatchcustomwidgetexecutionrole72F32199:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
        Version: '2012-10-17'
  testcloudwatchcustomwidgetexecutionroleDefaultPolicy4D8EC73B:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 'logs:CreateLogStream'
              - 'logs:PutLogEvents'
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'arn:'
                  - Ref: 'AWS::Partition'
                  - ':logs:'
                  - Ref: 'AWS::Region'
                  - ':'
                  - Ref: 'AWS::AccountId'
                  - ':log-group:'
                  - Ref: testcloudwatchcustomwidgetloggroupEBFA438D
                  - ':log-stream:*'
            Sid: AWSLambdaLogStreamPermissions
          - Action: 'lambda:InvokeFunction'
            Effect: Allow
            Resource:
              'Fn::GetAtt':
                - testrestatectllambda6F1900FA
                - Arn
            Sid: InvokeRestatectl
          - Action: 'ecs:DescribeTaskDefinition'
            Effect: Allow
            Resource: '*'
            Sid: ECSReadActions
          - Action: 'ecs:ListTasks'
            Condition:
              StringEquals:
                'ecs:cluster':
                  'Fn::GetAtt':
                    - testclusterDBD4D436
                    - Arn
            Effect: Allow
            Resource: '*'
            Sid: ECSListTasks
          - Action: 'ecs:DescribeTasks'
            Condition:
              StringEquals:
                'ecs:cluster':
                  'Fn::GetAtt':
                    - testclusterDBD4D436
                    - Arn
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'arn:'
                  - Ref: 'AWS::Partition'
                  - ':ecs:'
                  - Ref: 'AWS::Region'
                  - ':'
                  - Ref: 'AWS::AccountId'
                  - ':task/'
                  - Ref: testclusterDBD4D436
                  - /*
            Sid: ECSDescribeTasks
          - Action: 'ecs:DescribeServices'
            Condition:
              StringEquals:
                'ecs:cluster':
                  'Fn::GetAtt':
                    - testclusterDBD4D436
                    - Arn
            Effect: Allow
            Resource:
              - Ref: testcontrollerserviceService356186D6
              - Ref: teststatelessserviceService5CDEA5F0
            Sid: ECSDescribeServices
          - Action: 'cloudwatch:GetMetricData'
            Effect: Allow
            Resource: '*'
            Sid: CloudWatchReadActions
        Version: '2012-10-17'
      PolicyName: testcloudwatchcustomwidgetexecutionroleDefaultPolicy4D8EC73B
      Roles:
        - Ref: testcloudwatchcustomwidgetexecutionrole72F32199
  testcloudwatchcustomwidgetlambdaB0DB8C59:
    Type: 'AWS::Lambda::Function'
    Properties:
      Architectures:
        - arm64
      Code: Any<Object>
      Environment:
        Variables:
          ENABLE_EBS_VOLUMES: 'false'
      Handler: index.handler
      LoggingConfig:
        LogGroup:
          Ref: testcloudwatchcustomwidgetloggroupEBFA438D
      MemorySize: 1024
      Role:
        'Fn::GetAtt':
          - testcloudwatchcustomwidgetexecutionrole72F32199
          - Arn
      Runtime: nodejs22.x
      Tags:
        - Key: Name
          Value: RestateBYOC/test/cloudwatch-custom-widget-lambda
      Timeout: 60
    DependsOn:
      - testcloudwatchcustomwidgetexecutionroleDefaultPolicy4D8EC73B
      - testcloudwatchcustomwidgetexecutionrole72F32199
  testcloudwatchcustomwidgetlambdacloudwatchcustomwidgetlambdaallowdatasource06DF513A:
    Type: 'AWS::Lambda::Permission'
    Properties:
      Action: 'lambda:InvokeFunction'
      FunctionName:
        'Fn::GetAtt':
          - testcloudwatchcustomwidgetlambdaB0DB8C59
          - Arn
      Principal: lambda.datasource.cloudwatch.amazonaws.com
  testmetricsAAAB7FF4:
    Type: 'AWS::CloudWatch::Dashboard'
    Properties:
      DashboardBody:
        'Fn::Join':
          - ''
          - - >-
              {"widgets":[{"type":"metric","width":12,"height":6,"x":0,"y":0,"properties":{"view":"timeSeries","title":"Stateless
              CPU","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"CPU","expression":"SELECT AVG(CpuUtilized)
              FROM SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOCteststatelessdefinitionA59C4856' GROUP BY
              TaskId"}]],"annotations":{"horizontal":[{"value":16384,"label":"Limit","yAxis":"left"}]},"yAxis":{"left":{"label":"vCPUs","showUnits":false}}}},{"type":"metric","width":12,"height":6,"x":12,"y":0,"properties":{"view":"timeSeries","title":"Stateless
              Memory","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Memory","expression":"SELECT
              AVG(MemoryUtilized) FROM SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOCteststatelessdefinitionA59C4856' GROUP BY
              TaskId"}]],"annotations":{"horizontal":[{"value":32768,"label":"Limit","yAxis":"left"}]},"yAxis":{"left":{"label":"MiB","showUnits":false}}}},{"type":"metric","width":12,"height":6,"x":0,"y":6,"properties":{"view":"timeSeries","title":"Stateless
              Network Tx","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Tx","expression":"SELECT
              AVG(NetworkTxBytes) FROM SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOCteststatelessdefinitionA59C4856' GROUP BY
              TaskId"}]],"yAxis":{"left":{"label":"Bytes/sec","showUnits":false}}}},{"type":"metric","width":12,"height":6,"x":12,"y":6,"properties":{"view":"timeSeries","title":"Stateless
              Network Rx","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Rx","expression":"SELECT
              AVG(NetworkRxBytes) FROM SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOCteststatelessdefinitionA59C4856' GROUP BY
              TaskId"}]],"yAxis":{"left":{"label":"Bytes/sec","showUnits":false}}}},{"type":"log","width":24,"height":6,"x":0,"y":12,"properties":{"view":"table","title":"Stateless
              Logs","region":"region","query":"SOURCE '
            - Ref: testrestateloggroup6C0DD0DD
            - >-
              ' | fields @logStream, @timestamp, level, fields.message,
              target\\n          | sort @timestamp desc\\n          | limit
              500"}},{"type":"metric","width":12,"height":6,"x":0,"y":18,"properties":{"view":"timeSeries","title":"Stateful
              CPU","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"CPU","expression":"SELECT AVG(CpuUtilized)
              FROM SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily = 'RestateBYOCteststatefuldefinition9B15D9BA'
              GROUP BY
              TaskId"}]],"annotations":{"horizontal":[{"value":16384,"label":"Limit","yAxis":"left"}]},"yAxis":{"left":{"label":"vCPUs","showUnits":false}}}},{"type":"metric","width":12,"height":6,"x":12,"y":18,"properties":{"view":"timeSeries","title":"Stateful
              Memory","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Memory","expression":"SELECT
              AVG(MemoryUtilized) FROM SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily = 'RestateBYOCteststatefuldefinition9B15D9BA'
              GROUP BY
              TaskId"}]],"annotations":{"horizontal":[{"value":32768,"label":"Limit","yAxis":"left"}]},"yAxis":{"left":{"label":"MiB","showUnits":false}}}},{"type":"metric","width":12,"height":6,"x":0,"y":24,"properties":{"view":"timeSeries","title":"Stateful
              Network Tx","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Tx","expression":"SELECT
              AVG(NetworkTxBytes) FROM SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily = 'RestateBYOCteststatefuldefinition9B15D9BA'
              GROUP BY
              TaskId"}]],"yAxis":{"left":{"label":"Bytes/sec","showUnits":false}}}},{"type":"metric","width":12,"height":6,"x":12,"y":24,"properties":{"view":"timeSeries","title":"Stateful
              Network Rx","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Rx","expression":"SELECT
              AVG(NetworkRxBytes) FROM SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily = 'RestateBYOCteststatefuldefinition9B15D9BA'
              GROUP BY
              TaskId"}]],"yAxis":{"left":{"label":"Bytes/sec","showUnits":false}}}},{"type":"log","width":24,"height":6,"x":0,"y":30,"properties":{"view":"table","title":"Stateful
              Logs","region":"region","query":"SOURCE '
            - Ref: testrestateloggroup6C0DD0DD
            - >-
              ' | fields @logStream, @timestamp, level, fields.message,
              target\\n          | sort @timestamp desc\\n          | limit
              500"}},{"type":"metric","width":8,"height":6,"x":0,"y":36,"properties":{"view":"timeSeries","title":"Ephemeral
              Volume Usage (Total size 200GiB)","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Usage","expression":"SELECT
              MAX(EphemeralStorageUtilized) FROM
              SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily) WHERE TaskDefinitionFamily =
              'RestateBYOCteststatefuldefinition9B15D9BA'"}]],"annotations":{"horizontal":[{"value":200,"label":"Volume
              size","visible":false,"yAxis":"left"}]},"yAxis":{"left":{"label":"GiB","showUnits":false}},"liveData":false}},{"type":"metric","width":8,"height":6,"x":8,"y":36,"properties":{"view":"timeSeries","title":"Volume
              Write Throughput (Limited to 150 MiB/sec)","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Write","expression":"RATE(count) /
              1048576"}],[{"expression":"SELECT MAX(StorageWriteBytes) FROM
              SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily = 'RestateBYOCteststatefuldefinition9B15D9BA'
              GROUP BY
              TaskId","visible":false,"id":"count"}]],"annotations":{"horizontal":[{"value":150,"label":"Limit","visible":false,"yAxis":"left"}]},"yAxis":{"left":{"label":"MiB/sec","showUnits":false}}}},{"type":"metric","width":8,"height":6,"x":16,"y":36,"properties":{"view":"timeSeries","title":"Volume
              Read Throughput (Limited to 150 MiB/sec)","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Read","expression":"RATE(count) /
              1048576"}],[{"expression":"SELECT MAX(StorageReadBytes) FROM
              SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily = 'RestateBYOCteststatefuldefinition9B15D9BA'
              GROUP BY
              TaskId","visible":false,"id":"count"}]],"annotations":{"horizontal":[{"value":150,"label":"Limit","visible":false,"yAxis":"left"}]},"yAxis":{"left":{"label":"MiB/sec","showUnits":false}}}},{"type":"log","width":24,"height":6,"x":0,"y":42,"properties":{"view":"table","title":"Controller
              Logs","region":"region","query":"SOURCE '
            - Ref: testcontrollerloggroupB61E47AC
            - >-
              ' | fields @logStream, @timestamp, level, fields.message,
              target\\n          | sort @timestamp desc\\n          | limit
              500"}}]}
      DashboardName: RestateBYOC_test_metrics
  testcontrolpanel0D5F1B33:
    Type: 'AWS::CloudWatch::Dashboard'
    Properties:
      DashboardBody:
        'Fn::Join':
          - ''
          - - >-
              {"widgets":[{"type":"custom","width":24,"height":26,"x":0,"y":0,"properties":{"endpoint":"
            - 'Fn::GetAtt':
                - testcloudwatchcustomwidgetlambdaB0DB8C59
                - Arn
            - '","params":{"command":"controlPanel","input":{"region":"'
            - Ref: 'AWS::Region'
            - >-
              ","summary":{"clusterName":"RestateBYOC/test","restateVersion":"1.4","stackVersion":"0.4.1-dev","metricsDashboardName":"
            - Ref: testmetricsAAAB7FF4
            - '"},"resources":{"ecsClusterArn":"'
            - 'Fn::GetAtt':
                - testclusterDBD4D436
                - Arn
            - '","statelessServiceArn":"'
            - Ref: teststatelessserviceService5CDEA5F0
            - '","controllerServiceArn":"'
            - Ref: testcontrollerserviceService356186D6
            - '","restatectlLambdaArn":"'
            - 'Fn::GetAtt':
                - testrestatectllambda6F1900FA
                - Arn
            - >-
              "},"connectivityAndSecurity":{"connectivity":{"loadBalancerArns":{"ingress":["
            - Ref: testsharednlb6BC10CBB
            - '"],"admin":["'
            - Ref: testsharednlb6BC10CBB
            - '"]},"addresses":{"ingress":"http://'
            - 'Fn::GetAtt':
                - testsharednlb6BC10CBB
                - DNSName
            - ':8080","admin":"http://'
            - 'Fn::GetAtt':
                - testsharednlb6BC10CBB
                - DNSName
            - ':9070","webUI":"http://'
            - 'Fn::GetAtt':
                - testsharednlb6BC10CBB
                - DNSName
            - ':9070/ui"}},"networking":{"vpc":"'
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcA2121C384D1B3CDE'
            - '","availabilityZones":["dummy1a","dummy1b","dummy1c"],"subnets":["'
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet1Subnet934893E8236E2271'
            - '","'
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet2Subnet7031C2BA60DCB1EE'
            - '","'
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet3Subnet985AC459F9514491'
            - '"]},"security":{"securityGroups":["'
            - 'Fn::GetAtt':
                - testsecuritygroupB015C031
                - GroupId
            - '"]}},"storage":{"s3":{"bucket":"'
            - Ref: testbucket731B7DE2
            - >-
              "}}}},"title":"","updateOn":{"refresh":true,"resize":true,"timeRange":true}}}]}
      DashboardName: RestateBYOC_test_control-panel
  testroleB50A37BE:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
        Version: '2012-10-17'
  testroleDefaultPolicy884631E2:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 'logs:FilterLogEvents'
              - 'logs:GetLogEvents'
              - 'logs:GetLogGroupFields'
              - 'logs:DescribeLogGroups'
              - 'logs:DescribeLogStreams'
            Effect: Allow
            Resource:
              'Fn::GetAtt':
                - testrestateloggroup6C0DD0DD
                - Arn
          - Action:
              - 'logs:CreateLogStream'
              - 'logs:PutLogEvents'
            Effect: Allow
            Resource:
              'Fn::GetAtt':
                - testcontrollerloggroupB61E47AC
                - Arn
        Version: '2012-10-17'
      PolicyName: testroleDefaultPolicy884631E2
      Roles:
        - Ref: testroleB50A37BE
Outputs:
  testSecurityGroups50C338D1:
    Description: The security group IDs of the cluster
    Value:
      'Fn::GetAtt':
        - testsecuritygroupB015C031
        - GroupId
  testIngressNetworkListenerA459AD14:
    Description: The ARN of the network listener for the ingress port
    Value:
      Ref: testingresssharedlistenerF18D3E56
  testIngressNetworkTargetGroup73857B83:
    Description: The ARN of the network target group for the ingress port
    Value:
      Ref: testingresssharedtarget779E3570
  testAdminNetworkListener840296BA:
    Description: The ARN of the network listener for the admin port
    Value:
      Ref: testadminsharedlistener6D147D79
  testAdminNetworkTargetGroup1541C506:
    Description: The ARN of the network target group for the admin port
    Value:
      Ref: testadminsharedtarget0C095FA8
  testNodeNetworkListener743144A9:
    Description: The ARN of the network listener for the node port
    Value:
      Ref: testnodesharedlistener98A38BFD
  testNodeNetworkTargetGroup76D5EEBA:
    Description: The ARN of the network target group for the node port
    Value:
      Ref: testnodesharedtarget6337BC22
"
`;

exports[`BYOC Retirement watcher queue can be customized 1`] = `
"Resources:
  testsecuritygroupB015C031:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      GroupDescription: RestateBYOC/test/security-group
      SecurityGroupEgress:
        - CidrIp: 0.0.0.0/0
          Description: Allow all outbound traffic by default
          IpProtocol: '-1'
      Tags:
        - Key: Name
          Value: RestateBYOC/test/security-group
      VpcId:
        'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcA2121C384D1B3CDE'
  testsecuritygroupfromRestateBYOCtestsecuritygroupDC099EC280804D6652A7:
    Type: 'AWS::EC2::SecurityGroupIngress'
    Properties:
      Description: 'from RestateBYOCtestsecuritygroupDC099EC2:8080'
      FromPort: 8080
      GroupId:
        'Fn::GetAtt':
          - testsecuritygroupB015C031
          - GroupId
      IpProtocol: tcp
      SourceSecurityGroupId:
        'Fn::GetAtt':
          - testsecuritygroupB015C031
          - GroupId
      ToPort: 8080
  testsecuritygroupfromRestateBYOCtestsecuritygroupDC099EC2907024D2BE0B:
    Type: 'AWS::EC2::SecurityGroupIngress'
    Properties:
      Description: 'from RestateBYOCtestsecuritygroupDC099EC2:9070'
      FromPort: 9070
      GroupId:
        'Fn::GetAtt':
          - testsecuritygroupB015C031
          - GroupId
      IpProtocol: tcp
      SourceSecurityGroupId:
        'Fn::GetAtt':
          - testsecuritygroupB015C031
          - GroupId
      ToPort: 9070
  testsecuritygroupfromRestateBYOCtestsecuritygroupDC099EC25122D07222D4:
    Type: 'AWS::EC2::SecurityGroupIngress'
    Properties:
      Description: 'from RestateBYOCtestsecuritygroupDC099EC2:5122'
      FromPort: 5122
      GroupId:
        'Fn::GetAtt':
          - testsecuritygroupB015C031
          - GroupId
      IpProtocol: tcp
      SourceSecurityGroupId:
        'Fn::GetAtt':
          - testsecuritygroupB015C031
          - GroupId
      ToPort: 5122
  testbucket731B7DE2:
    Type: 'AWS::S3::Bucket'
    Properties:
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
    UpdateReplacePolicy: Retain
    DeletionPolicy: Retain
  testbucketPolicyB4FDDA54:
    Type: 'AWS::S3::BucketPolicy'
    Properties:
      Bucket:
        Ref: testbucket731B7DE2
      PolicyDocument:
        Statement:
          - Action: 's3:*'
            Condition:
              Bool:
                'aws:SecureTransport': 'false'
            Effect: Deny
            Principal:
              AWS: '*'
            Resource:
              - 'Fn::GetAtt':
                  - testbucket731B7DE2
                  - Arn
              - 'Fn::Join':
                  - ''
                  - - 'Fn::GetAtt':
                        - testbucket731B7DE2
                        - Arn
                    - /*
        Version: '2012-10-17'
  testclusterDBD4D436:
    Type: 'AWS::ECS::Cluster'
    Properties:
      ClusterSettings:
        - Name: containerInsights
          Value: enhanced
      Tags:
        - Key: Name
          Value: RestateBYOC/test/cluster
  testrestatetaskrole4CC243A3:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
        Version: '2012-10-17'
  testrestatetaskroleDefaultPolicy51A222FD:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 's3:GetObject'
              - 's3:PutObject'
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'Fn::GetAtt':
                      - testbucket731B7DE2
                      - Arn
                  - /*
            Sid: ReadWriteBucket
          - Action: 's3:ListBucket'
            Effect: Allow
            Resource:
              'Fn::GetAtt':
                - testbucket731B7DE2
                - Arn
            Sid: ListBucket
        Version: '2012-10-17'
      PolicyName: testrestatetaskroleDefaultPolicy51A222FD
      Roles:
        - Ref: testrestatetaskrole4CC243A3
  testrestateexecutionrole4CD7F161:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
        Version: '2012-10-17'
  testrestateexecutionroleDefaultPolicy04DC59EF:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 'logs:CreateLogStream'
              - 'logs:PutLogEvents'
            Effect: Allow
            Resource:
              'Fn::GetAtt':
                - testrestateloggroup6C0DD0DD
                - Arn
        Version: '2012-10-17'
      PolicyName: testrestateexecutionroleDefaultPolicy04DC59EF
      Roles:
        - Ref: testrestateexecutionrole4CD7F161
  testrestateloggroup6C0DD0DD:
    Type: 'AWS::Logs::LogGroup'
    Properties:
      RetentionInDays: 30
    UpdateReplacePolicy: Retain
    DeletionPolicy: Retain
  testcontrollerloggroupB61E47AC:
    Type: 'AWS::Logs::LogGroup'
    Properties:
      RetentionInDays: 30
    UpdateReplacePolicy: Retain
    DeletionPolicy: Retain
  testsharednlb6BC10CBB:
    Type: 'AWS::ElasticLoadBalancingV2::LoadBalancer'
    Properties:
      LoadBalancerAttributes:
        - Key: deletion_protection.enabled
          Value: 'false'
        - Key: load_balancing.cross_zone.enabled
          Value: 'false'
        - Key: dns_record.client_routing_policy
          Value: availability_zone_affinity
      Scheme: internal
      SecurityGroups:
        - 'Fn::GetAtt':
            - testsecuritygroupB015C031
            - GroupId
      Subnets:
        - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet1Subnet934893E8236E2271'
        - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet2Subnet7031C2BA60DCB1EE'
        - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet3Subnet985AC459F9514491'
      Tags:
        - Key: Name
          Value: RestateBYOC/test/shared-nlb
      Type: network
  testingresssharedlistenerF18D3E56:
    Type: 'AWS::ElasticLoadBalancingV2::Listener'
    Properties:
      DefaultActions:
        - TargetGroupArn:
            Ref: testingresssharedtarget779E3570
          Type: forward
      LoadBalancerArn:
        Ref: testsharednlb6BC10CBB
      Port: 8080
      Protocol: TCP
  testadminsharedlistener6D147D79:
    Type: 'AWS::ElasticLoadBalancingV2::Listener'
    Properties:
      DefaultActions:
        - TargetGroupArn:
            Ref: testadminsharedtarget0C095FA8
          Type: forward
      LoadBalancerArn:
        Ref: testsharednlb6BC10CBB
      Port: 9070
      Protocol: TCP
  testnodesharedlistener98A38BFD:
    Type: 'AWS::ElasticLoadBalancingV2::Listener'
    Properties:
      DefaultActions:
        - TargetGroupArn:
            Ref: testnodesharedtarget6337BC22
          Type: forward
      LoadBalancerArn:
        Ref: testsharednlb6BC10CBB
      Port: 5122
      Protocol: TCP
  teststatelessdefinition64DABAD1:
    Type: 'AWS::ECS::TaskDefinition'
    Properties:
      ContainerDefinitions:
        - Cpu: 16384
          EntryPoint:
            - bash
            - '-c'
            - >

              curl --no-progress-meter $ECS_CONTAINER_METADATA_URI_V4 -o
              container-metadata && \\

              curl --no-progress-meter $ECS_CONTAINER_METADATA_URI_V4/task -o
              task-metadata && \\

              export \\
                RESTATE_NODE_NAME=$(jq -r '.TaskARN' task-metadata) \\
                RESTATE_LOCATION="$AWS_REGION.$(jq -r '.AvailabilityZone' task-metadata)" \\
                RESTATE_ADVERTISED_ADDRESS="http://$(jq -r '.Networks[0].IPv4Addresses[0]' container-metadata):5122"
              exec restate-server
          Environment:
            - Name: RESTATE_LOG_FORMAT
              Value: json
            - Name: RESTATE_CLUSTER_NAME
              Value: RestateBYOC/test
            - Name: RESTATE_ROLES
              Value: '["admin","http-ingress"]'
            - Name: RESTATE_AUTO_PROVISION
              Value: 'true'
            - Name: RESTATE_SHUTDOWN_TIMEOUT
              Value: 100s
            - Name: RESTATE_DEFAULT_NUM_PARTITIONS
              Value: '128'
            - Name: RESTATE_DEFAULT_REPLICATION
              Value: '{zone: 2}'
            - Name: RESTATE_METADATA_CLIENT__TYPE
              Value: object-store
            - Name: RESTATE_METADATA_CLIENT__PATH
              Value:
                'Fn::Join':
                  - ''
                  - - 's3://'
                    - Ref: testbucket731B7DE2
                    - /metadata
            - Name: RESTATE_BIFROST__DEFAULT_PROVIDER
              Value: replicated
            - Name: >-
                RESTATE_INGRESS__EXPERIMENTAL_FEATURE_ENABLE_SEPARATE_INGRESS_ROLE
              Value: 'true'
            - Name: RESTATE_INGRESS__ADVERTISED_INGRESS_ENDPOINT
              Value:
                'Fn::Join':
                  - ''
                  - - 'http://'
                    - 'Fn::GetAtt':
                        - testsharednlb6BC10CBB
                        - DNSName
                    - ':8080'
            - Name: RESTATE_WORKER__SNAPSHOTS__DESTINATION
              Value:
                'Fn::Join':
                  - ''
                  - - 's3://'
                    - Ref: testbucket731B7DE2
                    - /snapshots
          Essential: true
          HealthCheck:
            Command:
              - CMD
              - curl
              - '--fail'
              - 'http://127.0.0.1:8080/restate/health'
            Interval: 30
            Retries: 3
            Timeout: 5
          Image: Any<Object>
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group:
                Ref: testrestateloggroup6C0DD0DD
              awslogs-stream-prefix: restate
              awslogs-region: region
              mode: non-blocking
          Memory: 32768
          Name: restate
          PortMappings:
            - ContainerPort: 8080
              Name: ingress
              Protocol: tcp
            - ContainerPort: 9070
              Name: admin
              Protocol: tcp
            - ContainerPort: 5122
              Name: node
              Protocol: tcp
          StopTimeout: 120
      Cpu: '16384'
      ExecutionRoleArn:
        'Fn::GetAtt':
          - testrestateexecutionrole4CD7F161
          - Arn
      Family: RestateBYOCteststatelessdefinitionA59C4856
      Memory: '32768'
      NetworkMode: awsvpc
      RequiresCompatibilities:
        - FARGATE
      RuntimePlatform:
        CpuArchitecture: ARM64
        OperatingSystemFamily: LINUX
      Tags:
        - Key: Name
          Value: RestateBYOC/test/stateless-definition
      TaskRoleArn:
        'Fn::GetAtt':
          - testrestatetaskrole4CC243A3
          - Arn
  teststatelessserviceService5CDEA5F0:
    Type: 'AWS::ECS::Service'
    Properties:
      AvailabilityZoneRebalancing: ENABLED
      Cluster:
        Ref: testclusterDBD4D436
      DeploymentConfiguration:
        Alarms:
          AlarmNames: []
          Enable: false
          Rollback: false
        MaximumPercent: 200
        MinimumHealthyPercent: 100
      DeploymentController:
        Type: ECS
      DesiredCount: 3
      EnableECSManagedTags: false
      EnableExecuteCommand: false
      HealthCheckGracePeriodSeconds: 60
      LaunchType: FARGATE
      LoadBalancers:
        - ContainerName: restate
          ContainerPort: 8080
          TargetGroupArn:
            Ref: testingresssharedtarget779E3570
        - ContainerName: restate
          ContainerPort: 9070
          TargetGroupArn:
            Ref: testadminsharedtarget0C095FA8
        - ContainerName: restate
          ContainerPort: 5122
          TargetGroupArn:
            Ref: testnodesharedtarget6337BC22
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: DISABLED
          SecurityGroups:
            - 'Fn::GetAtt':
                - testsecuritygroupB015C031
                - GroupId
          Subnets:
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet1Subnet934893E8236E2271'
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet2Subnet7031C2BA60DCB1EE'
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet3Subnet985AC459F9514491'
      PropagateTags: SERVICE
      Tags:
        - Key: Name
          Value: RestateBYOC/test/stateless-service
      TaskDefinition:
        Ref: teststatelessdefinition64DABAD1
    DependsOn:
      - testadminsharedlistener6D147D79
      - testingresssharedlistenerF18D3E56
      - testnodesharedlistener98A38BFD
      - testrestatetaskroleDefaultPolicy51A222FD
      - testrestatetaskrole4CC243A3
  teststatefuldefinitionB92BAA14:
    Type: 'AWS::ECS::TaskDefinition'
    Properties:
      ContainerDefinitions:
        - Cpu: 16384
          EntryPoint:
            - bash
            - '-c'
            - >

              curl --no-progress-meter $ECS_CONTAINER_METADATA_URI_V4 -o
              container-metadata && \\

              curl --no-progress-meter $ECS_CONTAINER_METADATA_URI_V4/task -o
              task-metadata && \\

              export \\
                RESTATE_NODE_NAME=$(jq -r '.TaskARN' task-metadata) \\
                RESTATE_LOCATION="$AWS_REGION.$(jq -r '.AvailabilityZone' task-metadata)" \\
                RESTATE_ADVERTISED_ADDRESS="http://$(jq -r '.Networks[0].IPv4Addresses[0]' container-metadata):5122" \\
                RESTATE_ROCKSDB_TOTAL_MEMORY_SIZE="$(($(jq -r '.Limits.Memory' container-metadata) * 3 / 4))MiB" \\
                RESTATE_WORKER__STORAGE__NUM_PARTITIONS_TO_SHARE_MEMORY_BUDGET=$(("$RESTATE_WORKER__STORAGE__NUM_PARTITIONS_TO_SHARE_MEMORY_BUDGET"))
              exec restate-server
          Environment:
            - Name: RESTATE_LOG_FORMAT
              Value: json
            - Name: RESTATE_CLUSTER_NAME
              Value: RestateBYOC/test
            - Name: RESTATE_ROLES
              Value: '["log-server", "worker"]'
            - Name: RESTATE_AUTO_PROVISION
              Value: 'false'
            - Name: RESTATE_SHUTDOWN_TIMEOUT
              Value: 100s
            - Name: RESTATE_METADATA_CLIENT__TYPE
              Value: object-store
            - Name: RESTATE_METADATA_CLIENT__PATH
              Value:
                'Fn::Join':
                  - ''
                  - - 's3://'
                    - Ref: testbucket731B7DE2
                    - /metadata
            - Name: RESTATE_WORKER__SNAPSHOTS__DESTINATION
              Value:
                'Fn::Join':
                  - ''
                  - - 's3://'
                    - Ref: testbucket731B7DE2
                    - /snapshots
            - Name: RESTATE_WORKER__SNAPSHOTS__SNAPSHOT_INTERVAL_NUM_RECORDS
              Value: '1000000'
            - Name: RESTATE_WORKER__STORAGE__ROCKSDB_DISABLE_DIRECT_IO_FOR_READS
              Value: 'true'
            - Name: RESTATE_WORKER__STORAGE__ROCKSDB_DISABLE_WAL_FSYNC
              Value: 'true'
            - Name: RESTATE_WORKER__STORAGE__NUM_PARTITIONS_TO_SHARE_MEMORY_BUDGET
              Value: (128 * 2) / (3 * 1)
            - Name: RESTATE_LOG_SERVER__ROCKSDB_DISABLE_WAL_FSYNC
              Value: 'true'
            - Name: RESTATE_LOG_SERVER__ROCKSDB_DISABLE_DIRECT_IO_FOR_READS
              Value: 'true'
            - Name: >-
                RESTATE_INGRESS__EXPERIMENTAL_FEATURE_ENABLE_SEPARATE_INGRESS_ROLE
              Value: 'true'
          Essential: true
          HealthCheck:
            Command:
              - CMD
              - curl
              - '--fail'
              - 'http://127.0.0.1:5122/health'
            Interval: 30
            Retries: 3
            Timeout: 5
          Image: Any<Object>
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group:
                Ref: testrestateloggroup6C0DD0DD
              awslogs-stream-prefix: restate
              awslogs-region: region
              mode: non-blocking
          Memory: 32768
          MountPoints:
            - ContainerPath: /restate-data
              ReadOnly: false
              SourceVolume: restate-data
          Name: restate
          PortMappings:
            - ContainerPort: 5122
              Name: node
              Protocol: tcp
          RestartPolicy:
            Enabled: true
            RestartAttemptPeriod: 60
          StopTimeout: 120
      Cpu: '16384'
      EphemeralStorage:
        SizeInGiB: 200
      ExecutionRoleArn:
        'Fn::GetAtt':
          - testrestateexecutionrole4CD7F161
          - Arn
      Family: RestateBYOCteststatefuldefinition9B15D9BA
      Memory: '32768'
      NetworkMode: awsvpc
      RequiresCompatibilities:
        - FARGATE
      RuntimePlatform:
        CpuArchitecture: ARM64
        OperatingSystemFamily: LINUX
      Tags:
        - Key: Name
          Value: RestateBYOC/test/stateful-definition
      TaskRoleArn:
        'Fn::GetAtt':
          - testrestatetaskrole4CC243A3
          - Arn
      Volumes:
        - ConfiguredAtLaunch: false
          Name: restate-data
  testingresssharedtarget779E3570:
    Type: 'AWS::ElasticLoadBalancingV2::TargetGroup'
    Properties:
      HealthCheckEnabled: true
      HealthCheckIntervalSeconds: 5
      HealthCheckPath: /restate/health
      HealthCheckProtocol: HTTP
      HealthCheckTimeoutSeconds: 2
      Port: 8080
      Protocol: TCP
      Tags:
        - Key: Name
          Value: RestateBYOC/test/ingress-shared-target
      TargetType: ip
      VpcId:
        'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcA2121C384D1B3CDE'
  testadminsharedtarget0C095FA8:
    Type: 'AWS::ElasticLoadBalancingV2::TargetGroup'
    Properties:
      HealthCheckEnabled: true
      HealthCheckIntervalSeconds: 5
      HealthCheckPath: /health
      HealthCheckPort: '9070'
      HealthCheckProtocol: HTTP
      HealthCheckTimeoutSeconds: 2
      Port: 9070
      Protocol: TCP
      Tags:
        - Key: Name
          Value: RestateBYOC/test/admin-shared-target
      TargetType: ip
      VpcId:
        'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcA2121C384D1B3CDE'
  testnodesharedtarget6337BC22:
    Type: 'AWS::ElasticLoadBalancingV2::TargetGroup'
    Properties:
      HealthCheckEnabled: true
      HealthCheckIntervalSeconds: 5
      HealthCheckPath: /health
      HealthCheckPort: '5122'
      HealthCheckProtocol: HTTP
      HealthCheckTimeoutSeconds: 2
      Port: 5122
      Protocol: TCP
      Tags:
        - Key: Name
          Value: RestateBYOC/test/node-shared-target
      TargetType: ip
      VpcId:
        'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcA2121C384D1B3CDE'
  testcontrollertaskrole42417C6E:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
        Version: '2012-10-17'
  testcontrollertaskroleDefaultPolicy030D6236:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action: 'ecs:ListTasks'
            Condition:
              ArnEquals:
                'ecs:cluster':
                  'Fn::GetAtt':
                    - testclusterDBD4D436
                    - Arn
            Effect: Allow
            Resource: '*'
            Sid: ECSListActions
          - Action:
              - 'ecs:TagResource'
              - 'ecs:DescribeTasks'
              - 'ecs:StopTask'
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'Fn::Join':
                      - /
                      - - 'Fn::Join':
                            - ':'
                            - - 'Fn::Select':
                                  - 0
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - testclusterDBD4D436
                                                  - Arn
                              - 'Fn::Select':
                                  - 1
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - testclusterDBD4D436
                                                  - Arn
                              - 'Fn::Select':
                                  - 2
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - testclusterDBD4D436
                                                  - Arn
                              - 'Fn::Select':
                                  - 3
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - testclusterDBD4D436
                                                  - Arn
                              - 'Fn::Select':
                                  - 4
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - testclusterDBD4D436
                                                  - Arn
                              - task
                        - 'Fn::Select':
                            - 1
                            - 'Fn::Split':
                                - /
                                - 'Fn::GetAtt':
                                    - testclusterDBD4D436
                                    - Arn
                        - ''
                  - '*'
            Sid: TaskActions
          - Action: 'ecs:RunTask'
            Condition:
              ArnEquals:
                'ecs:cluster':
                  'Fn::GetAtt':
                    - testclusterDBD4D436
                    - Arn
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'Fn::Join':
                      - ':'
                      - - 'Fn::Select':
                            - 0
                            - 'Fn::Split':
                                - ':'
                                - Ref: teststatefuldefinitionB92BAA14
                        - 'Fn::Select':
                            - 1
                            - 'Fn::Split':
                                - ':'
                                - Ref: teststatefuldefinitionB92BAA14
                        - 'Fn::Select':
                            - 2
                            - 'Fn::Split':
                                - ':'
                                - Ref: teststatefuldefinitionB92BAA14
                        - 'Fn::Select':
                            - 3
                            - 'Fn::Split':
                                - ':'
                                - Ref: teststatefuldefinitionB92BAA14
                        - 'Fn::Select':
                            - 4
                            - 'Fn::Split':
                                - ':'
                                - Ref: teststatefuldefinitionB92BAA14
                        - 'Fn::Select':
                            - 5
                            - 'Fn::Split':
                                - ':'
                                - Ref: teststatefuldefinitionB92BAA14
                  - ':*'
            Sid: RunTask
          - Action: 'iam:PassRole'
            Condition:
              StringEquals:
                'iam:PassedToService': ecs-tasks.amazonaws.com
            Effect: Allow
            Resource:
              - 'Fn::GetAtt':
                  - testrestatetaskrole4CC243A3
                  - Arn
              - 'Fn::GetAtt':
                  - testrestateexecutionrole4CD7F161
                  - Arn
            Sid: RunTaskPassRole
          - Action:
              - 'ec2:DescribeVolumes'
              - 'ec2:DescribeSnapshots'
            Effect: Allow
            Resource: '*'
            Sid: EC2ListActions
          - Action: 'ec2:CreateSnapshot'
            Condition:
              ArnEquals:
                'aws:RequestTag/restate:ecsClusterArn':
                  'Fn::GetAtt':
                    - testclusterDBD4D436
                    - Arn
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'arn:'
                  - Ref: 'AWS::Partition'
                  - ':ec2:'
                  - Ref: 'AWS::Region'
                  - '::snapshot/*'
            Sid: CreateSnapshot
          - Action: 'ec2:CreateSnapshot'
            Condition:
              ArnEquals:
                'aws:ResourceTag/restate:ecsClusterArn':
                  'Fn::GetAtt':
                    - testclusterDBD4D436
                    - Arn
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'arn:'
                  - Ref: 'AWS::Partition'
                  - ':ec2:'
                  - Ref: 'AWS::Region'
                  - ':'
                  - Ref: 'AWS::AccountId'
                  - ':volume/*'
            Sid: SnapshotVolume
          - Action: 'ec2:CreateTags'
            Condition:
              StringEquals:
                'ec2:CreateAction': CreateSnapshot
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'arn:'
                  - Ref: 'AWS::Partition'
                  - ':ec2:'
                  - Ref: 'AWS::Region'
                  - '::snapshot/*'
            Sid: TagSnapshots
          - Action:
              - 'ec2:DeleteVolume'
              - 'ec2:DeleteSnapshot'
            Condition:
              ArnEquals:
                'aws:ResourceTag/restate:ecsClusterArn':
                  'Fn::GetAtt':
                    - testclusterDBD4D436
                    - Arn
            Effect: Allow
            Resource:
              - 'Fn::Join':
                  - ''
                  - - 'arn:'
                    - Ref: 'AWS::Partition'
                    - ':ec2:'
                    - Ref: 'AWS::Region'
                    - ':'
                    - Ref: 'AWS::AccountId'
                    - ':volume/*'
              - 'Fn::Join':
                  - ''
                  - - 'arn:'
                    - Ref: 'AWS::Partition'
                    - ':ec2:'
                    - Ref: 'AWS::Region'
                    - '::snapshot/*'
            Sid: DeleteVolumeAndSnapshot
          - Action:
              - 's3:GetObject'
              - 's3:PutObject'
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'Fn::GetAtt':
                      - testbucket731B7DE2
                      - Arn
                  - /*
            Sid: ReadWriteBucket
          - Action: 's3:ListBucket'
            Effect: Allow
            Resource:
              'Fn::GetAtt':
                - testbucket731B7DE2
                - Arn
            Sid: ListBucket
        Version: '2012-10-17'
      PolicyName: testcontrollertaskroleDefaultPolicy030D6236
      Roles:
        - Ref: testcontrollertaskrole42417C6E
  testcontrollerexecutionrole3BE0C8C4:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
        Version: '2012-10-17'
  testcontrollerexecutionroleDefaultPolicy443CB52A:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 'logs:CreateLogStream'
              - 'logs:PutLogEvents'
            Effect: Allow
            Resource:
              'Fn::GetAtt':
                - testcontrollerloggroupB61E47AC
                - Arn
        Version: '2012-10-17'
      PolicyName: testcontrollerexecutionroleDefaultPolicy443CB52A
      Roles:
        - Ref: testcontrollerexecutionrole3BE0C8C4
  testcontrollerdefinition0C4BC223:
    Type: 'AWS::ECS::TaskDefinition'
    Properties:
      ContainerDefinitions:
        - Cpu: 1024
          Environment:
            - Name: RUST_LOG
              Value: 'info,restate_fargate_controller=debug'
            - Name: CONTROLLER_LOG_FORMAT
              Value: json
            - Name: CONTROLLER_METADATA_PATH
              Value:
                'Fn::Join':
                  - ''
                  - - 's3://'
                    - Ref: testbucket731B7DE2
                    - /metadata
            - Name: CONTROLLER_RECONCILE_INTERVAL
              Value: 10s
            - Name: CONTROLLER_CLUSTER__CLUSTER_ARN
              Value:
                'Fn::GetAtt':
                  - testclusterDBD4D436
                  - Arn
            - Name: CONTROLLER_LICENSE_KEY
              Value: foo
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __REGION
              Value:
                Ref: 'AWS::Region'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __CLUSTER_ARN
              Value:
                'Fn::GetAtt':
                  - testclusterDBD4D436
                  - Arn
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __TASK_PREFIX
              Value:
                'Fn::Join':
                  - /
                  - - 'Fn::Join':
                        - ':'
                        - - 'Fn::Select':
                              - 0
                              - 'Fn::Split':
                                  - ':'
                                  - 'Fn::Select':
                                      - 0
                                      - 'Fn::Split':
                                          - /
                                          - 'Fn::GetAtt':
                                              - testclusterDBD4D436
                                              - Arn
                          - 'Fn::Select':
                              - 1
                              - 'Fn::Split':
                                  - ':'
                                  - 'Fn::Select':
                                      - 0
                                      - 'Fn::Split':
                                          - /
                                          - 'Fn::GetAtt':
                                              - testclusterDBD4D436
                                              - Arn
                          - 'Fn::Select':
                              - 2
                              - 'Fn::Split':
                                  - ':'
                                  - 'Fn::Select':
                                      - 0
                                      - 'Fn::Split':
                                          - /
                                          - 'Fn::GetAtt':
                                              - testclusterDBD4D436
                                              - Arn
                          - 'Fn::Select':
                              - 3
                              - 'Fn::Split':
                                  - ':'
                                  - 'Fn::Select':
                                      - 0
                                      - 'Fn::Split':
                                          - /
                                          - 'Fn::GetAtt':
                                              - testclusterDBD4D436
                                              - Arn
                          - 'Fn::Select':
                              - 4
                              - 'Fn::Split':
                                  - ':'
                                  - 'Fn::Select':
                                      - 0
                                      - 'Fn::Split':
                                          - /
                                          - 'Fn::GetAtt':
                                              - testclusterDBD4D436
                                              - Arn
                          - task
                    - 'Fn::Select':
                        - 1
                        - 'Fn::Split':
                            - /
                            - 'Fn::GetAtt':
                                - testclusterDBD4D436
                                - Arn
                    - ''
            - Name: CONTROLLER_EBS_SNAPSHOT_RETENTION_PERIOD
              Value: 24h
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1a__ENABLE_EXECUTE_COMMAND
              Value: 'false'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1a__SECURITY_GROUPS
              Value:
                'Fn::Join':
                  - ''
                  - - '["'
                    - 'Fn::GetAtt':
                        - testsecuritygroupB015C031
                        - GroupId
                    - '"]'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1a__SUBNETS
              Value:
                'Fn::Join':
                  - ''
                  - - '["'
                    - 'Fn::ImportValue': >-
                        VPCStack:ExportsOutputRefvpcPrivateSubnet1Subnet934893E8236E2271
                    - '"]'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1a__TASK_DEFINITION_ARN
              Value:
                Ref: teststatefuldefinitionB92BAA14
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1a__COUNT
              Value: '1'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1b__ENABLE_EXECUTE_COMMAND
              Value: 'false'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1b__SECURITY_GROUPS
              Value:
                'Fn::Join':
                  - ''
                  - - '["'
                    - 'Fn::GetAtt':
                        - testsecuritygroupB015C031
                        - GroupId
                    - '"]'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1b__SUBNETS
              Value:
                'Fn::Join':
                  - ''
                  - - '["'
                    - 'Fn::ImportValue': >-
                        VPCStack:ExportsOutputRefvpcPrivateSubnet2Subnet7031C2BA60DCB1EE
                    - '"]'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1b__TASK_DEFINITION_ARN
              Value:
                Ref: teststatefuldefinitionB92BAA14
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1b__COUNT
              Value: '1'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1c__ENABLE_EXECUTE_COMMAND
              Value: 'false'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1c__SECURITY_GROUPS
              Value:
                'Fn::Join':
                  - ''
                  - - '["'
                    - 'Fn::GetAtt':
                        - testsecuritygroupB015C031
                        - GroupId
                    - '"]'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1c__SUBNETS
              Value:
                'Fn::Join':
                  - ''
                  - - '["'
                    - 'Fn::ImportValue': >-
                        VPCStack:ExportsOutputRefvpcPrivateSubnet3Subnet985AC459F9514491
                    - '"]'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1c__TASK_DEFINITION_ARN
              Value:
                Ref: teststatefuldefinitionB92BAA14
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1c__COUNT
              Value: '1'
          Essential: true
          HealthCheck:
            Command:
              - CMD
              - curl
              - '--fail'
              - 'http://127.0.0.1:8080/health'
            Interval: 30
            Retries: 10
            StartPeriod: 300
            Timeout: 5
          Image: Any<Object>
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group:
                Ref: testcontrollerloggroupB61E47AC
              awslogs-stream-prefix: controller
              awslogs-region: region
              mode: non-blocking
          Memory: 2048
          Name: controller
          StopTimeout: 120
      Cpu: '1024'
      ExecutionRoleArn:
        'Fn::GetAtt':
          - testcontrollerexecutionrole3BE0C8C4
          - Arn
      Family: RestateBYOCtestcontrollerdefinitionA329F74F
      Memory: '2048'
      NetworkMode: awsvpc
      RequiresCompatibilities:
        - FARGATE
      RuntimePlatform:
        CpuArchitecture: ARM64
        OperatingSystemFamily: LINUX
      Tags:
        - Key: Name
          Value: RestateBYOC/test/controller-definition
      TaskRoleArn:
        'Fn::GetAtt':
          - testcontrollertaskrole42417C6E
          - Arn
  testcontrollerserviceService356186D6:
    Type: 'AWS::ECS::Service'
    Properties:
      Cluster:
        Ref: testclusterDBD4D436
      DeploymentConfiguration:
        Alarms:
          AlarmNames: []
          Enable: false
          Rollback: false
        MaximumPercent: 100
        MinimumHealthyPercent: 0
      DeploymentController:
        Type: ECS
      DesiredCount: 1
      EnableECSManagedTags: false
      EnableExecuteCommand: false
      LaunchType: FARGATE
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: DISABLED
          SecurityGroups:
            - 'Fn::GetAtt':
                - testsecuritygroupB015C031
                - GroupId
          Subnets:
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet1Subnet934893E8236E2271'
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet2Subnet7031C2BA60DCB1EE'
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet3Subnet985AC459F9514491'
      Tags:
        - Key: Name
          Value: RestateBYOC/test/controller-service
      TaskDefinition:
        Ref: testcontrollerdefinition0C4BC223
    DependsOn:
      - testcontrollertaskroleDefaultPolicy030D6236
      - testcontrollertaskrole42417C6E
  testrestatectlloggroupC2AAB6C7:
    Type: 'AWS::Logs::LogGroup'
    Properties:
      RetentionInDays: 14
    UpdateReplacePolicy: Retain
    DeletionPolicy: Retain
  testrestatectllambdaexecutionrole9C923F83:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
        Version: '2012-10-17'
  testrestatectllambdaexecutionroleDefaultPolicy93BA3725:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 'logs:CreateLogStream'
              - 'logs:PutLogEvents'
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'arn:'
                  - Ref: 'AWS::Partition'
                  - ':logs:'
                  - Ref: 'AWS::Region'
                  - ':'
                  - Ref: 'AWS::AccountId'
                  - ':log-group:'
                  - Ref: testrestatectlloggroupC2AAB6C7
                  - ':log-stream:*'
            Sid: AWSLambdaLogStreamPermissions
          - Action:
              - 'ec2:CreateNetworkInterface'
              - 'ec2:DescribeNetworkInterfaces'
              - 'ec2:DescribeSubnets'
              - 'ec2:DeleteNetworkInterface'
            Effect: Allow
            Resource: '*'
            Sid: AWSLambdaVPCWildcardPermissions
          - Action:
              - 'ec2:AssignPrivateIpAddresses'
              - 'ec2:UnassignPrivateIpAddresses'
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'arn:'
                  - Ref: 'AWS::Partition'
                  - ':ec2:'
                  - Ref: 'AWS::Region'
                  - ':'
                  - Ref: 'AWS::AccountId'
                  - ':network-interface/*'
            Sid: AWSLambdaVPCNetworkInterfacePermissions
        Version: '2012-10-17'
      PolicyName: testrestatectllambdaexecutionroleDefaultPolicy93BA3725
      Roles:
        - Ref: testrestatectllambdaexecutionrole9C923F83
  testrestatectllambda6F1900FA:
    Type: 'AWS::Lambda::Function'
    Properties:
      Architectures:
        - arm64
      Code: Any<Object>
      Environment:
        Variables:
          RESTATECTL_ADDRESS:
            'Fn::Join':
              - ''
              - - 'http://'
                - 'Fn::GetAtt':
                    - testsharednlb6BC10CBB
                    - DNSName
                - ':5122'
      Handler: restatectl
      LoggingConfig:
        LogGroup:
          Ref: testrestatectlloggroupC2AAB6C7
      Role:
        'Fn::GetAtt':
          - testrestatectllambdaexecutionrole9C923F83
          - Arn
      Runtime: provided.al2023
      Tags:
        - Key: Name
          Value: RestateBYOC/test/restatectl-lambda
      Timeout: 10
      VpcConfig:
        SecurityGroupIds:
          - 'Fn::GetAtt':
              - testsecuritygroupB015C031
              - GroupId
        SubnetIds:
          - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet1Subnet934893E8236E2271'
          - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet2Subnet7031C2BA60DCB1EE'
          - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet3Subnet985AC459F9514491'
    DependsOn:
      - testrestatectllambdaexecutionroleDefaultPolicy93BA3725
      - testrestatectllambdaexecutionrole9C923F83
  testretirementwatcherloggroupBCD89B2E:
    Type: 'AWS::Logs::LogGroup'
    Properties:
      RetentionInDays: 14
    UpdateReplacePolicy: Retain
    DeletionPolicy: Retain
  testretirementwatcherlambdaexecutionrole0BCEB9D0:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
        Version: '2012-10-17'
  testretirementwatcherlambdaexecutionroleDefaultPolicy6E9FBD0D:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 'logs:CreateLogStream'
              - 'logs:PutLogEvents'
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'arn:'
                  - Ref: 'AWS::Partition'
                  - ':logs:'
                  - Ref: 'AWS::Region'
                  - ':'
                  - Ref: 'AWS::AccountId'
                  - ':log-group:'
                  - Ref: testretirementwatcherloggroupBCD89B2E
                  - ':log-stream:*'
            Sid: AWSLambdaLogStreamPermissions
          - Action: 'ecs:TagResource'
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'Fn::Join':
                      - /
                      - - 'Fn::Join':
                            - ':'
                            - - 'Fn::Select':
                                  - 0
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - testclusterDBD4D436
                                                  - Arn
                              - 'Fn::Select':
                                  - 1
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - testclusterDBD4D436
                                                  - Arn
                              - 'Fn::Select':
                                  - 2
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - testclusterDBD4D436
                                                  - Arn
                              - 'Fn::Select':
                                  - 3
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - testclusterDBD4D436
                                                  - Arn
                              - 'Fn::Select':
                                  - 4
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - testclusterDBD4D436
                                                  - Arn
                              - task
                        - 'Fn::Select':
                            - 1
                            - 'Fn::Split':
                                - /
                                - 'Fn::GetAtt':
                                    - testclusterDBD4D436
                                    - Arn
                        - ''
                  - '*'
            Sid: TagTasks
          - Action:
              - 'sqs:ReceiveMessage'
              - 'sqs:ChangeMessageVisibility'
              - 'sqs:GetQueueUrl'
              - 'sqs:DeleteMessage'
              - 'sqs:GetQueueAttributes'
            Effect: Allow
            Resource:
              'Fn::GetAtt':
                - testretirementwatcherqueue71FDBFE9
                - Arn
        Version: '2012-10-17'
      PolicyName: testretirementwatcherlambdaexecutionroleDefaultPolicy6E9FBD0D
      Roles:
        - Ref: testretirementwatcherlambdaexecutionrole0BCEB9D0
  testretirementwatcherlambdaF666308D:
    Type: 'AWS::Lambda::Function'
    Properties:
      Architectures:
        - arm64
      Code: Any<Object>
      Handler: index.handler
      LoggingConfig:
        LogGroup:
          Ref: testretirementwatcherloggroupBCD89B2E
      Role:
        'Fn::GetAtt':
          - testretirementwatcherlambdaexecutionrole0BCEB9D0
          - Arn
      Runtime: nodejs22.x
      Tags:
        - Key: Name
          Value: RestateBYOC/test/retirement-watcher-lambda
      Timeout: 60
    DependsOn:
      - testretirementwatcherlambdaexecutionroleDefaultPolicy6E9FBD0D
      - testretirementwatcherlambdaexecutionrole0BCEB9D0
  testretirementwatcherlambdaSqsEventSourceRestateBYOCtestretirementwatcherqueue805C85E9DF913057:
    Type: 'AWS::Lambda::EventSourceMapping'
    Properties:
      BatchSize: 1
      EventSourceArn:
        'Fn::GetAtt':
          - testretirementwatcherqueue71FDBFE9
          - Arn
      FunctionName:
        Ref: testretirementwatcherlambdaF666308D
      Tags:
        - Key: Name
          Value: RestateBYOC/test/retirement-watcher-lambda
  testretirementwatcherqueue71FDBFE9:
    Type: 'AWS::SQS::Queue'
    Properties:
      Tags:
        - Key: Name
          Value: RestateBYOC/test/retirement-watcher-queue
      VisibilityTimeout: 60
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  testretirementwatcherqueuePolicy7D50DFC3:
    Type: 'AWS::SQS::QueuePolicy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 'sqs:SendMessage'
              - 'sqs:GetQueueAttributes'
              - 'sqs:GetQueueUrl'
            Condition:
              ArnEquals:
                'aws:SourceArn':
                  'Fn::GetAtt':
                    - testretirementwatcherruleBA70D9F7
                    - Arn
            Effect: Allow
            Principal:
              Service: events.amazonaws.com
            Resource:
              'Fn::GetAtt':
                - testretirementwatcherqueue71FDBFE9
                - Arn
          - Action: 'sqs:SendMessage'
            Condition:
              StringEquals:
                'aws:SourceAccount':
                  Ref: 'AWS::AccountId'
            Effect: Allow
            Principal:
              Service: events.amazonaws.com
            Resource:
              'Fn::GetAtt':
                - testretirementwatcherqueue71FDBFE9
                - Arn
        Version: '2012-10-17'
      Queues:
        - Ref: testretirementwatcherqueue71FDBFE9
  testretirementwatcherruleBA70D9F7:
    Type: 'AWS::Events::Rule'
    Properties:
      EventPattern:
        detail:
          eventTypeCode:
            - equals-ignore-case: AWS_ECS_TASK_PATCHING_RETIREMENT
          service:
            - equals-ignore-case: ecs
        resources:
          - prefix:
              'Fn::Join':
                - /
                - - 'Fn::Join':
                      - ':'
                      - - 'Fn::Select':
                            - 0
                            - 'Fn::Split':
                                - ':'
                                - 'Fn::Select':
                                    - 0
                                    - 'Fn::Split':
                                        - /
                                        - 'Fn::GetAtt':
                                            - testclusterDBD4D436
                                            - Arn
                        - 'Fn::Select':
                            - 1
                            - 'Fn::Split':
                                - ':'
                                - 'Fn::Select':
                                    - 0
                                    - 'Fn::Split':
                                        - /
                                        - 'Fn::GetAtt':
                                            - testclusterDBD4D436
                                            - Arn
                        - 'Fn::Select':
                            - 2
                            - 'Fn::Split':
                                - ':'
                                - 'Fn::Select':
                                    - 0
                                    - 'Fn::Split':
                                        - /
                                        - 'Fn::GetAtt':
                                            - testclusterDBD4D436
                                            - Arn
                        - 'Fn::Select':
                            - 3
                            - 'Fn::Split':
                                - ':'
                                - 'Fn::Select':
                                    - 0
                                    - 'Fn::Split':
                                        - /
                                        - 'Fn::GetAtt':
                                            - testclusterDBD4D436
                                            - Arn
                        - 'Fn::Select':
                            - 4
                            - 'Fn::Split':
                                - ':'
                                - 'Fn::Select':
                                    - 0
                                    - 'Fn::Split':
                                        - /
                                        - 'Fn::GetAtt':
                                            - testclusterDBD4D436
                                            - Arn
                        - task
                  - 'Fn::Select':
                      - 1
                      - 'Fn::Split':
                          - /
                          - 'Fn::GetAtt':
                              - testclusterDBD4D436
                              - Arn
                  - ''
        detail-type:
          - equals-ignore-case: AWS Health Event
      State: ENABLED
      Targets:
        - Arn:
            'Fn::GetAtt':
              - testretirementwatcherqueue71FDBFE9
              - Arn
          Id: Target0
  testcloudwatchcustomwidgetloggroupEBFA438D:
    Type: 'AWS::Logs::LogGroup'
    Properties:
      RetentionInDays: 14
    UpdateReplacePolicy: Retain
    DeletionPolicy: Retain
  testcloudwatchcustomwidgetexecutionrole72F32199:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
        Version: '2012-10-17'
  testcloudwatchcustomwidgetexecutionroleDefaultPolicy4D8EC73B:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 'logs:CreateLogStream'
              - 'logs:PutLogEvents'
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'arn:'
                  - Ref: 'AWS::Partition'
                  - ':logs:'
                  - Ref: 'AWS::Region'
                  - ':'
                  - Ref: 'AWS::AccountId'
                  - ':log-group:'
                  - Ref: testcloudwatchcustomwidgetloggroupEBFA438D
                  - ':log-stream:*'
            Sid: AWSLambdaLogStreamPermissions
          - Action: 'lambda:InvokeFunction'
            Effect: Allow
            Resource:
              'Fn::GetAtt':
                - testrestatectllambda6F1900FA
                - Arn
            Sid: InvokeRestatectl
          - Action: 'ecs:DescribeTaskDefinition'
            Effect: Allow
            Resource: '*'
            Sid: ECSReadActions
          - Action: 'ecs:ListTasks'
            Condition:
              StringEquals:
                'ecs:cluster':
                  'Fn::GetAtt':
                    - testclusterDBD4D436
                    - Arn
            Effect: Allow
            Resource: '*'
            Sid: ECSListTasks
          - Action: 'ecs:DescribeTasks'
            Condition:
              StringEquals:
                'ecs:cluster':
                  'Fn::GetAtt':
                    - testclusterDBD4D436
                    - Arn
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'arn:'
                  - Ref: 'AWS::Partition'
                  - ':ecs:'
                  - Ref: 'AWS::Region'
                  - ':'
                  - Ref: 'AWS::AccountId'
                  - ':task/'
                  - Ref: testclusterDBD4D436
                  - /*
            Sid: ECSDescribeTasks
          - Action: 'ecs:DescribeServices'
            Condition:
              StringEquals:
                'ecs:cluster':
                  'Fn::GetAtt':
                    - testclusterDBD4D436
                    - Arn
            Effect: Allow
            Resource:
              - Ref: testcontrollerserviceService356186D6
              - Ref: teststatelessserviceService5CDEA5F0
            Sid: ECSDescribeServices
          - Action: 'cloudwatch:GetMetricData'
            Effect: Allow
            Resource: '*'
            Sid: CloudWatchReadActions
        Version: '2012-10-17'
      PolicyName: testcloudwatchcustomwidgetexecutionroleDefaultPolicy4D8EC73B
      Roles:
        - Ref: testcloudwatchcustomwidgetexecutionrole72F32199
  testcloudwatchcustomwidgetlambdaB0DB8C59:
    Type: 'AWS::Lambda::Function'
    Properties:
      Architectures:
        - arm64
      Code: Any<Object>
      Environment:
        Variables:
          ENABLE_EBS_VOLUMES: 'false'
      Handler: index.handler
      LoggingConfig:
        LogGroup:
          Ref: testcloudwatchcustomwidgetloggroupEBFA438D
      MemorySize: 1024
      Role:
        'Fn::GetAtt':
          - testcloudwatchcustomwidgetexecutionrole72F32199
          - Arn
      Runtime: nodejs22.x
      Tags:
        - Key: Name
          Value: RestateBYOC/test/cloudwatch-custom-widget-lambda
      Timeout: 60
    DependsOn:
      - testcloudwatchcustomwidgetexecutionroleDefaultPolicy4D8EC73B
      - testcloudwatchcustomwidgetexecutionrole72F32199
  testcloudwatchcustomwidgetlambdacloudwatchcustomwidgetlambdaallowdatasource06DF513A:
    Type: 'AWS::Lambda::Permission'
    Properties:
      Action: 'lambda:InvokeFunction'
      FunctionName:
        'Fn::GetAtt':
          - testcloudwatchcustomwidgetlambdaB0DB8C59
          - Arn
      Principal: lambda.datasource.cloudwatch.amazonaws.com
  testmetricsAAAB7FF4:
    Type: 'AWS::CloudWatch::Dashboard'
    Properties:
      DashboardBody:
        'Fn::Join':
          - ''
          - - >-
              {"widgets":[{"type":"metric","width":12,"height":6,"x":0,"y":0,"properties":{"view":"timeSeries","title":"Stateless
              CPU","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"CPU","expression":"SELECT AVG(CpuUtilized)
              FROM SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOCteststatelessdefinitionA59C4856' GROUP BY
              TaskId"}]],"annotations":{"horizontal":[{"value":16384,"label":"Limit","yAxis":"left"}]},"yAxis":{"left":{"label":"vCPUs","showUnits":false}}}},{"type":"metric","width":12,"height":6,"x":12,"y":0,"properties":{"view":"timeSeries","title":"Stateless
              Memory","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Memory","expression":"SELECT
              AVG(MemoryUtilized) FROM SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOCteststatelessdefinitionA59C4856' GROUP BY
              TaskId"}]],"annotations":{"horizontal":[{"value":32768,"label":"Limit","yAxis":"left"}]},"yAxis":{"left":{"label":"MiB","showUnits":false}}}},{"type":"metric","width":12,"height":6,"x":0,"y":6,"properties":{"view":"timeSeries","title":"Stateless
              Network Tx","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Tx","expression":"SELECT
              AVG(NetworkTxBytes) FROM SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOCteststatelessdefinitionA59C4856' GROUP BY
              TaskId"}]],"yAxis":{"left":{"label":"Bytes/sec","showUnits":false}}}},{"type":"metric","width":12,"height":6,"x":12,"y":6,"properties":{"view":"timeSeries","title":"Stateless
              Network Rx","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Rx","expression":"SELECT
              AVG(NetworkRxBytes) FROM SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOCteststatelessdefinitionA59C4856' GROUP BY
              TaskId"}]],"yAxis":{"left":{"label":"Bytes/sec","showUnits":false}}}},{"type":"log","width":24,"height":6,"x":0,"y":12,"properties":{"view":"table","title":"Stateless
              Logs","region":"region","query":"SOURCE '
            - Ref: testrestateloggroup6C0DD0DD
            - >-
              ' | fields @logStream, @timestamp, level, fields.message,
              target\\n          | sort @timestamp desc\\n          | limit
              500"}},{"type":"metric","width":12,"height":6,"x":0,"y":18,"properties":{"view":"timeSeries","title":"Stateful
              CPU","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"CPU","expression":"SELECT AVG(CpuUtilized)
              FROM SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily = 'RestateBYOCteststatefuldefinition9B15D9BA'
              GROUP BY
              TaskId"}]],"annotations":{"horizontal":[{"value":16384,"label":"Limit","yAxis":"left"}]},"yAxis":{"left":{"label":"vCPUs","showUnits":false}}}},{"type":"metric","width":12,"height":6,"x":12,"y":18,"properties":{"view":"timeSeries","title":"Stateful
              Memory","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Memory","expression":"SELECT
              AVG(MemoryUtilized) FROM SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily = 'RestateBYOCteststatefuldefinition9B15D9BA'
              GROUP BY
              TaskId"}]],"annotations":{"horizontal":[{"value":32768,"label":"Limit","yAxis":"left"}]},"yAxis":{"left":{"label":"MiB","showUnits":false}}}},{"type":"metric","width":12,"height":6,"x":0,"y":24,"properties":{"view":"timeSeries","title":"Stateful
              Network Tx","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Tx","expression":"SELECT
              AVG(NetworkTxBytes) FROM SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily = 'RestateBYOCteststatefuldefinition9B15D9BA'
              GROUP BY
              TaskId"}]],"yAxis":{"left":{"label":"Bytes/sec","showUnits":false}}}},{"type":"metric","width":12,"height":6,"x":12,"y":24,"properties":{"view":"timeSeries","title":"Stateful
              Network Rx","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Rx","expression":"SELECT
              AVG(NetworkRxBytes) FROM SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily = 'RestateBYOCteststatefuldefinition9B15D9BA'
              GROUP BY
              TaskId"}]],"yAxis":{"left":{"label":"Bytes/sec","showUnits":false}}}},{"type":"log","width":24,"height":6,"x":0,"y":30,"properties":{"view":"table","title":"Stateful
              Logs","region":"region","query":"SOURCE '
            - Ref: testrestateloggroup6C0DD0DD
            - >-
              ' | fields @logStream, @timestamp, level, fields.message,
              target\\n          | sort @timestamp desc\\n          | limit
              500"}},{"type":"metric","width":8,"height":6,"x":0,"y":36,"properties":{"view":"timeSeries","title":"Ephemeral
              Volume Usage (Total size 200GiB)","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Usage","expression":"SELECT
              MAX(EphemeralStorageUtilized) FROM
              SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily) WHERE TaskDefinitionFamily =
              'RestateBYOCteststatefuldefinition9B15D9BA'"}]],"annotations":{"horizontal":[{"value":200,"label":"Volume
              size","visible":false,"yAxis":"left"}]},"yAxis":{"left":{"label":"GiB","showUnits":false}},"liveData":false}},{"type":"metric","width":8,"height":6,"x":8,"y":36,"properties":{"view":"timeSeries","title":"Volume
              Write Throughput (Limited to 150 MiB/sec)","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Write","expression":"RATE(count) /
              1048576"}],[{"expression":"SELECT MAX(StorageWriteBytes) FROM
              SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily = 'RestateBYOCteststatefuldefinition9B15D9BA'
              GROUP BY
              TaskId","visible":false,"id":"count"}]],"annotations":{"horizontal":[{"value":150,"label":"Limit","visible":false,"yAxis":"left"}]},"yAxis":{"left":{"label":"MiB/sec","showUnits":false}}}},{"type":"metric","width":8,"height":6,"x":16,"y":36,"properties":{"view":"timeSeries","title":"Volume
              Read Throughput (Limited to 150 MiB/sec)","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Read","expression":"RATE(count) /
              1048576"}],[{"expression":"SELECT MAX(StorageReadBytes) FROM
              SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily = 'RestateBYOCteststatefuldefinition9B15D9BA'
              GROUP BY
              TaskId","visible":false,"id":"count"}]],"annotations":{"horizontal":[{"value":150,"label":"Limit","visible":false,"yAxis":"left"}]},"yAxis":{"left":{"label":"MiB/sec","showUnits":false}}}},{"type":"log","width":24,"height":6,"x":0,"y":42,"properties":{"view":"table","title":"Controller
              Logs","region":"region","query":"SOURCE '
            - Ref: testcontrollerloggroupB61E47AC
            - >-
              ' | fields @logStream, @timestamp, level, fields.message,
              target\\n          | sort @timestamp desc\\n          | limit
              500"}}]}
      DashboardName: RestateBYOC_test_metrics
  testcontrolpanel0D5F1B33:
    Type: 'AWS::CloudWatch::Dashboard'
    Properties:
      DashboardBody:
        'Fn::Join':
          - ''
          - - >-
              {"widgets":[{"type":"custom","width":24,"height":26,"x":0,"y":0,"properties":{"endpoint":"
            - 'Fn::GetAtt':
                - testcloudwatchcustomwidgetlambdaB0DB8C59
                - Arn
            - '","params":{"command":"controlPanel","input":{"region":"'
            - Ref: 'AWS::Region'
            - >-
              ","summary":{"clusterName":"RestateBYOC/test","restateVersion":"1.4","stackVersion":"0.4.1-dev","metricsDashboardName":"
            - Ref: testmetricsAAAB7FF4
            - '"},"resources":{"ecsClusterArn":"'
            - 'Fn::GetAtt':
                - testclusterDBD4D436
                - Arn
            - '","statelessServiceArn":"'
            - Ref: teststatelessserviceService5CDEA5F0
            - '","controllerServiceArn":"'
            - Ref: testcontrollerserviceService356186D6
            - '","restatectlLambdaArn":"'
            - 'Fn::GetAtt':
                - testrestatectllambda6F1900FA
                - Arn
            - >-
              "},"connectivityAndSecurity":{"connectivity":{"loadBalancerArns":{"ingress":["
            - Ref: testsharednlb6BC10CBB
            - '"],"admin":["'
            - Ref: testsharednlb6BC10CBB
            - '"]},"addresses":{"ingress":"http://'
            - 'Fn::GetAtt':
                - testsharednlb6BC10CBB
                - DNSName
            - ':8080","admin":"http://'
            - 'Fn::GetAtt':
                - testsharednlb6BC10CBB
                - DNSName
            - ':9070","webUI":"http://'
            - 'Fn::GetAtt':
                - testsharednlb6BC10CBB
                - DNSName
            - ':9070/ui"}},"networking":{"vpc":"'
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcA2121C384D1B3CDE'
            - '","availabilityZones":["dummy1a","dummy1b","dummy1c"],"subnets":["'
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet1Subnet934893E8236E2271'
            - '","'
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet2Subnet7031C2BA60DCB1EE'
            - '","'
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet3Subnet985AC459F9514491'
            - '"]},"security":{"securityGroups":["'
            - 'Fn::GetAtt':
                - testsecuritygroupB015C031
                - GroupId
            - '"]}},"storage":{"s3":{"bucket":"'
            - Ref: testbucket731B7DE2
            - >-
              "}}}},"title":"","updateOn":{"refresh":true,"resize":true,"timeRange":true}}}]}
      DashboardName: RestateBYOC_test_control-panel
Outputs:
  testSecurityGroups50C338D1:
    Description: The security group IDs of the cluster
    Value:
      'Fn::GetAtt':
        - testsecuritygroupB015C031
        - GroupId
  testIngressNetworkListenerA459AD14:
    Description: The ARN of the network listener for the ingress port
    Value:
      Ref: testingresssharedlistenerF18D3E56
  testIngressNetworkTargetGroup73857B83:
    Description: The ARN of the network target group for the ingress port
    Value:
      Ref: testingresssharedtarget779E3570
  testAdminNetworkListener840296BA:
    Description: The ARN of the network listener for the admin port
    Value:
      Ref: testadminsharedlistener6D147D79
  testAdminNetworkTargetGroup1541C506:
    Description: The ARN of the network target group for the admin port
    Value:
      Ref: testadminsharedtarget0C095FA8
  testNodeNetworkListener743144A9:
    Description: The ARN of the network listener for the node port
    Value:
      Ref: testnodesharedlistener98A38BFD
  testNodeNetworkTargetGroup76D5EEBA:
    Description: The ARN of the network target group for the node port
    Value:
      Ref: testnodesharedtarget6337BC22
"
`;

exports[`BYOC Set up custom ALB for authenticated access 1`] = `
"Resources:
  testsecuritygroupB015C031:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      GroupDescription: RestateBYOC/test/security-group
      SecurityGroupEgress:
        - CidrIp: 0.0.0.0/0
          Description: Allow all outbound traffic by default
          IpProtocol: '-1'
      Tags:
        - Key: Name
          Value: RestateBYOC/test/security-group
      VpcId:
        'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcA2121C384D1B3CDE'
  testsecuritygroupfromRestateBYOCtestsecuritygroupDC099EC280804D6652A7:
    Type: 'AWS::EC2::SecurityGroupIngress'
    Properties:
      Description: 'from RestateBYOCtestsecuritygroupDC099EC2:8080'
      FromPort: 8080
      GroupId:
        'Fn::GetAtt':
          - testsecuritygroupB015C031
          - GroupId
      IpProtocol: tcp
      SourceSecurityGroupId:
        'Fn::GetAtt':
          - testsecuritygroupB015C031
          - GroupId
      ToPort: 8080
  testsecuritygroupfromRestateBYOCtestsecuritygroupDC099EC2907024D2BE0B:
    Type: 'AWS::EC2::SecurityGroupIngress'
    Properties:
      Description: 'from RestateBYOCtestsecuritygroupDC099EC2:9070'
      FromPort: 9070
      GroupId:
        'Fn::GetAtt':
          - testsecuritygroupB015C031
          - GroupId
      IpProtocol: tcp
      SourceSecurityGroupId:
        'Fn::GetAtt':
          - testsecuritygroupB015C031
          - GroupId
      ToPort: 9070
  testsecuritygroupfromRestateBYOCtestsecuritygroupDC099EC25122D07222D4:
    Type: 'AWS::EC2::SecurityGroupIngress'
    Properties:
      Description: 'from RestateBYOCtestsecuritygroupDC099EC2:5122'
      FromPort: 5122
      GroupId:
        'Fn::GetAtt':
          - testsecuritygroupB015C031
          - GroupId
      IpProtocol: tcp
      SourceSecurityGroupId:
        'Fn::GetAtt':
          - testsecuritygroupB015C031
          - GroupId
      ToPort: 5122
  testsecuritygroupfromRestateBYOCadminalbSecurityGroup955313169070BF262A6D:
    Type: 'AWS::EC2::SecurityGroupIngress'
    Properties:
      Description: Load balancer to target
      FromPort: 9070
      GroupId:
        'Fn::GetAtt':
          - testsecuritygroupB015C031
          - GroupId
      IpProtocol: tcp
      SourceSecurityGroupId:
        'Fn::GetAtt':
          - adminalbSecurityGroup85AF9130
          - GroupId
      ToPort: 9070
  testbucket731B7DE2:
    Type: 'AWS::S3::Bucket'
    Properties:
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
    UpdateReplacePolicy: Retain
    DeletionPolicy: Retain
  testbucketPolicyB4FDDA54:
    Type: 'AWS::S3::BucketPolicy'
    Properties:
      Bucket:
        Ref: testbucket731B7DE2
      PolicyDocument:
        Statement:
          - Action: 's3:*'
            Condition:
              Bool:
                'aws:SecureTransport': 'false'
            Effect: Deny
            Principal:
              AWS: '*'
            Resource:
              - 'Fn::GetAtt':
                  - testbucket731B7DE2
                  - Arn
              - 'Fn::Join':
                  - ''
                  - - 'Fn::GetAtt':
                        - testbucket731B7DE2
                        - Arn
                    - /*
        Version: '2012-10-17'
  testclusterDBD4D436:
    Type: 'AWS::ECS::Cluster'
    Properties:
      ClusterSettings:
        - Name: containerInsights
          Value: enhanced
      Tags:
        - Key: Name
          Value: RestateBYOC/test/cluster
  testrestatetaskrole4CC243A3:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
        Version: '2012-10-17'
  testrestatetaskroleDefaultPolicy51A222FD:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 's3:GetObject'
              - 's3:PutObject'
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'Fn::GetAtt':
                      - testbucket731B7DE2
                      - Arn
                  - /*
            Sid: ReadWriteBucket
          - Action: 's3:ListBucket'
            Effect: Allow
            Resource:
              'Fn::GetAtt':
                - testbucket731B7DE2
                - Arn
            Sid: ListBucket
        Version: '2012-10-17'
      PolicyName: testrestatetaskroleDefaultPolicy51A222FD
      Roles:
        - Ref: testrestatetaskrole4CC243A3
  testrestateexecutionrole4CD7F161:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
        Version: '2012-10-17'
  testrestateexecutionroleDefaultPolicy04DC59EF:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 'logs:CreateLogStream'
              - 'logs:PutLogEvents'
            Effect: Allow
            Resource:
              'Fn::GetAtt':
                - testrestateloggroup6C0DD0DD
                - Arn
        Version: '2012-10-17'
      PolicyName: testrestateexecutionroleDefaultPolicy04DC59EF
      Roles:
        - Ref: testrestateexecutionrole4CD7F161
  testrestateloggroup6C0DD0DD:
    Type: 'AWS::Logs::LogGroup'
    Properties:
      RetentionInDays: 30
    UpdateReplacePolicy: Retain
    DeletionPolicy: Retain
  testcontrollerloggroupB61E47AC:
    Type: 'AWS::Logs::LogGroup'
    Properties:
      RetentionInDays: 30
    UpdateReplacePolicy: Retain
    DeletionPolicy: Retain
  testsharednlb6BC10CBB:
    Type: 'AWS::ElasticLoadBalancingV2::LoadBalancer'
    Properties:
      LoadBalancerAttributes:
        - Key: deletion_protection.enabled
          Value: 'false'
        - Key: load_balancing.cross_zone.enabled
          Value: 'false'
        - Key: dns_record.client_routing_policy
          Value: availability_zone_affinity
      Scheme: internal
      SecurityGroups:
        - 'Fn::GetAtt':
            - testsecuritygroupB015C031
            - GroupId
      Subnets:
        - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet1Subnet934893E8236E2271'
        - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet2Subnet7031C2BA60DCB1EE'
        - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet3Subnet985AC459F9514491'
      Tags:
        - Key: Name
          Value: RestateBYOC/test/shared-nlb
      Type: network
  testingresssharedlistenerF18D3E56:
    Type: 'AWS::ElasticLoadBalancingV2::Listener'
    Properties:
      DefaultActions:
        - TargetGroupArn:
            Ref: testingresssharedtarget779E3570
          Type: forward
      LoadBalancerArn:
        Ref: testsharednlb6BC10CBB
      Port: 8080
      Protocol: TCP
  testadminsharedlistener6D147D79:
    Type: 'AWS::ElasticLoadBalancingV2::Listener'
    Properties:
      DefaultActions:
        - TargetGroupArn:
            Ref: testadminsharedtarget0C095FA8
          Type: forward
      LoadBalancerArn:
        Ref: testsharednlb6BC10CBB
      Port: 9070
      Protocol: TCP
  testnodesharedlistener98A38BFD:
    Type: 'AWS::ElasticLoadBalancingV2::Listener'
    Properties:
      DefaultActions:
        - TargetGroupArn:
            Ref: testnodesharedtarget6337BC22
          Type: forward
      LoadBalancerArn:
        Ref: testsharednlb6BC10CBB
      Port: 5122
      Protocol: TCP
  teststatelessdefinition64DABAD1:
    Type: 'AWS::ECS::TaskDefinition'
    Properties:
      ContainerDefinitions:
        - Cpu: 16384
          EntryPoint:
            - bash
            - '-c'
            - >

              curl --no-progress-meter $ECS_CONTAINER_METADATA_URI_V4 -o
              container-metadata && \\

              curl --no-progress-meter $ECS_CONTAINER_METADATA_URI_V4/task -o
              task-metadata && \\

              export \\
                RESTATE_NODE_NAME=$(jq -r '.TaskARN' task-metadata) \\
                RESTATE_LOCATION="$AWS_REGION.$(jq -r '.AvailabilityZone' task-metadata)" \\
                RESTATE_ADVERTISED_ADDRESS="http://$(jq -r '.Networks[0].IPv4Addresses[0]' container-metadata):5122"
              exec restate-server
          Environment:
            - Name: RESTATE_LOG_FORMAT
              Value: json
            - Name: RESTATE_CLUSTER_NAME
              Value: RestateBYOC/test
            - Name: RESTATE_ROLES
              Value: '["admin","http-ingress"]'
            - Name: RESTATE_AUTO_PROVISION
              Value: 'true'
            - Name: RESTATE_SHUTDOWN_TIMEOUT
              Value: 100s
            - Name: RESTATE_DEFAULT_NUM_PARTITIONS
              Value: '128'
            - Name: RESTATE_DEFAULT_REPLICATION
              Value: '{zone: 2}'
            - Name: RESTATE_METADATA_CLIENT__TYPE
              Value: object-store
            - Name: RESTATE_METADATA_CLIENT__PATH
              Value:
                'Fn::Join':
                  - ''
                  - - 's3://'
                    - Ref: testbucket731B7DE2
                    - /metadata
            - Name: RESTATE_BIFROST__DEFAULT_PROVIDER
              Value: replicated
            - Name: >-
                RESTATE_INGRESS__EXPERIMENTAL_FEATURE_ENABLE_SEPARATE_INGRESS_ROLE
              Value: 'true'
            - Name: RESTATE_INGRESS__ADVERTISED_INGRESS_ENDPOINT
              Value:
                'Fn::Join':
                  - ''
                  - - 'http://'
                    - 'Fn::GetAtt':
                        - testsharednlb6BC10CBB
                        - DNSName
                    - ':8080'
            - Name: RESTATE_WORKER__SNAPSHOTS__DESTINATION
              Value:
                'Fn::Join':
                  - ''
                  - - 's3://'
                    - Ref: testbucket731B7DE2
                    - /snapshots
          Essential: true
          HealthCheck:
            Command:
              - CMD
              - curl
              - '--fail'
              - 'http://127.0.0.1:8080/restate/health'
            Interval: 30
            Retries: 3
            Timeout: 5
          Image: Any<Object>
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group:
                Ref: testrestateloggroup6C0DD0DD
              awslogs-stream-prefix: restate
              awslogs-region: region
              mode: non-blocking
          Memory: 32768
          Name: restate
          PortMappings:
            - ContainerPort: 8080
              Name: ingress
              Protocol: tcp
            - ContainerPort: 9070
              Name: admin
              Protocol: tcp
            - ContainerPort: 5122
              Name: node
              Protocol: tcp
          StopTimeout: 120
      Cpu: '16384'
      ExecutionRoleArn:
        'Fn::GetAtt':
          - testrestateexecutionrole4CD7F161
          - Arn
      Family: RestateBYOCteststatelessdefinitionA59C4856
      Memory: '32768'
      NetworkMode: awsvpc
      RequiresCompatibilities:
        - FARGATE
      RuntimePlatform:
        CpuArchitecture: ARM64
        OperatingSystemFamily: LINUX
      Tags:
        - Key: Name
          Value: RestateBYOC/test/stateless-definition
      TaskRoleArn:
        'Fn::GetAtt':
          - testrestatetaskrole4CC243A3
          - Arn
  teststatelessserviceService5CDEA5F0:
    Type: 'AWS::ECS::Service'
    Properties:
      AvailabilityZoneRebalancing: ENABLED
      Cluster:
        Ref: testclusterDBD4D436
      DeploymentConfiguration:
        Alarms:
          AlarmNames: []
          Enable: false
          Rollback: false
        MaximumPercent: 200
        MinimumHealthyPercent: 100
      DeploymentController:
        Type: ECS
      DesiredCount: 3
      EnableECSManagedTags: false
      EnableExecuteCommand: false
      HealthCheckGracePeriodSeconds: 60
      LaunchType: FARGATE
      LoadBalancers:
        - ContainerName: restate
          ContainerPort: 8080
          TargetGroupArn:
            Ref: testingresssharedtarget779E3570
        - ContainerName: restate
          ContainerPort: 9070
          TargetGroupArn:
            Ref: testadminsharedtarget0C095FA8
        - ContainerName: restate
          ContainerPort: 5122
          TargetGroupArn:
            Ref: testnodesharedtarget6337BC22
        - ContainerName: restate
          ContainerPort: 9070
          TargetGroupArn:
            Ref: testadminapplicationtarget365AC38B
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: DISABLED
          SecurityGroups:
            - 'Fn::GetAtt':
                - testsecuritygroupB015C031
                - GroupId
          Subnets:
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet1Subnet934893E8236E2271'
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet2Subnet7031C2BA60DCB1EE'
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet3Subnet985AC459F9514491'
      PropagateTags: SERVICE
      Tags:
        - Key: Name
          Value: RestateBYOC/test/stateless-service
      TaskDefinition:
        Ref: teststatelessdefinition64DABAD1
    DependsOn:
      - adminalbadminlistenerF7D4D12B
      - testadminsharedlistener6D147D79
      - testingresssharedlistenerF18D3E56
      - testnodesharedlistener98A38BFD
      - testrestatetaskroleDefaultPolicy51A222FD
      - testrestatetaskrole4CC243A3
  teststatefuldefinitionB92BAA14:
    Type: 'AWS::ECS::TaskDefinition'
    Properties:
      ContainerDefinitions:
        - Cpu: 16384
          EntryPoint:
            - bash
            - '-c'
            - >

              curl --no-progress-meter $ECS_CONTAINER_METADATA_URI_V4 -o
              container-metadata && \\

              curl --no-progress-meter $ECS_CONTAINER_METADATA_URI_V4/task -o
              task-metadata && \\

              export \\
                RESTATE_NODE_NAME=$(jq -r '.TaskARN' task-metadata) \\
                RESTATE_LOCATION="$AWS_REGION.$(jq -r '.AvailabilityZone' task-metadata)" \\
                RESTATE_ADVERTISED_ADDRESS="http://$(jq -r '.Networks[0].IPv4Addresses[0]' container-metadata):5122" \\
                RESTATE_ROCKSDB_TOTAL_MEMORY_SIZE="$(($(jq -r '.Limits.Memory' container-metadata) * 3 / 4))MiB" \\
                RESTATE_WORKER__STORAGE__NUM_PARTITIONS_TO_SHARE_MEMORY_BUDGET=$(("$RESTATE_WORKER__STORAGE__NUM_PARTITIONS_TO_SHARE_MEMORY_BUDGET"))
              exec restate-server
          Environment:
            - Name: RESTATE_LOG_FORMAT
              Value: json
            - Name: RESTATE_CLUSTER_NAME
              Value: RestateBYOC/test
            - Name: RESTATE_ROLES
              Value: '["log-server", "worker"]'
            - Name: RESTATE_AUTO_PROVISION
              Value: 'false'
            - Name: RESTATE_SHUTDOWN_TIMEOUT
              Value: 100s
            - Name: RESTATE_METADATA_CLIENT__TYPE
              Value: object-store
            - Name: RESTATE_METADATA_CLIENT__PATH
              Value:
                'Fn::Join':
                  - ''
                  - - 's3://'
                    - Ref: testbucket731B7DE2
                    - /metadata
            - Name: RESTATE_WORKER__SNAPSHOTS__DESTINATION
              Value:
                'Fn::Join':
                  - ''
                  - - 's3://'
                    - Ref: testbucket731B7DE2
                    - /snapshots
            - Name: RESTATE_WORKER__SNAPSHOTS__SNAPSHOT_INTERVAL_NUM_RECORDS
              Value: '1000000'
            - Name: RESTATE_WORKER__STORAGE__ROCKSDB_DISABLE_DIRECT_IO_FOR_READS
              Value: 'true'
            - Name: RESTATE_WORKER__STORAGE__ROCKSDB_DISABLE_WAL_FSYNC
              Value: 'true'
            - Name: RESTATE_WORKER__STORAGE__NUM_PARTITIONS_TO_SHARE_MEMORY_BUDGET
              Value: (128 * 2) / (3 * 1)
            - Name: RESTATE_LOG_SERVER__ROCKSDB_DISABLE_WAL_FSYNC
              Value: 'true'
            - Name: RESTATE_LOG_SERVER__ROCKSDB_DISABLE_DIRECT_IO_FOR_READS
              Value: 'true'
            - Name: >-
                RESTATE_INGRESS__EXPERIMENTAL_FEATURE_ENABLE_SEPARATE_INGRESS_ROLE
              Value: 'true'
          Essential: true
          HealthCheck:
            Command:
              - CMD
              - curl
              - '--fail'
              - 'http://127.0.0.1:5122/health'
            Interval: 30
            Retries: 3
            Timeout: 5
          Image: Any<Object>
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group:
                Ref: testrestateloggroup6C0DD0DD
              awslogs-stream-prefix: restate
              awslogs-region: region
              mode: non-blocking
          Memory: 32768
          MountPoints:
            - ContainerPath: /restate-data
              ReadOnly: false
              SourceVolume: restate-data
          Name: restate
          PortMappings:
            - ContainerPort: 5122
              Name: node
              Protocol: tcp
          RestartPolicy:
            Enabled: true
            RestartAttemptPeriod: 60
          StopTimeout: 120
      Cpu: '16384'
      EphemeralStorage:
        SizeInGiB: 200
      ExecutionRoleArn:
        'Fn::GetAtt':
          - testrestateexecutionrole4CD7F161
          - Arn
      Family: RestateBYOCteststatefuldefinition9B15D9BA
      Memory: '32768'
      NetworkMode: awsvpc
      RequiresCompatibilities:
        - FARGATE
      RuntimePlatform:
        CpuArchitecture: ARM64
        OperatingSystemFamily: LINUX
      Tags:
        - Key: Name
          Value: RestateBYOC/test/stateful-definition
      TaskRoleArn:
        'Fn::GetAtt':
          - testrestatetaskrole4CC243A3
          - Arn
      Volumes:
        - ConfiguredAtLaunch: false
          Name: restate-data
  testingresssharedtarget779E3570:
    Type: 'AWS::ElasticLoadBalancingV2::TargetGroup'
    Properties:
      HealthCheckEnabled: true
      HealthCheckIntervalSeconds: 5
      HealthCheckPath: /restate/health
      HealthCheckProtocol: HTTP
      HealthCheckTimeoutSeconds: 2
      Port: 8080
      Protocol: TCP
      Tags:
        - Key: Name
          Value: RestateBYOC/test/ingress-shared-target
      TargetType: ip
      VpcId:
        'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcA2121C384D1B3CDE'
  testadminsharedtarget0C095FA8:
    Type: 'AWS::ElasticLoadBalancingV2::TargetGroup'
    Properties:
      HealthCheckEnabled: true
      HealthCheckIntervalSeconds: 5
      HealthCheckPath: /health
      HealthCheckPort: '9070'
      HealthCheckProtocol: HTTP
      HealthCheckTimeoutSeconds: 2
      Port: 9070
      Protocol: TCP
      Tags:
        - Key: Name
          Value: RestateBYOC/test/admin-shared-target
      TargetType: ip
      VpcId:
        'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcA2121C384D1B3CDE'
  testnodesharedtarget6337BC22:
    Type: 'AWS::ElasticLoadBalancingV2::TargetGroup'
    Properties:
      HealthCheckEnabled: true
      HealthCheckIntervalSeconds: 5
      HealthCheckPath: /health
      HealthCheckPort: '5122'
      HealthCheckProtocol: HTTP
      HealthCheckTimeoutSeconds: 2
      Port: 5122
      Protocol: TCP
      Tags:
        - Key: Name
          Value: RestateBYOC/test/node-shared-target
      TargetType: ip
      VpcId:
        'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcA2121C384D1B3CDE'
  testcontrollertaskrole42417C6E:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
        Version: '2012-10-17'
  testcontrollertaskroleDefaultPolicy030D6236:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action: 'ecs:ListTasks'
            Condition:
              ArnEquals:
                'ecs:cluster':
                  'Fn::GetAtt':
                    - testclusterDBD4D436
                    - Arn
            Effect: Allow
            Resource: '*'
            Sid: ECSListActions
          - Action:
              - 'ecs:TagResource'
              - 'ecs:DescribeTasks'
              - 'ecs:StopTask'
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'Fn::Join':
                      - /
                      - - 'Fn::Join':
                            - ':'
                            - - 'Fn::Select':
                                  - 0
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - testclusterDBD4D436
                                                  - Arn
                              - 'Fn::Select':
                                  - 1
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - testclusterDBD4D436
                                                  - Arn
                              - 'Fn::Select':
                                  - 2
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - testclusterDBD4D436
                                                  - Arn
                              - 'Fn::Select':
                                  - 3
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - testclusterDBD4D436
                                                  - Arn
                              - 'Fn::Select':
                                  - 4
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - testclusterDBD4D436
                                                  - Arn
                              - task
                        - 'Fn::Select':
                            - 1
                            - 'Fn::Split':
                                - /
                                - 'Fn::GetAtt':
                                    - testclusterDBD4D436
                                    - Arn
                        - ''
                  - '*'
            Sid: TaskActions
          - Action: 'ecs:RunTask'
            Condition:
              ArnEquals:
                'ecs:cluster':
                  'Fn::GetAtt':
                    - testclusterDBD4D436
                    - Arn
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'Fn::Join':
                      - ':'
                      - - 'Fn::Select':
                            - 0
                            - 'Fn::Split':
                                - ':'
                                - Ref: teststatefuldefinitionB92BAA14
                        - 'Fn::Select':
                            - 1
                            - 'Fn::Split':
                                - ':'
                                - Ref: teststatefuldefinitionB92BAA14
                        - 'Fn::Select':
                            - 2
                            - 'Fn::Split':
                                - ':'
                                - Ref: teststatefuldefinitionB92BAA14
                        - 'Fn::Select':
                            - 3
                            - 'Fn::Split':
                                - ':'
                                - Ref: teststatefuldefinitionB92BAA14
                        - 'Fn::Select':
                            - 4
                            - 'Fn::Split':
                                - ':'
                                - Ref: teststatefuldefinitionB92BAA14
                        - 'Fn::Select':
                            - 5
                            - 'Fn::Split':
                                - ':'
                                - Ref: teststatefuldefinitionB92BAA14
                  - ':*'
            Sid: RunTask
          - Action: 'iam:PassRole'
            Condition:
              StringEquals:
                'iam:PassedToService': ecs-tasks.amazonaws.com
            Effect: Allow
            Resource:
              - 'Fn::GetAtt':
                  - testrestatetaskrole4CC243A3
                  - Arn
              - 'Fn::GetAtt':
                  - testrestateexecutionrole4CD7F161
                  - Arn
            Sid: RunTaskPassRole
          - Action:
              - 'ec2:DescribeVolumes'
              - 'ec2:DescribeSnapshots'
            Effect: Allow
            Resource: '*'
            Sid: EC2ListActions
          - Action: 'ec2:CreateSnapshot'
            Condition:
              ArnEquals:
                'aws:RequestTag/restate:ecsClusterArn':
                  'Fn::GetAtt':
                    - testclusterDBD4D436
                    - Arn
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'arn:'
                  - Ref: 'AWS::Partition'
                  - ':ec2:'
                  - Ref: 'AWS::Region'
                  - '::snapshot/*'
            Sid: CreateSnapshot
          - Action: 'ec2:CreateSnapshot'
            Condition:
              ArnEquals:
                'aws:ResourceTag/restate:ecsClusterArn':
                  'Fn::GetAtt':
                    - testclusterDBD4D436
                    - Arn
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'arn:'
                  - Ref: 'AWS::Partition'
                  - ':ec2:'
                  - Ref: 'AWS::Region'
                  - ':'
                  - Ref: 'AWS::AccountId'
                  - ':volume/*'
            Sid: SnapshotVolume
          - Action: 'ec2:CreateTags'
            Condition:
              StringEquals:
                'ec2:CreateAction': CreateSnapshot
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'arn:'
                  - Ref: 'AWS::Partition'
                  - ':ec2:'
                  - Ref: 'AWS::Region'
                  - '::snapshot/*'
            Sid: TagSnapshots
          - Action:
              - 'ec2:DeleteVolume'
              - 'ec2:DeleteSnapshot'
            Condition:
              ArnEquals:
                'aws:ResourceTag/restate:ecsClusterArn':
                  'Fn::GetAtt':
                    - testclusterDBD4D436
                    - Arn
            Effect: Allow
            Resource:
              - 'Fn::Join':
                  - ''
                  - - 'arn:'
                    - Ref: 'AWS::Partition'
                    - ':ec2:'
                    - Ref: 'AWS::Region'
                    - ':'
                    - Ref: 'AWS::AccountId'
                    - ':volume/*'
              - 'Fn::Join':
                  - ''
                  - - 'arn:'
                    - Ref: 'AWS::Partition'
                    - ':ec2:'
                    - Ref: 'AWS::Region'
                    - '::snapshot/*'
            Sid: DeleteVolumeAndSnapshot
          - Action:
              - 's3:GetObject'
              - 's3:PutObject'
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'Fn::GetAtt':
                      - testbucket731B7DE2
                      - Arn
                  - /*
            Sid: ReadWriteBucket
          - Action: 's3:ListBucket'
            Effect: Allow
            Resource:
              'Fn::GetAtt':
                - testbucket731B7DE2
                - Arn
            Sid: ListBucket
        Version: '2012-10-17'
      PolicyName: testcontrollertaskroleDefaultPolicy030D6236
      Roles:
        - Ref: testcontrollertaskrole42417C6E
  testcontrollerexecutionrole3BE0C8C4:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
        Version: '2012-10-17'
  testcontrollerexecutionroleDefaultPolicy443CB52A:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 'logs:CreateLogStream'
              - 'logs:PutLogEvents'
            Effect: Allow
            Resource:
              'Fn::GetAtt':
                - testcontrollerloggroupB61E47AC
                - Arn
        Version: '2012-10-17'
      PolicyName: testcontrollerexecutionroleDefaultPolicy443CB52A
      Roles:
        - Ref: testcontrollerexecutionrole3BE0C8C4
  testcontrollerdefinition0C4BC223:
    Type: 'AWS::ECS::TaskDefinition'
    Properties:
      ContainerDefinitions:
        - Cpu: 1024
          Environment:
            - Name: RUST_LOG
              Value: 'info,restate_fargate_controller=debug'
            - Name: CONTROLLER_LOG_FORMAT
              Value: json
            - Name: CONTROLLER_METADATA_PATH
              Value:
                'Fn::Join':
                  - ''
                  - - 's3://'
                    - Ref: testbucket731B7DE2
                    - /metadata
            - Name: CONTROLLER_RECONCILE_INTERVAL
              Value: 10s
            - Name: CONTROLLER_CLUSTER__CLUSTER_ARN
              Value:
                'Fn::GetAtt':
                  - testclusterDBD4D436
                  - Arn
            - Name: CONTROLLER_LICENSE_KEY
              Value: foo
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __REGION
              Value:
                Ref: 'AWS::Region'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __CLUSTER_ARN
              Value:
                'Fn::GetAtt':
                  - testclusterDBD4D436
                  - Arn
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __TASK_PREFIX
              Value:
                'Fn::Join':
                  - /
                  - - 'Fn::Join':
                        - ':'
                        - - 'Fn::Select':
                              - 0
                              - 'Fn::Split':
                                  - ':'
                                  - 'Fn::Select':
                                      - 0
                                      - 'Fn::Split':
                                          - /
                                          - 'Fn::GetAtt':
                                              - testclusterDBD4D436
                                              - Arn
                          - 'Fn::Select':
                              - 1
                              - 'Fn::Split':
                                  - ':'
                                  - 'Fn::Select':
                                      - 0
                                      - 'Fn::Split':
                                          - /
                                          - 'Fn::GetAtt':
                                              - testclusterDBD4D436
                                              - Arn
                          - 'Fn::Select':
                              - 2
                              - 'Fn::Split':
                                  - ':'
                                  - 'Fn::Select':
                                      - 0
                                      - 'Fn::Split':
                                          - /
                                          - 'Fn::GetAtt':
                                              - testclusterDBD4D436
                                              - Arn
                          - 'Fn::Select':
                              - 3
                              - 'Fn::Split':
                                  - ':'
                                  - 'Fn::Select':
                                      - 0
                                      - 'Fn::Split':
                                          - /
                                          - 'Fn::GetAtt':
                                              - testclusterDBD4D436
                                              - Arn
                          - 'Fn::Select':
                              - 4
                              - 'Fn::Split':
                                  - ':'
                                  - 'Fn::Select':
                                      - 0
                                      - 'Fn::Split':
                                          - /
                                          - 'Fn::GetAtt':
                                              - testclusterDBD4D436
                                              - Arn
                          - task
                    - 'Fn::Select':
                        - 1
                        - 'Fn::Split':
                            - /
                            - 'Fn::GetAtt':
                                - testclusterDBD4D436
                                - Arn
                    - ''
            - Name: CONTROLLER_EBS_SNAPSHOT_RETENTION_PERIOD
              Value: 24h
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1a__ENABLE_EXECUTE_COMMAND
              Value: 'false'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1a__SECURITY_GROUPS
              Value:
                'Fn::Join':
                  - ''
                  - - '["'
                    - 'Fn::GetAtt':
                        - testsecuritygroupB015C031
                        - GroupId
                    - '"]'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1a__SUBNETS
              Value:
                'Fn::Join':
                  - ''
                  - - '["'
                    - 'Fn::ImportValue': >-
                        VPCStack:ExportsOutputRefvpcPrivateSubnet1Subnet934893E8236E2271
                    - '"]'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1a__TASK_DEFINITION_ARN
              Value:
                Ref: teststatefuldefinitionB92BAA14
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1a__COUNT
              Value: '1'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1b__ENABLE_EXECUTE_COMMAND
              Value: 'false'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1b__SECURITY_GROUPS
              Value:
                'Fn::Join':
                  - ''
                  - - '["'
                    - 'Fn::GetAtt':
                        - testsecuritygroupB015C031
                        - GroupId
                    - '"]'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1b__SUBNETS
              Value:
                'Fn::Join':
                  - ''
                  - - '["'
                    - 'Fn::ImportValue': >-
                        VPCStack:ExportsOutputRefvpcPrivateSubnet2Subnet7031C2BA60DCB1EE
                    - '"]'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1b__TASK_DEFINITION_ARN
              Value:
                Ref: teststatefuldefinitionB92BAA14
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1b__COUNT
              Value: '1'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1c__ENABLE_EXECUTE_COMMAND
              Value: 'false'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1c__SECURITY_GROUPS
              Value:
                'Fn::Join':
                  - ''
                  - - '["'
                    - 'Fn::GetAtt':
                        - testsecuritygroupB015C031
                        - GroupId
                    - '"]'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1c__SUBNETS
              Value:
                'Fn::Join':
                  - ''
                  - - '["'
                    - 'Fn::ImportValue': >-
                        VPCStack:ExportsOutputRefvpcPrivateSubnet3Subnet985AC459F9514491
                    - '"]'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1c__TASK_DEFINITION_ARN
              Value:
                Ref: teststatefuldefinitionB92BAA14
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1c__COUNT
              Value: '1'
          Essential: true
          HealthCheck:
            Command:
              - CMD
              - curl
              - '--fail'
              - 'http://127.0.0.1:8080/health'
            Interval: 30
            Retries: 10
            StartPeriod: 300
            Timeout: 5
          Image: Any<Object>
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group:
                Ref: testcontrollerloggroupB61E47AC
              awslogs-stream-prefix: controller
              awslogs-region: region
              mode: non-blocking
          Memory: 2048
          Name: controller
          StopTimeout: 120
      Cpu: '1024'
      ExecutionRoleArn:
        'Fn::GetAtt':
          - testcontrollerexecutionrole3BE0C8C4
          - Arn
      Family: RestateBYOCtestcontrollerdefinitionA329F74F
      Memory: '2048'
      NetworkMode: awsvpc
      RequiresCompatibilities:
        - FARGATE
      RuntimePlatform:
        CpuArchitecture: ARM64
        OperatingSystemFamily: LINUX
      Tags:
        - Key: Name
          Value: RestateBYOC/test/controller-definition
      TaskRoleArn:
        'Fn::GetAtt':
          - testcontrollertaskrole42417C6E
          - Arn
  testcontrollerserviceService356186D6:
    Type: 'AWS::ECS::Service'
    Properties:
      Cluster:
        Ref: testclusterDBD4D436
      DeploymentConfiguration:
        Alarms:
          AlarmNames: []
          Enable: false
          Rollback: false
        MaximumPercent: 100
        MinimumHealthyPercent: 0
      DeploymentController:
        Type: ECS
      DesiredCount: 1
      EnableECSManagedTags: false
      EnableExecuteCommand: false
      LaunchType: FARGATE
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: DISABLED
          SecurityGroups:
            - 'Fn::GetAtt':
                - testsecuritygroupB015C031
                - GroupId
          Subnets:
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet1Subnet934893E8236E2271'
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet2Subnet7031C2BA60DCB1EE'
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet3Subnet985AC459F9514491'
      Tags:
        - Key: Name
          Value: RestateBYOC/test/controller-service
      TaskDefinition:
        Ref: testcontrollerdefinition0C4BC223
    DependsOn:
      - testcontrollertaskroleDefaultPolicy030D6236
      - testcontrollertaskrole42417C6E
  testrestatectlloggroupC2AAB6C7:
    Type: 'AWS::Logs::LogGroup'
    Properties:
      RetentionInDays: 14
    UpdateReplacePolicy: Retain
    DeletionPolicy: Retain
  testrestatectllambdaexecutionrole9C923F83:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
        Version: '2012-10-17'
  testrestatectllambdaexecutionroleDefaultPolicy93BA3725:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 'logs:CreateLogStream'
              - 'logs:PutLogEvents'
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'arn:'
                  - Ref: 'AWS::Partition'
                  - ':logs:'
                  - Ref: 'AWS::Region'
                  - ':'
                  - Ref: 'AWS::AccountId'
                  - ':log-group:'
                  - Ref: testrestatectlloggroupC2AAB6C7
                  - ':log-stream:*'
            Sid: AWSLambdaLogStreamPermissions
          - Action:
              - 'ec2:CreateNetworkInterface'
              - 'ec2:DescribeNetworkInterfaces'
              - 'ec2:DescribeSubnets'
              - 'ec2:DeleteNetworkInterface'
            Effect: Allow
            Resource: '*'
            Sid: AWSLambdaVPCWildcardPermissions
          - Action:
              - 'ec2:AssignPrivateIpAddresses'
              - 'ec2:UnassignPrivateIpAddresses'
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'arn:'
                  - Ref: 'AWS::Partition'
                  - ':ec2:'
                  - Ref: 'AWS::Region'
                  - ':'
                  - Ref: 'AWS::AccountId'
                  - ':network-interface/*'
            Sid: AWSLambdaVPCNetworkInterfacePermissions
        Version: '2012-10-17'
      PolicyName: testrestatectllambdaexecutionroleDefaultPolicy93BA3725
      Roles:
        - Ref: testrestatectllambdaexecutionrole9C923F83
  testrestatectllambda6F1900FA:
    Type: 'AWS::Lambda::Function'
    Properties:
      Architectures:
        - arm64
      Code: Any<Object>
      Environment:
        Variables:
          RESTATECTL_ADDRESS:
            'Fn::Join':
              - ''
              - - 'http://'
                - 'Fn::GetAtt':
                    - testsharednlb6BC10CBB
                    - DNSName
                - ':5122'
      Handler: restatectl
      LoggingConfig:
        LogGroup:
          Ref: testrestatectlloggroupC2AAB6C7
      Role:
        'Fn::GetAtt':
          - testrestatectllambdaexecutionrole9C923F83
          - Arn
      Runtime: provided.al2023
      Tags:
        - Key: Name
          Value: RestateBYOC/test/restatectl-lambda
      Timeout: 10
      VpcConfig:
        SecurityGroupIds:
          - 'Fn::GetAtt':
              - testsecuritygroupB015C031
              - GroupId
        SubnetIds:
          - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet1Subnet934893E8236E2271'
          - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet2Subnet7031C2BA60DCB1EE'
          - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet3Subnet985AC459F9514491'
    DependsOn:
      - testrestatectllambdaexecutionroleDefaultPolicy93BA3725
      - testrestatectllambdaexecutionrole9C923F83
  testretirementwatcherloggroupBCD89B2E:
    Type: 'AWS::Logs::LogGroup'
    Properties:
      RetentionInDays: 14
    UpdateReplacePolicy: Retain
    DeletionPolicy: Retain
  testretirementwatcherlambdaexecutionrole0BCEB9D0:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
        Version: '2012-10-17'
  testretirementwatcherlambdaexecutionroleDefaultPolicy6E9FBD0D:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 'logs:CreateLogStream'
              - 'logs:PutLogEvents'
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'arn:'
                  - Ref: 'AWS::Partition'
                  - ':logs:'
                  - Ref: 'AWS::Region'
                  - ':'
                  - Ref: 'AWS::AccountId'
                  - ':log-group:'
                  - Ref: testretirementwatcherloggroupBCD89B2E
                  - ':log-stream:*'
            Sid: AWSLambdaLogStreamPermissions
          - Action: 'ecs:TagResource'
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'Fn::Join':
                      - /
                      - - 'Fn::Join':
                            - ':'
                            - - 'Fn::Select':
                                  - 0
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - testclusterDBD4D436
                                                  - Arn
                              - 'Fn::Select':
                                  - 1
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - testclusterDBD4D436
                                                  - Arn
                              - 'Fn::Select':
                                  - 2
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - testclusterDBD4D436
                                                  - Arn
                              - 'Fn::Select':
                                  - 3
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - testclusterDBD4D436
                                                  - Arn
                              - 'Fn::Select':
                                  - 4
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - testclusterDBD4D436
                                                  - Arn
                              - task
                        - 'Fn::Select':
                            - 1
                            - 'Fn::Split':
                                - /
                                - 'Fn::GetAtt':
                                    - testclusterDBD4D436
                                    - Arn
                        - ''
                  - '*'
            Sid: TagTasks
          - Action:
              - 'sqs:ReceiveMessage'
              - 'sqs:ChangeMessageVisibility'
              - 'sqs:GetQueueUrl'
              - 'sqs:DeleteMessage'
              - 'sqs:GetQueueAttributes'
            Effect: Allow
            Resource:
              'Fn::GetAtt':
                - testretirementwatcherqueue71FDBFE9
                - Arn
        Version: '2012-10-17'
      PolicyName: testretirementwatcherlambdaexecutionroleDefaultPolicy6E9FBD0D
      Roles:
        - Ref: testretirementwatcherlambdaexecutionrole0BCEB9D0
  testretirementwatcherlambdaF666308D:
    Type: 'AWS::Lambda::Function'
    Properties:
      Architectures:
        - arm64
      Code: Any<Object>
      Handler: index.handler
      LoggingConfig:
        LogGroup:
          Ref: testretirementwatcherloggroupBCD89B2E
      Role:
        'Fn::GetAtt':
          - testretirementwatcherlambdaexecutionrole0BCEB9D0
          - Arn
      Runtime: nodejs22.x
      Tags:
        - Key: Name
          Value: RestateBYOC/test/retirement-watcher-lambda
      Timeout: 60
    DependsOn:
      - testretirementwatcherlambdaexecutionroleDefaultPolicy6E9FBD0D
      - testretirementwatcherlambdaexecutionrole0BCEB9D0
  testretirementwatcherlambdaSqsEventSourceRestateBYOCtestretirementwatcherqueue805C85E9DF913057:
    Type: 'AWS::Lambda::EventSourceMapping'
    Properties:
      BatchSize: 1
      EventSourceArn:
        'Fn::GetAtt':
          - testretirementwatcherqueue71FDBFE9
          - Arn
      FunctionName:
        Ref: testretirementwatcherlambdaF666308D
      Tags:
        - Key: Name
          Value: RestateBYOC/test/retirement-watcher-lambda
  testretirementwatcherqueue71FDBFE9:
    Type: 'AWS::SQS::Queue'
    Properties:
      Tags:
        - Key: Name
          Value: RestateBYOC/test/retirement-watcher-queue
      VisibilityTimeout: 60
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  testretirementwatcherqueuePolicy7D50DFC3:
    Type: 'AWS::SQS::QueuePolicy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 'sqs:SendMessage'
              - 'sqs:GetQueueAttributes'
              - 'sqs:GetQueueUrl'
            Condition:
              ArnEquals:
                'aws:SourceArn':
                  'Fn::GetAtt':
                    - testretirementwatcherruleBA70D9F7
                    - Arn
            Effect: Allow
            Principal:
              Service: events.amazonaws.com
            Resource:
              'Fn::GetAtt':
                - testretirementwatcherqueue71FDBFE9
                - Arn
        Version: '2012-10-17'
      Queues:
        - Ref: testretirementwatcherqueue71FDBFE9
  testretirementwatcherruleBA70D9F7:
    Type: 'AWS::Events::Rule'
    Properties:
      EventPattern:
        detail:
          eventTypeCode:
            - equals-ignore-case: AWS_ECS_TASK_PATCHING_RETIREMENT
          service:
            - equals-ignore-case: ecs
        resources:
          - prefix:
              'Fn::Join':
                - /
                - - 'Fn::Join':
                      - ':'
                      - - 'Fn::Select':
                            - 0
                            - 'Fn::Split':
                                - ':'
                                - 'Fn::Select':
                                    - 0
                                    - 'Fn::Split':
                                        - /
                                        - 'Fn::GetAtt':
                                            - testclusterDBD4D436
                                            - Arn
                        - 'Fn::Select':
                            - 1
                            - 'Fn::Split':
                                - ':'
                                - 'Fn::Select':
                                    - 0
                                    - 'Fn::Split':
                                        - /
                                        - 'Fn::GetAtt':
                                            - testclusterDBD4D436
                                            - Arn
                        - 'Fn::Select':
                            - 2
                            - 'Fn::Split':
                                - ':'
                                - 'Fn::Select':
                                    - 0
                                    - 'Fn::Split':
                                        - /
                                        - 'Fn::GetAtt':
                                            - testclusterDBD4D436
                                            - Arn
                        - 'Fn::Select':
                            - 3
                            - 'Fn::Split':
                                - ':'
                                - 'Fn::Select':
                                    - 0
                                    - 'Fn::Split':
                                        - /
                                        - 'Fn::GetAtt':
                                            - testclusterDBD4D436
                                            - Arn
                        - 'Fn::Select':
                            - 4
                            - 'Fn::Split':
                                - ':'
                                - 'Fn::Select':
                                    - 0
                                    - 'Fn::Split':
                                        - /
                                        - 'Fn::GetAtt':
                                            - testclusterDBD4D436
                                            - Arn
                        - task
                  - 'Fn::Select':
                      - 1
                      - 'Fn::Split':
                          - /
                          - 'Fn::GetAtt':
                              - testclusterDBD4D436
                              - Arn
                  - ''
        detail-type:
          - equals-ignore-case: AWS Health Event
      State: ENABLED
      Targets:
        - Arn:
            'Fn::GetAtt':
              - testretirementwatcherqueue71FDBFE9
              - Arn
          Id: Target0
  testcloudwatchcustomwidgetloggroupEBFA438D:
    Type: 'AWS::Logs::LogGroup'
    Properties:
      RetentionInDays: 14
    UpdateReplacePolicy: Retain
    DeletionPolicy: Retain
  testcloudwatchcustomwidgetexecutionrole72F32199:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
        Version: '2012-10-17'
  testcloudwatchcustomwidgetexecutionroleDefaultPolicy4D8EC73B:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 'logs:CreateLogStream'
              - 'logs:PutLogEvents'
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'arn:'
                  - Ref: 'AWS::Partition'
                  - ':logs:'
                  - Ref: 'AWS::Region'
                  - ':'
                  - Ref: 'AWS::AccountId'
                  - ':log-group:'
                  - Ref: testcloudwatchcustomwidgetloggroupEBFA438D
                  - ':log-stream:*'
            Sid: AWSLambdaLogStreamPermissions
          - Action: 'lambda:InvokeFunction'
            Effect: Allow
            Resource:
              'Fn::GetAtt':
                - testrestatectllambda6F1900FA
                - Arn
            Sid: InvokeRestatectl
          - Action: 'ecs:DescribeTaskDefinition'
            Effect: Allow
            Resource: '*'
            Sid: ECSReadActions
          - Action: 'ecs:ListTasks'
            Condition:
              StringEquals:
                'ecs:cluster':
                  'Fn::GetAtt':
                    - testclusterDBD4D436
                    - Arn
            Effect: Allow
            Resource: '*'
            Sid: ECSListTasks
          - Action: 'ecs:DescribeTasks'
            Condition:
              StringEquals:
                'ecs:cluster':
                  'Fn::GetAtt':
                    - testclusterDBD4D436
                    - Arn
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'arn:'
                  - Ref: 'AWS::Partition'
                  - ':ecs:'
                  - Ref: 'AWS::Region'
                  - ':'
                  - Ref: 'AWS::AccountId'
                  - ':task/'
                  - Ref: testclusterDBD4D436
                  - /*
            Sid: ECSDescribeTasks
          - Action: 'ecs:DescribeServices'
            Condition:
              StringEquals:
                'ecs:cluster':
                  'Fn::GetAtt':
                    - testclusterDBD4D436
                    - Arn
            Effect: Allow
            Resource:
              - Ref: testcontrollerserviceService356186D6
              - Ref: teststatelessserviceService5CDEA5F0
            Sid: ECSDescribeServices
          - Action: 'cloudwatch:GetMetricData'
            Effect: Allow
            Resource: '*'
            Sid: CloudWatchReadActions
        Version: '2012-10-17'
      PolicyName: testcloudwatchcustomwidgetexecutionroleDefaultPolicy4D8EC73B
      Roles:
        - Ref: testcloudwatchcustomwidgetexecutionrole72F32199
  testcloudwatchcustomwidgetlambdaB0DB8C59:
    Type: 'AWS::Lambda::Function'
    Properties:
      Architectures:
        - arm64
      Code: Any<Object>
      Environment:
        Variables:
          ENABLE_EBS_VOLUMES: 'false'
      Handler: index.handler
      LoggingConfig:
        LogGroup:
          Ref: testcloudwatchcustomwidgetloggroupEBFA438D
      MemorySize: 1024
      Role:
        'Fn::GetAtt':
          - testcloudwatchcustomwidgetexecutionrole72F32199
          - Arn
      Runtime: nodejs22.x
      Tags:
        - Key: Name
          Value: RestateBYOC/test/cloudwatch-custom-widget-lambda
      Timeout: 60
    DependsOn:
      - testcloudwatchcustomwidgetexecutionroleDefaultPolicy4D8EC73B
      - testcloudwatchcustomwidgetexecutionrole72F32199
  testcloudwatchcustomwidgetlambdacloudwatchcustomwidgetlambdaallowdatasource06DF513A:
    Type: 'AWS::Lambda::Permission'
    Properties:
      Action: 'lambda:InvokeFunction'
      FunctionName:
        'Fn::GetAtt':
          - testcloudwatchcustomwidgetlambdaB0DB8C59
          - Arn
      Principal: lambda.datasource.cloudwatch.amazonaws.com
  testmetricsAAAB7FF4:
    Type: 'AWS::CloudWatch::Dashboard'
    Properties:
      DashboardBody:
        'Fn::Join':
          - ''
          - - >-
              {"widgets":[{"type":"metric","width":12,"height":6,"x":0,"y":0,"properties":{"view":"timeSeries","title":"Stateless
              CPU","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"CPU","expression":"SELECT AVG(CpuUtilized)
              FROM SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOCteststatelessdefinitionA59C4856' GROUP BY
              TaskId"}]],"annotations":{"horizontal":[{"value":16384,"label":"Limit","yAxis":"left"}]},"yAxis":{"left":{"label":"vCPUs","showUnits":false}}}},{"type":"metric","width":12,"height":6,"x":12,"y":0,"properties":{"view":"timeSeries","title":"Stateless
              Memory","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Memory","expression":"SELECT
              AVG(MemoryUtilized) FROM SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOCteststatelessdefinitionA59C4856' GROUP BY
              TaskId"}]],"annotations":{"horizontal":[{"value":32768,"label":"Limit","yAxis":"left"}]},"yAxis":{"left":{"label":"MiB","showUnits":false}}}},{"type":"metric","width":12,"height":6,"x":0,"y":6,"properties":{"view":"timeSeries","title":"Stateless
              Network Tx","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Tx","expression":"SELECT
              AVG(NetworkTxBytes) FROM SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOCteststatelessdefinitionA59C4856' GROUP BY
              TaskId"}]],"yAxis":{"left":{"label":"Bytes/sec","showUnits":false}}}},{"type":"metric","width":12,"height":6,"x":12,"y":6,"properties":{"view":"timeSeries","title":"Stateless
              Network Rx","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Rx","expression":"SELECT
              AVG(NetworkRxBytes) FROM SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOCteststatelessdefinitionA59C4856' GROUP BY
              TaskId"}]],"yAxis":{"left":{"label":"Bytes/sec","showUnits":false}}}},{"type":"log","width":24,"height":6,"x":0,"y":12,"properties":{"view":"table","title":"Stateless
              Logs","region":"region","query":"SOURCE '
            - Ref: testrestateloggroup6C0DD0DD
            - >-
              ' | fields @logStream, @timestamp, level, fields.message,
              target\\n          | sort @timestamp desc\\n          | limit
              500"}},{"type":"metric","width":12,"height":6,"x":0,"y":18,"properties":{"view":"timeSeries","title":"Stateful
              CPU","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"CPU","expression":"SELECT AVG(CpuUtilized)
              FROM SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily = 'RestateBYOCteststatefuldefinition9B15D9BA'
              GROUP BY
              TaskId"}]],"annotations":{"horizontal":[{"value":16384,"label":"Limit","yAxis":"left"}]},"yAxis":{"left":{"label":"vCPUs","showUnits":false}}}},{"type":"metric","width":12,"height":6,"x":12,"y":18,"properties":{"view":"timeSeries","title":"Stateful
              Memory","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Memory","expression":"SELECT
              AVG(MemoryUtilized) FROM SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily = 'RestateBYOCteststatefuldefinition9B15D9BA'
              GROUP BY
              TaskId"}]],"annotations":{"horizontal":[{"value":32768,"label":"Limit","yAxis":"left"}]},"yAxis":{"left":{"label":"MiB","showUnits":false}}}},{"type":"metric","width":12,"height":6,"x":0,"y":24,"properties":{"view":"timeSeries","title":"Stateful
              Network Tx","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Tx","expression":"SELECT
              AVG(NetworkTxBytes) FROM SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily = 'RestateBYOCteststatefuldefinition9B15D9BA'
              GROUP BY
              TaskId"}]],"yAxis":{"left":{"label":"Bytes/sec","showUnits":false}}}},{"type":"metric","width":12,"height":6,"x":12,"y":24,"properties":{"view":"timeSeries","title":"Stateful
              Network Rx","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Rx","expression":"SELECT
              AVG(NetworkRxBytes) FROM SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily = 'RestateBYOCteststatefuldefinition9B15D9BA'
              GROUP BY
              TaskId"}]],"yAxis":{"left":{"label":"Bytes/sec","showUnits":false}}}},{"type":"log","width":24,"height":6,"x":0,"y":30,"properties":{"view":"table","title":"Stateful
              Logs","region":"region","query":"SOURCE '
            - Ref: testrestateloggroup6C0DD0DD
            - >-
              ' | fields @logStream, @timestamp, level, fields.message,
              target\\n          | sort @timestamp desc\\n          | limit
              500"}},{"type":"metric","width":8,"height":6,"x":0,"y":36,"properties":{"view":"timeSeries","title":"Ephemeral
              Volume Usage (Total size 200GiB)","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Usage","expression":"SELECT
              MAX(EphemeralStorageUtilized) FROM
              SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily) WHERE TaskDefinitionFamily =
              'RestateBYOCteststatefuldefinition9B15D9BA'"}]],"annotations":{"horizontal":[{"value":200,"label":"Volume
              size","visible":false,"yAxis":"left"}]},"yAxis":{"left":{"label":"GiB","showUnits":false}},"liveData":false}},{"type":"metric","width":8,"height":6,"x":8,"y":36,"properties":{"view":"timeSeries","title":"Volume
              Write Throughput (Limited to 150 MiB/sec)","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Write","expression":"RATE(count) /
              1048576"}],[{"expression":"SELECT MAX(StorageWriteBytes) FROM
              SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily = 'RestateBYOCteststatefuldefinition9B15D9BA'
              GROUP BY
              TaskId","visible":false,"id":"count"}]],"annotations":{"horizontal":[{"value":150,"label":"Limit","visible":false,"yAxis":"left"}]},"yAxis":{"left":{"label":"MiB/sec","showUnits":false}}}},{"type":"metric","width":8,"height":6,"x":16,"y":36,"properties":{"view":"timeSeries","title":"Volume
              Read Throughput (Limited to 150 MiB/sec)","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Read","expression":"RATE(count) /
              1048576"}],[{"expression":"SELECT MAX(StorageReadBytes) FROM
              SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily = 'RestateBYOCteststatefuldefinition9B15D9BA'
              GROUP BY
              TaskId","visible":false,"id":"count"}]],"annotations":{"horizontal":[{"value":150,"label":"Limit","visible":false,"yAxis":"left"}]},"yAxis":{"left":{"label":"MiB/sec","showUnits":false}}}},{"type":"log","width":24,"height":6,"x":0,"y":42,"properties":{"view":"table","title":"Controller
              Logs","region":"region","query":"SOURCE '
            - Ref: testcontrollerloggroupB61E47AC
            - >-
              ' | fields @logStream, @timestamp, level, fields.message,
              target\\n          | sort @timestamp desc\\n          | limit
              500"}}]}
      DashboardName: RestateBYOC_test_metrics
  testcontrolpanel0D5F1B33:
    Type: 'AWS::CloudWatch::Dashboard'
    Properties:
      DashboardBody:
        'Fn::Join':
          - ''
          - - >-
              {"widgets":[{"type":"custom","width":24,"height":26,"x":0,"y":0,"properties":{"endpoint":"
            - 'Fn::GetAtt':
                - testcloudwatchcustomwidgetlambdaB0DB8C59
                - Arn
            - '","params":{"command":"controlPanel","input":{"region":"'
            - Ref: 'AWS::Region'
            - >-
              ","summary":{"clusterName":"RestateBYOC/test","restateVersion":"1.4","stackVersion":"0.4.1-dev","metricsDashboardName":"
            - Ref: testmetricsAAAB7FF4
            - '"},"resources":{"ecsClusterArn":"'
            - 'Fn::GetAtt':
                - testclusterDBD4D436
                - Arn
            - '","statelessServiceArn":"'
            - Ref: teststatelessserviceService5CDEA5F0
            - '","controllerServiceArn":"'
            - Ref: testcontrollerserviceService356186D6
            - '","restatectlLambdaArn":"'
            - 'Fn::GetAtt':
                - testrestatectllambda6F1900FA
                - Arn
            - >-
              "},"connectivityAndSecurity":{"connectivity":{"loadBalancerArns":{"ingress":["
            - Ref: testsharednlb6BC10CBB
            - '"],"admin":["'
            - Ref: testsharednlb6BC10CBB
            - '"]},"addresses":{"ingress":"http://'
            - 'Fn::GetAtt':
                - testsharednlb6BC10CBB
                - DNSName
            - ':8080","admin":"http://'
            - 'Fn::GetAtt':
                - testsharednlb6BC10CBB
                - DNSName
            - ':9070","webUI":"http://'
            - 'Fn::GetAtt':
                - testsharednlb6BC10CBB
                - DNSName
            - ':9070/ui"}},"networking":{"vpc":"'
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcA2121C384D1B3CDE'
            - '","availabilityZones":["dummy1a","dummy1b","dummy1c"],"subnets":["'
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet1Subnet934893E8236E2271'
            - '","'
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet2Subnet7031C2BA60DCB1EE'
            - '","'
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet3Subnet985AC459F9514491'
            - '"]},"security":{"securityGroups":["'
            - 'Fn::GetAtt':
                - testsecuritygroupB015C031
                - GroupId
            - '"]}},"storage":{"s3":{"bucket":"'
            - Ref: testbucket731B7DE2
            - >-
              "}}}},"title":"","updateOn":{"refresh":true,"resize":true,"timeRange":true}}}]}
      DashboardName: RestateBYOC_test_control-panel
  testadminapplicationtarget365AC38B:
    Type: 'AWS::ElasticLoadBalancingV2::TargetGroup'
    Properties:
      HealthCheckEnabled: true
      HealthCheckIntervalSeconds: 5
      HealthCheckPath: /health
      HealthCheckPort: '9070'
      HealthCheckProtocol: HTTP
      HealthCheckTimeoutSeconds: 2
      Port: 9070
      Protocol: HTTP
      Tags:
        - Key: Name
          Value: RestateBYOC/test/admin-application-target
      TargetGroupAttributes:
        - Key: stickiness.enabled
          Value: 'false'
      TargetType: ip
      VpcId:
        'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcA2121C384D1B3CDE'
  albaccesslogsFDEBFEC7:
    Type: 'AWS::S3::Bucket'
    Properties:
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      LifecycleConfiguration:
        Rules:
          - ExpirationInDays: 1825
            Status: Enabled
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
    UpdateReplacePolicy: Retain
    DeletionPolicy: Retain
  albaccesslogsPolicyE2B747DA:
    Type: 'AWS::S3::BucketPolicy'
    Properties:
      Bucket:
        Ref: albaccesslogsFDEBFEC7
      PolicyDocument:
        Statement:
          - Action: 's3:*'
            Condition:
              Bool:
                'aws:SecureTransport': 'false'
            Effect: Deny
            Principal:
              AWS: '*'
            Resource:
              - 'Fn::GetAtt':
                  - albaccesslogsFDEBFEC7
                  - Arn
              - 'Fn::Join':
                  - ''
                  - - 'Fn::GetAtt':
                        - albaccesslogsFDEBFEC7
                        - Arn
                    - /*
          - Action: 's3:PutObject'
            Effect: Allow
            Principal:
              Service: logdelivery.elasticloadbalancing.amazonaws.com
            Resource:
              'Fn::Join':
                - ''
                - - 'Fn::GetAtt':
                      - albaccesslogsFDEBFEC7
                      - Arn
                  - /admin-alb/AWSLogs/account-id/*
          - Action: 's3:PutObject'
            Condition:
              StringEquals:
                's3:x-amz-acl': bucket-owner-full-control
            Effect: Allow
            Principal:
              Service: delivery.logs.amazonaws.com
            Resource:
              'Fn::Join':
                - ''
                - - 'Fn::GetAtt':
                      - albaccesslogsFDEBFEC7
                      - Arn
                  - /admin-alb/AWSLogs/account-id/*
          - Action: 's3:GetBucketAcl'
            Effect: Allow
            Principal:
              Service: delivery.logs.amazonaws.com
            Resource:
              'Fn::GetAtt':
                - albaccesslogsFDEBFEC7
                - Arn
        Version: '2012-10-17'
  adminalb890E7B06:
    Type: 'AWS::ElasticLoadBalancingV2::LoadBalancer'
    Properties:
      LoadBalancerAttributes:
        - Key: deletion_protection.enabled
          Value: 'false'
        - Key: access_logs.s3.enabled
          Value: 'true'
        - Key: access_logs.s3.bucket
          Value:
            Ref: albaccesslogsFDEBFEC7
        - Key: access_logs.s3.prefix
          Value: admin-alb
      Scheme: internet-facing
      SecurityGroups:
        - 'Fn::GetAtt':
            - adminalbSecurityGroup85AF9130
            - GroupId
      Subnets:
        - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPublicSubnet1Subnet2E65531ECCB85041'
        - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPublicSubnet2Subnet009B674FB900C242'
        - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPublicSubnet3Subnet11B92D7C8409C46F'
      Type: application
    DependsOn:
      - albaccesslogsPolicyE2B747DA
  adminalbSecurityGroup85AF9130:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      GroupDescription: Automatically created Security Group for ELB RestateBYOCadminalb8A992992
      SecurityGroupEgress:
        - CidrIp: 0.0.0.0/0
          Description: Allow to IdP endpoint
          FromPort: 443
          IpProtocol: tcp
          ToPort: 443
      SecurityGroupIngress:
        - CidrIp: 0.0.0.0/0
          Description: Allow from anyone on port 443
          FromPort: 443
          IpProtocol: tcp
          ToPort: 443
      VpcId:
        'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcA2121C384D1B3CDE'
  adminalbSecurityGrouptoRestateBYOCtestsecuritygroupDC099EC29070C2154502:
    Type: 'AWS::EC2::SecurityGroupEgress'
    Properties:
      Description: Load balancer to target
      DestinationSecurityGroupId:
        'Fn::GetAtt':
          - testsecuritygroupB015C031
          - GroupId
      FromPort: 9070
      GroupId:
        'Fn::GetAtt':
          - adminalbSecurityGroup85AF9130
          - GroupId
      IpProtocol: tcp
      ToPort: 9070
  adminalbadminlistenerF7D4D12B:
    Type: 'AWS::ElasticLoadBalancingV2::Listener'
    Properties:
      Certificates:
        - CertificateArn: 'arn:aws:acm:region:account-id:certificate/admin-cert-id'
      DefaultActions:
        - AuthenticateOidcConfig:
            AuthorizationEndpoint: 'https://accounts.google.com/o/oauth2/v2/auth'
            ClientId: client-id-from-google-cloud-console
            ClientSecret: >-
              {{resolve:secretsmanager:restate-google-sso-client-secret:SecretString:::}}
            Issuer: 'https://accounts.google.com'
            TokenEndpoint: 'https://oauth2.googleapis.com/token'
            UserInfoEndpoint: 'https://openidconnect.googleapis.com/v1/userinfo'
          Order: 1
          Type: authenticate-oidc
        - Order: 2
          TargetGroupArn:
            Ref: testadminapplicationtarget365AC38B
          Type: forward
      LoadBalancerArn:
        Ref: adminalb890E7B06
      Port: 443
      Protocol: HTTPS
Outputs:
  testSecurityGroups50C338D1:
    Description: The security group IDs of the cluster
    Value:
      'Fn::GetAtt':
        - testsecuritygroupB015C031
        - GroupId
  testIngressNetworkListenerA459AD14:
    Description: The ARN of the network listener for the ingress port
    Value:
      Ref: testingresssharedlistenerF18D3E56
  testIngressNetworkTargetGroup73857B83:
    Description: The ARN of the network target group for the ingress port
    Value:
      Ref: testingresssharedtarget779E3570
  testAdminNetworkListener840296BA:
    Description: The ARN of the network listener for the admin port
    Value:
      Ref: testadminsharedlistener6D147D79
  testAdminNetworkTargetGroup1541C506:
    Description: The ARN of the network target group for the admin port
    Value:
      Ref: testadminsharedtarget0C095FA8
  testNodeNetworkListener743144A9:
    Description: The ARN of the network listener for the node port
    Value:
      Ref: testnodesharedlistener98A38BFD
  testNodeNetworkTargetGroup76D5EEBA:
    Description: The ARN of the network target group for the node port
    Value:
      Ref: testnodesharedtarget6337BC22
  testAdminApplicationTargetGroup42EB955D:
    Description: The ARN of the application target group for the admin port
    Value:
      Ref: testadminapplicationtarget365AC38B
"
`;

exports[`BYOC Task log driver mode can be customized 1`] = `
"Resources:
  customrestatelogsABA15428:
    Type: 'AWS::Logs::LogGroup'
    Properties:
      RetentionInDays: 7
    UpdateReplacePolicy: Retain
    DeletionPolicy: Retain
  customcontrollerlogs5262F813:
    Type: 'AWS::Logs::LogGroup'
    Properties:
      RetentionInDays: 7
    UpdateReplacePolicy: Retain
    DeletionPolicy: Retain
  testsecuritygroupB015C031:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      GroupDescription: RestateBYOC/test/security-group
      SecurityGroupEgress:
        - CidrIp: 0.0.0.0/0
          Description: Allow all outbound traffic by default
          IpProtocol: '-1'
      Tags:
        - Key: Name
          Value: RestateBYOC/test/security-group
      VpcId:
        'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcA2121C384D1B3CDE'
  testsecuritygroupfromRestateBYOCtestsecuritygroupDC099EC280804D6652A7:
    Type: 'AWS::EC2::SecurityGroupIngress'
    Properties:
      Description: 'from RestateBYOCtestsecuritygroupDC099EC2:8080'
      FromPort: 8080
      GroupId:
        'Fn::GetAtt':
          - testsecuritygroupB015C031
          - GroupId
      IpProtocol: tcp
      SourceSecurityGroupId:
        'Fn::GetAtt':
          - testsecuritygroupB015C031
          - GroupId
      ToPort: 8080
  testsecuritygroupfromRestateBYOCtestsecuritygroupDC099EC2907024D2BE0B:
    Type: 'AWS::EC2::SecurityGroupIngress'
    Properties:
      Description: 'from RestateBYOCtestsecuritygroupDC099EC2:9070'
      FromPort: 9070
      GroupId:
        'Fn::GetAtt':
          - testsecuritygroupB015C031
          - GroupId
      IpProtocol: tcp
      SourceSecurityGroupId:
        'Fn::GetAtt':
          - testsecuritygroupB015C031
          - GroupId
      ToPort: 9070
  testsecuritygroupfromRestateBYOCtestsecuritygroupDC099EC25122D07222D4:
    Type: 'AWS::EC2::SecurityGroupIngress'
    Properties:
      Description: 'from RestateBYOCtestsecuritygroupDC099EC2:5122'
      FromPort: 5122
      GroupId:
        'Fn::GetAtt':
          - testsecuritygroupB015C031
          - GroupId
      IpProtocol: tcp
      SourceSecurityGroupId:
        'Fn::GetAtt':
          - testsecuritygroupB015C031
          - GroupId
      ToPort: 5122
  testbucket731B7DE2:
    Type: 'AWS::S3::Bucket'
    Properties:
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
    UpdateReplacePolicy: Retain
    DeletionPolicy: Retain
  testbucketPolicyB4FDDA54:
    Type: 'AWS::S3::BucketPolicy'
    Properties:
      Bucket:
        Ref: testbucket731B7DE2
      PolicyDocument:
        Statement:
          - Action: 's3:*'
            Condition:
              Bool:
                'aws:SecureTransport': 'false'
            Effect: Deny
            Principal:
              AWS: '*'
            Resource:
              - 'Fn::GetAtt':
                  - testbucket731B7DE2
                  - Arn
              - 'Fn::Join':
                  - ''
                  - - 'Fn::GetAtt':
                        - testbucket731B7DE2
                        - Arn
                    - /*
        Version: '2012-10-17'
  testclusterDBD4D436:
    Type: 'AWS::ECS::Cluster'
    Properties:
      ClusterSettings:
        - Name: containerInsights
          Value: enhanced
      Tags:
        - Key: Name
          Value: RestateBYOC/test/cluster
  testrestatetaskrole4CC243A3:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
        Version: '2012-10-17'
  testrestatetaskroleDefaultPolicy51A222FD:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 's3:GetObject'
              - 's3:PutObject'
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'Fn::GetAtt':
                      - testbucket731B7DE2
                      - Arn
                  - /*
            Sid: ReadWriteBucket
          - Action: 's3:ListBucket'
            Effect: Allow
            Resource:
              'Fn::GetAtt':
                - testbucket731B7DE2
                - Arn
            Sid: ListBucket
        Version: '2012-10-17'
      PolicyName: testrestatetaskroleDefaultPolicy51A222FD
      Roles:
        - Ref: testrestatetaskrole4CC243A3
  testrestateexecutionrole4CD7F161:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
        Version: '2012-10-17'
  testrestateexecutionroleDefaultPolicy04DC59EF:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 'logs:CreateLogStream'
              - 'logs:PutLogEvents'
            Effect: Allow
            Resource:
              'Fn::GetAtt':
                - customrestatelogsABA15428
                - Arn
        Version: '2012-10-17'
      PolicyName: testrestateexecutionroleDefaultPolicy04DC59EF
      Roles:
        - Ref: testrestateexecutionrole4CD7F161
  testrestateloggroup6C0DD0DD:
    Type: 'AWS::Logs::LogGroup'
    Properties:
      RetentionInDays: 30
    UpdateReplacePolicy: Retain
    DeletionPolicy: Retain
  testcontrollerloggroupB61E47AC:
    Type: 'AWS::Logs::LogGroup'
    Properties:
      RetentionInDays: 30
    UpdateReplacePolicy: Retain
    DeletionPolicy: Retain
  testsharednlb6BC10CBB:
    Type: 'AWS::ElasticLoadBalancingV2::LoadBalancer'
    Properties:
      LoadBalancerAttributes:
        - Key: deletion_protection.enabled
          Value: 'false'
        - Key: load_balancing.cross_zone.enabled
          Value: 'false'
        - Key: dns_record.client_routing_policy
          Value: availability_zone_affinity
      Scheme: internal
      SecurityGroups:
        - 'Fn::GetAtt':
            - testsecuritygroupB015C031
            - GroupId
      Subnets:
        - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet1Subnet934893E8236E2271'
        - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet2Subnet7031C2BA60DCB1EE'
        - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet3Subnet985AC459F9514491'
      Tags:
        - Key: Name
          Value: RestateBYOC/test/shared-nlb
      Type: network
  testingresssharedlistenerF18D3E56:
    Type: 'AWS::ElasticLoadBalancingV2::Listener'
    Properties:
      DefaultActions:
        - TargetGroupArn:
            Ref: testingresssharedtarget779E3570
          Type: forward
      LoadBalancerArn:
        Ref: testsharednlb6BC10CBB
      Port: 8080
      Protocol: TCP
  testadminsharedlistener6D147D79:
    Type: 'AWS::ElasticLoadBalancingV2::Listener'
    Properties:
      DefaultActions:
        - TargetGroupArn:
            Ref: testadminsharedtarget0C095FA8
          Type: forward
      LoadBalancerArn:
        Ref: testsharednlb6BC10CBB
      Port: 9070
      Protocol: TCP
  testnodesharedlistener98A38BFD:
    Type: 'AWS::ElasticLoadBalancingV2::Listener'
    Properties:
      DefaultActions:
        - TargetGroupArn:
            Ref: testnodesharedtarget6337BC22
          Type: forward
      LoadBalancerArn:
        Ref: testsharednlb6BC10CBB
      Port: 5122
      Protocol: TCP
  teststatelessdefinition64DABAD1:
    Type: 'AWS::ECS::TaskDefinition'
    Properties:
      ContainerDefinitions:
        - Cpu: 16384
          EntryPoint:
            - bash
            - '-c'
            - >

              curl --no-progress-meter $ECS_CONTAINER_METADATA_URI_V4 -o
              container-metadata && \\

              curl --no-progress-meter $ECS_CONTAINER_METADATA_URI_V4/task -o
              task-metadata && \\

              export \\
                RESTATE_NODE_NAME=$(jq -r '.TaskARN' task-metadata) \\
                RESTATE_LOCATION="$AWS_REGION.$(jq -r '.AvailabilityZone' task-metadata)" \\
                RESTATE_ADVERTISED_ADDRESS="http://$(jq -r '.Networks[0].IPv4Addresses[0]' container-metadata):5122"
              exec restate-server
          Environment:
            - Name: RESTATE_LOG_FORMAT
              Value: json
            - Name: RESTATE_CLUSTER_NAME
              Value: RestateBYOC/test
            - Name: RESTATE_ROLES
              Value: '["admin","http-ingress"]'
            - Name: RESTATE_AUTO_PROVISION
              Value: 'true'
            - Name: RESTATE_SHUTDOWN_TIMEOUT
              Value: 100s
            - Name: RESTATE_DEFAULT_NUM_PARTITIONS
              Value: '128'
            - Name: RESTATE_DEFAULT_REPLICATION
              Value: '{zone: 2}'
            - Name: RESTATE_METADATA_CLIENT__TYPE
              Value: object-store
            - Name: RESTATE_METADATA_CLIENT__PATH
              Value:
                'Fn::Join':
                  - ''
                  - - 's3://'
                    - Ref: testbucket731B7DE2
                    - /metadata
            - Name: RESTATE_BIFROST__DEFAULT_PROVIDER
              Value: replicated
            - Name: >-
                RESTATE_INGRESS__EXPERIMENTAL_FEATURE_ENABLE_SEPARATE_INGRESS_ROLE
              Value: 'true'
            - Name: RESTATE_INGRESS__ADVERTISED_INGRESS_ENDPOINT
              Value:
                'Fn::Join':
                  - ''
                  - - 'http://'
                    - 'Fn::GetAtt':
                        - testsharednlb6BC10CBB
                        - DNSName
                    - ':8080'
            - Name: RESTATE_WORKER__SNAPSHOTS__DESTINATION
              Value:
                'Fn::Join':
                  - ''
                  - - 's3://'
                    - Ref: testbucket731B7DE2
                    - /snapshots
          Essential: true
          HealthCheck:
            Command:
              - CMD
              - curl
              - '--fail'
              - 'http://127.0.0.1:8080/restate/health'
            Interval: 30
            Retries: 3
            Timeout: 5
          Image: Any<Object>
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group:
                Ref: customrestatelogsABA15428
              awslogs-stream-prefix: restate
              awslogs-region: region
              mode: non-blocking
              max-buffer-size: 5242880b
          Memory: 32768
          Name: restate
          PortMappings:
            - ContainerPort: 8080
              Name: ingress
              Protocol: tcp
            - ContainerPort: 9070
              Name: admin
              Protocol: tcp
            - ContainerPort: 5122
              Name: node
              Protocol: tcp
          StopTimeout: 120
      Cpu: '16384'
      ExecutionRoleArn:
        'Fn::GetAtt':
          - testrestateexecutionrole4CD7F161
          - Arn
      Family: RestateBYOCteststatelessdefinitionA59C4856
      Memory: '32768'
      NetworkMode: awsvpc
      RequiresCompatibilities:
        - FARGATE
      RuntimePlatform:
        CpuArchitecture: ARM64
        OperatingSystemFamily: LINUX
      Tags:
        - Key: Name
          Value: RestateBYOC/test/stateless-definition
      TaskRoleArn:
        'Fn::GetAtt':
          - testrestatetaskrole4CC243A3
          - Arn
  teststatelessserviceService5CDEA5F0:
    Type: 'AWS::ECS::Service'
    Properties:
      AvailabilityZoneRebalancing: ENABLED
      Cluster:
        Ref: testclusterDBD4D436
      DeploymentConfiguration:
        Alarms:
          AlarmNames: []
          Enable: false
          Rollback: false
        MaximumPercent: 200
        MinimumHealthyPercent: 100
      DeploymentController:
        Type: ECS
      DesiredCount: 3
      EnableECSManagedTags: false
      EnableExecuteCommand: false
      HealthCheckGracePeriodSeconds: 60
      LaunchType: FARGATE
      LoadBalancers:
        - ContainerName: restate
          ContainerPort: 8080
          TargetGroupArn:
            Ref: testingresssharedtarget779E3570
        - ContainerName: restate
          ContainerPort: 9070
          TargetGroupArn:
            Ref: testadminsharedtarget0C095FA8
        - ContainerName: restate
          ContainerPort: 5122
          TargetGroupArn:
            Ref: testnodesharedtarget6337BC22
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: DISABLED
          SecurityGroups:
            - 'Fn::GetAtt':
                - testsecuritygroupB015C031
                - GroupId
          Subnets:
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet1Subnet934893E8236E2271'
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet2Subnet7031C2BA60DCB1EE'
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet3Subnet985AC459F9514491'
      PropagateTags: SERVICE
      Tags:
        - Key: Name
          Value: RestateBYOC/test/stateless-service
      TaskDefinition:
        Ref: teststatelessdefinition64DABAD1
    DependsOn:
      - testadminsharedlistener6D147D79
      - testingresssharedlistenerF18D3E56
      - testnodesharedlistener98A38BFD
      - testrestatetaskroleDefaultPolicy51A222FD
      - testrestatetaskrole4CC243A3
  teststatefuldefinitionB92BAA14:
    Type: 'AWS::ECS::TaskDefinition'
    Properties:
      ContainerDefinitions:
        - Cpu: 16384
          EntryPoint:
            - bash
            - '-c'
            - >

              curl --no-progress-meter $ECS_CONTAINER_METADATA_URI_V4 -o
              container-metadata && \\

              curl --no-progress-meter $ECS_CONTAINER_METADATA_URI_V4/task -o
              task-metadata && \\

              export \\
                RESTATE_NODE_NAME=$(jq -r '.TaskARN' task-metadata) \\
                RESTATE_LOCATION="$AWS_REGION.$(jq -r '.AvailabilityZone' task-metadata)" \\
                RESTATE_ADVERTISED_ADDRESS="http://$(jq -r '.Networks[0].IPv4Addresses[0]' container-metadata):5122" \\
                RESTATE_ROCKSDB_TOTAL_MEMORY_SIZE="$(($(jq -r '.Limits.Memory' container-metadata) * 3 / 4))MiB" \\
                RESTATE_WORKER__STORAGE__NUM_PARTITIONS_TO_SHARE_MEMORY_BUDGET=$(("$RESTATE_WORKER__STORAGE__NUM_PARTITIONS_TO_SHARE_MEMORY_BUDGET"))
              exec restate-server
          Environment:
            - Name: RESTATE_LOG_FORMAT
              Value: json
            - Name: RESTATE_CLUSTER_NAME
              Value: RestateBYOC/test
            - Name: RESTATE_ROLES
              Value: '["log-server", "worker"]'
            - Name: RESTATE_AUTO_PROVISION
              Value: 'false'
            - Name: RESTATE_SHUTDOWN_TIMEOUT
              Value: 100s
            - Name: RESTATE_METADATA_CLIENT__TYPE
              Value: object-store
            - Name: RESTATE_METADATA_CLIENT__PATH
              Value:
                'Fn::Join':
                  - ''
                  - - 's3://'
                    - Ref: testbucket731B7DE2
                    - /metadata
            - Name: RESTATE_WORKER__SNAPSHOTS__DESTINATION
              Value:
                'Fn::Join':
                  - ''
                  - - 's3://'
                    - Ref: testbucket731B7DE2
                    - /snapshots
            - Name: RESTATE_WORKER__SNAPSHOTS__SNAPSHOT_INTERVAL_NUM_RECORDS
              Value: '1000000'
            - Name: RESTATE_WORKER__STORAGE__ROCKSDB_DISABLE_DIRECT_IO_FOR_READS
              Value: 'true'
            - Name: RESTATE_WORKER__STORAGE__ROCKSDB_DISABLE_WAL_FSYNC
              Value: 'true'
            - Name: RESTATE_WORKER__STORAGE__NUM_PARTITIONS_TO_SHARE_MEMORY_BUDGET
              Value: (128 * 2) / (3 * 1)
            - Name: RESTATE_LOG_SERVER__ROCKSDB_DISABLE_WAL_FSYNC
              Value: 'true'
            - Name: RESTATE_LOG_SERVER__ROCKSDB_DISABLE_DIRECT_IO_FOR_READS
              Value: 'true'
            - Name: >-
                RESTATE_INGRESS__EXPERIMENTAL_FEATURE_ENABLE_SEPARATE_INGRESS_ROLE
              Value: 'true'
          Essential: true
          HealthCheck:
            Command:
              - CMD
              - curl
              - '--fail'
              - 'http://127.0.0.1:5122/health'
            Interval: 30
            Retries: 3
            Timeout: 5
          Image: Any<Object>
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group:
                Ref: customrestatelogsABA15428
              awslogs-stream-prefix: restate
              awslogs-region: region
              mode: non-blocking
              max-buffer-size: 5242880b
          Memory: 32768
          MountPoints:
            - ContainerPath: /restate-data
              ReadOnly: false
              SourceVolume: restate-data
          Name: restate
          PortMappings:
            - ContainerPort: 5122
              Name: node
              Protocol: tcp
          RestartPolicy:
            Enabled: true
            RestartAttemptPeriod: 60
          StopTimeout: 120
      Cpu: '16384'
      EphemeralStorage:
        SizeInGiB: 200
      ExecutionRoleArn:
        'Fn::GetAtt':
          - testrestateexecutionrole4CD7F161
          - Arn
      Family: RestateBYOCteststatefuldefinition9B15D9BA
      Memory: '32768'
      NetworkMode: awsvpc
      RequiresCompatibilities:
        - FARGATE
      RuntimePlatform:
        CpuArchitecture: ARM64
        OperatingSystemFamily: LINUX
      Tags:
        - Key: Name
          Value: RestateBYOC/test/stateful-definition
      TaskRoleArn:
        'Fn::GetAtt':
          - testrestatetaskrole4CC243A3
          - Arn
      Volumes:
        - ConfiguredAtLaunch: false
          Name: restate-data
  testingresssharedtarget779E3570:
    Type: 'AWS::ElasticLoadBalancingV2::TargetGroup'
    Properties:
      HealthCheckEnabled: true
      HealthCheckIntervalSeconds: 5
      HealthCheckPath: /restate/health
      HealthCheckProtocol: HTTP
      HealthCheckTimeoutSeconds: 2
      Port: 8080
      Protocol: TCP
      Tags:
        - Key: Name
          Value: RestateBYOC/test/ingress-shared-target
      TargetType: ip
      VpcId:
        'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcA2121C384D1B3CDE'
  testadminsharedtarget0C095FA8:
    Type: 'AWS::ElasticLoadBalancingV2::TargetGroup'
    Properties:
      HealthCheckEnabled: true
      HealthCheckIntervalSeconds: 5
      HealthCheckPath: /health
      HealthCheckPort: '9070'
      HealthCheckProtocol: HTTP
      HealthCheckTimeoutSeconds: 2
      Port: 9070
      Protocol: TCP
      Tags:
        - Key: Name
          Value: RestateBYOC/test/admin-shared-target
      TargetType: ip
      VpcId:
        'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcA2121C384D1B3CDE'
  testnodesharedtarget6337BC22:
    Type: 'AWS::ElasticLoadBalancingV2::TargetGroup'
    Properties:
      HealthCheckEnabled: true
      HealthCheckIntervalSeconds: 5
      HealthCheckPath: /health
      HealthCheckPort: '5122'
      HealthCheckProtocol: HTTP
      HealthCheckTimeoutSeconds: 2
      Port: 5122
      Protocol: TCP
      Tags:
        - Key: Name
          Value: RestateBYOC/test/node-shared-target
      TargetType: ip
      VpcId:
        'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcA2121C384D1B3CDE'
  testcontrollertaskrole42417C6E:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
        Version: '2012-10-17'
  testcontrollertaskroleDefaultPolicy030D6236:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action: 'ecs:ListTasks'
            Condition:
              ArnEquals:
                'ecs:cluster':
                  'Fn::GetAtt':
                    - testclusterDBD4D436
                    - Arn
            Effect: Allow
            Resource: '*'
            Sid: ECSListActions
          - Action:
              - 'ecs:TagResource'
              - 'ecs:DescribeTasks'
              - 'ecs:StopTask'
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'Fn::Join':
                      - /
                      - - 'Fn::Join':
                            - ':'
                            - - 'Fn::Select':
                                  - 0
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - testclusterDBD4D436
                                                  - Arn
                              - 'Fn::Select':
                                  - 1
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - testclusterDBD4D436
                                                  - Arn
                              - 'Fn::Select':
                                  - 2
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - testclusterDBD4D436
                                                  - Arn
                              - 'Fn::Select':
                                  - 3
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - testclusterDBD4D436
                                                  - Arn
                              - 'Fn::Select':
                                  - 4
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - testclusterDBD4D436
                                                  - Arn
                              - task
                        - 'Fn::Select':
                            - 1
                            - 'Fn::Split':
                                - /
                                - 'Fn::GetAtt':
                                    - testclusterDBD4D436
                                    - Arn
                        - ''
                  - '*'
            Sid: TaskActions
          - Action: 'ecs:RunTask'
            Condition:
              ArnEquals:
                'ecs:cluster':
                  'Fn::GetAtt':
                    - testclusterDBD4D436
                    - Arn
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'Fn::Join':
                      - ':'
                      - - 'Fn::Select':
                            - 0
                            - 'Fn::Split':
                                - ':'
                                - Ref: teststatefuldefinitionB92BAA14
                        - 'Fn::Select':
                            - 1
                            - 'Fn::Split':
                                - ':'
                                - Ref: teststatefuldefinitionB92BAA14
                        - 'Fn::Select':
                            - 2
                            - 'Fn::Split':
                                - ':'
                                - Ref: teststatefuldefinitionB92BAA14
                        - 'Fn::Select':
                            - 3
                            - 'Fn::Split':
                                - ':'
                                - Ref: teststatefuldefinitionB92BAA14
                        - 'Fn::Select':
                            - 4
                            - 'Fn::Split':
                                - ':'
                                - Ref: teststatefuldefinitionB92BAA14
                        - 'Fn::Select':
                            - 5
                            - 'Fn::Split':
                                - ':'
                                - Ref: teststatefuldefinitionB92BAA14
                  - ':*'
            Sid: RunTask
          - Action: 'iam:PassRole'
            Condition:
              StringEquals:
                'iam:PassedToService': ecs-tasks.amazonaws.com
            Effect: Allow
            Resource:
              - 'Fn::GetAtt':
                  - testrestatetaskrole4CC243A3
                  - Arn
              - 'Fn::GetAtt':
                  - testrestateexecutionrole4CD7F161
                  - Arn
            Sid: RunTaskPassRole
          - Action:
              - 'ec2:DescribeVolumes'
              - 'ec2:DescribeSnapshots'
            Effect: Allow
            Resource: '*'
            Sid: EC2ListActions
          - Action: 'ec2:CreateSnapshot'
            Condition:
              ArnEquals:
                'aws:RequestTag/restate:ecsClusterArn':
                  'Fn::GetAtt':
                    - testclusterDBD4D436
                    - Arn
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'arn:'
                  - Ref: 'AWS::Partition'
                  - ':ec2:'
                  - Ref: 'AWS::Region'
                  - '::snapshot/*'
            Sid: CreateSnapshot
          - Action: 'ec2:CreateSnapshot'
            Condition:
              ArnEquals:
                'aws:ResourceTag/restate:ecsClusterArn':
                  'Fn::GetAtt':
                    - testclusterDBD4D436
                    - Arn
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'arn:'
                  - Ref: 'AWS::Partition'
                  - ':ec2:'
                  - Ref: 'AWS::Region'
                  - ':'
                  - Ref: 'AWS::AccountId'
                  - ':volume/*'
            Sid: SnapshotVolume
          - Action: 'ec2:CreateTags'
            Condition:
              StringEquals:
                'ec2:CreateAction': CreateSnapshot
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'arn:'
                  - Ref: 'AWS::Partition'
                  - ':ec2:'
                  - Ref: 'AWS::Region'
                  - '::snapshot/*'
            Sid: TagSnapshots
          - Action:
              - 'ec2:DeleteVolume'
              - 'ec2:DeleteSnapshot'
            Condition:
              ArnEquals:
                'aws:ResourceTag/restate:ecsClusterArn':
                  'Fn::GetAtt':
                    - testclusterDBD4D436
                    - Arn
            Effect: Allow
            Resource:
              - 'Fn::Join':
                  - ''
                  - - 'arn:'
                    - Ref: 'AWS::Partition'
                    - ':ec2:'
                    - Ref: 'AWS::Region'
                    - ':'
                    - Ref: 'AWS::AccountId'
                    - ':volume/*'
              - 'Fn::Join':
                  - ''
                  - - 'arn:'
                    - Ref: 'AWS::Partition'
                    - ':ec2:'
                    - Ref: 'AWS::Region'
                    - '::snapshot/*'
            Sid: DeleteVolumeAndSnapshot
          - Action:
              - 's3:GetObject'
              - 's3:PutObject'
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'Fn::GetAtt':
                      - testbucket731B7DE2
                      - Arn
                  - /*
            Sid: ReadWriteBucket
          - Action: 's3:ListBucket'
            Effect: Allow
            Resource:
              'Fn::GetAtt':
                - testbucket731B7DE2
                - Arn
            Sid: ListBucket
        Version: '2012-10-17'
      PolicyName: testcontrollertaskroleDefaultPolicy030D6236
      Roles:
        - Ref: testcontrollertaskrole42417C6E
  testcontrollerexecutionrole3BE0C8C4:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
        Version: '2012-10-17'
  testcontrollerexecutionroleDefaultPolicy443CB52A:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 'logs:CreateLogStream'
              - 'logs:PutLogEvents'
            Effect: Allow
            Resource:
              'Fn::GetAtt':
                - customcontrollerlogs5262F813
                - Arn
        Version: '2012-10-17'
      PolicyName: testcontrollerexecutionroleDefaultPolicy443CB52A
      Roles:
        - Ref: testcontrollerexecutionrole3BE0C8C4
  testcontrollerdefinition0C4BC223:
    Type: 'AWS::ECS::TaskDefinition'
    Properties:
      ContainerDefinitions:
        - Cpu: 1024
          Environment:
            - Name: RUST_LOG
              Value: 'info,restate_fargate_controller=debug'
            - Name: CONTROLLER_LOG_FORMAT
              Value: json
            - Name: CONTROLLER_METADATA_PATH
              Value:
                'Fn::Join':
                  - ''
                  - - 's3://'
                    - Ref: testbucket731B7DE2
                    - /metadata
            - Name: CONTROLLER_RECONCILE_INTERVAL
              Value: 10s
            - Name: CONTROLLER_CLUSTER__CLUSTER_ARN
              Value:
                'Fn::GetAtt':
                  - testclusterDBD4D436
                  - Arn
            - Name: CONTROLLER_LICENSE_KEY
              Value: foo
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __REGION
              Value:
                Ref: 'AWS::Region'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __CLUSTER_ARN
              Value:
                'Fn::GetAtt':
                  - testclusterDBD4D436
                  - Arn
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __TASK_PREFIX
              Value:
                'Fn::Join':
                  - /
                  - - 'Fn::Join':
                        - ':'
                        - - 'Fn::Select':
                              - 0
                              - 'Fn::Split':
                                  - ':'
                                  - 'Fn::Select':
                                      - 0
                                      - 'Fn::Split':
                                          - /
                                          - 'Fn::GetAtt':
                                              - testclusterDBD4D436
                                              - Arn
                          - 'Fn::Select':
                              - 1
                              - 'Fn::Split':
                                  - ':'
                                  - 'Fn::Select':
                                      - 0
                                      - 'Fn::Split':
                                          - /
                                          - 'Fn::GetAtt':
                                              - testclusterDBD4D436
                                              - Arn
                          - 'Fn::Select':
                              - 2
                              - 'Fn::Split':
                                  - ':'
                                  - 'Fn::Select':
                                      - 0
                                      - 'Fn::Split':
                                          - /
                                          - 'Fn::GetAtt':
                                              - testclusterDBD4D436
                                              - Arn
                          - 'Fn::Select':
                              - 3
                              - 'Fn::Split':
                                  - ':'
                                  - 'Fn::Select':
                                      - 0
                                      - 'Fn::Split':
                                          - /
                                          - 'Fn::GetAtt':
                                              - testclusterDBD4D436
                                              - Arn
                          - 'Fn::Select':
                              - 4
                              - 'Fn::Split':
                                  - ':'
                                  - 'Fn::Select':
                                      - 0
                                      - 'Fn::Split':
                                          - /
                                          - 'Fn::GetAtt':
                                              - testclusterDBD4D436
                                              - Arn
                          - task
                    - 'Fn::Select':
                        - 1
                        - 'Fn::Split':
                            - /
                            - 'Fn::GetAtt':
                                - testclusterDBD4D436
                                - Arn
                    - ''
            - Name: CONTROLLER_EBS_SNAPSHOT_RETENTION_PERIOD
              Value: 24h
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1a__ENABLE_EXECUTE_COMMAND
              Value: 'false'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1a__SECURITY_GROUPS
              Value:
                'Fn::Join':
                  - ''
                  - - '["'
                    - 'Fn::GetAtt':
                        - testsecuritygroupB015C031
                        - GroupId
                    - '"]'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1a__SUBNETS
              Value:
                'Fn::Join':
                  - ''
                  - - '["'
                    - 'Fn::ImportValue': >-
                        VPCStack:ExportsOutputRefvpcPrivateSubnet1Subnet934893E8236E2271
                    - '"]'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1a__TASK_DEFINITION_ARN
              Value:
                Ref: teststatefuldefinitionB92BAA14
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1a__COUNT
              Value: '1'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1b__ENABLE_EXECUTE_COMMAND
              Value: 'false'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1b__SECURITY_GROUPS
              Value:
                'Fn::Join':
                  - ''
                  - - '["'
                    - 'Fn::GetAtt':
                        - testsecuritygroupB015C031
                        - GroupId
                    - '"]'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1b__SUBNETS
              Value:
                'Fn::Join':
                  - ''
                  - - '["'
                    - 'Fn::ImportValue': >-
                        VPCStack:ExportsOutputRefvpcPrivateSubnet2Subnet7031C2BA60DCB1EE
                    - '"]'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1b__TASK_DEFINITION_ARN
              Value:
                Ref: teststatefuldefinitionB92BAA14
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1b__COUNT
              Value: '1'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1c__ENABLE_EXECUTE_COMMAND
              Value: 'false'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1c__SECURITY_GROUPS
              Value:
                'Fn::Join':
                  - ''
                  - - '["'
                    - 'Fn::GetAtt':
                        - testsecuritygroupB015C031
                        - GroupId
                    - '"]'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1c__SUBNETS
              Value:
                'Fn::Join':
                  - ''
                  - - '["'
                    - 'Fn::ImportValue': >-
                        VPCStack:ExportsOutputRefvpcPrivateSubnet3Subnet985AC459F9514491
                    - '"]'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1c__TASK_DEFINITION_ARN
              Value:
                Ref: teststatefuldefinitionB92BAA14
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1c__COUNT
              Value: '1'
          Essential: true
          HealthCheck:
            Command:
              - CMD
              - curl
              - '--fail'
              - 'http://127.0.0.1:8080/health'
            Interval: 30
            Retries: 10
            StartPeriod: 300
            Timeout: 5
          Image: Any<Object>
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group:
                Ref: customcontrollerlogs5262F813
              awslogs-stream-prefix: controller
              awslogs-region: region
              awslogs-datetime-format: custom-format
              mode: blocking
          Memory: 2048
          Name: controller
          StopTimeout: 120
      Cpu: '1024'
      ExecutionRoleArn:
        'Fn::GetAtt':
          - testcontrollerexecutionrole3BE0C8C4
          - Arn
      Family: RestateBYOCtestcontrollerdefinitionA329F74F
      Memory: '2048'
      NetworkMode: awsvpc
      RequiresCompatibilities:
        - FARGATE
      RuntimePlatform:
        CpuArchitecture: ARM64
        OperatingSystemFamily: LINUX
      Tags:
        - Key: Name
          Value: RestateBYOC/test/controller-definition
      TaskRoleArn:
        'Fn::GetAtt':
          - testcontrollertaskrole42417C6E
          - Arn
  testcontrollerserviceService356186D6:
    Type: 'AWS::ECS::Service'
    Properties:
      Cluster:
        Ref: testclusterDBD4D436
      DeploymentConfiguration:
        Alarms:
          AlarmNames: []
          Enable: false
          Rollback: false
        MaximumPercent: 100
        MinimumHealthyPercent: 0
      DeploymentController:
        Type: ECS
      DesiredCount: 1
      EnableECSManagedTags: false
      EnableExecuteCommand: false
      LaunchType: FARGATE
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: DISABLED
          SecurityGroups:
            - 'Fn::GetAtt':
                - testsecuritygroupB015C031
                - GroupId
          Subnets:
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet1Subnet934893E8236E2271'
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet2Subnet7031C2BA60DCB1EE'
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet3Subnet985AC459F9514491'
      Tags:
        - Key: Name
          Value: RestateBYOC/test/controller-service
      TaskDefinition:
        Ref: testcontrollerdefinition0C4BC223
    DependsOn:
      - testcontrollertaskroleDefaultPolicy030D6236
      - testcontrollertaskrole42417C6E
  testrestatectlloggroupC2AAB6C7:
    Type: 'AWS::Logs::LogGroup'
    Properties:
      RetentionInDays: 14
    UpdateReplacePolicy: Retain
    DeletionPolicy: Retain
  testrestatectllambdaexecutionrole9C923F83:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
        Version: '2012-10-17'
  testrestatectllambdaexecutionroleDefaultPolicy93BA3725:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 'logs:CreateLogStream'
              - 'logs:PutLogEvents'
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'arn:'
                  - Ref: 'AWS::Partition'
                  - ':logs:'
                  - Ref: 'AWS::Region'
                  - ':'
                  - Ref: 'AWS::AccountId'
                  - ':log-group:'
                  - Ref: testrestatectlloggroupC2AAB6C7
                  - ':log-stream:*'
            Sid: AWSLambdaLogStreamPermissions
          - Action:
              - 'ec2:CreateNetworkInterface'
              - 'ec2:DescribeNetworkInterfaces'
              - 'ec2:DescribeSubnets'
              - 'ec2:DeleteNetworkInterface'
            Effect: Allow
            Resource: '*'
            Sid: AWSLambdaVPCWildcardPermissions
          - Action:
              - 'ec2:AssignPrivateIpAddresses'
              - 'ec2:UnassignPrivateIpAddresses'
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'arn:'
                  - Ref: 'AWS::Partition'
                  - ':ec2:'
                  - Ref: 'AWS::Region'
                  - ':'
                  - Ref: 'AWS::AccountId'
                  - ':network-interface/*'
            Sid: AWSLambdaVPCNetworkInterfacePermissions
        Version: '2012-10-17'
      PolicyName: testrestatectllambdaexecutionroleDefaultPolicy93BA3725
      Roles:
        - Ref: testrestatectllambdaexecutionrole9C923F83
  testrestatectllambda6F1900FA:
    Type: 'AWS::Lambda::Function'
    Properties:
      Architectures:
        - arm64
      Code: Any<Object>
      Environment:
        Variables:
          RESTATECTL_ADDRESS:
            'Fn::Join':
              - ''
              - - 'http://'
                - 'Fn::GetAtt':
                    - testsharednlb6BC10CBB
                    - DNSName
                - ':5122'
      Handler: restatectl
      LoggingConfig:
        LogGroup:
          Ref: testrestatectlloggroupC2AAB6C7
      Role:
        'Fn::GetAtt':
          - testrestatectllambdaexecutionrole9C923F83
          - Arn
      Runtime: provided.al2023
      Tags:
        - Key: Name
          Value: RestateBYOC/test/restatectl-lambda
      Timeout: 10
      VpcConfig:
        SecurityGroupIds:
          - 'Fn::GetAtt':
              - testsecuritygroupB015C031
              - GroupId
        SubnetIds:
          - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet1Subnet934893E8236E2271'
          - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet2Subnet7031C2BA60DCB1EE'
          - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet3Subnet985AC459F9514491'
    DependsOn:
      - testrestatectllambdaexecutionroleDefaultPolicy93BA3725
      - testrestatectllambdaexecutionrole9C923F83
  testretirementwatcherloggroupBCD89B2E:
    Type: 'AWS::Logs::LogGroup'
    Properties:
      RetentionInDays: 14
    UpdateReplacePolicy: Retain
    DeletionPolicy: Retain
  testretirementwatcherlambdaexecutionrole0BCEB9D0:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
        Version: '2012-10-17'
  testretirementwatcherlambdaexecutionroleDefaultPolicy6E9FBD0D:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 'logs:CreateLogStream'
              - 'logs:PutLogEvents'
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'arn:'
                  - Ref: 'AWS::Partition'
                  - ':logs:'
                  - Ref: 'AWS::Region'
                  - ':'
                  - Ref: 'AWS::AccountId'
                  - ':log-group:'
                  - Ref: testretirementwatcherloggroupBCD89B2E
                  - ':log-stream:*'
            Sid: AWSLambdaLogStreamPermissions
          - Action: 'ecs:TagResource'
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'Fn::Join':
                      - /
                      - - 'Fn::Join':
                            - ':'
                            - - 'Fn::Select':
                                  - 0
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - testclusterDBD4D436
                                                  - Arn
                              - 'Fn::Select':
                                  - 1
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - testclusterDBD4D436
                                                  - Arn
                              - 'Fn::Select':
                                  - 2
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - testclusterDBD4D436
                                                  - Arn
                              - 'Fn::Select':
                                  - 3
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - testclusterDBD4D436
                                                  - Arn
                              - 'Fn::Select':
                                  - 4
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - testclusterDBD4D436
                                                  - Arn
                              - task
                        - 'Fn::Select':
                            - 1
                            - 'Fn::Split':
                                - /
                                - 'Fn::GetAtt':
                                    - testclusterDBD4D436
                                    - Arn
                        - ''
                  - '*'
            Sid: TagTasks
          - Action:
              - 'sqs:ReceiveMessage'
              - 'sqs:ChangeMessageVisibility'
              - 'sqs:GetQueueUrl'
              - 'sqs:DeleteMessage'
              - 'sqs:GetQueueAttributes'
            Effect: Allow
            Resource:
              'Fn::GetAtt':
                - testretirementwatcherqueue71FDBFE9
                - Arn
        Version: '2012-10-17'
      PolicyName: testretirementwatcherlambdaexecutionroleDefaultPolicy6E9FBD0D
      Roles:
        - Ref: testretirementwatcherlambdaexecutionrole0BCEB9D0
  testretirementwatcherlambdaF666308D:
    Type: 'AWS::Lambda::Function'
    Properties:
      Architectures:
        - arm64
      Code: Any<Object>
      Handler: index.handler
      LoggingConfig:
        LogGroup:
          Ref: testretirementwatcherloggroupBCD89B2E
      Role:
        'Fn::GetAtt':
          - testretirementwatcherlambdaexecutionrole0BCEB9D0
          - Arn
      Runtime: nodejs22.x
      Tags:
        - Key: Name
          Value: RestateBYOC/test/retirement-watcher-lambda
      Timeout: 60
    DependsOn:
      - testretirementwatcherlambdaexecutionroleDefaultPolicy6E9FBD0D
      - testretirementwatcherlambdaexecutionrole0BCEB9D0
  testretirementwatcherlambdaSqsEventSourceRestateBYOCtestretirementwatcherqueue805C85E9DF913057:
    Type: 'AWS::Lambda::EventSourceMapping'
    Properties:
      BatchSize: 1
      EventSourceArn:
        'Fn::GetAtt':
          - testretirementwatcherqueue71FDBFE9
          - Arn
      FunctionName:
        Ref: testretirementwatcherlambdaF666308D
      Tags:
        - Key: Name
          Value: RestateBYOC/test/retirement-watcher-lambda
  testretirementwatcherqueue71FDBFE9:
    Type: 'AWS::SQS::Queue'
    Properties:
      Tags:
        - Key: Name
          Value: RestateBYOC/test/retirement-watcher-queue
      VisibilityTimeout: 60
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  testretirementwatcherqueuePolicy7D50DFC3:
    Type: 'AWS::SQS::QueuePolicy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 'sqs:SendMessage'
              - 'sqs:GetQueueAttributes'
              - 'sqs:GetQueueUrl'
            Condition:
              ArnEquals:
                'aws:SourceArn':
                  'Fn::GetAtt':
                    - testretirementwatcherruleBA70D9F7
                    - Arn
            Effect: Allow
            Principal:
              Service: events.amazonaws.com
            Resource:
              'Fn::GetAtt':
                - testretirementwatcherqueue71FDBFE9
                - Arn
        Version: '2012-10-17'
      Queues:
        - Ref: testretirementwatcherqueue71FDBFE9
  testretirementwatcherruleBA70D9F7:
    Type: 'AWS::Events::Rule'
    Properties:
      EventPattern:
        detail:
          eventTypeCode:
            - equals-ignore-case: AWS_ECS_TASK_PATCHING_RETIREMENT
          service:
            - equals-ignore-case: ecs
        resources:
          - prefix:
              'Fn::Join':
                - /
                - - 'Fn::Join':
                      - ':'
                      - - 'Fn::Select':
                            - 0
                            - 'Fn::Split':
                                - ':'
                                - 'Fn::Select':
                                    - 0
                                    - 'Fn::Split':
                                        - /
                                        - 'Fn::GetAtt':
                                            - testclusterDBD4D436
                                            - Arn
                        - 'Fn::Select':
                            - 1
                            - 'Fn::Split':
                                - ':'
                                - 'Fn::Select':
                                    - 0
                                    - 'Fn::Split':
                                        - /
                                        - 'Fn::GetAtt':
                                            - testclusterDBD4D436
                                            - Arn
                        - 'Fn::Select':
                            - 2
                            - 'Fn::Split':
                                - ':'
                                - 'Fn::Select':
                                    - 0
                                    - 'Fn::Split':
                                        - /
                                        - 'Fn::GetAtt':
                                            - testclusterDBD4D436
                                            - Arn
                        - 'Fn::Select':
                            - 3
                            - 'Fn::Split':
                                - ':'
                                - 'Fn::Select':
                                    - 0
                                    - 'Fn::Split':
                                        - /
                                        - 'Fn::GetAtt':
                                            - testclusterDBD4D436
                                            - Arn
                        - 'Fn::Select':
                            - 4
                            - 'Fn::Split':
                                - ':'
                                - 'Fn::Select':
                                    - 0
                                    - 'Fn::Split':
                                        - /
                                        - 'Fn::GetAtt':
                                            - testclusterDBD4D436
                                            - Arn
                        - task
                  - 'Fn::Select':
                      - 1
                      - 'Fn::Split':
                          - /
                          - 'Fn::GetAtt':
                              - testclusterDBD4D436
                              - Arn
                  - ''
        detail-type:
          - equals-ignore-case: AWS Health Event
      State: ENABLED
      Targets:
        - Arn:
            'Fn::GetAtt':
              - testretirementwatcherqueue71FDBFE9
              - Arn
          Id: Target0
  testcloudwatchcustomwidgetloggroupEBFA438D:
    Type: 'AWS::Logs::LogGroup'
    Properties:
      RetentionInDays: 14
    UpdateReplacePolicy: Retain
    DeletionPolicy: Retain
  testcloudwatchcustomwidgetexecutionrole72F32199:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
        Version: '2012-10-17'
  testcloudwatchcustomwidgetexecutionroleDefaultPolicy4D8EC73B:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 'logs:CreateLogStream'
              - 'logs:PutLogEvents'
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'arn:'
                  - Ref: 'AWS::Partition'
                  - ':logs:'
                  - Ref: 'AWS::Region'
                  - ':'
                  - Ref: 'AWS::AccountId'
                  - ':log-group:'
                  - Ref: testcloudwatchcustomwidgetloggroupEBFA438D
                  - ':log-stream:*'
            Sid: AWSLambdaLogStreamPermissions
          - Action: 'lambda:InvokeFunction'
            Effect: Allow
            Resource:
              'Fn::GetAtt':
                - testrestatectllambda6F1900FA
                - Arn
            Sid: InvokeRestatectl
          - Action: 'ecs:DescribeTaskDefinition'
            Effect: Allow
            Resource: '*'
            Sid: ECSReadActions
          - Action: 'ecs:ListTasks'
            Condition:
              StringEquals:
                'ecs:cluster':
                  'Fn::GetAtt':
                    - testclusterDBD4D436
                    - Arn
            Effect: Allow
            Resource: '*'
            Sid: ECSListTasks
          - Action: 'ecs:DescribeTasks'
            Condition:
              StringEquals:
                'ecs:cluster':
                  'Fn::GetAtt':
                    - testclusterDBD4D436
                    - Arn
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'arn:'
                  - Ref: 'AWS::Partition'
                  - ':ecs:'
                  - Ref: 'AWS::Region'
                  - ':'
                  - Ref: 'AWS::AccountId'
                  - ':task/'
                  - Ref: testclusterDBD4D436
                  - /*
            Sid: ECSDescribeTasks
          - Action: 'ecs:DescribeServices'
            Condition:
              StringEquals:
                'ecs:cluster':
                  'Fn::GetAtt':
                    - testclusterDBD4D436
                    - Arn
            Effect: Allow
            Resource:
              - Ref: testcontrollerserviceService356186D6
              - Ref: teststatelessserviceService5CDEA5F0
            Sid: ECSDescribeServices
          - Action: 'cloudwatch:GetMetricData'
            Effect: Allow
            Resource: '*'
            Sid: CloudWatchReadActions
        Version: '2012-10-17'
      PolicyName: testcloudwatchcustomwidgetexecutionroleDefaultPolicy4D8EC73B
      Roles:
        - Ref: testcloudwatchcustomwidgetexecutionrole72F32199
  testcloudwatchcustomwidgetlambdaB0DB8C59:
    Type: 'AWS::Lambda::Function'
    Properties:
      Architectures:
        - arm64
      Code: Any<Object>
      Environment:
        Variables:
          ENABLE_EBS_VOLUMES: 'false'
      Handler: index.handler
      LoggingConfig:
        LogGroup:
          Ref: testcloudwatchcustomwidgetloggroupEBFA438D
      MemorySize: 1024
      Role:
        'Fn::GetAtt':
          - testcloudwatchcustomwidgetexecutionrole72F32199
          - Arn
      Runtime: nodejs22.x
      Tags:
        - Key: Name
          Value: RestateBYOC/test/cloudwatch-custom-widget-lambda
      Timeout: 60
    DependsOn:
      - testcloudwatchcustomwidgetexecutionroleDefaultPolicy4D8EC73B
      - testcloudwatchcustomwidgetexecutionrole72F32199
  testcloudwatchcustomwidgetlambdacloudwatchcustomwidgetlambdaallowdatasource06DF513A:
    Type: 'AWS::Lambda::Permission'
    Properties:
      Action: 'lambda:InvokeFunction'
      FunctionName:
        'Fn::GetAtt':
          - testcloudwatchcustomwidgetlambdaB0DB8C59
          - Arn
      Principal: lambda.datasource.cloudwatch.amazonaws.com
  testmetricsAAAB7FF4:
    Type: 'AWS::CloudWatch::Dashboard'
    Properties:
      DashboardBody:
        'Fn::Join':
          - ''
          - - >-
              {"widgets":[{"type":"metric","width":12,"height":6,"x":0,"y":0,"properties":{"view":"timeSeries","title":"Stateless
              CPU","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"CPU","expression":"SELECT AVG(CpuUtilized)
              FROM SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOCteststatelessdefinitionA59C4856' GROUP BY
              TaskId"}]],"annotations":{"horizontal":[{"value":16384,"label":"Limit","yAxis":"left"}]},"yAxis":{"left":{"label":"vCPUs","showUnits":false}}}},{"type":"metric","width":12,"height":6,"x":12,"y":0,"properties":{"view":"timeSeries","title":"Stateless
              Memory","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Memory","expression":"SELECT
              AVG(MemoryUtilized) FROM SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOCteststatelessdefinitionA59C4856' GROUP BY
              TaskId"}]],"annotations":{"horizontal":[{"value":32768,"label":"Limit","yAxis":"left"}]},"yAxis":{"left":{"label":"MiB","showUnits":false}}}},{"type":"metric","width":12,"height":6,"x":0,"y":6,"properties":{"view":"timeSeries","title":"Stateless
              Network Tx","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Tx","expression":"SELECT
              AVG(NetworkTxBytes) FROM SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOCteststatelessdefinitionA59C4856' GROUP BY
              TaskId"}]],"yAxis":{"left":{"label":"Bytes/sec","showUnits":false}}}},{"type":"metric","width":12,"height":6,"x":12,"y":6,"properties":{"view":"timeSeries","title":"Stateless
              Network Rx","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Rx","expression":"SELECT
              AVG(NetworkRxBytes) FROM SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOCteststatelessdefinitionA59C4856' GROUP BY
              TaskId"}]],"yAxis":{"left":{"label":"Bytes/sec","showUnits":false}}}},{"type":"log","width":24,"height":6,"x":0,"y":12,"properties":{"view":"table","title":"Stateless
              Logs","region":"region","query":"SOURCE '
            - Ref: customrestatelogsABA15428
            - >-
              ' | fields @logStream, @timestamp, level, fields.message,
              target\\n          | sort @timestamp desc\\n          | limit
              500"}},{"type":"metric","width":12,"height":6,"x":0,"y":18,"properties":{"view":"timeSeries","title":"Stateful
              CPU","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"CPU","expression":"SELECT AVG(CpuUtilized)
              FROM SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily = 'RestateBYOCteststatefuldefinition9B15D9BA'
              GROUP BY
              TaskId"}]],"annotations":{"horizontal":[{"value":16384,"label":"Limit","yAxis":"left"}]},"yAxis":{"left":{"label":"vCPUs","showUnits":false}}}},{"type":"metric","width":12,"height":6,"x":12,"y":18,"properties":{"view":"timeSeries","title":"Stateful
              Memory","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Memory","expression":"SELECT
              AVG(MemoryUtilized) FROM SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily = 'RestateBYOCteststatefuldefinition9B15D9BA'
              GROUP BY
              TaskId"}]],"annotations":{"horizontal":[{"value":32768,"label":"Limit","yAxis":"left"}]},"yAxis":{"left":{"label":"MiB","showUnits":false}}}},{"type":"metric","width":12,"height":6,"x":0,"y":24,"properties":{"view":"timeSeries","title":"Stateful
              Network Tx","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Tx","expression":"SELECT
              AVG(NetworkTxBytes) FROM SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily = 'RestateBYOCteststatefuldefinition9B15D9BA'
              GROUP BY
              TaskId"}]],"yAxis":{"left":{"label":"Bytes/sec","showUnits":false}}}},{"type":"metric","width":12,"height":6,"x":12,"y":24,"properties":{"view":"timeSeries","title":"Stateful
              Network Rx","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Rx","expression":"SELECT
              AVG(NetworkRxBytes) FROM SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily = 'RestateBYOCteststatefuldefinition9B15D9BA'
              GROUP BY
              TaskId"}]],"yAxis":{"left":{"label":"Bytes/sec","showUnits":false}}}},{"type":"log","width":24,"height":6,"x":0,"y":30,"properties":{"view":"table","title":"Stateful
              Logs","region":"region","query":"SOURCE '
            - Ref: customrestatelogsABA15428
            - >-
              ' | fields @logStream, @timestamp, level, fields.message,
              target\\n          | sort @timestamp desc\\n          | limit
              500"}},{"type":"metric","width":8,"height":6,"x":0,"y":36,"properties":{"view":"timeSeries","title":"Ephemeral
              Volume Usage (Total size 200GiB)","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Usage","expression":"SELECT
              MAX(EphemeralStorageUtilized) FROM
              SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily) WHERE TaskDefinitionFamily =
              'RestateBYOCteststatefuldefinition9B15D9BA'"}]],"annotations":{"horizontal":[{"value":200,"label":"Volume
              size","visible":false,"yAxis":"left"}]},"yAxis":{"left":{"label":"GiB","showUnits":false}},"liveData":false}},{"type":"metric","width":8,"height":6,"x":8,"y":36,"properties":{"view":"timeSeries","title":"Volume
              Write Throughput (Limited to 150 MiB/sec)","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Write","expression":"RATE(count) /
              1048576"}],[{"expression":"SELECT MAX(StorageWriteBytes) FROM
              SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily = 'RestateBYOCteststatefuldefinition9B15D9BA'
              GROUP BY
              TaskId","visible":false,"id":"count"}]],"annotations":{"horizontal":[{"value":150,"label":"Limit","visible":false,"yAxis":"left"}]},"yAxis":{"left":{"label":"MiB/sec","showUnits":false}}}},{"type":"metric","width":8,"height":6,"x":16,"y":36,"properties":{"view":"timeSeries","title":"Volume
              Read Throughput (Limited to 150 MiB/sec)","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Read","expression":"RATE(count) /
              1048576"}],[{"expression":"SELECT MAX(StorageReadBytes) FROM
              SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily = 'RestateBYOCteststatefuldefinition9B15D9BA'
              GROUP BY
              TaskId","visible":false,"id":"count"}]],"annotations":{"horizontal":[{"value":150,"label":"Limit","visible":false,"yAxis":"left"}]},"yAxis":{"left":{"label":"MiB/sec","showUnits":false}}}},{"type":"log","width":24,"height":6,"x":0,"y":42,"properties":{"view":"table","title":"Controller
              Logs","region":"region","query":"SOURCE '
            - Ref: customcontrollerlogs5262F813
            - >-
              ' | fields @logStream, @timestamp, level, fields.message,
              target\\n          | sort @timestamp desc\\n          | limit
              500"}}]}
      DashboardName: RestateBYOC_test_metrics
  testcontrolpanel0D5F1B33:
    Type: 'AWS::CloudWatch::Dashboard'
    Properties:
      DashboardBody:
        'Fn::Join':
          - ''
          - - >-
              {"widgets":[{"type":"custom","width":24,"height":26,"x":0,"y":0,"properties":{"endpoint":"
            - 'Fn::GetAtt':
                - testcloudwatchcustomwidgetlambdaB0DB8C59
                - Arn
            - '","params":{"command":"controlPanel","input":{"region":"'
            - Ref: 'AWS::Region'
            - >-
              ","summary":{"clusterName":"RestateBYOC/test","restateVersion":"1.4","stackVersion":"0.4.1-dev","metricsDashboardName":"
            - Ref: testmetricsAAAB7FF4
            - '"},"resources":{"ecsClusterArn":"'
            - 'Fn::GetAtt':
                - testclusterDBD4D436
                - Arn
            - '","statelessServiceArn":"'
            - Ref: teststatelessserviceService5CDEA5F0
            - '","controllerServiceArn":"'
            - Ref: testcontrollerserviceService356186D6
            - '","restatectlLambdaArn":"'
            - 'Fn::GetAtt':
                - testrestatectllambda6F1900FA
                - Arn
            - >-
              "},"connectivityAndSecurity":{"connectivity":{"loadBalancerArns":{"ingress":["
            - Ref: testsharednlb6BC10CBB
            - '"],"admin":["'
            - Ref: testsharednlb6BC10CBB
            - '"]},"addresses":{"ingress":"http://'
            - 'Fn::GetAtt':
                - testsharednlb6BC10CBB
                - DNSName
            - ':8080","admin":"http://'
            - 'Fn::GetAtt':
                - testsharednlb6BC10CBB
                - DNSName
            - ':9070","webUI":"http://'
            - 'Fn::GetAtt':
                - testsharednlb6BC10CBB
                - DNSName
            - ':9070/ui"}},"networking":{"vpc":"'
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcA2121C384D1B3CDE'
            - '","availabilityZones":["dummy1a","dummy1b","dummy1c"],"subnets":["'
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet1Subnet934893E8236E2271'
            - '","'
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet2Subnet7031C2BA60DCB1EE'
            - '","'
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet3Subnet985AC459F9514491'
            - '"]},"security":{"securityGroups":["'
            - 'Fn::GetAtt':
                - testsecuritygroupB015C031
                - GroupId
            - '"]}},"storage":{"s3":{"bucket":"'
            - Ref: testbucket731B7DE2
            - >-
              "}}}},"title":"","updateOn":{"refresh":true,"resize":true,"timeRange":true}}}]}
      DashboardName: RestateBYOC_test_control-panel
Outputs:
  testSecurityGroups50C338D1:
    Description: The security group IDs of the cluster
    Value:
      'Fn::GetAtt':
        - testsecuritygroupB015C031
        - GroupId
  testIngressNetworkListenerA459AD14:
    Description: The ARN of the network listener for the ingress port
    Value:
      Ref: testingresssharedlistenerF18D3E56
  testIngressNetworkTargetGroup73857B83:
    Description: The ARN of the network target group for the ingress port
    Value:
      Ref: testingresssharedtarget779E3570
  testAdminNetworkListener840296BA:
    Description: The ARN of the network listener for the admin port
    Value:
      Ref: testadminsharedlistener6D147D79
  testAdminNetworkTargetGroup1541C506:
    Description: The ARN of the network target group for the admin port
    Value:
      Ref: testadminsharedtarget0C095FA8
  testNodeNetworkListener743144A9:
    Description: The ARN of the network listener for the node port
    Value:
      Ref: testnodesharedlistener98A38BFD
  testNodeNetworkTargetGroup76D5EEBA:
    Description: The ARN of the network target group for the node port
    Value:
      Ref: testnodesharedtarget6337BC22
"
`;

exports[`BYOC With cluster name 1`] = `
"Resources:
  withclusternamesecuritygroup9A10CA11:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      GroupDescription: RestateBYOC/with-cluster-name/security-group
      SecurityGroupEgress:
        - CidrIp: 0.0.0.0/0
          Description: Allow all outbound traffic by default
          IpProtocol: '-1'
      Tags:
        - Key: Name
          Value: RestateBYOC/with-cluster-name/security-group
      VpcId:
        'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcA2121C384D1B3CDE'
  withclusternamesecuritygroupfromRestateBYOCwithclusternamesecuritygroup775133D98080B7F12075:
    Type: 'AWS::EC2::SecurityGroupIngress'
    Properties:
      Description: 'from RestateBYOCwithclusternamesecuritygroup775133D9:8080'
      FromPort: 8080
      GroupId:
        'Fn::GetAtt':
          - withclusternamesecuritygroup9A10CA11
          - GroupId
      IpProtocol: tcp
      SourceSecurityGroupId:
        'Fn::GetAtt':
          - withclusternamesecuritygroup9A10CA11
          - GroupId
      ToPort: 8080
  withclusternamesecuritygroupfromRestateBYOCwithclusternamesecuritygroup775133D99070B88425F0:
    Type: 'AWS::EC2::SecurityGroupIngress'
    Properties:
      Description: 'from RestateBYOCwithclusternamesecuritygroup775133D9:9070'
      FromPort: 9070
      GroupId:
        'Fn::GetAtt':
          - withclusternamesecuritygroup9A10CA11
          - GroupId
      IpProtocol: tcp
      SourceSecurityGroupId:
        'Fn::GetAtt':
          - withclusternamesecuritygroup9A10CA11
          - GroupId
      ToPort: 9070
  withclusternamesecuritygroupfromRestateBYOCwithclusternamesecuritygroup775133D95122FFDE2146:
    Type: 'AWS::EC2::SecurityGroupIngress'
    Properties:
      Description: 'from RestateBYOCwithclusternamesecuritygroup775133D9:5122'
      FromPort: 5122
      GroupId:
        'Fn::GetAtt':
          - withclusternamesecuritygroup9A10CA11
          - GroupId
      IpProtocol: tcp
      SourceSecurityGroupId:
        'Fn::GetAtt':
          - withclusternamesecuritygroup9A10CA11
          - GroupId
      ToPort: 5122
  withclusternamebucket6214CCB0:
    Type: 'AWS::S3::Bucket'
    Properties:
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
    UpdateReplacePolicy: Retain
    DeletionPolicy: Retain
  withclusternamebucketPolicy2E156306:
    Type: 'AWS::S3::BucketPolicy'
    Properties:
      Bucket:
        Ref: withclusternamebucket6214CCB0
      PolicyDocument:
        Statement:
          - Action: 's3:*'
            Condition:
              Bool:
                'aws:SecureTransport': 'false'
            Effect: Deny
            Principal:
              AWS: '*'
            Resource:
              - 'Fn::GetAtt':
                  - withclusternamebucket6214CCB0
                  - Arn
              - 'Fn::Join':
                  - ''
                  - - 'Fn::GetAtt':
                        - withclusternamebucket6214CCB0
                        - Arn
                    - /*
        Version: '2012-10-17'
  withclusternamecluster8A2E876D:
    Type: 'AWS::ECS::Cluster'
    Properties:
      ClusterName: restate-byoc-cluster
      ClusterSettings:
        - Name: containerInsights
          Value: enhanced
      Tags:
        - Key: Name
          Value: RestateBYOC/with-cluster-name/cluster
  withclusternamerestatetaskrole3143312B:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
        Version: '2012-10-17'
  withclusternamerestatetaskroleDefaultPolicyA64EFA38:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 's3:GetObject'
              - 's3:PutObject'
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'Fn::GetAtt':
                      - withclusternamebucket6214CCB0
                      - Arn
                  - /*
            Sid: ReadWriteBucket
          - Action: 's3:ListBucket'
            Effect: Allow
            Resource:
              'Fn::GetAtt':
                - withclusternamebucket6214CCB0
                - Arn
            Sid: ListBucket
        Version: '2012-10-17'
      PolicyName: withclusternamerestatetaskroleDefaultPolicyA64EFA38
      Roles:
        - Ref: withclusternamerestatetaskrole3143312B
  withclusternamerestateexecutionroleEAACE718:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
        Version: '2012-10-17'
  withclusternamerestateexecutionroleDefaultPolicyEBAE444C:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 'logs:CreateLogStream'
              - 'logs:PutLogEvents'
            Effect: Allow
            Resource:
              'Fn::GetAtt':
                - withclusternamerestateloggroupC9A99FB9
                - Arn
        Version: '2012-10-17'
      PolicyName: withclusternamerestateexecutionroleDefaultPolicyEBAE444C
      Roles:
        - Ref: withclusternamerestateexecutionroleEAACE718
  withclusternamerestateloggroupC9A99FB9:
    Type: 'AWS::Logs::LogGroup'
    Properties:
      RetentionInDays: 30
    UpdateReplacePolicy: Retain
    DeletionPolicy: Retain
  withclusternamecontrollerloggroup157ABD85:
    Type: 'AWS::Logs::LogGroup'
    Properties:
      RetentionInDays: 30
    UpdateReplacePolicy: Retain
    DeletionPolicy: Retain
  withclusternamesharednlb8C523D9C:
    Type: 'AWS::ElasticLoadBalancingV2::LoadBalancer'
    Properties:
      LoadBalancerAttributes:
        - Key: deletion_protection.enabled
          Value: 'false'
        - Key: load_balancing.cross_zone.enabled
          Value: 'false'
        - Key: dns_record.client_routing_policy
          Value: availability_zone_affinity
      Scheme: internal
      SecurityGroups:
        - 'Fn::GetAtt':
            - withclusternamesecuritygroup9A10CA11
            - GroupId
      Subnets:
        - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet1Subnet934893E8236E2271'
        - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet2Subnet7031C2BA60DCB1EE'
        - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet3Subnet985AC459F9514491'
      Tags:
        - Key: Name
          Value: RestateBYOC/with-cluster-name/shared-nlb
      Type: network
  withclusternameingresssharedlistener95E35FDA:
    Type: 'AWS::ElasticLoadBalancingV2::Listener'
    Properties:
      DefaultActions:
        - TargetGroupArn:
            Ref: withclusternameingresssharedtargetB3D385F9
          Type: forward
      LoadBalancerArn:
        Ref: withclusternamesharednlb8C523D9C
      Port: 8080
      Protocol: TCP
  withclusternameadminsharedlistener9BA748D2:
    Type: 'AWS::ElasticLoadBalancingV2::Listener'
    Properties:
      DefaultActions:
        - TargetGroupArn:
            Ref: withclusternameadminsharedtarget0D4BB912
          Type: forward
      LoadBalancerArn:
        Ref: withclusternamesharednlb8C523D9C
      Port: 9070
      Protocol: TCP
  withclusternamenodesharedlistener0C52ED87:
    Type: 'AWS::ElasticLoadBalancingV2::Listener'
    Properties:
      DefaultActions:
        - TargetGroupArn:
            Ref: withclusternamenodesharedtarget977BCA3A
          Type: forward
      LoadBalancerArn:
        Ref: withclusternamesharednlb8C523D9C
      Port: 5122
      Protocol: TCP
  withclusternamestatelessdefinitionDA6BEB29:
    Type: 'AWS::ECS::TaskDefinition'
    Properties:
      ContainerDefinitions:
        - Cpu: 16384
          EntryPoint:
            - bash
            - '-c'
            - >

              curl --no-progress-meter $ECS_CONTAINER_METADATA_URI_V4 -o
              container-metadata && \\

              curl --no-progress-meter $ECS_CONTAINER_METADATA_URI_V4/task -o
              task-metadata && \\

              export \\
                RESTATE_NODE_NAME=$(jq -r '.TaskARN' task-metadata) \\
                RESTATE_LOCATION="$AWS_REGION.$(jq -r '.AvailabilityZone' task-metadata)" \\
                RESTATE_ADVERTISED_ADDRESS="http://$(jq -r '.Networks[0].IPv4Addresses[0]' container-metadata):5122"
              exec restate-server
          Environment:
            - Name: RESTATE_LOG_FORMAT
              Value: json
            - Name: RESTATE_CLUSTER_NAME
              Value: restate-byoc-cluster
            - Name: RESTATE_ROLES
              Value: '["admin","http-ingress"]'
            - Name: RESTATE_AUTO_PROVISION
              Value: 'true'
            - Name: RESTATE_SHUTDOWN_TIMEOUT
              Value: 100s
            - Name: RESTATE_DEFAULT_NUM_PARTITIONS
              Value: '128'
            - Name: RESTATE_DEFAULT_REPLICATION
              Value: '{zone: 2}'
            - Name: RESTATE_METADATA_CLIENT__TYPE
              Value: object-store
            - Name: RESTATE_METADATA_CLIENT__PATH
              Value:
                'Fn::Join':
                  - ''
                  - - 's3://'
                    - Ref: withclusternamebucket6214CCB0
                    - /metadata
            - Name: RESTATE_BIFROST__DEFAULT_PROVIDER
              Value: replicated
            - Name: >-
                RESTATE_INGRESS__EXPERIMENTAL_FEATURE_ENABLE_SEPARATE_INGRESS_ROLE
              Value: 'true'
            - Name: RESTATE_INGRESS__ADVERTISED_INGRESS_ENDPOINT
              Value:
                'Fn::Join':
                  - ''
                  - - 'http://'
                    - 'Fn::GetAtt':
                        - withclusternamesharednlb8C523D9C
                        - DNSName
                    - ':8080'
            - Name: RESTATE_WORKER__SNAPSHOTS__DESTINATION
              Value:
                'Fn::Join':
                  - ''
                  - - 's3://'
                    - Ref: withclusternamebucket6214CCB0
                    - /snapshots
          Essential: true
          HealthCheck:
            Command:
              - CMD
              - curl
              - '--fail'
              - 'http://127.0.0.1:8080/restate/health'
            Interval: 30
            Retries: 3
            Timeout: 5
          Image: Any<Object>
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group:
                Ref: withclusternamerestateloggroupC9A99FB9
              awslogs-stream-prefix: restate
              awslogs-region: region
              mode: non-blocking
          Memory: 32768
          Name: restate
          PortMappings:
            - ContainerPort: 8080
              Name: ingress
              Protocol: tcp
            - ContainerPort: 9070
              Name: admin
              Protocol: tcp
            - ContainerPort: 5122
              Name: node
              Protocol: tcp
          StopTimeout: 120
      Cpu: '16384'
      ExecutionRoleArn:
        'Fn::GetAtt':
          - withclusternamerestateexecutionroleEAACE718
          - Arn
      Family: RestateBYOCwithclusternamestatelessdefinition07E62327
      Memory: '32768'
      NetworkMode: awsvpc
      RequiresCompatibilities:
        - FARGATE
      RuntimePlatform:
        CpuArchitecture: ARM64
        OperatingSystemFamily: LINUX
      Tags:
        - Key: Name
          Value: RestateBYOC/with-cluster-name/stateless-definition
      TaskRoleArn:
        'Fn::GetAtt':
          - withclusternamerestatetaskrole3143312B
          - Arn
  withclusternamestatelessserviceServiceA9323A0F:
    Type: 'AWS::ECS::Service'
    Properties:
      AvailabilityZoneRebalancing: ENABLED
      Cluster:
        Ref: withclusternamecluster8A2E876D
      DeploymentConfiguration:
        Alarms:
          AlarmNames: []
          Enable: false
          Rollback: false
        MaximumPercent: 200
        MinimumHealthyPercent: 100
      DeploymentController:
        Type: ECS
      DesiredCount: 3
      EnableECSManagedTags: false
      EnableExecuteCommand: false
      HealthCheckGracePeriodSeconds: 60
      LaunchType: FARGATE
      LoadBalancers:
        - ContainerName: restate
          ContainerPort: 8080
          TargetGroupArn:
            Ref: withclusternameingresssharedtargetB3D385F9
        - ContainerName: restate
          ContainerPort: 9070
          TargetGroupArn:
            Ref: withclusternameadminsharedtarget0D4BB912
        - ContainerName: restate
          ContainerPort: 5122
          TargetGroupArn:
            Ref: withclusternamenodesharedtarget977BCA3A
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: DISABLED
          SecurityGroups:
            - 'Fn::GetAtt':
                - withclusternamesecuritygroup9A10CA11
                - GroupId
          Subnets:
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet1Subnet934893E8236E2271'
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet2Subnet7031C2BA60DCB1EE'
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet3Subnet985AC459F9514491'
      PropagateTags: SERVICE
      Tags:
        - Key: Name
          Value: RestateBYOC/with-cluster-name/stateless-service
      TaskDefinition:
        Ref: withclusternamestatelessdefinitionDA6BEB29
    DependsOn:
      - withclusternameadminsharedlistener9BA748D2
      - withclusternameingresssharedlistener95E35FDA
      - withclusternamenodesharedlistener0C52ED87
      - withclusternamerestatetaskroleDefaultPolicyA64EFA38
      - withclusternamerestatetaskrole3143312B
  withclusternamestatefuldefinitionBAF7A571:
    Type: 'AWS::ECS::TaskDefinition'
    Properties:
      ContainerDefinitions:
        - Cpu: 16384
          EntryPoint:
            - bash
            - '-c'
            - >

              curl --no-progress-meter $ECS_CONTAINER_METADATA_URI_V4 -o
              container-metadata && \\

              curl --no-progress-meter $ECS_CONTAINER_METADATA_URI_V4/task -o
              task-metadata && \\

              export \\
                RESTATE_NODE_NAME=$(jq -r '.TaskARN' task-metadata) \\
                RESTATE_LOCATION="$AWS_REGION.$(jq -r '.AvailabilityZone' task-metadata)" \\
                RESTATE_ADVERTISED_ADDRESS="http://$(jq -r '.Networks[0].IPv4Addresses[0]' container-metadata):5122" \\
                RESTATE_ROCKSDB_TOTAL_MEMORY_SIZE="$(($(jq -r '.Limits.Memory' container-metadata) * 3 / 4))MiB" \\
                RESTATE_WORKER__STORAGE__NUM_PARTITIONS_TO_SHARE_MEMORY_BUDGET=$(("$RESTATE_WORKER__STORAGE__NUM_PARTITIONS_TO_SHARE_MEMORY_BUDGET"))
              exec restate-server
          Environment:
            - Name: RESTATE_LOG_FORMAT
              Value: json
            - Name: RESTATE_CLUSTER_NAME
              Value: restate-byoc-cluster
            - Name: RESTATE_ROLES
              Value: '["log-server", "worker"]'
            - Name: RESTATE_AUTO_PROVISION
              Value: 'false'
            - Name: RESTATE_SHUTDOWN_TIMEOUT
              Value: 100s
            - Name: RESTATE_METADATA_CLIENT__TYPE
              Value: object-store
            - Name: RESTATE_METADATA_CLIENT__PATH
              Value:
                'Fn::Join':
                  - ''
                  - - 's3://'
                    - Ref: withclusternamebucket6214CCB0
                    - /metadata
            - Name: RESTATE_WORKER__SNAPSHOTS__DESTINATION
              Value:
                'Fn::Join':
                  - ''
                  - - 's3://'
                    - Ref: withclusternamebucket6214CCB0
                    - /snapshots
            - Name: RESTATE_WORKER__SNAPSHOTS__SNAPSHOT_INTERVAL_NUM_RECORDS
              Value: '1000000'
            - Name: RESTATE_WORKER__STORAGE__ROCKSDB_DISABLE_DIRECT_IO_FOR_READS
              Value: 'true'
            - Name: RESTATE_WORKER__STORAGE__ROCKSDB_DISABLE_WAL_FSYNC
              Value: 'true'
            - Name: RESTATE_WORKER__STORAGE__NUM_PARTITIONS_TO_SHARE_MEMORY_BUDGET
              Value: (128 * 2) / (3 * 1)
            - Name: RESTATE_LOG_SERVER__ROCKSDB_DISABLE_WAL_FSYNC
              Value: 'true'
            - Name: RESTATE_LOG_SERVER__ROCKSDB_DISABLE_DIRECT_IO_FOR_READS
              Value: 'true'
            - Name: >-
                RESTATE_INGRESS__EXPERIMENTAL_FEATURE_ENABLE_SEPARATE_INGRESS_ROLE
              Value: 'true'
          Essential: true
          HealthCheck:
            Command:
              - CMD
              - curl
              - '--fail'
              - 'http://127.0.0.1:5122/health'
            Interval: 30
            Retries: 3
            Timeout: 5
          Image: Any<Object>
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group:
                Ref: withclusternamerestateloggroupC9A99FB9
              awslogs-stream-prefix: restate
              awslogs-region: region
              mode: non-blocking
          Memory: 32768
          MountPoints:
            - ContainerPath: /restate-data
              ReadOnly: false
              SourceVolume: restate-data
          Name: restate
          PortMappings:
            - ContainerPort: 5122
              Name: node
              Protocol: tcp
          RestartPolicy:
            Enabled: true
            RestartAttemptPeriod: 60
          StopTimeout: 120
      Cpu: '16384'
      EphemeralStorage:
        SizeInGiB: 200
      ExecutionRoleArn:
        'Fn::GetAtt':
          - withclusternamerestateexecutionroleEAACE718
          - Arn
      Family: RestateBYOCwithclusternamestatefuldefinitionA7F94D22
      Memory: '32768'
      NetworkMode: awsvpc
      RequiresCompatibilities:
        - FARGATE
      RuntimePlatform:
        CpuArchitecture: ARM64
        OperatingSystemFamily: LINUX
      Tags:
        - Key: Name
          Value: RestateBYOC/with-cluster-name/stateful-definition
      TaskRoleArn:
        'Fn::GetAtt':
          - withclusternamerestatetaskrole3143312B
          - Arn
      Volumes:
        - ConfiguredAtLaunch: false
          Name: restate-data
  withclusternameingresssharedtargetB3D385F9:
    Type: 'AWS::ElasticLoadBalancingV2::TargetGroup'
    Properties:
      HealthCheckEnabled: true
      HealthCheckIntervalSeconds: 5
      HealthCheckPath: /restate/health
      HealthCheckProtocol: HTTP
      HealthCheckTimeoutSeconds: 2
      Port: 8080
      Protocol: TCP
      Tags:
        - Key: Name
          Value: RestateBYOC/with-cluster-name/ingress-shared-target
      TargetType: ip
      VpcId:
        'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcA2121C384D1B3CDE'
  withclusternameadminsharedtarget0D4BB912:
    Type: 'AWS::ElasticLoadBalancingV2::TargetGroup'
    Properties:
      HealthCheckEnabled: true
      HealthCheckIntervalSeconds: 5
      HealthCheckPath: /health
      HealthCheckPort: '9070'
      HealthCheckProtocol: HTTP
      HealthCheckTimeoutSeconds: 2
      Port: 9070
      Protocol: TCP
      Tags:
        - Key: Name
          Value: RestateBYOC/with-cluster-name/admin-shared-target
      TargetType: ip
      VpcId:
        'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcA2121C384D1B3CDE'
  withclusternamenodesharedtarget977BCA3A:
    Type: 'AWS::ElasticLoadBalancingV2::TargetGroup'
    Properties:
      HealthCheckEnabled: true
      HealthCheckIntervalSeconds: 5
      HealthCheckPath: /health
      HealthCheckPort: '5122'
      HealthCheckProtocol: HTTP
      HealthCheckTimeoutSeconds: 2
      Port: 5122
      Protocol: TCP
      Tags:
        - Key: Name
          Value: RestateBYOC/with-cluster-name/node-shared-target
      TargetType: ip
      VpcId:
        'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcA2121C384D1B3CDE'
  withclusternamecontrollertaskroleD965AFAA:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
        Version: '2012-10-17'
  withclusternamecontrollertaskroleDefaultPolicy54BC385C:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action: 'ecs:ListTasks'
            Condition:
              ArnEquals:
                'ecs:cluster':
                  'Fn::GetAtt':
                    - withclusternamecluster8A2E876D
                    - Arn
            Effect: Allow
            Resource: '*'
            Sid: ECSListActions
          - Action:
              - 'ecs:TagResource'
              - 'ecs:DescribeTasks'
              - 'ecs:StopTask'
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'Fn::Join':
                      - /
                      - - 'Fn::Join':
                            - ':'
                            - - 'Fn::Select':
                                  - 0
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - withclusternamecluster8A2E876D
                                                  - Arn
                              - 'Fn::Select':
                                  - 1
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - withclusternamecluster8A2E876D
                                                  - Arn
                              - 'Fn::Select':
                                  - 2
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - withclusternamecluster8A2E876D
                                                  - Arn
                              - 'Fn::Select':
                                  - 3
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - withclusternamecluster8A2E876D
                                                  - Arn
                              - 'Fn::Select':
                                  - 4
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - withclusternamecluster8A2E876D
                                                  - Arn
                              - task
                        - 'Fn::Select':
                            - 1
                            - 'Fn::Split':
                                - /
                                - 'Fn::GetAtt':
                                    - withclusternamecluster8A2E876D
                                    - Arn
                        - ''
                  - '*'
            Sid: TaskActions
          - Action: 'ecs:RunTask'
            Condition:
              ArnEquals:
                'ecs:cluster':
                  'Fn::GetAtt':
                    - withclusternamecluster8A2E876D
                    - Arn
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'Fn::Join':
                      - ':'
                      - - 'Fn::Select':
                            - 0
                            - 'Fn::Split':
                                - ':'
                                - Ref: withclusternamestatefuldefinitionBAF7A571
                        - 'Fn::Select':
                            - 1
                            - 'Fn::Split':
                                - ':'
                                - Ref: withclusternamestatefuldefinitionBAF7A571
                        - 'Fn::Select':
                            - 2
                            - 'Fn::Split':
                                - ':'
                                - Ref: withclusternamestatefuldefinitionBAF7A571
                        - 'Fn::Select':
                            - 3
                            - 'Fn::Split':
                                - ':'
                                - Ref: withclusternamestatefuldefinitionBAF7A571
                        - 'Fn::Select':
                            - 4
                            - 'Fn::Split':
                                - ':'
                                - Ref: withclusternamestatefuldefinitionBAF7A571
                        - 'Fn::Select':
                            - 5
                            - 'Fn::Split':
                                - ':'
                                - Ref: withclusternamestatefuldefinitionBAF7A571
                  - ':*'
            Sid: RunTask
          - Action: 'iam:PassRole'
            Condition:
              StringEquals:
                'iam:PassedToService': ecs-tasks.amazonaws.com
            Effect: Allow
            Resource:
              - 'Fn::GetAtt':
                  - withclusternamerestatetaskrole3143312B
                  - Arn
              - 'Fn::GetAtt':
                  - withclusternamerestateexecutionroleEAACE718
                  - Arn
            Sid: RunTaskPassRole
          - Action:
              - 'ec2:DescribeVolumes'
              - 'ec2:DescribeSnapshots'
            Effect: Allow
            Resource: '*'
            Sid: EC2ListActions
          - Action: 'ec2:CreateSnapshot'
            Condition:
              ArnEquals:
                'aws:RequestTag/restate:ecsClusterArn':
                  'Fn::GetAtt':
                    - withclusternamecluster8A2E876D
                    - Arn
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'arn:'
                  - Ref: 'AWS::Partition'
                  - ':ec2:'
                  - Ref: 'AWS::Region'
                  - '::snapshot/*'
            Sid: CreateSnapshot
          - Action: 'ec2:CreateSnapshot'
            Condition:
              ArnEquals:
                'aws:ResourceTag/restate:ecsClusterArn':
                  'Fn::GetAtt':
                    - withclusternamecluster8A2E876D
                    - Arn
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'arn:'
                  - Ref: 'AWS::Partition'
                  - ':ec2:'
                  - Ref: 'AWS::Region'
                  - ':'
                  - Ref: 'AWS::AccountId'
                  - ':volume/*'
            Sid: SnapshotVolume
          - Action: 'ec2:CreateTags'
            Condition:
              StringEquals:
                'ec2:CreateAction': CreateSnapshot
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'arn:'
                  - Ref: 'AWS::Partition'
                  - ':ec2:'
                  - Ref: 'AWS::Region'
                  - '::snapshot/*'
            Sid: TagSnapshots
          - Action:
              - 'ec2:DeleteVolume'
              - 'ec2:DeleteSnapshot'
            Condition:
              ArnEquals:
                'aws:ResourceTag/restate:ecsClusterArn':
                  'Fn::GetAtt':
                    - withclusternamecluster8A2E876D
                    - Arn
            Effect: Allow
            Resource:
              - 'Fn::Join':
                  - ''
                  - - 'arn:'
                    - Ref: 'AWS::Partition'
                    - ':ec2:'
                    - Ref: 'AWS::Region'
                    - ':'
                    - Ref: 'AWS::AccountId'
                    - ':volume/*'
              - 'Fn::Join':
                  - ''
                  - - 'arn:'
                    - Ref: 'AWS::Partition'
                    - ':ec2:'
                    - Ref: 'AWS::Region'
                    - '::snapshot/*'
            Sid: DeleteVolumeAndSnapshot
          - Action:
              - 's3:GetObject'
              - 's3:PutObject'
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'Fn::GetAtt':
                      - withclusternamebucket6214CCB0
                      - Arn
                  - /*
            Sid: ReadWriteBucket
          - Action: 's3:ListBucket'
            Effect: Allow
            Resource:
              'Fn::GetAtt':
                - withclusternamebucket6214CCB0
                - Arn
            Sid: ListBucket
        Version: '2012-10-17'
      PolicyName: withclusternamecontrollertaskroleDefaultPolicy54BC385C
      Roles:
        - Ref: withclusternamecontrollertaskroleD965AFAA
  withclusternamecontrollerexecutionroleA7855798:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
        Version: '2012-10-17'
  withclusternamecontrollerexecutionroleDefaultPolicy352367F7:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 'logs:CreateLogStream'
              - 'logs:PutLogEvents'
            Effect: Allow
            Resource:
              'Fn::GetAtt':
                - withclusternamecontrollerloggroup157ABD85
                - Arn
        Version: '2012-10-17'
      PolicyName: withclusternamecontrollerexecutionroleDefaultPolicy352367F7
      Roles:
        - Ref: withclusternamecontrollerexecutionroleA7855798
  withclusternamecontrollerdefinitionAFF92F56:
    Type: 'AWS::ECS::TaskDefinition'
    Properties:
      ContainerDefinitions:
        - Cpu: 1024
          Environment:
            - Name: RUST_LOG
              Value: 'info,restate_fargate_controller=debug'
            - Name: CONTROLLER_LOG_FORMAT
              Value: json
            - Name: CONTROLLER_METADATA_PATH
              Value:
                'Fn::Join':
                  - ''
                  - - 's3://'
                    - Ref: withclusternamebucket6214CCB0
                    - /metadata
            - Name: CONTROLLER_RECONCILE_INTERVAL
              Value: 10s
            - Name: CONTROLLER_CLUSTER__CLUSTER_ARN
              Value:
                'Fn::GetAtt':
                  - withclusternamecluster8A2E876D
                  - Arn
            - Name: CONTROLLER_LICENSE_KEY
              Value: foo
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __REGION
              Value:
                Ref: 'AWS::Region'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __CLUSTER_ARN
              Value:
                'Fn::GetAtt':
                  - withclusternamecluster8A2E876D
                  - Arn
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __TASK_PREFIX
              Value:
                'Fn::Join':
                  - /
                  - - 'Fn::Join':
                        - ':'
                        - - 'Fn::Select':
                              - 0
                              - 'Fn::Split':
                                  - ':'
                                  - 'Fn::Select':
                                      - 0
                                      - 'Fn::Split':
                                          - /
                                          - 'Fn::GetAtt':
                                              - withclusternamecluster8A2E876D
                                              - Arn
                          - 'Fn::Select':
                              - 1
                              - 'Fn::Split':
                                  - ':'
                                  - 'Fn::Select':
                                      - 0
                                      - 'Fn::Split':
                                          - /
                                          - 'Fn::GetAtt':
                                              - withclusternamecluster8A2E876D
                                              - Arn
                          - 'Fn::Select':
                              - 2
                              - 'Fn::Split':
                                  - ':'
                                  - 'Fn::Select':
                                      - 0
                                      - 'Fn::Split':
                                          - /
                                          - 'Fn::GetAtt':
                                              - withclusternamecluster8A2E876D
                                              - Arn
                          - 'Fn::Select':
                              - 3
                              - 'Fn::Split':
                                  - ':'
                                  - 'Fn::Select':
                                      - 0
                                      - 'Fn::Split':
                                          - /
                                          - 'Fn::GetAtt':
                                              - withclusternamecluster8A2E876D
                                              - Arn
                          - 'Fn::Select':
                              - 4
                              - 'Fn::Split':
                                  - ':'
                                  - 'Fn::Select':
                                      - 0
                                      - 'Fn::Split':
                                          - /
                                          - 'Fn::GetAtt':
                                              - withclusternamecluster8A2E876D
                                              - Arn
                          - task
                    - 'Fn::Select':
                        - 1
                        - 'Fn::Split':
                            - /
                            - 'Fn::GetAtt':
                                - withclusternamecluster8A2E876D
                                - Arn
                    - ''
            - Name: CONTROLLER_EBS_SNAPSHOT_RETENTION_PERIOD
              Value: 24h
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1a__ENABLE_EXECUTE_COMMAND
              Value: 'false'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1a__SECURITY_GROUPS
              Value:
                'Fn::Join':
                  - ''
                  - - '["'
                    - 'Fn::GetAtt':
                        - withclusternamesecuritygroup9A10CA11
                        - GroupId
                    - '"]'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1a__SUBNETS
              Value:
                'Fn::Join':
                  - ''
                  - - '["'
                    - 'Fn::ImportValue': >-
                        VPCStack:ExportsOutputRefvpcPrivateSubnet1Subnet934893E8236E2271
                    - '"]'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1a__TASK_DEFINITION_ARN
              Value:
                Ref: withclusternamestatefuldefinitionBAF7A571
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1a__COUNT
              Value: '1'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1b__ENABLE_EXECUTE_COMMAND
              Value: 'false'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1b__SECURITY_GROUPS
              Value:
                'Fn::Join':
                  - ''
                  - - '["'
                    - 'Fn::GetAtt':
                        - withclusternamesecuritygroup9A10CA11
                        - GroupId
                    - '"]'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1b__SUBNETS
              Value:
                'Fn::Join':
                  - ''
                  - - '["'
                    - 'Fn::ImportValue': >-
                        VPCStack:ExportsOutputRefvpcPrivateSubnet2Subnet7031C2BA60DCB1EE
                    - '"]'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1b__TASK_DEFINITION_ARN
              Value:
                Ref: withclusternamestatefuldefinitionBAF7A571
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1b__COUNT
              Value: '1'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1c__ENABLE_EXECUTE_COMMAND
              Value: 'false'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1c__SECURITY_GROUPS
              Value:
                'Fn::Join':
                  - ''
                  - - '["'
                    - 'Fn::GetAtt':
                        - withclusternamesecuritygroup9A10CA11
                        - GroupId
                    - '"]'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1c__SUBNETS
              Value:
                'Fn::Join':
                  - ''
                  - - '["'
                    - 'Fn::ImportValue': >-
                        VPCStack:ExportsOutputRefvpcPrivateSubnet3Subnet985AC459F9514491
                    - '"]'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1c__TASK_DEFINITION_ARN
              Value:
                Ref: withclusternamestatefuldefinitionBAF7A571
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1c__COUNT
              Value: '1'
          Essential: true
          HealthCheck:
            Command:
              - CMD
              - curl
              - '--fail'
              - 'http://127.0.0.1:8080/health'
            Interval: 30
            Retries: 10
            StartPeriod: 300
            Timeout: 5
          Image: Any<Object>
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group:
                Ref: withclusternamecontrollerloggroup157ABD85
              awslogs-stream-prefix: controller
              awslogs-region: region
              mode: non-blocking
          Memory: 2048
          Name: controller
          StopTimeout: 120
      Cpu: '1024'
      ExecutionRoleArn:
        'Fn::GetAtt':
          - withclusternamecontrollerexecutionroleA7855798
          - Arn
      Family: RestateBYOCwithclusternamecontrollerdefinition332A4808
      Memory: '2048'
      NetworkMode: awsvpc
      RequiresCompatibilities:
        - FARGATE
      RuntimePlatform:
        CpuArchitecture: ARM64
        OperatingSystemFamily: LINUX
      Tags:
        - Key: Name
          Value: RestateBYOC/with-cluster-name/controller-definition
      TaskRoleArn:
        'Fn::GetAtt':
          - withclusternamecontrollertaskroleD965AFAA
          - Arn
  withclusternamecontrollerserviceService7DEFCD49:
    Type: 'AWS::ECS::Service'
    Properties:
      Cluster:
        Ref: withclusternamecluster8A2E876D
      DeploymentConfiguration:
        Alarms:
          AlarmNames: []
          Enable: false
          Rollback: false
        MaximumPercent: 100
        MinimumHealthyPercent: 0
      DeploymentController:
        Type: ECS
      DesiredCount: 1
      EnableECSManagedTags: false
      EnableExecuteCommand: false
      LaunchType: FARGATE
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: DISABLED
          SecurityGroups:
            - 'Fn::GetAtt':
                - withclusternamesecuritygroup9A10CA11
                - GroupId
          Subnets:
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet1Subnet934893E8236E2271'
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet2Subnet7031C2BA60DCB1EE'
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet3Subnet985AC459F9514491'
      Tags:
        - Key: Name
          Value: RestateBYOC/with-cluster-name/controller-service
      TaskDefinition:
        Ref: withclusternamecontrollerdefinitionAFF92F56
    DependsOn:
      - withclusternamecontrollertaskroleDefaultPolicy54BC385C
      - withclusternamecontrollertaskroleD965AFAA
  withclusternamerestatectlloggroup03E0BF5F:
    Type: 'AWS::Logs::LogGroup'
    Properties:
      RetentionInDays: 14
    UpdateReplacePolicy: Retain
    DeletionPolicy: Retain
  withclusternamerestatectllambdaexecutionrole0F7FCC2E:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
        Version: '2012-10-17'
  withclusternamerestatectllambdaexecutionroleDefaultPolicy984C46E8:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 'logs:CreateLogStream'
              - 'logs:PutLogEvents'
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'arn:'
                  - Ref: 'AWS::Partition'
                  - ':logs:'
                  - Ref: 'AWS::Region'
                  - ':'
                  - Ref: 'AWS::AccountId'
                  - ':log-group:'
                  - Ref: withclusternamerestatectlloggroup03E0BF5F
                  - ':log-stream:*'
            Sid: AWSLambdaLogStreamPermissions
          - Action:
              - 'ec2:CreateNetworkInterface'
              - 'ec2:DescribeNetworkInterfaces'
              - 'ec2:DescribeSubnets'
              - 'ec2:DeleteNetworkInterface'
            Effect: Allow
            Resource: '*'
            Sid: AWSLambdaVPCWildcardPermissions
          - Action:
              - 'ec2:AssignPrivateIpAddresses'
              - 'ec2:UnassignPrivateIpAddresses'
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'arn:'
                  - Ref: 'AWS::Partition'
                  - ':ec2:'
                  - Ref: 'AWS::Region'
                  - ':'
                  - Ref: 'AWS::AccountId'
                  - ':network-interface/*'
            Sid: AWSLambdaVPCNetworkInterfacePermissions
        Version: '2012-10-17'
      PolicyName: withclusternamerestatectllambdaexecutionroleDefaultPolicy984C46E8
      Roles:
        - Ref: withclusternamerestatectllambdaexecutionrole0F7FCC2E
  withclusternamerestatectllambdaBEFE7F28:
    Type: 'AWS::Lambda::Function'
    Properties:
      Architectures:
        - arm64
      Code: Any<Object>
      Environment:
        Variables:
          RESTATECTL_ADDRESS:
            'Fn::Join':
              - ''
              - - 'http://'
                - 'Fn::GetAtt':
                    - withclusternamesharednlb8C523D9C
                    - DNSName
                - ':5122'
      Handler: restatectl
      LoggingConfig:
        LogGroup:
          Ref: withclusternamerestatectlloggroup03E0BF5F
      Role:
        'Fn::GetAtt':
          - withclusternamerestatectllambdaexecutionrole0F7FCC2E
          - Arn
      Runtime: provided.al2023
      Tags:
        - Key: Name
          Value: RestateBYOC/with-cluster-name/restatectl-lambda
      Timeout: 10
      VpcConfig:
        SecurityGroupIds:
          - 'Fn::GetAtt':
              - withclusternamesecuritygroup9A10CA11
              - GroupId
        SubnetIds:
          - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet1Subnet934893E8236E2271'
          - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet2Subnet7031C2BA60DCB1EE'
          - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet3Subnet985AC459F9514491'
    DependsOn:
      - withclusternamerestatectllambdaexecutionroleDefaultPolicy984C46E8
      - withclusternamerestatectllambdaexecutionrole0F7FCC2E
  withclusternameretirementwatcherloggroup9E8494A5:
    Type: 'AWS::Logs::LogGroup'
    Properties:
      RetentionInDays: 14
    UpdateReplacePolicy: Retain
    DeletionPolicy: Retain
  withclusternameretirementwatcherlambdaexecutionrole9364C1F9:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
        Version: '2012-10-17'
  withclusternameretirementwatcherlambdaexecutionroleDefaultPolicy7C1996BD:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 'logs:CreateLogStream'
              - 'logs:PutLogEvents'
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'arn:'
                  - Ref: 'AWS::Partition'
                  - ':logs:'
                  - Ref: 'AWS::Region'
                  - ':'
                  - Ref: 'AWS::AccountId'
                  - ':log-group:'
                  - Ref: withclusternameretirementwatcherloggroup9E8494A5
                  - ':log-stream:*'
            Sid: AWSLambdaLogStreamPermissions
          - Action: 'ecs:TagResource'
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'Fn::Join':
                      - /
                      - - 'Fn::Join':
                            - ':'
                            - - 'Fn::Select':
                                  - 0
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - withclusternamecluster8A2E876D
                                                  - Arn
                              - 'Fn::Select':
                                  - 1
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - withclusternamecluster8A2E876D
                                                  - Arn
                              - 'Fn::Select':
                                  - 2
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - withclusternamecluster8A2E876D
                                                  - Arn
                              - 'Fn::Select':
                                  - 3
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - withclusternamecluster8A2E876D
                                                  - Arn
                              - 'Fn::Select':
                                  - 4
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - withclusternamecluster8A2E876D
                                                  - Arn
                              - task
                        - 'Fn::Select':
                            - 1
                            - 'Fn::Split':
                                - /
                                - 'Fn::GetAtt':
                                    - withclusternamecluster8A2E876D
                                    - Arn
                        - ''
                  - '*'
            Sid: TagTasks
          - Action:
              - 'sqs:ReceiveMessage'
              - 'sqs:ChangeMessageVisibility'
              - 'sqs:GetQueueUrl'
              - 'sqs:DeleteMessage'
              - 'sqs:GetQueueAttributes'
            Effect: Allow
            Resource:
              'Fn::GetAtt':
                - withclusternameretirementwatcherqueue2D776989
                - Arn
        Version: '2012-10-17'
      PolicyName: withclusternameretirementwatcherlambdaexecutionroleDefaultPolicy7C1996BD
      Roles:
        - Ref: withclusternameretirementwatcherlambdaexecutionrole9364C1F9
  withclusternameretirementwatcherlambda1D4BEA71:
    Type: 'AWS::Lambda::Function'
    Properties:
      Architectures:
        - arm64
      Code: Any<Object>
      Handler: index.handler
      LoggingConfig:
        LogGroup:
          Ref: withclusternameretirementwatcherloggroup9E8494A5
      Role:
        'Fn::GetAtt':
          - withclusternameretirementwatcherlambdaexecutionrole9364C1F9
          - Arn
      Runtime: nodejs22.x
      Tags:
        - Key: Name
          Value: RestateBYOC/with-cluster-name/retirement-watcher-lambda
      Timeout: 60
    DependsOn:
      - withclusternameretirementwatcherlambdaexecutionroleDefaultPolicy7C1996BD
      - withclusternameretirementwatcherlambdaexecutionrole9364C1F9
  withclusternameretirementwatcherlambdaSqsEventSourceRestateBYOCwithclusternameretirementwatcherqueue73C8CBB7F04D7E2D:
    Type: 'AWS::Lambda::EventSourceMapping'
    Properties:
      BatchSize: 1
      EventSourceArn:
        'Fn::GetAtt':
          - withclusternameretirementwatcherqueue2D776989
          - Arn
      FunctionName:
        Ref: withclusternameretirementwatcherlambda1D4BEA71
      Tags:
        - Key: Name
          Value: RestateBYOC/with-cluster-name/retirement-watcher-lambda
  withclusternameretirementwatcherqueue2D776989:
    Type: 'AWS::SQS::Queue'
    Properties:
      Tags:
        - Key: Name
          Value: RestateBYOC/with-cluster-name/retirement-watcher-queue
      VisibilityTimeout: 60
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  withclusternameretirementwatcherqueuePolicyF36D49F3:
    Type: 'AWS::SQS::QueuePolicy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 'sqs:SendMessage'
              - 'sqs:GetQueueAttributes'
              - 'sqs:GetQueueUrl'
            Condition:
              ArnEquals:
                'aws:SourceArn':
                  'Fn::GetAtt':
                    - withclusternameretirementwatcherruleC862246D
                    - Arn
            Effect: Allow
            Principal:
              Service: events.amazonaws.com
            Resource:
              'Fn::GetAtt':
                - withclusternameretirementwatcherqueue2D776989
                - Arn
        Version: '2012-10-17'
      Queues:
        - Ref: withclusternameretirementwatcherqueue2D776989
  withclusternameretirementwatcherruleC862246D:
    Type: 'AWS::Events::Rule'
    Properties:
      EventPattern:
        detail:
          eventTypeCode:
            - equals-ignore-case: AWS_ECS_TASK_PATCHING_RETIREMENT
          service:
            - equals-ignore-case: ecs
        resources:
          - prefix:
              'Fn::Join':
                - /
                - - 'Fn::Join':
                      - ':'
                      - - 'Fn::Select':
                            - 0
                            - 'Fn::Split':
                                - ':'
                                - 'Fn::Select':
                                    - 0
                                    - 'Fn::Split':
                                        - /
                                        - 'Fn::GetAtt':
                                            - withclusternamecluster8A2E876D
                                            - Arn
                        - 'Fn::Select':
                            - 1
                            - 'Fn::Split':
                                - ':'
                                - 'Fn::Select':
                                    - 0
                                    - 'Fn::Split':
                                        - /
                                        - 'Fn::GetAtt':
                                            - withclusternamecluster8A2E876D
                                            - Arn
                        - 'Fn::Select':
                            - 2
                            - 'Fn::Split':
                                - ':'
                                - 'Fn::Select':
                                    - 0
                                    - 'Fn::Split':
                                        - /
                                        - 'Fn::GetAtt':
                                            - withclusternamecluster8A2E876D
                                            - Arn
                        - 'Fn::Select':
                            - 3
                            - 'Fn::Split':
                                - ':'
                                - 'Fn::Select':
                                    - 0
                                    - 'Fn::Split':
                                        - /
                                        - 'Fn::GetAtt':
                                            - withclusternamecluster8A2E876D
                                            - Arn
                        - 'Fn::Select':
                            - 4
                            - 'Fn::Split':
                                - ':'
                                - 'Fn::Select':
                                    - 0
                                    - 'Fn::Split':
                                        - /
                                        - 'Fn::GetAtt':
                                            - withclusternamecluster8A2E876D
                                            - Arn
                        - task
                  - 'Fn::Select':
                      - 1
                      - 'Fn::Split':
                          - /
                          - 'Fn::GetAtt':
                              - withclusternamecluster8A2E876D
                              - Arn
                  - ''
        detail-type:
          - equals-ignore-case: AWS Health Event
      State: ENABLED
      Targets:
        - Arn:
            'Fn::GetAtt':
              - withclusternameretirementwatcherqueue2D776989
              - Arn
          Id: Target0
  withclusternamecloudwatchcustomwidgetloggroup4AC45DBE:
    Type: 'AWS::Logs::LogGroup'
    Properties:
      RetentionInDays: 14
    UpdateReplacePolicy: Retain
    DeletionPolicy: Retain
  withclusternamecloudwatchcustomwidgetexecutionrole11E14880:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
        Version: '2012-10-17'
  withclusternamecloudwatchcustomwidgetexecutionroleDefaultPolicyD8E5ADCA:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 'logs:CreateLogStream'
              - 'logs:PutLogEvents'
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'arn:'
                  - Ref: 'AWS::Partition'
                  - ':logs:'
                  - Ref: 'AWS::Region'
                  - ':'
                  - Ref: 'AWS::AccountId'
                  - ':log-group:'
                  - Ref: withclusternamecloudwatchcustomwidgetloggroup4AC45DBE
                  - ':log-stream:*'
            Sid: AWSLambdaLogStreamPermissions
          - Action: 'lambda:InvokeFunction'
            Effect: Allow
            Resource:
              'Fn::GetAtt':
                - withclusternamerestatectllambdaBEFE7F28
                - Arn
            Sid: InvokeRestatectl
          - Action: 'ecs:DescribeTaskDefinition'
            Effect: Allow
            Resource: '*'
            Sid: ECSReadActions
          - Action: 'ecs:ListTasks'
            Condition:
              StringEquals:
                'ecs:cluster':
                  'Fn::GetAtt':
                    - withclusternamecluster8A2E876D
                    - Arn
            Effect: Allow
            Resource: '*'
            Sid: ECSListTasks
          - Action: 'ecs:DescribeTasks'
            Condition:
              StringEquals:
                'ecs:cluster':
                  'Fn::GetAtt':
                    - withclusternamecluster8A2E876D
                    - Arn
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'arn:'
                  - Ref: 'AWS::Partition'
                  - ':ecs:'
                  - Ref: 'AWS::Region'
                  - ':'
                  - Ref: 'AWS::AccountId'
                  - ':task/'
                  - Ref: withclusternamecluster8A2E876D
                  - /*
            Sid: ECSDescribeTasks
          - Action: 'ecs:DescribeServices'
            Condition:
              StringEquals:
                'ecs:cluster':
                  'Fn::GetAtt':
                    - withclusternamecluster8A2E876D
                    - Arn
            Effect: Allow
            Resource:
              - Ref: withclusternamecontrollerserviceService7DEFCD49
              - Ref: withclusternamestatelessserviceServiceA9323A0F
            Sid: ECSDescribeServices
          - Action: 'cloudwatch:GetMetricData'
            Effect: Allow
            Resource: '*'
            Sid: CloudWatchReadActions
        Version: '2012-10-17'
      PolicyName: withclusternamecloudwatchcustomwidgetexecutionroleDefaultPolicyD8E5ADCA
      Roles:
        - Ref: withclusternamecloudwatchcustomwidgetexecutionrole11E14880
  withclusternamecloudwatchcustomwidgetlambda3C8DD721:
    Type: 'AWS::Lambda::Function'
    Properties:
      Architectures:
        - arm64
      Code: Any<Object>
      Environment:
        Variables:
          ENABLE_EBS_VOLUMES: 'false'
      Handler: index.handler
      LoggingConfig:
        LogGroup:
          Ref: withclusternamecloudwatchcustomwidgetloggroup4AC45DBE
      MemorySize: 1024
      Role:
        'Fn::GetAtt':
          - withclusternamecloudwatchcustomwidgetexecutionrole11E14880
          - Arn
      Runtime: nodejs22.x
      Tags:
        - Key: Name
          Value: RestateBYOC/with-cluster-name/cloudwatch-custom-widget-lambda
      Timeout: 60
    DependsOn:
      - withclusternamecloudwatchcustomwidgetexecutionroleDefaultPolicyD8E5ADCA
      - withclusternamecloudwatchcustomwidgetexecutionrole11E14880
  withclusternamecloudwatchcustomwidgetlambdacloudwatchcustomwidgetlambdaallowdatasource393CC364:
    Type: 'AWS::Lambda::Permission'
    Properties:
      Action: 'lambda:InvokeFunction'
      FunctionName:
        'Fn::GetAtt':
          - withclusternamecloudwatchcustomwidgetlambda3C8DD721
          - Arn
      Principal: lambda.datasource.cloudwatch.amazonaws.com
  withclusternamemetrics035F2329:
    Type: 'AWS::CloudWatch::Dashboard'
    Properties:
      DashboardBody:
        'Fn::Join':
          - ''
          - - >-
              {"widgets":[{"type":"metric","width":12,"height":6,"x":0,"y":0,"properties":{"view":"timeSeries","title":"Stateless
              CPU","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"CPU","expression":"SELECT AVG(CpuUtilized)
              FROM SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOCwithclusternamestatelessdefinition07E62327' GROUP BY
              TaskId"}]],"annotations":{"horizontal":[{"value":16384,"label":"Limit","yAxis":"left"}]},"yAxis":{"left":{"label":"vCPUs","showUnits":false}}}},{"type":"metric","width":12,"height":6,"x":12,"y":0,"properties":{"view":"timeSeries","title":"Stateless
              Memory","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Memory","expression":"SELECT
              AVG(MemoryUtilized) FROM SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOCwithclusternamestatelessdefinition07E62327' GROUP BY
              TaskId"}]],"annotations":{"horizontal":[{"value":32768,"label":"Limit","yAxis":"left"}]},"yAxis":{"left":{"label":"MiB","showUnits":false}}}},{"type":"metric","width":12,"height":6,"x":0,"y":6,"properties":{"view":"timeSeries","title":"Stateless
              Network Tx","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Tx","expression":"SELECT
              AVG(NetworkTxBytes) FROM SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOCwithclusternamestatelessdefinition07E62327' GROUP BY
              TaskId"}]],"yAxis":{"left":{"label":"Bytes/sec","showUnits":false}}}},{"type":"metric","width":12,"height":6,"x":12,"y":6,"properties":{"view":"timeSeries","title":"Stateless
              Network Rx","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Rx","expression":"SELECT
              AVG(NetworkRxBytes) FROM SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOCwithclusternamestatelessdefinition07E62327' GROUP BY
              TaskId"}]],"yAxis":{"left":{"label":"Bytes/sec","showUnits":false}}}},{"type":"log","width":24,"height":6,"x":0,"y":12,"properties":{"view":"table","title":"Stateless
              Logs","region":"region","query":"SOURCE '
            - Ref: withclusternamerestateloggroupC9A99FB9
            - >-
              ' | fields @logStream, @timestamp, level, fields.message,
              target\\n          | sort @timestamp desc\\n          | limit
              500"}},{"type":"metric","width":12,"height":6,"x":0,"y":18,"properties":{"view":"timeSeries","title":"Stateful
              CPU","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"CPU","expression":"SELECT AVG(CpuUtilized)
              FROM SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOCwithclusternamestatefuldefinitionA7F94D22' GROUP BY
              TaskId"}]],"annotations":{"horizontal":[{"value":16384,"label":"Limit","yAxis":"left"}]},"yAxis":{"left":{"label":"vCPUs","showUnits":false}}}},{"type":"metric","width":12,"height":6,"x":12,"y":18,"properties":{"view":"timeSeries","title":"Stateful
              Memory","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Memory","expression":"SELECT
              AVG(MemoryUtilized) FROM SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOCwithclusternamestatefuldefinitionA7F94D22' GROUP BY
              TaskId"}]],"annotations":{"horizontal":[{"value":32768,"label":"Limit","yAxis":"left"}]},"yAxis":{"left":{"label":"MiB","showUnits":false}}}},{"type":"metric","width":12,"height":6,"x":0,"y":24,"properties":{"view":"timeSeries","title":"Stateful
              Network Tx","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Tx","expression":"SELECT
              AVG(NetworkTxBytes) FROM SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOCwithclusternamestatefuldefinitionA7F94D22' GROUP BY
              TaskId"}]],"yAxis":{"left":{"label":"Bytes/sec","showUnits":false}}}},{"type":"metric","width":12,"height":6,"x":12,"y":24,"properties":{"view":"timeSeries","title":"Stateful
              Network Rx","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Rx","expression":"SELECT
              AVG(NetworkRxBytes) FROM SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOCwithclusternamestatefuldefinitionA7F94D22' GROUP BY
              TaskId"}]],"yAxis":{"left":{"label":"Bytes/sec","showUnits":false}}}},{"type":"log","width":24,"height":6,"x":0,"y":30,"properties":{"view":"table","title":"Stateful
              Logs","region":"region","query":"SOURCE '
            - Ref: withclusternamerestateloggroupC9A99FB9
            - >-
              ' | fields @logStream, @timestamp, level, fields.message,
              target\\n          | sort @timestamp desc\\n          | limit
              500"}},{"type":"metric","width":8,"height":6,"x":0,"y":36,"properties":{"view":"timeSeries","title":"Ephemeral
              Volume Usage (Total size 200GiB)","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Usage","expression":"SELECT
              MAX(EphemeralStorageUtilized) FROM
              SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily) WHERE TaskDefinitionFamily =
              'RestateBYOCwithclusternamestatefuldefinitionA7F94D22'"}]],"annotations":{"horizontal":[{"value":200,"label":"Volume
              size","visible":false,"yAxis":"left"}]},"yAxis":{"left":{"label":"GiB","showUnits":false}},"liveData":false}},{"type":"metric","width":8,"height":6,"x":8,"y":36,"properties":{"view":"timeSeries","title":"Volume
              Write Throughput (Limited to 150 MiB/sec)","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Write","expression":"RATE(count) /
              1048576"}],[{"expression":"SELECT MAX(StorageWriteBytes) FROM
              SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOCwithclusternamestatefuldefinitionA7F94D22' GROUP BY
              TaskId","visible":false,"id":"count"}]],"annotations":{"horizontal":[{"value":150,"label":"Limit","visible":false,"yAxis":"left"}]},"yAxis":{"left":{"label":"MiB/sec","showUnits":false}}}},{"type":"metric","width":8,"height":6,"x":16,"y":36,"properties":{"view":"timeSeries","title":"Volume
              Read Throughput (Limited to 150 MiB/sec)","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Read","expression":"RATE(count) /
              1048576"}],[{"expression":"SELECT MAX(StorageReadBytes) FROM
              SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOCwithclusternamestatefuldefinitionA7F94D22' GROUP BY
              TaskId","visible":false,"id":"count"}]],"annotations":{"horizontal":[{"value":150,"label":"Limit","visible":false,"yAxis":"left"}]},"yAxis":{"left":{"label":"MiB/sec","showUnits":false}}}},{"type":"log","width":24,"height":6,"x":0,"y":42,"properties":{"view":"table","title":"Controller
              Logs","region":"region","query":"SOURCE '
            - Ref: withclusternamecontrollerloggroup157ABD85
            - >-
              ' | fields @logStream, @timestamp, level, fields.message,
              target\\n          | sort @timestamp desc\\n          | limit
              500"}}]}
      DashboardName: RestateBYOC_with-cluster-name_metrics
  withclusternamecontrolpanel0DA98007:
    Type: 'AWS::CloudWatch::Dashboard'
    Properties:
      DashboardBody:
        'Fn::Join':
          - ''
          - - >-
              {"widgets":[{"type":"custom","width":24,"height":26,"x":0,"y":0,"properties":{"endpoint":"
            - 'Fn::GetAtt':
                - withclusternamecloudwatchcustomwidgetlambda3C8DD721
                - Arn
            - '","params":{"command":"controlPanel","input":{"region":"'
            - Ref: 'AWS::Region'
            - >-
              ","summary":{"clusterName":"restate-byoc-cluster","restateVersion":"1.4","stackVersion":"0.4.1-dev","metricsDashboardName":"
            - Ref: withclusternamemetrics035F2329
            - '"},"resources":{"ecsClusterArn":"'
            - 'Fn::GetAtt':
                - withclusternamecluster8A2E876D
                - Arn
            - '","statelessServiceArn":"'
            - Ref: withclusternamestatelessserviceServiceA9323A0F
            - '","controllerServiceArn":"'
            - Ref: withclusternamecontrollerserviceService7DEFCD49
            - '","restatectlLambdaArn":"'
            - 'Fn::GetAtt':
                - withclusternamerestatectllambdaBEFE7F28
                - Arn
            - >-
              "},"connectivityAndSecurity":{"connectivity":{"loadBalancerArns":{"ingress":["
            - Ref: withclusternamesharednlb8C523D9C
            - '"],"admin":["'
            - Ref: withclusternamesharednlb8C523D9C
            - '"]},"addresses":{"ingress":"http://'
            - 'Fn::GetAtt':
                - withclusternamesharednlb8C523D9C
                - DNSName
            - ':8080","admin":"http://'
            - 'Fn::GetAtt':
                - withclusternamesharednlb8C523D9C
                - DNSName
            - ':9070","webUI":"http://'
            - 'Fn::GetAtt':
                - withclusternamesharednlb8C523D9C
                - DNSName
            - ':9070/ui"}},"networking":{"vpc":"'
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcA2121C384D1B3CDE'
            - '","availabilityZones":["dummy1a","dummy1b","dummy1c"],"subnets":["'
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet1Subnet934893E8236E2271'
            - '","'
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet2Subnet7031C2BA60DCB1EE'
            - '","'
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet3Subnet985AC459F9514491'
            - '"]},"security":{"securityGroups":["'
            - 'Fn::GetAtt':
                - withclusternamesecuritygroup9A10CA11
                - GroupId
            - '"]}},"storage":{"s3":{"bucket":"'
            - Ref: withclusternamebucket6214CCB0
            - >-
              "}}}},"title":"","updateOn":{"refresh":true,"resize":true,"timeRange":true}}}]}
      DashboardName: RestateBYOC_with-cluster-name_control-panel
Outputs:
  withclusternameSecurityGroups0B23FBD2:
    Description: The security group IDs of the cluster
    Value:
      'Fn::GetAtt':
        - withclusternamesecuritygroup9A10CA11
        - GroupId
  withclusternameIngressNetworkListener3CFF85D8:
    Description: The ARN of the network listener for the ingress port
    Value:
      Ref: withclusternameingresssharedlistener95E35FDA
  withclusternameIngressNetworkTargetGroupD4FC923B:
    Description: The ARN of the network target group for the ingress port
    Value:
      Ref: withclusternameingresssharedtargetB3D385F9
  withclusternameAdminNetworkListenerA948C54C:
    Description: The ARN of the network listener for the admin port
    Value:
      Ref: withclusternameadminsharedlistener9BA748D2
  withclusternameAdminNetworkTargetGroup91166891:
    Description: The ARN of the network target group for the admin port
    Value:
      Ref: withclusternameadminsharedtarget0D4BB912
  withclusternameNodeNetworkListener5BD5FF0E:
    Description: The ARN of the network listener for the node port
    Value:
      Ref: withclusternamenodesharedlistener0C52ED87
  withclusternameNodeNetworkTargetGroupF79B180F:
    Description: The ARN of the network target group for the node port
    Value:
      Ref: withclusternamenodesharedtarget977BCA3A
"
`;

exports[`BYOC With existing bucket 1`] = `
"Resources:
  withclusternamesecuritygroup9A10CA11:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      GroupDescription: RestateBYOC/with-cluster-name/security-group
      SecurityGroupEgress:
        - CidrIp: 0.0.0.0/0
          Description: Allow all outbound traffic by default
          IpProtocol: '-1'
      Tags:
        - Key: Name
          Value: RestateBYOC/with-cluster-name/security-group
      VpcId:
        'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcA2121C384D1B3CDE'
  withclusternamesecuritygroupfromRestateBYOCwithclusternamesecuritygroup775133D98080B7F12075:
    Type: 'AWS::EC2::SecurityGroupIngress'
    Properties:
      Description: 'from RestateBYOCwithclusternamesecuritygroup775133D9:8080'
      FromPort: 8080
      GroupId:
        'Fn::GetAtt':
          - withclusternamesecuritygroup9A10CA11
          - GroupId
      IpProtocol: tcp
      SourceSecurityGroupId:
        'Fn::GetAtt':
          - withclusternamesecuritygroup9A10CA11
          - GroupId
      ToPort: 8080
  withclusternamesecuritygroupfromRestateBYOCwithclusternamesecuritygroup775133D99070B88425F0:
    Type: 'AWS::EC2::SecurityGroupIngress'
    Properties:
      Description: 'from RestateBYOCwithclusternamesecuritygroup775133D9:9070'
      FromPort: 9070
      GroupId:
        'Fn::GetAtt':
          - withclusternamesecuritygroup9A10CA11
          - GroupId
      IpProtocol: tcp
      SourceSecurityGroupId:
        'Fn::GetAtt':
          - withclusternamesecuritygroup9A10CA11
          - GroupId
      ToPort: 9070
  withclusternamesecuritygroupfromRestateBYOCwithclusternamesecuritygroup775133D95122FFDE2146:
    Type: 'AWS::EC2::SecurityGroupIngress'
    Properties:
      Description: 'from RestateBYOCwithclusternamesecuritygroup775133D9:5122'
      FromPort: 5122
      GroupId:
        'Fn::GetAtt':
          - withclusternamesecuritygroup9A10CA11
          - GroupId
      IpProtocol: tcp
      SourceSecurityGroupId:
        'Fn::GetAtt':
          - withclusternamesecuritygroup9A10CA11
          - GroupId
      ToPort: 5122
  withclusternamecluster8A2E876D:
    Type: 'AWS::ECS::Cluster'
    Properties:
      ClusterSettings:
        - Name: containerInsights
          Value: enhanced
      Tags:
        - Key: Name
          Value: RestateBYOC/with-cluster-name/cluster
  withclusternamerestatetaskrole3143312B:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
        Version: '2012-10-17'
  withclusternamerestatetaskroleDefaultPolicyA64EFA38:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 's3:GetObject'
              - 's3:PutObject'
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'arn:'
                  - Ref: 'AWS::Partition'
                  - ':s3:::bucket-name/*'
            Sid: ReadWriteBucket
          - Action: 's3:ListBucket'
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'arn:'
                  - Ref: 'AWS::Partition'
                  - ':s3:::bucket-name'
            Sid: ListBucket
        Version: '2012-10-17'
      PolicyName: withclusternamerestatetaskroleDefaultPolicyA64EFA38
      Roles:
        - Ref: withclusternamerestatetaskrole3143312B
  withclusternamerestateexecutionroleEAACE718:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
        Version: '2012-10-17'
  withclusternamerestateexecutionroleDefaultPolicyEBAE444C:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 'logs:CreateLogStream'
              - 'logs:PutLogEvents'
            Effect: Allow
            Resource:
              'Fn::GetAtt':
                - withclusternamerestateloggroupC9A99FB9
                - Arn
        Version: '2012-10-17'
      PolicyName: withclusternamerestateexecutionroleDefaultPolicyEBAE444C
      Roles:
        - Ref: withclusternamerestateexecutionroleEAACE718
  withclusternamerestateloggroupC9A99FB9:
    Type: 'AWS::Logs::LogGroup'
    Properties:
      RetentionInDays: 30
    UpdateReplacePolicy: Retain
    DeletionPolicy: Retain
  withclusternamecontrollerloggroup157ABD85:
    Type: 'AWS::Logs::LogGroup'
    Properties:
      RetentionInDays: 30
    UpdateReplacePolicy: Retain
    DeletionPolicy: Retain
  withclusternamesharednlb8C523D9C:
    Type: 'AWS::ElasticLoadBalancingV2::LoadBalancer'
    Properties:
      LoadBalancerAttributes:
        - Key: deletion_protection.enabled
          Value: 'false'
        - Key: load_balancing.cross_zone.enabled
          Value: 'false'
        - Key: dns_record.client_routing_policy
          Value: availability_zone_affinity
      Scheme: internal
      SecurityGroups:
        - 'Fn::GetAtt':
            - withclusternamesecuritygroup9A10CA11
            - GroupId
      Subnets:
        - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet1Subnet934893E8236E2271'
        - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet2Subnet7031C2BA60DCB1EE'
        - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet3Subnet985AC459F9514491'
      Tags:
        - Key: Name
          Value: RestateBYOC/with-cluster-name/shared-nlb
      Type: network
  withclusternameingresssharedlistener95E35FDA:
    Type: 'AWS::ElasticLoadBalancingV2::Listener'
    Properties:
      DefaultActions:
        - TargetGroupArn:
            Ref: withclusternameingresssharedtargetB3D385F9
          Type: forward
      LoadBalancerArn:
        Ref: withclusternamesharednlb8C523D9C
      Port: 8080
      Protocol: TCP
  withclusternameadminsharedlistener9BA748D2:
    Type: 'AWS::ElasticLoadBalancingV2::Listener'
    Properties:
      DefaultActions:
        - TargetGroupArn:
            Ref: withclusternameadminsharedtarget0D4BB912
          Type: forward
      LoadBalancerArn:
        Ref: withclusternamesharednlb8C523D9C
      Port: 9070
      Protocol: TCP
  withclusternamenodesharedlistener0C52ED87:
    Type: 'AWS::ElasticLoadBalancingV2::Listener'
    Properties:
      DefaultActions:
        - TargetGroupArn:
            Ref: withclusternamenodesharedtarget977BCA3A
          Type: forward
      LoadBalancerArn:
        Ref: withclusternamesharednlb8C523D9C
      Port: 5122
      Protocol: TCP
  withclusternamestatelessdefinitionDA6BEB29:
    Type: 'AWS::ECS::TaskDefinition'
    Properties:
      ContainerDefinitions:
        - Cpu: 16384
          EntryPoint:
            - bash
            - '-c'
            - >

              curl --no-progress-meter $ECS_CONTAINER_METADATA_URI_V4 -o
              container-metadata && \\

              curl --no-progress-meter $ECS_CONTAINER_METADATA_URI_V4/task -o
              task-metadata && \\

              export \\
                RESTATE_NODE_NAME=$(jq -r '.TaskARN' task-metadata) \\
                RESTATE_LOCATION="$AWS_REGION.$(jq -r '.AvailabilityZone' task-metadata)" \\
                RESTATE_ADVERTISED_ADDRESS="http://$(jq -r '.Networks[0].IPv4Addresses[0]' container-metadata):5122"
              exec restate-server
          Environment:
            - Name: RESTATE_LOG_FORMAT
              Value: json
            - Name: RESTATE_CLUSTER_NAME
              Value: RestateBYOC/with-cluster-name
            - Name: RESTATE_ROLES
              Value: '["admin","http-ingress"]'
            - Name: RESTATE_AUTO_PROVISION
              Value: 'true'
            - Name: RESTATE_SHUTDOWN_TIMEOUT
              Value: 100s
            - Name: RESTATE_DEFAULT_NUM_PARTITIONS
              Value: '128'
            - Name: RESTATE_DEFAULT_REPLICATION
              Value: '{zone: 2}'
            - Name: RESTATE_METADATA_CLIENT__TYPE
              Value: object-store
            - Name: RESTATE_METADATA_CLIENT__PATH
              Value: 's3://bucket-name/restate/prefix/metadata'
            - Name: RESTATE_BIFROST__DEFAULT_PROVIDER
              Value: replicated
            - Name: >-
                RESTATE_INGRESS__EXPERIMENTAL_FEATURE_ENABLE_SEPARATE_INGRESS_ROLE
              Value: 'true'
            - Name: RESTATE_INGRESS__ADVERTISED_INGRESS_ENDPOINT
              Value:
                'Fn::Join':
                  - ''
                  - - 'http://'
                    - 'Fn::GetAtt':
                        - withclusternamesharednlb8C523D9C
                        - DNSName
                    - ':8080'
            - Name: RESTATE_WORKER__SNAPSHOTS__DESTINATION
              Value: 's3://bucket-name/restate/prefix/snapshots'
          Essential: true
          HealthCheck:
            Command:
              - CMD
              - curl
              - '--fail'
              - 'http://127.0.0.1:8080/restate/health'
            Interval: 30
            Retries: 3
            Timeout: 5
          Image: Any<Object>
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group:
                Ref: withclusternamerestateloggroupC9A99FB9
              awslogs-stream-prefix: restate
              awslogs-region: region
              mode: non-blocking
          Memory: 32768
          Name: restate
          PortMappings:
            - ContainerPort: 8080
              Name: ingress
              Protocol: tcp
            - ContainerPort: 9070
              Name: admin
              Protocol: tcp
            - ContainerPort: 5122
              Name: node
              Protocol: tcp
          StopTimeout: 120
      Cpu: '16384'
      ExecutionRoleArn:
        'Fn::GetAtt':
          - withclusternamerestateexecutionroleEAACE718
          - Arn
      Family: RestateBYOCwithclusternamestatelessdefinition07E62327
      Memory: '32768'
      NetworkMode: awsvpc
      RequiresCompatibilities:
        - FARGATE
      RuntimePlatform:
        CpuArchitecture: ARM64
        OperatingSystemFamily: LINUX
      Tags:
        - Key: Name
          Value: RestateBYOC/with-cluster-name/stateless-definition
      TaskRoleArn:
        'Fn::GetAtt':
          - withclusternamerestatetaskrole3143312B
          - Arn
  withclusternamestatelessserviceServiceA9323A0F:
    Type: 'AWS::ECS::Service'
    Properties:
      AvailabilityZoneRebalancing: ENABLED
      Cluster:
        Ref: withclusternamecluster8A2E876D
      DeploymentConfiguration:
        Alarms:
          AlarmNames: []
          Enable: false
          Rollback: false
        MaximumPercent: 200
        MinimumHealthyPercent: 100
      DeploymentController:
        Type: ECS
      DesiredCount: 3
      EnableECSManagedTags: false
      EnableExecuteCommand: false
      HealthCheckGracePeriodSeconds: 60
      LaunchType: FARGATE
      LoadBalancers:
        - ContainerName: restate
          ContainerPort: 8080
          TargetGroupArn:
            Ref: withclusternameingresssharedtargetB3D385F9
        - ContainerName: restate
          ContainerPort: 9070
          TargetGroupArn:
            Ref: withclusternameadminsharedtarget0D4BB912
        - ContainerName: restate
          ContainerPort: 5122
          TargetGroupArn:
            Ref: withclusternamenodesharedtarget977BCA3A
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: DISABLED
          SecurityGroups:
            - 'Fn::GetAtt':
                - withclusternamesecuritygroup9A10CA11
                - GroupId
          Subnets:
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet1Subnet934893E8236E2271'
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet2Subnet7031C2BA60DCB1EE'
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet3Subnet985AC459F9514491'
      PropagateTags: SERVICE
      Tags:
        - Key: Name
          Value: RestateBYOC/with-cluster-name/stateless-service
      TaskDefinition:
        Ref: withclusternamestatelessdefinitionDA6BEB29
    DependsOn:
      - withclusternameadminsharedlistener9BA748D2
      - withclusternameingresssharedlistener95E35FDA
      - withclusternamenodesharedlistener0C52ED87
      - withclusternamerestatetaskroleDefaultPolicyA64EFA38
      - withclusternamerestatetaskrole3143312B
  withclusternamestatefuldefinitionBAF7A571:
    Type: 'AWS::ECS::TaskDefinition'
    Properties:
      ContainerDefinitions:
        - Cpu: 16384
          EntryPoint:
            - bash
            - '-c'
            - >

              curl --no-progress-meter $ECS_CONTAINER_METADATA_URI_V4 -o
              container-metadata && \\

              curl --no-progress-meter $ECS_CONTAINER_METADATA_URI_V4/task -o
              task-metadata && \\

              export \\
                RESTATE_NODE_NAME=$(jq -r '.TaskARN' task-metadata) \\
                RESTATE_LOCATION="$AWS_REGION.$(jq -r '.AvailabilityZone' task-metadata)" \\
                RESTATE_ADVERTISED_ADDRESS="http://$(jq -r '.Networks[0].IPv4Addresses[0]' container-metadata):5122" \\
                RESTATE_ROCKSDB_TOTAL_MEMORY_SIZE="$(($(jq -r '.Limits.Memory' container-metadata) * 3 / 4))MiB" \\
                RESTATE_WORKER__STORAGE__NUM_PARTITIONS_TO_SHARE_MEMORY_BUDGET=$(("$RESTATE_WORKER__STORAGE__NUM_PARTITIONS_TO_SHARE_MEMORY_BUDGET"))
              exec restate-server
          Environment:
            - Name: RESTATE_LOG_FORMAT
              Value: json
            - Name: RESTATE_CLUSTER_NAME
              Value: RestateBYOC/with-cluster-name
            - Name: RESTATE_ROLES
              Value: '["log-server", "worker"]'
            - Name: RESTATE_AUTO_PROVISION
              Value: 'false'
            - Name: RESTATE_SHUTDOWN_TIMEOUT
              Value: 100s
            - Name: RESTATE_METADATA_CLIENT__TYPE
              Value: object-store
            - Name: RESTATE_METADATA_CLIENT__PATH
              Value: 's3://bucket-name/restate/prefix/metadata'
            - Name: RESTATE_WORKER__SNAPSHOTS__DESTINATION
              Value: 's3://bucket-name/restate/prefix/snapshots'
            - Name: RESTATE_WORKER__SNAPSHOTS__SNAPSHOT_INTERVAL_NUM_RECORDS
              Value: '1000000'
            - Name: RESTATE_WORKER__STORAGE__ROCKSDB_DISABLE_DIRECT_IO_FOR_READS
              Value: 'true'
            - Name: RESTATE_WORKER__STORAGE__ROCKSDB_DISABLE_WAL_FSYNC
              Value: 'true'
            - Name: RESTATE_WORKER__STORAGE__NUM_PARTITIONS_TO_SHARE_MEMORY_BUDGET
              Value: (128 * 2) / (3 * 1)
            - Name: RESTATE_LOG_SERVER__ROCKSDB_DISABLE_WAL_FSYNC
              Value: 'true'
            - Name: RESTATE_LOG_SERVER__ROCKSDB_DISABLE_DIRECT_IO_FOR_READS
              Value: 'true'
            - Name: >-
                RESTATE_INGRESS__EXPERIMENTAL_FEATURE_ENABLE_SEPARATE_INGRESS_ROLE
              Value: 'true'
          Essential: true
          HealthCheck:
            Command:
              - CMD
              - curl
              - '--fail'
              - 'http://127.0.0.1:5122/health'
            Interval: 30
            Retries: 3
            Timeout: 5
          Image: Any<Object>
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group:
                Ref: withclusternamerestateloggroupC9A99FB9
              awslogs-stream-prefix: restate
              awslogs-region: region
              mode: non-blocking
          Memory: 32768
          MountPoints:
            - ContainerPath: /restate-data
              ReadOnly: false
              SourceVolume: restate-data
          Name: restate
          PortMappings:
            - ContainerPort: 5122
              Name: node
              Protocol: tcp
          RestartPolicy:
            Enabled: true
            RestartAttemptPeriod: 60
          StopTimeout: 120
      Cpu: '16384'
      EphemeralStorage:
        SizeInGiB: 200
      ExecutionRoleArn:
        'Fn::GetAtt':
          - withclusternamerestateexecutionroleEAACE718
          - Arn
      Family: RestateBYOCwithclusternamestatefuldefinitionA7F94D22
      Memory: '32768'
      NetworkMode: awsvpc
      RequiresCompatibilities:
        - FARGATE
      RuntimePlatform:
        CpuArchitecture: ARM64
        OperatingSystemFamily: LINUX
      Tags:
        - Key: Name
          Value: RestateBYOC/with-cluster-name/stateful-definition
      TaskRoleArn:
        'Fn::GetAtt':
          - withclusternamerestatetaskrole3143312B
          - Arn
      Volumes:
        - ConfiguredAtLaunch: false
          Name: restate-data
  withclusternameingresssharedtargetB3D385F9:
    Type: 'AWS::ElasticLoadBalancingV2::TargetGroup'
    Properties:
      HealthCheckEnabled: true
      HealthCheckIntervalSeconds: 5
      HealthCheckPath: /restate/health
      HealthCheckProtocol: HTTP
      HealthCheckTimeoutSeconds: 2
      Port: 8080
      Protocol: TCP
      Tags:
        - Key: Name
          Value: RestateBYOC/with-cluster-name/ingress-shared-target
      TargetType: ip
      VpcId:
        'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcA2121C384D1B3CDE'
  withclusternameadminsharedtarget0D4BB912:
    Type: 'AWS::ElasticLoadBalancingV2::TargetGroup'
    Properties:
      HealthCheckEnabled: true
      HealthCheckIntervalSeconds: 5
      HealthCheckPath: /health
      HealthCheckPort: '9070'
      HealthCheckProtocol: HTTP
      HealthCheckTimeoutSeconds: 2
      Port: 9070
      Protocol: TCP
      Tags:
        - Key: Name
          Value: RestateBYOC/with-cluster-name/admin-shared-target
      TargetType: ip
      VpcId:
        'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcA2121C384D1B3CDE'
  withclusternamenodesharedtarget977BCA3A:
    Type: 'AWS::ElasticLoadBalancingV2::TargetGroup'
    Properties:
      HealthCheckEnabled: true
      HealthCheckIntervalSeconds: 5
      HealthCheckPath: /health
      HealthCheckPort: '5122'
      HealthCheckProtocol: HTTP
      HealthCheckTimeoutSeconds: 2
      Port: 5122
      Protocol: TCP
      Tags:
        - Key: Name
          Value: RestateBYOC/with-cluster-name/node-shared-target
      TargetType: ip
      VpcId:
        'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcA2121C384D1B3CDE'
  withclusternamecontrollertaskroleD965AFAA:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
        Version: '2012-10-17'
  withclusternamecontrollertaskroleDefaultPolicy54BC385C:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action: 'ecs:ListTasks'
            Condition:
              ArnEquals:
                'ecs:cluster':
                  'Fn::GetAtt':
                    - withclusternamecluster8A2E876D
                    - Arn
            Effect: Allow
            Resource: '*'
            Sid: ECSListActions
          - Action:
              - 'ecs:TagResource'
              - 'ecs:DescribeTasks'
              - 'ecs:StopTask'
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'Fn::Join':
                      - /
                      - - 'Fn::Join':
                            - ':'
                            - - 'Fn::Select':
                                  - 0
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - withclusternamecluster8A2E876D
                                                  - Arn
                              - 'Fn::Select':
                                  - 1
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - withclusternamecluster8A2E876D
                                                  - Arn
                              - 'Fn::Select':
                                  - 2
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - withclusternamecluster8A2E876D
                                                  - Arn
                              - 'Fn::Select':
                                  - 3
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - withclusternamecluster8A2E876D
                                                  - Arn
                              - 'Fn::Select':
                                  - 4
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - withclusternamecluster8A2E876D
                                                  - Arn
                              - task
                        - 'Fn::Select':
                            - 1
                            - 'Fn::Split':
                                - /
                                - 'Fn::GetAtt':
                                    - withclusternamecluster8A2E876D
                                    - Arn
                        - ''
                  - '*'
            Sid: TaskActions
          - Action: 'ecs:RunTask'
            Condition:
              ArnEquals:
                'ecs:cluster':
                  'Fn::GetAtt':
                    - withclusternamecluster8A2E876D
                    - Arn
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'Fn::Join':
                      - ':'
                      - - 'Fn::Select':
                            - 0
                            - 'Fn::Split':
                                - ':'
                                - Ref: withclusternamestatefuldefinitionBAF7A571
                        - 'Fn::Select':
                            - 1
                            - 'Fn::Split':
                                - ':'
                                - Ref: withclusternamestatefuldefinitionBAF7A571
                        - 'Fn::Select':
                            - 2
                            - 'Fn::Split':
                                - ':'
                                - Ref: withclusternamestatefuldefinitionBAF7A571
                        - 'Fn::Select':
                            - 3
                            - 'Fn::Split':
                                - ':'
                                - Ref: withclusternamestatefuldefinitionBAF7A571
                        - 'Fn::Select':
                            - 4
                            - 'Fn::Split':
                                - ':'
                                - Ref: withclusternamestatefuldefinitionBAF7A571
                        - 'Fn::Select':
                            - 5
                            - 'Fn::Split':
                                - ':'
                                - Ref: withclusternamestatefuldefinitionBAF7A571
                  - ':*'
            Sid: RunTask
          - Action: 'iam:PassRole'
            Condition:
              StringEquals:
                'iam:PassedToService': ecs-tasks.amazonaws.com
            Effect: Allow
            Resource:
              - 'Fn::GetAtt':
                  - withclusternamerestatetaskrole3143312B
                  - Arn
              - 'Fn::GetAtt':
                  - withclusternamerestateexecutionroleEAACE718
                  - Arn
            Sid: RunTaskPassRole
          - Action:
              - 'ec2:DescribeVolumes'
              - 'ec2:DescribeSnapshots'
            Effect: Allow
            Resource: '*'
            Sid: EC2ListActions
          - Action: 'ec2:CreateSnapshot'
            Condition:
              ArnEquals:
                'aws:RequestTag/restate:ecsClusterArn':
                  'Fn::GetAtt':
                    - withclusternamecluster8A2E876D
                    - Arn
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'arn:'
                  - Ref: 'AWS::Partition'
                  - ':ec2:'
                  - Ref: 'AWS::Region'
                  - '::snapshot/*'
            Sid: CreateSnapshot
          - Action: 'ec2:CreateSnapshot'
            Condition:
              ArnEquals:
                'aws:ResourceTag/restate:ecsClusterArn':
                  'Fn::GetAtt':
                    - withclusternamecluster8A2E876D
                    - Arn
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'arn:'
                  - Ref: 'AWS::Partition'
                  - ':ec2:'
                  - Ref: 'AWS::Region'
                  - ':'
                  - Ref: 'AWS::AccountId'
                  - ':volume/*'
            Sid: SnapshotVolume
          - Action: 'ec2:CreateTags'
            Condition:
              StringEquals:
                'ec2:CreateAction': CreateSnapshot
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'arn:'
                  - Ref: 'AWS::Partition'
                  - ':ec2:'
                  - Ref: 'AWS::Region'
                  - '::snapshot/*'
            Sid: TagSnapshots
          - Action:
              - 'ec2:DeleteVolume'
              - 'ec2:DeleteSnapshot'
            Condition:
              ArnEquals:
                'aws:ResourceTag/restate:ecsClusterArn':
                  'Fn::GetAtt':
                    - withclusternamecluster8A2E876D
                    - Arn
            Effect: Allow
            Resource:
              - 'Fn::Join':
                  - ''
                  - - 'arn:'
                    - Ref: 'AWS::Partition'
                    - ':ec2:'
                    - Ref: 'AWS::Region'
                    - ':'
                    - Ref: 'AWS::AccountId'
                    - ':volume/*'
              - 'Fn::Join':
                  - ''
                  - - 'arn:'
                    - Ref: 'AWS::Partition'
                    - ':ec2:'
                    - Ref: 'AWS::Region'
                    - '::snapshot/*'
            Sid: DeleteVolumeAndSnapshot
          - Action:
              - 's3:GetObject'
              - 's3:PutObject'
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'arn:'
                  - Ref: 'AWS::Partition'
                  - ':s3:::bucket-name/*'
            Sid: ReadWriteBucket
          - Action: 's3:ListBucket'
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'arn:'
                  - Ref: 'AWS::Partition'
                  - ':s3:::bucket-name'
            Sid: ListBucket
        Version: '2012-10-17'
      PolicyName: withclusternamecontrollertaskroleDefaultPolicy54BC385C
      Roles:
        - Ref: withclusternamecontrollertaskroleD965AFAA
  withclusternamecontrollerexecutionroleA7855798:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
        Version: '2012-10-17'
  withclusternamecontrollerexecutionroleDefaultPolicy352367F7:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 'logs:CreateLogStream'
              - 'logs:PutLogEvents'
            Effect: Allow
            Resource:
              'Fn::GetAtt':
                - withclusternamecontrollerloggroup157ABD85
                - Arn
        Version: '2012-10-17'
      PolicyName: withclusternamecontrollerexecutionroleDefaultPolicy352367F7
      Roles:
        - Ref: withclusternamecontrollerexecutionroleA7855798
  withclusternamecontrollerdefinitionAFF92F56:
    Type: 'AWS::ECS::TaskDefinition'
    Properties:
      ContainerDefinitions:
        - Cpu: 1024
          Environment:
            - Name: RUST_LOG
              Value: 'info,restate_fargate_controller=debug'
            - Name: CONTROLLER_LOG_FORMAT
              Value: json
            - Name: CONTROLLER_METADATA_PATH
              Value: 's3://bucket-name/restate/prefix/metadata'
            - Name: CONTROLLER_RECONCILE_INTERVAL
              Value: 10s
            - Name: CONTROLLER_CLUSTER__CLUSTER_ARN
              Value:
                'Fn::GetAtt':
                  - withclusternamecluster8A2E876D
                  - Arn
            - Name: CONTROLLER_LICENSE_KEY
              Value: foo
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __REGION
              Value:
                Ref: 'AWS::Region'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __CLUSTER_ARN
              Value:
                'Fn::GetAtt':
                  - withclusternamecluster8A2E876D
                  - Arn
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __TASK_PREFIX
              Value:
                'Fn::Join':
                  - /
                  - - 'Fn::Join':
                        - ':'
                        - - 'Fn::Select':
                              - 0
                              - 'Fn::Split':
                                  - ':'
                                  - 'Fn::Select':
                                      - 0
                                      - 'Fn::Split':
                                          - /
                                          - 'Fn::GetAtt':
                                              - withclusternamecluster8A2E876D
                                              - Arn
                          - 'Fn::Select':
                              - 1
                              - 'Fn::Split':
                                  - ':'
                                  - 'Fn::Select':
                                      - 0
                                      - 'Fn::Split':
                                          - /
                                          - 'Fn::GetAtt':
                                              - withclusternamecluster8A2E876D
                                              - Arn
                          - 'Fn::Select':
                              - 2
                              - 'Fn::Split':
                                  - ':'
                                  - 'Fn::Select':
                                      - 0
                                      - 'Fn::Split':
                                          - /
                                          - 'Fn::GetAtt':
                                              - withclusternamecluster8A2E876D
                                              - Arn
                          - 'Fn::Select':
                              - 3
                              - 'Fn::Split':
                                  - ':'
                                  - 'Fn::Select':
                                      - 0
                                      - 'Fn::Split':
                                          - /
                                          - 'Fn::GetAtt':
                                              - withclusternamecluster8A2E876D
                                              - Arn
                          - 'Fn::Select':
                              - 4
                              - 'Fn::Split':
                                  - ':'
                                  - 'Fn::Select':
                                      - 0
                                      - 'Fn::Split':
                                          - /
                                          - 'Fn::GetAtt':
                                              - withclusternamecluster8A2E876D
                                              - Arn
                          - task
                    - 'Fn::Select':
                        - 1
                        - 'Fn::Split':
                            - /
                            - 'Fn::GetAtt':
                                - withclusternamecluster8A2E876D
                                - Arn
                    - ''
            - Name: CONTROLLER_EBS_SNAPSHOT_RETENTION_PERIOD
              Value: 24h
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1a__ENABLE_EXECUTE_COMMAND
              Value: 'false'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1a__SECURITY_GROUPS
              Value:
                'Fn::Join':
                  - ''
                  - - '["'
                    - 'Fn::GetAtt':
                        - withclusternamesecuritygroup9A10CA11
                        - GroupId
                    - '"]'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1a__SUBNETS
              Value:
                'Fn::Join':
                  - ''
                  - - '["'
                    - 'Fn::ImportValue': >-
                        VPCStack:ExportsOutputRefvpcPrivateSubnet1Subnet934893E8236E2271
                    - '"]'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1a__TASK_DEFINITION_ARN
              Value:
                Ref: withclusternamestatefuldefinitionBAF7A571
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1a__COUNT
              Value: '1'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1b__ENABLE_EXECUTE_COMMAND
              Value: 'false'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1b__SECURITY_GROUPS
              Value:
                'Fn::Join':
                  - ''
                  - - '["'
                    - 'Fn::GetAtt':
                        - withclusternamesecuritygroup9A10CA11
                        - GroupId
                    - '"]'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1b__SUBNETS
              Value:
                'Fn::Join':
                  - ''
                  - - '["'
                    - 'Fn::ImportValue': >-
                        VPCStack:ExportsOutputRefvpcPrivateSubnet2Subnet7031C2BA60DCB1EE
                    - '"]'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1b__TASK_DEFINITION_ARN
              Value:
                Ref: withclusternamestatefuldefinitionBAF7A571
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1b__COUNT
              Value: '1'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1c__ENABLE_EXECUTE_COMMAND
              Value: 'false'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1c__SECURITY_GROUPS
              Value:
                'Fn::Join':
                  - ''
                  - - '["'
                    - 'Fn::GetAtt':
                        - withclusternamesecuritygroup9A10CA11
                        - GroupId
                    - '"]'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1c__SUBNETS
              Value:
                'Fn::Join':
                  - ''
                  - - '["'
                    - 'Fn::ImportValue': >-
                        VPCStack:ExportsOutputRefvpcPrivateSubnet3Subnet985AC459F9514491
                    - '"]'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1c__TASK_DEFINITION_ARN
              Value:
                Ref: withclusternamestatefuldefinitionBAF7A571
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1c__COUNT
              Value: '1'
          Essential: true
          HealthCheck:
            Command:
              - CMD
              - curl
              - '--fail'
              - 'http://127.0.0.1:8080/health'
            Interval: 30
            Retries: 10
            StartPeriod: 300
            Timeout: 5
          Image: Any<Object>
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group:
                Ref: withclusternamecontrollerloggroup157ABD85
              awslogs-stream-prefix: controller
              awslogs-region: region
              mode: non-blocking
          Memory: 2048
          Name: controller
          StopTimeout: 120
      Cpu: '1024'
      ExecutionRoleArn:
        'Fn::GetAtt':
          - withclusternamecontrollerexecutionroleA7855798
          - Arn
      Family: RestateBYOCwithclusternamecontrollerdefinition332A4808
      Memory: '2048'
      NetworkMode: awsvpc
      RequiresCompatibilities:
        - FARGATE
      RuntimePlatform:
        CpuArchitecture: ARM64
        OperatingSystemFamily: LINUX
      Tags:
        - Key: Name
          Value: RestateBYOC/with-cluster-name/controller-definition
      TaskRoleArn:
        'Fn::GetAtt':
          - withclusternamecontrollertaskroleD965AFAA
          - Arn
  withclusternamecontrollerserviceService7DEFCD49:
    Type: 'AWS::ECS::Service'
    Properties:
      Cluster:
        Ref: withclusternamecluster8A2E876D
      DeploymentConfiguration:
        Alarms:
          AlarmNames: []
          Enable: false
          Rollback: false
        MaximumPercent: 100
        MinimumHealthyPercent: 0
      DeploymentController:
        Type: ECS
      DesiredCount: 1
      EnableECSManagedTags: false
      EnableExecuteCommand: false
      LaunchType: FARGATE
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: DISABLED
          SecurityGroups:
            - 'Fn::GetAtt':
                - withclusternamesecuritygroup9A10CA11
                - GroupId
          Subnets:
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet1Subnet934893E8236E2271'
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet2Subnet7031C2BA60DCB1EE'
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet3Subnet985AC459F9514491'
      Tags:
        - Key: Name
          Value: RestateBYOC/with-cluster-name/controller-service
      TaskDefinition:
        Ref: withclusternamecontrollerdefinitionAFF92F56
    DependsOn:
      - withclusternamecontrollertaskroleDefaultPolicy54BC385C
      - withclusternamecontrollertaskroleD965AFAA
  withclusternamerestatectlloggroup03E0BF5F:
    Type: 'AWS::Logs::LogGroup'
    Properties:
      RetentionInDays: 14
    UpdateReplacePolicy: Retain
    DeletionPolicy: Retain
  withclusternamerestatectllambdaexecutionrole0F7FCC2E:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
        Version: '2012-10-17'
  withclusternamerestatectllambdaexecutionroleDefaultPolicy984C46E8:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 'logs:CreateLogStream'
              - 'logs:PutLogEvents'
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'arn:'
                  - Ref: 'AWS::Partition'
                  - ':logs:'
                  - Ref: 'AWS::Region'
                  - ':'
                  - Ref: 'AWS::AccountId'
                  - ':log-group:'
                  - Ref: withclusternamerestatectlloggroup03E0BF5F
                  - ':log-stream:*'
            Sid: AWSLambdaLogStreamPermissions
          - Action:
              - 'ec2:CreateNetworkInterface'
              - 'ec2:DescribeNetworkInterfaces'
              - 'ec2:DescribeSubnets'
              - 'ec2:DeleteNetworkInterface'
            Effect: Allow
            Resource: '*'
            Sid: AWSLambdaVPCWildcardPermissions
          - Action:
              - 'ec2:AssignPrivateIpAddresses'
              - 'ec2:UnassignPrivateIpAddresses'
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'arn:'
                  - Ref: 'AWS::Partition'
                  - ':ec2:'
                  - Ref: 'AWS::Region'
                  - ':'
                  - Ref: 'AWS::AccountId'
                  - ':network-interface/*'
            Sid: AWSLambdaVPCNetworkInterfacePermissions
        Version: '2012-10-17'
      PolicyName: withclusternamerestatectllambdaexecutionroleDefaultPolicy984C46E8
      Roles:
        - Ref: withclusternamerestatectllambdaexecutionrole0F7FCC2E
  withclusternamerestatectllambdaBEFE7F28:
    Type: 'AWS::Lambda::Function'
    Properties:
      Architectures:
        - arm64
      Code: Any<Object>
      Environment:
        Variables:
          RESTATECTL_ADDRESS:
            'Fn::Join':
              - ''
              - - 'http://'
                - 'Fn::GetAtt':
                    - withclusternamesharednlb8C523D9C
                    - DNSName
                - ':5122'
      Handler: restatectl
      LoggingConfig:
        LogGroup:
          Ref: withclusternamerestatectlloggroup03E0BF5F
      Role:
        'Fn::GetAtt':
          - withclusternamerestatectllambdaexecutionrole0F7FCC2E
          - Arn
      Runtime: provided.al2023
      Tags:
        - Key: Name
          Value: RestateBYOC/with-cluster-name/restatectl-lambda
      Timeout: 10
      VpcConfig:
        SecurityGroupIds:
          - 'Fn::GetAtt':
              - withclusternamesecuritygroup9A10CA11
              - GroupId
        SubnetIds:
          - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet1Subnet934893E8236E2271'
          - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet2Subnet7031C2BA60DCB1EE'
          - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet3Subnet985AC459F9514491'
    DependsOn:
      - withclusternamerestatectllambdaexecutionroleDefaultPolicy984C46E8
      - withclusternamerestatectllambdaexecutionrole0F7FCC2E
  withclusternameretirementwatcherloggroup9E8494A5:
    Type: 'AWS::Logs::LogGroup'
    Properties:
      RetentionInDays: 14
    UpdateReplacePolicy: Retain
    DeletionPolicy: Retain
  withclusternameretirementwatcherlambdaexecutionrole9364C1F9:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
        Version: '2012-10-17'
  withclusternameretirementwatcherlambdaexecutionroleDefaultPolicy7C1996BD:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 'logs:CreateLogStream'
              - 'logs:PutLogEvents'
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'arn:'
                  - Ref: 'AWS::Partition'
                  - ':logs:'
                  - Ref: 'AWS::Region'
                  - ':'
                  - Ref: 'AWS::AccountId'
                  - ':log-group:'
                  - Ref: withclusternameretirementwatcherloggroup9E8494A5
                  - ':log-stream:*'
            Sid: AWSLambdaLogStreamPermissions
          - Action: 'ecs:TagResource'
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'Fn::Join':
                      - /
                      - - 'Fn::Join':
                            - ':'
                            - - 'Fn::Select':
                                  - 0
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - withclusternamecluster8A2E876D
                                                  - Arn
                              - 'Fn::Select':
                                  - 1
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - withclusternamecluster8A2E876D
                                                  - Arn
                              - 'Fn::Select':
                                  - 2
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - withclusternamecluster8A2E876D
                                                  - Arn
                              - 'Fn::Select':
                                  - 3
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - withclusternamecluster8A2E876D
                                                  - Arn
                              - 'Fn::Select':
                                  - 4
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - withclusternamecluster8A2E876D
                                                  - Arn
                              - task
                        - 'Fn::Select':
                            - 1
                            - 'Fn::Split':
                                - /
                                - 'Fn::GetAtt':
                                    - withclusternamecluster8A2E876D
                                    - Arn
                        - ''
                  - '*'
            Sid: TagTasks
          - Action:
              - 'sqs:ReceiveMessage'
              - 'sqs:ChangeMessageVisibility'
              - 'sqs:GetQueueUrl'
              - 'sqs:DeleteMessage'
              - 'sqs:GetQueueAttributes'
            Effect: Allow
            Resource:
              'Fn::GetAtt':
                - withclusternameretirementwatcherqueue2D776989
                - Arn
        Version: '2012-10-17'
      PolicyName: withclusternameretirementwatcherlambdaexecutionroleDefaultPolicy7C1996BD
      Roles:
        - Ref: withclusternameretirementwatcherlambdaexecutionrole9364C1F9
  withclusternameretirementwatcherlambda1D4BEA71:
    Type: 'AWS::Lambda::Function'
    Properties:
      Architectures:
        - arm64
      Code: Any<Object>
      Handler: index.handler
      LoggingConfig:
        LogGroup:
          Ref: withclusternameretirementwatcherloggroup9E8494A5
      Role:
        'Fn::GetAtt':
          - withclusternameretirementwatcherlambdaexecutionrole9364C1F9
          - Arn
      Runtime: nodejs22.x
      Tags:
        - Key: Name
          Value: RestateBYOC/with-cluster-name/retirement-watcher-lambda
      Timeout: 60
    DependsOn:
      - withclusternameretirementwatcherlambdaexecutionroleDefaultPolicy7C1996BD
      - withclusternameretirementwatcherlambdaexecutionrole9364C1F9
  withclusternameretirementwatcherlambdaSqsEventSourceRestateBYOCwithclusternameretirementwatcherqueue73C8CBB7F04D7E2D:
    Type: 'AWS::Lambda::EventSourceMapping'
    Properties:
      BatchSize: 1
      EventSourceArn:
        'Fn::GetAtt':
          - withclusternameretirementwatcherqueue2D776989
          - Arn
      FunctionName:
        Ref: withclusternameretirementwatcherlambda1D4BEA71
      Tags:
        - Key: Name
          Value: RestateBYOC/with-cluster-name/retirement-watcher-lambda
  withclusternameretirementwatcherqueue2D776989:
    Type: 'AWS::SQS::Queue'
    Properties:
      Tags:
        - Key: Name
          Value: RestateBYOC/with-cluster-name/retirement-watcher-queue
      VisibilityTimeout: 60
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  withclusternameretirementwatcherqueuePolicyF36D49F3:
    Type: 'AWS::SQS::QueuePolicy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 'sqs:SendMessage'
              - 'sqs:GetQueueAttributes'
              - 'sqs:GetQueueUrl'
            Condition:
              ArnEquals:
                'aws:SourceArn':
                  'Fn::GetAtt':
                    - withclusternameretirementwatcherruleC862246D
                    - Arn
            Effect: Allow
            Principal:
              Service: events.amazonaws.com
            Resource:
              'Fn::GetAtt':
                - withclusternameretirementwatcherqueue2D776989
                - Arn
        Version: '2012-10-17'
      Queues:
        - Ref: withclusternameretirementwatcherqueue2D776989
  withclusternameretirementwatcherruleC862246D:
    Type: 'AWS::Events::Rule'
    Properties:
      EventPattern:
        detail:
          eventTypeCode:
            - equals-ignore-case: AWS_ECS_TASK_PATCHING_RETIREMENT
          service:
            - equals-ignore-case: ecs
        resources:
          - prefix:
              'Fn::Join':
                - /
                - - 'Fn::Join':
                      - ':'
                      - - 'Fn::Select':
                            - 0
                            - 'Fn::Split':
                                - ':'
                                - 'Fn::Select':
                                    - 0
                                    - 'Fn::Split':
                                        - /
                                        - 'Fn::GetAtt':
                                            - withclusternamecluster8A2E876D
                                            - Arn
                        - 'Fn::Select':
                            - 1
                            - 'Fn::Split':
                                - ':'
                                - 'Fn::Select':
                                    - 0
                                    - 'Fn::Split':
                                        - /
                                        - 'Fn::GetAtt':
                                            - withclusternamecluster8A2E876D
                                            - Arn
                        - 'Fn::Select':
                            - 2
                            - 'Fn::Split':
                                - ':'
                                - 'Fn::Select':
                                    - 0
                                    - 'Fn::Split':
                                        - /
                                        - 'Fn::GetAtt':
                                            - withclusternamecluster8A2E876D
                                            - Arn
                        - 'Fn::Select':
                            - 3
                            - 'Fn::Split':
                                - ':'
                                - 'Fn::Select':
                                    - 0
                                    - 'Fn::Split':
                                        - /
                                        - 'Fn::GetAtt':
                                            - withclusternamecluster8A2E876D
                                            - Arn
                        - 'Fn::Select':
                            - 4
                            - 'Fn::Split':
                                - ':'
                                - 'Fn::Select':
                                    - 0
                                    - 'Fn::Split':
                                        - /
                                        - 'Fn::GetAtt':
                                            - withclusternamecluster8A2E876D
                                            - Arn
                        - task
                  - 'Fn::Select':
                      - 1
                      - 'Fn::Split':
                          - /
                          - 'Fn::GetAtt':
                              - withclusternamecluster8A2E876D
                              - Arn
                  - ''
        detail-type:
          - equals-ignore-case: AWS Health Event
      State: ENABLED
      Targets:
        - Arn:
            'Fn::GetAtt':
              - withclusternameretirementwatcherqueue2D776989
              - Arn
          Id: Target0
  withclusternamecloudwatchcustomwidgetloggroup4AC45DBE:
    Type: 'AWS::Logs::LogGroup'
    Properties:
      RetentionInDays: 14
    UpdateReplacePolicy: Retain
    DeletionPolicy: Retain
  withclusternamecloudwatchcustomwidgetexecutionrole11E14880:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
        Version: '2012-10-17'
  withclusternamecloudwatchcustomwidgetexecutionroleDefaultPolicyD8E5ADCA:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 'logs:CreateLogStream'
              - 'logs:PutLogEvents'
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'arn:'
                  - Ref: 'AWS::Partition'
                  - ':logs:'
                  - Ref: 'AWS::Region'
                  - ':'
                  - Ref: 'AWS::AccountId'
                  - ':log-group:'
                  - Ref: withclusternamecloudwatchcustomwidgetloggroup4AC45DBE
                  - ':log-stream:*'
            Sid: AWSLambdaLogStreamPermissions
          - Action: 'lambda:InvokeFunction'
            Effect: Allow
            Resource:
              'Fn::GetAtt':
                - withclusternamerestatectllambdaBEFE7F28
                - Arn
            Sid: InvokeRestatectl
          - Action: 'ecs:DescribeTaskDefinition'
            Effect: Allow
            Resource: '*'
            Sid: ECSReadActions
          - Action: 'ecs:ListTasks'
            Condition:
              StringEquals:
                'ecs:cluster':
                  'Fn::GetAtt':
                    - withclusternamecluster8A2E876D
                    - Arn
            Effect: Allow
            Resource: '*'
            Sid: ECSListTasks
          - Action: 'ecs:DescribeTasks'
            Condition:
              StringEquals:
                'ecs:cluster':
                  'Fn::GetAtt':
                    - withclusternamecluster8A2E876D
                    - Arn
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'arn:'
                  - Ref: 'AWS::Partition'
                  - ':ecs:'
                  - Ref: 'AWS::Region'
                  - ':'
                  - Ref: 'AWS::AccountId'
                  - ':task/'
                  - Ref: withclusternamecluster8A2E876D
                  - /*
            Sid: ECSDescribeTasks
          - Action: 'ecs:DescribeServices'
            Condition:
              StringEquals:
                'ecs:cluster':
                  'Fn::GetAtt':
                    - withclusternamecluster8A2E876D
                    - Arn
            Effect: Allow
            Resource:
              - Ref: withclusternamecontrollerserviceService7DEFCD49
              - Ref: withclusternamestatelessserviceServiceA9323A0F
            Sid: ECSDescribeServices
          - Action: 'cloudwatch:GetMetricData'
            Effect: Allow
            Resource: '*'
            Sid: CloudWatchReadActions
        Version: '2012-10-17'
      PolicyName: withclusternamecloudwatchcustomwidgetexecutionroleDefaultPolicyD8E5ADCA
      Roles:
        - Ref: withclusternamecloudwatchcustomwidgetexecutionrole11E14880
  withclusternamecloudwatchcustomwidgetlambda3C8DD721:
    Type: 'AWS::Lambda::Function'
    Properties:
      Architectures:
        - arm64
      Code: Any<Object>
      Environment:
        Variables:
          ENABLE_EBS_VOLUMES: 'false'
      Handler: index.handler
      LoggingConfig:
        LogGroup:
          Ref: withclusternamecloudwatchcustomwidgetloggroup4AC45DBE
      MemorySize: 1024
      Role:
        'Fn::GetAtt':
          - withclusternamecloudwatchcustomwidgetexecutionrole11E14880
          - Arn
      Runtime: nodejs22.x
      Tags:
        - Key: Name
          Value: RestateBYOC/with-cluster-name/cloudwatch-custom-widget-lambda
      Timeout: 60
    DependsOn:
      - withclusternamecloudwatchcustomwidgetexecutionroleDefaultPolicyD8E5ADCA
      - withclusternamecloudwatchcustomwidgetexecutionrole11E14880
  withclusternamecloudwatchcustomwidgetlambdacloudwatchcustomwidgetlambdaallowdatasource393CC364:
    Type: 'AWS::Lambda::Permission'
    Properties:
      Action: 'lambda:InvokeFunction'
      FunctionName:
        'Fn::GetAtt':
          - withclusternamecloudwatchcustomwidgetlambda3C8DD721
          - Arn
      Principal: lambda.datasource.cloudwatch.amazonaws.com
  withclusternamemetrics035F2329:
    Type: 'AWS::CloudWatch::Dashboard'
    Properties:
      DashboardBody:
        'Fn::Join':
          - ''
          - - >-
              {"widgets":[{"type":"metric","width":12,"height":6,"x":0,"y":0,"properties":{"view":"timeSeries","title":"Stateless
              CPU","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"CPU","expression":"SELECT AVG(CpuUtilized)
              FROM SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOCwithclusternamestatelessdefinition07E62327' GROUP BY
              TaskId"}]],"annotations":{"horizontal":[{"value":16384,"label":"Limit","yAxis":"left"}]},"yAxis":{"left":{"label":"vCPUs","showUnits":false}}}},{"type":"metric","width":12,"height":6,"x":12,"y":0,"properties":{"view":"timeSeries","title":"Stateless
              Memory","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Memory","expression":"SELECT
              AVG(MemoryUtilized) FROM SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOCwithclusternamestatelessdefinition07E62327' GROUP BY
              TaskId"}]],"annotations":{"horizontal":[{"value":32768,"label":"Limit","yAxis":"left"}]},"yAxis":{"left":{"label":"MiB","showUnits":false}}}},{"type":"metric","width":12,"height":6,"x":0,"y":6,"properties":{"view":"timeSeries","title":"Stateless
              Network Tx","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Tx","expression":"SELECT
              AVG(NetworkTxBytes) FROM SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOCwithclusternamestatelessdefinition07E62327' GROUP BY
              TaskId"}]],"yAxis":{"left":{"label":"Bytes/sec","showUnits":false}}}},{"type":"metric","width":12,"height":6,"x":12,"y":6,"properties":{"view":"timeSeries","title":"Stateless
              Network Rx","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Rx","expression":"SELECT
              AVG(NetworkRxBytes) FROM SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOCwithclusternamestatelessdefinition07E62327' GROUP BY
              TaskId"}]],"yAxis":{"left":{"label":"Bytes/sec","showUnits":false}}}},{"type":"log","width":24,"height":6,"x":0,"y":12,"properties":{"view":"table","title":"Stateless
              Logs","region":"region","query":"SOURCE '
            - Ref: withclusternamerestateloggroupC9A99FB9
            - >-
              ' | fields @logStream, @timestamp, level, fields.message,
              target\\n          | sort @timestamp desc\\n          | limit
              500"}},{"type":"metric","width":12,"height":6,"x":0,"y":18,"properties":{"view":"timeSeries","title":"Stateful
              CPU","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"CPU","expression":"SELECT AVG(CpuUtilized)
              FROM SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOCwithclusternamestatefuldefinitionA7F94D22' GROUP BY
              TaskId"}]],"annotations":{"horizontal":[{"value":16384,"label":"Limit","yAxis":"left"}]},"yAxis":{"left":{"label":"vCPUs","showUnits":false}}}},{"type":"metric","width":12,"height":6,"x":12,"y":18,"properties":{"view":"timeSeries","title":"Stateful
              Memory","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Memory","expression":"SELECT
              AVG(MemoryUtilized) FROM SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOCwithclusternamestatefuldefinitionA7F94D22' GROUP BY
              TaskId"}]],"annotations":{"horizontal":[{"value":32768,"label":"Limit","yAxis":"left"}]},"yAxis":{"left":{"label":"MiB","showUnits":false}}}},{"type":"metric","width":12,"height":6,"x":0,"y":24,"properties":{"view":"timeSeries","title":"Stateful
              Network Tx","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Tx","expression":"SELECT
              AVG(NetworkTxBytes) FROM SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOCwithclusternamestatefuldefinitionA7F94D22' GROUP BY
              TaskId"}]],"yAxis":{"left":{"label":"Bytes/sec","showUnits":false}}}},{"type":"metric","width":12,"height":6,"x":12,"y":24,"properties":{"view":"timeSeries","title":"Stateful
              Network Rx","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Rx","expression":"SELECT
              AVG(NetworkRxBytes) FROM SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOCwithclusternamestatefuldefinitionA7F94D22' GROUP BY
              TaskId"}]],"yAxis":{"left":{"label":"Bytes/sec","showUnits":false}}}},{"type":"log","width":24,"height":6,"x":0,"y":30,"properties":{"view":"table","title":"Stateful
              Logs","region":"region","query":"SOURCE '
            - Ref: withclusternamerestateloggroupC9A99FB9
            - >-
              ' | fields @logStream, @timestamp, level, fields.message,
              target\\n          | sort @timestamp desc\\n          | limit
              500"}},{"type":"metric","width":8,"height":6,"x":0,"y":36,"properties":{"view":"timeSeries","title":"Ephemeral
              Volume Usage (Total size 200GiB)","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Usage","expression":"SELECT
              MAX(EphemeralStorageUtilized) FROM
              SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily) WHERE TaskDefinitionFamily =
              'RestateBYOCwithclusternamestatefuldefinitionA7F94D22'"}]],"annotations":{"horizontal":[{"value":200,"label":"Volume
              size","visible":false,"yAxis":"left"}]},"yAxis":{"left":{"label":"GiB","showUnits":false}},"liveData":false}},{"type":"metric","width":8,"height":6,"x":8,"y":36,"properties":{"view":"timeSeries","title":"Volume
              Write Throughput (Limited to 150 MiB/sec)","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Write","expression":"RATE(count) /
              1048576"}],[{"expression":"SELECT MAX(StorageWriteBytes) FROM
              SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOCwithclusternamestatefuldefinitionA7F94D22' GROUP BY
              TaskId","visible":false,"id":"count"}]],"annotations":{"horizontal":[{"value":150,"label":"Limit","visible":false,"yAxis":"left"}]},"yAxis":{"left":{"label":"MiB/sec","showUnits":false}}}},{"type":"metric","width":8,"height":6,"x":16,"y":36,"properties":{"view":"timeSeries","title":"Volume
              Read Throughput (Limited to 150 MiB/sec)","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Read","expression":"RATE(count) /
              1048576"}],[{"expression":"SELECT MAX(StorageReadBytes) FROM
              SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOCwithclusternamestatefuldefinitionA7F94D22' GROUP BY
              TaskId","visible":false,"id":"count"}]],"annotations":{"horizontal":[{"value":150,"label":"Limit","visible":false,"yAxis":"left"}]},"yAxis":{"left":{"label":"MiB/sec","showUnits":false}}}},{"type":"log","width":24,"height":6,"x":0,"y":42,"properties":{"view":"table","title":"Controller
              Logs","region":"region","query":"SOURCE '
            - Ref: withclusternamecontrollerloggroup157ABD85
            - >-
              ' | fields @logStream, @timestamp, level, fields.message,
              target\\n          | sort @timestamp desc\\n          | limit
              500"}}]}
      DashboardName: RestateBYOC_with-cluster-name_metrics
  withclusternamecontrolpanel0DA98007:
    Type: 'AWS::CloudWatch::Dashboard'
    Properties:
      DashboardBody:
        'Fn::Join':
          - ''
          - - >-
              {"widgets":[{"type":"custom","width":24,"height":26,"x":0,"y":0,"properties":{"endpoint":"
            - 'Fn::GetAtt':
                - withclusternamecloudwatchcustomwidgetlambda3C8DD721
                - Arn
            - '","params":{"command":"controlPanel","input":{"region":"'
            - Ref: 'AWS::Region'
            - >-
              ","summary":{"clusterName":"RestateBYOC/with-cluster-name","restateVersion":"1.4","stackVersion":"0.4.1-dev","metricsDashboardName":"
            - Ref: withclusternamemetrics035F2329
            - '"},"resources":{"ecsClusterArn":"'
            - 'Fn::GetAtt':
                - withclusternamecluster8A2E876D
                - Arn
            - '","statelessServiceArn":"'
            - Ref: withclusternamestatelessserviceServiceA9323A0F
            - '","controllerServiceArn":"'
            - Ref: withclusternamecontrollerserviceService7DEFCD49
            - '","restatectlLambdaArn":"'
            - 'Fn::GetAtt':
                - withclusternamerestatectllambdaBEFE7F28
                - Arn
            - >-
              "},"connectivityAndSecurity":{"connectivity":{"loadBalancerArns":{"ingress":["
            - Ref: withclusternamesharednlb8C523D9C
            - '"],"admin":["'
            - Ref: withclusternamesharednlb8C523D9C
            - '"]},"addresses":{"ingress":"http://'
            - 'Fn::GetAtt':
                - withclusternamesharednlb8C523D9C
                - DNSName
            - ':8080","admin":"http://'
            - 'Fn::GetAtt':
                - withclusternamesharednlb8C523D9C
                - DNSName
            - ':9070","webUI":"http://'
            - 'Fn::GetAtt':
                - withclusternamesharednlb8C523D9C
                - DNSName
            - ':9070/ui"}},"networking":{"vpc":"'
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcA2121C384D1B3CDE'
            - '","availabilityZones":["dummy1a","dummy1b","dummy1c"],"subnets":["'
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet1Subnet934893E8236E2271'
            - '","'
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet2Subnet7031C2BA60DCB1EE'
            - '","'
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet3Subnet985AC459F9514491'
            - '"]},"security":{"securityGroups":["'
            - 'Fn::GetAtt':
                - withclusternamesecuritygroup9A10CA11
                - GroupId
            - >-
              "]}},"storage":{"s3":{"bucket":"bucket-name"}}}},"title":"","updateOn":{"refresh":true,"resize":true,"timeRange":true}}}]}
      DashboardName: RestateBYOC_with-cluster-name_control-panel
Outputs:
  withclusternameSecurityGroups0B23FBD2:
    Description: The security group IDs of the cluster
    Value:
      'Fn::GetAtt':
        - withclusternamesecuritygroup9A10CA11
        - GroupId
  withclusternameIngressNetworkListener3CFF85D8:
    Description: The ARN of the network listener for the ingress port
    Value:
      Ref: withclusternameingresssharedlistener95E35FDA
  withclusternameIngressNetworkTargetGroupD4FC923B:
    Description: The ARN of the network target group for the ingress port
    Value:
      Ref: withclusternameingresssharedtargetB3D385F9
  withclusternameAdminNetworkListenerA948C54C:
    Description: The ARN of the network listener for the admin port
    Value:
      Ref: withclusternameadminsharedlistener9BA748D2
  withclusternameAdminNetworkTargetGroup91166891:
    Description: The ARN of the network target group for the admin port
    Value:
      Ref: withclusternameadminsharedtarget0D4BB912
  withclusternameNodeNetworkListener5BD5FF0E:
    Description: The ARN of the network listener for the node port
    Value:
      Ref: withclusternamenodesharedlistener0C52ED87
  withclusternameNodeNetworkTargetGroupF79B180F:
    Description: The ARN of the network target group for the node port
    Value:
      Ref: withclusternamenodesharedtarget977BCA3A
"
`;

exports[`BYOC With otel collector 1`] = `
"Resources:
  withotelcollectorsecuritygroupBD4A7399:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      GroupDescription: RestateBYOC/with-otel-collector/security-group
      SecurityGroupEgress:
        - CidrIp: 0.0.0.0/0
          Description: Allow all outbound traffic by default
          IpProtocol: '-1'
      Tags:
        - Key: Name
          Value: RestateBYOC/with-otel-collector/security-group
      VpcId:
        'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcA2121C384D1B3CDE'
  withotelcollectorsecuritygroupfromRestateBYOCwithotelcollectorsecuritygroup8F266FC48080E57FC3B5:
    Type: 'AWS::EC2::SecurityGroupIngress'
    Properties:
      Description: 'from RestateBYOCwithotelcollectorsecuritygroup8F266FC4:8080'
      FromPort: 8080
      GroupId:
        'Fn::GetAtt':
          - withotelcollectorsecuritygroupBD4A7399
          - GroupId
      IpProtocol: tcp
      SourceSecurityGroupId:
        'Fn::GetAtt':
          - withotelcollectorsecuritygroupBD4A7399
          - GroupId
      ToPort: 8080
  withotelcollectorsecuritygroupfromRestateBYOCwithotelcollectorsecuritygroup8F266FC490706978750A:
    Type: 'AWS::EC2::SecurityGroupIngress'
    Properties:
      Description: 'from RestateBYOCwithotelcollectorsecuritygroup8F266FC4:9070'
      FromPort: 9070
      GroupId:
        'Fn::GetAtt':
          - withotelcollectorsecuritygroupBD4A7399
          - GroupId
      IpProtocol: tcp
      SourceSecurityGroupId:
        'Fn::GetAtt':
          - withotelcollectorsecuritygroupBD4A7399
          - GroupId
      ToPort: 9070
  withotelcollectorsecuritygroupfromRestateBYOCwithotelcollectorsecuritygroup8F266FC451227B061610:
    Type: 'AWS::EC2::SecurityGroupIngress'
    Properties:
      Description: 'from RestateBYOCwithotelcollectorsecuritygroup8F266FC4:5122'
      FromPort: 5122
      GroupId:
        'Fn::GetAtt':
          - withotelcollectorsecuritygroupBD4A7399
          - GroupId
      IpProtocol: tcp
      SourceSecurityGroupId:
        'Fn::GetAtt':
          - withotelcollectorsecuritygroupBD4A7399
          - GroupId
      ToPort: 5122
  withotelcollectorbucket91BBB0A6:
    Type: 'AWS::S3::Bucket'
    Properties:
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
    UpdateReplacePolicy: Retain
    DeletionPolicy: Retain
  withotelcollectorbucketPolicyEBDF0D9E:
    Type: 'AWS::S3::BucketPolicy'
    Properties:
      Bucket:
        Ref: withotelcollectorbucket91BBB0A6
      PolicyDocument:
        Statement:
          - Action: 's3:*'
            Condition:
              Bool:
                'aws:SecureTransport': 'false'
            Effect: Deny
            Principal:
              AWS: '*'
            Resource:
              - 'Fn::GetAtt':
                  - withotelcollectorbucket91BBB0A6
                  - Arn
              - 'Fn::Join':
                  - ''
                  - - 'Fn::GetAtt':
                        - withotelcollectorbucket91BBB0A6
                        - Arn
                    - /*
        Version: '2012-10-17'
  withotelcollectorcluster09679981:
    Type: 'AWS::ECS::Cluster'
    Properties:
      ClusterSettings:
        - Name: containerInsights
          Value: enhanced
      Tags:
        - Key: Name
          Value: RestateBYOC/with-otel-collector/cluster
  withotelcollectorrestatetaskrole86DA1F80:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
        Version: '2012-10-17'
  withotelcollectorrestatetaskroleDefaultPolicyEFEF2082:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 's3:GetObject'
              - 's3:PutObject'
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'Fn::GetAtt':
                      - withotelcollectorbucket91BBB0A6
                      - Arn
                  - /*
            Sid: ReadWriteBucket
          - Action: 's3:ListBucket'
            Effect: Allow
            Resource:
              'Fn::GetAtt':
                - withotelcollectorbucket91BBB0A6
                - Arn
            Sid: ListBucket
        Version: '2012-10-17'
      PolicyName: withotelcollectorrestatetaskroleDefaultPolicyEFEF2082
      Roles:
        - Ref: withotelcollectorrestatetaskrole86DA1F80
  withotelcollectorrestateexecutionroleEB9F4CAC:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
        Version: '2012-10-17'
  withotelcollectorrestateexecutionroleDefaultPolicyC64BE7CC:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 'logs:CreateLogStream'
              - 'logs:PutLogEvents'
            Effect: Allow
            Resource:
              'Fn::GetAtt':
                - withotelcollectorrestateloggroupE7CD68F4
                - Arn
        Version: '2012-10-17'
      PolicyName: withotelcollectorrestateexecutionroleDefaultPolicyC64BE7CC
      Roles:
        - Ref: withotelcollectorrestateexecutionroleEB9F4CAC
  withotelcollectorrestateloggroupE7CD68F4:
    Type: 'AWS::Logs::LogGroup'
    Properties:
      RetentionInDays: 30
    UpdateReplacePolicy: Retain
    DeletionPolicy: Retain
  withotelcollectorcontrollerloggroupE0170504:
    Type: 'AWS::Logs::LogGroup'
    Properties:
      RetentionInDays: 30
    UpdateReplacePolicy: Retain
    DeletionPolicy: Retain
  withotelcollectorsharednlbB07E655C:
    Type: 'AWS::ElasticLoadBalancingV2::LoadBalancer'
    Properties:
      LoadBalancerAttributes:
        - Key: deletion_protection.enabled
          Value: 'false'
        - Key: load_balancing.cross_zone.enabled
          Value: 'false'
        - Key: dns_record.client_routing_policy
          Value: availability_zone_affinity
      Scheme: internal
      SecurityGroups:
        - 'Fn::GetAtt':
            - withotelcollectorsecuritygroupBD4A7399
            - GroupId
      Subnets:
        - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet1Subnet934893E8236E2271'
        - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet2Subnet7031C2BA60DCB1EE'
        - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet3Subnet985AC459F9514491'
      Tags:
        - Key: Name
          Value: RestateBYOC/with-otel-collector/shared-nlb
      Type: network
  withotelcollectoringresssharedlistener92B1BA62:
    Type: 'AWS::ElasticLoadBalancingV2::Listener'
    Properties:
      DefaultActions:
        - TargetGroupArn:
            Ref: withotelcollectoringresssharedtarget878F9905
          Type: forward
      LoadBalancerArn:
        Ref: withotelcollectorsharednlbB07E655C
      Port: 8080
      Protocol: TCP
  withotelcollectoradminsharedlistenerF5722F86:
    Type: 'AWS::ElasticLoadBalancingV2::Listener'
    Properties:
      DefaultActions:
        - TargetGroupArn:
            Ref: withotelcollectoradminsharedtarget90E7DEFD
          Type: forward
      LoadBalancerArn:
        Ref: withotelcollectorsharednlbB07E655C
      Port: 9070
      Protocol: TCP
  withotelcollectornodesharedlistenerF009ADCC:
    Type: 'AWS::ElasticLoadBalancingV2::Listener'
    Properties:
      DefaultActions:
        - TargetGroupArn:
            Ref: withotelcollectornodesharedtarget3F81F89C
          Type: forward
      LoadBalancerArn:
        Ref: withotelcollectorsharednlbB07E655C
      Port: 5122
      Protocol: TCP
  withotelcollectorstatelessdefinition55F766B0:
    Type: 'AWS::ECS::TaskDefinition'
    Properties:
      ContainerDefinitions:
        - Cpu: 16128
          EntryPoint:
            - bash
            - '-c'
            - >

              curl --no-progress-meter $ECS_CONTAINER_METADATA_URI_V4 -o
              container-metadata && \\

              curl --no-progress-meter $ECS_CONTAINER_METADATA_URI_V4/task -o
              task-metadata && \\

              export \\
                RESTATE_NODE_NAME=$(jq -r '.TaskARN' task-metadata) \\
                RESTATE_LOCATION="$AWS_REGION.$(jq -r '.AvailabilityZone' task-metadata)" \\
                RESTATE_ADVERTISED_ADDRESS="http://$(jq -r '.Networks[0].IPv4Addresses[0]' container-metadata):5122"
              exec restate-server
          Environment:
            - Name: RESTATE_LOG_FORMAT
              Value: json
            - Name: RESTATE_CLUSTER_NAME
              Value: RestateBYOC/with-otel-collector
            - Name: RESTATE_ROLES
              Value: '["admin","http-ingress"]'
            - Name: RESTATE_AUTO_PROVISION
              Value: 'true'
            - Name: RESTATE_SHUTDOWN_TIMEOUT
              Value: 100s
            - Name: RESTATE_DEFAULT_NUM_PARTITIONS
              Value: '128'
            - Name: RESTATE_DEFAULT_REPLICATION
              Value: '{zone: 2}'
            - Name: RESTATE_METADATA_CLIENT__TYPE
              Value: object-store
            - Name: RESTATE_METADATA_CLIENT__PATH
              Value:
                'Fn::Join':
                  - ''
                  - - 's3://'
                    - Ref: withotelcollectorbucket91BBB0A6
                    - /metadata
            - Name: RESTATE_BIFROST__DEFAULT_PROVIDER
              Value: replicated
            - Name: >-
                RESTATE_INGRESS__EXPERIMENTAL_FEATURE_ENABLE_SEPARATE_INGRESS_ROLE
              Value: 'true'
            - Name: RESTATE_INGRESS__ADVERTISED_INGRESS_ENDPOINT
              Value:
                'Fn::Join':
                  - ''
                  - - 'http://'
                    - 'Fn::GetAtt':
                        - withotelcollectorsharednlbB07E655C
                        - DNSName
                    - ':8080'
            - Name: RESTATE_WORKER__SNAPSHOTS__DESTINATION
              Value:
                'Fn::Join':
                  - ''
                  - - 's3://'
                    - Ref: withotelcollectorbucket91BBB0A6
                    - /snapshots
          Essential: true
          HealthCheck:
            Command:
              - CMD
              - curl
              - '--fail'
              - 'http://127.0.0.1:8080/restate/health'
            Interval: 30
            Retries: 3
            Timeout: 5
          Image: Any<Object>
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group:
                Ref: withotelcollectorrestateloggroupE7CD68F4
              awslogs-stream-prefix: restate
              awslogs-region: region
              mode: non-blocking
          Memory: 32256
          Name: restate
          PortMappings:
            - ContainerPort: 8080
              Name: ingress
              Protocol: tcp
            - ContainerPort: 9070
              Name: admin
              Protocol: tcp
            - ContainerPort: 5122
              Name: node
              Protocol: tcp
          StopTimeout: 120
        - Cpu: 256
          Environment:
            - Name: AOT_CONFIG_CONTENT
              Value: >-
                {"receivers":{"otlp":{"protocols":{"grpc":{"endpoint":"localhost:4317"}}},"prometheus":{"config":{"scrape_configs":[{"job_name":"restate","static_configs":[{"targets":["localhost:5122"]}],"scrape_interval":"60s"}]}},"awsecscontainermetrics":{"collection_interval":"60s"}},"processors":{"batch/traces":{"timeout":"5s","send_batch_size":50},"batch/metrics":{"timeout":"60s"},"filter/ecs":{"metrics":{"include":{"match_type":"strict","metric_names":["ecs.task.memory.reserved","ecs.task.memory.utilized","ecs.task.cpu.utilized","ecs.task.cpu.reserved","ecs.task.network.io.usage.rx_bytes","ecs.task.network.io.usage.tx_bytes","ecs.task.storage.read_bytes","ecs.task.storage.write_bytes"]}}},"metricstransform/ecs":{"transforms":[{"include":"ecs.task.memory.utilized","action":"update","new_name":"restate_ecs_memory_utilized"},{"include":"ecs.task.memory.reserved","action":"update","new_name":"restate_ecs_memory_reserved"},{"include":"ecs.task.cpu.utilized","action":"update","new_name":"restate_ecs_cpu_utilized"},{"include":"ecs.task.cpu.reserved","action":"update","new_name":"restate_ecs_cpu_reserved"},{"include":"ecs.task.network.io.usage.rx_bytes","action":"update","new_name":"restate_ecs_network_io_usage_rx_bytes"},{"include":"ecs.task.network.io.usage.tx_bytes","action":"update","new_name":"restate_ecs_network_io_usage_tx_bytes"},{"include":"ecs.task.storage.read_bytes","action":"update","new_name":"restate_ecs_storage_read_bytes"},{"include":"ecs.task.storage.write_bytes","action":"update","new_name":"restate_ecs_storage_write_bytes"}]},"resource/ecs":{"attributes":[{"key":"service.name","value":"restate","action":"upsert"},{"key":"cluster_name","value":"\${env:RESTATE_CLUSTER_NAME}","action":"insert"},{"key":"node_name","from_attribute":"aws.ecs.task.arn","action":"insert"},{"key":"availability_zone","from_attribute":"cloud.zone","action":"insert"},{"pattern":"aws.*","action":"delete"},{"pattern":"cloud.*","action":"delete"}]}},"exporters":{"awsemf":{"namespace":"Restate/Metrics","log_group_name":"/restate/metrics"}},"service":{"pipelines":{"metrics/restate":{"receivers":["prometheus"],"processors":["batch/metrics"],"exporters":["awsemf"]},"metrics/ecs":{"receivers":["awsecscontainermetrics"],"processors":["filter/ecs","metricstransform/ecs","resource/ecs"],"exporters":["awsemf"]}},"extensions":["health_check","zpages","sigv4auth"]},"extensions":{"health_check":{},"zpages":{},"sigv4auth":{}}}
            - Name: RESTATE_CLUSTER_NAME
              Value: RestateBYOC/with-otel-collector
          Essential: false
          HealthCheck:
            Command:
              - CMD
              - /healthcheck
            Interval: 5
            Retries: 3
            Timeout: 5
          Image: Any<Object>
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group:
                Ref: withotelcollectorrestateloggroupE7CD68F4
              awslogs-stream-prefix: restate
              awslogs-region: region
              mode: non-blocking
          Memory: 512
          Name: otel-collector
          RestartPolicy:
            Enabled: true
            RestartAttemptPeriod: 60
          StopTimeout: 30
      Cpu: '16384'
      ExecutionRoleArn:
        'Fn::GetAtt':
          - withotelcollectorrestateexecutionroleEB9F4CAC
          - Arn
      Family: RestateBYOCwithotelcollectorstatelessdefinition8B26C72F
      Memory: '32768'
      NetworkMode: awsvpc
      RequiresCompatibilities:
        - FARGATE
      RuntimePlatform:
        CpuArchitecture: ARM64
        OperatingSystemFamily: LINUX
      Tags:
        - Key: Name
          Value: RestateBYOC/with-otel-collector/stateless-definition
      TaskRoleArn:
        'Fn::GetAtt':
          - withotelcollectorrestatetaskrole86DA1F80
          - Arn
  withotelcollectorstatelessserviceService8ABCCEA9:
    Type: 'AWS::ECS::Service'
    Properties:
      AvailabilityZoneRebalancing: ENABLED
      Cluster:
        Ref: withotelcollectorcluster09679981
      DeploymentConfiguration:
        Alarms:
          AlarmNames: []
          Enable: false
          Rollback: false
        MaximumPercent: 200
        MinimumHealthyPercent: 100
      DeploymentController:
        Type: ECS
      DesiredCount: 3
      EnableECSManagedTags: false
      EnableExecuteCommand: false
      HealthCheckGracePeriodSeconds: 60
      LaunchType: FARGATE
      LoadBalancers:
        - ContainerName: restate
          ContainerPort: 8080
          TargetGroupArn:
            Ref: withotelcollectoringresssharedtarget878F9905
        - ContainerName: restate
          ContainerPort: 9070
          TargetGroupArn:
            Ref: withotelcollectoradminsharedtarget90E7DEFD
        - ContainerName: restate
          ContainerPort: 5122
          TargetGroupArn:
            Ref: withotelcollectornodesharedtarget3F81F89C
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: DISABLED
          SecurityGroups:
            - 'Fn::GetAtt':
                - withotelcollectorsecuritygroupBD4A7399
                - GroupId
          Subnets:
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet1Subnet934893E8236E2271'
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet2Subnet7031C2BA60DCB1EE'
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet3Subnet985AC459F9514491'
      PropagateTags: SERVICE
      Tags:
        - Key: Name
          Value: RestateBYOC/with-otel-collector/stateless-service
      TaskDefinition:
        Ref: withotelcollectorstatelessdefinition55F766B0
    DependsOn:
      - withotelcollectoradminsharedlistenerF5722F86
      - withotelcollectoringresssharedlistener92B1BA62
      - withotelcollectornodesharedlistenerF009ADCC
      - withotelcollectorrestatetaskroleDefaultPolicyEFEF2082
      - withotelcollectorrestatetaskrole86DA1F80
  withotelcollectorstatefuldefinitionFB434419:
    Type: 'AWS::ECS::TaskDefinition'
    Properties:
      ContainerDefinitions:
        - Cpu: 16128
          EntryPoint:
            - bash
            - '-c'
            - >

              curl --no-progress-meter $ECS_CONTAINER_METADATA_URI_V4 -o
              container-metadata && \\

              curl --no-progress-meter $ECS_CONTAINER_METADATA_URI_V4/task -o
              task-metadata && \\

              export \\
                RESTATE_NODE_NAME=$(jq -r '.TaskARN' task-metadata) \\
                RESTATE_LOCATION="$AWS_REGION.$(jq -r '.AvailabilityZone' task-metadata)" \\
                RESTATE_ADVERTISED_ADDRESS="http://$(jq -r '.Networks[0].IPv4Addresses[0]' container-metadata):5122" \\
                RESTATE_ROCKSDB_TOTAL_MEMORY_SIZE="$(($(jq -r '.Limits.Memory' container-metadata) * 3 / 4))MiB" \\
                RESTATE_WORKER__STORAGE__NUM_PARTITIONS_TO_SHARE_MEMORY_BUDGET=$(("$RESTATE_WORKER__STORAGE__NUM_PARTITIONS_TO_SHARE_MEMORY_BUDGET"))
              exec restate-server
          Environment:
            - Name: RESTATE_LOG_FORMAT
              Value: json
            - Name: RESTATE_CLUSTER_NAME
              Value: RestateBYOC/with-otel-collector
            - Name: RESTATE_ROLES
              Value: '["log-server", "worker"]'
            - Name: RESTATE_AUTO_PROVISION
              Value: 'false'
            - Name: RESTATE_SHUTDOWN_TIMEOUT
              Value: 100s
            - Name: RESTATE_METADATA_CLIENT__TYPE
              Value: object-store
            - Name: RESTATE_METADATA_CLIENT__PATH
              Value:
                'Fn::Join':
                  - ''
                  - - 's3://'
                    - Ref: withotelcollectorbucket91BBB0A6
                    - /metadata
            - Name: RESTATE_WORKER__SNAPSHOTS__DESTINATION
              Value:
                'Fn::Join':
                  - ''
                  - - 's3://'
                    - Ref: withotelcollectorbucket91BBB0A6
                    - /snapshots
            - Name: RESTATE_WORKER__SNAPSHOTS__SNAPSHOT_INTERVAL_NUM_RECORDS
              Value: '1000000'
            - Name: RESTATE_WORKER__STORAGE__ROCKSDB_DISABLE_DIRECT_IO_FOR_READS
              Value: 'true'
            - Name: RESTATE_WORKER__STORAGE__ROCKSDB_DISABLE_WAL_FSYNC
              Value: 'true'
            - Name: RESTATE_WORKER__STORAGE__NUM_PARTITIONS_TO_SHARE_MEMORY_BUDGET
              Value: (128 * 2) / (3 * 1)
            - Name: RESTATE_LOG_SERVER__ROCKSDB_DISABLE_WAL_FSYNC
              Value: 'true'
            - Name: RESTATE_LOG_SERVER__ROCKSDB_DISABLE_DIRECT_IO_FOR_READS
              Value: 'true'
            - Name: >-
                RESTATE_INGRESS__EXPERIMENTAL_FEATURE_ENABLE_SEPARATE_INGRESS_ROLE
              Value: 'true'
          Essential: true
          HealthCheck:
            Command:
              - CMD
              - curl
              - '--fail'
              - 'http://127.0.0.1:5122/health'
            Interval: 30
            Retries: 3
            Timeout: 5
          Image: Any<Object>
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group:
                Ref: withotelcollectorrestateloggroupE7CD68F4
              awslogs-stream-prefix: restate
              awslogs-region: region
              mode: non-blocking
          Memory: 32256
          MountPoints:
            - ContainerPath: /restate-data
              ReadOnly: false
              SourceVolume: restate-data
          Name: restate
          PortMappings:
            - ContainerPort: 5122
              Name: node
              Protocol: tcp
          RestartPolicy:
            Enabled: true
            RestartAttemptPeriod: 60
          StopTimeout: 120
        - Cpu: 256
          Environment:
            - Name: AOT_CONFIG_CONTENT
              Value: >-
                {"receivers":{"otlp":{"protocols":{"grpc":{"endpoint":"localhost:4317"}}},"prometheus":{"config":{"scrape_configs":[{"job_name":"restate","static_configs":[{"targets":["localhost:5122"]}],"scrape_interval":"60s"}]}},"awsecscontainermetrics":{"collection_interval":"60s"}},"processors":{"batch/traces":{"timeout":"5s","send_batch_size":50},"batch/metrics":{"timeout":"60s"},"filter/ecs":{"metrics":{"include":{"match_type":"strict","metric_names":["ecs.task.memory.reserved","ecs.task.memory.utilized","ecs.task.cpu.utilized","ecs.task.cpu.reserved","ecs.task.network.io.usage.rx_bytes","ecs.task.network.io.usage.tx_bytes","ecs.task.storage.read_bytes","ecs.task.storage.write_bytes"]}}},"metricstransform/ecs":{"transforms":[{"include":"ecs.task.memory.utilized","action":"update","new_name":"restate_ecs_memory_utilized"},{"include":"ecs.task.memory.reserved","action":"update","new_name":"restate_ecs_memory_reserved"},{"include":"ecs.task.cpu.utilized","action":"update","new_name":"restate_ecs_cpu_utilized"},{"include":"ecs.task.cpu.reserved","action":"update","new_name":"restate_ecs_cpu_reserved"},{"include":"ecs.task.network.io.usage.rx_bytes","action":"update","new_name":"restate_ecs_network_io_usage_rx_bytes"},{"include":"ecs.task.network.io.usage.tx_bytes","action":"update","new_name":"restate_ecs_network_io_usage_tx_bytes"},{"include":"ecs.task.storage.read_bytes","action":"update","new_name":"restate_ecs_storage_read_bytes"},{"include":"ecs.task.storage.write_bytes","action":"update","new_name":"restate_ecs_storage_write_bytes"}]},"resource/ecs":{"attributes":[{"key":"service.name","value":"restate","action":"upsert"},{"key":"cluster_name","value":"\${env:RESTATE_CLUSTER_NAME}","action":"insert"},{"key":"node_name","from_attribute":"aws.ecs.task.arn","action":"insert"},{"key":"availability_zone","from_attribute":"cloud.zone","action":"insert"},{"pattern":"aws.*","action":"delete"},{"pattern":"cloud.*","action":"delete"}]}},"exporters":{"awsemf":{"namespace":"Restate/Metrics","log_group_name":"/restate/metrics"}},"service":{"pipelines":{"metrics/restate":{"receivers":["prometheus"],"processors":["batch/metrics"],"exporters":["awsemf"]},"metrics/ecs":{"receivers":["awsecscontainermetrics"],"processors":["filter/ecs","metricstransform/ecs","resource/ecs"],"exporters":["awsemf"]}},"extensions":["health_check","zpages","sigv4auth"]},"extensions":{"health_check":{},"zpages":{},"sigv4auth":{}}}
            - Name: RESTATE_CLUSTER_NAME
              Value: RestateBYOC/with-otel-collector
          Essential: false
          HealthCheck:
            Command:
              - CMD
              - /healthcheck
            Interval: 5
            Retries: 3
            Timeout: 5
          Image: Any<Object>
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group:
                Ref: withotelcollectorrestateloggroupE7CD68F4
              awslogs-stream-prefix: restate
              awslogs-region: region
              mode: non-blocking
          Memory: 512
          Name: otel-collector
          RestartPolicy:
            Enabled: true
            RestartAttemptPeriod: 60
          StopTimeout: 30
      Cpu: '16384'
      EphemeralStorage:
        SizeInGiB: 200
      ExecutionRoleArn:
        'Fn::GetAtt':
          - withotelcollectorrestateexecutionroleEB9F4CAC
          - Arn
      Family: RestateBYOCwithotelcollectorstatefuldefinition83529E5C
      Memory: '32768'
      NetworkMode: awsvpc
      RequiresCompatibilities:
        - FARGATE
      RuntimePlatform:
        CpuArchitecture: ARM64
        OperatingSystemFamily: LINUX
      Tags:
        - Key: Name
          Value: RestateBYOC/with-otel-collector/stateful-definition
      TaskRoleArn:
        'Fn::GetAtt':
          - withotelcollectorrestatetaskrole86DA1F80
          - Arn
      Volumes:
        - ConfiguredAtLaunch: false
          Name: restate-data
  withotelcollectoringresssharedtarget878F9905:
    Type: 'AWS::ElasticLoadBalancingV2::TargetGroup'
    Properties:
      HealthCheckEnabled: true
      HealthCheckIntervalSeconds: 5
      HealthCheckPath: /restate/health
      HealthCheckProtocol: HTTP
      HealthCheckTimeoutSeconds: 2
      Port: 8080
      Protocol: TCP
      Tags:
        - Key: Name
          Value: RestateBYOC/with-otel-collector/ingress-shared-target
      TargetType: ip
      VpcId:
        'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcA2121C384D1B3CDE'
  withotelcollectoradminsharedtarget90E7DEFD:
    Type: 'AWS::ElasticLoadBalancingV2::TargetGroup'
    Properties:
      HealthCheckEnabled: true
      HealthCheckIntervalSeconds: 5
      HealthCheckPath: /health
      HealthCheckPort: '9070'
      HealthCheckProtocol: HTTP
      HealthCheckTimeoutSeconds: 2
      Port: 9070
      Protocol: TCP
      Tags:
        - Key: Name
          Value: RestateBYOC/with-otel-collector/admin-shared-target
      TargetType: ip
      VpcId:
        'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcA2121C384D1B3CDE'
  withotelcollectornodesharedtarget3F81F89C:
    Type: 'AWS::ElasticLoadBalancingV2::TargetGroup'
    Properties:
      HealthCheckEnabled: true
      HealthCheckIntervalSeconds: 5
      HealthCheckPath: /health
      HealthCheckPort: '5122'
      HealthCheckProtocol: HTTP
      HealthCheckTimeoutSeconds: 2
      Port: 5122
      Protocol: TCP
      Tags:
        - Key: Name
          Value: RestateBYOC/with-otel-collector/node-shared-target
      TargetType: ip
      VpcId:
        'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcA2121C384D1B3CDE'
  withotelcollectorcontrollertaskrole025F5504:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
        Version: '2012-10-17'
  withotelcollectorcontrollertaskroleDefaultPolicyE9B648FA:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action: 'ecs:ListTasks'
            Condition:
              ArnEquals:
                'ecs:cluster':
                  'Fn::GetAtt':
                    - withotelcollectorcluster09679981
                    - Arn
            Effect: Allow
            Resource: '*'
            Sid: ECSListActions
          - Action:
              - 'ecs:TagResource'
              - 'ecs:DescribeTasks'
              - 'ecs:StopTask'
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'Fn::Join':
                      - /
                      - - 'Fn::Join':
                            - ':'
                            - - 'Fn::Select':
                                  - 0
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - withotelcollectorcluster09679981
                                                  - Arn
                              - 'Fn::Select':
                                  - 1
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - withotelcollectorcluster09679981
                                                  - Arn
                              - 'Fn::Select':
                                  - 2
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - withotelcollectorcluster09679981
                                                  - Arn
                              - 'Fn::Select':
                                  - 3
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - withotelcollectorcluster09679981
                                                  - Arn
                              - 'Fn::Select':
                                  - 4
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - withotelcollectorcluster09679981
                                                  - Arn
                              - task
                        - 'Fn::Select':
                            - 1
                            - 'Fn::Split':
                                - /
                                - 'Fn::GetAtt':
                                    - withotelcollectorcluster09679981
                                    - Arn
                        - ''
                  - '*'
            Sid: TaskActions
          - Action: 'ecs:RunTask'
            Condition:
              ArnEquals:
                'ecs:cluster':
                  'Fn::GetAtt':
                    - withotelcollectorcluster09679981
                    - Arn
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'Fn::Join':
                      - ':'
                      - - 'Fn::Select':
                            - 0
                            - 'Fn::Split':
                                - ':'
                                - Ref: withotelcollectorstatefuldefinitionFB434419
                        - 'Fn::Select':
                            - 1
                            - 'Fn::Split':
                                - ':'
                                - Ref: withotelcollectorstatefuldefinitionFB434419
                        - 'Fn::Select':
                            - 2
                            - 'Fn::Split':
                                - ':'
                                - Ref: withotelcollectorstatefuldefinitionFB434419
                        - 'Fn::Select':
                            - 3
                            - 'Fn::Split':
                                - ':'
                                - Ref: withotelcollectorstatefuldefinitionFB434419
                        - 'Fn::Select':
                            - 4
                            - 'Fn::Split':
                                - ':'
                                - Ref: withotelcollectorstatefuldefinitionFB434419
                        - 'Fn::Select':
                            - 5
                            - 'Fn::Split':
                                - ':'
                                - Ref: withotelcollectorstatefuldefinitionFB434419
                  - ':*'
            Sid: RunTask
          - Action: 'iam:PassRole'
            Condition:
              StringEquals:
                'iam:PassedToService': ecs-tasks.amazonaws.com
            Effect: Allow
            Resource:
              - 'Fn::GetAtt':
                  - withotelcollectorrestatetaskrole86DA1F80
                  - Arn
              - 'Fn::GetAtt':
                  - withotelcollectorrestateexecutionroleEB9F4CAC
                  - Arn
            Sid: RunTaskPassRole
          - Action:
              - 'ec2:DescribeVolumes'
              - 'ec2:DescribeSnapshots'
            Effect: Allow
            Resource: '*'
            Sid: EC2ListActions
          - Action: 'ec2:CreateSnapshot'
            Condition:
              ArnEquals:
                'aws:RequestTag/restate:ecsClusterArn':
                  'Fn::GetAtt':
                    - withotelcollectorcluster09679981
                    - Arn
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'arn:'
                  - Ref: 'AWS::Partition'
                  - ':ec2:'
                  - Ref: 'AWS::Region'
                  - '::snapshot/*'
            Sid: CreateSnapshot
          - Action: 'ec2:CreateSnapshot'
            Condition:
              ArnEquals:
                'aws:ResourceTag/restate:ecsClusterArn':
                  'Fn::GetAtt':
                    - withotelcollectorcluster09679981
                    - Arn
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'arn:'
                  - Ref: 'AWS::Partition'
                  - ':ec2:'
                  - Ref: 'AWS::Region'
                  - ':'
                  - Ref: 'AWS::AccountId'
                  - ':volume/*'
            Sid: SnapshotVolume
          - Action: 'ec2:CreateTags'
            Condition:
              StringEquals:
                'ec2:CreateAction': CreateSnapshot
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'arn:'
                  - Ref: 'AWS::Partition'
                  - ':ec2:'
                  - Ref: 'AWS::Region'
                  - '::snapshot/*'
            Sid: TagSnapshots
          - Action:
              - 'ec2:DeleteVolume'
              - 'ec2:DeleteSnapshot'
            Condition:
              ArnEquals:
                'aws:ResourceTag/restate:ecsClusterArn':
                  'Fn::GetAtt':
                    - withotelcollectorcluster09679981
                    - Arn
            Effect: Allow
            Resource:
              - 'Fn::Join':
                  - ''
                  - - 'arn:'
                    - Ref: 'AWS::Partition'
                    - ':ec2:'
                    - Ref: 'AWS::Region'
                    - ':'
                    - Ref: 'AWS::AccountId'
                    - ':volume/*'
              - 'Fn::Join':
                  - ''
                  - - 'arn:'
                    - Ref: 'AWS::Partition'
                    - ':ec2:'
                    - Ref: 'AWS::Region'
                    - '::snapshot/*'
            Sid: DeleteVolumeAndSnapshot
          - Action:
              - 's3:GetObject'
              - 's3:PutObject'
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'Fn::GetAtt':
                      - withotelcollectorbucket91BBB0A6
                      - Arn
                  - /*
            Sid: ReadWriteBucket
          - Action: 's3:ListBucket'
            Effect: Allow
            Resource:
              'Fn::GetAtt':
                - withotelcollectorbucket91BBB0A6
                - Arn
            Sid: ListBucket
        Version: '2012-10-17'
      PolicyName: withotelcollectorcontrollertaskroleDefaultPolicyE9B648FA
      Roles:
        - Ref: withotelcollectorcontrollertaskrole025F5504
  withotelcollectorcontrollerexecutionrole5AE5C9E0:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
        Version: '2012-10-17'
  withotelcollectorcontrollerexecutionroleDefaultPolicy435FD9C3:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 'logs:CreateLogStream'
              - 'logs:PutLogEvents'
            Effect: Allow
            Resource:
              'Fn::GetAtt':
                - withotelcollectorcontrollerloggroupE0170504
                - Arn
        Version: '2012-10-17'
      PolicyName: withotelcollectorcontrollerexecutionroleDefaultPolicy435FD9C3
      Roles:
        - Ref: withotelcollectorcontrollerexecutionrole5AE5C9E0
  withotelcollectorcontrollerdefinitionD29F6C59:
    Type: 'AWS::ECS::TaskDefinition'
    Properties:
      ContainerDefinitions:
        - Cpu: 1024
          Environment:
            - Name: RUST_LOG
              Value: 'info,restate_fargate_controller=debug'
            - Name: CONTROLLER_LOG_FORMAT
              Value: json
            - Name: CONTROLLER_METADATA_PATH
              Value:
                'Fn::Join':
                  - ''
                  - - 's3://'
                    - Ref: withotelcollectorbucket91BBB0A6
                    - /metadata
            - Name: CONTROLLER_RECONCILE_INTERVAL
              Value: 10s
            - Name: CONTROLLER_CLUSTER__CLUSTER_ARN
              Value:
                'Fn::GetAtt':
                  - withotelcollectorcluster09679981
                  - Arn
            - Name: CONTROLLER_LICENSE_KEY
              Value: foo
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __REGION
              Value:
                Ref: 'AWS::Region'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __CLUSTER_ARN
              Value:
                'Fn::GetAtt':
                  - withotelcollectorcluster09679981
                  - Arn
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __TASK_PREFIX
              Value:
                'Fn::Join':
                  - /
                  - - 'Fn::Join':
                        - ':'
                        - - 'Fn::Select':
                              - 0
                              - 'Fn::Split':
                                  - ':'
                                  - 'Fn::Select':
                                      - 0
                                      - 'Fn::Split':
                                          - /
                                          - 'Fn::GetAtt':
                                              - withotelcollectorcluster09679981
                                              - Arn
                          - 'Fn::Select':
                              - 1
                              - 'Fn::Split':
                                  - ':'
                                  - 'Fn::Select':
                                      - 0
                                      - 'Fn::Split':
                                          - /
                                          - 'Fn::GetAtt':
                                              - withotelcollectorcluster09679981
                                              - Arn
                          - 'Fn::Select':
                              - 2
                              - 'Fn::Split':
                                  - ':'
                                  - 'Fn::Select':
                                      - 0
                                      - 'Fn::Split':
                                          - /
                                          - 'Fn::GetAtt':
                                              - withotelcollectorcluster09679981
                                              - Arn
                          - 'Fn::Select':
                              - 3
                              - 'Fn::Split':
                                  - ':'
                                  - 'Fn::Select':
                                      - 0
                                      - 'Fn::Split':
                                          - /
                                          - 'Fn::GetAtt':
                                              - withotelcollectorcluster09679981
                                              - Arn
                          - 'Fn::Select':
                              - 4
                              - 'Fn::Split':
                                  - ':'
                                  - 'Fn::Select':
                                      - 0
                                      - 'Fn::Split':
                                          - /
                                          - 'Fn::GetAtt':
                                              - withotelcollectorcluster09679981
                                              - Arn
                          - task
                    - 'Fn::Select':
                        - 1
                        - 'Fn::Split':
                            - /
                            - 'Fn::GetAtt':
                                - withotelcollectorcluster09679981
                                - Arn
                    - ''
            - Name: CONTROLLER_EBS_SNAPSHOT_RETENTION_PERIOD
              Value: 24h
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1a__ENABLE_EXECUTE_COMMAND
              Value: 'false'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1a__SECURITY_GROUPS
              Value:
                'Fn::Join':
                  - ''
                  - - '["'
                    - 'Fn::GetAtt':
                        - withotelcollectorsecuritygroupBD4A7399
                        - GroupId
                    - '"]'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1a__SUBNETS
              Value:
                'Fn::Join':
                  - ''
                  - - '["'
                    - 'Fn::ImportValue': >-
                        VPCStack:ExportsOutputRefvpcPrivateSubnet1Subnet934893E8236E2271
                    - '"]'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1a__TASK_DEFINITION_ARN
              Value:
                Ref: withotelcollectorstatefuldefinitionFB434419
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1a__COUNT
              Value: '1'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1b__ENABLE_EXECUTE_COMMAND
              Value: 'false'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1b__SECURITY_GROUPS
              Value:
                'Fn::Join':
                  - ''
                  - - '["'
                    - 'Fn::GetAtt':
                        - withotelcollectorsecuritygroupBD4A7399
                        - GroupId
                    - '"]'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1b__SUBNETS
              Value:
                'Fn::Join':
                  - ''
                  - - '["'
                    - 'Fn::ImportValue': >-
                        VPCStack:ExportsOutputRefvpcPrivateSubnet2Subnet7031C2BA60DCB1EE
                    - '"]'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1b__TASK_DEFINITION_ARN
              Value:
                Ref: withotelcollectorstatefuldefinitionFB434419
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1b__COUNT
              Value: '1'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1c__ENABLE_EXECUTE_COMMAND
              Value: 'false'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1c__SECURITY_GROUPS
              Value:
                'Fn::Join':
                  - ''
                  - - '["'
                    - 'Fn::GetAtt':
                        - withotelcollectorsecuritygroupBD4A7399
                        - GroupId
                    - '"]'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1c__SUBNETS
              Value:
                'Fn::Join':
                  - ''
                  - - '["'
                    - 'Fn::ImportValue': >-
                        VPCStack:ExportsOutputRefvpcPrivateSubnet3Subnet985AC459F9514491
                    - '"]'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1c__TASK_DEFINITION_ARN
              Value:
                Ref: withotelcollectorstatefuldefinitionFB434419
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1c__COUNT
              Value: '1'
          Essential: true
          HealthCheck:
            Command:
              - CMD
              - curl
              - '--fail'
              - 'http://127.0.0.1:8080/health'
            Interval: 30
            Retries: 10
            StartPeriod: 300
            Timeout: 5
          Image: Any<Object>
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group:
                Ref: withotelcollectorcontrollerloggroupE0170504
              awslogs-stream-prefix: controller
              awslogs-region: region
              mode: non-blocking
          Memory: 2048
          Name: controller
          StopTimeout: 120
      Cpu: '1024'
      ExecutionRoleArn:
        'Fn::GetAtt':
          - withotelcollectorcontrollerexecutionrole5AE5C9E0
          - Arn
      Family: RestateBYOCwithotelcollectorcontrollerdefinitionB39134AC
      Memory: '2048'
      NetworkMode: awsvpc
      RequiresCompatibilities:
        - FARGATE
      RuntimePlatform:
        CpuArchitecture: ARM64
        OperatingSystemFamily: LINUX
      Tags:
        - Key: Name
          Value: RestateBYOC/with-otel-collector/controller-definition
      TaskRoleArn:
        'Fn::GetAtt':
          - withotelcollectorcontrollertaskrole025F5504
          - Arn
  withotelcollectorcontrollerserviceService83299A78:
    Type: 'AWS::ECS::Service'
    Properties:
      Cluster:
        Ref: withotelcollectorcluster09679981
      DeploymentConfiguration:
        Alarms:
          AlarmNames: []
          Enable: false
          Rollback: false
        MaximumPercent: 100
        MinimumHealthyPercent: 0
      DeploymentController:
        Type: ECS
      DesiredCount: 1
      EnableECSManagedTags: false
      EnableExecuteCommand: false
      LaunchType: FARGATE
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: DISABLED
          SecurityGroups:
            - 'Fn::GetAtt':
                - withotelcollectorsecuritygroupBD4A7399
                - GroupId
          Subnets:
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet1Subnet934893E8236E2271'
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet2Subnet7031C2BA60DCB1EE'
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet3Subnet985AC459F9514491'
      Tags:
        - Key: Name
          Value: RestateBYOC/with-otel-collector/controller-service
      TaskDefinition:
        Ref: withotelcollectorcontrollerdefinitionD29F6C59
    DependsOn:
      - withotelcollectorcontrollertaskroleDefaultPolicyE9B648FA
      - withotelcollectorcontrollertaskrole025F5504
  withotelcollectorrestatectlloggroup4D5886B6:
    Type: 'AWS::Logs::LogGroup'
    Properties:
      RetentionInDays: 14
    UpdateReplacePolicy: Retain
    DeletionPolicy: Retain
  withotelcollectorrestatectllambdaexecutionroleA0831EA5:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
        Version: '2012-10-17'
  withotelcollectorrestatectllambdaexecutionroleDefaultPolicy07728179:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 'logs:CreateLogStream'
              - 'logs:PutLogEvents'
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'arn:'
                  - Ref: 'AWS::Partition'
                  - ':logs:'
                  - Ref: 'AWS::Region'
                  - ':'
                  - Ref: 'AWS::AccountId'
                  - ':log-group:'
                  - Ref: withotelcollectorrestatectlloggroup4D5886B6
                  - ':log-stream:*'
            Sid: AWSLambdaLogStreamPermissions
          - Action:
              - 'ec2:CreateNetworkInterface'
              - 'ec2:DescribeNetworkInterfaces'
              - 'ec2:DescribeSubnets'
              - 'ec2:DeleteNetworkInterface'
            Effect: Allow
            Resource: '*'
            Sid: AWSLambdaVPCWildcardPermissions
          - Action:
              - 'ec2:AssignPrivateIpAddresses'
              - 'ec2:UnassignPrivateIpAddresses'
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'arn:'
                  - Ref: 'AWS::Partition'
                  - ':ec2:'
                  - Ref: 'AWS::Region'
                  - ':'
                  - Ref: 'AWS::AccountId'
                  - ':network-interface/*'
            Sid: AWSLambdaVPCNetworkInterfacePermissions
        Version: '2012-10-17'
      PolicyName: withotelcollectorrestatectllambdaexecutionroleDefaultPolicy07728179
      Roles:
        - Ref: withotelcollectorrestatectllambdaexecutionroleA0831EA5
  withotelcollectorrestatectllambda4FF04021:
    Type: 'AWS::Lambda::Function'
    Properties:
      Architectures:
        - arm64
      Code: Any<Object>
      Environment:
        Variables:
          RESTATECTL_ADDRESS:
            'Fn::Join':
              - ''
              - - 'http://'
                - 'Fn::GetAtt':
                    - withotelcollectorsharednlbB07E655C
                    - DNSName
                - ':5122'
      Handler: restatectl
      LoggingConfig:
        LogGroup:
          Ref: withotelcollectorrestatectlloggroup4D5886B6
      Role:
        'Fn::GetAtt':
          - withotelcollectorrestatectllambdaexecutionroleA0831EA5
          - Arn
      Runtime: provided.al2023
      Tags:
        - Key: Name
          Value: RestateBYOC/with-otel-collector/restatectl-lambda
      Timeout: 10
      VpcConfig:
        SecurityGroupIds:
          - 'Fn::GetAtt':
              - withotelcollectorsecuritygroupBD4A7399
              - GroupId
        SubnetIds:
          - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet1Subnet934893E8236E2271'
          - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet2Subnet7031C2BA60DCB1EE'
          - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet3Subnet985AC459F9514491'
    DependsOn:
      - withotelcollectorrestatectllambdaexecutionroleDefaultPolicy07728179
      - withotelcollectorrestatectllambdaexecutionroleA0831EA5
  withotelcollectorretirementwatcherloggroupF6A70EF5:
    Type: 'AWS::Logs::LogGroup'
    Properties:
      RetentionInDays: 14
    UpdateReplacePolicy: Retain
    DeletionPolicy: Retain
  withotelcollectorretirementwatcherlambdaexecutionroleC58542B9:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
        Version: '2012-10-17'
  withotelcollectorretirementwatcherlambdaexecutionroleDefaultPolicy34803E07:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 'logs:CreateLogStream'
              - 'logs:PutLogEvents'
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'arn:'
                  - Ref: 'AWS::Partition'
                  - ':logs:'
                  - Ref: 'AWS::Region'
                  - ':'
                  - Ref: 'AWS::AccountId'
                  - ':log-group:'
                  - Ref: withotelcollectorretirementwatcherloggroupF6A70EF5
                  - ':log-stream:*'
            Sid: AWSLambdaLogStreamPermissions
          - Action: 'ecs:TagResource'
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'Fn::Join':
                      - /
                      - - 'Fn::Join':
                            - ':'
                            - - 'Fn::Select':
                                  - 0
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - withotelcollectorcluster09679981
                                                  - Arn
                              - 'Fn::Select':
                                  - 1
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - withotelcollectorcluster09679981
                                                  - Arn
                              - 'Fn::Select':
                                  - 2
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - withotelcollectorcluster09679981
                                                  - Arn
                              - 'Fn::Select':
                                  - 3
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - withotelcollectorcluster09679981
                                                  - Arn
                              - 'Fn::Select':
                                  - 4
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - withotelcollectorcluster09679981
                                                  - Arn
                              - task
                        - 'Fn::Select':
                            - 1
                            - 'Fn::Split':
                                - /
                                - 'Fn::GetAtt':
                                    - withotelcollectorcluster09679981
                                    - Arn
                        - ''
                  - '*'
            Sid: TagTasks
          - Action:
              - 'sqs:ReceiveMessage'
              - 'sqs:ChangeMessageVisibility'
              - 'sqs:GetQueueUrl'
              - 'sqs:DeleteMessage'
              - 'sqs:GetQueueAttributes'
            Effect: Allow
            Resource:
              'Fn::GetAtt':
                - withotelcollectorretirementwatcherqueue9A16F3EA
                - Arn
        Version: '2012-10-17'
      PolicyName: >-
        withotelcollectorretirementwatcherlambdaexecutionroleDefaultPolicy34803E07
      Roles:
        - Ref: withotelcollectorretirementwatcherlambdaexecutionroleC58542B9
  withotelcollectorretirementwatcherlambdaD651D071:
    Type: 'AWS::Lambda::Function'
    Properties:
      Architectures:
        - arm64
      Code: Any<Object>
      Handler: index.handler
      LoggingConfig:
        LogGroup:
          Ref: withotelcollectorretirementwatcherloggroupF6A70EF5
      Role:
        'Fn::GetAtt':
          - withotelcollectorretirementwatcherlambdaexecutionroleC58542B9
          - Arn
      Runtime: nodejs22.x
      Tags:
        - Key: Name
          Value: RestateBYOC/with-otel-collector/retirement-watcher-lambda
      Timeout: 60
    DependsOn:
      - >-
        withotelcollectorretirementwatcherlambdaexecutionroleDefaultPolicy34803E07
      - withotelcollectorretirementwatcherlambdaexecutionroleC58542B9
  withotelcollectorretirementwatcherlambdaSqsEventSourceRestateBYOCwithotelcollectorretirementwatcherqueue2005046DEEAC319F:
    Type: 'AWS::Lambda::EventSourceMapping'
    Properties:
      BatchSize: 1
      EventSourceArn:
        'Fn::GetAtt':
          - withotelcollectorretirementwatcherqueue9A16F3EA
          - Arn
      FunctionName:
        Ref: withotelcollectorretirementwatcherlambdaD651D071
      Tags:
        - Key: Name
          Value: RestateBYOC/with-otel-collector/retirement-watcher-lambda
  withotelcollectorretirementwatcherqueue9A16F3EA:
    Type: 'AWS::SQS::Queue'
    Properties:
      Tags:
        - Key: Name
          Value: RestateBYOC/with-otel-collector/retirement-watcher-queue
      VisibilityTimeout: 60
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  withotelcollectorretirementwatcherqueuePolicy29D1C5CB:
    Type: 'AWS::SQS::QueuePolicy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 'sqs:SendMessage'
              - 'sqs:GetQueueAttributes'
              - 'sqs:GetQueueUrl'
            Condition:
              ArnEquals:
                'aws:SourceArn':
                  'Fn::GetAtt':
                    - withotelcollectorretirementwatcherruleC06121B4
                    - Arn
            Effect: Allow
            Principal:
              Service: events.amazonaws.com
            Resource:
              'Fn::GetAtt':
                - withotelcollectorretirementwatcherqueue9A16F3EA
                - Arn
        Version: '2012-10-17'
      Queues:
        - Ref: withotelcollectorretirementwatcherqueue9A16F3EA
  withotelcollectorretirementwatcherruleC06121B4:
    Type: 'AWS::Events::Rule'
    Properties:
      EventPattern:
        detail:
          eventTypeCode:
            - equals-ignore-case: AWS_ECS_TASK_PATCHING_RETIREMENT
          service:
            - equals-ignore-case: ecs
        resources:
          - prefix:
              'Fn::Join':
                - /
                - - 'Fn::Join':
                      - ':'
                      - - 'Fn::Select':
                            - 0
                            - 'Fn::Split':
                                - ':'
                                - 'Fn::Select':
                                    - 0
                                    - 'Fn::Split':
                                        - /
                                        - 'Fn::GetAtt':
                                            - withotelcollectorcluster09679981
                                            - Arn
                        - 'Fn::Select':
                            - 1
                            - 'Fn::Split':
                                - ':'
                                - 'Fn::Select':
                                    - 0
                                    - 'Fn::Split':
                                        - /
                                        - 'Fn::GetAtt':
                                            - withotelcollectorcluster09679981
                                            - Arn
                        - 'Fn::Select':
                            - 2
                            - 'Fn::Split':
                                - ':'
                                - 'Fn::Select':
                                    - 0
                                    - 'Fn::Split':
                                        - /
                                        - 'Fn::GetAtt':
                                            - withotelcollectorcluster09679981
                                            - Arn
                        - 'Fn::Select':
                            - 3
                            - 'Fn::Split':
                                - ':'
                                - 'Fn::Select':
                                    - 0
                                    - 'Fn::Split':
                                        - /
                                        - 'Fn::GetAtt':
                                            - withotelcollectorcluster09679981
                                            - Arn
                        - 'Fn::Select':
                            - 4
                            - 'Fn::Split':
                                - ':'
                                - 'Fn::Select':
                                    - 0
                                    - 'Fn::Split':
                                        - /
                                        - 'Fn::GetAtt':
                                            - withotelcollectorcluster09679981
                                            - Arn
                        - task
                  - 'Fn::Select':
                      - 1
                      - 'Fn::Split':
                          - /
                          - 'Fn::GetAtt':
                              - withotelcollectorcluster09679981
                              - Arn
                  - ''
        detail-type:
          - equals-ignore-case: AWS Health Event
      State: ENABLED
      Targets:
        - Arn:
            'Fn::GetAtt':
              - withotelcollectorretirementwatcherqueue9A16F3EA
              - Arn
          Id: Target0
  withotelcollectorcloudwatchcustomwidgetloggroup476A8511:
    Type: 'AWS::Logs::LogGroup'
    Properties:
      RetentionInDays: 14
    UpdateReplacePolicy: Retain
    DeletionPolicy: Retain
  withotelcollectorcloudwatchcustomwidgetexecutionrole56230195:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
        Version: '2012-10-17'
  withotelcollectorcloudwatchcustomwidgetexecutionroleDefaultPolicy6173D3CE:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 'logs:CreateLogStream'
              - 'logs:PutLogEvents'
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'arn:'
                  - Ref: 'AWS::Partition'
                  - ':logs:'
                  - Ref: 'AWS::Region'
                  - ':'
                  - Ref: 'AWS::AccountId'
                  - ':log-group:'
                  - Ref: withotelcollectorcloudwatchcustomwidgetloggroup476A8511
                  - ':log-stream:*'
            Sid: AWSLambdaLogStreamPermissions
          - Action: 'lambda:InvokeFunction'
            Effect: Allow
            Resource:
              'Fn::GetAtt':
                - withotelcollectorrestatectllambda4FF04021
                - Arn
            Sid: InvokeRestatectl
          - Action: 'ecs:DescribeTaskDefinition'
            Effect: Allow
            Resource: '*'
            Sid: ECSReadActions
          - Action: 'ecs:ListTasks'
            Condition:
              StringEquals:
                'ecs:cluster':
                  'Fn::GetAtt':
                    - withotelcollectorcluster09679981
                    - Arn
            Effect: Allow
            Resource: '*'
            Sid: ECSListTasks
          - Action: 'ecs:DescribeTasks'
            Condition:
              StringEquals:
                'ecs:cluster':
                  'Fn::GetAtt':
                    - withotelcollectorcluster09679981
                    - Arn
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'arn:'
                  - Ref: 'AWS::Partition'
                  - ':ecs:'
                  - Ref: 'AWS::Region'
                  - ':'
                  - Ref: 'AWS::AccountId'
                  - ':task/'
                  - Ref: withotelcollectorcluster09679981
                  - /*
            Sid: ECSDescribeTasks
          - Action: 'ecs:DescribeServices'
            Condition:
              StringEquals:
                'ecs:cluster':
                  'Fn::GetAtt':
                    - withotelcollectorcluster09679981
                    - Arn
            Effect: Allow
            Resource:
              - Ref: withotelcollectorcontrollerserviceService83299A78
              - Ref: withotelcollectorstatelessserviceService8ABCCEA9
            Sid: ECSDescribeServices
          - Action: 'cloudwatch:GetMetricData'
            Effect: Allow
            Resource: '*'
            Sid: CloudWatchReadActions
        Version: '2012-10-17'
      PolicyName: >-
        withotelcollectorcloudwatchcustomwidgetexecutionroleDefaultPolicy6173D3CE
      Roles:
        - Ref: withotelcollectorcloudwatchcustomwidgetexecutionrole56230195
  withotelcollectorcloudwatchcustomwidgetlambdaECB1432F:
    Type: 'AWS::Lambda::Function'
    Properties:
      Architectures:
        - arm64
      Code: Any<Object>
      Environment:
        Variables:
          ENABLE_EBS_VOLUMES: 'false'
      Handler: index.handler
      LoggingConfig:
        LogGroup:
          Ref: withotelcollectorcloudwatchcustomwidgetloggroup476A8511
      MemorySize: 1024
      Role:
        'Fn::GetAtt':
          - withotelcollectorcloudwatchcustomwidgetexecutionrole56230195
          - Arn
      Runtime: nodejs22.x
      Tags:
        - Key: Name
          Value: RestateBYOC/with-otel-collector/cloudwatch-custom-widget-lambda
      Timeout: 60
    DependsOn:
      - >-
        withotelcollectorcloudwatchcustomwidgetexecutionroleDefaultPolicy6173D3CE
      - withotelcollectorcloudwatchcustomwidgetexecutionrole56230195
  withotelcollectorcloudwatchcustomwidgetlambdacloudwatchcustomwidgetlambdaallowdatasourceAF3A7C1A:
    Type: 'AWS::Lambda::Permission'
    Properties:
      Action: 'lambda:InvokeFunction'
      FunctionName:
        'Fn::GetAtt':
          - withotelcollectorcloudwatchcustomwidgetlambdaECB1432F
          - Arn
      Principal: lambda.datasource.cloudwatch.amazonaws.com
  withotelcollectormetrics493AA233:
    Type: 'AWS::CloudWatch::Dashboard'
    Properties:
      DashboardBody:
        'Fn::Join':
          - ''
          - - >-
              {"widgets":[{"type":"metric","width":12,"height":6,"x":0,"y":0,"properties":{"view":"timeSeries","title":"Stateless
              CPU","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"CPU","expression":"SELECT AVG(CpuUtilized)
              FROM SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOCwithotelcollectorstatelessdefinition8B26C72F' GROUP BY
              TaskId"}]],"annotations":{"horizontal":[{"value":16384,"label":"Limit","yAxis":"left"}]},"yAxis":{"left":{"label":"vCPUs","showUnits":false}}}},{"type":"metric","width":12,"height":6,"x":12,"y":0,"properties":{"view":"timeSeries","title":"Stateless
              Memory","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Memory","expression":"SELECT
              AVG(MemoryUtilized) FROM SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOCwithotelcollectorstatelessdefinition8B26C72F' GROUP BY
              TaskId"}]],"annotations":{"horizontal":[{"value":32768,"label":"Limit","yAxis":"left"}]},"yAxis":{"left":{"label":"MiB","showUnits":false}}}},{"type":"metric","width":12,"height":6,"x":0,"y":6,"properties":{"view":"timeSeries","title":"Stateless
              Network Tx","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Tx","expression":"SELECT
              AVG(NetworkTxBytes) FROM SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOCwithotelcollectorstatelessdefinition8B26C72F' GROUP BY
              TaskId"}]],"yAxis":{"left":{"label":"Bytes/sec","showUnits":false}}}},{"type":"metric","width":12,"height":6,"x":12,"y":6,"properties":{"view":"timeSeries","title":"Stateless
              Network Rx","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Rx","expression":"SELECT
              AVG(NetworkRxBytes) FROM SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOCwithotelcollectorstatelessdefinition8B26C72F' GROUP BY
              TaskId"}]],"yAxis":{"left":{"label":"Bytes/sec","showUnits":false}}}},{"type":"log","width":24,"height":6,"x":0,"y":12,"properties":{"view":"table","title":"Stateless
              Logs","region":"region","query":"SOURCE '
            - Ref: withotelcollectorrestateloggroupE7CD68F4
            - >-
              ' | fields @logStream, @timestamp, level, fields.message,
              target\\n          | sort @timestamp desc\\n          | limit
              500"}},{"type":"metric","width":12,"height":6,"x":0,"y":18,"properties":{"view":"timeSeries","title":"Stateful
              CPU","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"CPU","expression":"SELECT AVG(CpuUtilized)
              FROM SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOCwithotelcollectorstatefuldefinition83529E5C' GROUP BY
              TaskId"}]],"annotations":{"horizontal":[{"value":16384,"label":"Limit","yAxis":"left"}]},"yAxis":{"left":{"label":"vCPUs","showUnits":false}}}},{"type":"metric","width":12,"height":6,"x":12,"y":18,"properties":{"view":"timeSeries","title":"Stateful
              Memory","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Memory","expression":"SELECT
              AVG(MemoryUtilized) FROM SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOCwithotelcollectorstatefuldefinition83529E5C' GROUP BY
              TaskId"}]],"annotations":{"horizontal":[{"value":32768,"label":"Limit","yAxis":"left"}]},"yAxis":{"left":{"label":"MiB","showUnits":false}}}},{"type":"metric","width":12,"height":6,"x":0,"y":24,"properties":{"view":"timeSeries","title":"Stateful
              Network Tx","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Tx","expression":"SELECT
              AVG(NetworkTxBytes) FROM SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOCwithotelcollectorstatefuldefinition83529E5C' GROUP BY
              TaskId"}]],"yAxis":{"left":{"label":"Bytes/sec","showUnits":false}}}},{"type":"metric","width":12,"height":6,"x":12,"y":24,"properties":{"view":"timeSeries","title":"Stateful
              Network Rx","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Rx","expression":"SELECT
              AVG(NetworkRxBytes) FROM SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOCwithotelcollectorstatefuldefinition83529E5C' GROUP BY
              TaskId"}]],"yAxis":{"left":{"label":"Bytes/sec","showUnits":false}}}},{"type":"log","width":24,"height":6,"x":0,"y":30,"properties":{"view":"table","title":"Stateful
              Logs","region":"region","query":"SOURCE '
            - Ref: withotelcollectorrestateloggroupE7CD68F4
            - >-
              ' | fields @logStream, @timestamp, level, fields.message,
              target\\n          | sort @timestamp desc\\n          | limit
              500"}},{"type":"metric","width":8,"height":6,"x":0,"y":36,"properties":{"view":"timeSeries","title":"Ephemeral
              Volume Usage (Total size 200GiB)","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Usage","expression":"SELECT
              MAX(EphemeralStorageUtilized) FROM
              SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily) WHERE TaskDefinitionFamily =
              'RestateBYOCwithotelcollectorstatefuldefinition83529E5C'"}]],"annotations":{"horizontal":[{"value":200,"label":"Volume
              size","visible":false,"yAxis":"left"}]},"yAxis":{"left":{"label":"GiB","showUnits":false}},"liveData":false}},{"type":"metric","width":8,"height":6,"x":8,"y":36,"properties":{"view":"timeSeries","title":"Volume
              Write Throughput (Limited to 150 MiB/sec)","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Write","expression":"RATE(count) /
              1048576"}],[{"expression":"SELECT MAX(StorageWriteBytes) FROM
              SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOCwithotelcollectorstatefuldefinition83529E5C' GROUP BY
              TaskId","visible":false,"id":"count"}]],"annotations":{"horizontal":[{"value":150,"label":"Limit","visible":false,"yAxis":"left"}]},"yAxis":{"left":{"label":"MiB/sec","showUnits":false}}}},{"type":"metric","width":8,"height":6,"x":16,"y":36,"properties":{"view":"timeSeries","title":"Volume
              Read Throughput (Limited to 150 MiB/sec)","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Read","expression":"RATE(count) /
              1048576"}],[{"expression":"SELECT MAX(StorageReadBytes) FROM
              SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOCwithotelcollectorstatefuldefinition83529E5C' GROUP BY
              TaskId","visible":false,"id":"count"}]],"annotations":{"horizontal":[{"value":150,"label":"Limit","visible":false,"yAxis":"left"}]},"yAxis":{"left":{"label":"MiB/sec","showUnits":false}}}},{"type":"log","width":24,"height":6,"x":0,"y":42,"properties":{"view":"table","title":"Controller
              Logs","region":"region","query":"SOURCE '
            - Ref: withotelcollectorcontrollerloggroupE0170504
            - >-
              ' | fields @logStream, @timestamp, level, fields.message,
              target\\n          | sort @timestamp desc\\n          | limit
              500"}}]}
      DashboardName: RestateBYOC_with-otel-collector_metrics
  withotelcollectorcontrolpanel249EF470:
    Type: 'AWS::CloudWatch::Dashboard'
    Properties:
      DashboardBody:
        'Fn::Join':
          - ''
          - - >-
              {"widgets":[{"type":"custom","width":24,"height":26,"x":0,"y":0,"properties":{"endpoint":"
            - 'Fn::GetAtt':
                - withotelcollectorcloudwatchcustomwidgetlambdaECB1432F
                - Arn
            - '","params":{"command":"controlPanel","input":{"region":"'
            - Ref: 'AWS::Region'
            - >-
              ","summary":{"clusterName":"RestateBYOC/with-otel-collector","restateVersion":"1.4","stackVersion":"0.4.1-dev","metricsDashboardName":"
            - Ref: withotelcollectormetrics493AA233
            - '"},"resources":{"ecsClusterArn":"'
            - 'Fn::GetAtt':
                - withotelcollectorcluster09679981
                - Arn
            - '","statelessServiceArn":"'
            - Ref: withotelcollectorstatelessserviceService8ABCCEA9
            - '","controllerServiceArn":"'
            - Ref: withotelcollectorcontrollerserviceService83299A78
            - '","restatectlLambdaArn":"'
            - 'Fn::GetAtt':
                - withotelcollectorrestatectllambda4FF04021
                - Arn
            - >-
              "},"connectivityAndSecurity":{"connectivity":{"loadBalancerArns":{"ingress":["
            - Ref: withotelcollectorsharednlbB07E655C
            - '"],"admin":["'
            - Ref: withotelcollectorsharednlbB07E655C
            - '"]},"addresses":{"ingress":"http://'
            - 'Fn::GetAtt':
                - withotelcollectorsharednlbB07E655C
                - DNSName
            - ':8080","admin":"http://'
            - 'Fn::GetAtt':
                - withotelcollectorsharednlbB07E655C
                - DNSName
            - ':9070","webUI":"http://'
            - 'Fn::GetAtt':
                - withotelcollectorsharednlbB07E655C
                - DNSName
            - ':9070/ui"}},"networking":{"vpc":"'
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcA2121C384D1B3CDE'
            - '","availabilityZones":["dummy1a","dummy1b","dummy1c"],"subnets":["'
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet1Subnet934893E8236E2271'
            - '","'
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet2Subnet7031C2BA60DCB1EE'
            - '","'
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet3Subnet985AC459F9514491'
            - '"]},"security":{"securityGroups":["'
            - 'Fn::GetAtt':
                - withotelcollectorsecuritygroupBD4A7399
                - GroupId
            - '"]}},"storage":{"s3":{"bucket":"'
            - Ref: withotelcollectorbucket91BBB0A6
            - >-
              "}}}},"title":"","updateOn":{"refresh":true,"resize":true,"timeRange":true}}}]}
      DashboardName: RestateBYOC_with-otel-collector_control-panel
Outputs:
  withotelcollectorSecurityGroups05665198:
    Description: The security group IDs of the cluster
    Value:
      'Fn::GetAtt':
        - withotelcollectorsecuritygroupBD4A7399
        - GroupId
  withotelcollectorIngressNetworkListener1F059E1B:
    Description: The ARN of the network listener for the ingress port
    Value:
      Ref: withotelcollectoringresssharedlistener92B1BA62
  withotelcollectorIngressNetworkTargetGroup7FAC75AC:
    Description: The ARN of the network target group for the ingress port
    Value:
      Ref: withotelcollectoringresssharedtarget878F9905
  withotelcollectorAdminNetworkListenerC345BDBB:
    Description: The ARN of the network listener for the admin port
    Value:
      Ref: withotelcollectoradminsharedlistenerF5722F86
  withotelcollectorAdminNetworkTargetGroupD4894232:
    Description: The ARN of the network target group for the admin port
    Value:
      Ref: withotelcollectoradminsharedtarget90E7DEFD
  withotelcollectorNodeNetworkListenerDF53C8EC:
    Description: The ARN of the network listener for the node port
    Value:
      Ref: withotelcollectornodesharedlistenerF009ADCC
  withotelcollectorNodeNetworkTargetGroupA7210A1E:
    Description: The ARN of the network target group for the node port
    Value:
      Ref: withotelcollectornodesharedtarget3F81F89C
"
`;

exports[`BYOC With specific SG and subnets 1`] = `
"Resources:
  sg29196201:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      GroupDescription: RestateBYOC/sg
      SecurityGroupEgress:
        - CidrIp: 0.0.0.0/0
          Description: Allow all outbound traffic by default
          IpProtocol: '-1'
      VpcId:
        'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcA2121C384D1B3CDE'
  withvpcsubnetbucket1E081BFF:
    Type: 'AWS::S3::Bucket'
    Properties:
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
    UpdateReplacePolicy: Retain
    DeletionPolicy: Retain
  withvpcsubnetbucketPolicyCC735A2D:
    Type: 'AWS::S3::BucketPolicy'
    Properties:
      Bucket:
        Ref: withvpcsubnetbucket1E081BFF
      PolicyDocument:
        Statement:
          - Action: 's3:*'
            Condition:
              Bool:
                'aws:SecureTransport': 'false'
            Effect: Deny
            Principal:
              AWS: '*'
            Resource:
              - 'Fn::GetAtt':
                  - withvpcsubnetbucket1E081BFF
                  - Arn
              - 'Fn::Join':
                  - ''
                  - - 'Fn::GetAtt':
                        - withvpcsubnetbucket1E081BFF
                        - Arn
                    - /*
        Version: '2012-10-17'
  withvpcsubnetcluster14F481BD:
    Type: 'AWS::ECS::Cluster'
    Properties:
      ClusterSettings:
        - Name: containerInsights
          Value: enhanced
      Tags:
        - Key: Name
          Value: RestateBYOC/with-vpc-subnet/cluster
  withvpcsubnetrestatetaskrole0DB71BBB:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
        Version: '2012-10-17'
  withvpcsubnetrestatetaskroleDefaultPolicy3F77BBD4:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 's3:GetObject'
              - 's3:PutObject'
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'Fn::GetAtt':
                      - withvpcsubnetbucket1E081BFF
                      - Arn
                  - /*
            Sid: ReadWriteBucket
          - Action: 's3:ListBucket'
            Effect: Allow
            Resource:
              'Fn::GetAtt':
                - withvpcsubnetbucket1E081BFF
                - Arn
            Sid: ListBucket
        Version: '2012-10-17'
      PolicyName: withvpcsubnetrestatetaskroleDefaultPolicy3F77BBD4
      Roles:
        - Ref: withvpcsubnetrestatetaskrole0DB71BBB
  withvpcsubnetrestateexecutionrole09337314:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
        Version: '2012-10-17'
  withvpcsubnetrestateexecutionroleDefaultPolicy028A2DDF:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 'logs:CreateLogStream'
              - 'logs:PutLogEvents'
            Effect: Allow
            Resource:
              'Fn::GetAtt':
                - withvpcsubnetrestateloggroup9A66BB7A
                - Arn
        Version: '2012-10-17'
      PolicyName: withvpcsubnetrestateexecutionroleDefaultPolicy028A2DDF
      Roles:
        - Ref: withvpcsubnetrestateexecutionrole09337314
  withvpcsubnetrestateloggroup9A66BB7A:
    Type: 'AWS::Logs::LogGroup'
    Properties:
      RetentionInDays: 30
    UpdateReplacePolicy: Retain
    DeletionPolicy: Retain
  withvpcsubnetcontrollerloggroup5F5E6509:
    Type: 'AWS::Logs::LogGroup'
    Properties:
      RetentionInDays: 30
    UpdateReplacePolicy: Retain
    DeletionPolicy: Retain
  withvpcsubnetsharednlb5421469F:
    Type: 'AWS::ElasticLoadBalancingV2::LoadBalancer'
    Properties:
      LoadBalancerAttributes:
        - Key: deletion_protection.enabled
          Value: 'false'
        - Key: load_balancing.cross_zone.enabled
          Value: 'false'
        - Key: dns_record.client_routing_policy
          Value: availability_zone_affinity
      Scheme: internal
      SecurityGroups:
        - 'Fn::GetAtt':
            - sg29196201
            - GroupId
      Subnets:
        - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet1Subnet934893E8236E2271'
        - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet2Subnet7031C2BA60DCB1EE'
      Tags:
        - Key: Name
          Value: RestateBYOC/with-vpc-subnet/shared-nlb
      Type: network
  withvpcsubnetingresssharedlistener4D3399EF:
    Type: 'AWS::ElasticLoadBalancingV2::Listener'
    Properties:
      DefaultActions:
        - TargetGroupArn:
            Ref: withvpcsubnetingresssharedtargetE6C22455
          Type: forward
      LoadBalancerArn:
        Ref: withvpcsubnetsharednlb5421469F
      Port: 8080
      Protocol: TCP
  withvpcsubnetadminsharedlistenerA099F537:
    Type: 'AWS::ElasticLoadBalancingV2::Listener'
    Properties:
      DefaultActions:
        - TargetGroupArn:
            Ref: withvpcsubnetadminsharedtarget8C328C16
          Type: forward
      LoadBalancerArn:
        Ref: withvpcsubnetsharednlb5421469F
      Port: 9070
      Protocol: TCP
  withvpcsubnetnodesharedlistener362A7851:
    Type: 'AWS::ElasticLoadBalancingV2::Listener'
    Properties:
      DefaultActions:
        - TargetGroupArn:
            Ref: withvpcsubnetnodesharedtarget7EB5F977
          Type: forward
      LoadBalancerArn:
        Ref: withvpcsubnetsharednlb5421469F
      Port: 5122
      Protocol: TCP
  withvpcsubnetstatelessdefinitionCF58C10F:
    Type: 'AWS::ECS::TaskDefinition'
    Properties:
      ContainerDefinitions:
        - Cpu: 16384
          EntryPoint:
            - bash
            - '-c'
            - >

              curl --no-progress-meter $ECS_CONTAINER_METADATA_URI_V4 -o
              container-metadata && \\

              curl --no-progress-meter $ECS_CONTAINER_METADATA_URI_V4/task -o
              task-metadata && \\

              export \\
                RESTATE_NODE_NAME=$(jq -r '.TaskARN' task-metadata) \\
                RESTATE_LOCATION="$AWS_REGION.$(jq -r '.AvailabilityZone' task-metadata)" \\
                RESTATE_ADVERTISED_ADDRESS="http://$(jq -r '.Networks[0].IPv4Addresses[0]' container-metadata):5122"
              exec restate-server
          Environment:
            - Name: RESTATE_LOG_FORMAT
              Value: json
            - Name: RESTATE_CLUSTER_NAME
              Value: RestateBYOC/with-vpc-subnet
            - Name: RESTATE_ROLES
              Value: '["admin","http-ingress"]'
            - Name: RESTATE_AUTO_PROVISION
              Value: 'true'
            - Name: RESTATE_SHUTDOWN_TIMEOUT
              Value: 100s
            - Name: RESTATE_DEFAULT_NUM_PARTITIONS
              Value: '128'
            - Name: RESTATE_DEFAULT_REPLICATION
              Value: '{node: 2}'
            - Name: RESTATE_METADATA_CLIENT__TYPE
              Value: object-store
            - Name: RESTATE_METADATA_CLIENT__PATH
              Value:
                'Fn::Join':
                  - ''
                  - - 's3://'
                    - Ref: withvpcsubnetbucket1E081BFF
                    - /metadata
            - Name: RESTATE_BIFROST__DEFAULT_PROVIDER
              Value: replicated
            - Name: >-
                RESTATE_INGRESS__EXPERIMENTAL_FEATURE_ENABLE_SEPARATE_INGRESS_ROLE
              Value: 'true'
            - Name: RESTATE_INGRESS__ADVERTISED_INGRESS_ENDPOINT
              Value:
                'Fn::Join':
                  - ''
                  - - 'http://'
                    - 'Fn::GetAtt':
                        - withvpcsubnetsharednlb5421469F
                        - DNSName
                    - ':8080'
            - Name: RESTATE_WORKER__SNAPSHOTS__DESTINATION
              Value:
                'Fn::Join':
                  - ''
                  - - 's3://'
                    - Ref: withvpcsubnetbucket1E081BFF
                    - /snapshots
          Essential: true
          HealthCheck:
            Command:
              - CMD
              - curl
              - '--fail'
              - 'http://127.0.0.1:8080/restate/health'
            Interval: 30
            Retries: 3
            Timeout: 5
          Image: Any<Object>
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group:
                Ref: withvpcsubnetrestateloggroup9A66BB7A
              awslogs-stream-prefix: restate
              awslogs-region: region
              mode: non-blocking
          Memory: 32768
          Name: restate
          PortMappings:
            - ContainerPort: 8080
              Name: ingress
              Protocol: tcp
            - ContainerPort: 9070
              Name: admin
              Protocol: tcp
            - ContainerPort: 5122
              Name: node
              Protocol: tcp
          StopTimeout: 120
      Cpu: '16384'
      ExecutionRoleArn:
        'Fn::GetAtt':
          - withvpcsubnetrestateexecutionrole09337314
          - Arn
      Family: RestateBYOCwithvpcsubnetstatelessdefinitionFB34AE10
      Memory: '32768'
      NetworkMode: awsvpc
      RequiresCompatibilities:
        - FARGATE
      RuntimePlatform:
        CpuArchitecture: ARM64
        OperatingSystemFamily: LINUX
      Tags:
        - Key: Name
          Value: RestateBYOC/with-vpc-subnet/stateless-definition
      TaskRoleArn:
        'Fn::GetAtt':
          - withvpcsubnetrestatetaskrole0DB71BBB
          - Arn
  withvpcsubnetstatelessserviceService547C3679:
    Type: 'AWS::ECS::Service'
    Properties:
      AvailabilityZoneRebalancing: ENABLED
      Cluster:
        Ref: withvpcsubnetcluster14F481BD
      DeploymentConfiguration:
        Alarms:
          AlarmNames: []
          Enable: false
          Rollback: false
        MaximumPercent: 200
        MinimumHealthyPercent: 100
      DeploymentController:
        Type: ECS
      DesiredCount: 3
      EnableECSManagedTags: false
      EnableExecuteCommand: false
      HealthCheckGracePeriodSeconds: 60
      LaunchType: FARGATE
      LoadBalancers:
        - ContainerName: restate
          ContainerPort: 8080
          TargetGroupArn:
            Ref: withvpcsubnetingresssharedtargetE6C22455
        - ContainerName: restate
          ContainerPort: 9070
          TargetGroupArn:
            Ref: withvpcsubnetadminsharedtarget8C328C16
        - ContainerName: restate
          ContainerPort: 5122
          TargetGroupArn:
            Ref: withvpcsubnetnodesharedtarget7EB5F977
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: DISABLED
          SecurityGroups:
            - 'Fn::GetAtt':
                - sg29196201
                - GroupId
          Subnets:
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet1Subnet934893E8236E2271'
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet2Subnet7031C2BA60DCB1EE'
      PropagateTags: SERVICE
      Tags:
        - Key: Name
          Value: RestateBYOC/with-vpc-subnet/stateless-service
      TaskDefinition:
        Ref: withvpcsubnetstatelessdefinitionCF58C10F
    DependsOn:
      - withvpcsubnetadminsharedlistenerA099F537
      - withvpcsubnetingresssharedlistener4D3399EF
      - withvpcsubnetnodesharedlistener362A7851
      - withvpcsubnetrestatetaskroleDefaultPolicy3F77BBD4
      - withvpcsubnetrestatetaskrole0DB71BBB
  withvpcsubnetstatefuldefinitionC0B189B6:
    Type: 'AWS::ECS::TaskDefinition'
    Properties:
      ContainerDefinitions:
        - Cpu: 16384
          EntryPoint:
            - bash
            - '-c'
            - >

              curl --no-progress-meter $ECS_CONTAINER_METADATA_URI_V4 -o
              container-metadata && \\

              curl --no-progress-meter $ECS_CONTAINER_METADATA_URI_V4/task -o
              task-metadata && \\

              export \\
                RESTATE_NODE_NAME=$(jq -r '.TaskARN' task-metadata) \\
                RESTATE_LOCATION="$AWS_REGION.$(jq -r '.AvailabilityZone' task-metadata)" \\
                RESTATE_ADVERTISED_ADDRESS="http://$(jq -r '.Networks[0].IPv4Addresses[0]' container-metadata):5122" \\
                RESTATE_ROCKSDB_TOTAL_MEMORY_SIZE="$(($(jq -r '.Limits.Memory' container-metadata) * 3 / 4))MiB" \\
                RESTATE_WORKER__STORAGE__NUM_PARTITIONS_TO_SHARE_MEMORY_BUDGET=$(("$RESTATE_WORKER__STORAGE__NUM_PARTITIONS_TO_SHARE_MEMORY_BUDGET"))
              exec restate-server
          Environment:
            - Name: RESTATE_LOG_FORMAT
              Value: json
            - Name: RESTATE_CLUSTER_NAME
              Value: RestateBYOC/with-vpc-subnet
            - Name: RESTATE_ROLES
              Value: '["log-server", "worker"]'
            - Name: RESTATE_AUTO_PROVISION
              Value: 'false'
            - Name: RESTATE_SHUTDOWN_TIMEOUT
              Value: 100s
            - Name: RESTATE_METADATA_CLIENT__TYPE
              Value: object-store
            - Name: RESTATE_METADATA_CLIENT__PATH
              Value:
                'Fn::Join':
                  - ''
                  - - 's3://'
                    - Ref: withvpcsubnetbucket1E081BFF
                    - /metadata
            - Name: RESTATE_WORKER__SNAPSHOTS__DESTINATION
              Value:
                'Fn::Join':
                  - ''
                  - - 's3://'
                    - Ref: withvpcsubnetbucket1E081BFF
                    - /snapshots
            - Name: RESTATE_WORKER__SNAPSHOTS__SNAPSHOT_INTERVAL_NUM_RECORDS
              Value: '1000000'
            - Name: RESTATE_WORKER__STORAGE__ROCKSDB_DISABLE_DIRECT_IO_FOR_READS
              Value: 'true'
            - Name: RESTATE_WORKER__STORAGE__ROCKSDB_DISABLE_WAL_FSYNC
              Value: 'true'
            - Name: RESTATE_WORKER__STORAGE__NUM_PARTITIONS_TO_SHARE_MEMORY_BUDGET
              Value: (128 * 2) / (2 * 1)
            - Name: RESTATE_LOG_SERVER__ROCKSDB_DISABLE_WAL_FSYNC
              Value: 'true'
            - Name: RESTATE_LOG_SERVER__ROCKSDB_DISABLE_DIRECT_IO_FOR_READS
              Value: 'true'
            - Name: >-
                RESTATE_INGRESS__EXPERIMENTAL_FEATURE_ENABLE_SEPARATE_INGRESS_ROLE
              Value: 'true'
          Essential: true
          HealthCheck:
            Command:
              - CMD
              - curl
              - '--fail'
              - 'http://127.0.0.1:5122/health'
            Interval: 30
            Retries: 3
            Timeout: 5
          Image: Any<Object>
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group:
                Ref: withvpcsubnetrestateloggroup9A66BB7A
              awslogs-stream-prefix: restate
              awslogs-region: region
              mode: non-blocking
          Memory: 32768
          MountPoints:
            - ContainerPath: /restate-data
              ReadOnly: false
              SourceVolume: restate-data
          Name: restate
          PortMappings:
            - ContainerPort: 5122
              Name: node
              Protocol: tcp
          RestartPolicy:
            Enabled: true
            RestartAttemptPeriod: 60
          StopTimeout: 120
      Cpu: '16384'
      EphemeralStorage:
        SizeInGiB: 200
      ExecutionRoleArn:
        'Fn::GetAtt':
          - withvpcsubnetrestateexecutionrole09337314
          - Arn
      Family: RestateBYOCwithvpcsubnetstatefuldefinition3D0F1E76
      Memory: '32768'
      NetworkMode: awsvpc
      RequiresCompatibilities:
        - FARGATE
      RuntimePlatform:
        CpuArchitecture: ARM64
        OperatingSystemFamily: LINUX
      Tags:
        - Key: Name
          Value: RestateBYOC/with-vpc-subnet/stateful-definition
      TaskRoleArn:
        'Fn::GetAtt':
          - withvpcsubnetrestatetaskrole0DB71BBB
          - Arn
      Volumes:
        - ConfiguredAtLaunch: false
          Name: restate-data
  withvpcsubnetingresssharedtargetE6C22455:
    Type: 'AWS::ElasticLoadBalancingV2::TargetGroup'
    Properties:
      HealthCheckEnabled: true
      HealthCheckIntervalSeconds: 5
      HealthCheckPath: /restate/health
      HealthCheckProtocol: HTTP
      HealthCheckTimeoutSeconds: 2
      Port: 8080
      Protocol: TCP
      Tags:
        - Key: Name
          Value: RestateBYOC/with-vpc-subnet/ingress-shared-target
      TargetType: ip
      VpcId:
        'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcA2121C384D1B3CDE'
  withvpcsubnetadminsharedtarget8C328C16:
    Type: 'AWS::ElasticLoadBalancingV2::TargetGroup'
    Properties:
      HealthCheckEnabled: true
      HealthCheckIntervalSeconds: 5
      HealthCheckPath: /health
      HealthCheckPort: '9070'
      HealthCheckProtocol: HTTP
      HealthCheckTimeoutSeconds: 2
      Port: 9070
      Protocol: TCP
      Tags:
        - Key: Name
          Value: RestateBYOC/with-vpc-subnet/admin-shared-target
      TargetType: ip
      VpcId:
        'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcA2121C384D1B3CDE'
  withvpcsubnetnodesharedtarget7EB5F977:
    Type: 'AWS::ElasticLoadBalancingV2::TargetGroup'
    Properties:
      HealthCheckEnabled: true
      HealthCheckIntervalSeconds: 5
      HealthCheckPath: /health
      HealthCheckPort: '5122'
      HealthCheckProtocol: HTTP
      HealthCheckTimeoutSeconds: 2
      Port: 5122
      Protocol: TCP
      Tags:
        - Key: Name
          Value: RestateBYOC/with-vpc-subnet/node-shared-target
      TargetType: ip
      VpcId:
        'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcA2121C384D1B3CDE'
  withvpcsubnetcontrollertaskrole89CF9CC3:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
        Version: '2012-10-17'
  withvpcsubnetcontrollertaskroleDefaultPolicy33CDD013:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action: 'ecs:ListTasks'
            Condition:
              ArnEquals:
                'ecs:cluster':
                  'Fn::GetAtt':
                    - withvpcsubnetcluster14F481BD
                    - Arn
            Effect: Allow
            Resource: '*'
            Sid: ECSListActions
          - Action:
              - 'ecs:TagResource'
              - 'ecs:DescribeTasks'
              - 'ecs:StopTask'
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'Fn::Join':
                      - /
                      - - 'Fn::Join':
                            - ':'
                            - - 'Fn::Select':
                                  - 0
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - withvpcsubnetcluster14F481BD
                                                  - Arn
                              - 'Fn::Select':
                                  - 1
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - withvpcsubnetcluster14F481BD
                                                  - Arn
                              - 'Fn::Select':
                                  - 2
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - withvpcsubnetcluster14F481BD
                                                  - Arn
                              - 'Fn::Select':
                                  - 3
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - withvpcsubnetcluster14F481BD
                                                  - Arn
                              - 'Fn::Select':
                                  - 4
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - withvpcsubnetcluster14F481BD
                                                  - Arn
                              - task
                        - 'Fn::Select':
                            - 1
                            - 'Fn::Split':
                                - /
                                - 'Fn::GetAtt':
                                    - withvpcsubnetcluster14F481BD
                                    - Arn
                        - ''
                  - '*'
            Sid: TaskActions
          - Action: 'ecs:RunTask'
            Condition:
              ArnEquals:
                'ecs:cluster':
                  'Fn::GetAtt':
                    - withvpcsubnetcluster14F481BD
                    - Arn
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'Fn::Join':
                      - ':'
                      - - 'Fn::Select':
                            - 0
                            - 'Fn::Split':
                                - ':'
                                - Ref: withvpcsubnetstatefuldefinitionC0B189B6
                        - 'Fn::Select':
                            - 1
                            - 'Fn::Split':
                                - ':'
                                - Ref: withvpcsubnetstatefuldefinitionC0B189B6
                        - 'Fn::Select':
                            - 2
                            - 'Fn::Split':
                                - ':'
                                - Ref: withvpcsubnetstatefuldefinitionC0B189B6
                        - 'Fn::Select':
                            - 3
                            - 'Fn::Split':
                                - ':'
                                - Ref: withvpcsubnetstatefuldefinitionC0B189B6
                        - 'Fn::Select':
                            - 4
                            - 'Fn::Split':
                                - ':'
                                - Ref: withvpcsubnetstatefuldefinitionC0B189B6
                        - 'Fn::Select':
                            - 5
                            - 'Fn::Split':
                                - ':'
                                - Ref: withvpcsubnetstatefuldefinitionC0B189B6
                  - ':*'
            Sid: RunTask
          - Action: 'iam:PassRole'
            Condition:
              StringEquals:
                'iam:PassedToService': ecs-tasks.amazonaws.com
            Effect: Allow
            Resource:
              - 'Fn::GetAtt':
                  - withvpcsubnetrestatetaskrole0DB71BBB
                  - Arn
              - 'Fn::GetAtt':
                  - withvpcsubnetrestateexecutionrole09337314
                  - Arn
            Sid: RunTaskPassRole
          - Action:
              - 'ec2:DescribeVolumes'
              - 'ec2:DescribeSnapshots'
            Effect: Allow
            Resource: '*'
            Sid: EC2ListActions
          - Action: 'ec2:CreateSnapshot'
            Condition:
              ArnEquals:
                'aws:RequestTag/restate:ecsClusterArn':
                  'Fn::GetAtt':
                    - withvpcsubnetcluster14F481BD
                    - Arn
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'arn:'
                  - Ref: 'AWS::Partition'
                  - ':ec2:'
                  - Ref: 'AWS::Region'
                  - '::snapshot/*'
            Sid: CreateSnapshot
          - Action: 'ec2:CreateSnapshot'
            Condition:
              ArnEquals:
                'aws:ResourceTag/restate:ecsClusterArn':
                  'Fn::GetAtt':
                    - withvpcsubnetcluster14F481BD
                    - Arn
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'arn:'
                  - Ref: 'AWS::Partition'
                  - ':ec2:'
                  - Ref: 'AWS::Region'
                  - ':'
                  - Ref: 'AWS::AccountId'
                  - ':volume/*'
            Sid: SnapshotVolume
          - Action: 'ec2:CreateTags'
            Condition:
              StringEquals:
                'ec2:CreateAction': CreateSnapshot
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'arn:'
                  - Ref: 'AWS::Partition'
                  - ':ec2:'
                  - Ref: 'AWS::Region'
                  - '::snapshot/*'
            Sid: TagSnapshots
          - Action:
              - 'ec2:DeleteVolume'
              - 'ec2:DeleteSnapshot'
            Condition:
              ArnEquals:
                'aws:ResourceTag/restate:ecsClusterArn':
                  'Fn::GetAtt':
                    - withvpcsubnetcluster14F481BD
                    - Arn
            Effect: Allow
            Resource:
              - 'Fn::Join':
                  - ''
                  - - 'arn:'
                    - Ref: 'AWS::Partition'
                    - ':ec2:'
                    - Ref: 'AWS::Region'
                    - ':'
                    - Ref: 'AWS::AccountId'
                    - ':volume/*'
              - 'Fn::Join':
                  - ''
                  - - 'arn:'
                    - Ref: 'AWS::Partition'
                    - ':ec2:'
                    - Ref: 'AWS::Region'
                    - '::snapshot/*'
            Sid: DeleteVolumeAndSnapshot
          - Action:
              - 's3:GetObject'
              - 's3:PutObject'
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'Fn::GetAtt':
                      - withvpcsubnetbucket1E081BFF
                      - Arn
                  - /*
            Sid: ReadWriteBucket
          - Action: 's3:ListBucket'
            Effect: Allow
            Resource:
              'Fn::GetAtt':
                - withvpcsubnetbucket1E081BFF
                - Arn
            Sid: ListBucket
        Version: '2012-10-17'
      PolicyName: withvpcsubnetcontrollertaskroleDefaultPolicy33CDD013
      Roles:
        - Ref: withvpcsubnetcontrollertaskrole89CF9CC3
  withvpcsubnetcontrollerexecutionrole4A321FEC:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
        Version: '2012-10-17'
  withvpcsubnetcontrollerexecutionroleDefaultPolicy84E61BC0:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 'logs:CreateLogStream'
              - 'logs:PutLogEvents'
            Effect: Allow
            Resource:
              'Fn::GetAtt':
                - withvpcsubnetcontrollerloggroup5F5E6509
                - Arn
        Version: '2012-10-17'
      PolicyName: withvpcsubnetcontrollerexecutionroleDefaultPolicy84E61BC0
      Roles:
        - Ref: withvpcsubnetcontrollerexecutionrole4A321FEC
  withvpcsubnetcontrollerdefinition30C81EC1:
    Type: 'AWS::ECS::TaskDefinition'
    Properties:
      ContainerDefinitions:
        - Cpu: 1024
          Environment:
            - Name: RUST_LOG
              Value: 'info,restate_fargate_controller=debug'
            - Name: CONTROLLER_LOG_FORMAT
              Value: json
            - Name: CONTROLLER_METADATA_PATH
              Value:
                'Fn::Join':
                  - ''
                  - - 's3://'
                    - Ref: withvpcsubnetbucket1E081BFF
                    - /metadata
            - Name: CONTROLLER_RECONCILE_INTERVAL
              Value: 10s
            - Name: CONTROLLER_CLUSTER__CLUSTER_ARN
              Value:
                'Fn::GetAtt':
                  - withvpcsubnetcluster14F481BD
                  - Arn
            - Name: CONTROLLER_LICENSE_KEY
              Value: foo
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __REGION
              Value:
                Ref: 'AWS::Region'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __CLUSTER_ARN
              Value:
                'Fn::GetAtt':
                  - withvpcsubnetcluster14F481BD
                  - Arn
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __TASK_PREFIX
              Value:
                'Fn::Join':
                  - /
                  - - 'Fn::Join':
                        - ':'
                        - - 'Fn::Select':
                              - 0
                              - 'Fn::Split':
                                  - ':'
                                  - 'Fn::Select':
                                      - 0
                                      - 'Fn::Split':
                                          - /
                                          - 'Fn::GetAtt':
                                              - withvpcsubnetcluster14F481BD
                                              - Arn
                          - 'Fn::Select':
                              - 1
                              - 'Fn::Split':
                                  - ':'
                                  - 'Fn::Select':
                                      - 0
                                      - 'Fn::Split':
                                          - /
                                          - 'Fn::GetAtt':
                                              - withvpcsubnetcluster14F481BD
                                              - Arn
                          - 'Fn::Select':
                              - 2
                              - 'Fn::Split':
                                  - ':'
                                  - 'Fn::Select':
                                      - 0
                                      - 'Fn::Split':
                                          - /
                                          - 'Fn::GetAtt':
                                              - withvpcsubnetcluster14F481BD
                                              - Arn
                          - 'Fn::Select':
                              - 3
                              - 'Fn::Split':
                                  - ':'
                                  - 'Fn::Select':
                                      - 0
                                      - 'Fn::Split':
                                          - /
                                          - 'Fn::GetAtt':
                                              - withvpcsubnetcluster14F481BD
                                              - Arn
                          - 'Fn::Select':
                              - 4
                              - 'Fn::Split':
                                  - ':'
                                  - 'Fn::Select':
                                      - 0
                                      - 'Fn::Split':
                                          - /
                                          - 'Fn::GetAtt':
                                              - withvpcsubnetcluster14F481BD
                                              - Arn
                          - task
                    - 'Fn::Select':
                        - 1
                        - 'Fn::Split':
                            - /
                            - 'Fn::GetAtt':
                                - withvpcsubnetcluster14F481BD
                                - Arn
                    - ''
            - Name: CONTROLLER_EBS_SNAPSHOT_RETENTION_PERIOD
              Value: 24h
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1a__ENABLE_EXECUTE_COMMAND
              Value: 'false'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1a__SECURITY_GROUPS
              Value:
                'Fn::Join':
                  - ''
                  - - '["'
                    - 'Fn::GetAtt':
                        - sg29196201
                        - GroupId
                    - '"]'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1a__SUBNETS
              Value:
                'Fn::Join':
                  - ''
                  - - '["'
                    - 'Fn::ImportValue': >-
                        VPCStack:ExportsOutputRefvpcPrivateSubnet1Subnet934893E8236E2271
                    - '"]'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1a__TASK_DEFINITION_ARN
              Value:
                Ref: withvpcsubnetstatefuldefinitionC0B189B6
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1a__COUNT
              Value: '1'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1b__ENABLE_EXECUTE_COMMAND
              Value: 'false'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1b__SECURITY_GROUPS
              Value:
                'Fn::Join':
                  - ''
                  - - '["'
                    - 'Fn::GetAtt':
                        - sg29196201
                        - GroupId
                    - '"]'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1b__SUBNETS
              Value:
                'Fn::Join':
                  - ''
                  - - '["'
                    - 'Fn::ImportValue': >-
                        VPCStack:ExportsOutputRefvpcPrivateSubnet2Subnet7031C2BA60DCB1EE
                    - '"]'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1b__TASK_DEFINITION_ARN
              Value:
                Ref: withvpcsubnetstatefuldefinitionC0B189B6
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1b__COUNT
              Value: '1'
          Essential: true
          HealthCheck:
            Command:
              - CMD
              - curl
              - '--fail'
              - 'http://127.0.0.1:8080/health'
            Interval: 30
            Retries: 10
            StartPeriod: 300
            Timeout: 5
          Image: Any<Object>
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group:
                Ref: withvpcsubnetcontrollerloggroup5F5E6509
              awslogs-stream-prefix: controller
              awslogs-region: region
              mode: non-blocking
          Memory: 2048
          Name: controller
          StopTimeout: 120
      Cpu: '1024'
      ExecutionRoleArn:
        'Fn::GetAtt':
          - withvpcsubnetcontrollerexecutionrole4A321FEC
          - Arn
      Family: RestateBYOCwithvpcsubnetcontrollerdefinition90906246
      Memory: '2048'
      NetworkMode: awsvpc
      RequiresCompatibilities:
        - FARGATE
      RuntimePlatform:
        CpuArchitecture: ARM64
        OperatingSystemFamily: LINUX
      Tags:
        - Key: Name
          Value: RestateBYOC/with-vpc-subnet/controller-definition
      TaskRoleArn:
        'Fn::GetAtt':
          - withvpcsubnetcontrollertaskrole89CF9CC3
          - Arn
  withvpcsubnetcontrollerserviceServiceEDFDC99A:
    Type: 'AWS::ECS::Service'
    Properties:
      Cluster:
        Ref: withvpcsubnetcluster14F481BD
      DeploymentConfiguration:
        Alarms:
          AlarmNames: []
          Enable: false
          Rollback: false
        MaximumPercent: 100
        MinimumHealthyPercent: 0
      DeploymentController:
        Type: ECS
      DesiredCount: 1
      EnableECSManagedTags: false
      EnableExecuteCommand: false
      LaunchType: FARGATE
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: DISABLED
          SecurityGroups:
            - 'Fn::GetAtt':
                - sg29196201
                - GroupId
          Subnets:
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet1Subnet934893E8236E2271'
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet2Subnet7031C2BA60DCB1EE'
      Tags:
        - Key: Name
          Value: RestateBYOC/with-vpc-subnet/controller-service
      TaskDefinition:
        Ref: withvpcsubnetcontrollerdefinition30C81EC1
    DependsOn:
      - withvpcsubnetcontrollertaskroleDefaultPolicy33CDD013
      - withvpcsubnetcontrollertaskrole89CF9CC3
  withvpcsubnetrestatectlloggroupEB7B5F65:
    Type: 'AWS::Logs::LogGroup'
    Properties:
      RetentionInDays: 14
    UpdateReplacePolicy: Retain
    DeletionPolicy: Retain
  withvpcsubnetrestatectllambdaexecutionrole94FEEEE2:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
        Version: '2012-10-17'
  withvpcsubnetrestatectllambdaexecutionroleDefaultPolicy793B68AB:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 'logs:CreateLogStream'
              - 'logs:PutLogEvents'
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'arn:'
                  - Ref: 'AWS::Partition'
                  - ':logs:'
                  - Ref: 'AWS::Region'
                  - ':'
                  - Ref: 'AWS::AccountId'
                  - ':log-group:'
                  - Ref: withvpcsubnetrestatectlloggroupEB7B5F65
                  - ':log-stream:*'
            Sid: AWSLambdaLogStreamPermissions
          - Action:
              - 'ec2:CreateNetworkInterface'
              - 'ec2:DescribeNetworkInterfaces'
              - 'ec2:DescribeSubnets'
              - 'ec2:DeleteNetworkInterface'
            Effect: Allow
            Resource: '*'
            Sid: AWSLambdaVPCWildcardPermissions
          - Action:
              - 'ec2:AssignPrivateIpAddresses'
              - 'ec2:UnassignPrivateIpAddresses'
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'arn:'
                  - Ref: 'AWS::Partition'
                  - ':ec2:'
                  - Ref: 'AWS::Region'
                  - ':'
                  - Ref: 'AWS::AccountId'
                  - ':network-interface/*'
            Sid: AWSLambdaVPCNetworkInterfacePermissions
        Version: '2012-10-17'
      PolicyName: withvpcsubnetrestatectllambdaexecutionroleDefaultPolicy793B68AB
      Roles:
        - Ref: withvpcsubnetrestatectllambdaexecutionrole94FEEEE2
  withvpcsubnetrestatectllambda63DC72AF:
    Type: 'AWS::Lambda::Function'
    Properties:
      Architectures:
        - arm64
      Code: Any<Object>
      Environment:
        Variables:
          RESTATECTL_ADDRESS:
            'Fn::Join':
              - ''
              - - 'http://'
                - 'Fn::GetAtt':
                    - withvpcsubnetsharednlb5421469F
                    - DNSName
                - ':5122'
      Handler: restatectl
      LoggingConfig:
        LogGroup:
          Ref: withvpcsubnetrestatectlloggroupEB7B5F65
      Role:
        'Fn::GetAtt':
          - withvpcsubnetrestatectllambdaexecutionrole94FEEEE2
          - Arn
      Runtime: provided.al2023
      Tags:
        - Key: Name
          Value: RestateBYOC/with-vpc-subnet/restatectl-lambda
      Timeout: 10
      VpcConfig:
        SecurityGroupIds:
          - 'Fn::GetAtt':
              - sg29196201
              - GroupId
        SubnetIds:
          - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet1Subnet934893E8236E2271'
          - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet2Subnet7031C2BA60DCB1EE'
    DependsOn:
      - withvpcsubnetrestatectllambdaexecutionroleDefaultPolicy793B68AB
      - withvpcsubnetrestatectllambdaexecutionrole94FEEEE2
  withvpcsubnetretirementwatcherloggroupD98D033D:
    Type: 'AWS::Logs::LogGroup'
    Properties:
      RetentionInDays: 14
    UpdateReplacePolicy: Retain
    DeletionPolicy: Retain
  withvpcsubnetretirementwatcherlambdaexecutionroleD1AD90F5:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
        Version: '2012-10-17'
  withvpcsubnetretirementwatcherlambdaexecutionroleDefaultPolicy80C15355:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 'logs:CreateLogStream'
              - 'logs:PutLogEvents'
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'arn:'
                  - Ref: 'AWS::Partition'
                  - ':logs:'
                  - Ref: 'AWS::Region'
                  - ':'
                  - Ref: 'AWS::AccountId'
                  - ':log-group:'
                  - Ref: withvpcsubnetretirementwatcherloggroupD98D033D
                  - ':log-stream:*'
            Sid: AWSLambdaLogStreamPermissions
          - Action: 'ecs:TagResource'
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'Fn::Join':
                      - /
                      - - 'Fn::Join':
                            - ':'
                            - - 'Fn::Select':
                                  - 0
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - withvpcsubnetcluster14F481BD
                                                  - Arn
                              - 'Fn::Select':
                                  - 1
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - withvpcsubnetcluster14F481BD
                                                  - Arn
                              - 'Fn::Select':
                                  - 2
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - withvpcsubnetcluster14F481BD
                                                  - Arn
                              - 'Fn::Select':
                                  - 3
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - withvpcsubnetcluster14F481BD
                                                  - Arn
                              - 'Fn::Select':
                                  - 4
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - withvpcsubnetcluster14F481BD
                                                  - Arn
                              - task
                        - 'Fn::Select':
                            - 1
                            - 'Fn::Split':
                                - /
                                - 'Fn::GetAtt':
                                    - withvpcsubnetcluster14F481BD
                                    - Arn
                        - ''
                  - '*'
            Sid: TagTasks
          - Action:
              - 'sqs:ReceiveMessage'
              - 'sqs:ChangeMessageVisibility'
              - 'sqs:GetQueueUrl'
              - 'sqs:DeleteMessage'
              - 'sqs:GetQueueAttributes'
            Effect: Allow
            Resource:
              'Fn::GetAtt':
                - withvpcsubnetretirementwatcherqueueA19D1494
                - Arn
        Version: '2012-10-17'
      PolicyName: withvpcsubnetretirementwatcherlambdaexecutionroleDefaultPolicy80C15355
      Roles:
        - Ref: withvpcsubnetretirementwatcherlambdaexecutionroleD1AD90F5
  withvpcsubnetretirementwatcherlambdaE557A2A6:
    Type: 'AWS::Lambda::Function'
    Properties:
      Architectures:
        - arm64
      Code: Any<Object>
      Handler: index.handler
      LoggingConfig:
        LogGroup:
          Ref: withvpcsubnetretirementwatcherloggroupD98D033D
      Role:
        'Fn::GetAtt':
          - withvpcsubnetretirementwatcherlambdaexecutionroleD1AD90F5
          - Arn
      Runtime: nodejs22.x
      Tags:
        - Key: Name
          Value: RestateBYOC/with-vpc-subnet/retirement-watcher-lambda
      Timeout: 60
    DependsOn:
      - withvpcsubnetretirementwatcherlambdaexecutionroleDefaultPolicy80C15355
      - withvpcsubnetretirementwatcherlambdaexecutionroleD1AD90F5
  withvpcsubnetretirementwatcherlambdaSqsEventSourceRestateBYOCwithvpcsubnetretirementwatcherqueue3508D31F1E74C4B3:
    Type: 'AWS::Lambda::EventSourceMapping'
    Properties:
      BatchSize: 1
      EventSourceArn:
        'Fn::GetAtt':
          - withvpcsubnetretirementwatcherqueueA19D1494
          - Arn
      FunctionName:
        Ref: withvpcsubnetretirementwatcherlambdaE557A2A6
      Tags:
        - Key: Name
          Value: RestateBYOC/with-vpc-subnet/retirement-watcher-lambda
  withvpcsubnetretirementwatcherqueueA19D1494:
    Type: 'AWS::SQS::Queue'
    Properties:
      Tags:
        - Key: Name
          Value: RestateBYOC/with-vpc-subnet/retirement-watcher-queue
      VisibilityTimeout: 60
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  withvpcsubnetretirementwatcherqueuePolicy0DB82B43:
    Type: 'AWS::SQS::QueuePolicy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 'sqs:SendMessage'
              - 'sqs:GetQueueAttributes'
              - 'sqs:GetQueueUrl'
            Condition:
              ArnEquals:
                'aws:SourceArn':
                  'Fn::GetAtt':
                    - withvpcsubnetretirementwatcherrule11EB4431
                    - Arn
            Effect: Allow
            Principal:
              Service: events.amazonaws.com
            Resource:
              'Fn::GetAtt':
                - withvpcsubnetretirementwatcherqueueA19D1494
                - Arn
        Version: '2012-10-17'
      Queues:
        - Ref: withvpcsubnetretirementwatcherqueueA19D1494
  withvpcsubnetretirementwatcherrule11EB4431:
    Type: 'AWS::Events::Rule'
    Properties:
      EventPattern:
        detail:
          eventTypeCode:
            - equals-ignore-case: AWS_ECS_TASK_PATCHING_RETIREMENT
          service:
            - equals-ignore-case: ecs
        resources:
          - prefix:
              'Fn::Join':
                - /
                - - 'Fn::Join':
                      - ':'
                      - - 'Fn::Select':
                            - 0
                            - 'Fn::Split':
                                - ':'
                                - 'Fn::Select':
                                    - 0
                                    - 'Fn::Split':
                                        - /
                                        - 'Fn::GetAtt':
                                            - withvpcsubnetcluster14F481BD
                                            - Arn
                        - 'Fn::Select':
                            - 1
                            - 'Fn::Split':
                                - ':'
                                - 'Fn::Select':
                                    - 0
                                    - 'Fn::Split':
                                        - /
                                        - 'Fn::GetAtt':
                                            - withvpcsubnetcluster14F481BD
                                            - Arn
                        - 'Fn::Select':
                            - 2
                            - 'Fn::Split':
                                - ':'
                                - 'Fn::Select':
                                    - 0
                                    - 'Fn::Split':
                                        - /
                                        - 'Fn::GetAtt':
                                            - withvpcsubnetcluster14F481BD
                                            - Arn
                        - 'Fn::Select':
                            - 3
                            - 'Fn::Split':
                                - ':'
                                - 'Fn::Select':
                                    - 0
                                    - 'Fn::Split':
                                        - /
                                        - 'Fn::GetAtt':
                                            - withvpcsubnetcluster14F481BD
                                            - Arn
                        - 'Fn::Select':
                            - 4
                            - 'Fn::Split':
                                - ':'
                                - 'Fn::Select':
                                    - 0
                                    - 'Fn::Split':
                                        - /
                                        - 'Fn::GetAtt':
                                            - withvpcsubnetcluster14F481BD
                                            - Arn
                        - task
                  - 'Fn::Select':
                      - 1
                      - 'Fn::Split':
                          - /
                          - 'Fn::GetAtt':
                              - withvpcsubnetcluster14F481BD
                              - Arn
                  - ''
        detail-type:
          - equals-ignore-case: AWS Health Event
      State: ENABLED
      Targets:
        - Arn:
            'Fn::GetAtt':
              - withvpcsubnetretirementwatcherqueueA19D1494
              - Arn
          Id: Target0
  withvpcsubnetcloudwatchcustomwidgetloggroupBB4CBE80:
    Type: 'AWS::Logs::LogGroup'
    Properties:
      RetentionInDays: 14
    UpdateReplacePolicy: Retain
    DeletionPolicy: Retain
  withvpcsubnetcloudwatchcustomwidgetexecutionroleF8EB3E41:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
        Version: '2012-10-17'
  withvpcsubnetcloudwatchcustomwidgetexecutionroleDefaultPolicy9A153CB8:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 'logs:CreateLogStream'
              - 'logs:PutLogEvents'
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'arn:'
                  - Ref: 'AWS::Partition'
                  - ':logs:'
                  - Ref: 'AWS::Region'
                  - ':'
                  - Ref: 'AWS::AccountId'
                  - ':log-group:'
                  - Ref: withvpcsubnetcloudwatchcustomwidgetloggroupBB4CBE80
                  - ':log-stream:*'
            Sid: AWSLambdaLogStreamPermissions
          - Action:
              - 'ec2:CreateNetworkInterface'
              - 'ec2:DescribeNetworkInterfaces'
              - 'ec2:DescribeSubnets'
              - 'ec2:DeleteNetworkInterface'
            Effect: Allow
            Resource: '*'
            Sid: AWSLambdaVPCWildcardPermissions
          - Action:
              - 'ec2:AssignPrivateIpAddresses'
              - 'ec2:UnassignPrivateIpAddresses'
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'arn:'
                  - Ref: 'AWS::Partition'
                  - ':ec2:'
                  - Ref: 'AWS::Region'
                  - ':'
                  - Ref: 'AWS::AccountId'
                  - ':network-interface/*'
            Sid: AWSLambdaVPCNetworkInterfacePermissions
          - Action: 'lambda:InvokeFunction'
            Effect: Allow
            Resource:
              'Fn::GetAtt':
                - withvpcsubnetrestatectllambda63DC72AF
                - Arn
            Sid: InvokeRestatectl
          - Action: 'ecs:DescribeTaskDefinition'
            Effect: Allow
            Resource: '*'
            Sid: ECSReadActions
          - Action: 'ecs:ListTasks'
            Condition:
              StringEquals:
                'ecs:cluster':
                  'Fn::GetAtt':
                    - withvpcsubnetcluster14F481BD
                    - Arn
            Effect: Allow
            Resource: '*'
            Sid: ECSListTasks
          - Action: 'ecs:DescribeTasks'
            Condition:
              StringEquals:
                'ecs:cluster':
                  'Fn::GetAtt':
                    - withvpcsubnetcluster14F481BD
                    - Arn
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'arn:'
                  - Ref: 'AWS::Partition'
                  - ':ecs:'
                  - Ref: 'AWS::Region'
                  - ':'
                  - Ref: 'AWS::AccountId'
                  - ':task/'
                  - Ref: withvpcsubnetcluster14F481BD
                  - /*
            Sid: ECSDescribeTasks
          - Action: 'ecs:DescribeServices'
            Condition:
              StringEquals:
                'ecs:cluster':
                  'Fn::GetAtt':
                    - withvpcsubnetcluster14F481BD
                    - Arn
            Effect: Allow
            Resource:
              - Ref: withvpcsubnetcontrollerserviceServiceEDFDC99A
              - Ref: withvpcsubnetstatelessserviceService547C3679
            Sid: ECSDescribeServices
          - Action: 'cloudwatch:GetMetricData'
            Effect: Allow
            Resource: '*'
            Sid: CloudWatchReadActions
        Version: '2012-10-17'
      PolicyName: withvpcsubnetcloudwatchcustomwidgetexecutionroleDefaultPolicy9A153CB8
      Roles:
        - Ref: withvpcsubnetcloudwatchcustomwidgetexecutionroleF8EB3E41
  withvpcsubnetcloudwatchcustomwidgetlambdaA362F8D7:
    Type: 'AWS::Lambda::Function'
    Properties:
      Architectures:
        - arm64
      Code: Any<Object>
      Environment:
        Variables:
          ENABLE_EBS_VOLUMES: 'false'
      Handler: index.handler
      LoggingConfig:
        LogGroup:
          Ref: withvpcsubnetcloudwatchcustomwidgetloggroupBB4CBE80
      MemorySize: 1024
      Role:
        'Fn::GetAtt':
          - withvpcsubnetcloudwatchcustomwidgetexecutionroleF8EB3E41
          - Arn
      Runtime: nodejs22.x
      Tags:
        - Key: Name
          Value: RestateBYOC/with-vpc-subnet/cloudwatch-custom-widget-lambda
      Timeout: 60
      VpcConfig:
        SecurityGroupIds:
          - 'Fn::GetAtt':
              - sg29196201
              - GroupId
        SubnetIds:
          - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet1Subnet934893E8236E2271'
          - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet2Subnet7031C2BA60DCB1EE'
    DependsOn:
      - withvpcsubnetcloudwatchcustomwidgetexecutionroleDefaultPolicy9A153CB8
      - withvpcsubnetcloudwatchcustomwidgetexecutionroleF8EB3E41
  withvpcsubnetcloudwatchcustomwidgetlambdacloudwatchcustomwidgetlambdaallowdatasourceF745BA24:
    Type: 'AWS::Lambda::Permission'
    Properties:
      Action: 'lambda:InvokeFunction'
      FunctionName:
        'Fn::GetAtt':
          - withvpcsubnetcloudwatchcustomwidgetlambdaA362F8D7
          - Arn
      Principal: lambda.datasource.cloudwatch.amazonaws.com
  withvpcsubnetmetrics67F0AF3D:
    Type: 'AWS::CloudWatch::Dashboard'
    Properties:
      DashboardBody:
        'Fn::Join':
          - ''
          - - >-
              {"widgets":[{"type":"metric","width":12,"height":6,"x":0,"y":0,"properties":{"view":"timeSeries","title":"Stateless
              CPU","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"CPU","expression":"SELECT AVG(CpuUtilized)
              FROM SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOCwithvpcsubnetstatelessdefinitionFB34AE10' GROUP BY
              TaskId"}]],"annotations":{"horizontal":[{"value":16384,"label":"Limit","yAxis":"left"}]},"yAxis":{"left":{"label":"vCPUs","showUnits":false}}}},{"type":"metric","width":12,"height":6,"x":12,"y":0,"properties":{"view":"timeSeries","title":"Stateless
              Memory","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Memory","expression":"SELECT
              AVG(MemoryUtilized) FROM SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOCwithvpcsubnetstatelessdefinitionFB34AE10' GROUP BY
              TaskId"}]],"annotations":{"horizontal":[{"value":32768,"label":"Limit","yAxis":"left"}]},"yAxis":{"left":{"label":"MiB","showUnits":false}}}},{"type":"metric","width":12,"height":6,"x":0,"y":6,"properties":{"view":"timeSeries","title":"Stateless
              Network Tx","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Tx","expression":"SELECT
              AVG(NetworkTxBytes) FROM SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOCwithvpcsubnetstatelessdefinitionFB34AE10' GROUP BY
              TaskId"}]],"yAxis":{"left":{"label":"Bytes/sec","showUnits":false}}}},{"type":"metric","width":12,"height":6,"x":12,"y":6,"properties":{"view":"timeSeries","title":"Stateless
              Network Rx","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Rx","expression":"SELECT
              AVG(NetworkRxBytes) FROM SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOCwithvpcsubnetstatelessdefinitionFB34AE10' GROUP BY
              TaskId"}]],"yAxis":{"left":{"label":"Bytes/sec","showUnits":false}}}},{"type":"log","width":24,"height":6,"x":0,"y":12,"properties":{"view":"table","title":"Stateless
              Logs","region":"region","query":"SOURCE '
            - Ref: withvpcsubnetrestateloggroup9A66BB7A
            - >-
              ' | fields @logStream, @timestamp, level, fields.message,
              target\\n          | sort @timestamp desc\\n          | limit
              500"}},{"type":"metric","width":12,"height":6,"x":0,"y":18,"properties":{"view":"timeSeries","title":"Stateful
              CPU","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"CPU","expression":"SELECT AVG(CpuUtilized)
              FROM SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOCwithvpcsubnetstatefuldefinition3D0F1E76' GROUP BY
              TaskId"}]],"annotations":{"horizontal":[{"value":16384,"label":"Limit","yAxis":"left"}]},"yAxis":{"left":{"label":"vCPUs","showUnits":false}}}},{"type":"metric","width":12,"height":6,"x":12,"y":18,"properties":{"view":"timeSeries","title":"Stateful
              Memory","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Memory","expression":"SELECT
              AVG(MemoryUtilized) FROM SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOCwithvpcsubnetstatefuldefinition3D0F1E76' GROUP BY
              TaskId"}]],"annotations":{"horizontal":[{"value":32768,"label":"Limit","yAxis":"left"}]},"yAxis":{"left":{"label":"MiB","showUnits":false}}}},{"type":"metric","width":12,"height":6,"x":0,"y":24,"properties":{"view":"timeSeries","title":"Stateful
              Network Tx","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Tx","expression":"SELECT
              AVG(NetworkTxBytes) FROM SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOCwithvpcsubnetstatefuldefinition3D0F1E76' GROUP BY
              TaskId"}]],"yAxis":{"left":{"label":"Bytes/sec","showUnits":false}}}},{"type":"metric","width":12,"height":6,"x":12,"y":24,"properties":{"view":"timeSeries","title":"Stateful
              Network Rx","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Rx","expression":"SELECT
              AVG(NetworkRxBytes) FROM SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOCwithvpcsubnetstatefuldefinition3D0F1E76' GROUP BY
              TaskId"}]],"yAxis":{"left":{"label":"Bytes/sec","showUnits":false}}}},{"type":"log","width":24,"height":6,"x":0,"y":30,"properties":{"view":"table","title":"Stateful
              Logs","region":"region","query":"SOURCE '
            - Ref: withvpcsubnetrestateloggroup9A66BB7A
            - >-
              ' | fields @logStream, @timestamp, level, fields.message,
              target\\n          | sort @timestamp desc\\n          | limit
              500"}},{"type":"metric","width":8,"height":6,"x":0,"y":36,"properties":{"view":"timeSeries","title":"Ephemeral
              Volume Usage (Total size 200GiB)","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Usage","expression":"SELECT
              MAX(EphemeralStorageUtilized) FROM
              SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily) WHERE TaskDefinitionFamily =
              'RestateBYOCwithvpcsubnetstatefuldefinition3D0F1E76'"}]],"annotations":{"horizontal":[{"value":200,"label":"Volume
              size","visible":false,"yAxis":"left"}]},"yAxis":{"left":{"label":"GiB","showUnits":false}},"liveData":false}},{"type":"metric","width":8,"height":6,"x":8,"y":36,"properties":{"view":"timeSeries","title":"Volume
              Write Throughput (Limited to 150 MiB/sec)","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Write","expression":"RATE(count) /
              1048576"}],[{"expression":"SELECT MAX(StorageWriteBytes) FROM
              SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOCwithvpcsubnetstatefuldefinition3D0F1E76' GROUP BY
              TaskId","visible":false,"id":"count"}]],"annotations":{"horizontal":[{"value":150,"label":"Limit","visible":false,"yAxis":"left"}]},"yAxis":{"left":{"label":"MiB/sec","showUnits":false}}}},{"type":"metric","width":8,"height":6,"x":16,"y":36,"properties":{"view":"timeSeries","title":"Volume
              Read Throughput (Limited to 150 MiB/sec)","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Read","expression":"RATE(count) /
              1048576"}],[{"expression":"SELECT MAX(StorageReadBytes) FROM
              SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOCwithvpcsubnetstatefuldefinition3D0F1E76' GROUP BY
              TaskId","visible":false,"id":"count"}]],"annotations":{"horizontal":[{"value":150,"label":"Limit","visible":false,"yAxis":"left"}]},"yAxis":{"left":{"label":"MiB/sec","showUnits":false}}}},{"type":"log","width":24,"height":6,"x":0,"y":42,"properties":{"view":"table","title":"Controller
              Logs","region":"region","query":"SOURCE '
            - Ref: withvpcsubnetcontrollerloggroup5F5E6509
            - >-
              ' | fields @logStream, @timestamp, level, fields.message,
              target\\n          | sort @timestamp desc\\n          | limit
              500"}}]}
      DashboardName: RestateBYOC_with-vpc-subnet_metrics
  withvpcsubnetcontrolpanel4EDF09C9:
    Type: 'AWS::CloudWatch::Dashboard'
    Properties:
      DashboardBody:
        'Fn::Join':
          - ''
          - - >-
              {"widgets":[{"type":"custom","width":24,"height":26,"x":0,"y":0,"properties":{"endpoint":"
            - 'Fn::GetAtt':
                - withvpcsubnetcloudwatchcustomwidgetlambdaA362F8D7
                - Arn
            - '","params":{"command":"controlPanel","input":{"region":"'
            - Ref: 'AWS::Region'
            - >-
              ","summary":{"clusterName":"RestateBYOC/with-vpc-subnet","restateVersion":"1.4","stackVersion":"0.4.1-dev","metricsDashboardName":"
            - Ref: withvpcsubnetmetrics67F0AF3D
            - '"},"resources":{"ecsClusterArn":"'
            - 'Fn::GetAtt':
                - withvpcsubnetcluster14F481BD
                - Arn
            - '","statelessServiceArn":"'
            - Ref: withvpcsubnetstatelessserviceService547C3679
            - '","controllerServiceArn":"'
            - Ref: withvpcsubnetcontrollerserviceServiceEDFDC99A
            - '","restatectlLambdaArn":"'
            - 'Fn::GetAtt':
                - withvpcsubnetrestatectllambda63DC72AF
                - Arn
            - >-
              "},"connectivityAndSecurity":{"connectivity":{"loadBalancerArns":{"ingress":["
            - Ref: withvpcsubnetsharednlb5421469F
            - '"],"admin":["'
            - Ref: withvpcsubnetsharednlb5421469F
            - '"]},"addresses":{"ingress":"http://'
            - 'Fn::GetAtt':
                - withvpcsubnetsharednlb5421469F
                - DNSName
            - ':8080","admin":"http://'
            - 'Fn::GetAtt':
                - withvpcsubnetsharednlb5421469F
                - DNSName
            - ':9070","webUI":"http://'
            - 'Fn::GetAtt':
                - withvpcsubnetsharednlb5421469F
                - DNSName
            - ':9070/ui"}},"networking":{"vpc":"'
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcA2121C384D1B3CDE'
            - '","availabilityZones":["dummy1a","dummy1b"],"subnets":["'
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet1Subnet934893E8236E2271'
            - '","'
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet2Subnet7031C2BA60DCB1EE'
            - '"]},"security":{"securityGroups":["'
            - 'Fn::GetAtt':
                - sg29196201
                - GroupId
            - '"]}},"storage":{"s3":{"bucket":"'
            - Ref: withvpcsubnetbucket1E081BFF
            - >-
              "}}}},"title":"","updateOn":{"refresh":true,"resize":true,"timeRange":true}}}]}
      DashboardName: RestateBYOC_with-vpc-subnet_control-panel
Outputs:
  withvpcsubnetSecurityGroups328ED5C7:
    Description: The security group IDs of the cluster
    Value:
      'Fn::GetAtt':
        - sg29196201
        - GroupId
  withvpcsubnetIngressNetworkListener9E7EFC33:
    Description: The ARN of the network listener for the ingress port
    Value:
      Ref: withvpcsubnetingresssharedlistener4D3399EF
  withvpcsubnetIngressNetworkTargetGroup9DF1D4DD:
    Description: The ARN of the network target group for the ingress port
    Value:
      Ref: withvpcsubnetingresssharedtargetE6C22455
  withvpcsubnetAdminNetworkListenerEE07DF44:
    Description: The ARN of the network listener for the admin port
    Value:
      Ref: withvpcsubnetadminsharedlistenerA099F537
  withvpcsubnetAdminNetworkTargetGroup46655F8D:
    Description: The ARN of the network target group for the admin port
    Value:
      Ref: withvpcsubnetadminsharedtarget8C328C16
  withvpcsubnetNodeNetworkListenerAD09642F:
    Description: The ARN of the network listener for the node port
    Value:
      Ref: withvpcsubnetnodesharedlistener362A7851
  withvpcsubnetNodeNetworkTargetGroupD02C76F4:
    Description: The ARN of the network target group for the node port
    Value:
      Ref: withvpcsubnetnodesharedtarget7EB5F977
"
`;
