// Jest Snapshot v1, https://goo.gl/fbAQLP

exports[`BYOC Default parameters 1`] = `
"Resources:
  defaultsecuritygroupE8DEFA55:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      GroupDescription: RestateBYOC/default/security-group
      SecurityGroupEgress:
        - CidrIp: 0.0.0.0/0
          Description: Allow all outbound traffic by default
          IpProtocol: '-1'
      Tags:
        - Key: Name
          Value: RestateBYOC/default/security-group
      VpcId:
        'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcA2121C384D1B3CDE'
  defaultsecuritygroupfromRestateBYOCdefaultsecuritygroup87B50E9980804AEED840:
    Type: 'AWS::EC2::SecurityGroupIngress'
    Properties:
      Description: 'from RestateBYOCdefaultsecuritygroup87B50E99:8080'
      FromPort: 8080
      GroupId:
        'Fn::GetAtt':
          - defaultsecuritygroupE8DEFA55
          - GroupId
      IpProtocol: tcp
      SourceSecurityGroupId:
        'Fn::GetAtt':
          - defaultsecuritygroupE8DEFA55
          - GroupId
      ToPort: 8080
  defaultsecuritygroupfromRestateBYOCdefaultsecuritygroup87B50E99907077632CDC:
    Type: 'AWS::EC2::SecurityGroupIngress'
    Properties:
      Description: 'from RestateBYOCdefaultsecuritygroup87B50E99:9070'
      FromPort: 9070
      GroupId:
        'Fn::GetAtt':
          - defaultsecuritygroupE8DEFA55
          - GroupId
      IpProtocol: tcp
      SourceSecurityGroupId:
        'Fn::GetAtt':
          - defaultsecuritygroupE8DEFA55
          - GroupId
      ToPort: 9070
  defaultsecuritygroupfromRestateBYOCdefaultsecuritygroup87B50E9951227EDECDBD:
    Type: 'AWS::EC2::SecurityGroupIngress'
    Properties:
      Description: 'from RestateBYOCdefaultsecuritygroup87B50E99:5122'
      FromPort: 5122
      GroupId:
        'Fn::GetAtt':
          - defaultsecuritygroupE8DEFA55
          - GroupId
      IpProtocol: tcp
      SourceSecurityGroupId:
        'Fn::GetAtt':
          - defaultsecuritygroupE8DEFA55
          - GroupId
      ToPort: 5122
  defaultbucket65304C97:
    Type: 'AWS::S3::Bucket'
    Properties:
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
    UpdateReplacePolicy: Retain
    DeletionPolicy: Retain
  defaultbucketPolicy7463A49D:
    Type: 'AWS::S3::BucketPolicy'
    Properties:
      Bucket:
        Ref: defaultbucket65304C97
      PolicyDocument:
        Statement:
          - Action: 's3:*'
            Condition:
              Bool:
                'aws:SecureTransport': 'false'
            Effect: Deny
            Principal:
              AWS: '*'
            Resource:
              - 'Fn::GetAtt':
                  - defaultbucket65304C97
                  - Arn
              - 'Fn::Join':
                  - ''
                  - - 'Fn::GetAtt':
                        - defaultbucket65304C97
                        - Arn
                    - /*
        Version: '2012-10-17'
  defaultcluster07071299:
    Type: 'AWS::ECS::Cluster'
    Properties:
      ClusterSettings:
        - Name: containerInsights
          Value: enhanced
      Tags:
        - Key: Name
          Value: RestateBYOC/default/cluster
  defaultrestatetaskrole1A7BDFBB:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
        Version: '2012-10-17'
  defaultrestatetaskroleDefaultPolicy58736B8D:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 's3:GetObject'
              - 's3:PutObject'
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'Fn::GetAtt':
                      - defaultbucket65304C97
                      - Arn
                  - /*
            Sid: ReadWriteBucket
          - Action: 's3:ListBucket'
            Effect: Allow
            Resource:
              'Fn::GetAtt':
                - defaultbucket65304C97
                - Arn
            Sid: ListBucket
        Version: '2012-10-17'
      PolicyName: defaultrestatetaskroleDefaultPolicy58736B8D
      Roles:
        - Ref: defaultrestatetaskrole1A7BDFBB
  defaultrestateexecutionrole4009B294:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
        Version: '2012-10-17'
  defaultrestateexecutionroleDefaultPolicy3E1E0421:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 'logs:CreateLogStream'
              - 'logs:PutLogEvents'
            Effect: Allow
            Resource:
              'Fn::GetAtt':
                - defaultstatelessdefinitionrestateLogGroup49FB832E
                - Arn
          - Action:
              - 'logs:CreateLogStream'
              - 'logs:PutLogEvents'
            Effect: Allow
            Resource:
              'Fn::GetAtt':
                - defaultstatefuldefinitionrestateLogGroup3CA44D5E
                - Arn
        Version: '2012-10-17'
      PolicyName: defaultrestateexecutionroleDefaultPolicy3E1E0421
      Roles:
        - Ref: defaultrestateexecutionrole4009B294
  defaultsharednlb5E13F2A0:
    Type: 'AWS::ElasticLoadBalancingV2::LoadBalancer'
    Properties:
      LoadBalancerAttributes:
        - Key: deletion_protection.enabled
          Value: 'false'
        - Key: load_balancing.cross_zone.enabled
          Value: 'false'
        - Key: dns_record.client_routing_policy
          Value: availability_zone_affinity
      Scheme: internal
      SecurityGroups:
        - 'Fn::GetAtt':
            - defaultsecuritygroupE8DEFA55
            - GroupId
      Subnets:
        - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet1Subnet934893E8236E2271'
        - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet2Subnet7031C2BA60DCB1EE'
        - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet3Subnet985AC459F9514491'
      Tags:
        - Key: Name
          Value: RestateBYOC/default/shared-nlb
      Type: network
  defaultingresssharedlistener3AB06661:
    Type: 'AWS::ElasticLoadBalancingV2::Listener'
    Properties:
      DefaultActions:
        - TargetGroupArn:
            Ref: defaultingresssharedtarget501739FD
          Type: forward
      LoadBalancerArn:
        Ref: defaultsharednlb5E13F2A0
      Port: 8080
      Protocol: TCP
  defaultadminsharedlistener2B6E2F69:
    Type: 'AWS::ElasticLoadBalancingV2::Listener'
    Properties:
      DefaultActions:
        - TargetGroupArn:
            Ref: defaultadminsharedtarget04FDBD2A
          Type: forward
      LoadBalancerArn:
        Ref: defaultsharednlb5E13F2A0
      Port: 9070
      Protocol: TCP
  defaultnodesharedlistenerF94E5381:
    Type: 'AWS::ElasticLoadBalancingV2::Listener'
    Properties:
      DefaultActions:
        - TargetGroupArn:
            Ref: defaultnodesharedtarget1C48E466
          Type: forward
      LoadBalancerArn:
        Ref: defaultsharednlb5E13F2A0
      Port: 5122
      Protocol: TCP
  defaultstatelessdefinitionDCB0B7C0:
    Type: 'AWS::ECS::TaskDefinition'
    Properties:
      ContainerDefinitions:
        - Cpu: 16384
          EntryPoint:
            - bash
            - '-c'
            - >

              curl --no-progress-meter $ECS_CONTAINER_METADATA_URI_V4/task -o
              task-metadata && \\

              export \\
                RESTATE_NODE_NAME=$(jq -r '.TaskARN' task-metadata) \\
                RESTATE_LOCATION="$AWS_REGION.$(jq -r '.AvailabilityZone' task-metadata)" \\
                RESTATE_ADVERTISED_ADDRESS="http://$(jq -r '.Containers[0].Networks[0].IPv4Addresses[0]' task-metadata):5122"
              exec restate-server
          Environment:
            - Name: RESTATE_LOG_FORMAT
              Value: json
            - Name: RESTATE_CLUSTER_NAME
              Value: RestateBYOC/default
            - Name: RESTATE_ROLES
              Value: '["admin","http-ingress"]'
            - Name: RESTATE_AUTO_PROVISION
              Value: 'true'
            - Name: RESTATE_SHUTDOWN_TIMEOUT
              Value: 100s
            - Name: RESTATE_DEFAULT_NUM_PARTITIONS
              Value: '128'
            - Name: RESTATE_DEFAULT_REPLICATION
              Value: '{zone: 2}'
            - Name: RESTATE_METADATA_CLIENT__TYPE
              Value: object-store
            - Name: RESTATE_METADATA_CLIENT__PATH
              Value:
                'Fn::Join':
                  - ''
                  - - 's3://'
                    - Ref: defaultbucket65304C97
                    - /metadata
            - Name: RESTATE_BIFROST__DEFAULT_PROVIDER
              Value: replicated
            - Name: >-
                RESTATE_INGRESS__EXPERIMENTAL_FEATURE_ENABLE_SEPARATE_INGRESS_ROLE
              Value: 'true'
            - Name: RESTATE_INGRESS__ADVERTISED_INGRESS_ENDPOINT
              Value:
                'Fn::Join':
                  - ''
                  - - 'http://'
                    - 'Fn::GetAtt':
                        - defaultsharednlb5E13F2A0
                        - DNSName
                    - ':8080'
            - Name: RESTATE_WORKER__SNAPSHOTS__DESTINATION
              Value:
                'Fn::Join':
                  - ''
                  - - 's3://'
                    - Ref: defaultbucket65304C97
                    - /snapshots
          Essential: true
          HealthCheck:
            Command:
              - CMD
              - curl
              - '--fail'
              - 'http://127.0.0.1:8080/restate/health'
            Interval: 30
            Retries: 3
            Timeout: 5
          Image: Any<Object>
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group:
                Ref: defaultstatelessdefinitionrestateLogGroup49FB832E
              awslogs-stream-prefix: restate
              awslogs-region: region
          Memory: 32768
          Name: restate
          PortMappings:
            - ContainerPort: 8080
              Name: ingress
              Protocol: tcp
            - ContainerPort: 9070
              Name: admin
              Protocol: tcp
            - ContainerPort: 5122
              Name: node
              Protocol: tcp
          StopTimeout: 120
      Cpu: '16384'
      ExecutionRoleArn:
        'Fn::GetAtt':
          - defaultrestateexecutionrole4009B294
          - Arn
      Family: RestateBYOCdefaultstatelessdefinitionFF58C79A
      Memory: '32768'
      NetworkMode: awsvpc
      RequiresCompatibilities:
        - FARGATE
      RuntimePlatform:
        CpuArchitecture: ARM64
        OperatingSystemFamily: LINUX
      Tags:
        - Key: Name
          Value: RestateBYOC/default/stateless-definition
      TaskRoleArn:
        'Fn::GetAtt':
          - defaultrestatetaskrole1A7BDFBB
          - Arn
  defaultstatelessdefinitionrestateLogGroup49FB832E:
    Type: 'AWS::Logs::LogGroup'
    Properties:
      Tags:
        - Key: Name
          Value: RestateBYOC/default/stateless-definition
    UpdateReplacePolicy: Retain
    DeletionPolicy: Retain
  defaultstatelessserviceService8A7FABFB:
    Type: 'AWS::ECS::Service'
    Properties:
      Cluster:
        Ref: defaultcluster07071299
      DeploymentConfiguration:
        Alarms:
          AlarmNames: []
          Enable: false
          Rollback: false
        MaximumPercent: 200
        MinimumHealthyPercent: 100
      DesiredCount: 3
      EnableECSManagedTags: false
      EnableExecuteCommand: false
      HealthCheckGracePeriodSeconds: 60
      LaunchType: FARGATE
      LoadBalancers:
        - ContainerName: restate
          ContainerPort: 8080
          TargetGroupArn:
            Ref: defaultingresssharedtarget501739FD
        - ContainerName: restate
          ContainerPort: 9070
          TargetGroupArn:
            Ref: defaultadminsharedtarget04FDBD2A
        - ContainerName: restate
          ContainerPort: 5122
          TargetGroupArn:
            Ref: defaultnodesharedtarget1C48E466
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: DISABLED
          SecurityGroups:
            - 'Fn::GetAtt':
                - defaultsecuritygroupE8DEFA55
                - GroupId
          Subnets:
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet1Subnet934893E8236E2271'
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet2Subnet7031C2BA60DCB1EE'
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet3Subnet985AC459F9514491'
      PropagateTags: SERVICE
      Tags:
        - Key: Name
          Value: RestateBYOC/default/stateless-service
      TaskDefinition:
        Ref: defaultstatelessdefinitionDCB0B7C0
    DependsOn:
      - defaultadminsharedlistener2B6E2F69
      - defaultingresssharedlistener3AB06661
      - defaultnodesharedlistenerF94E5381
      - defaultrestatetaskroleDefaultPolicy58736B8D
      - defaultrestatetaskrole1A7BDFBB
  defaultstatefuldefinition4CD55F35:
    Type: 'AWS::ECS::TaskDefinition'
    Properties:
      ContainerDefinitions:
        - Cpu: 16384
          EntryPoint:
            - bash
            - '-c'
            - >

              curl --no-progress-meter $ECS_CONTAINER_METADATA_URI_V4/task -o
              task-metadata && \\

              export \\
                RESTATE_NODE_NAME=$(jq -r '.TaskARN' task-metadata) \\
                RESTATE_LOCATION="$AWS_REGION.$(jq -r '.AvailabilityZone' task-metadata)" \\
                RESTATE_ADVERTISED_ADDRESS="http://$(jq -r '.Containers[0].Networks[0].IPv4Addresses[0]' task-metadata):5122"
              exec restate-server
          Environment:
            - Name: RESTATE_LOG_FORMAT
              Value: json
            - Name: RESTATE_CLUSTER_NAME
              Value: RestateBYOC/default
            - Name: RESTATE_ROLES
              Value: '["log-server", "worker"]'
            - Name: RESTATE_AUTO_PROVISION
              Value: 'false'
            - Name: RESTATE_SHUTDOWN_TIMEOUT
              Value: 100s
            - Name: RESTATE_ROCKSDB_TOTAL_MEMORY_SIZE
              Value: 24576MiB
            - Name: RESTATE_METADATA_CLIENT__TYPE
              Value: object-store
            - Name: RESTATE_METADATA_CLIENT__PATH
              Value:
                'Fn::Join':
                  - ''
                  - - 's3://'
                    - Ref: defaultbucket65304C97
                    - /metadata
            - Name: RESTATE_WORKER__SNAPSHOTS__DESTINATION
              Value:
                'Fn::Join':
                  - ''
                  - - 's3://'
                    - Ref: defaultbucket65304C97
                    - /snapshots
            - Name: RESTATE_WORKER__SNAPSHOTS__SNAPSHOT_INTERVAL_NUM_RECORDS
              Value: '1000000'
            - Name: RESTATE_WORKER__STORAGE__ROCKSDB_DISABLE_DIRECT_IO_FOR_READS
              Value: 'true'
            - Name: RESTATE_WORKER__STORAGE__ROCKSDB_DISABLE_WAL_FSYNC
              Value: 'true'
            - Name: RESTATE_LOG_SERVER__ROCKSDB_DISABLE_WAL_FSYNC
              Value: 'true'
            - Name: RESTATE_LOG_SERVER__ROCKSDB_DISABLE_DIRECT_IO_FOR_READS
              Value: 'true'
            - Name: >-
                RESTATE_INGRESS__EXPERIMENTAL_FEATURE_ENABLE_SEPARATE_INGRESS_ROLE
              Value: 'true'
          Essential: true
          HealthCheck:
            Command:
              - CMD
              - curl
              - '--fail'
              - 'http://127.0.0.1:5122/health'
            Interval: 30
            Retries: 3
            Timeout: 5
          Image: Any<Object>
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group:
                Ref: defaultstatefuldefinitionrestateLogGroup3CA44D5E
              awslogs-stream-prefix: restate
              awslogs-region: region
          Memory: 32768
          MountPoints:
            - ContainerPath: /restate-data
              ReadOnly: false
              SourceVolume: restate-data
          Name: restate
          PortMappings:
            - ContainerPort: 5122
              Name: node
              Protocol: tcp
          RestartPolicy:
            Enabled: true
            RestartAttemptPeriod: 60
          StopTimeout: 120
      Cpu: '16384'
      EphemeralStorage:
        SizeInGiB: 200
      ExecutionRoleArn:
        'Fn::GetAtt':
          - defaultrestateexecutionrole4009B294
          - Arn
      Family: RestateBYOCdefaultstatefuldefinition4D62F21B
      Memory: '32768'
      NetworkMode: awsvpc
      RequiresCompatibilities:
        - FARGATE
      RuntimePlatform:
        CpuArchitecture: ARM64
        OperatingSystemFamily: LINUX
      Tags:
        - Key: Name
          Value: RestateBYOC/default/stateful-definition
      TaskRoleArn:
        'Fn::GetAtt':
          - defaultrestatetaskrole1A7BDFBB
          - Arn
      Volumes:
        - ConfiguredAtLaunch: false
          Name: restate-data
  defaultstatefuldefinitionrestateLogGroup3CA44D5E:
    Type: 'AWS::Logs::LogGroup'
    Properties:
      Tags:
        - Key: Name
          Value: RestateBYOC/default/stateful-definition
    UpdateReplacePolicy: Retain
    DeletionPolicy: Retain
  defaultingresssharedtarget501739FD:
    Type: 'AWS::ElasticLoadBalancingV2::TargetGroup'
    Properties:
      HealthCheckEnabled: true
      HealthCheckIntervalSeconds: 5
      HealthCheckPath: /restate/health
      HealthCheckProtocol: HTTP
      HealthCheckTimeoutSeconds: 2
      Port: 8080
      Protocol: TCP
      Tags:
        - Key: Name
          Value: RestateBYOC/default/ingress-shared-target
      TargetType: ip
      VpcId:
        'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcA2121C384D1B3CDE'
  defaultadminsharedtarget04FDBD2A:
    Type: 'AWS::ElasticLoadBalancingV2::TargetGroup'
    Properties:
      HealthCheckEnabled: true
      HealthCheckIntervalSeconds: 5
      HealthCheckPath: /health
      HealthCheckPort: '9070'
      HealthCheckProtocol: HTTP
      HealthCheckTimeoutSeconds: 2
      Port: 9070
      Protocol: TCP
      Tags:
        - Key: Name
          Value: RestateBYOC/default/admin-shared-target
      TargetType: ip
      VpcId:
        'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcA2121C384D1B3CDE'
  defaultnodesharedtarget1C48E466:
    Type: 'AWS::ElasticLoadBalancingV2::TargetGroup'
    Properties:
      HealthCheckEnabled: true
      HealthCheckIntervalSeconds: 5
      HealthCheckPath: /health
      HealthCheckPort: '5122'
      HealthCheckProtocol: HTTP
      HealthCheckTimeoutSeconds: 2
      Port: 5122
      Protocol: TCP
      Tags:
        - Key: Name
          Value: RestateBYOC/default/node-shared-target
      TargetType: ip
      VpcId:
        'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcA2121C384D1B3CDE'
  defaultcontrollertaskrole7B120178:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
        Version: '2012-10-17'
  defaultcontrollertaskroleDefaultPolicy328ED952:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 'ecs:ListTasks'
              - 'ecs:DescribeTasks'
              - 'ecs:StopTask'
            Condition:
              ArnEquals:
                'ecs:cluster':
                  'Fn::GetAtt':
                    - defaultcluster07071299
                    - Arn
            Effect: Allow
            Resource: '*'
            Sid: TaskActions
          - Action: 'ecs:TagResource'
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'Fn::Join':
                      - /
                      - - 'Fn::Join':
                            - ':'
                            - - 'Fn::Select':
                                  - 0
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - defaultcluster07071299
                                                  - Arn
                              - 'Fn::Select':
                                  - 1
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - defaultcluster07071299
                                                  - Arn
                              - 'Fn::Select':
                                  - 2
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - defaultcluster07071299
                                                  - Arn
                              - 'Fn::Select':
                                  - 3
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - defaultcluster07071299
                                                  - Arn
                              - 'Fn::Select':
                                  - 4
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - defaultcluster07071299
                                                  - Arn
                              - task
                        - 'Fn::Select':
                            - 1
                            - 'Fn::Split':
                                - /
                                - 'Fn::GetAtt':
                                    - defaultcluster07071299
                                    - Arn
                        - ''
                  - '*'
            Sid: TagTasks
          - Action: 'ecs:RunTask'
            Condition:
              ArnEquals:
                'ecs:cluster':
                  'Fn::GetAtt':
                    - defaultcluster07071299
                    - Arn
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'Fn::Join':
                      - ':'
                      - - 'Fn::Select':
                            - 0
                            - 'Fn::Split':
                                - ':'
                                - Ref: defaultstatefuldefinition4CD55F35
                        - 'Fn::Select':
                            - 1
                            - 'Fn::Split':
                                - ':'
                                - Ref: defaultstatefuldefinition4CD55F35
                        - 'Fn::Select':
                            - 2
                            - 'Fn::Split':
                                - ':'
                                - Ref: defaultstatefuldefinition4CD55F35
                        - 'Fn::Select':
                            - 3
                            - 'Fn::Split':
                                - ':'
                                - Ref: defaultstatefuldefinition4CD55F35
                        - 'Fn::Select':
                            - 4
                            - 'Fn::Split':
                                - ':'
                                - Ref: defaultstatefuldefinition4CD55F35
                        - 'Fn::Select':
                            - 5
                            - 'Fn::Split':
                                - ':'
                                - Ref: defaultstatefuldefinition4CD55F35
                  - ':*'
            Sid: RunTask
          - Action: 'iam:PassRole'
            Condition:
              StringEquals:
                'iam:PassedToService': ecs-tasks.amazonaws.com
            Effect: Allow
            Resource:
              - 'Fn::GetAtt':
                  - defaultrestatetaskrole1A7BDFBB
                  - Arn
              - 'Fn::GetAtt':
                  - defaultrestateexecutionrole4009B294
                  - Arn
            Sid: RunTaskPassRole
          - Action:
              - 's3:GetObject'
              - 's3:PutObject'
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'Fn::GetAtt':
                      - defaultbucket65304C97
                      - Arn
                  - /*
            Sid: ReadWriteBucket
          - Action: 's3:ListBucket'
            Effect: Allow
            Resource:
              'Fn::GetAtt':
                - defaultbucket65304C97
                - Arn
            Sid: ListBucket
        Version: '2012-10-17'
      PolicyName: defaultcontrollertaskroleDefaultPolicy328ED952
      Roles:
        - Ref: defaultcontrollertaskrole7B120178
  defaultcontrollerexecutionrole67636991:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
        Version: '2012-10-17'
  defaultcontrollerexecutionroleDefaultPolicy53CE4FA0:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 'logs:CreateLogStream'
              - 'logs:PutLogEvents'
            Effect: Allow
            Resource:
              'Fn::GetAtt':
                - defaultcontrollerdefinitioncontrollerLogGroup60752F65
                - Arn
        Version: '2012-10-17'
      PolicyName: defaultcontrollerexecutionroleDefaultPolicy53CE4FA0
      Roles:
        - Ref: defaultcontrollerexecutionrole67636991
  defaultcontrollerdefinition66AD165F:
    Type: 'AWS::ECS::TaskDefinition'
    Properties:
      ContainerDefinitions:
        - Cpu: 1024
          Environment:
            - Name: RUST_LOG
              Value: 'info,restate_fargate_controller=debug'
            - Name: CONTROLLER_LOG_FORMAT
              Value: json
            - Name: CONTROLLER_METADATA_PATH
              Value:
                'Fn::Join':
                  - ''
                  - - 's3://'
                    - Ref: defaultbucket65304C97
                    - /metadata
            - Name: CONTROLLER_RECONCILE_INTERVAL
              Value: 10s
            - Name: CONTROLLER_CLUSTER__CLUSTER_ARN
              Value:
                'Fn::GetAtt':
                  - defaultcluster07071299
                  - Arn
            - Name: CONTROLLER_LICENSE_ID
              Value: foo
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __REGION
              Value:
                Ref: 'AWS::Region'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __CLUSTER_ARN
              Value:
                'Fn::GetAtt':
                  - defaultcluster07071299
                  - Arn
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __TASK_PREFIX
              Value:
                'Fn::Join':
                  - /
                  - - 'Fn::Join':
                        - ':'
                        - - 'Fn::Select':
                              - 0
                              - 'Fn::Split':
                                  - ':'
                                  - 'Fn::Select':
                                      - 0
                                      - 'Fn::Split':
                                          - /
                                          - 'Fn::GetAtt':
                                              - defaultcluster07071299
                                              - Arn
                          - 'Fn::Select':
                              - 1
                              - 'Fn::Split':
                                  - ':'
                                  - 'Fn::Select':
                                      - 0
                                      - 'Fn::Split':
                                          - /
                                          - 'Fn::GetAtt':
                                              - defaultcluster07071299
                                              - Arn
                          - 'Fn::Select':
                              - 2
                              - 'Fn::Split':
                                  - ':'
                                  - 'Fn::Select':
                                      - 0
                                      - 'Fn::Split':
                                          - /
                                          - 'Fn::GetAtt':
                                              - defaultcluster07071299
                                              - Arn
                          - 'Fn::Select':
                              - 3
                              - 'Fn::Split':
                                  - ':'
                                  - 'Fn::Select':
                                      - 0
                                      - 'Fn::Split':
                                          - /
                                          - 'Fn::GetAtt':
                                              - defaultcluster07071299
                                              - Arn
                          - 'Fn::Select':
                              - 4
                              - 'Fn::Split':
                                  - ':'
                                  - 'Fn::Select':
                                      - 0
                                      - 'Fn::Split':
                                          - /
                                          - 'Fn::GetAtt':
                                              - defaultcluster07071299
                                              - Arn
                          - task
                    - 'Fn::Select':
                        - 1
                        - 'Fn::Split':
                            - /
                            - 'Fn::GetAtt':
                                - defaultcluster07071299
                                - Arn
                    - ''
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1a__ENABLE_EXECUTE_COMMAND
              Value: 'false'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1a__SECURITY_GROUPS
              Value:
                'Fn::Join':
                  - ''
                  - - '["'
                    - 'Fn::GetAtt':
                        - defaultsecuritygroupE8DEFA55
                        - GroupId
                    - '"]'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1a__SUBNETS
              Value:
                'Fn::Join':
                  - ''
                  - - '["'
                    - 'Fn::ImportValue': >-
                        VPCStack:ExportsOutputRefvpcPrivateSubnet1Subnet934893E8236E2271
                    - '"]'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1a__TASK_DEFINITION_ARN
              Value:
                Ref: defaultstatefuldefinition4CD55F35
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1a__COUNT
              Value: '1'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1b__ENABLE_EXECUTE_COMMAND
              Value: 'false'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1b__SECURITY_GROUPS
              Value:
                'Fn::Join':
                  - ''
                  - - '["'
                    - 'Fn::GetAtt':
                        - defaultsecuritygroupE8DEFA55
                        - GroupId
                    - '"]'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1b__SUBNETS
              Value:
                'Fn::Join':
                  - ''
                  - - '["'
                    - 'Fn::ImportValue': >-
                        VPCStack:ExportsOutputRefvpcPrivateSubnet2Subnet7031C2BA60DCB1EE
                    - '"]'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1b__TASK_DEFINITION_ARN
              Value:
                Ref: defaultstatefuldefinition4CD55F35
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1b__COUNT
              Value: '1'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1c__ENABLE_EXECUTE_COMMAND
              Value: 'false'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1c__SECURITY_GROUPS
              Value:
                'Fn::Join':
                  - ''
                  - - '["'
                    - 'Fn::GetAtt':
                        - defaultsecuritygroupE8DEFA55
                        - GroupId
                    - '"]'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1c__SUBNETS
              Value:
                'Fn::Join':
                  - ''
                  - - '["'
                    - 'Fn::ImportValue': >-
                        VPCStack:ExportsOutputRefvpcPrivateSubnet3Subnet985AC459F9514491
                    - '"]'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1c__TASK_DEFINITION_ARN
              Value:
                Ref: defaultstatefuldefinition4CD55F35
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1c__COUNT
              Value: '1'
          Essential: true
          HealthCheck:
            Command:
              - CMD
              - curl
              - '--fail'
              - 'http://127.0.0.1:8080/health'
            Interval: 30
            Retries: 10
            StartPeriod: 300
            Timeout: 5
          Image: Any<Object>
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group:
                Ref: defaultcontrollerdefinitioncontrollerLogGroup60752F65
              awslogs-stream-prefix: controller
              awslogs-region: region
          Memory: 2048
          Name: controller
          StopTimeout: 120
      Cpu: '1024'
      ExecutionRoleArn:
        'Fn::GetAtt':
          - defaultcontrollerexecutionrole67636991
          - Arn
      Family: RestateBYOCdefaultcontrollerdefinition426584A5
      Memory: '2048'
      NetworkMode: awsvpc
      RequiresCompatibilities:
        - FARGATE
      RuntimePlatform:
        CpuArchitecture: ARM64
        OperatingSystemFamily: LINUX
      Tags:
        - Key: Name
          Value: RestateBYOC/default/controller-definition
      TaskRoleArn:
        'Fn::GetAtt':
          - defaultcontrollertaskrole7B120178
          - Arn
  defaultcontrollerdefinitioncontrollerLogGroup60752F65:
    Type: 'AWS::Logs::LogGroup'
    Properties:
      Tags:
        - Key: Name
          Value: RestateBYOC/default/controller-definition
    UpdateReplacePolicy: Retain
    DeletionPolicy: Retain
  defaultcontrollerserviceService18139D09:
    Type: 'AWS::ECS::Service'
    Properties:
      Cluster:
        Ref: defaultcluster07071299
      DeploymentConfiguration:
        Alarms:
          AlarmNames: []
          Enable: false
          Rollback: false
        MaximumPercent: 100
        MinimumHealthyPercent: 0
      DesiredCount: 1
      EnableECSManagedTags: false
      EnableExecuteCommand: false
      LaunchType: FARGATE
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: DISABLED
          SecurityGroups:
            - 'Fn::GetAtt':
                - defaultsecuritygroupE8DEFA55
                - GroupId
          Subnets:
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet1Subnet934893E8236E2271'
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet2Subnet7031C2BA60DCB1EE'
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet3Subnet985AC459F9514491'
      Tags:
        - Key: Name
          Value: RestateBYOC/default/controller-service
      TaskDefinition:
        Ref: defaultcontrollerdefinition66AD165F
    DependsOn:
      - defaultcontrollertaskroleDefaultPolicy328ED952
      - defaultcontrollertaskrole7B120178
  defaultrestatectllambdaexecutionrole68199B2A:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
        Version: '2012-10-17'
  defaultrestatectllambdaexecutionroleDefaultPolicy52B70971:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 'logs:CreateLogGroup'
              - 'logs:CreateLogStream'
              - 'logs:PutLogEvents'
              - 'ec2:CreateNetworkInterface'
              - 'ec2:DescribeNetworkInterfaces'
              - 'ec2:DescribeSubnets'
              - 'ec2:DeleteNetworkInterface'
              - 'ec2:AssignPrivateIpAddresses'
              - 'ec2:UnassignPrivateIpAddresses'
            Effect: Allow
            Resource: '*'
            Sid: AWSLambdaVPCAccessExecutionPermissions
        Version: '2012-10-17'
      PolicyName: defaultrestatectllambdaexecutionroleDefaultPolicy52B70971
      Roles:
        - Ref: defaultrestatectllambdaexecutionrole68199B2A
  defaultrestatectllambda05E7B262:
    Type: 'AWS::Lambda::Function'
    Properties:
      Architectures:
        - arm64
      Code: Any<Object>
      Environment:
        Variables:
          RESTATECTL_ADDRESS:
            'Fn::Join':
              - ''
              - - 'http://'
                - 'Fn::GetAtt':
                    - defaultsharednlb5E13F2A0
                    - DNSName
                - ':5122'
      Handler: restatectl
      Role:
        'Fn::GetAtt':
          - defaultrestatectllambdaexecutionrole68199B2A
          - Arn
      Runtime: provided.al2023
      Tags:
        - Key: Name
          Value: RestateBYOC/default/restatectl-lambda
      Timeout: 10
      VpcConfig:
        SecurityGroupIds:
          - 'Fn::GetAtt':
              - defaultsecuritygroupE8DEFA55
              - GroupId
        SubnetIds:
          - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet1Subnet934893E8236E2271'
          - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet2Subnet7031C2BA60DCB1EE'
          - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet3Subnet985AC459F9514491'
    DependsOn:
      - defaultrestatectllambdaexecutionroleDefaultPolicy52B70971
      - defaultrestatectllambdaexecutionrole68199B2A
  defaultretirementwatcherlambdaexecutionroleF14BB722:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
        Version: '2012-10-17'
  defaultretirementwatcherlambdaexecutionroleDefaultPolicy6242FE7D:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 'logs:CreateLogGroup'
              - 'logs:CreateLogStream'
              - 'logs:PutLogEvents'
            Effect: Allow
            Resource: '*'
            Sid: AWSLambdaBasicExecutionPermissions
          - Action: 'ecs:TagResource'
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'Fn::Join':
                      - /
                      - - 'Fn::Join':
                            - ':'
                            - - 'Fn::Select':
                                  - 0
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - defaultcluster07071299
                                                  - Arn
                              - 'Fn::Select':
                                  - 1
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - defaultcluster07071299
                                                  - Arn
                              - 'Fn::Select':
                                  - 2
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - defaultcluster07071299
                                                  - Arn
                              - 'Fn::Select':
                                  - 3
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - defaultcluster07071299
                                                  - Arn
                              - 'Fn::Select':
                                  - 4
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - defaultcluster07071299
                                                  - Arn
                              - task
                        - 'Fn::Select':
                            - 1
                            - 'Fn::Split':
                                - /
                                - 'Fn::GetAtt':
                                    - defaultcluster07071299
                                    - Arn
                        - ''
                  - '*'
            Sid: TagTasks
          - Action:
              - 'sqs:ReceiveMessage'
              - 'sqs:ChangeMessageVisibility'
              - 'sqs:GetQueueUrl'
              - 'sqs:DeleteMessage'
              - 'sqs:GetQueueAttributes'
            Effect: Allow
            Resource:
              'Fn::GetAtt':
                - defaultretirementwatcherqueue17CDF7F2
                - Arn
        Version: '2012-10-17'
      PolicyName: defaultretirementwatcherlambdaexecutionroleDefaultPolicy6242FE7D
      Roles:
        - Ref: defaultretirementwatcherlambdaexecutionroleF14BB722
  defaultretirementwatcherlambda80A1658E:
    Type: 'AWS::Lambda::Function'
    Properties:
      Architectures:
        - arm64
      Code: Any<Object>
      Handler: index.handler
      Role:
        'Fn::GetAtt':
          - defaultretirementwatcherlambdaexecutionroleF14BB722
          - Arn
      Runtime: nodejs22.x
      Tags:
        - Key: Name
          Value: RestateBYOC/default/retirement-watcher-lambda
      Timeout: 60
    DependsOn:
      - defaultretirementwatcherlambdaexecutionroleDefaultPolicy6242FE7D
      - defaultretirementwatcherlambdaexecutionroleF14BB722
  defaultretirementwatcherlambdaSqsEventSourceRestateBYOCdefaultretirementwatcherqueueBDC523A27D939D1D:
    Type: 'AWS::Lambda::EventSourceMapping'
    Properties:
      BatchSize: 1
      EventSourceArn:
        'Fn::GetAtt':
          - defaultretirementwatcherqueue17CDF7F2
          - Arn
      FunctionName:
        Ref: defaultretirementwatcherlambda80A1658E
      Tags:
        - Key: Name
          Value: RestateBYOC/default/retirement-watcher-lambda
  defaultretirementwatcherqueue17CDF7F2:
    Type: 'AWS::SQS::Queue'
    Properties:
      Tags:
        - Key: Name
          Value: RestateBYOC/default/retirement-watcher-queue
      VisibilityTimeout: 60
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  defaultretirementwatcherqueuePolicyFD7DA2DA:
    Type: 'AWS::SQS::QueuePolicy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 'sqs:SendMessage'
              - 'sqs:GetQueueAttributes'
              - 'sqs:GetQueueUrl'
            Condition:
              ArnEquals:
                'aws:SourceArn':
                  'Fn::GetAtt':
                    - defaultretirementwatcherrule3F2F34F3
                    - Arn
            Effect: Allow
            Principal:
              Service: events.amazonaws.com
            Resource:
              'Fn::GetAtt':
                - defaultretirementwatcherqueue17CDF7F2
                - Arn
        Version: '2012-10-17'
      Queues:
        - Ref: defaultretirementwatcherqueue17CDF7F2
  defaultretirementwatcherrule3F2F34F3:
    Type: 'AWS::Events::Rule'
    Properties:
      EventPattern:
        detail:
          eventTypeCode:
            - equals-ignore-case: AWS_ECS_TASK_PATCHING_RETIREMENT
          service:
            - equals-ignore-case: ecs
        resources:
          - prefix:
              'Fn::Join':
                - /
                - - 'Fn::Join':
                      - ':'
                      - - 'Fn::Select':
                            - 0
                            - 'Fn::Split':
                                - ':'
                                - 'Fn::Select':
                                    - 0
                                    - 'Fn::Split':
                                        - /
                                        - 'Fn::GetAtt':
                                            - defaultcluster07071299
                                            - Arn
                        - 'Fn::Select':
                            - 1
                            - 'Fn::Split':
                                - ':'
                                - 'Fn::Select':
                                    - 0
                                    - 'Fn::Split':
                                        - /
                                        - 'Fn::GetAtt':
                                            - defaultcluster07071299
                                            - Arn
                        - 'Fn::Select':
                            - 2
                            - 'Fn::Split':
                                - ':'
                                - 'Fn::Select':
                                    - 0
                                    - 'Fn::Split':
                                        - /
                                        - 'Fn::GetAtt':
                                            - defaultcluster07071299
                                            - Arn
                        - 'Fn::Select':
                            - 3
                            - 'Fn::Split':
                                - ':'
                                - 'Fn::Select':
                                    - 0
                                    - 'Fn::Split':
                                        - /
                                        - 'Fn::GetAtt':
                                            - defaultcluster07071299
                                            - Arn
                        - 'Fn::Select':
                            - 4
                            - 'Fn::Split':
                                - ':'
                                - 'Fn::Select':
                                    - 0
                                    - 'Fn::Split':
                                        - /
                                        - 'Fn::GetAtt':
                                            - defaultcluster07071299
                                            - Arn
                        - task
                  - 'Fn::Select':
                      - 1
                      - 'Fn::Split':
                          - /
                          - 'Fn::GetAtt':
                              - defaultcluster07071299
                              - Arn
                  - ''
        detail-type:
          - equals-ignore-case: AWS Health Event
      State: ENABLED
      Targets:
        - Arn:
            'Fn::GetAtt':
              - defaultretirementwatcherqueue17CDF7F2
              - Arn
          Id: Target0
  defaultcloudwatchcustomwidgetexecutionrole4ED639C0:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
        Version: '2012-10-17'
  defaultcloudwatchcustomwidgetexecutionroleDefaultPolicy61BF3642:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 'logs:CreateLogGroup'
              - 'logs:CreateLogStream'
              - 'logs:PutLogEvents'
            Effect: Allow
            Resource: '*'
            Sid: AWSLambdaBasicExecutionPermissions
          - Action: 'lambda:InvokeFunction'
            Effect: Allow
            Resource:
              'Fn::GetAtt':
                - defaultrestatectllambda05E7B262
                - Arn
            Sid: InvokeRestatectl
          - Action:
              - 'ec2:DescribeVolumes'
              - 'ec2:DescribeVolumeStatus'
            Effect: Allow
            Resource: '*'
            Sid: EC2ReadActions
          - Action: 'ecs:DescribeTaskDefinition'
            Effect: Allow
            Resource: '*'
            Sid: ECSReadActions
          - Action: 'ecs:ListTasks'
            Condition:
              StringEquals:
                'ecs:cluster':
                  'Fn::GetAtt':
                    - defaultcluster07071299
                    - Arn
            Effect: Allow
            Resource: '*'
            Sid: ECSListTasks
          - Action: 'ecs:DescribeTasks'
            Condition:
              StringEquals:
                'ecs:cluster':
                  'Fn::GetAtt':
                    - defaultcluster07071299
                    - Arn
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'arn:'
                  - Ref: 'AWS::Partition'
                  - ':ecs:'
                  - Ref: 'AWS::Region'
                  - ':'
                  - Ref: 'AWS::AccountId'
                  - ':task/'
                  - Ref: defaultcluster07071299
                  - /*
            Sid: ECSDescribeTasks
          - Action: 'ecs:DescribeServices'
            Condition:
              StringEquals:
                'ecs:cluster':
                  'Fn::GetAtt':
                    - defaultcluster07071299
                    - Arn
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'arn:'
                  - Ref: 'AWS::Partition'
                  - ':ecs:'
                  - Ref: 'AWS::Region'
                  - ':'
                  - Ref: 'AWS::AccountId'
                  - ':service/'
                  - Ref: defaultcluster07071299
                  - /*
            Sid: ECSDescribeServices
          - Action: 'cloudwatch:GetMetricData'
            Effect: Allow
            Resource: '*'
            Sid: CloudWatchReadActions
        Version: '2012-10-17'
      PolicyName: defaultcloudwatchcustomwidgetexecutionroleDefaultPolicy61BF3642
      Roles:
        - Ref: defaultcloudwatchcustomwidgetexecutionrole4ED639C0
  defaultcloudwatchcustomwidgetlambda65C26149:
    Type: 'AWS::Lambda::Function'
    Properties:
      Architectures:
        - arm64
      Code: Any<Object>
      Handler: index.handler
      MemorySize: 1024
      Role:
        'Fn::GetAtt':
          - defaultcloudwatchcustomwidgetexecutionrole4ED639C0
          - Arn
      Runtime: nodejs22.x
      Tags:
        - Key: Name
          Value: RestateBYOC/default/cloudwatch-custom-widget-lambda
      Timeout: 60
    DependsOn:
      - defaultcloudwatchcustomwidgetexecutionroleDefaultPolicy61BF3642
      - defaultcloudwatchcustomwidgetexecutionrole4ED639C0
  defaultcloudwatchcustomwidgetlambdacloudwatchcustomwidgetlambdaallowdatasource2DAA7122:
    Type: 'AWS::Lambda::Permission'
    Properties:
      Action: 'lambda:InvokeFunction'
      FunctionName:
        'Fn::GetAtt':
          - defaultcloudwatchcustomwidgetlambda65C26149
          - Arn
      Principal: lambda.datasource.cloudwatch.amazonaws.com
  defaultmetrics63974EF8:
    Type: 'AWS::CloudWatch::Dashboard'
    Properties:
      DashboardBody:
        'Fn::Join':
          - ''
          - - >-
              {"widgets":[{"type":"metric","width":12,"height":6,"x":0,"y":0,"properties":{"view":"timeSeries","title":"Stateless
              CPU","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"CPU","expression":"cpu /
              1024"}],[{"expression":"SELECT AVG(CpuUtilized) FROM
              SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOCdefaultstatelessdefinitionFF58C79A' GROUP BY
              TaskId","visible":false,"id":"cpu"}]],"annotations":{"horizontal":[{"value":16,"label":"Limit","yAxis":"left"}]},"yAxis":{"left":{"label":"vCPUs","showUnits":false}}}},{"type":"metric","width":12,"height":6,"x":12,"y":0,"properties":{"view":"timeSeries","title":"Stateless
              Memory","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Memory","expression":"memory /
              1024"}],[{"expression":"SELECT AVG(MemoryUtilized) FROM
              SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOCdefaultstatelessdefinitionFF58C79A' GROUP BY
              TaskId","visible":false,"id":"memory"}]],"annotations":{"horizontal":[{"value":32,"label":"Limit","yAxis":"left"}]},"yAxis":{"left":{"label":"GiB","showUnits":false}}}},{"type":"metric","width":12,"height":6,"x":0,"y":6,"properties":{"view":"timeSeries","title":"Stateless
              Network Tx","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Tx","expression":"SELECT
              AVG(NetworkTxBytes) FROM SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOCdefaultstatelessdefinitionFF58C79A' GROUP BY
              TaskId"}]],"yAxis":{"left":{"label":"Bytes/sec","showUnits":false}}}},{"type":"metric","width":12,"height":6,"x":12,"y":6,"properties":{"view":"timeSeries","title":"Stateless
              Network Rx","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Rx","expression":"SELECT
              AVG(NetworkRxBytes) FROM SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOCdefaultstatelessdefinitionFF58C79A' GROUP BY
              TaskId"}]],"yAxis":{"left":{"label":"Bytes/sec","showUnits":false}}}},{"type":"log","width":24,"height":6,"x":0,"y":12,"properties":{"view":"table","title":"Stateless
              Logs","region":"region","query":"SOURCE '
            - Ref: defaultstatelessdefinitionrestateLogGroup49FB832E
            - >-
              ' | fields @logStream, @timestamp, level, fields.message,
              target\\n          | sort @timestamp desc\\n          | limit
              500"}},{"type":"metric","width":12,"height":6,"x":0,"y":18,"properties":{"view":"timeSeries","title":"Stateful
              CPU","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"CPU","expression":"cpu /
              1024"}],[{"expression":"SELECT AVG(CpuUtilized) FROM
              SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOCdefaultstatefuldefinition4D62F21B' GROUP BY
              TaskId","visible":false,"id":"cpu"}]],"annotations":{"horizontal":[{"value":16,"label":"Limit","yAxis":"left"}]},"yAxis":{"left":{"label":"vCPUs","showUnits":false}}}},{"type":"metric","width":12,"height":6,"x":12,"y":18,"properties":{"view":"timeSeries","title":"Stateful
              Memory","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Memory","expression":"memory /
              1024"}],[{"expression":"SELECT AVG(MemoryUtilized) FROM
              SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOCdefaultstatefuldefinition4D62F21B' GROUP BY
              TaskId","visible":false,"id":"memory"}]],"annotations":{"horizontal":[{"value":32,"label":"Limit","yAxis":"left"}]},"yAxis":{"left":{"label":"GiB","showUnits":false}}}},{"type":"metric","width":12,"height":6,"x":0,"y":24,"properties":{"view":"timeSeries","title":"Stateful
              Network Tx","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Tx","expression":"SELECT
              AVG(NetworkTxBytes) FROM SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOCdefaultstatefuldefinition4D62F21B' GROUP BY
              TaskId"}]],"yAxis":{"left":{"label":"Bytes/sec","showUnits":false}}}},{"type":"metric","width":12,"height":6,"x":12,"y":24,"properties":{"view":"timeSeries","title":"Stateful
              Network Rx","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Rx","expression":"SELECT
              AVG(NetworkRxBytes) FROM SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOCdefaultstatefuldefinition4D62F21B' GROUP BY
              TaskId"}]],"yAxis":{"left":{"label":"Bytes/sec","showUnits":false}}}},{"type":"log","width":24,"height":6,"x":0,"y":30,"properties":{"view":"table","title":"Stateful
              Logs","region":"region","query":"SOURCE '
            - Ref: defaultstatefuldefinitionrestateLogGroup3CA44D5E
            - >-
              ' | fields @logStream, @timestamp, level, fields.message,
              target\\n          | sort @timestamp desc\\n          | limit
              500"}},{"type":"metric","width":8,"height":6,"x":0,"y":36,"properties":{"view":"timeSeries","title":"Ephemeral
              Volume Usage (Total size 200GiB)","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Usage","expression":"SELECT
              MAX(EphemeralStorageUtilized) FROM
              SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily) WHERE TaskDefinitionFamily =
              'RestateBYOCdefaultstatefuldefinition4D62F21B'"}]],"annotations":{"horizontal":[{"value":200,"label":"Volume
              size","visible":false,"yAxis":"left"}]},"yAxis":{"left":{"label":"GiB","showUnits":false}},"liveData":false}},{"type":"metric","width":8,"height":6,"x":8,"y":36,"properties":{"view":"timeSeries","title":"Volume
              Write Throughput (Limited to 150 MiB/sec)","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Write","expression":"RATE(count) /
              1048576"}],[{"expression":"SELECT MAX(StorageWriteBytes) FROM
              SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOCdefaultstatefuldefinition4D62F21B' GROUP BY
              TaskId","visible":false,"id":"count"}]],"annotations":{"horizontal":[{"value":150,"label":"Limit","visible":false,"yAxis":"left"}]},"yAxis":{"left":{"label":"MiB/sec","showUnits":false}}}},{"type":"metric","width":8,"height":6,"x":16,"y":36,"properties":{"view":"timeSeries","title":"Volume
              Read Throughput (Limited to 150 MiB/sec)","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Read","expression":"RATE(count) /
              1048576"}],[{"expression":"SELECT MAX(StorageReadBytes) FROM
              SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOCdefaultstatefuldefinition4D62F21B' GROUP BY
              TaskId","visible":false,"id":"count"}]],"annotations":{"horizontal":[{"value":150,"label":"Limit","visible":false,"yAxis":"left"}]},"yAxis":{"left":{"label":"MiB/sec","showUnits":false}}}},{"type":"log","width":24,"height":6,"x":0,"y":42,"properties":{"view":"table","title":"Controller
              Logs","region":"region","query":"SOURCE '
            - Ref: defaultcontrollerdefinitioncontrollerLogGroup60752F65
            - >-
              ' | fields @logStream, @timestamp, level, fields.message,
              target\\n          | sort @timestamp desc\\n          | limit
              500"}}]}
      DashboardName: RestateBYOC_default_metrics
  defaultcontrolpanel3C04E2BB:
    Type: 'AWS::CloudWatch::Dashboard'
    Properties:
      DashboardBody:
        'Fn::Join':
          - ''
          - - >-
              {"widgets":[{"type":"custom","width":24,"height":26,"x":0,"y":0,"properties":{"endpoint":"
            - 'Fn::GetAtt':
                - defaultcloudwatchcustomwidgetlambda65C26149
                - Arn
            - '","params":{"command":"controlPanel","input":{"region":"'
            - Ref: 'AWS::Region'
            - >-
              ","summary":{"clusterName":"RestateBYOC/default","restateVersion":"1.3","stackVersion":"0.2.0","metricsDashboardName":"
            - Ref: defaultmetrics63974EF8
            - '"},"resources":{"ecsClusterArn":"'
            - 'Fn::GetAtt':
                - defaultcluster07071299
                - Arn
            - '","statelessServiceArn":"'
            - Ref: defaultstatelessserviceService8A7FABFB
            - '","controllerServiceArn":"'
            - Ref: defaultcontrollerserviceService18139D09
            - '","restatectlLambdaArn":"'
            - 'Fn::GetAtt':
                - defaultrestatectllambda05E7B262
                - Arn
            - >-
              "},"connectivityAndSecurity":{"connectivity":{"loadBalancerArns":{"ingress":["
            - Ref: defaultsharednlb5E13F2A0
            - '"],"admin":["'
            - Ref: defaultsharednlb5E13F2A0
            - '"]},"addresses":{"ingress":"http://'
            - 'Fn::GetAtt':
                - defaultsharednlb5E13F2A0
                - DNSName
            - ':8080","admin":"http://'
            - 'Fn::GetAtt':
                - defaultsharednlb5E13F2A0
                - DNSName
            - ':9070","webUI":"http://'
            - 'Fn::GetAtt':
                - defaultsharednlb5E13F2A0
                - DNSName
            - ':9070/ui"}},"networking":{"vpc":"'
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcA2121C384D1B3CDE'
            - '","availabilityZones":["dummy1a","dummy1b","dummy1c"],"subnets":["'
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet1Subnet934893E8236E2271'
            - '","'
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet2Subnet7031C2BA60DCB1EE'
            - '","'
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet3Subnet985AC459F9514491'
            - '"]},"security":{"securityGroups":["'
            - 'Fn::GetAtt':
                - defaultsecuritygroupE8DEFA55
                - GroupId
            - '"]}},"storage":{"s3":{"bucket":"'
            - Ref: defaultbucket65304C97
            - >-
              "}}}},"title":"","updateOn":{"refresh":true,"resize":true,"timeRange":true}}}]}
      DashboardName: RestateBYOC_default_control-panel
  defaultservicedeployerlambdaexecutionrole6140D796:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
        Version: '2012-10-17'
  defaultservicedeployerlambdaexecutionroleDefaultPolicy09E0E938:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 'logs:CreateLogGroup'
              - 'logs:CreateLogStream'
              - 'logs:PutLogEvents'
              - 'ec2:CreateNetworkInterface'
              - 'ec2:DescribeNetworkInterfaces'
              - 'ec2:DescribeSubnets'
              - 'ec2:DeleteNetworkInterface'
              - 'ec2:AssignPrivateIpAddresses'
              - 'ec2:UnassignPrivateIpAddresses'
            Effect: Allow
            Resource: '*'
            Sid: AWSLambdaVPCAccessExecutionPermissions
        Version: '2012-10-17'
      PolicyName: defaultservicedeployerlambdaexecutionroleDefaultPolicy09E0E938
      Roles:
        - Ref: defaultservicedeployerlambdaexecutionrole6140D796
  defaultservicedeployerEventHandler07D0FC10:
    Type: 'AWS::Lambda::Function'
    Properties:
      Architectures:
        - arm64
      Code: Any<Object>
      Description: Restate custom registration handler
      Environment:
        Variables:
          NODE_OPTIONS: '--enable-source-maps'
      Handler: entrypoint.handler
      MemorySize: 128
      Role:
        'Fn::GetAtt':
          - defaultservicedeployerlambdaexecutionrole6140D796
          - Arn
      Runtime: nodejs22.x
      Timeout: 180
      VpcConfig:
        SecurityGroupIds:
          - 'Fn::GetAtt':
              - defaultsecuritygroupE8DEFA55
              - GroupId
        SubnetIds:
          - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet1Subnet934893E8236E2271'
          - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet2Subnet7031C2BA60DCB1EE'
          - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet3Subnet985AC459F9514491'
    DependsOn:
      - defaultservicedeployerlambdaexecutionroleDefaultPolicy09E0E938
      - defaultservicedeployerlambdaexecutionrole6140D796
  defaultservicedeployerDeploymentLogs01FFFB9F:
    Type: 'AWS::Logs::LogGroup'
    Properties:
      LogGroupName:
        'Fn::Join':
          - ''
          - - /aws/lambda/
            - Ref: defaultservicedeployerEventHandler07D0FC10
      RetentionInDays: 30
    UpdateReplacePolicy: Retain
    DeletionPolicy: RetainExceptOnCreate
"
`;

exports[`BYOC With one az 1`] = `
"Resources:
  oneazsecuritygroup3EBC43A7:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      GroupDescription: RestateBYOC/one-az/security-group
      SecurityGroupEgress:
        - CidrIp: 0.0.0.0/0
          Description: Allow all outbound traffic by default
          IpProtocol: '-1'
      Tags:
        - Key: Name
          Value: RestateBYOC/one-az/security-group
      VpcId:
        'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcA2121C384D1B3CDE'
  oneazsecuritygroupfromRestateBYOConeazsecuritygroup044152E980808B74ECD0:
    Type: 'AWS::EC2::SecurityGroupIngress'
    Properties:
      Description: 'from RestateBYOConeazsecuritygroup044152E9:8080'
      FromPort: 8080
      GroupId:
        'Fn::GetAtt':
          - oneazsecuritygroup3EBC43A7
          - GroupId
      IpProtocol: tcp
      SourceSecurityGroupId:
        'Fn::GetAtt':
          - oneazsecuritygroup3EBC43A7
          - GroupId
      ToPort: 8080
  oneazsecuritygroupfromRestateBYOConeazsecuritygroup044152E99070AAE9493A:
    Type: 'AWS::EC2::SecurityGroupIngress'
    Properties:
      Description: 'from RestateBYOConeazsecuritygroup044152E9:9070'
      FromPort: 9070
      GroupId:
        'Fn::GetAtt':
          - oneazsecuritygroup3EBC43A7
          - GroupId
      IpProtocol: tcp
      SourceSecurityGroupId:
        'Fn::GetAtt':
          - oneazsecuritygroup3EBC43A7
          - GroupId
      ToPort: 9070
  oneazsecuritygroupfromRestateBYOConeazsecuritygroup044152E95122B819ECBD:
    Type: 'AWS::EC2::SecurityGroupIngress'
    Properties:
      Description: 'from RestateBYOConeazsecuritygroup044152E9:5122'
      FromPort: 5122
      GroupId:
        'Fn::GetAtt':
          - oneazsecuritygroup3EBC43A7
          - GroupId
      IpProtocol: tcp
      SourceSecurityGroupId:
        'Fn::GetAtt':
          - oneazsecuritygroup3EBC43A7
          - GroupId
      ToPort: 5122
  oneazbucket84454759:
    Type: 'AWS::S3::Bucket'
    Properties:
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
    UpdateReplacePolicy: Retain
    DeletionPolicy: Retain
  oneazbucketPolicy9AEA2C98:
    Type: 'AWS::S3::BucketPolicy'
    Properties:
      Bucket:
        Ref: oneazbucket84454759
      PolicyDocument:
        Statement:
          - Action: 's3:*'
            Condition:
              Bool:
                'aws:SecureTransport': 'false'
            Effect: Deny
            Principal:
              AWS: '*'
            Resource:
              - 'Fn::GetAtt':
                  - oneazbucket84454759
                  - Arn
              - 'Fn::Join':
                  - ''
                  - - 'Fn::GetAtt':
                        - oneazbucket84454759
                        - Arn
                    - /*
        Version: '2012-10-17'
  oneazcluster64058501:
    Type: 'AWS::ECS::Cluster'
    Properties:
      ClusterSettings:
        - Name: containerInsights
          Value: enhanced
      Tags:
        - Key: Name
          Value: RestateBYOC/one-az/cluster
  oneazrestatetaskroleED26DCA9:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
        Version: '2012-10-17'
  oneazrestatetaskroleDefaultPolicy75353BFC:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 's3:GetObject'
              - 's3:PutObject'
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'Fn::GetAtt':
                      - oneazbucket84454759
                      - Arn
                  - /*
            Sid: ReadWriteBucket
          - Action: 's3:ListBucket'
            Effect: Allow
            Resource:
              'Fn::GetAtt':
                - oneazbucket84454759
                - Arn
            Sid: ListBucket
        Version: '2012-10-17'
      PolicyName: oneazrestatetaskroleDefaultPolicy75353BFC
      Roles:
        - Ref: oneazrestatetaskroleED26DCA9
  oneazrestateexecutionrole28BB1A47:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
        Version: '2012-10-17'
  oneazrestateexecutionroleDefaultPolicy73A40FE6:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 'logs:CreateLogStream'
              - 'logs:PutLogEvents'
            Effect: Allow
            Resource:
              'Fn::GetAtt':
                - oneazstatelessdefinitionrestateLogGroup43B4F616
                - Arn
          - Action:
              - 'logs:CreateLogStream'
              - 'logs:PutLogEvents'
            Effect: Allow
            Resource:
              'Fn::GetAtt':
                - oneazstatefuldefinitionrestateLogGroupB1728FF3
                - Arn
        Version: '2012-10-17'
      PolicyName: oneazrestateexecutionroleDefaultPolicy73A40FE6
      Roles:
        - Ref: oneazrestateexecutionrole28BB1A47
  oneazsharednlb21F0A25A:
    Type: 'AWS::ElasticLoadBalancingV2::LoadBalancer'
    Properties:
      LoadBalancerAttributes:
        - Key: deletion_protection.enabled
          Value: 'false'
        - Key: load_balancing.cross_zone.enabled
          Value: 'false'
        - Key: dns_record.client_routing_policy
          Value: availability_zone_affinity
      Scheme: internal
      SecurityGroups:
        - 'Fn::GetAtt':
            - oneazsecuritygroup3EBC43A7
            - GroupId
      Subnets:
        - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet1Subnet934893E8236E2271'
      Tags:
        - Key: Name
          Value: RestateBYOC/one-az/shared-nlb
      Type: network
  oneazingresssharedlistener65EA2978:
    Type: 'AWS::ElasticLoadBalancingV2::Listener'
    Properties:
      DefaultActions:
        - TargetGroupArn:
            Ref: oneazingresssharedtarget87A44DD7
          Type: forward
      LoadBalancerArn:
        Ref: oneazsharednlb21F0A25A
      Port: 8080
      Protocol: TCP
  oneazadminsharedlistenerA70D0F28:
    Type: 'AWS::ElasticLoadBalancingV2::Listener'
    Properties:
      DefaultActions:
        - TargetGroupArn:
            Ref: oneazadminsharedtarget813446FE
          Type: forward
      LoadBalancerArn:
        Ref: oneazsharednlb21F0A25A
      Port: 9070
      Protocol: TCP
  oneaznodesharedlistener633B0D1E:
    Type: 'AWS::ElasticLoadBalancingV2::Listener'
    Properties:
      DefaultActions:
        - TargetGroupArn:
            Ref: oneaznodesharedtarget4E3E63D0
          Type: forward
      LoadBalancerArn:
        Ref: oneazsharednlb21F0A25A
      Port: 5122
      Protocol: TCP
  oneazstatelessdefinition33395BD6:
    Type: 'AWS::ECS::TaskDefinition'
    Properties:
      ContainerDefinitions:
        - Cpu: 16384
          EntryPoint:
            - bash
            - '-c'
            - >

              curl --no-progress-meter $ECS_CONTAINER_METADATA_URI_V4/task -o
              task-metadata && \\

              export \\
                RESTATE_NODE_NAME=$(jq -r '.TaskARN' task-metadata) \\
                RESTATE_LOCATION="$AWS_REGION.$(jq -r '.AvailabilityZone' task-metadata)" \\
                RESTATE_ADVERTISED_ADDRESS="http://$(jq -r '.Containers[0].Networks[0].IPv4Addresses[0]' task-metadata):5122"
              exec restate-server
          Environment:
            - Name: RESTATE_LOG_FORMAT
              Value: json
            - Name: RESTATE_CLUSTER_NAME
              Value: RestateBYOC/one-az
            - Name: RESTATE_ROLES
              Value: '["admin","http-ingress"]'
            - Name: RESTATE_AUTO_PROVISION
              Value: 'true'
            - Name: RESTATE_SHUTDOWN_TIMEOUT
              Value: 100s
            - Name: RESTATE_DEFAULT_NUM_PARTITIONS
              Value: '128'
            - Name: RESTATE_DEFAULT_REPLICATION
              Value: '{node: 2}'
            - Name: RESTATE_METADATA_CLIENT__TYPE
              Value: object-store
            - Name: RESTATE_METADATA_CLIENT__PATH
              Value:
                'Fn::Join':
                  - ''
                  - - 's3://'
                    - Ref: oneazbucket84454759
                    - /metadata
            - Name: RESTATE_BIFROST__DEFAULT_PROVIDER
              Value: replicated
            - Name: >-
                RESTATE_INGRESS__EXPERIMENTAL_FEATURE_ENABLE_SEPARATE_INGRESS_ROLE
              Value: 'true'
            - Name: RESTATE_INGRESS__ADVERTISED_INGRESS_ENDPOINT
              Value:
                'Fn::Join':
                  - ''
                  - - 'http://'
                    - 'Fn::GetAtt':
                        - oneazsharednlb21F0A25A
                        - DNSName
                    - ':8080'
            - Name: RESTATE_WORKER__SNAPSHOTS__DESTINATION
              Value:
                'Fn::Join':
                  - ''
                  - - 's3://'
                    - Ref: oneazbucket84454759
                    - /snapshots
          Essential: true
          HealthCheck:
            Command:
              - CMD
              - curl
              - '--fail'
              - 'http://127.0.0.1:8080/restate/health'
            Interval: 30
            Retries: 3
            Timeout: 5
          Image: Any<Object>
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group:
                Ref: oneazstatelessdefinitionrestateLogGroup43B4F616
              awslogs-stream-prefix: restate
              awslogs-region: region
          Memory: 32768
          Name: restate
          PortMappings:
            - ContainerPort: 8080
              Name: ingress
              Protocol: tcp
            - ContainerPort: 9070
              Name: admin
              Protocol: tcp
            - ContainerPort: 5122
              Name: node
              Protocol: tcp
          StopTimeout: 120
      Cpu: '16384'
      ExecutionRoleArn:
        'Fn::GetAtt':
          - oneazrestateexecutionrole28BB1A47
          - Arn
      Family: RestateBYOConeazstatelessdefinition6087330A
      Memory: '32768'
      NetworkMode: awsvpc
      RequiresCompatibilities:
        - FARGATE
      RuntimePlatform:
        CpuArchitecture: ARM64
        OperatingSystemFamily: LINUX
      Tags:
        - Key: Name
          Value: RestateBYOC/one-az/stateless-definition
      TaskRoleArn:
        'Fn::GetAtt':
          - oneazrestatetaskroleED26DCA9
          - Arn
  oneazstatelessdefinitionrestateLogGroup43B4F616:
    Type: 'AWS::Logs::LogGroup'
    Properties:
      Tags:
        - Key: Name
          Value: RestateBYOC/one-az/stateless-definition
    UpdateReplacePolicy: Retain
    DeletionPolicy: Retain
  oneazstatelessserviceServiceB8B226F2:
    Type: 'AWS::ECS::Service'
    Properties:
      Cluster:
        Ref: oneazcluster64058501
      DeploymentConfiguration:
        Alarms:
          AlarmNames: []
          Enable: false
          Rollback: false
        MaximumPercent: 200
        MinimumHealthyPercent: 100
      DesiredCount: 3
      EnableECSManagedTags: false
      EnableExecuteCommand: false
      HealthCheckGracePeriodSeconds: 60
      LaunchType: FARGATE
      LoadBalancers:
        - ContainerName: restate
          ContainerPort: 8080
          TargetGroupArn:
            Ref: oneazingresssharedtarget87A44DD7
        - ContainerName: restate
          ContainerPort: 9070
          TargetGroupArn:
            Ref: oneazadminsharedtarget813446FE
        - ContainerName: restate
          ContainerPort: 5122
          TargetGroupArn:
            Ref: oneaznodesharedtarget4E3E63D0
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: DISABLED
          SecurityGroups:
            - 'Fn::GetAtt':
                - oneazsecuritygroup3EBC43A7
                - GroupId
          Subnets:
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet1Subnet934893E8236E2271'
      PropagateTags: SERVICE
      Tags:
        - Key: Name
          Value: RestateBYOC/one-az/stateless-service
      TaskDefinition:
        Ref: oneazstatelessdefinition33395BD6
    DependsOn:
      - oneazadminsharedlistenerA70D0F28
      - oneazingresssharedlistener65EA2978
      - oneaznodesharedlistener633B0D1E
      - oneazrestatetaskroleDefaultPolicy75353BFC
      - oneazrestatetaskroleED26DCA9
  oneazstatefuldefinition8395A3A6:
    Type: 'AWS::ECS::TaskDefinition'
    Properties:
      ContainerDefinitions:
        - Cpu: 16384
          EntryPoint:
            - bash
            - '-c'
            - >

              curl --no-progress-meter $ECS_CONTAINER_METADATA_URI_V4/task -o
              task-metadata && \\

              export \\
                RESTATE_NODE_NAME=$(jq -r '.TaskARN' task-metadata) \\
                RESTATE_LOCATION="$AWS_REGION.$(jq -r '.AvailabilityZone' task-metadata)" \\
                RESTATE_ADVERTISED_ADDRESS="http://$(jq -r '.Containers[0].Networks[0].IPv4Addresses[0]' task-metadata):5122"
              exec restate-server
          Environment:
            - Name: RESTATE_LOG_FORMAT
              Value: json
            - Name: RESTATE_CLUSTER_NAME
              Value: RestateBYOC/one-az
            - Name: RESTATE_ROLES
              Value: '["log-server", "worker"]'
            - Name: RESTATE_AUTO_PROVISION
              Value: 'false'
            - Name: RESTATE_SHUTDOWN_TIMEOUT
              Value: 100s
            - Name: RESTATE_ROCKSDB_TOTAL_MEMORY_SIZE
              Value: 24576MiB
            - Name: RESTATE_METADATA_CLIENT__TYPE
              Value: object-store
            - Name: RESTATE_METADATA_CLIENT__PATH
              Value:
                'Fn::Join':
                  - ''
                  - - 's3://'
                    - Ref: oneazbucket84454759
                    - /metadata
            - Name: RESTATE_WORKER__SNAPSHOTS__DESTINATION
              Value:
                'Fn::Join':
                  - ''
                  - - 's3://'
                    - Ref: oneazbucket84454759
                    - /snapshots
            - Name: RESTATE_WORKER__SNAPSHOTS__SNAPSHOT_INTERVAL_NUM_RECORDS
              Value: '1000000'
            - Name: RESTATE_WORKER__STORAGE__ROCKSDB_DISABLE_DIRECT_IO_FOR_READS
              Value: 'true'
            - Name: RESTATE_WORKER__STORAGE__ROCKSDB_DISABLE_WAL_FSYNC
              Value: 'true'
            - Name: RESTATE_LOG_SERVER__ROCKSDB_DISABLE_WAL_FSYNC
              Value: 'true'
            - Name: RESTATE_LOG_SERVER__ROCKSDB_DISABLE_DIRECT_IO_FOR_READS
              Value: 'true'
            - Name: >-
                RESTATE_INGRESS__EXPERIMENTAL_FEATURE_ENABLE_SEPARATE_INGRESS_ROLE
              Value: 'true'
          Essential: true
          HealthCheck:
            Command:
              - CMD
              - curl
              - '--fail'
              - 'http://127.0.0.1:5122/health'
            Interval: 30
            Retries: 3
            Timeout: 5
          Image: Any<Object>
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group:
                Ref: oneazstatefuldefinitionrestateLogGroupB1728FF3
              awslogs-stream-prefix: restate
              awslogs-region: region
          Memory: 32768
          MountPoints:
            - ContainerPath: /restate-data
              ReadOnly: false
              SourceVolume: restate-data
          Name: restate
          PortMappings:
            - ContainerPort: 5122
              Name: node
              Protocol: tcp
          RestartPolicy:
            Enabled: true
            RestartAttemptPeriod: 60
          StopTimeout: 120
      Cpu: '16384'
      EphemeralStorage:
        SizeInGiB: 200
      ExecutionRoleArn:
        'Fn::GetAtt':
          - oneazrestateexecutionrole28BB1A47
          - Arn
      Family: RestateBYOConeazstatefuldefinition17638845
      Memory: '32768'
      NetworkMode: awsvpc
      RequiresCompatibilities:
        - FARGATE
      RuntimePlatform:
        CpuArchitecture: ARM64
        OperatingSystemFamily: LINUX
      Tags:
        - Key: Name
          Value: RestateBYOC/one-az/stateful-definition
      TaskRoleArn:
        'Fn::GetAtt':
          - oneazrestatetaskroleED26DCA9
          - Arn
      Volumes:
        - ConfiguredAtLaunch: false
          Name: restate-data
  oneazstatefuldefinitionrestateLogGroupB1728FF3:
    Type: 'AWS::Logs::LogGroup'
    Properties:
      Tags:
        - Key: Name
          Value: RestateBYOC/one-az/stateful-definition
    UpdateReplacePolicy: Retain
    DeletionPolicy: Retain
  oneazingresssharedtarget87A44DD7:
    Type: 'AWS::ElasticLoadBalancingV2::TargetGroup'
    Properties:
      HealthCheckEnabled: true
      HealthCheckIntervalSeconds: 5
      HealthCheckPath: /restate/health
      HealthCheckProtocol: HTTP
      HealthCheckTimeoutSeconds: 2
      Port: 8080
      Protocol: TCP
      Tags:
        - Key: Name
          Value: RestateBYOC/one-az/ingress-shared-target
      TargetType: ip
      VpcId:
        'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcA2121C384D1B3CDE'
  oneazadminsharedtarget813446FE:
    Type: 'AWS::ElasticLoadBalancingV2::TargetGroup'
    Properties:
      HealthCheckEnabled: true
      HealthCheckIntervalSeconds: 5
      HealthCheckPath: /health
      HealthCheckPort: '9070'
      HealthCheckProtocol: HTTP
      HealthCheckTimeoutSeconds: 2
      Port: 9070
      Protocol: TCP
      Tags:
        - Key: Name
          Value: RestateBYOC/one-az/admin-shared-target
      TargetType: ip
      VpcId:
        'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcA2121C384D1B3CDE'
  oneaznodesharedtarget4E3E63D0:
    Type: 'AWS::ElasticLoadBalancingV2::TargetGroup'
    Properties:
      HealthCheckEnabled: true
      HealthCheckIntervalSeconds: 5
      HealthCheckPath: /health
      HealthCheckPort: '5122'
      HealthCheckProtocol: HTTP
      HealthCheckTimeoutSeconds: 2
      Port: 5122
      Protocol: TCP
      Tags:
        - Key: Name
          Value: RestateBYOC/one-az/node-shared-target
      TargetType: ip
      VpcId:
        'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcA2121C384D1B3CDE'
  oneazcontrollertaskroleBDE4B7AC:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
        Version: '2012-10-17'
  oneazcontrollertaskroleDefaultPolicyE5418FA5:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 'ecs:ListTasks'
              - 'ecs:DescribeTasks'
              - 'ecs:StopTask'
            Condition:
              ArnEquals:
                'ecs:cluster':
                  'Fn::GetAtt':
                    - oneazcluster64058501
                    - Arn
            Effect: Allow
            Resource: '*'
            Sid: TaskActions
          - Action: 'ecs:TagResource'
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'Fn::Join':
                      - /
                      - - 'Fn::Join':
                            - ':'
                            - - 'Fn::Select':
                                  - 0
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - oneazcluster64058501
                                                  - Arn
                              - 'Fn::Select':
                                  - 1
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - oneazcluster64058501
                                                  - Arn
                              - 'Fn::Select':
                                  - 2
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - oneazcluster64058501
                                                  - Arn
                              - 'Fn::Select':
                                  - 3
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - oneazcluster64058501
                                                  - Arn
                              - 'Fn::Select':
                                  - 4
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - oneazcluster64058501
                                                  - Arn
                              - task
                        - 'Fn::Select':
                            - 1
                            - 'Fn::Split':
                                - /
                                - 'Fn::GetAtt':
                                    - oneazcluster64058501
                                    - Arn
                        - ''
                  - '*'
            Sid: TagTasks
          - Action: 'ecs:RunTask'
            Condition:
              ArnEquals:
                'ecs:cluster':
                  'Fn::GetAtt':
                    - oneazcluster64058501
                    - Arn
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'Fn::Join':
                      - ':'
                      - - 'Fn::Select':
                            - 0
                            - 'Fn::Split':
                                - ':'
                                - Ref: oneazstatefuldefinition8395A3A6
                        - 'Fn::Select':
                            - 1
                            - 'Fn::Split':
                                - ':'
                                - Ref: oneazstatefuldefinition8395A3A6
                        - 'Fn::Select':
                            - 2
                            - 'Fn::Split':
                                - ':'
                                - Ref: oneazstatefuldefinition8395A3A6
                        - 'Fn::Select':
                            - 3
                            - 'Fn::Split':
                                - ':'
                                - Ref: oneazstatefuldefinition8395A3A6
                        - 'Fn::Select':
                            - 4
                            - 'Fn::Split':
                                - ':'
                                - Ref: oneazstatefuldefinition8395A3A6
                        - 'Fn::Select':
                            - 5
                            - 'Fn::Split':
                                - ':'
                                - Ref: oneazstatefuldefinition8395A3A6
                  - ':*'
            Sid: RunTask
          - Action: 'iam:PassRole'
            Condition:
              StringEquals:
                'iam:PassedToService': ecs-tasks.amazonaws.com
            Effect: Allow
            Resource:
              - 'Fn::GetAtt':
                  - oneazrestatetaskroleED26DCA9
                  - Arn
              - 'Fn::GetAtt':
                  - oneazrestateexecutionrole28BB1A47
                  - Arn
            Sid: RunTaskPassRole
          - Action:
              - 's3:GetObject'
              - 's3:PutObject'
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'Fn::GetAtt':
                      - oneazbucket84454759
                      - Arn
                  - /*
            Sid: ReadWriteBucket
          - Action: 's3:ListBucket'
            Effect: Allow
            Resource:
              'Fn::GetAtt':
                - oneazbucket84454759
                - Arn
            Sid: ListBucket
        Version: '2012-10-17'
      PolicyName: oneazcontrollertaskroleDefaultPolicyE5418FA5
      Roles:
        - Ref: oneazcontrollertaskroleBDE4B7AC
  oneazcontrollerexecutionrole0484C60A:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
        Version: '2012-10-17'
  oneazcontrollerexecutionroleDefaultPolicy4AFAAA9F:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 'logs:CreateLogStream'
              - 'logs:PutLogEvents'
            Effect: Allow
            Resource:
              'Fn::GetAtt':
                - oneazcontrollerdefinitioncontrollerLogGroup0F18651A
                - Arn
        Version: '2012-10-17'
      PolicyName: oneazcontrollerexecutionroleDefaultPolicy4AFAAA9F
      Roles:
        - Ref: oneazcontrollerexecutionrole0484C60A
  oneazcontrollerdefinition4A9153FC:
    Type: 'AWS::ECS::TaskDefinition'
    Properties:
      ContainerDefinitions:
        - Cpu: 1024
          Environment:
            - Name: RUST_LOG
              Value: 'info,restate_fargate_controller=debug'
            - Name: CONTROLLER_LOG_FORMAT
              Value: json
            - Name: CONTROLLER_METADATA_PATH
              Value:
                'Fn::Join':
                  - ''
                  - - 's3://'
                    - Ref: oneazbucket84454759
                    - /metadata
            - Name: CONTROLLER_RECONCILE_INTERVAL
              Value: 10s
            - Name: CONTROLLER_CLUSTER__CLUSTER_ARN
              Value:
                'Fn::GetAtt':
                  - oneazcluster64058501
                  - Arn
            - Name: CONTROLLER_LICENSE_ID
              Value: foo
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __REGION
              Value:
                Ref: 'AWS::Region'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __CLUSTER_ARN
              Value:
                'Fn::GetAtt':
                  - oneazcluster64058501
                  - Arn
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __TASK_PREFIX
              Value:
                'Fn::Join':
                  - /
                  - - 'Fn::Join':
                        - ':'
                        - - 'Fn::Select':
                              - 0
                              - 'Fn::Split':
                                  - ':'
                                  - 'Fn::Select':
                                      - 0
                                      - 'Fn::Split':
                                          - /
                                          - 'Fn::GetAtt':
                                              - oneazcluster64058501
                                              - Arn
                          - 'Fn::Select':
                              - 1
                              - 'Fn::Split':
                                  - ':'
                                  - 'Fn::Select':
                                      - 0
                                      - 'Fn::Split':
                                          - /
                                          - 'Fn::GetAtt':
                                              - oneazcluster64058501
                                              - Arn
                          - 'Fn::Select':
                              - 2
                              - 'Fn::Split':
                                  - ':'
                                  - 'Fn::Select':
                                      - 0
                                      - 'Fn::Split':
                                          - /
                                          - 'Fn::GetAtt':
                                              - oneazcluster64058501
                                              - Arn
                          - 'Fn::Select':
                              - 3
                              - 'Fn::Split':
                                  - ':'
                                  - 'Fn::Select':
                                      - 0
                                      - 'Fn::Split':
                                          - /
                                          - 'Fn::GetAtt':
                                              - oneazcluster64058501
                                              - Arn
                          - 'Fn::Select':
                              - 4
                              - 'Fn::Split':
                                  - ':'
                                  - 'Fn::Select':
                                      - 0
                                      - 'Fn::Split':
                                          - /
                                          - 'Fn::GetAtt':
                                              - oneazcluster64058501
                                              - Arn
                          - task
                    - 'Fn::Select':
                        - 1
                        - 'Fn::Split':
                            - /
                            - 'Fn::GetAtt':
                                - oneazcluster64058501
                                - Arn
                    - ''
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1a__ENABLE_EXECUTE_COMMAND
              Value: 'false'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1a__SECURITY_GROUPS
              Value:
                'Fn::Join':
                  - ''
                  - - '["'
                    - 'Fn::GetAtt':
                        - oneazsecuritygroup3EBC43A7
                        - GroupId
                    - '"]'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1a__SUBNETS
              Value:
                'Fn::Join':
                  - ''
                  - - '["'
                    - 'Fn::ImportValue': >-
                        VPCStack:ExportsOutputRefvpcPrivateSubnet1Subnet934893E8236E2271
                    - '"]'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1a__TASK_DEFINITION_ARN
              Value:
                Ref: oneazstatefuldefinition8395A3A6
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1a__COUNT
              Value: '1'
          Essential: true
          HealthCheck:
            Command:
              - CMD
              - curl
              - '--fail'
              - 'http://127.0.0.1:8080/health'
            Interval: 30
            Retries: 10
            StartPeriod: 300
            Timeout: 5
          Image: Any<Object>
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group:
                Ref: oneazcontrollerdefinitioncontrollerLogGroup0F18651A
              awslogs-stream-prefix: controller
              awslogs-region: region
          Memory: 2048
          Name: controller
          StopTimeout: 120
      Cpu: '1024'
      ExecutionRoleArn:
        'Fn::GetAtt':
          - oneazcontrollerexecutionrole0484C60A
          - Arn
      Family: RestateBYOConeazcontrollerdefinition8E758A24
      Memory: '2048'
      NetworkMode: awsvpc
      RequiresCompatibilities:
        - FARGATE
      RuntimePlatform:
        CpuArchitecture: ARM64
        OperatingSystemFamily: LINUX
      Tags:
        - Key: Name
          Value: RestateBYOC/one-az/controller-definition
      TaskRoleArn:
        'Fn::GetAtt':
          - oneazcontrollertaskroleBDE4B7AC
          - Arn
  oneazcontrollerdefinitioncontrollerLogGroup0F18651A:
    Type: 'AWS::Logs::LogGroup'
    Properties:
      Tags:
        - Key: Name
          Value: RestateBYOC/one-az/controller-definition
    UpdateReplacePolicy: Retain
    DeletionPolicy: Retain
  oneazcontrollerserviceService687CA4B7:
    Type: 'AWS::ECS::Service'
    Properties:
      Cluster:
        Ref: oneazcluster64058501
      DeploymentConfiguration:
        Alarms:
          AlarmNames: []
          Enable: false
          Rollback: false
        MaximumPercent: 100
        MinimumHealthyPercent: 0
      DesiredCount: 1
      EnableECSManagedTags: false
      EnableExecuteCommand: false
      LaunchType: FARGATE
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: DISABLED
          SecurityGroups:
            - 'Fn::GetAtt':
                - oneazsecuritygroup3EBC43A7
                - GroupId
          Subnets:
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet1Subnet934893E8236E2271'
      Tags:
        - Key: Name
          Value: RestateBYOC/one-az/controller-service
      TaskDefinition:
        Ref: oneazcontrollerdefinition4A9153FC
    DependsOn:
      - oneazcontrollertaskroleDefaultPolicyE5418FA5
      - oneazcontrollertaskroleBDE4B7AC
  oneazrestatectllambdaexecutionroleB8EEEC4E:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
        Version: '2012-10-17'
  oneazrestatectllambdaexecutionroleDefaultPolicyC1275182:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 'logs:CreateLogGroup'
              - 'logs:CreateLogStream'
              - 'logs:PutLogEvents'
              - 'ec2:CreateNetworkInterface'
              - 'ec2:DescribeNetworkInterfaces'
              - 'ec2:DescribeSubnets'
              - 'ec2:DeleteNetworkInterface'
              - 'ec2:AssignPrivateIpAddresses'
              - 'ec2:UnassignPrivateIpAddresses'
            Effect: Allow
            Resource: '*'
            Sid: AWSLambdaVPCAccessExecutionPermissions
        Version: '2012-10-17'
      PolicyName: oneazrestatectllambdaexecutionroleDefaultPolicyC1275182
      Roles:
        - Ref: oneazrestatectllambdaexecutionroleB8EEEC4E
  oneazrestatectllambdaE8A79621:
    Type: 'AWS::Lambda::Function'
    Properties:
      Architectures:
        - arm64
      Code: Any<Object>
      Environment:
        Variables:
          RESTATECTL_ADDRESS:
            'Fn::Join':
              - ''
              - - 'http://'
                - 'Fn::GetAtt':
                    - oneazsharednlb21F0A25A
                    - DNSName
                - ':5122'
      Handler: restatectl
      Role:
        'Fn::GetAtt':
          - oneazrestatectllambdaexecutionroleB8EEEC4E
          - Arn
      Runtime: provided.al2023
      Tags:
        - Key: Name
          Value: RestateBYOC/one-az/restatectl-lambda
      Timeout: 10
      VpcConfig:
        SecurityGroupIds:
          - 'Fn::GetAtt':
              - oneazsecuritygroup3EBC43A7
              - GroupId
        SubnetIds:
          - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet1Subnet934893E8236E2271'
    DependsOn:
      - oneazrestatectllambdaexecutionroleDefaultPolicyC1275182
      - oneazrestatectllambdaexecutionroleB8EEEC4E
  oneazretirementwatcherlambdaexecutionrole56B4A63B:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
        Version: '2012-10-17'
  oneazretirementwatcherlambdaexecutionroleDefaultPolicy8CBE0045:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 'logs:CreateLogGroup'
              - 'logs:CreateLogStream'
              - 'logs:PutLogEvents'
            Effect: Allow
            Resource: '*'
            Sid: AWSLambdaBasicExecutionPermissions
          - Action: 'ecs:TagResource'
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'Fn::Join':
                      - /
                      - - 'Fn::Join':
                            - ':'
                            - - 'Fn::Select':
                                  - 0
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - oneazcluster64058501
                                                  - Arn
                              - 'Fn::Select':
                                  - 1
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - oneazcluster64058501
                                                  - Arn
                              - 'Fn::Select':
                                  - 2
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - oneazcluster64058501
                                                  - Arn
                              - 'Fn::Select':
                                  - 3
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - oneazcluster64058501
                                                  - Arn
                              - 'Fn::Select':
                                  - 4
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - oneazcluster64058501
                                                  - Arn
                              - task
                        - 'Fn::Select':
                            - 1
                            - 'Fn::Split':
                                - /
                                - 'Fn::GetAtt':
                                    - oneazcluster64058501
                                    - Arn
                        - ''
                  - '*'
            Sid: TagTasks
          - Action:
              - 'sqs:ReceiveMessage'
              - 'sqs:ChangeMessageVisibility'
              - 'sqs:GetQueueUrl'
              - 'sqs:DeleteMessage'
              - 'sqs:GetQueueAttributes'
            Effect: Allow
            Resource:
              'Fn::GetAtt':
                - oneazretirementwatcherqueue042F1856
                - Arn
        Version: '2012-10-17'
      PolicyName: oneazretirementwatcherlambdaexecutionroleDefaultPolicy8CBE0045
      Roles:
        - Ref: oneazretirementwatcherlambdaexecutionrole56B4A63B
  oneazretirementwatcherlambdaEF1C1730:
    Type: 'AWS::Lambda::Function'
    Properties:
      Architectures:
        - arm64
      Code: Any<Object>
      Handler: index.handler
      Role:
        'Fn::GetAtt':
          - oneazretirementwatcherlambdaexecutionrole56B4A63B
          - Arn
      Runtime: nodejs22.x
      Tags:
        - Key: Name
          Value: RestateBYOC/one-az/retirement-watcher-lambda
      Timeout: 60
    DependsOn:
      - oneazretirementwatcherlambdaexecutionroleDefaultPolicy8CBE0045
      - oneazretirementwatcherlambdaexecutionrole56B4A63B
  oneazretirementwatcherlambdaSqsEventSourceRestateBYOConeazretirementwatcherqueue592872342954F75A:
    Type: 'AWS::Lambda::EventSourceMapping'
    Properties:
      BatchSize: 1
      EventSourceArn:
        'Fn::GetAtt':
          - oneazretirementwatcherqueue042F1856
          - Arn
      FunctionName:
        Ref: oneazretirementwatcherlambdaEF1C1730
      Tags:
        - Key: Name
          Value: RestateBYOC/one-az/retirement-watcher-lambda
  oneazretirementwatcherqueue042F1856:
    Type: 'AWS::SQS::Queue'
    Properties:
      Tags:
        - Key: Name
          Value: RestateBYOC/one-az/retirement-watcher-queue
      VisibilityTimeout: 60
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  oneazretirementwatcherqueuePolicy0BB90DBC:
    Type: 'AWS::SQS::QueuePolicy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 'sqs:SendMessage'
              - 'sqs:GetQueueAttributes'
              - 'sqs:GetQueueUrl'
            Condition:
              ArnEquals:
                'aws:SourceArn':
                  'Fn::GetAtt':
                    - oneazretirementwatcherrule5E911FA0
                    - Arn
            Effect: Allow
            Principal:
              Service: events.amazonaws.com
            Resource:
              'Fn::GetAtt':
                - oneazretirementwatcherqueue042F1856
                - Arn
        Version: '2012-10-17'
      Queues:
        - Ref: oneazretirementwatcherqueue042F1856
  oneazretirementwatcherrule5E911FA0:
    Type: 'AWS::Events::Rule'
    Properties:
      EventPattern:
        detail:
          eventTypeCode:
            - equals-ignore-case: AWS_ECS_TASK_PATCHING_RETIREMENT
          service:
            - equals-ignore-case: ecs
        resources:
          - prefix:
              'Fn::Join':
                - /
                - - 'Fn::Join':
                      - ':'
                      - - 'Fn::Select':
                            - 0
                            - 'Fn::Split':
                                - ':'
                                - 'Fn::Select':
                                    - 0
                                    - 'Fn::Split':
                                        - /
                                        - 'Fn::GetAtt':
                                            - oneazcluster64058501
                                            - Arn
                        - 'Fn::Select':
                            - 1
                            - 'Fn::Split':
                                - ':'
                                - 'Fn::Select':
                                    - 0
                                    - 'Fn::Split':
                                        - /
                                        - 'Fn::GetAtt':
                                            - oneazcluster64058501
                                            - Arn
                        - 'Fn::Select':
                            - 2
                            - 'Fn::Split':
                                - ':'
                                - 'Fn::Select':
                                    - 0
                                    - 'Fn::Split':
                                        - /
                                        - 'Fn::GetAtt':
                                            - oneazcluster64058501
                                            - Arn
                        - 'Fn::Select':
                            - 3
                            - 'Fn::Split':
                                - ':'
                                - 'Fn::Select':
                                    - 0
                                    - 'Fn::Split':
                                        - /
                                        - 'Fn::GetAtt':
                                            - oneazcluster64058501
                                            - Arn
                        - 'Fn::Select':
                            - 4
                            - 'Fn::Split':
                                - ':'
                                - 'Fn::Select':
                                    - 0
                                    - 'Fn::Split':
                                        - /
                                        - 'Fn::GetAtt':
                                            - oneazcluster64058501
                                            - Arn
                        - task
                  - 'Fn::Select':
                      - 1
                      - 'Fn::Split':
                          - /
                          - 'Fn::GetAtt':
                              - oneazcluster64058501
                              - Arn
                  - ''
        detail-type:
          - equals-ignore-case: AWS Health Event
      State: ENABLED
      Targets:
        - Arn:
            'Fn::GetAtt':
              - oneazretirementwatcherqueue042F1856
              - Arn
          Id: Target0
  oneazcloudwatchcustomwidgetexecutionroleE86BBDF1:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
        Version: '2012-10-17'
  oneazcloudwatchcustomwidgetexecutionroleDefaultPolicy42B10BFD:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 'logs:CreateLogGroup'
              - 'logs:CreateLogStream'
              - 'logs:PutLogEvents'
            Effect: Allow
            Resource: '*'
            Sid: AWSLambdaBasicExecutionPermissions
          - Action: 'lambda:InvokeFunction'
            Effect: Allow
            Resource:
              'Fn::GetAtt':
                - oneazrestatectllambdaE8A79621
                - Arn
            Sid: InvokeRestatectl
          - Action:
              - 'ec2:DescribeVolumes'
              - 'ec2:DescribeVolumeStatus'
            Effect: Allow
            Resource: '*'
            Sid: EC2ReadActions
          - Action: 'ecs:DescribeTaskDefinition'
            Effect: Allow
            Resource: '*'
            Sid: ECSReadActions
          - Action: 'ecs:ListTasks'
            Condition:
              StringEquals:
                'ecs:cluster':
                  'Fn::GetAtt':
                    - oneazcluster64058501
                    - Arn
            Effect: Allow
            Resource: '*'
            Sid: ECSListTasks
          - Action: 'ecs:DescribeTasks'
            Condition:
              StringEquals:
                'ecs:cluster':
                  'Fn::GetAtt':
                    - oneazcluster64058501
                    - Arn
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'arn:'
                  - Ref: 'AWS::Partition'
                  - ':ecs:'
                  - Ref: 'AWS::Region'
                  - ':'
                  - Ref: 'AWS::AccountId'
                  - ':task/'
                  - Ref: oneazcluster64058501
                  - /*
            Sid: ECSDescribeTasks
          - Action: 'ecs:DescribeServices'
            Condition:
              StringEquals:
                'ecs:cluster':
                  'Fn::GetAtt':
                    - oneazcluster64058501
                    - Arn
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'arn:'
                  - Ref: 'AWS::Partition'
                  - ':ecs:'
                  - Ref: 'AWS::Region'
                  - ':'
                  - Ref: 'AWS::AccountId'
                  - ':service/'
                  - Ref: oneazcluster64058501
                  - /*
            Sid: ECSDescribeServices
          - Action: 'cloudwatch:GetMetricData'
            Effect: Allow
            Resource: '*'
            Sid: CloudWatchReadActions
        Version: '2012-10-17'
      PolicyName: oneazcloudwatchcustomwidgetexecutionroleDefaultPolicy42B10BFD
      Roles:
        - Ref: oneazcloudwatchcustomwidgetexecutionroleE86BBDF1
  oneazcloudwatchcustomwidgetlambdaC77CF452:
    Type: 'AWS::Lambda::Function'
    Properties:
      Architectures:
        - arm64
      Code: Any<Object>
      Handler: index.handler
      MemorySize: 1024
      Role:
        'Fn::GetAtt':
          - oneazcloudwatchcustomwidgetexecutionroleE86BBDF1
          - Arn
      Runtime: nodejs22.x
      Tags:
        - Key: Name
          Value: RestateBYOC/one-az/cloudwatch-custom-widget-lambda
      Timeout: 60
    DependsOn:
      - oneazcloudwatchcustomwidgetexecutionroleDefaultPolicy42B10BFD
      - oneazcloudwatchcustomwidgetexecutionroleE86BBDF1
  oneazcloudwatchcustomwidgetlambdacloudwatchcustomwidgetlambdaallowdatasource3D12003C:
    Type: 'AWS::Lambda::Permission'
    Properties:
      Action: 'lambda:InvokeFunction'
      FunctionName:
        'Fn::GetAtt':
          - oneazcloudwatchcustomwidgetlambdaC77CF452
          - Arn
      Principal: lambda.datasource.cloudwatch.amazonaws.com
  oneazmetrics14A011A9:
    Type: 'AWS::CloudWatch::Dashboard'
    Properties:
      DashboardBody:
        'Fn::Join':
          - ''
          - - >-
              {"widgets":[{"type":"metric","width":12,"height":6,"x":0,"y":0,"properties":{"view":"timeSeries","title":"Stateless
              CPU","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"CPU","expression":"cpu /
              1024"}],[{"expression":"SELECT AVG(CpuUtilized) FROM
              SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOConeazstatelessdefinition6087330A' GROUP BY
              TaskId","visible":false,"id":"cpu"}]],"annotations":{"horizontal":[{"value":16,"label":"Limit","yAxis":"left"}]},"yAxis":{"left":{"label":"vCPUs","showUnits":false}}}},{"type":"metric","width":12,"height":6,"x":12,"y":0,"properties":{"view":"timeSeries","title":"Stateless
              Memory","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Memory","expression":"memory /
              1024"}],[{"expression":"SELECT AVG(MemoryUtilized) FROM
              SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOConeazstatelessdefinition6087330A' GROUP BY
              TaskId","visible":false,"id":"memory"}]],"annotations":{"horizontal":[{"value":32,"label":"Limit","yAxis":"left"}]},"yAxis":{"left":{"label":"GiB","showUnits":false}}}},{"type":"metric","width":12,"height":6,"x":0,"y":6,"properties":{"view":"timeSeries","title":"Stateless
              Network Tx","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Tx","expression":"SELECT
              AVG(NetworkTxBytes) FROM SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOConeazstatelessdefinition6087330A' GROUP BY
              TaskId"}]],"yAxis":{"left":{"label":"Bytes/sec","showUnits":false}}}},{"type":"metric","width":12,"height":6,"x":12,"y":6,"properties":{"view":"timeSeries","title":"Stateless
              Network Rx","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Rx","expression":"SELECT
              AVG(NetworkRxBytes) FROM SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOConeazstatelessdefinition6087330A' GROUP BY
              TaskId"}]],"yAxis":{"left":{"label":"Bytes/sec","showUnits":false}}}},{"type":"log","width":24,"height":6,"x":0,"y":12,"properties":{"view":"table","title":"Stateless
              Logs","region":"region","query":"SOURCE '
            - Ref: oneazstatelessdefinitionrestateLogGroup43B4F616
            - >-
              ' | fields @logStream, @timestamp, level, fields.message,
              target\\n          | sort @timestamp desc\\n          | limit
              500"}},{"type":"metric","width":12,"height":6,"x":0,"y":18,"properties":{"view":"timeSeries","title":"Stateful
              CPU","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"CPU","expression":"cpu /
              1024"}],[{"expression":"SELECT AVG(CpuUtilized) FROM
              SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOConeazstatefuldefinition17638845' GROUP BY
              TaskId","visible":false,"id":"cpu"}]],"annotations":{"horizontal":[{"value":16,"label":"Limit","yAxis":"left"}]},"yAxis":{"left":{"label":"vCPUs","showUnits":false}}}},{"type":"metric","width":12,"height":6,"x":12,"y":18,"properties":{"view":"timeSeries","title":"Stateful
              Memory","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Memory","expression":"memory /
              1024"}],[{"expression":"SELECT AVG(MemoryUtilized) FROM
              SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOConeazstatefuldefinition17638845' GROUP BY
              TaskId","visible":false,"id":"memory"}]],"annotations":{"horizontal":[{"value":32,"label":"Limit","yAxis":"left"}]},"yAxis":{"left":{"label":"GiB","showUnits":false}}}},{"type":"metric","width":12,"height":6,"x":0,"y":24,"properties":{"view":"timeSeries","title":"Stateful
              Network Tx","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Tx","expression":"SELECT
              AVG(NetworkTxBytes) FROM SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOConeazstatefuldefinition17638845' GROUP BY
              TaskId"}]],"yAxis":{"left":{"label":"Bytes/sec","showUnits":false}}}},{"type":"metric","width":12,"height":6,"x":12,"y":24,"properties":{"view":"timeSeries","title":"Stateful
              Network Rx","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Rx","expression":"SELECT
              AVG(NetworkRxBytes) FROM SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOConeazstatefuldefinition17638845' GROUP BY
              TaskId"}]],"yAxis":{"left":{"label":"Bytes/sec","showUnits":false}}}},{"type":"log","width":24,"height":6,"x":0,"y":30,"properties":{"view":"table","title":"Stateful
              Logs","region":"region","query":"SOURCE '
            - Ref: oneazstatefuldefinitionrestateLogGroupB1728FF3
            - >-
              ' | fields @logStream, @timestamp, level, fields.message,
              target\\n          | sort @timestamp desc\\n          | limit
              500"}},{"type":"metric","width":8,"height":6,"x":0,"y":36,"properties":{"view":"timeSeries","title":"Ephemeral
              Volume Usage (Total size 200GiB)","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Usage","expression":"SELECT
              MAX(EphemeralStorageUtilized) FROM
              SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily) WHERE TaskDefinitionFamily =
              'RestateBYOConeazstatefuldefinition17638845'"}]],"annotations":{"horizontal":[{"value":200,"label":"Volume
              size","visible":false,"yAxis":"left"}]},"yAxis":{"left":{"label":"GiB","showUnits":false}},"liveData":false}},{"type":"metric","width":8,"height":6,"x":8,"y":36,"properties":{"view":"timeSeries","title":"Volume
              Write Throughput (Limited to 150 MiB/sec)","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Write","expression":"RATE(count) /
              1048576"}],[{"expression":"SELECT MAX(StorageWriteBytes) FROM
              SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOConeazstatefuldefinition17638845' GROUP BY
              TaskId","visible":false,"id":"count"}]],"annotations":{"horizontal":[{"value":150,"label":"Limit","visible":false,"yAxis":"left"}]},"yAxis":{"left":{"label":"MiB/sec","showUnits":false}}}},{"type":"metric","width":8,"height":6,"x":16,"y":36,"properties":{"view":"timeSeries","title":"Volume
              Read Throughput (Limited to 150 MiB/sec)","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Read","expression":"RATE(count) /
              1048576"}],[{"expression":"SELECT MAX(StorageReadBytes) FROM
              SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOConeazstatefuldefinition17638845' GROUP BY
              TaskId","visible":false,"id":"count"}]],"annotations":{"horizontal":[{"value":150,"label":"Limit","visible":false,"yAxis":"left"}]},"yAxis":{"left":{"label":"MiB/sec","showUnits":false}}}},{"type":"log","width":24,"height":6,"x":0,"y":42,"properties":{"view":"table","title":"Controller
              Logs","region":"region","query":"SOURCE '
            - Ref: oneazcontrollerdefinitioncontrollerLogGroup0F18651A
            - >-
              ' | fields @logStream, @timestamp, level, fields.message,
              target\\n          | sort @timestamp desc\\n          | limit
              500"}}]}
      DashboardName: RestateBYOC_one-az_metrics
  oneazcontrolpanel43160428:
    Type: 'AWS::CloudWatch::Dashboard'
    Properties:
      DashboardBody:
        'Fn::Join':
          - ''
          - - >-
              {"widgets":[{"type":"custom","width":24,"height":26,"x":0,"y":0,"properties":{"endpoint":"
            - 'Fn::GetAtt':
                - oneazcloudwatchcustomwidgetlambdaC77CF452
                - Arn
            - '","params":{"command":"controlPanel","input":{"region":"'
            - Ref: 'AWS::Region'
            - >-
              ","summary":{"clusterName":"RestateBYOC/one-az","restateVersion":"1.3","stackVersion":"0.2.0","metricsDashboardName":"
            - Ref: oneazmetrics14A011A9
            - '"},"resources":{"ecsClusterArn":"'
            - 'Fn::GetAtt':
                - oneazcluster64058501
                - Arn
            - '","statelessServiceArn":"'
            - Ref: oneazstatelessserviceServiceB8B226F2
            - '","controllerServiceArn":"'
            - Ref: oneazcontrollerserviceService687CA4B7
            - '","restatectlLambdaArn":"'
            - 'Fn::GetAtt':
                - oneazrestatectllambdaE8A79621
                - Arn
            - >-
              "},"connectivityAndSecurity":{"connectivity":{"loadBalancerArns":{"ingress":["
            - Ref: oneazsharednlb21F0A25A
            - '"],"admin":["'
            - Ref: oneazsharednlb21F0A25A
            - '"]},"addresses":{"ingress":"http://'
            - 'Fn::GetAtt':
                - oneazsharednlb21F0A25A
                - DNSName
            - ':8080","admin":"http://'
            - 'Fn::GetAtt':
                - oneazsharednlb21F0A25A
                - DNSName
            - ':9070","webUI":"http://'
            - 'Fn::GetAtt':
                - oneazsharednlb21F0A25A
                - DNSName
            - ':9070/ui"}},"networking":{"vpc":"'
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcA2121C384D1B3CDE'
            - '","availabilityZones":["dummy1a"],"subnets":["'
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet1Subnet934893E8236E2271'
            - '"]},"security":{"securityGroups":["'
            - 'Fn::GetAtt':
                - oneazsecuritygroup3EBC43A7
                - GroupId
            - '"]}},"storage":{"s3":{"bucket":"'
            - Ref: oneazbucket84454759
            - >-
              "}}}},"title":"","updateOn":{"refresh":true,"resize":true,"timeRange":true}}}]}
      DashboardName: RestateBYOC_one-az_control-panel
  oneazservicedeployerlambdaexecutionroleBCB2D253:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
        Version: '2012-10-17'
  oneazservicedeployerlambdaexecutionroleDefaultPolicy6F5E3F27:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 'logs:CreateLogGroup'
              - 'logs:CreateLogStream'
              - 'logs:PutLogEvents'
              - 'ec2:CreateNetworkInterface'
              - 'ec2:DescribeNetworkInterfaces'
              - 'ec2:DescribeSubnets'
              - 'ec2:DeleteNetworkInterface'
              - 'ec2:AssignPrivateIpAddresses'
              - 'ec2:UnassignPrivateIpAddresses'
            Effect: Allow
            Resource: '*'
            Sid: AWSLambdaVPCAccessExecutionPermissions
        Version: '2012-10-17'
      PolicyName: oneazservicedeployerlambdaexecutionroleDefaultPolicy6F5E3F27
      Roles:
        - Ref: oneazservicedeployerlambdaexecutionroleBCB2D253
  oneazservicedeployerEventHandler6219458C:
    Type: 'AWS::Lambda::Function'
    Properties:
      Architectures:
        - arm64
      Code: Any<Object>
      Description: Restate custom registration handler
      Environment:
        Variables:
          NODE_OPTIONS: '--enable-source-maps'
      Handler: entrypoint.handler
      MemorySize: 128
      Role:
        'Fn::GetAtt':
          - oneazservicedeployerlambdaexecutionroleBCB2D253
          - Arn
      Runtime: nodejs22.x
      Timeout: 180
      VpcConfig:
        SecurityGroupIds:
          - 'Fn::GetAtt':
              - oneazsecuritygroup3EBC43A7
              - GroupId
        SubnetIds:
          - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet1Subnet934893E8236E2271'
    DependsOn:
      - oneazservicedeployerlambdaexecutionroleDefaultPolicy6F5E3F27
      - oneazservicedeployerlambdaexecutionroleBCB2D253
  oneazservicedeployerDeploymentLogs843ED89D:
    Type: 'AWS::Logs::LogGroup'
    Properties:
      LogGroupName:
        'Fn::Join':
          - ''
          - - /aws/lambda/
            - Ref: oneazservicedeployerEventHandler6219458C
      RetentionInDays: 30
    UpdateReplacePolicy: Retain
    DeletionPolicy: RetainExceptOnCreate
"
`;

exports[`BYOC With shared alb 1`] = `
"Resources:
  withsharedalbsecuritygroup764E6947:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      GroupDescription: RestateBYOC/with-shared-alb/security-group
      SecurityGroupEgress:
        - CidrIp: 0.0.0.0/0
          Description: Allow all outbound traffic by default
          IpProtocol: '-1'
      Tags:
        - Key: Name
          Value: RestateBYOC/with-shared-alb/security-group
      VpcId:
        'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcA2121C384D1B3CDE'
  withsharedalbsecuritygroupfromRestateBYOCwithsharedalbsecuritygroup28468EAF8080ACDBC509:
    Type: 'AWS::EC2::SecurityGroupIngress'
    Properties:
      Description: 'from RestateBYOCwithsharedalbsecuritygroup28468EAF:8080'
      FromPort: 8080
      GroupId:
        'Fn::GetAtt':
          - withsharedalbsecuritygroup764E6947
          - GroupId
      IpProtocol: tcp
      SourceSecurityGroupId:
        'Fn::GetAtt':
          - withsharedalbsecuritygroup764E6947
          - GroupId
      ToPort: 8080
  withsharedalbsecuritygroupfromRestateBYOCwithsharedalbsecuritygroup28468EAF90704E57034E:
    Type: 'AWS::EC2::SecurityGroupIngress'
    Properties:
      Description: 'from RestateBYOCwithsharedalbsecuritygroup28468EAF:9070'
      FromPort: 9070
      GroupId:
        'Fn::GetAtt':
          - withsharedalbsecuritygroup764E6947
          - GroupId
      IpProtocol: tcp
      SourceSecurityGroupId:
        'Fn::GetAtt':
          - withsharedalbsecuritygroup764E6947
          - GroupId
      ToPort: 9070
  withsharedalbsecuritygroupfromRestateBYOCwithsharedalbsecuritygroup28468EAF51222F095694:
    Type: 'AWS::EC2::SecurityGroupIngress'
    Properties:
      Description: 'from RestateBYOCwithsharedalbsecuritygroup28468EAF:5122'
      FromPort: 5122
      GroupId:
        'Fn::GetAtt':
          - withsharedalbsecuritygroup764E6947
          - GroupId
      IpProtocol: tcp
      SourceSecurityGroupId:
        'Fn::GetAtt':
          - withsharedalbsecuritygroup764E6947
          - GroupId
      ToPort: 5122
  withsharedalbsecuritygroupfromRestateBYOCwithsharedalbSecurityGroup800C83328080E578C2A6:
    Type: 'AWS::EC2::SecurityGroupIngress'
    Properties:
      Description: Load balancer to target
      FromPort: 8080
      GroupId:
        'Fn::GetAtt':
          - withsharedalbsecuritygroup764E6947
          - GroupId
      IpProtocol: tcp
      SourceSecurityGroupId:
        'Fn::GetAtt':
          - withsharedalbSecurityGroup58DDD13B
          - GroupId
      ToPort: 8080
  withsharedalbsecuritygroupfromRestateBYOCwithsharedalbSecurityGroup800C8332907086EEBE43:
    Type: 'AWS::EC2::SecurityGroupIngress'
    Properties:
      Description: Load balancer to target
      FromPort: 9070
      GroupId:
        'Fn::GetAtt':
          - withsharedalbsecuritygroup764E6947
          - GroupId
      IpProtocol: tcp
      SourceSecurityGroupId:
        'Fn::GetAtt':
          - withsharedalbSecurityGroup58DDD13B
          - GroupId
      ToPort: 9070
  withsharedalbsecuritygroupfromRestateBYOCwithsharedalbSecurityGroup800C83325122AFC3E8E4:
    Type: 'AWS::EC2::SecurityGroupIngress'
    Properties:
      Description: Load balancer to target
      FromPort: 5122
      GroupId:
        'Fn::GetAtt':
          - withsharedalbsecuritygroup764E6947
          - GroupId
      IpProtocol: tcp
      SourceSecurityGroupId:
        'Fn::GetAtt':
          - withsharedalbSecurityGroup58DDD13B
          - GroupId
      ToPort: 5122
  withsharedalbbucket0B158E57:
    Type: 'AWS::S3::Bucket'
    Properties:
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
    UpdateReplacePolicy: Retain
    DeletionPolicy: Retain
  withsharedalbbucketPolicy40D4255E:
    Type: 'AWS::S3::BucketPolicy'
    Properties:
      Bucket:
        Ref: withsharedalbbucket0B158E57
      PolicyDocument:
        Statement:
          - Action: 's3:*'
            Condition:
              Bool:
                'aws:SecureTransport': 'false'
            Effect: Deny
            Principal:
              AWS: '*'
            Resource:
              - 'Fn::GetAtt':
                  - withsharedalbbucket0B158E57
                  - Arn
              - 'Fn::Join':
                  - ''
                  - - 'Fn::GetAtt':
                        - withsharedalbbucket0B158E57
                        - Arn
                    - /*
        Version: '2012-10-17'
  withsharedalbclusterC111A9F9:
    Type: 'AWS::ECS::Cluster'
    Properties:
      ClusterSettings:
        - Name: containerInsights
          Value: enhanced
      Tags:
        - Key: Name
          Value: RestateBYOC/with-shared-alb/cluster
  withsharedalbrestatetaskroleDE0CA1F2:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
        Version: '2012-10-17'
  withsharedalbrestatetaskroleDefaultPolicy3C4A4214:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 's3:GetObject'
              - 's3:PutObject'
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'Fn::GetAtt':
                      - withsharedalbbucket0B158E57
                      - Arn
                  - /*
            Sid: ReadWriteBucket
          - Action: 's3:ListBucket'
            Effect: Allow
            Resource:
              'Fn::GetAtt':
                - withsharedalbbucket0B158E57
                - Arn
            Sid: ListBucket
        Version: '2012-10-17'
      PolicyName: withsharedalbrestatetaskroleDefaultPolicy3C4A4214
      Roles:
        - Ref: withsharedalbrestatetaskroleDE0CA1F2
  withsharedalbrestateexecutionroleBA9578BE:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
        Version: '2012-10-17'
  withsharedalbrestateexecutionroleDefaultPolicyA58ABF43:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 'logs:CreateLogStream'
              - 'logs:PutLogEvents'
            Effect: Allow
            Resource:
              'Fn::GetAtt':
                - withsharedalbstatelessdefinitionrestateLogGroup1AEC0F29
                - Arn
          - Action:
              - 'logs:CreateLogStream'
              - 'logs:PutLogEvents'
            Effect: Allow
            Resource:
              'Fn::GetAtt':
                - withsharedalbstatefuldefinitionrestateLogGroup5BDDBA7D
                - Arn
        Version: '2012-10-17'
      PolicyName: withsharedalbrestateexecutionroleDefaultPolicyA58ABF43
      Roles:
        - Ref: withsharedalbrestateexecutionroleBA9578BE
  withsharedalb7F233835:
    Type: 'AWS::ElasticLoadBalancingV2::LoadBalancer'
    Properties:
      LoadBalancerAttributes:
        - Key: deletion_protection.enabled
          Value: 'false'
      Scheme: internal
      SecurityGroups:
        - 'Fn::GetAtt':
            - withsharedalbSecurityGroup58DDD13B
            - GroupId
      Subnets:
        - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet1Subnet934893E8236E2271'
        - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet2Subnet7031C2BA60DCB1EE'
        - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet3Subnet985AC459F9514491'
      Tags:
        - Key: Name
          Value: RestateBYOC/with-shared-alb/shared-alb
      Type: application
  withsharedalbSecurityGroup58DDD13B:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      GroupDescription: >-
        Automatically created Security Group for ELB
        RestateBYOCwithsharedalb048D83D1
      SecurityGroupIngress:
        - CidrIp: 0.0.0.0/0
          Description: Allow from anyone on port 8080
          FromPort: 8080
          IpProtocol: tcp
          ToPort: 8080
        - CidrIp: 0.0.0.0/0
          Description: Allow from anyone on port 9070
          FromPort: 9070
          IpProtocol: tcp
          ToPort: 9070
        - CidrIp: 0.0.0.0/0
          Description: Allow from anyone on port 5122
          FromPort: 5122
          IpProtocol: tcp
          ToPort: 5122
      Tags:
        - Key: Name
          Value: RestateBYOC/with-shared-alb/shared-alb
      VpcId:
        'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcA2121C384D1B3CDE'
  withsharedalbSecurityGrouptoRestateBYOCwithsharedalbsecuritygroup28468EAF8080110FE4C2:
    Type: 'AWS::EC2::SecurityGroupEgress'
    Properties:
      Description: Load balancer to target
      DestinationSecurityGroupId:
        'Fn::GetAtt':
          - withsharedalbsecuritygroup764E6947
          - GroupId
      FromPort: 8080
      GroupId:
        'Fn::GetAtt':
          - withsharedalbSecurityGroup58DDD13B
          - GroupId
      IpProtocol: tcp
      ToPort: 8080
  withsharedalbSecurityGrouptoRestateBYOCwithsharedalbsecuritygroup28468EAF9070F6884DF5:
    Type: 'AWS::EC2::SecurityGroupEgress'
    Properties:
      Description: Load balancer to target
      DestinationSecurityGroupId:
        'Fn::GetAtt':
          - withsharedalbsecuritygroup764E6947
          - GroupId
      FromPort: 9070
      GroupId:
        'Fn::GetAtt':
          - withsharedalbSecurityGroup58DDD13B
          - GroupId
      IpProtocol: tcp
      ToPort: 9070
  withsharedalbSecurityGrouptoRestateBYOCwithsharedalbsecuritygroup28468EAF51220195B892:
    Type: 'AWS::EC2::SecurityGroupEgress'
    Properties:
      Description: Load balancer to target
      DestinationSecurityGroupId:
        'Fn::GetAtt':
          - withsharedalbsecuritygroup764E6947
          - GroupId
      FromPort: 5122
      GroupId:
        'Fn::GetAtt':
          - withsharedalbSecurityGroup58DDD13B
          - GroupId
      IpProtocol: tcp
      ToPort: 5122
  withsharedalbingresssharedlistenerC5DBBAEA:
    Type: 'AWS::ElasticLoadBalancingV2::Listener'
    Properties:
      DefaultActions:
        - TargetGroupArn:
            Ref: withsharedalbingresssharedtarget7AF31D75
          Type: forward
      LoadBalancerArn:
        Ref: withsharedalb7F233835
      Port: 8080
      Protocol: HTTP
  withsharedalbadminsharedlistener58F44365:
    Type: 'AWS::ElasticLoadBalancingV2::Listener'
    Properties:
      DefaultActions:
        - TargetGroupArn:
            Ref: withsharedalbadminsharedtargetEC422D18
          Type: forward
      LoadBalancerArn:
        Ref: withsharedalb7F233835
      Port: 9070
      Protocol: HTTP
  withsharedalbnodesharedlistener638EC249:
    Type: 'AWS::ElasticLoadBalancingV2::Listener'
    Properties:
      DefaultActions:
        - TargetGroupArn:
            Ref: withsharedalbnodesharedtarget238B77F4
          Type: forward
      LoadBalancerArn:
        Ref: withsharedalb7F233835
      Port: 5122
      Protocol: HTTP
  withsharedalbstatelessdefinition9EFE894B:
    Type: 'AWS::ECS::TaskDefinition'
    Properties:
      ContainerDefinitions:
        - Cpu: 16384
          EntryPoint:
            - bash
            - '-c'
            - >

              curl --no-progress-meter $ECS_CONTAINER_METADATA_URI_V4/task -o
              task-metadata && \\

              export \\
                RESTATE_NODE_NAME=$(jq -r '.TaskARN' task-metadata) \\
                RESTATE_LOCATION="$AWS_REGION.$(jq -r '.AvailabilityZone' task-metadata)" \\
                RESTATE_ADVERTISED_ADDRESS="http://$(jq -r '.Containers[0].Networks[0].IPv4Addresses[0]' task-metadata):5122"
              exec restate-server
          Environment:
            - Name: RESTATE_LOG_FORMAT
              Value: json
            - Name: RESTATE_CLUSTER_NAME
              Value: RestateBYOC/with-shared-alb
            - Name: RESTATE_ROLES
              Value: '["admin","http-ingress"]'
            - Name: RESTATE_AUTO_PROVISION
              Value: 'true'
            - Name: RESTATE_SHUTDOWN_TIMEOUT
              Value: 100s
            - Name: RESTATE_DEFAULT_NUM_PARTITIONS
              Value: '128'
            - Name: RESTATE_DEFAULT_REPLICATION
              Value: '{zone: 2}'
            - Name: RESTATE_METADATA_CLIENT__TYPE
              Value: object-store
            - Name: RESTATE_METADATA_CLIENT__PATH
              Value:
                'Fn::Join':
                  - ''
                  - - 's3://'
                    - Ref: withsharedalbbucket0B158E57
                    - /metadata
            - Name: RESTATE_BIFROST__DEFAULT_PROVIDER
              Value: replicated
            - Name: >-
                RESTATE_INGRESS__EXPERIMENTAL_FEATURE_ENABLE_SEPARATE_INGRESS_ROLE
              Value: 'true'
            - Name: RESTATE_INGRESS__ADVERTISED_INGRESS_ENDPOINT
              Value:
                'Fn::Join':
                  - ''
                  - - 'http://'
                    - 'Fn::GetAtt':
                        - withsharedalb7F233835
                        - DNSName
                    - ':8080'
            - Name: RESTATE_WORKER__SNAPSHOTS__DESTINATION
              Value:
                'Fn::Join':
                  - ''
                  - - 's3://'
                    - Ref: withsharedalbbucket0B158E57
                    - /snapshots
          Essential: true
          HealthCheck:
            Command:
              - CMD
              - curl
              - '--fail'
              - 'http://127.0.0.1:8080/restate/health'
            Interval: 30
            Retries: 3
            Timeout: 5
          Image: Any<Object>
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group:
                Ref: withsharedalbstatelessdefinitionrestateLogGroup1AEC0F29
              awslogs-stream-prefix: restate
              awslogs-region: region
          Memory: 32768
          Name: restate
          PortMappings:
            - ContainerPort: 8080
              Name: ingress
              Protocol: tcp
            - ContainerPort: 9070
              Name: admin
              Protocol: tcp
            - ContainerPort: 5122
              Name: node
              Protocol: tcp
          StopTimeout: 120
      Cpu: '16384'
      ExecutionRoleArn:
        'Fn::GetAtt':
          - withsharedalbrestateexecutionroleBA9578BE
          - Arn
      Family: RestateBYOCwithsharedalbstatelessdefinition16966423
      Memory: '32768'
      NetworkMode: awsvpc
      RequiresCompatibilities:
        - FARGATE
      RuntimePlatform:
        CpuArchitecture: ARM64
        OperatingSystemFamily: LINUX
      Tags:
        - Key: Name
          Value: RestateBYOC/with-shared-alb/stateless-definition
      TaskRoleArn:
        'Fn::GetAtt':
          - withsharedalbrestatetaskroleDE0CA1F2
          - Arn
  withsharedalbstatelessdefinitionrestateLogGroup1AEC0F29:
    Type: 'AWS::Logs::LogGroup'
    Properties:
      Tags:
        - Key: Name
          Value: RestateBYOC/with-shared-alb/stateless-definition
    UpdateReplacePolicy: Retain
    DeletionPolicy: Retain
  withsharedalbstatelessserviceService9BBF0F9B:
    Type: 'AWS::ECS::Service'
    Properties:
      Cluster:
        Ref: withsharedalbclusterC111A9F9
      DeploymentConfiguration:
        Alarms:
          AlarmNames: []
          Enable: false
          Rollback: false
        MaximumPercent: 200
        MinimumHealthyPercent: 100
      DesiredCount: 3
      EnableECSManagedTags: false
      EnableExecuteCommand: false
      HealthCheckGracePeriodSeconds: 60
      LaunchType: FARGATE
      LoadBalancers:
        - ContainerName: restate
          ContainerPort: 8080
          TargetGroupArn:
            Ref: withsharedalbingresssharedtarget7AF31D75
        - ContainerName: restate
          ContainerPort: 9070
          TargetGroupArn:
            Ref: withsharedalbadminsharedtargetEC422D18
        - ContainerName: restate
          ContainerPort: 5122
          TargetGroupArn:
            Ref: withsharedalbnodesharedtarget238B77F4
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: DISABLED
          SecurityGroups:
            - 'Fn::GetAtt':
                - withsharedalbsecuritygroup764E6947
                - GroupId
          Subnets:
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet1Subnet934893E8236E2271'
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet2Subnet7031C2BA60DCB1EE'
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet3Subnet985AC459F9514491'
      PropagateTags: SERVICE
      Tags:
        - Key: Name
          Value: RestateBYOC/with-shared-alb/stateless-service
      TaskDefinition:
        Ref: withsharedalbstatelessdefinition9EFE894B
    DependsOn:
      - withsharedalbadminsharedlistener58F44365
      - withsharedalbingresssharedlistenerC5DBBAEA
      - withsharedalbnodesharedlistener638EC249
      - withsharedalbrestatetaskroleDefaultPolicy3C4A4214
      - withsharedalbrestatetaskroleDE0CA1F2
  withsharedalbstatefuldefinitionD5488E14:
    Type: 'AWS::ECS::TaskDefinition'
    Properties:
      ContainerDefinitions:
        - Cpu: 16384
          EntryPoint:
            - bash
            - '-c'
            - >

              curl --no-progress-meter $ECS_CONTAINER_METADATA_URI_V4/task -o
              task-metadata && \\

              export \\
                RESTATE_NODE_NAME=$(jq -r '.TaskARN' task-metadata) \\
                RESTATE_LOCATION="$AWS_REGION.$(jq -r '.AvailabilityZone' task-metadata)" \\
                RESTATE_ADVERTISED_ADDRESS="http://$(jq -r '.Containers[0].Networks[0].IPv4Addresses[0]' task-metadata):5122"
              exec restate-server
          Environment:
            - Name: RESTATE_LOG_FORMAT
              Value: json
            - Name: RESTATE_CLUSTER_NAME
              Value: RestateBYOC/with-shared-alb
            - Name: RESTATE_ROLES
              Value: '["log-server", "worker"]'
            - Name: RESTATE_AUTO_PROVISION
              Value: 'false'
            - Name: RESTATE_SHUTDOWN_TIMEOUT
              Value: 100s
            - Name: RESTATE_ROCKSDB_TOTAL_MEMORY_SIZE
              Value: 24576MiB
            - Name: RESTATE_METADATA_CLIENT__TYPE
              Value: object-store
            - Name: RESTATE_METADATA_CLIENT__PATH
              Value:
                'Fn::Join':
                  - ''
                  - - 's3://'
                    - Ref: withsharedalbbucket0B158E57
                    - /metadata
            - Name: RESTATE_WORKER__SNAPSHOTS__DESTINATION
              Value:
                'Fn::Join':
                  - ''
                  - - 's3://'
                    - Ref: withsharedalbbucket0B158E57
                    - /snapshots
            - Name: RESTATE_WORKER__SNAPSHOTS__SNAPSHOT_INTERVAL_NUM_RECORDS
              Value: '1000000'
            - Name: RESTATE_WORKER__STORAGE__ROCKSDB_DISABLE_DIRECT_IO_FOR_READS
              Value: 'true'
            - Name: RESTATE_WORKER__STORAGE__ROCKSDB_DISABLE_WAL_FSYNC
              Value: 'true'
            - Name: RESTATE_LOG_SERVER__ROCKSDB_DISABLE_WAL_FSYNC
              Value: 'true'
            - Name: RESTATE_LOG_SERVER__ROCKSDB_DISABLE_DIRECT_IO_FOR_READS
              Value: 'true'
            - Name: >-
                RESTATE_INGRESS__EXPERIMENTAL_FEATURE_ENABLE_SEPARATE_INGRESS_ROLE
              Value: 'true'
          Essential: true
          HealthCheck:
            Command:
              - CMD
              - curl
              - '--fail'
              - 'http://127.0.0.1:5122/health'
            Interval: 30
            Retries: 3
            Timeout: 5
          Image: Any<Object>
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group:
                Ref: withsharedalbstatefuldefinitionrestateLogGroup5BDDBA7D
              awslogs-stream-prefix: restate
              awslogs-region: region
          Memory: 32768
          MountPoints:
            - ContainerPath: /restate-data
              ReadOnly: false
              SourceVolume: restate-data
          Name: restate
          PortMappings:
            - ContainerPort: 5122
              Name: node
              Protocol: tcp
          RestartPolicy:
            Enabled: true
            RestartAttemptPeriod: 60
          StopTimeout: 120
      Cpu: '16384'
      EphemeralStorage:
        SizeInGiB: 200
      ExecutionRoleArn:
        'Fn::GetAtt':
          - withsharedalbrestateexecutionroleBA9578BE
          - Arn
      Family: RestateBYOCwithsharedalbstatefuldefinition0CF34EB1
      Memory: '32768'
      NetworkMode: awsvpc
      RequiresCompatibilities:
        - FARGATE
      RuntimePlatform:
        CpuArchitecture: ARM64
        OperatingSystemFamily: LINUX
      Tags:
        - Key: Name
          Value: RestateBYOC/with-shared-alb/stateful-definition
      TaskRoleArn:
        'Fn::GetAtt':
          - withsharedalbrestatetaskroleDE0CA1F2
          - Arn
      Volumes:
        - ConfiguredAtLaunch: false
          Name: restate-data
  withsharedalbstatefuldefinitionrestateLogGroup5BDDBA7D:
    Type: 'AWS::Logs::LogGroup'
    Properties:
      Tags:
        - Key: Name
          Value: RestateBYOC/with-shared-alb/stateful-definition
    UpdateReplacePolicy: Retain
    DeletionPolicy: Retain
  withsharedalbingresssharedtarget7AF31D75:
    Type: 'AWS::ElasticLoadBalancingV2::TargetGroup'
    Properties:
      HealthCheckEnabled: true
      HealthCheckIntervalSeconds: 5
      HealthCheckPath: /restate/health
      HealthCheckProtocol: HTTP
      HealthCheckTimeoutSeconds: 2
      Port: 8080
      Protocol: HTTP
      Tags:
        - Key: Name
          Value: RestateBYOC/with-shared-alb/ingress-shared-target
      TargetGroupAttributes:
        - Key: stickiness.enabled
          Value: 'false'
      TargetType: ip
      VpcId:
        'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcA2121C384D1B3CDE'
  withsharedalbadminsharedtargetEC422D18:
    Type: 'AWS::ElasticLoadBalancingV2::TargetGroup'
    Properties:
      HealthCheckEnabled: true
      HealthCheckIntervalSeconds: 5
      HealthCheckPath: /health
      HealthCheckPort: '9070'
      HealthCheckProtocol: HTTP
      HealthCheckTimeoutSeconds: 2
      Port: 9070
      Protocol: HTTP
      Tags:
        - Key: Name
          Value: RestateBYOC/with-shared-alb/admin-shared-target
      TargetGroupAttributes:
        - Key: stickiness.enabled
          Value: 'false'
      TargetType: ip
      VpcId:
        'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcA2121C384D1B3CDE'
  withsharedalbnodesharedtarget238B77F4:
    Type: 'AWS::ElasticLoadBalancingV2::TargetGroup'
    Properties:
      HealthCheckEnabled: true
      HealthCheckIntervalSeconds: 5
      HealthCheckPath: /health
      HealthCheckPort: '5122'
      HealthCheckProtocol: HTTP
      HealthCheckTimeoutSeconds: 2
      Port: 5122
      Protocol: HTTP
      Tags:
        - Key: Name
          Value: RestateBYOC/with-shared-alb/node-shared-target
      TargetGroupAttributes:
        - Key: stickiness.enabled
          Value: 'false'
      TargetType: ip
      VpcId:
        'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcA2121C384D1B3CDE'
  withsharedalbcontrollertaskrole5ABF1B92:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
        Version: '2012-10-17'
  withsharedalbcontrollertaskroleDefaultPolicyC7AD62B0:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 'ecs:ListTasks'
              - 'ecs:DescribeTasks'
              - 'ecs:StopTask'
            Condition:
              ArnEquals:
                'ecs:cluster':
                  'Fn::GetAtt':
                    - withsharedalbclusterC111A9F9
                    - Arn
            Effect: Allow
            Resource: '*'
            Sid: TaskActions
          - Action: 'ecs:TagResource'
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'Fn::Join':
                      - /
                      - - 'Fn::Join':
                            - ':'
                            - - 'Fn::Select':
                                  - 0
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - withsharedalbclusterC111A9F9
                                                  - Arn
                              - 'Fn::Select':
                                  - 1
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - withsharedalbclusterC111A9F9
                                                  - Arn
                              - 'Fn::Select':
                                  - 2
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - withsharedalbclusterC111A9F9
                                                  - Arn
                              - 'Fn::Select':
                                  - 3
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - withsharedalbclusterC111A9F9
                                                  - Arn
                              - 'Fn::Select':
                                  - 4
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - withsharedalbclusterC111A9F9
                                                  - Arn
                              - task
                        - 'Fn::Select':
                            - 1
                            - 'Fn::Split':
                                - /
                                - 'Fn::GetAtt':
                                    - withsharedalbclusterC111A9F9
                                    - Arn
                        - ''
                  - '*'
            Sid: TagTasks
          - Action: 'ecs:RunTask'
            Condition:
              ArnEquals:
                'ecs:cluster':
                  'Fn::GetAtt':
                    - withsharedalbclusterC111A9F9
                    - Arn
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'Fn::Join':
                      - ':'
                      - - 'Fn::Select':
                            - 0
                            - 'Fn::Split':
                                - ':'
                                - Ref: withsharedalbstatefuldefinitionD5488E14
                        - 'Fn::Select':
                            - 1
                            - 'Fn::Split':
                                - ':'
                                - Ref: withsharedalbstatefuldefinitionD5488E14
                        - 'Fn::Select':
                            - 2
                            - 'Fn::Split':
                                - ':'
                                - Ref: withsharedalbstatefuldefinitionD5488E14
                        - 'Fn::Select':
                            - 3
                            - 'Fn::Split':
                                - ':'
                                - Ref: withsharedalbstatefuldefinitionD5488E14
                        - 'Fn::Select':
                            - 4
                            - 'Fn::Split':
                                - ':'
                                - Ref: withsharedalbstatefuldefinitionD5488E14
                        - 'Fn::Select':
                            - 5
                            - 'Fn::Split':
                                - ':'
                                - Ref: withsharedalbstatefuldefinitionD5488E14
                  - ':*'
            Sid: RunTask
          - Action: 'iam:PassRole'
            Condition:
              StringEquals:
                'iam:PassedToService': ecs-tasks.amazonaws.com
            Effect: Allow
            Resource:
              - 'Fn::GetAtt':
                  - withsharedalbrestatetaskroleDE0CA1F2
                  - Arn
              - 'Fn::GetAtt':
                  - withsharedalbrestateexecutionroleBA9578BE
                  - Arn
            Sid: RunTaskPassRole
          - Action:
              - 's3:GetObject'
              - 's3:PutObject'
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'Fn::GetAtt':
                      - withsharedalbbucket0B158E57
                      - Arn
                  - /*
            Sid: ReadWriteBucket
          - Action: 's3:ListBucket'
            Effect: Allow
            Resource:
              'Fn::GetAtt':
                - withsharedalbbucket0B158E57
                - Arn
            Sid: ListBucket
        Version: '2012-10-17'
      PolicyName: withsharedalbcontrollertaskroleDefaultPolicyC7AD62B0
      Roles:
        - Ref: withsharedalbcontrollertaskrole5ABF1B92
  withsharedalbcontrollerexecutionrole30176AED:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
        Version: '2012-10-17'
  withsharedalbcontrollerexecutionroleDefaultPolicyAF5969E0:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 'logs:CreateLogStream'
              - 'logs:PutLogEvents'
            Effect: Allow
            Resource:
              'Fn::GetAtt':
                - withsharedalbcontrollerdefinitioncontrollerLogGroup5AF9B5BD
                - Arn
        Version: '2012-10-17'
      PolicyName: withsharedalbcontrollerexecutionroleDefaultPolicyAF5969E0
      Roles:
        - Ref: withsharedalbcontrollerexecutionrole30176AED
  withsharedalbcontrollerdefinition39478DDF:
    Type: 'AWS::ECS::TaskDefinition'
    Properties:
      ContainerDefinitions:
        - Cpu: 1024
          Environment:
            - Name: RUST_LOG
              Value: 'info,restate_fargate_controller=debug'
            - Name: CONTROLLER_LOG_FORMAT
              Value: json
            - Name: CONTROLLER_METADATA_PATH
              Value:
                'Fn::Join':
                  - ''
                  - - 's3://'
                    - Ref: withsharedalbbucket0B158E57
                    - /metadata
            - Name: CONTROLLER_RECONCILE_INTERVAL
              Value: 10s
            - Name: CONTROLLER_CLUSTER__CLUSTER_ARN
              Value:
                'Fn::GetAtt':
                  - withsharedalbclusterC111A9F9
                  - Arn
            - Name: CONTROLLER_LICENSE_ID
              Value: foo
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __REGION
              Value:
                Ref: 'AWS::Region'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __CLUSTER_ARN
              Value:
                'Fn::GetAtt':
                  - withsharedalbclusterC111A9F9
                  - Arn
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __TASK_PREFIX
              Value:
                'Fn::Join':
                  - /
                  - - 'Fn::Join':
                        - ':'
                        - - 'Fn::Select':
                              - 0
                              - 'Fn::Split':
                                  - ':'
                                  - 'Fn::Select':
                                      - 0
                                      - 'Fn::Split':
                                          - /
                                          - 'Fn::GetAtt':
                                              - withsharedalbclusterC111A9F9
                                              - Arn
                          - 'Fn::Select':
                              - 1
                              - 'Fn::Split':
                                  - ':'
                                  - 'Fn::Select':
                                      - 0
                                      - 'Fn::Split':
                                          - /
                                          - 'Fn::GetAtt':
                                              - withsharedalbclusterC111A9F9
                                              - Arn
                          - 'Fn::Select':
                              - 2
                              - 'Fn::Split':
                                  - ':'
                                  - 'Fn::Select':
                                      - 0
                                      - 'Fn::Split':
                                          - /
                                          - 'Fn::GetAtt':
                                              - withsharedalbclusterC111A9F9
                                              - Arn
                          - 'Fn::Select':
                              - 3
                              - 'Fn::Split':
                                  - ':'
                                  - 'Fn::Select':
                                      - 0
                                      - 'Fn::Split':
                                          - /
                                          - 'Fn::GetAtt':
                                              - withsharedalbclusterC111A9F9
                                              - Arn
                          - 'Fn::Select':
                              - 4
                              - 'Fn::Split':
                                  - ':'
                                  - 'Fn::Select':
                                      - 0
                                      - 'Fn::Split':
                                          - /
                                          - 'Fn::GetAtt':
                                              - withsharedalbclusterC111A9F9
                                              - Arn
                          - task
                    - 'Fn::Select':
                        - 1
                        - 'Fn::Split':
                            - /
                            - 'Fn::GetAtt':
                                - withsharedalbclusterC111A9F9
                                - Arn
                    - ''
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1a__ENABLE_EXECUTE_COMMAND
              Value: 'false'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1a__SECURITY_GROUPS
              Value:
                'Fn::Join':
                  - ''
                  - - '["'
                    - 'Fn::GetAtt':
                        - withsharedalbsecuritygroup764E6947
                        - GroupId
                    - '"]'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1a__SUBNETS
              Value:
                'Fn::Join':
                  - ''
                  - - '["'
                    - 'Fn::ImportValue': >-
                        VPCStack:ExportsOutputRefvpcPrivateSubnet1Subnet934893E8236E2271
                    - '"]'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1a__TASK_DEFINITION_ARN
              Value:
                Ref: withsharedalbstatefuldefinitionD5488E14
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1a__COUNT
              Value: '1'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1b__ENABLE_EXECUTE_COMMAND
              Value: 'false'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1b__SECURITY_GROUPS
              Value:
                'Fn::Join':
                  - ''
                  - - '["'
                    - 'Fn::GetAtt':
                        - withsharedalbsecuritygroup764E6947
                        - GroupId
                    - '"]'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1b__SUBNETS
              Value:
                'Fn::Join':
                  - ''
                  - - '["'
                    - 'Fn::ImportValue': >-
                        VPCStack:ExportsOutputRefvpcPrivateSubnet2Subnet7031C2BA60DCB1EE
                    - '"]'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1b__TASK_DEFINITION_ARN
              Value:
                Ref: withsharedalbstatefuldefinitionD5488E14
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1b__COUNT
              Value: '1'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1c__ENABLE_EXECUTE_COMMAND
              Value: 'false'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1c__SECURITY_GROUPS
              Value:
                'Fn::Join':
                  - ''
                  - - '["'
                    - 'Fn::GetAtt':
                        - withsharedalbsecuritygroup764E6947
                        - GroupId
                    - '"]'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1c__SUBNETS
              Value:
                'Fn::Join':
                  - ''
                  - - '["'
                    - 'Fn::ImportValue': >-
                        VPCStack:ExportsOutputRefvpcPrivateSubnet3Subnet985AC459F9514491
                    - '"]'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1c__TASK_DEFINITION_ARN
              Value:
                Ref: withsharedalbstatefuldefinitionD5488E14
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1c__COUNT
              Value: '1'
          Essential: true
          HealthCheck:
            Command:
              - CMD
              - curl
              - '--fail'
              - 'http://127.0.0.1:8080/health'
            Interval: 30
            Retries: 10
            StartPeriod: 300
            Timeout: 5
          Image: Any<Object>
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group:
                Ref: withsharedalbcontrollerdefinitioncontrollerLogGroup5AF9B5BD
              awslogs-stream-prefix: controller
              awslogs-region: region
          Memory: 2048
          Name: controller
          StopTimeout: 120
      Cpu: '1024'
      ExecutionRoleArn:
        'Fn::GetAtt':
          - withsharedalbcontrollerexecutionrole30176AED
          - Arn
      Family: RestateBYOCwithsharedalbcontrollerdefinitionC9A7D99F
      Memory: '2048'
      NetworkMode: awsvpc
      RequiresCompatibilities:
        - FARGATE
      RuntimePlatform:
        CpuArchitecture: ARM64
        OperatingSystemFamily: LINUX
      Tags:
        - Key: Name
          Value: RestateBYOC/with-shared-alb/controller-definition
      TaskRoleArn:
        'Fn::GetAtt':
          - withsharedalbcontrollertaskrole5ABF1B92
          - Arn
  withsharedalbcontrollerdefinitioncontrollerLogGroup5AF9B5BD:
    Type: 'AWS::Logs::LogGroup'
    Properties:
      Tags:
        - Key: Name
          Value: RestateBYOC/with-shared-alb/controller-definition
    UpdateReplacePolicy: Retain
    DeletionPolicy: Retain
  withsharedalbcontrollerserviceServiceC852EDD3:
    Type: 'AWS::ECS::Service'
    Properties:
      Cluster:
        Ref: withsharedalbclusterC111A9F9
      DeploymentConfiguration:
        Alarms:
          AlarmNames: []
          Enable: false
          Rollback: false
        MaximumPercent: 100
        MinimumHealthyPercent: 0
      DesiredCount: 1
      EnableECSManagedTags: false
      EnableExecuteCommand: false
      LaunchType: FARGATE
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: DISABLED
          SecurityGroups:
            - 'Fn::GetAtt':
                - withsharedalbsecuritygroup764E6947
                - GroupId
          Subnets:
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet1Subnet934893E8236E2271'
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet2Subnet7031C2BA60DCB1EE'
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet3Subnet985AC459F9514491'
      Tags:
        - Key: Name
          Value: RestateBYOC/with-shared-alb/controller-service
      TaskDefinition:
        Ref: withsharedalbcontrollerdefinition39478DDF
    DependsOn:
      - withsharedalbcontrollertaskroleDefaultPolicyC7AD62B0
      - withsharedalbcontrollertaskrole5ABF1B92
  withsharedalbrestatectllambdaexecutionroleB3B04E1D:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
        Version: '2012-10-17'
  withsharedalbrestatectllambdaexecutionroleDefaultPolicy9F6A02B5:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 'logs:CreateLogGroup'
              - 'logs:CreateLogStream'
              - 'logs:PutLogEvents'
              - 'ec2:CreateNetworkInterface'
              - 'ec2:DescribeNetworkInterfaces'
              - 'ec2:DescribeSubnets'
              - 'ec2:DeleteNetworkInterface'
              - 'ec2:AssignPrivateIpAddresses'
              - 'ec2:UnassignPrivateIpAddresses'
            Effect: Allow
            Resource: '*'
            Sid: AWSLambdaVPCAccessExecutionPermissions
        Version: '2012-10-17'
      PolicyName: withsharedalbrestatectllambdaexecutionroleDefaultPolicy9F6A02B5
      Roles:
        - Ref: withsharedalbrestatectllambdaexecutionroleB3B04E1D
  withsharedalbrestatectllambda0FCA62E7:
    Type: 'AWS::Lambda::Function'
    Properties:
      Architectures:
        - arm64
      Code: Any<Object>
      Environment:
        Variables:
          RESTATECTL_ADDRESS:
            'Fn::Join':
              - ''
              - - 'http://'
                - 'Fn::GetAtt':
                    - withsharedalb7F233835
                    - DNSName
                - ':5122'
      Handler: restatectl
      Role:
        'Fn::GetAtt':
          - withsharedalbrestatectllambdaexecutionroleB3B04E1D
          - Arn
      Runtime: provided.al2023
      Tags:
        - Key: Name
          Value: RestateBYOC/with-shared-alb/restatectl-lambda
      Timeout: 10
      VpcConfig:
        SecurityGroupIds:
          - 'Fn::GetAtt':
              - withsharedalbsecuritygroup764E6947
              - GroupId
        SubnetIds:
          - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet1Subnet934893E8236E2271'
          - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet2Subnet7031C2BA60DCB1EE'
          - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet3Subnet985AC459F9514491'
    DependsOn:
      - withsharedalbrestatectllambdaexecutionroleDefaultPolicy9F6A02B5
      - withsharedalbrestatectllambdaexecutionroleB3B04E1D
  withsharedalbretirementwatcherlambdaexecutionrole6A436460:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
        Version: '2012-10-17'
  withsharedalbretirementwatcherlambdaexecutionroleDefaultPolicyE5657E6C:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 'logs:CreateLogGroup'
              - 'logs:CreateLogStream'
              - 'logs:PutLogEvents'
            Effect: Allow
            Resource: '*'
            Sid: AWSLambdaBasicExecutionPermissions
          - Action: 'ecs:TagResource'
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'Fn::Join':
                      - /
                      - - 'Fn::Join':
                            - ':'
                            - - 'Fn::Select':
                                  - 0
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - withsharedalbclusterC111A9F9
                                                  - Arn
                              - 'Fn::Select':
                                  - 1
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - withsharedalbclusterC111A9F9
                                                  - Arn
                              - 'Fn::Select':
                                  - 2
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - withsharedalbclusterC111A9F9
                                                  - Arn
                              - 'Fn::Select':
                                  - 3
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - withsharedalbclusterC111A9F9
                                                  - Arn
                              - 'Fn::Select':
                                  - 4
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - withsharedalbclusterC111A9F9
                                                  - Arn
                              - task
                        - 'Fn::Select':
                            - 1
                            - 'Fn::Split':
                                - /
                                - 'Fn::GetAtt':
                                    - withsharedalbclusterC111A9F9
                                    - Arn
                        - ''
                  - '*'
            Sid: TagTasks
          - Action:
              - 'sqs:ReceiveMessage'
              - 'sqs:ChangeMessageVisibility'
              - 'sqs:GetQueueUrl'
              - 'sqs:DeleteMessage'
              - 'sqs:GetQueueAttributes'
            Effect: Allow
            Resource:
              'Fn::GetAtt':
                - withsharedalbretirementwatcherqueue03B8B440
                - Arn
        Version: '2012-10-17'
      PolicyName: withsharedalbretirementwatcherlambdaexecutionroleDefaultPolicyE5657E6C
      Roles:
        - Ref: withsharedalbretirementwatcherlambdaexecutionrole6A436460
  withsharedalbretirementwatcherlambda618A4350:
    Type: 'AWS::Lambda::Function'
    Properties:
      Architectures:
        - arm64
      Code: Any<Object>
      Handler: index.handler
      Role:
        'Fn::GetAtt':
          - withsharedalbretirementwatcherlambdaexecutionrole6A436460
          - Arn
      Runtime: nodejs22.x
      Tags:
        - Key: Name
          Value: RestateBYOC/with-shared-alb/retirement-watcher-lambda
      Timeout: 60
    DependsOn:
      - withsharedalbretirementwatcherlambdaexecutionroleDefaultPolicyE5657E6C
      - withsharedalbretirementwatcherlambdaexecutionrole6A436460
  withsharedalbretirementwatcherlambdaSqsEventSourceRestateBYOCwithsharedalbretirementwatcherqueue58A2E6387C52124E:
    Type: 'AWS::Lambda::EventSourceMapping'
    Properties:
      BatchSize: 1
      EventSourceArn:
        'Fn::GetAtt':
          - withsharedalbretirementwatcherqueue03B8B440
          - Arn
      FunctionName:
        Ref: withsharedalbretirementwatcherlambda618A4350
      Tags:
        - Key: Name
          Value: RestateBYOC/with-shared-alb/retirement-watcher-lambda
  withsharedalbretirementwatcherqueue03B8B440:
    Type: 'AWS::SQS::Queue'
    Properties:
      Tags:
        - Key: Name
          Value: RestateBYOC/with-shared-alb/retirement-watcher-queue
      VisibilityTimeout: 60
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  withsharedalbretirementwatcherqueuePolicyF9872244:
    Type: 'AWS::SQS::QueuePolicy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 'sqs:SendMessage'
              - 'sqs:GetQueueAttributes'
              - 'sqs:GetQueueUrl'
            Condition:
              ArnEquals:
                'aws:SourceArn':
                  'Fn::GetAtt':
                    - withsharedalbretirementwatcherrule73F0FCDD
                    - Arn
            Effect: Allow
            Principal:
              Service: events.amazonaws.com
            Resource:
              'Fn::GetAtt':
                - withsharedalbretirementwatcherqueue03B8B440
                - Arn
        Version: '2012-10-17'
      Queues:
        - Ref: withsharedalbretirementwatcherqueue03B8B440
  withsharedalbretirementwatcherrule73F0FCDD:
    Type: 'AWS::Events::Rule'
    Properties:
      EventPattern:
        detail:
          eventTypeCode:
            - equals-ignore-case: AWS_ECS_TASK_PATCHING_RETIREMENT
          service:
            - equals-ignore-case: ecs
        resources:
          - prefix:
              'Fn::Join':
                - /
                - - 'Fn::Join':
                      - ':'
                      - - 'Fn::Select':
                            - 0
                            - 'Fn::Split':
                                - ':'
                                - 'Fn::Select':
                                    - 0
                                    - 'Fn::Split':
                                        - /
                                        - 'Fn::GetAtt':
                                            - withsharedalbclusterC111A9F9
                                            - Arn
                        - 'Fn::Select':
                            - 1
                            - 'Fn::Split':
                                - ':'
                                - 'Fn::Select':
                                    - 0
                                    - 'Fn::Split':
                                        - /
                                        - 'Fn::GetAtt':
                                            - withsharedalbclusterC111A9F9
                                            - Arn
                        - 'Fn::Select':
                            - 2
                            - 'Fn::Split':
                                - ':'
                                - 'Fn::Select':
                                    - 0
                                    - 'Fn::Split':
                                        - /
                                        - 'Fn::GetAtt':
                                            - withsharedalbclusterC111A9F9
                                            - Arn
                        - 'Fn::Select':
                            - 3
                            - 'Fn::Split':
                                - ':'
                                - 'Fn::Select':
                                    - 0
                                    - 'Fn::Split':
                                        - /
                                        - 'Fn::GetAtt':
                                            - withsharedalbclusterC111A9F9
                                            - Arn
                        - 'Fn::Select':
                            - 4
                            - 'Fn::Split':
                                - ':'
                                - 'Fn::Select':
                                    - 0
                                    - 'Fn::Split':
                                        - /
                                        - 'Fn::GetAtt':
                                            - withsharedalbclusterC111A9F9
                                            - Arn
                        - task
                  - 'Fn::Select':
                      - 1
                      - 'Fn::Split':
                          - /
                          - 'Fn::GetAtt':
                              - withsharedalbclusterC111A9F9
                              - Arn
                  - ''
        detail-type:
          - equals-ignore-case: AWS Health Event
      State: ENABLED
      Targets:
        - Arn:
            'Fn::GetAtt':
              - withsharedalbretirementwatcherqueue03B8B440
              - Arn
          Id: Target0
  withsharedalbcloudwatchcustomwidgetexecutionrole61B3E971:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
        Version: '2012-10-17'
  withsharedalbcloudwatchcustomwidgetexecutionroleDefaultPolicyDA6C219F:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 'logs:CreateLogGroup'
              - 'logs:CreateLogStream'
              - 'logs:PutLogEvents'
            Effect: Allow
            Resource: '*'
            Sid: AWSLambdaBasicExecutionPermissions
          - Action: 'lambda:InvokeFunction'
            Effect: Allow
            Resource:
              'Fn::GetAtt':
                - withsharedalbrestatectllambda0FCA62E7
                - Arn
            Sid: InvokeRestatectl
          - Action:
              - 'ec2:DescribeVolumes'
              - 'ec2:DescribeVolumeStatus'
            Effect: Allow
            Resource: '*'
            Sid: EC2ReadActions
          - Action: 'ecs:DescribeTaskDefinition'
            Effect: Allow
            Resource: '*'
            Sid: ECSReadActions
          - Action: 'ecs:ListTasks'
            Condition:
              StringEquals:
                'ecs:cluster':
                  'Fn::GetAtt':
                    - withsharedalbclusterC111A9F9
                    - Arn
            Effect: Allow
            Resource: '*'
            Sid: ECSListTasks
          - Action: 'ecs:DescribeTasks'
            Condition:
              StringEquals:
                'ecs:cluster':
                  'Fn::GetAtt':
                    - withsharedalbclusterC111A9F9
                    - Arn
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'arn:'
                  - Ref: 'AWS::Partition'
                  - ':ecs:'
                  - Ref: 'AWS::Region'
                  - ':'
                  - Ref: 'AWS::AccountId'
                  - ':task/'
                  - Ref: withsharedalbclusterC111A9F9
                  - /*
            Sid: ECSDescribeTasks
          - Action: 'ecs:DescribeServices'
            Condition:
              StringEquals:
                'ecs:cluster':
                  'Fn::GetAtt':
                    - withsharedalbclusterC111A9F9
                    - Arn
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'arn:'
                  - Ref: 'AWS::Partition'
                  - ':ecs:'
                  - Ref: 'AWS::Region'
                  - ':'
                  - Ref: 'AWS::AccountId'
                  - ':service/'
                  - Ref: withsharedalbclusterC111A9F9
                  - /*
            Sid: ECSDescribeServices
          - Action: 'cloudwatch:GetMetricData'
            Effect: Allow
            Resource: '*'
            Sid: CloudWatchReadActions
        Version: '2012-10-17'
      PolicyName: withsharedalbcloudwatchcustomwidgetexecutionroleDefaultPolicyDA6C219F
      Roles:
        - Ref: withsharedalbcloudwatchcustomwidgetexecutionrole61B3E971
  withsharedalbcloudwatchcustomwidgetlambda64BF84CE:
    Type: 'AWS::Lambda::Function'
    Properties:
      Architectures:
        - arm64
      Code: Any<Object>
      Handler: index.handler
      MemorySize: 1024
      Role:
        'Fn::GetAtt':
          - withsharedalbcloudwatchcustomwidgetexecutionrole61B3E971
          - Arn
      Runtime: nodejs22.x
      Tags:
        - Key: Name
          Value: RestateBYOC/with-shared-alb/cloudwatch-custom-widget-lambda
      Timeout: 60
    DependsOn:
      - withsharedalbcloudwatchcustomwidgetexecutionroleDefaultPolicyDA6C219F
      - withsharedalbcloudwatchcustomwidgetexecutionrole61B3E971
  withsharedalbcloudwatchcustomwidgetlambdacloudwatchcustomwidgetlambdaallowdatasource4405006D:
    Type: 'AWS::Lambda::Permission'
    Properties:
      Action: 'lambda:InvokeFunction'
      FunctionName:
        'Fn::GetAtt':
          - withsharedalbcloudwatchcustomwidgetlambda64BF84CE
          - Arn
      Principal: lambda.datasource.cloudwatch.amazonaws.com
  withsharedalbmetrics9B81E37C:
    Type: 'AWS::CloudWatch::Dashboard'
    Properties:
      DashboardBody:
        'Fn::Join':
          - ''
          - - >-
              {"widgets":[{"type":"metric","width":12,"height":6,"x":0,"y":0,"properties":{"view":"timeSeries","title":"Stateless
              CPU","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"CPU","expression":"cpu /
              1024"}],[{"expression":"SELECT AVG(CpuUtilized) FROM
              SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOCwithsharedalbstatelessdefinition16966423' GROUP BY
              TaskId","visible":false,"id":"cpu"}]],"annotations":{"horizontal":[{"value":16,"label":"Limit","yAxis":"left"}]},"yAxis":{"left":{"label":"vCPUs","showUnits":false}}}},{"type":"metric","width":12,"height":6,"x":12,"y":0,"properties":{"view":"timeSeries","title":"Stateless
              Memory","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Memory","expression":"memory /
              1024"}],[{"expression":"SELECT AVG(MemoryUtilized) FROM
              SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOCwithsharedalbstatelessdefinition16966423' GROUP BY
              TaskId","visible":false,"id":"memory"}]],"annotations":{"horizontal":[{"value":32,"label":"Limit","yAxis":"left"}]},"yAxis":{"left":{"label":"GiB","showUnits":false}}}},{"type":"metric","width":12,"height":6,"x":0,"y":6,"properties":{"view":"timeSeries","title":"Stateless
              Network Tx","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Tx","expression":"SELECT
              AVG(NetworkTxBytes) FROM SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOCwithsharedalbstatelessdefinition16966423' GROUP BY
              TaskId"}]],"yAxis":{"left":{"label":"Bytes/sec","showUnits":false}}}},{"type":"metric","width":12,"height":6,"x":12,"y":6,"properties":{"view":"timeSeries","title":"Stateless
              Network Rx","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Rx","expression":"SELECT
              AVG(NetworkRxBytes) FROM SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOCwithsharedalbstatelessdefinition16966423' GROUP BY
              TaskId"}]],"yAxis":{"left":{"label":"Bytes/sec","showUnits":false}}}},{"type":"log","width":24,"height":6,"x":0,"y":12,"properties":{"view":"table","title":"Stateless
              Logs","region":"region","query":"SOURCE '
            - Ref: withsharedalbstatelessdefinitionrestateLogGroup1AEC0F29
            - >-
              ' | fields @logStream, @timestamp, level, fields.message,
              target\\n          | sort @timestamp desc\\n          | limit
              500"}},{"type":"metric","width":12,"height":6,"x":0,"y":18,"properties":{"view":"timeSeries","title":"Stateful
              CPU","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"CPU","expression":"cpu /
              1024"}],[{"expression":"SELECT AVG(CpuUtilized) FROM
              SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOCwithsharedalbstatefuldefinition0CF34EB1' GROUP BY
              TaskId","visible":false,"id":"cpu"}]],"annotations":{"horizontal":[{"value":16,"label":"Limit","yAxis":"left"}]},"yAxis":{"left":{"label":"vCPUs","showUnits":false}}}},{"type":"metric","width":12,"height":6,"x":12,"y":18,"properties":{"view":"timeSeries","title":"Stateful
              Memory","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Memory","expression":"memory /
              1024"}],[{"expression":"SELECT AVG(MemoryUtilized) FROM
              SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOCwithsharedalbstatefuldefinition0CF34EB1' GROUP BY
              TaskId","visible":false,"id":"memory"}]],"annotations":{"horizontal":[{"value":32,"label":"Limit","yAxis":"left"}]},"yAxis":{"left":{"label":"GiB","showUnits":false}}}},{"type":"metric","width":12,"height":6,"x":0,"y":24,"properties":{"view":"timeSeries","title":"Stateful
              Network Tx","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Tx","expression":"SELECT
              AVG(NetworkTxBytes) FROM SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOCwithsharedalbstatefuldefinition0CF34EB1' GROUP BY
              TaskId"}]],"yAxis":{"left":{"label":"Bytes/sec","showUnits":false}}}},{"type":"metric","width":12,"height":6,"x":12,"y":24,"properties":{"view":"timeSeries","title":"Stateful
              Network Rx","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Rx","expression":"SELECT
              AVG(NetworkRxBytes) FROM SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOCwithsharedalbstatefuldefinition0CF34EB1' GROUP BY
              TaskId"}]],"yAxis":{"left":{"label":"Bytes/sec","showUnits":false}}}},{"type":"log","width":24,"height":6,"x":0,"y":30,"properties":{"view":"table","title":"Stateful
              Logs","region":"region","query":"SOURCE '
            - Ref: withsharedalbstatefuldefinitionrestateLogGroup5BDDBA7D
            - >-
              ' | fields @logStream, @timestamp, level, fields.message,
              target\\n          | sort @timestamp desc\\n          | limit
              500"}},{"type":"metric","width":8,"height":6,"x":0,"y":36,"properties":{"view":"timeSeries","title":"Ephemeral
              Volume Usage (Total size 200GiB)","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Usage","expression":"SELECT
              MAX(EphemeralStorageUtilized) FROM
              SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily) WHERE TaskDefinitionFamily =
              'RestateBYOCwithsharedalbstatefuldefinition0CF34EB1'"}]],"annotations":{"horizontal":[{"value":200,"label":"Volume
              size","visible":false,"yAxis":"left"}]},"yAxis":{"left":{"label":"GiB","showUnits":false}},"liveData":false}},{"type":"metric","width":8,"height":6,"x":8,"y":36,"properties":{"view":"timeSeries","title":"Volume
              Write Throughput (Limited to 150 MiB/sec)","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Write","expression":"RATE(count) /
              1048576"}],[{"expression":"SELECT MAX(StorageWriteBytes) FROM
              SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOCwithsharedalbstatefuldefinition0CF34EB1' GROUP BY
              TaskId","visible":false,"id":"count"}]],"annotations":{"horizontal":[{"value":150,"label":"Limit","visible":false,"yAxis":"left"}]},"yAxis":{"left":{"label":"MiB/sec","showUnits":false}}}},{"type":"metric","width":8,"height":6,"x":16,"y":36,"properties":{"view":"timeSeries","title":"Volume
              Read Throughput (Limited to 150 MiB/sec)","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Read","expression":"RATE(count) /
              1048576"}],[{"expression":"SELECT MAX(StorageReadBytes) FROM
              SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOCwithsharedalbstatefuldefinition0CF34EB1' GROUP BY
              TaskId","visible":false,"id":"count"}]],"annotations":{"horizontal":[{"value":150,"label":"Limit","visible":false,"yAxis":"left"}]},"yAxis":{"left":{"label":"MiB/sec","showUnits":false}}}},{"type":"log","width":24,"height":6,"x":0,"y":42,"properties":{"view":"table","title":"Controller
              Logs","region":"region","query":"SOURCE '
            - Ref: withsharedalbcontrollerdefinitioncontrollerLogGroup5AF9B5BD
            - >-
              ' | fields @logStream, @timestamp, level, fields.message,
              target\\n          | sort @timestamp desc\\n          | limit
              500"}}]}
      DashboardName: RestateBYOC_with-shared-alb_metrics
  withsharedalbcontrolpanelF43BDFC4:
    Type: 'AWS::CloudWatch::Dashboard'
    Properties:
      DashboardBody:
        'Fn::Join':
          - ''
          - - >-
              {"widgets":[{"type":"custom","width":24,"height":26,"x":0,"y":0,"properties":{"endpoint":"
            - 'Fn::GetAtt':
                - withsharedalbcloudwatchcustomwidgetlambda64BF84CE
                - Arn
            - '","params":{"command":"controlPanel","input":{"region":"'
            - Ref: 'AWS::Region'
            - >-
              ","summary":{"clusterName":"RestateBYOC/with-shared-alb","restateVersion":"1.3","stackVersion":"0.2.0","metricsDashboardName":"
            - Ref: withsharedalbmetrics9B81E37C
            - '"},"resources":{"ecsClusterArn":"'
            - 'Fn::GetAtt':
                - withsharedalbclusterC111A9F9
                - Arn
            - '","statelessServiceArn":"'
            - Ref: withsharedalbstatelessserviceService9BBF0F9B
            - '","controllerServiceArn":"'
            - Ref: withsharedalbcontrollerserviceServiceC852EDD3
            - '","restatectlLambdaArn":"'
            - 'Fn::GetAtt':
                - withsharedalbrestatectllambda0FCA62E7
                - Arn
            - >-
              "},"connectivityAndSecurity":{"connectivity":{"loadBalancerArns":{"ingress":["
            - Ref: withsharedalb7F233835
            - '"],"admin":["'
            - Ref: withsharedalb7F233835
            - '"]},"addresses":{"ingress":"http://'
            - 'Fn::GetAtt':
                - withsharedalb7F233835
                - DNSName
            - ':8080","admin":"http://'
            - 'Fn::GetAtt':
                - withsharedalb7F233835
                - DNSName
            - ':9070","webUI":"http://'
            - 'Fn::GetAtt':
                - withsharedalb7F233835
                - DNSName
            - ':9070/ui"}},"networking":{"vpc":"'
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcA2121C384D1B3CDE'
            - '","availabilityZones":["dummy1a","dummy1b","dummy1c"],"subnets":["'
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet1Subnet934893E8236E2271'
            - '","'
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet2Subnet7031C2BA60DCB1EE'
            - '","'
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet3Subnet985AC459F9514491'
            - '"]},"security":{"securityGroups":["'
            - 'Fn::GetAtt':
                - withsharedalbsecuritygroup764E6947
                - GroupId
            - '"]}},"storage":{"s3":{"bucket":"'
            - Ref: withsharedalbbucket0B158E57
            - >-
              "}}}},"title":"","updateOn":{"refresh":true,"resize":true,"timeRange":true}}}]}
      DashboardName: RestateBYOC_with-shared-alb_control-panel
  withsharedalbservicedeployerlambdaexecutionrole3C2BA824:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
        Version: '2012-10-17'
  withsharedalbservicedeployerlambdaexecutionroleDefaultPolicy35179AC3:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 'logs:CreateLogGroup'
              - 'logs:CreateLogStream'
              - 'logs:PutLogEvents'
              - 'ec2:CreateNetworkInterface'
              - 'ec2:DescribeNetworkInterfaces'
              - 'ec2:DescribeSubnets'
              - 'ec2:DeleteNetworkInterface'
              - 'ec2:AssignPrivateIpAddresses'
              - 'ec2:UnassignPrivateIpAddresses'
            Effect: Allow
            Resource: '*'
            Sid: AWSLambdaVPCAccessExecutionPermissions
        Version: '2012-10-17'
      PolicyName: withsharedalbservicedeployerlambdaexecutionroleDefaultPolicy35179AC3
      Roles:
        - Ref: withsharedalbservicedeployerlambdaexecutionrole3C2BA824
  withsharedalbservicedeployerEventHandler08B36F69:
    Type: 'AWS::Lambda::Function'
    Properties:
      Architectures:
        - arm64
      Code: Any<Object>
      Description: Restate custom registration handler
      Environment:
        Variables:
          NODE_OPTIONS: '--enable-source-maps'
      Handler: entrypoint.handler
      MemorySize: 128
      Role:
        'Fn::GetAtt':
          - withsharedalbservicedeployerlambdaexecutionrole3C2BA824
          - Arn
      Runtime: nodejs22.x
      Timeout: 180
      VpcConfig:
        SecurityGroupIds:
          - 'Fn::GetAtt':
              - withsharedalbsecuritygroup764E6947
              - GroupId
        SubnetIds:
          - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet1Subnet934893E8236E2271'
          - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet2Subnet7031C2BA60DCB1EE'
          - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet3Subnet985AC459F9514491'
    DependsOn:
      - withsharedalbservicedeployerlambdaexecutionroleDefaultPolicy35179AC3
      - withsharedalbservicedeployerlambdaexecutionrole3C2BA824
  withsharedalbservicedeployerDeploymentLogsF669CD11:
    Type: 'AWS::Logs::LogGroup'
    Properties:
      LogGroupName:
        'Fn::Join':
          - ''
          - - /aws/lambda/
            - Ref: withsharedalbservicedeployerEventHandler08B36F69
      RetentionInDays: 30
    UpdateReplacePolicy: Retain
    DeletionPolicy: RetainExceptOnCreate
"
`;

exports[`BYOC With volume 1`] = `
"Resources:
  withvolumesecuritygroup6DBAA33E:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      GroupDescription: RestateBYOC/with-volume/security-group
      SecurityGroupEgress:
        - CidrIp: 0.0.0.0/0
          Description: Allow all outbound traffic by default
          IpProtocol: '-1'
      Tags:
        - Key: Name
          Value: RestateBYOC/with-volume/security-group
      VpcId:
        'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcA2121C384D1B3CDE'
  withvolumesecuritygroupfromRestateBYOCwithvolumesecuritygroup543DDD29808082ABCD3E:
    Type: 'AWS::EC2::SecurityGroupIngress'
    Properties:
      Description: 'from RestateBYOCwithvolumesecuritygroup543DDD29:8080'
      FromPort: 8080
      GroupId:
        'Fn::GetAtt':
          - withvolumesecuritygroup6DBAA33E
          - GroupId
      IpProtocol: tcp
      SourceSecurityGroupId:
        'Fn::GetAtt':
          - withvolumesecuritygroup6DBAA33E
          - GroupId
      ToPort: 8080
  withvolumesecuritygroupfromRestateBYOCwithvolumesecuritygroup543DDD2990705962AE02:
    Type: 'AWS::EC2::SecurityGroupIngress'
    Properties:
      Description: 'from RestateBYOCwithvolumesecuritygroup543DDD29:9070'
      FromPort: 9070
      GroupId:
        'Fn::GetAtt':
          - withvolumesecuritygroup6DBAA33E
          - GroupId
      IpProtocol: tcp
      SourceSecurityGroupId:
        'Fn::GetAtt':
          - withvolumesecuritygroup6DBAA33E
          - GroupId
      ToPort: 9070
  withvolumesecuritygroupfromRestateBYOCwithvolumesecuritygroup543DDD2951222D7DB9AB:
    Type: 'AWS::EC2::SecurityGroupIngress'
    Properties:
      Description: 'from RestateBYOCwithvolumesecuritygroup543DDD29:5122'
      FromPort: 5122
      GroupId:
        'Fn::GetAtt':
          - withvolumesecuritygroup6DBAA33E
          - GroupId
      IpProtocol: tcp
      SourceSecurityGroupId:
        'Fn::GetAtt':
          - withvolumesecuritygroup6DBAA33E
          - GroupId
      ToPort: 5122
  withvolumebucketE6C6250B:
    Type: 'AWS::S3::Bucket'
    Properties:
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
    UpdateReplacePolicy: Retain
    DeletionPolicy: Retain
  withvolumebucketPolicyCEE43EA3:
    Type: 'AWS::S3::BucketPolicy'
    Properties:
      Bucket:
        Ref: withvolumebucketE6C6250B
      PolicyDocument:
        Statement:
          - Action: 's3:*'
            Condition:
              Bool:
                'aws:SecureTransport': 'false'
            Effect: Deny
            Principal:
              AWS: '*'
            Resource:
              - 'Fn::GetAtt':
                  - withvolumebucketE6C6250B
                  - Arn
              - 'Fn::Join':
                  - ''
                  - - 'Fn::GetAtt':
                        - withvolumebucketE6C6250B
                        - Arn
                    - /*
        Version: '2012-10-17'
  withvolumecluster05BAFA05:
    Type: 'AWS::ECS::Cluster'
    Properties:
      ClusterSettings:
        - Name: containerInsights
          Value: enhanced
      Tags:
        - Key: Name
          Value: RestateBYOC/with-volume/cluster
  withvolumerestatetaskroleEAE4F95E:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
        Version: '2012-10-17'
  withvolumerestatetaskroleDefaultPolicyB2F6578B:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 's3:GetObject'
              - 's3:PutObject'
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'Fn::GetAtt':
                      - withvolumebucketE6C6250B
                      - Arn
                  - /*
            Sid: ReadWriteBucket
          - Action: 's3:ListBucket'
            Effect: Allow
            Resource:
              'Fn::GetAtt':
                - withvolumebucketE6C6250B
                - Arn
            Sid: ListBucket
        Version: '2012-10-17'
      PolicyName: withvolumerestatetaskroleDefaultPolicyB2F6578B
      Roles:
        - Ref: withvolumerestatetaskroleEAE4F95E
  withvolumerestateexecutionroleBCDE318D:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
        Version: '2012-10-17'
  withvolumerestateexecutionroleDefaultPolicy00C7C566:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 'logs:CreateLogStream'
              - 'logs:PutLogEvents'
            Effect: Allow
            Resource:
              'Fn::GetAtt':
                - withvolumestatelessdefinitionrestateLogGroup9C462383
                - Arn
          - Action:
              - 'logs:CreateLogStream'
              - 'logs:PutLogEvents'
            Effect: Allow
            Resource:
              'Fn::GetAtt':
                - withvolumestatefuldefinitionrestateLogGroupD4893BD3
                - Arn
        Version: '2012-10-17'
      PolicyName: withvolumerestateexecutionroleDefaultPolicy00C7C566
      Roles:
        - Ref: withvolumerestateexecutionroleBCDE318D
  withvolumesharednlb4B8218D2:
    Type: 'AWS::ElasticLoadBalancingV2::LoadBalancer'
    Properties:
      LoadBalancerAttributes:
        - Key: deletion_protection.enabled
          Value: 'false'
        - Key: load_balancing.cross_zone.enabled
          Value: 'false'
        - Key: dns_record.client_routing_policy
          Value: availability_zone_affinity
      Scheme: internal
      SecurityGroups:
        - 'Fn::GetAtt':
            - withvolumesecuritygroup6DBAA33E
            - GroupId
      Subnets:
        - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet1Subnet934893E8236E2271'
        - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet2Subnet7031C2BA60DCB1EE'
        - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet3Subnet985AC459F9514491'
      Tags:
        - Key: Name
          Value: RestateBYOC/with-volume/shared-nlb
      Type: network
  withvolumeingresssharedlistener5D7C7189:
    Type: 'AWS::ElasticLoadBalancingV2::Listener'
    Properties:
      DefaultActions:
        - TargetGroupArn:
            Ref: withvolumeingresssharedtarget52F4AFDA
          Type: forward
      LoadBalancerArn:
        Ref: withvolumesharednlb4B8218D2
      Port: 8080
      Protocol: TCP
  withvolumeadminsharedlistenerB71D0323:
    Type: 'AWS::ElasticLoadBalancingV2::Listener'
    Properties:
      DefaultActions:
        - TargetGroupArn:
            Ref: withvolumeadminsharedtargetDB9B03BE
          Type: forward
      LoadBalancerArn:
        Ref: withvolumesharednlb4B8218D2
      Port: 9070
      Protocol: TCP
  withvolumenodesharedlistener3FFE0F43:
    Type: 'AWS::ElasticLoadBalancingV2::Listener'
    Properties:
      DefaultActions:
        - TargetGroupArn:
            Ref: withvolumenodesharedtarget2EC7A630
          Type: forward
      LoadBalancerArn:
        Ref: withvolumesharednlb4B8218D2
      Port: 5122
      Protocol: TCP
  withvolumestatelessdefinition6EEBEF17:
    Type: 'AWS::ECS::TaskDefinition'
    Properties:
      ContainerDefinitions:
        - Cpu: 16384
          EntryPoint:
            - bash
            - '-c'
            - >

              curl --no-progress-meter $ECS_CONTAINER_METADATA_URI_V4/task -o
              task-metadata && \\

              export \\
                RESTATE_NODE_NAME=$(jq -r '.TaskARN' task-metadata) \\
                RESTATE_LOCATION="$AWS_REGION.$(jq -r '.AvailabilityZone' task-metadata)" \\
                RESTATE_ADVERTISED_ADDRESS="http://$(jq -r '.Containers[0].Networks[0].IPv4Addresses[0]' task-metadata):5122"
              exec restate-server
          Environment:
            - Name: RESTATE_LOG_FORMAT
              Value: json
            - Name: RESTATE_CLUSTER_NAME
              Value: RestateBYOC/with-volume
            - Name: RESTATE_ROLES
              Value: '["admin","http-ingress"]'
            - Name: RESTATE_AUTO_PROVISION
              Value: 'true'
            - Name: RESTATE_SHUTDOWN_TIMEOUT
              Value: 100s
            - Name: RESTATE_DEFAULT_NUM_PARTITIONS
              Value: '128'
            - Name: RESTATE_DEFAULT_REPLICATION
              Value: '{zone: 2}'
            - Name: RESTATE_METADATA_CLIENT__TYPE
              Value: object-store
            - Name: RESTATE_METADATA_CLIENT__PATH
              Value:
                'Fn::Join':
                  - ''
                  - - 's3://'
                    - Ref: withvolumebucketE6C6250B
                    - /metadata
            - Name: RESTATE_BIFROST__DEFAULT_PROVIDER
              Value: replicated
            - Name: >-
                RESTATE_INGRESS__EXPERIMENTAL_FEATURE_ENABLE_SEPARATE_INGRESS_ROLE
              Value: 'true'
            - Name: RESTATE_INGRESS__ADVERTISED_INGRESS_ENDPOINT
              Value:
                'Fn::Join':
                  - ''
                  - - 'http://'
                    - 'Fn::GetAtt':
                        - withvolumesharednlb4B8218D2
                        - DNSName
                    - ':8080'
            - Name: RESTATE_WORKER__SNAPSHOTS__DESTINATION
              Value:
                'Fn::Join':
                  - ''
                  - - 's3://'
                    - Ref: withvolumebucketE6C6250B
                    - /snapshots
          Essential: true
          HealthCheck:
            Command:
              - CMD
              - curl
              - '--fail'
              - 'http://127.0.0.1:8080/restate/health'
            Interval: 30
            Retries: 3
            Timeout: 5
          Image: Any<Object>
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group:
                Ref: withvolumestatelessdefinitionrestateLogGroup9C462383
              awslogs-stream-prefix: restate
              awslogs-region: region
          Memory: 32768
          Name: restate
          PortMappings:
            - ContainerPort: 8080
              Name: ingress
              Protocol: tcp
            - ContainerPort: 9070
              Name: admin
              Protocol: tcp
            - ContainerPort: 5122
              Name: node
              Protocol: tcp
          StopTimeout: 120
      Cpu: '16384'
      ExecutionRoleArn:
        'Fn::GetAtt':
          - withvolumerestateexecutionroleBCDE318D
          - Arn
      Family: RestateBYOCwithvolumestatelessdefinition93235A6B
      Memory: '32768'
      NetworkMode: awsvpc
      RequiresCompatibilities:
        - FARGATE
      RuntimePlatform:
        CpuArchitecture: ARM64
        OperatingSystemFamily: LINUX
      Tags:
        - Key: Name
          Value: RestateBYOC/with-volume/stateless-definition
      TaskRoleArn:
        'Fn::GetAtt':
          - withvolumerestatetaskroleEAE4F95E
          - Arn
  withvolumestatelessdefinitionrestateLogGroup9C462383:
    Type: 'AWS::Logs::LogGroup'
    Properties:
      Tags:
        - Key: Name
          Value: RestateBYOC/with-volume/stateless-definition
    UpdateReplacePolicy: Retain
    DeletionPolicy: Retain
  withvolumestatelessserviceServiceDCB5849A:
    Type: 'AWS::ECS::Service'
    Properties:
      Cluster:
        Ref: withvolumecluster05BAFA05
      DeploymentConfiguration:
        Alarms:
          AlarmNames: []
          Enable: false
          Rollback: false
        MaximumPercent: 200
        MinimumHealthyPercent: 100
      DesiredCount: 3
      EnableECSManagedTags: false
      EnableExecuteCommand: false
      HealthCheckGracePeriodSeconds: 60
      LaunchType: FARGATE
      LoadBalancers:
        - ContainerName: restate
          ContainerPort: 8080
          TargetGroupArn:
            Ref: withvolumeingresssharedtarget52F4AFDA
        - ContainerName: restate
          ContainerPort: 9070
          TargetGroupArn:
            Ref: withvolumeadminsharedtargetDB9B03BE
        - ContainerName: restate
          ContainerPort: 5122
          TargetGroupArn:
            Ref: withvolumenodesharedtarget2EC7A630
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: DISABLED
          SecurityGroups:
            - 'Fn::GetAtt':
                - withvolumesecuritygroup6DBAA33E
                - GroupId
          Subnets:
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet1Subnet934893E8236E2271'
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet2Subnet7031C2BA60DCB1EE'
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet3Subnet985AC459F9514491'
      PropagateTags: SERVICE
      Tags:
        - Key: Name
          Value: RestateBYOC/with-volume/stateless-service
      TaskDefinition:
        Ref: withvolumestatelessdefinition6EEBEF17
    DependsOn:
      - withvolumeadminsharedlistenerB71D0323
      - withvolumeingresssharedlistener5D7C7189
      - withvolumenodesharedlistener3FFE0F43
      - withvolumerestatetaskroleDefaultPolicyB2F6578B
      - withvolumerestatetaskroleEAE4F95E
  withvolumestatefuldefinitionF7A5C84B:
    Type: 'AWS::ECS::TaskDefinition'
    Properties:
      ContainerDefinitions:
        - Cpu: 16384
          EntryPoint:
            - bash
            - '-c'
            - >

              curl --no-progress-meter $ECS_CONTAINER_METADATA_URI_V4/task -o
              task-metadata && \\

              export \\
                RESTATE_NODE_NAME=$(jq -r '.TaskARN' task-metadata) \\
                RESTATE_LOCATION="$AWS_REGION.$(jq -r '.AvailabilityZone' task-metadata)" \\
                RESTATE_ADVERTISED_ADDRESS="http://$(jq -r '.Containers[0].Networks[0].IPv4Addresses[0]' task-metadata):5122"
              exec restate-server
          Environment:
            - Name: RESTATE_LOG_FORMAT
              Value: json
            - Name: RESTATE_CLUSTER_NAME
              Value: RestateBYOC/with-volume
            - Name: RESTATE_ROLES
              Value: '["log-server", "worker"]'
            - Name: RESTATE_AUTO_PROVISION
              Value: 'false'
            - Name: RESTATE_SHUTDOWN_TIMEOUT
              Value: 100s
            - Name: RESTATE_ROCKSDB_TOTAL_MEMORY_SIZE
              Value: 24576MiB
            - Name: RESTATE_METADATA_CLIENT__TYPE
              Value: object-store
            - Name: RESTATE_METADATA_CLIENT__PATH
              Value:
                'Fn::Join':
                  - ''
                  - - 's3://'
                    - Ref: withvolumebucketE6C6250B
                    - /metadata
            - Name: RESTATE_WORKER__SNAPSHOTS__DESTINATION
              Value:
                'Fn::Join':
                  - ''
                  - - 's3://'
                    - Ref: withvolumebucketE6C6250B
                    - /snapshots
            - Name: RESTATE_WORKER__SNAPSHOTS__SNAPSHOT_INTERVAL_NUM_RECORDS
              Value: '1000000'
            - Name: RESTATE_WORKER__STORAGE__ROCKSDB_DISABLE_DIRECT_IO_FOR_READS
              Value: 'true'
            - Name: RESTATE_WORKER__STORAGE__ROCKSDB_DISABLE_WAL_FSYNC
              Value: 'true'
            - Name: RESTATE_LOG_SERVER__ROCKSDB_DISABLE_WAL_FSYNC
              Value: 'true'
            - Name: RESTATE_LOG_SERVER__ROCKSDB_DISABLE_DIRECT_IO_FOR_READS
              Value: 'true'
            - Name: >-
                RESTATE_INGRESS__EXPERIMENTAL_FEATURE_ENABLE_SEPARATE_INGRESS_ROLE
              Value: 'true'
          Essential: true
          HealthCheck:
            Command:
              - CMD
              - curl
              - '--fail'
              - 'http://127.0.0.1:5122/health'
            Interval: 30
            Retries: 3
            Timeout: 5
          Image: Any<Object>
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group:
                Ref: withvolumestatefuldefinitionrestateLogGroupD4893BD3
              awslogs-stream-prefix: restate
              awslogs-region: region
          Memory: 32768
          MountPoints:
            - ContainerPath: /restate-data
              ReadOnly: false
              SourceVolume: restate-data
          Name: restate
          PortMappings:
            - ContainerPort: 5122
              Name: node
              Protocol: tcp
          RestartPolicy:
            Enabled: true
            RestartAttemptPeriod: 60
          StopTimeout: 120
      Cpu: '16384'
      ExecutionRoleArn:
        'Fn::GetAtt':
          - withvolumerestateexecutionroleBCDE318D
          - Arn
      Family: RestateBYOCwithvolumestatefuldefinition4F5A9794
      Memory: '32768'
      NetworkMode: awsvpc
      RequiresCompatibilities:
        - FARGATE
      RuntimePlatform:
        CpuArchitecture: ARM64
        OperatingSystemFamily: LINUX
      Tags:
        - Key: Name
          Value: RestateBYOC/with-volume/stateful-definition
      TaskRoleArn:
        'Fn::GetAtt':
          - withvolumerestatetaskroleEAE4F95E
          - Arn
      Volumes:
        - ConfiguredAtLaunch: true
          Name: restate-data
  withvolumestatefuldefinitionrestateLogGroupD4893BD3:
    Type: 'AWS::Logs::LogGroup'
    Properties:
      Tags:
        - Key: Name
          Value: RestateBYOC/with-volume/stateful-definition
    UpdateReplacePolicy: Retain
    DeletionPolicy: Retain
  withvolumeingresssharedtarget52F4AFDA:
    Type: 'AWS::ElasticLoadBalancingV2::TargetGroup'
    Properties:
      HealthCheckEnabled: true
      HealthCheckIntervalSeconds: 5
      HealthCheckPath: /restate/health
      HealthCheckProtocol: HTTP
      HealthCheckTimeoutSeconds: 2
      Port: 8080
      Protocol: TCP
      Tags:
        - Key: Name
          Value: RestateBYOC/with-volume/ingress-shared-target
      TargetType: ip
      VpcId:
        'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcA2121C384D1B3CDE'
  withvolumeadminsharedtargetDB9B03BE:
    Type: 'AWS::ElasticLoadBalancingV2::TargetGroup'
    Properties:
      HealthCheckEnabled: true
      HealthCheckIntervalSeconds: 5
      HealthCheckPath: /health
      HealthCheckPort: '9070'
      HealthCheckProtocol: HTTP
      HealthCheckTimeoutSeconds: 2
      Port: 9070
      Protocol: TCP
      Tags:
        - Key: Name
          Value: RestateBYOC/with-volume/admin-shared-target
      TargetType: ip
      VpcId:
        'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcA2121C384D1B3CDE'
  withvolumenodesharedtarget2EC7A630:
    Type: 'AWS::ElasticLoadBalancingV2::TargetGroup'
    Properties:
      HealthCheckEnabled: true
      HealthCheckIntervalSeconds: 5
      HealthCheckPath: /health
      HealthCheckPort: '5122'
      HealthCheckProtocol: HTTP
      HealthCheckTimeoutSeconds: 2
      Port: 5122
      Protocol: TCP
      Tags:
        - Key: Name
          Value: RestateBYOC/with-volume/node-shared-target
      TargetType: ip
      VpcId:
        'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcA2121C384D1B3CDE'
  withvolumecontrollertaskrole96D31345:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
        Version: '2012-10-17'
  withvolumecontrollertaskroleDefaultPolicyCC286394:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 'ecs:ListTasks'
              - 'ecs:DescribeTasks'
              - 'ecs:StopTask'
            Condition:
              ArnEquals:
                'ecs:cluster':
                  'Fn::GetAtt':
                    - withvolumecluster05BAFA05
                    - Arn
            Effect: Allow
            Resource: '*'
            Sid: TaskActions
          - Action: 'ecs:TagResource'
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'Fn::Join':
                      - /
                      - - 'Fn::Join':
                            - ':'
                            - - 'Fn::Select':
                                  - 0
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - withvolumecluster05BAFA05
                                                  - Arn
                              - 'Fn::Select':
                                  - 1
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - withvolumecluster05BAFA05
                                                  - Arn
                              - 'Fn::Select':
                                  - 2
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - withvolumecluster05BAFA05
                                                  - Arn
                              - 'Fn::Select':
                                  - 3
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - withvolumecluster05BAFA05
                                                  - Arn
                              - 'Fn::Select':
                                  - 4
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - withvolumecluster05BAFA05
                                                  - Arn
                              - task
                        - 'Fn::Select':
                            - 1
                            - 'Fn::Split':
                                - /
                                - 'Fn::GetAtt':
                                    - withvolumecluster05BAFA05
                                    - Arn
                        - ''
                  - '*'
            Sid: TagTasks
          - Action: 'ecs:RunTask'
            Condition:
              ArnEquals:
                'ecs:cluster':
                  'Fn::GetAtt':
                    - withvolumecluster05BAFA05
                    - Arn
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'Fn::Join':
                      - ':'
                      - - 'Fn::Select':
                            - 0
                            - 'Fn::Split':
                                - ':'
                                - Ref: withvolumestatefuldefinitionF7A5C84B
                        - 'Fn::Select':
                            - 1
                            - 'Fn::Split':
                                - ':'
                                - Ref: withvolumestatefuldefinitionF7A5C84B
                        - 'Fn::Select':
                            - 2
                            - 'Fn::Split':
                                - ':'
                                - Ref: withvolumestatefuldefinitionF7A5C84B
                        - 'Fn::Select':
                            - 3
                            - 'Fn::Split':
                                - ':'
                                - Ref: withvolumestatefuldefinitionF7A5C84B
                        - 'Fn::Select':
                            - 4
                            - 'Fn::Split':
                                - ':'
                                - Ref: withvolumestatefuldefinitionF7A5C84B
                        - 'Fn::Select':
                            - 5
                            - 'Fn::Split':
                                - ':'
                                - Ref: withvolumestatefuldefinitionF7A5C84B
                  - ':*'
            Sid: RunTask
          - Action: 'iam:PassRole'
            Condition:
              StringEquals:
                'iam:PassedToService': ecs-tasks.amazonaws.com
            Effect: Allow
            Resource:
              - 'Fn::GetAtt':
                  - withvolumerestatetaskroleEAE4F95E
                  - Arn
              - 'Fn::GetAtt':
                  - withvolumerestateexecutionroleBCDE318D
                  - Arn
            Sid: RunTaskPassRole
          - Action: 'iam:PassRole'
            Condition:
              StringEquals:
                'iam:PassedToService': ecs.amazonaws.com
            Effect: Allow
            Resource:
              'Fn::GetAtt':
                - withvolumevolumerole7B81BA6D
                - Arn
            Sid: RunTaskPassVolumeRole
          - Action:
              - 's3:GetObject'
              - 's3:PutObject'
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'Fn::GetAtt':
                      - withvolumebucketE6C6250B
                      - Arn
                  - /*
            Sid: ReadWriteBucket
          - Action: 's3:ListBucket'
            Effect: Allow
            Resource:
              'Fn::GetAtt':
                - withvolumebucketE6C6250B
                - Arn
            Sid: ListBucket
        Version: '2012-10-17'
      PolicyName: withvolumecontrollertaskroleDefaultPolicyCC286394
      Roles:
        - Ref: withvolumecontrollertaskrole96D31345
  withvolumecontrollerexecutionrole2832B829:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
        Version: '2012-10-17'
  withvolumecontrollerexecutionroleDefaultPolicyEE2C9936:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 'logs:CreateLogStream'
              - 'logs:PutLogEvents'
            Effect: Allow
            Resource:
              'Fn::GetAtt':
                - withvolumecontrollerdefinitioncontrollerLogGroupF7CEE299
                - Arn
        Version: '2012-10-17'
      PolicyName: withvolumecontrollerexecutionroleDefaultPolicyEE2C9936
      Roles:
        - Ref: withvolumecontrollerexecutionrole2832B829
  withvolumecontrollerdefinitionD81EB134:
    Type: 'AWS::ECS::TaskDefinition'
    Properties:
      ContainerDefinitions:
        - Cpu: 1024
          Environment:
            - Name: RUST_LOG
              Value: 'info,restate_fargate_controller=debug'
            - Name: CONTROLLER_LOG_FORMAT
              Value: json
            - Name: CONTROLLER_METADATA_PATH
              Value:
                'Fn::Join':
                  - ''
                  - - 's3://'
                    - Ref: withvolumebucketE6C6250B
                    - /metadata
            - Name: CONTROLLER_RECONCILE_INTERVAL
              Value: 10s
            - Name: CONTROLLER_CLUSTER__CLUSTER_ARN
              Value:
                'Fn::GetAtt':
                  - withvolumecluster05BAFA05
                  - Arn
            - Name: CONTROLLER_LICENSE_ID
              Value: foo
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __REGION
              Value:
                Ref: 'AWS::Region'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __CLUSTER_ARN
              Value:
                'Fn::GetAtt':
                  - withvolumecluster05BAFA05
                  - Arn
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __TASK_PREFIX
              Value:
                'Fn::Join':
                  - /
                  - - 'Fn::Join':
                        - ':'
                        - - 'Fn::Select':
                              - 0
                              - 'Fn::Split':
                                  - ':'
                                  - 'Fn::Select':
                                      - 0
                                      - 'Fn::Split':
                                          - /
                                          - 'Fn::GetAtt':
                                              - withvolumecluster05BAFA05
                                              - Arn
                          - 'Fn::Select':
                              - 1
                              - 'Fn::Split':
                                  - ':'
                                  - 'Fn::Select':
                                      - 0
                                      - 'Fn::Split':
                                          - /
                                          - 'Fn::GetAtt':
                                              - withvolumecluster05BAFA05
                                              - Arn
                          - 'Fn::Select':
                              - 2
                              - 'Fn::Split':
                                  - ':'
                                  - 'Fn::Select':
                                      - 0
                                      - 'Fn::Split':
                                          - /
                                          - 'Fn::GetAtt':
                                              - withvolumecluster05BAFA05
                                              - Arn
                          - 'Fn::Select':
                              - 3
                              - 'Fn::Split':
                                  - ':'
                                  - 'Fn::Select':
                                      - 0
                                      - 'Fn::Split':
                                          - /
                                          - 'Fn::GetAtt':
                                              - withvolumecluster05BAFA05
                                              - Arn
                          - 'Fn::Select':
                              - 4
                              - 'Fn::Split':
                                  - ':'
                                  - 'Fn::Select':
                                      - 0
                                      - 'Fn::Split':
                                          - /
                                          - 'Fn::GetAtt':
                                              - withvolumecluster05BAFA05
                                              - Arn
                          - task
                    - 'Fn::Select':
                        - 1
                        - 'Fn::Split':
                            - /
                            - 'Fn::GetAtt':
                                - withvolumecluster05BAFA05
                                - Arn
                    - ''
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1a__VOLUME__SIZE_IN_GIB
              Value: '200'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1a__VOLUME__ROLE_ARN
              Value:
                'Fn::GetAtt':
                  - withvolumevolumerole7B81BA6D
                  - Arn
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1a__VOLUME__VOLUME_TYPE
              Value: gp3
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1a__VOLUME__NAME
              Value: restate-data
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1a__ENABLE_EXECUTE_COMMAND
              Value: 'false'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1a__SECURITY_GROUPS
              Value:
                'Fn::Join':
                  - ''
                  - - '["'
                    - 'Fn::GetAtt':
                        - withvolumesecuritygroup6DBAA33E
                        - GroupId
                    - '"]'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1a__SUBNETS
              Value:
                'Fn::Join':
                  - ''
                  - - '["'
                    - 'Fn::ImportValue': >-
                        VPCStack:ExportsOutputRefvpcPrivateSubnet1Subnet934893E8236E2271
                    - '"]'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1a__TASK_DEFINITION_ARN
              Value:
                Ref: withvolumestatefuldefinitionF7A5C84B
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1a__COUNT
              Value: '1'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1b__VOLUME__SIZE_IN_GIB
              Value: '200'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1b__VOLUME__ROLE_ARN
              Value:
                'Fn::GetAtt':
                  - withvolumevolumerole7B81BA6D
                  - Arn
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1b__VOLUME__VOLUME_TYPE
              Value: gp3
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1b__VOLUME__NAME
              Value: restate-data
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1b__ENABLE_EXECUTE_COMMAND
              Value: 'false'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1b__SECURITY_GROUPS
              Value:
                'Fn::Join':
                  - ''
                  - - '["'
                    - 'Fn::GetAtt':
                        - withvolumesecuritygroup6DBAA33E
                        - GroupId
                    - '"]'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1b__SUBNETS
              Value:
                'Fn::Join':
                  - ''
                  - - '["'
                    - 'Fn::ImportValue': >-
                        VPCStack:ExportsOutputRefvpcPrivateSubnet2Subnet7031C2BA60DCB1EE
                    - '"]'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1b__TASK_DEFINITION_ARN
              Value:
                Ref: withvolumestatefuldefinitionF7A5C84B
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1b__COUNT
              Value: '1'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1c__VOLUME__SIZE_IN_GIB
              Value: '200'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1c__VOLUME__ROLE_ARN
              Value:
                'Fn::GetAtt':
                  - withvolumevolumerole7B81BA6D
                  - Arn
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1c__VOLUME__VOLUME_TYPE
              Value: gp3
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1c__VOLUME__NAME
              Value: restate-data
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1c__ENABLE_EXECUTE_COMMAND
              Value: 'false'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1c__SECURITY_GROUPS
              Value:
                'Fn::Join':
                  - ''
                  - - '["'
                    - 'Fn::GetAtt':
                        - withvolumesecuritygroup6DBAA33E
                        - GroupId
                    - '"]'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1c__SUBNETS
              Value:
                'Fn::Join':
                  - ''
                  - - '["'
                    - 'Fn::ImportValue': >-
                        VPCStack:ExportsOutputRefvpcPrivateSubnet3Subnet985AC459F9514491
                    - '"]'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1c__TASK_DEFINITION_ARN
              Value:
                Ref: withvolumestatefuldefinitionF7A5C84B
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1c__COUNT
              Value: '1'
          Essential: true
          HealthCheck:
            Command:
              - CMD
              - curl
              - '--fail'
              - 'http://127.0.0.1:8080/health'
            Interval: 30
            Retries: 10
            StartPeriod: 300
            Timeout: 5
          Image: Any<Object>
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group:
                Ref: withvolumecontrollerdefinitioncontrollerLogGroupF7CEE299
              awslogs-stream-prefix: controller
              awslogs-region: region
          Memory: 2048
          Name: controller
          StopTimeout: 120
      Cpu: '1024'
      ExecutionRoleArn:
        'Fn::GetAtt':
          - withvolumecontrollerexecutionrole2832B829
          - Arn
      Family: RestateBYOCwithvolumecontrollerdefinitionC10AEDF7
      Memory: '2048'
      NetworkMode: awsvpc
      RequiresCompatibilities:
        - FARGATE
      RuntimePlatform:
        CpuArchitecture: ARM64
        OperatingSystemFamily: LINUX
      Tags:
        - Key: Name
          Value: RestateBYOC/with-volume/controller-definition
      TaskRoleArn:
        'Fn::GetAtt':
          - withvolumecontrollertaskrole96D31345
          - Arn
  withvolumecontrollerdefinitioncontrollerLogGroupF7CEE299:
    Type: 'AWS::Logs::LogGroup'
    Properties:
      Tags:
        - Key: Name
          Value: RestateBYOC/with-volume/controller-definition
    UpdateReplacePolicy: Retain
    DeletionPolicy: Retain
  withvolumevolumerole7B81BA6D:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: ecs.amazonaws.com
        Version: '2012-10-17'
      Policies:
        - PolicyDocument:
            Statement:
              - Action: 'ec2:CreateVolume'
                Condition:
                  ArnLike:
                    'aws:RequestTag/AmazonECSCreated':
                      'Fn::Join':
                        - ''
                        - - 'arn:'
                          - Ref: 'AWS::Partition'
                          - ':ecs:'
                          - Ref: 'AWS::Region'
                          - ':'
                          - Ref: 'AWS::AccountId'
                          - ':task/*'
                  StringEquals:
                    'aws:RequestTag/AmazonECSManaged': 'true'
                Effect: Allow
                Resource:
                  'Fn::Join':
                    - ''
                    - - 'arn:'
                      - Ref: 'AWS::Partition'
                      - ':ec2:'
                      - Ref: 'AWS::Region'
                      - ':'
                      - Ref: 'AWS::AccountId'
                      - ':volume/*'
                Sid: CreateEBSManagedVolume
              - Action: 'ec2:CreateTags'
                Condition:
                  ArnLike:
                    'aws:RequestTag/AmazonECSCreated':
                      'Fn::Join':
                        - ''
                        - - 'arn:'
                          - Ref: 'AWS::Partition'
                          - ':ecs:'
                          - Ref: 'AWS::Region'
                          - ':'
                          - Ref: 'AWS::AccountId'
                          - ':task/*'
                  StringEquals:
                    'ec2:CreateAction': CreateVolume
                    'aws:RequestTag/AmazonECSManaged': 'true'
                Effect: Allow
                Resource:
                  'Fn::Join':
                    - ''
                    - - 'arn:'
                      - Ref: 'AWS::Partition'
                      - ':ec2:'
                      - Ref: 'AWS::Region'
                      - ':'
                      - Ref: 'AWS::AccountId'
                      - ':volume/*'
                Sid: TagOnCreateVolume
              - Action:
                  - 'ec2:DescribeVolumes'
                  - 'ec2:DescribeAvailabilityZones'
                Condition:
                  StringEquals:
                    'ec2:Region':
                      Ref: 'AWS::Region'
                Effect: Allow
                Resource: '*'
                Sid: DescribeVolumesForLifecycle
              - Action:
                  - 'ec2:AttachVolume'
                  - 'ec2:DetachVolume'
                Condition:
                  StringEquals:
                    'aws:ResourceTag/AmazonECSManaged': 'true'
                Effect: Allow
                Resource:
                  'Fn::Join':
                    - ''
                    - - 'arn:'
                      - Ref: 'AWS::Partition'
                      - ':ec2:'
                      - Ref: 'AWS::Region'
                      - ':'
                      - Ref: 'AWS::AccountId'
                      - ':volume/*'
                Sid: ManageEBSVolumeLifecycle
              - Action:
                  - 'ec2:AttachVolume'
                  - 'ec2:DetachVolume'
                Effect: Allow
                Resource:
                  'Fn::Join':
                    - ''
                    - - 'arn:'
                      - Ref: 'AWS::Partition'
                      - ':ec2:'
                      - Ref: 'AWS::Region'
                      - ':*:instance/*'
                Sid: ManageVolumeAttachmentsForEC2
              - Action: 'ec2:DeleteVolume'
                Condition:
                  ArnLike:
                    'aws:ResourceTag/AmazonECSCreated':
                      'Fn::Join':
                        - ''
                        - - 'arn:'
                          - Ref: 'AWS::Partition'
                          - ':ecs:'
                          - Ref: 'AWS::Region'
                          - ':'
                          - Ref: 'AWS::AccountId'
                          - ':task/*'
                  StringEquals:
                    'aws:ResourceTag/AmazonECSManaged': 'true'
                Effect: Allow
                Resource:
                  'Fn::Join':
                    - ''
                    - - 'arn:'
                      - Ref: 'AWS::Partition'
                      - ':ec2:'
                      - Ref: 'AWS::Region'
                      - ':'
                      - Ref: 'AWS::AccountId'
                      - ':volume/*'
                Sid: DeleteEBSManagedVolume
            Version: '2012-10-17'
          PolicyName: volume
      Tags:
        - Key: Name
          Value: RestateBYOC/with-volume/volume-role
    UpdateReplacePolicy: Retain
    DeletionPolicy: Retain
  withvolumecontrollerserviceService047527E7:
    Type: 'AWS::ECS::Service'
    Properties:
      Cluster:
        Ref: withvolumecluster05BAFA05
      DeploymentConfiguration:
        Alarms:
          AlarmNames: []
          Enable: false
          Rollback: false
        MaximumPercent: 100
        MinimumHealthyPercent: 0
      DesiredCount: 1
      EnableECSManagedTags: false
      EnableExecuteCommand: false
      LaunchType: FARGATE
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: DISABLED
          SecurityGroups:
            - 'Fn::GetAtt':
                - withvolumesecuritygroup6DBAA33E
                - GroupId
          Subnets:
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet1Subnet934893E8236E2271'
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet2Subnet7031C2BA60DCB1EE'
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet3Subnet985AC459F9514491'
      Tags:
        - Key: Name
          Value: RestateBYOC/with-volume/controller-service
      TaskDefinition:
        Ref: withvolumecontrollerdefinitionD81EB134
    DependsOn:
      - withvolumecontrollertaskroleDefaultPolicyCC286394
      - withvolumecontrollertaskrole96D31345
  withvolumerestatectllambdaexecutionrole9F033DC5:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
        Version: '2012-10-17'
  withvolumerestatectllambdaexecutionroleDefaultPolicy04A6D03E:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 'logs:CreateLogGroup'
              - 'logs:CreateLogStream'
              - 'logs:PutLogEvents'
              - 'ec2:CreateNetworkInterface'
              - 'ec2:DescribeNetworkInterfaces'
              - 'ec2:DescribeSubnets'
              - 'ec2:DeleteNetworkInterface'
              - 'ec2:AssignPrivateIpAddresses'
              - 'ec2:UnassignPrivateIpAddresses'
            Effect: Allow
            Resource: '*'
            Sid: AWSLambdaVPCAccessExecutionPermissions
        Version: '2012-10-17'
      PolicyName: withvolumerestatectllambdaexecutionroleDefaultPolicy04A6D03E
      Roles:
        - Ref: withvolumerestatectllambdaexecutionrole9F033DC5
  withvolumerestatectllambdaE21E648A:
    Type: 'AWS::Lambda::Function'
    Properties:
      Architectures:
        - arm64
      Code: Any<Object>
      Environment:
        Variables:
          RESTATECTL_ADDRESS:
            'Fn::Join':
              - ''
              - - 'http://'
                - 'Fn::GetAtt':
                    - withvolumesharednlb4B8218D2
                    - DNSName
                - ':5122'
      Handler: restatectl
      Role:
        'Fn::GetAtt':
          - withvolumerestatectllambdaexecutionrole9F033DC5
          - Arn
      Runtime: provided.al2023
      Tags:
        - Key: Name
          Value: RestateBYOC/with-volume/restatectl-lambda
      Timeout: 10
      VpcConfig:
        SecurityGroupIds:
          - 'Fn::GetAtt':
              - withvolumesecuritygroup6DBAA33E
              - GroupId
        SubnetIds:
          - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet1Subnet934893E8236E2271'
          - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet2Subnet7031C2BA60DCB1EE'
          - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet3Subnet985AC459F9514491'
    DependsOn:
      - withvolumerestatectllambdaexecutionroleDefaultPolicy04A6D03E
      - withvolumerestatectllambdaexecutionrole9F033DC5
  withvolumeretirementwatcherlambdaexecutionrole1CF7FED2:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
        Version: '2012-10-17'
  withvolumeretirementwatcherlambdaexecutionroleDefaultPolicy7190CB45:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 'logs:CreateLogGroup'
              - 'logs:CreateLogStream'
              - 'logs:PutLogEvents'
            Effect: Allow
            Resource: '*'
            Sid: AWSLambdaBasicExecutionPermissions
          - Action: 'ecs:TagResource'
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'Fn::Join':
                      - /
                      - - 'Fn::Join':
                            - ':'
                            - - 'Fn::Select':
                                  - 0
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - withvolumecluster05BAFA05
                                                  - Arn
                              - 'Fn::Select':
                                  - 1
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - withvolumecluster05BAFA05
                                                  - Arn
                              - 'Fn::Select':
                                  - 2
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - withvolumecluster05BAFA05
                                                  - Arn
                              - 'Fn::Select':
                                  - 3
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - withvolumecluster05BAFA05
                                                  - Arn
                              - 'Fn::Select':
                                  - 4
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - withvolumecluster05BAFA05
                                                  - Arn
                              - task
                        - 'Fn::Select':
                            - 1
                            - 'Fn::Split':
                                - /
                                - 'Fn::GetAtt':
                                    - withvolumecluster05BAFA05
                                    - Arn
                        - ''
                  - '*'
            Sid: TagTasks
          - Action:
              - 'sqs:ReceiveMessage'
              - 'sqs:ChangeMessageVisibility'
              - 'sqs:GetQueueUrl'
              - 'sqs:DeleteMessage'
              - 'sqs:GetQueueAttributes'
            Effect: Allow
            Resource:
              'Fn::GetAtt':
                - withvolumeretirementwatcherqueue8056CC91
                - Arn
        Version: '2012-10-17'
      PolicyName: withvolumeretirementwatcherlambdaexecutionroleDefaultPolicy7190CB45
      Roles:
        - Ref: withvolumeretirementwatcherlambdaexecutionrole1CF7FED2
  withvolumeretirementwatcherlambda4701EE8D:
    Type: 'AWS::Lambda::Function'
    Properties:
      Architectures:
        - arm64
      Code: Any<Object>
      Handler: index.handler
      Role:
        'Fn::GetAtt':
          - withvolumeretirementwatcherlambdaexecutionrole1CF7FED2
          - Arn
      Runtime: nodejs22.x
      Tags:
        - Key: Name
          Value: RestateBYOC/with-volume/retirement-watcher-lambda
      Timeout: 60
    DependsOn:
      - withvolumeretirementwatcherlambdaexecutionroleDefaultPolicy7190CB45
      - withvolumeretirementwatcherlambdaexecutionrole1CF7FED2
  withvolumeretirementwatcherlambdaSqsEventSourceRestateBYOCwithvolumeretirementwatcherqueue7DC965034656E297:
    Type: 'AWS::Lambda::EventSourceMapping'
    Properties:
      BatchSize: 1
      EventSourceArn:
        'Fn::GetAtt':
          - withvolumeretirementwatcherqueue8056CC91
          - Arn
      FunctionName:
        Ref: withvolumeretirementwatcherlambda4701EE8D
      Tags:
        - Key: Name
          Value: RestateBYOC/with-volume/retirement-watcher-lambda
  withvolumeretirementwatcherqueue8056CC91:
    Type: 'AWS::SQS::Queue'
    Properties:
      Tags:
        - Key: Name
          Value: RestateBYOC/with-volume/retirement-watcher-queue
      VisibilityTimeout: 60
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  withvolumeretirementwatcherqueuePolicy07BC8FFE:
    Type: 'AWS::SQS::QueuePolicy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 'sqs:SendMessage'
              - 'sqs:GetQueueAttributes'
              - 'sqs:GetQueueUrl'
            Condition:
              ArnEquals:
                'aws:SourceArn':
                  'Fn::GetAtt':
                    - withvolumeretirementwatcherrule8C23936A
                    - Arn
            Effect: Allow
            Principal:
              Service: events.amazonaws.com
            Resource:
              'Fn::GetAtt':
                - withvolumeretirementwatcherqueue8056CC91
                - Arn
        Version: '2012-10-17'
      Queues:
        - Ref: withvolumeretirementwatcherqueue8056CC91
  withvolumeretirementwatcherrule8C23936A:
    Type: 'AWS::Events::Rule'
    Properties:
      EventPattern:
        detail:
          eventTypeCode:
            - equals-ignore-case: AWS_ECS_TASK_PATCHING_RETIREMENT
          service:
            - equals-ignore-case: ecs
        resources:
          - prefix:
              'Fn::Join':
                - /
                - - 'Fn::Join':
                      - ':'
                      - - 'Fn::Select':
                            - 0
                            - 'Fn::Split':
                                - ':'
                                - 'Fn::Select':
                                    - 0
                                    - 'Fn::Split':
                                        - /
                                        - 'Fn::GetAtt':
                                            - withvolumecluster05BAFA05
                                            - Arn
                        - 'Fn::Select':
                            - 1
                            - 'Fn::Split':
                                - ':'
                                - 'Fn::Select':
                                    - 0
                                    - 'Fn::Split':
                                        - /
                                        - 'Fn::GetAtt':
                                            - withvolumecluster05BAFA05
                                            - Arn
                        - 'Fn::Select':
                            - 2
                            - 'Fn::Split':
                                - ':'
                                - 'Fn::Select':
                                    - 0
                                    - 'Fn::Split':
                                        - /
                                        - 'Fn::GetAtt':
                                            - withvolumecluster05BAFA05
                                            - Arn
                        - 'Fn::Select':
                            - 3
                            - 'Fn::Split':
                                - ':'
                                - 'Fn::Select':
                                    - 0
                                    - 'Fn::Split':
                                        - /
                                        - 'Fn::GetAtt':
                                            - withvolumecluster05BAFA05
                                            - Arn
                        - 'Fn::Select':
                            - 4
                            - 'Fn::Split':
                                - ':'
                                - 'Fn::Select':
                                    - 0
                                    - 'Fn::Split':
                                        - /
                                        - 'Fn::GetAtt':
                                            - withvolumecluster05BAFA05
                                            - Arn
                        - task
                  - 'Fn::Select':
                      - 1
                      - 'Fn::Split':
                          - /
                          - 'Fn::GetAtt':
                              - withvolumecluster05BAFA05
                              - Arn
                  - ''
        detail-type:
          - equals-ignore-case: AWS Health Event
      State: ENABLED
      Targets:
        - Arn:
            'Fn::GetAtt':
              - withvolumeretirementwatcherqueue8056CC91
              - Arn
          Id: Target0
  withvolumecloudwatchcustomwidgetexecutionrole973DB43A:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
        Version: '2012-10-17'
  withvolumecloudwatchcustomwidgetexecutionroleDefaultPolicy393C3D88:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 'logs:CreateLogGroup'
              - 'logs:CreateLogStream'
              - 'logs:PutLogEvents'
            Effect: Allow
            Resource: '*'
            Sid: AWSLambdaBasicExecutionPermissions
          - Action: 'lambda:InvokeFunction'
            Effect: Allow
            Resource:
              'Fn::GetAtt':
                - withvolumerestatectllambdaE21E648A
                - Arn
            Sid: InvokeRestatectl
          - Action:
              - 'ec2:DescribeVolumes'
              - 'ec2:DescribeVolumeStatus'
            Effect: Allow
            Resource: '*'
            Sid: EC2ReadActions
          - Action: 'ecs:DescribeTaskDefinition'
            Effect: Allow
            Resource: '*'
            Sid: ECSReadActions
          - Action: 'ecs:ListTasks'
            Condition:
              StringEquals:
                'ecs:cluster':
                  'Fn::GetAtt':
                    - withvolumecluster05BAFA05
                    - Arn
            Effect: Allow
            Resource: '*'
            Sid: ECSListTasks
          - Action: 'ecs:DescribeTasks'
            Condition:
              StringEquals:
                'ecs:cluster':
                  'Fn::GetAtt':
                    - withvolumecluster05BAFA05
                    - Arn
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'arn:'
                  - Ref: 'AWS::Partition'
                  - ':ecs:'
                  - Ref: 'AWS::Region'
                  - ':'
                  - Ref: 'AWS::AccountId'
                  - ':task/'
                  - Ref: withvolumecluster05BAFA05
                  - /*
            Sid: ECSDescribeTasks
          - Action: 'ecs:DescribeServices'
            Condition:
              StringEquals:
                'ecs:cluster':
                  'Fn::GetAtt':
                    - withvolumecluster05BAFA05
                    - Arn
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'arn:'
                  - Ref: 'AWS::Partition'
                  - ':ecs:'
                  - Ref: 'AWS::Region'
                  - ':'
                  - Ref: 'AWS::AccountId'
                  - ':service/'
                  - Ref: withvolumecluster05BAFA05
                  - /*
            Sid: ECSDescribeServices
          - Action: 'cloudwatch:GetMetricData'
            Effect: Allow
            Resource: '*'
            Sid: CloudWatchReadActions
        Version: '2012-10-17'
      PolicyName: withvolumecloudwatchcustomwidgetexecutionroleDefaultPolicy393C3D88
      Roles:
        - Ref: withvolumecloudwatchcustomwidgetexecutionrole973DB43A
  withvolumecloudwatchcustomwidgetlambda2A396DEC:
    Type: 'AWS::Lambda::Function'
    Properties:
      Architectures:
        - arm64
      Code: Any<Object>
      Handler: index.handler
      MemorySize: 1024
      Role:
        'Fn::GetAtt':
          - withvolumecloudwatchcustomwidgetexecutionrole973DB43A
          - Arn
      Runtime: nodejs22.x
      Tags:
        - Key: Name
          Value: RestateBYOC/with-volume/cloudwatch-custom-widget-lambda
      Timeout: 60
    DependsOn:
      - withvolumecloudwatchcustomwidgetexecutionroleDefaultPolicy393C3D88
      - withvolumecloudwatchcustomwidgetexecutionrole973DB43A
  withvolumecloudwatchcustomwidgetlambdacloudwatchcustomwidgetlambdaallowdatasource7A19B03F:
    Type: 'AWS::Lambda::Permission'
    Properties:
      Action: 'lambda:InvokeFunction'
      FunctionName:
        'Fn::GetAtt':
          - withvolumecloudwatchcustomwidgetlambda2A396DEC
          - Arn
      Principal: lambda.datasource.cloudwatch.amazonaws.com
  withvolumemetrics6A2051ED:
    Type: 'AWS::CloudWatch::Dashboard'
    Properties:
      DashboardBody:
        'Fn::Join':
          - ''
          - - >-
              {"widgets":[{"type":"metric","width":12,"height":6,"x":0,"y":0,"properties":{"view":"timeSeries","title":"Stateless
              CPU","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"CPU","expression":"cpu /
              1024"}],[{"expression":"SELECT AVG(CpuUtilized) FROM
              SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOCwithvolumestatelessdefinition93235A6B' GROUP BY
              TaskId","visible":false,"id":"cpu"}]],"annotations":{"horizontal":[{"value":16,"label":"Limit","yAxis":"left"}]},"yAxis":{"left":{"label":"vCPUs","showUnits":false}}}},{"type":"metric","width":12,"height":6,"x":12,"y":0,"properties":{"view":"timeSeries","title":"Stateless
              Memory","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Memory","expression":"memory /
              1024"}],[{"expression":"SELECT AVG(MemoryUtilized) FROM
              SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOCwithvolumestatelessdefinition93235A6B' GROUP BY
              TaskId","visible":false,"id":"memory"}]],"annotations":{"horizontal":[{"value":32,"label":"Limit","yAxis":"left"}]},"yAxis":{"left":{"label":"GiB","showUnits":false}}}},{"type":"metric","width":12,"height":6,"x":0,"y":6,"properties":{"view":"timeSeries","title":"Stateless
              Network Tx","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Tx","expression":"SELECT
              AVG(NetworkTxBytes) FROM SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOCwithvolumestatelessdefinition93235A6B' GROUP BY
              TaskId"}]],"yAxis":{"left":{"label":"Bytes/sec","showUnits":false}}}},{"type":"metric","width":12,"height":6,"x":12,"y":6,"properties":{"view":"timeSeries","title":"Stateless
              Network Rx","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Rx","expression":"SELECT
              AVG(NetworkRxBytes) FROM SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOCwithvolumestatelessdefinition93235A6B' GROUP BY
              TaskId"}]],"yAxis":{"left":{"label":"Bytes/sec","showUnits":false}}}},{"type":"log","width":24,"height":6,"x":0,"y":12,"properties":{"view":"table","title":"Stateless
              Logs","region":"region","query":"SOURCE '
            - Ref: withvolumestatelessdefinitionrestateLogGroup9C462383
            - >-
              ' | fields @logStream, @timestamp, level, fields.message,
              target\\n          | sort @timestamp desc\\n          | limit
              500"}},{"type":"metric","width":12,"height":6,"x":0,"y":18,"properties":{"view":"timeSeries","title":"Stateful
              CPU","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"CPU","expression":"cpu /
              1024"}],[{"expression":"SELECT AVG(CpuUtilized) FROM
              SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOCwithvolumestatefuldefinition4F5A9794' GROUP BY
              TaskId","visible":false,"id":"cpu"}]],"annotations":{"horizontal":[{"value":16,"label":"Limit","yAxis":"left"}]},"yAxis":{"left":{"label":"vCPUs","showUnits":false}}}},{"type":"metric","width":12,"height":6,"x":12,"y":18,"properties":{"view":"timeSeries","title":"Stateful
              Memory","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Memory","expression":"memory /
              1024"}],[{"expression":"SELECT AVG(MemoryUtilized) FROM
              SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOCwithvolumestatefuldefinition4F5A9794' GROUP BY
              TaskId","visible":false,"id":"memory"}]],"annotations":{"horizontal":[{"value":32,"label":"Limit","yAxis":"left"}]},"yAxis":{"left":{"label":"GiB","showUnits":false}}}},{"type":"metric","width":12,"height":6,"x":0,"y":24,"properties":{"view":"timeSeries","title":"Stateful
              Network Tx","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Tx","expression":"SELECT
              AVG(NetworkTxBytes) FROM SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOCwithvolumestatefuldefinition4F5A9794' GROUP BY
              TaskId"}]],"yAxis":{"left":{"label":"Bytes/sec","showUnits":false}}}},{"type":"metric","width":12,"height":6,"x":12,"y":24,"properties":{"view":"timeSeries","title":"Stateful
              Network Rx","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Rx","expression":"SELECT
              AVG(NetworkRxBytes) FROM SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOCwithvolumestatefuldefinition4F5A9794' GROUP BY
              TaskId"}]],"yAxis":{"left":{"label":"Bytes/sec","showUnits":false}}}},{"type":"log","width":24,"height":6,"x":0,"y":30,"properties":{"view":"table","title":"Stateful
              Logs","region":"region","query":"SOURCE '
            - Ref: withvolumestatefuldefinitionrestateLogGroupD4893BD3
            - >-
              ' | fields @logStream, @timestamp, level, fields.message,
              target\\n          | sort @timestamp desc\\n          | limit
              500"}},{"type":"metric","width":8,"height":6,"x":0,"y":36,"properties":{"view":"timeSeries","title":"EBS
              Volume Usage (Total size 200GiB)","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Usage","expression":"SELECT
              MAX(EBSFilesystemUtilized) FROM SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,VolumeName) WHERE
              TaskDefinitionFamily =
              'RestateBYOCwithvolumestatefuldefinition4F5A9794' GROUP BY
              VolumeName"}]],"annotations":{"horizontal":[{"value":200,"label":"Volume
              size","visible":false,"yAxis":"left"}]},"yAxis":{"left":{"label":"GiB","showUnits":false}}}},{"type":"metric","width":8,"height":6,"x":8,"y":36,"properties":{"view":"timeSeries","title":"Volume
              Write Throughput (Limited to 125 MiB/sec)","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Write","expression":"RATE(count) /
              1048576"}],[{"expression":"SELECT MAX(StorageWriteBytes) FROM
              SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOCwithvolumestatefuldefinition4F5A9794' GROUP BY
              TaskId","visible":false,"id":"count"}]],"annotations":{"horizontal":[{"value":125,"label":"Limit","visible":false,"yAxis":"left"}]},"yAxis":{"left":{"label":"MiB/sec","showUnits":false}}}},{"type":"metric","width":8,"height":6,"x":16,"y":36,"properties":{"view":"timeSeries","title":"Volume
              Read Throughput (Limited to 125 MiB/sec)","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Read","expression":"RATE(count) /
              1048576"}],[{"expression":"SELECT MAX(StorageReadBytes) FROM
              SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOCwithvolumestatefuldefinition4F5A9794' GROUP BY
              TaskId","visible":false,"id":"count"}]],"annotations":{"horizontal":[{"value":125,"label":"Limit","visible":false,"yAxis":"left"}]},"yAxis":{"left":{"label":"MiB/sec","showUnits":false}}}},{"type":"metric","width":12,"height":6,"x":0,"y":42,"properties":{"view":"timeSeries","title":"EBS
              Volume Write IOPS (Limited to 3000)","region":"
            - Ref: 'AWS::Region'
            - '","metrics":[[{"expression":"LAMBDA(\\"'
            - Ref: withvolumecloudwatchcustomwidgetlambda2A396DEC
            - '\\", \\"volumeIOPs\\", \\"'
            - Ref: withvolumecluster05BAFA05
            - >-
              \\", \\"Write\\",
              \\"SELECT\\")"}]],"annotations":{"horizontal":[{"label":"Limit","value":3000,"visible":false,"yAxis":"left"}]},"yAxis":{"left":{"label":"IOPS","showUnits":false}}}},{"type":"metric","width":12,"height":6,"x":12,"y":42,"properties":{"view":"timeSeries","title":"EBS
              Volume Read IOPS (Limited to 3000)","region":"
            - Ref: 'AWS::Region'
            - '","metrics":[[{"expression":"LAMBDA(\\"'
            - Ref: withvolumecloudwatchcustomwidgetlambda2A396DEC
            - '\\", \\"volumeIOPs\\", \\"'
            - Ref: withvolumecluster05BAFA05
            - >-
              \\", \\"Read\\",
              \\"SELECT\\")"}]],"annotations":{"horizontal":[{"label":"Limit","value":3000,"visible":false,"yAxis":"left"}]},"yAxis":{"left":{"label":"IOPS","showUnits":false}}}},{"type":"log","width":24,"height":6,"x":0,"y":48,"properties":{"view":"table","title":"Controller
              Logs","region":"region","query":"SOURCE '
            - Ref: withvolumecontrollerdefinitioncontrollerLogGroupF7CEE299
            - >-
              ' | fields @logStream, @timestamp, level, fields.message,
              target\\n          | sort @timestamp desc\\n          | limit
              500"}}]}
      DashboardName: RestateBYOC_with-volume_metrics
  withvolumecontrolpanel121F08D1:
    Type: 'AWS::CloudWatch::Dashboard'
    Properties:
      DashboardBody:
        'Fn::Join':
          - ''
          - - >-
              {"widgets":[{"type":"custom","width":24,"height":26,"x":0,"y":0,"properties":{"endpoint":"
            - 'Fn::GetAtt':
                - withvolumecloudwatchcustomwidgetlambda2A396DEC
                - Arn
            - '","params":{"command":"controlPanel","input":{"region":"'
            - Ref: 'AWS::Region'
            - >-
              ","summary":{"clusterName":"RestateBYOC/with-volume","restateVersion":"1.3","stackVersion":"0.2.0","metricsDashboardName":"
            - Ref: withvolumemetrics6A2051ED
            - '"},"resources":{"ecsClusterArn":"'
            - 'Fn::GetAtt':
                - withvolumecluster05BAFA05
                - Arn
            - '","statelessServiceArn":"'
            - Ref: withvolumestatelessserviceServiceDCB5849A
            - '","controllerServiceArn":"'
            - Ref: withvolumecontrollerserviceService047527E7
            - '","restatectlLambdaArn":"'
            - 'Fn::GetAtt':
                - withvolumerestatectllambdaE21E648A
                - Arn
            - >-
              "},"connectivityAndSecurity":{"connectivity":{"loadBalancerArns":{"ingress":["
            - Ref: withvolumesharednlb4B8218D2
            - '"],"admin":["'
            - Ref: withvolumesharednlb4B8218D2
            - '"]},"addresses":{"ingress":"http://'
            - 'Fn::GetAtt':
                - withvolumesharednlb4B8218D2
                - DNSName
            - ':8080","admin":"http://'
            - 'Fn::GetAtt':
                - withvolumesharednlb4B8218D2
                - DNSName
            - ':9070","webUI":"http://'
            - 'Fn::GetAtt':
                - withvolumesharednlb4B8218D2
                - DNSName
            - ':9070/ui"}},"networking":{"vpc":"'
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcA2121C384D1B3CDE'
            - '","availabilityZones":["dummy1a","dummy1b","dummy1c"],"subnets":["'
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet1Subnet934893E8236E2271'
            - '","'
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet2Subnet7031C2BA60DCB1EE'
            - '","'
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet3Subnet985AC459F9514491'
            - '"]},"security":{"securityGroups":["'
            - 'Fn::GetAtt':
                - withvolumesecuritygroup6DBAA33E
                - GroupId
            - '"]}},"storage":{"s3":{"bucket":"'
            - Ref: withvolumebucketE6C6250B
            - >-
              "}}}},"title":"","updateOn":{"refresh":true,"resize":true,"timeRange":true}}}]}
      DashboardName: RestateBYOC_with-volume_control-panel
  withvolumeservicedeployerlambdaexecutionroleAC3EC425:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
        Version: '2012-10-17'
  withvolumeservicedeployerlambdaexecutionroleDefaultPolicy28D741ED:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 'logs:CreateLogGroup'
              - 'logs:CreateLogStream'
              - 'logs:PutLogEvents'
              - 'ec2:CreateNetworkInterface'
              - 'ec2:DescribeNetworkInterfaces'
              - 'ec2:DescribeSubnets'
              - 'ec2:DeleteNetworkInterface'
              - 'ec2:AssignPrivateIpAddresses'
              - 'ec2:UnassignPrivateIpAddresses'
            Effect: Allow
            Resource: '*'
            Sid: AWSLambdaVPCAccessExecutionPermissions
        Version: '2012-10-17'
      PolicyName: withvolumeservicedeployerlambdaexecutionroleDefaultPolicy28D741ED
      Roles:
        - Ref: withvolumeservicedeployerlambdaexecutionroleAC3EC425
  withvolumeservicedeployerEventHandlerC7B60E7B:
    Type: 'AWS::Lambda::Function'
    Properties:
      Architectures:
        - arm64
      Code: Any<Object>
      Description: Restate custom registration handler
      Environment:
        Variables:
          NODE_OPTIONS: '--enable-source-maps'
      Handler: entrypoint.handler
      MemorySize: 128
      Role:
        'Fn::GetAtt':
          - withvolumeservicedeployerlambdaexecutionroleAC3EC425
          - Arn
      Runtime: nodejs22.x
      Timeout: 180
      VpcConfig:
        SecurityGroupIds:
          - 'Fn::GetAtt':
              - withvolumesecuritygroup6DBAA33E
              - GroupId
        SubnetIds:
          - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet1Subnet934893E8236E2271'
          - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet2Subnet7031C2BA60DCB1EE'
          - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet3Subnet985AC459F9514491'
    DependsOn:
      - withvolumeservicedeployerlambdaexecutionroleDefaultPolicy28D741ED
      - withvolumeservicedeployerlambdaexecutionroleAC3EC425
  withvolumeservicedeployerDeploymentLogsFDDBA0DC:
    Type: 'AWS::Logs::LogGroup'
    Properties:
      LogGroupName:
        'Fn::Join':
          - ''
          - - /aws/lambda/
            - Ref: withvolumeservicedeployerEventHandlerC7B60E7B
      RetentionInDays: 30
    UpdateReplacePolicy: Retain
    DeletionPolicy: RetainExceptOnCreate
"
`;

exports[`BYOC Without control panel 1`] = `
"Resources:
  withoutcontrolpanelsecuritygroup442A1897:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      GroupDescription: RestateBYOC/without-control-panel/security-group
      SecurityGroupEgress:
        - CidrIp: 0.0.0.0/0
          Description: Allow all outbound traffic by default
          IpProtocol: '-1'
      Tags:
        - Key: Name
          Value: RestateBYOC/without-control-panel/security-group
      VpcId:
        'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcA2121C384D1B3CDE'
  withoutcontrolpanelsecuritygroupfromRestateBYOCwithoutcontrolpanelsecuritygroup2AC6537580807B932CF0:
    Type: 'AWS::EC2::SecurityGroupIngress'
    Properties:
      Description: 'from RestateBYOCwithoutcontrolpanelsecuritygroup2AC65375:8080'
      FromPort: 8080
      GroupId:
        'Fn::GetAtt':
          - withoutcontrolpanelsecuritygroup442A1897
          - GroupId
      IpProtocol: tcp
      SourceSecurityGroupId:
        'Fn::GetAtt':
          - withoutcontrolpanelsecuritygroup442A1897
          - GroupId
      ToPort: 8080
  withoutcontrolpanelsecuritygroupfromRestateBYOCwithoutcontrolpanelsecuritygroup2AC65375907064ECC8CB:
    Type: 'AWS::EC2::SecurityGroupIngress'
    Properties:
      Description: 'from RestateBYOCwithoutcontrolpanelsecuritygroup2AC65375:9070'
      FromPort: 9070
      GroupId:
        'Fn::GetAtt':
          - withoutcontrolpanelsecuritygroup442A1897
          - GroupId
      IpProtocol: tcp
      SourceSecurityGroupId:
        'Fn::GetAtt':
          - withoutcontrolpanelsecuritygroup442A1897
          - GroupId
      ToPort: 9070
  withoutcontrolpanelsecuritygroupfromRestateBYOCwithoutcontrolpanelsecuritygroup2AC65375512242A53290:
    Type: 'AWS::EC2::SecurityGroupIngress'
    Properties:
      Description: 'from RestateBYOCwithoutcontrolpanelsecuritygroup2AC65375:5122'
      FromPort: 5122
      GroupId:
        'Fn::GetAtt':
          - withoutcontrolpanelsecuritygroup442A1897
          - GroupId
      IpProtocol: tcp
      SourceSecurityGroupId:
        'Fn::GetAtt':
          - withoutcontrolpanelsecuritygroup442A1897
          - GroupId
      ToPort: 5122
  withoutcontrolpanelbucketEE1CBB8F:
    Type: 'AWS::S3::Bucket'
    Properties:
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
    UpdateReplacePolicy: Retain
    DeletionPolicy: Retain
  withoutcontrolpanelbucketPolicyF3D0F310:
    Type: 'AWS::S3::BucketPolicy'
    Properties:
      Bucket:
        Ref: withoutcontrolpanelbucketEE1CBB8F
      PolicyDocument:
        Statement:
          - Action: 's3:*'
            Condition:
              Bool:
                'aws:SecureTransport': 'false'
            Effect: Deny
            Principal:
              AWS: '*'
            Resource:
              - 'Fn::GetAtt':
                  - withoutcontrolpanelbucketEE1CBB8F
                  - Arn
              - 'Fn::Join':
                  - ''
                  - - 'Fn::GetAtt':
                        - withoutcontrolpanelbucketEE1CBB8F
                        - Arn
                    - /*
        Version: '2012-10-17'
  withoutcontrolpanelcluster0BE3B425:
    Type: 'AWS::ECS::Cluster'
    Properties:
      ClusterSettings:
        - Name: containerInsights
          Value: enhanced
      Tags:
        - Key: Name
          Value: RestateBYOC/without-control-panel/cluster
  withoutcontrolpanelrestatetaskroleFF8DB8FE:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
        Version: '2012-10-17'
  withoutcontrolpanelrestatetaskroleDefaultPolicyF992A460:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 's3:GetObject'
              - 's3:PutObject'
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'Fn::GetAtt':
                      - withoutcontrolpanelbucketEE1CBB8F
                      - Arn
                  - /*
            Sid: ReadWriteBucket
          - Action: 's3:ListBucket'
            Effect: Allow
            Resource:
              'Fn::GetAtt':
                - withoutcontrolpanelbucketEE1CBB8F
                - Arn
            Sid: ListBucket
        Version: '2012-10-17'
      PolicyName: withoutcontrolpanelrestatetaskroleDefaultPolicyF992A460
      Roles:
        - Ref: withoutcontrolpanelrestatetaskroleFF8DB8FE
  withoutcontrolpanelrestateexecutionrole1993D09B:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
        Version: '2012-10-17'
  withoutcontrolpanelrestateexecutionroleDefaultPolicy6A5B5DF0:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 'logs:CreateLogStream'
              - 'logs:PutLogEvents'
            Effect: Allow
            Resource:
              'Fn::GetAtt':
                - withoutcontrolpanelstatelessdefinitionrestateLogGroupA8E6F021
                - Arn
          - Action:
              - 'logs:CreateLogStream'
              - 'logs:PutLogEvents'
            Effect: Allow
            Resource:
              'Fn::GetAtt':
                - withoutcontrolpanelstatefuldefinitionrestateLogGroupCCD0E826
                - Arn
        Version: '2012-10-17'
      PolicyName: withoutcontrolpanelrestateexecutionroleDefaultPolicy6A5B5DF0
      Roles:
        - Ref: withoutcontrolpanelrestateexecutionrole1993D09B
  withoutcontrolpanelsharednlb68A27AF0:
    Type: 'AWS::ElasticLoadBalancingV2::LoadBalancer'
    Properties:
      LoadBalancerAttributes:
        - Key: deletion_protection.enabled
          Value: 'false'
        - Key: load_balancing.cross_zone.enabled
          Value: 'false'
        - Key: dns_record.client_routing_policy
          Value: availability_zone_affinity
      Scheme: internal
      SecurityGroups:
        - 'Fn::GetAtt':
            - withoutcontrolpanelsecuritygroup442A1897
            - GroupId
      Subnets:
        - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet1Subnet934893E8236E2271'
        - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet2Subnet7031C2BA60DCB1EE'
        - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet3Subnet985AC459F9514491'
      Tags:
        - Key: Name
          Value: RestateBYOC/without-control-panel/shared-nlb
      Type: network
  withoutcontrolpanelingresssharedlistener2A10FF3E:
    Type: 'AWS::ElasticLoadBalancingV2::Listener'
    Properties:
      DefaultActions:
        - TargetGroupArn:
            Ref: withoutcontrolpanelingresssharedtarget040A5A44
          Type: forward
      LoadBalancerArn:
        Ref: withoutcontrolpanelsharednlb68A27AF0
      Port: 8080
      Protocol: TCP
  withoutcontrolpaneladminsharedlistener23DDE4FD:
    Type: 'AWS::ElasticLoadBalancingV2::Listener'
    Properties:
      DefaultActions:
        - TargetGroupArn:
            Ref: withoutcontrolpaneladminsharedtargetBE291FE8
          Type: forward
      LoadBalancerArn:
        Ref: withoutcontrolpanelsharednlb68A27AF0
      Port: 9070
      Protocol: TCP
  withoutcontrolpanelnodesharedlistenerF5D548C2:
    Type: 'AWS::ElasticLoadBalancingV2::Listener'
    Properties:
      DefaultActions:
        - TargetGroupArn:
            Ref: withoutcontrolpanelnodesharedtarget4C2992DD
          Type: forward
      LoadBalancerArn:
        Ref: withoutcontrolpanelsharednlb68A27AF0
      Port: 5122
      Protocol: TCP
  withoutcontrolpanelstatelessdefinition28C4C08C:
    Type: 'AWS::ECS::TaskDefinition'
    Properties:
      ContainerDefinitions:
        - Cpu: 16384
          EntryPoint:
            - bash
            - '-c'
            - >

              curl --no-progress-meter $ECS_CONTAINER_METADATA_URI_V4/task -o
              task-metadata && \\

              export \\
                RESTATE_NODE_NAME=$(jq -r '.TaskARN' task-metadata) \\
                RESTATE_LOCATION="$AWS_REGION.$(jq -r '.AvailabilityZone' task-metadata)" \\
                RESTATE_ADVERTISED_ADDRESS="http://$(jq -r '.Containers[0].Networks[0].IPv4Addresses[0]' task-metadata):5122"
              exec restate-server
          Environment:
            - Name: RESTATE_LOG_FORMAT
              Value: json
            - Name: RESTATE_CLUSTER_NAME
              Value: RestateBYOC/without-control-panel
            - Name: RESTATE_ROLES
              Value: '["admin","http-ingress"]'
            - Name: RESTATE_AUTO_PROVISION
              Value: 'true'
            - Name: RESTATE_SHUTDOWN_TIMEOUT
              Value: 100s
            - Name: RESTATE_DEFAULT_NUM_PARTITIONS
              Value: '128'
            - Name: RESTATE_DEFAULT_REPLICATION
              Value: '{zone: 2}'
            - Name: RESTATE_METADATA_CLIENT__TYPE
              Value: object-store
            - Name: RESTATE_METADATA_CLIENT__PATH
              Value:
                'Fn::Join':
                  - ''
                  - - 's3://'
                    - Ref: withoutcontrolpanelbucketEE1CBB8F
                    - /metadata
            - Name: RESTATE_BIFROST__DEFAULT_PROVIDER
              Value: replicated
            - Name: >-
                RESTATE_INGRESS__EXPERIMENTAL_FEATURE_ENABLE_SEPARATE_INGRESS_ROLE
              Value: 'true'
            - Name: RESTATE_INGRESS__ADVERTISED_INGRESS_ENDPOINT
              Value:
                'Fn::Join':
                  - ''
                  - - 'http://'
                    - 'Fn::GetAtt':
                        - withoutcontrolpanelsharednlb68A27AF0
                        - DNSName
                    - ':8080'
            - Name: RESTATE_WORKER__SNAPSHOTS__DESTINATION
              Value:
                'Fn::Join':
                  - ''
                  - - 's3://'
                    - Ref: withoutcontrolpanelbucketEE1CBB8F
                    - /snapshots
          Essential: true
          HealthCheck:
            Command:
              - CMD
              - curl
              - '--fail'
              - 'http://127.0.0.1:8080/restate/health'
            Interval: 30
            Retries: 3
            Timeout: 5
          Image: Any<Object>
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group:
                Ref: withoutcontrolpanelstatelessdefinitionrestateLogGroupA8E6F021
              awslogs-stream-prefix: restate
              awslogs-region: region
          Memory: 32768
          Name: restate
          PortMappings:
            - ContainerPort: 8080
              Name: ingress
              Protocol: tcp
            - ContainerPort: 9070
              Name: admin
              Protocol: tcp
            - ContainerPort: 5122
              Name: node
              Protocol: tcp
          StopTimeout: 120
      Cpu: '16384'
      ExecutionRoleArn:
        'Fn::GetAtt':
          - withoutcontrolpanelrestateexecutionrole1993D09B
          - Arn
      Family: RestateBYOCwithoutcontrolpanelstatelessdefinition80E3064F
      Memory: '32768'
      NetworkMode: awsvpc
      RequiresCompatibilities:
        - FARGATE
      RuntimePlatform:
        CpuArchitecture: ARM64
        OperatingSystemFamily: LINUX
      Tags:
        - Key: Name
          Value: RestateBYOC/without-control-panel/stateless-definition
      TaskRoleArn:
        'Fn::GetAtt':
          - withoutcontrolpanelrestatetaskroleFF8DB8FE
          - Arn
  withoutcontrolpanelstatelessdefinitionrestateLogGroupA8E6F021:
    Type: 'AWS::Logs::LogGroup'
    Properties:
      Tags:
        - Key: Name
          Value: RestateBYOC/without-control-panel/stateless-definition
    UpdateReplacePolicy: Retain
    DeletionPolicy: Retain
  withoutcontrolpanelstatelessserviceService70D13293:
    Type: 'AWS::ECS::Service'
    Properties:
      Cluster:
        Ref: withoutcontrolpanelcluster0BE3B425
      DeploymentConfiguration:
        Alarms:
          AlarmNames: []
          Enable: false
          Rollback: false
        MaximumPercent: 200
        MinimumHealthyPercent: 100
      DesiredCount: 3
      EnableECSManagedTags: false
      EnableExecuteCommand: false
      HealthCheckGracePeriodSeconds: 60
      LaunchType: FARGATE
      LoadBalancers:
        - ContainerName: restate
          ContainerPort: 8080
          TargetGroupArn:
            Ref: withoutcontrolpanelingresssharedtarget040A5A44
        - ContainerName: restate
          ContainerPort: 9070
          TargetGroupArn:
            Ref: withoutcontrolpaneladminsharedtargetBE291FE8
        - ContainerName: restate
          ContainerPort: 5122
          TargetGroupArn:
            Ref: withoutcontrolpanelnodesharedtarget4C2992DD
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: DISABLED
          SecurityGroups:
            - 'Fn::GetAtt':
                - withoutcontrolpanelsecuritygroup442A1897
                - GroupId
          Subnets:
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet1Subnet934893E8236E2271'
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet2Subnet7031C2BA60DCB1EE'
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet3Subnet985AC459F9514491'
      PropagateTags: SERVICE
      Tags:
        - Key: Name
          Value: RestateBYOC/without-control-panel/stateless-service
      TaskDefinition:
        Ref: withoutcontrolpanelstatelessdefinition28C4C08C
    DependsOn:
      - withoutcontrolpaneladminsharedlistener23DDE4FD
      - withoutcontrolpanelingresssharedlistener2A10FF3E
      - withoutcontrolpanelnodesharedlistenerF5D548C2
      - withoutcontrolpanelrestatetaskroleDefaultPolicyF992A460
      - withoutcontrolpanelrestatetaskroleFF8DB8FE
  withoutcontrolpanelstatefuldefinitionB19B8DF2:
    Type: 'AWS::ECS::TaskDefinition'
    Properties:
      ContainerDefinitions:
        - Cpu: 16384
          EntryPoint:
            - bash
            - '-c'
            - >

              curl --no-progress-meter $ECS_CONTAINER_METADATA_URI_V4/task -o
              task-metadata && \\

              export \\
                RESTATE_NODE_NAME=$(jq -r '.TaskARN' task-metadata) \\
                RESTATE_LOCATION="$AWS_REGION.$(jq -r '.AvailabilityZone' task-metadata)" \\
                RESTATE_ADVERTISED_ADDRESS="http://$(jq -r '.Containers[0].Networks[0].IPv4Addresses[0]' task-metadata):5122"
              exec restate-server
          Environment:
            - Name: RESTATE_LOG_FORMAT
              Value: json
            - Name: RESTATE_CLUSTER_NAME
              Value: RestateBYOC/without-control-panel
            - Name: RESTATE_ROLES
              Value: '["log-server", "worker"]'
            - Name: RESTATE_AUTO_PROVISION
              Value: 'false'
            - Name: RESTATE_SHUTDOWN_TIMEOUT
              Value: 100s
            - Name: RESTATE_ROCKSDB_TOTAL_MEMORY_SIZE
              Value: 24576MiB
            - Name: RESTATE_METADATA_CLIENT__TYPE
              Value: object-store
            - Name: RESTATE_METADATA_CLIENT__PATH
              Value:
                'Fn::Join':
                  - ''
                  - - 's3://'
                    - Ref: withoutcontrolpanelbucketEE1CBB8F
                    - /metadata
            - Name: RESTATE_WORKER__SNAPSHOTS__DESTINATION
              Value:
                'Fn::Join':
                  - ''
                  - - 's3://'
                    - Ref: withoutcontrolpanelbucketEE1CBB8F
                    - /snapshots
            - Name: RESTATE_WORKER__SNAPSHOTS__SNAPSHOT_INTERVAL_NUM_RECORDS
              Value: '1000000'
            - Name: RESTATE_WORKER__STORAGE__ROCKSDB_DISABLE_DIRECT_IO_FOR_READS
              Value: 'true'
            - Name: RESTATE_WORKER__STORAGE__ROCKSDB_DISABLE_WAL_FSYNC
              Value: 'true'
            - Name: RESTATE_LOG_SERVER__ROCKSDB_DISABLE_WAL_FSYNC
              Value: 'true'
            - Name: RESTATE_LOG_SERVER__ROCKSDB_DISABLE_DIRECT_IO_FOR_READS
              Value: 'true'
            - Name: >-
                RESTATE_INGRESS__EXPERIMENTAL_FEATURE_ENABLE_SEPARATE_INGRESS_ROLE
              Value: 'true'
          Essential: true
          HealthCheck:
            Command:
              - CMD
              - curl
              - '--fail'
              - 'http://127.0.0.1:5122/health'
            Interval: 30
            Retries: 3
            Timeout: 5
          Image: Any<Object>
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group:
                Ref: withoutcontrolpanelstatefuldefinitionrestateLogGroupCCD0E826
              awslogs-stream-prefix: restate
              awslogs-region: region
          Memory: 32768
          MountPoints:
            - ContainerPath: /restate-data
              ReadOnly: false
              SourceVolume: restate-data
          Name: restate
          PortMappings:
            - ContainerPort: 5122
              Name: node
              Protocol: tcp
          RestartPolicy:
            Enabled: true
            RestartAttemptPeriod: 60
          StopTimeout: 120
      Cpu: '16384'
      EphemeralStorage:
        SizeInGiB: 200
      ExecutionRoleArn:
        'Fn::GetAtt':
          - withoutcontrolpanelrestateexecutionrole1993D09B
          - Arn
      Family: RestateBYOCwithoutcontrolpanelstatefuldefinitionC1D30D6E
      Memory: '32768'
      NetworkMode: awsvpc
      RequiresCompatibilities:
        - FARGATE
      RuntimePlatform:
        CpuArchitecture: ARM64
        OperatingSystemFamily: LINUX
      Tags:
        - Key: Name
          Value: RestateBYOC/without-control-panel/stateful-definition
      TaskRoleArn:
        'Fn::GetAtt':
          - withoutcontrolpanelrestatetaskroleFF8DB8FE
          - Arn
      Volumes:
        - ConfiguredAtLaunch: false
          Name: restate-data
  withoutcontrolpanelstatefuldefinitionrestateLogGroupCCD0E826:
    Type: 'AWS::Logs::LogGroup'
    Properties:
      Tags:
        - Key: Name
          Value: RestateBYOC/without-control-panel/stateful-definition
    UpdateReplacePolicy: Retain
    DeletionPolicy: Retain
  withoutcontrolpanelingresssharedtarget040A5A44:
    Type: 'AWS::ElasticLoadBalancingV2::TargetGroup'
    Properties:
      HealthCheckEnabled: true
      HealthCheckIntervalSeconds: 5
      HealthCheckPath: /restate/health
      HealthCheckProtocol: HTTP
      HealthCheckTimeoutSeconds: 2
      Port: 8080
      Protocol: TCP
      Tags:
        - Key: Name
          Value: RestateBYOC/without-control-panel/ingress-shared-target
      TargetType: ip
      VpcId:
        'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcA2121C384D1B3CDE'
  withoutcontrolpaneladminsharedtargetBE291FE8:
    Type: 'AWS::ElasticLoadBalancingV2::TargetGroup'
    Properties:
      HealthCheckEnabled: true
      HealthCheckIntervalSeconds: 5
      HealthCheckPath: /health
      HealthCheckPort: '9070'
      HealthCheckProtocol: HTTP
      HealthCheckTimeoutSeconds: 2
      Port: 9070
      Protocol: TCP
      Tags:
        - Key: Name
          Value: RestateBYOC/without-control-panel/admin-shared-target
      TargetType: ip
      VpcId:
        'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcA2121C384D1B3CDE'
  withoutcontrolpanelnodesharedtarget4C2992DD:
    Type: 'AWS::ElasticLoadBalancingV2::TargetGroup'
    Properties:
      HealthCheckEnabled: true
      HealthCheckIntervalSeconds: 5
      HealthCheckPath: /health
      HealthCheckPort: '5122'
      HealthCheckProtocol: HTTP
      HealthCheckTimeoutSeconds: 2
      Port: 5122
      Protocol: TCP
      Tags:
        - Key: Name
          Value: RestateBYOC/without-control-panel/node-shared-target
      TargetType: ip
      VpcId:
        'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcA2121C384D1B3CDE'
  withoutcontrolpanelcontrollertaskroleC014A25C:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
        Version: '2012-10-17'
  withoutcontrolpanelcontrollertaskroleDefaultPolicy88E6453A:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 'ecs:ListTasks'
              - 'ecs:DescribeTasks'
              - 'ecs:StopTask'
            Condition:
              ArnEquals:
                'ecs:cluster':
                  'Fn::GetAtt':
                    - withoutcontrolpanelcluster0BE3B425
                    - Arn
            Effect: Allow
            Resource: '*'
            Sid: TaskActions
          - Action: 'ecs:TagResource'
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'Fn::Join':
                      - /
                      - - 'Fn::Join':
                            - ':'
                            - - 'Fn::Select':
                                  - 0
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - withoutcontrolpanelcluster0BE3B425
                                                  - Arn
                              - 'Fn::Select':
                                  - 1
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - withoutcontrolpanelcluster0BE3B425
                                                  - Arn
                              - 'Fn::Select':
                                  - 2
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - withoutcontrolpanelcluster0BE3B425
                                                  - Arn
                              - 'Fn::Select':
                                  - 3
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - withoutcontrolpanelcluster0BE3B425
                                                  - Arn
                              - 'Fn::Select':
                                  - 4
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - withoutcontrolpanelcluster0BE3B425
                                                  - Arn
                              - task
                        - 'Fn::Select':
                            - 1
                            - 'Fn::Split':
                                - /
                                - 'Fn::GetAtt':
                                    - withoutcontrolpanelcluster0BE3B425
                                    - Arn
                        - ''
                  - '*'
            Sid: TagTasks
          - Action: 'ecs:RunTask'
            Condition:
              ArnEquals:
                'ecs:cluster':
                  'Fn::GetAtt':
                    - withoutcontrolpanelcluster0BE3B425
                    - Arn
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'Fn::Join':
                      - ':'
                      - - 'Fn::Select':
                            - 0
                            - 'Fn::Split':
                                - ':'
                                - Ref: >-
                                    withoutcontrolpanelstatefuldefinitionB19B8DF2
                        - 'Fn::Select':
                            - 1
                            - 'Fn::Split':
                                - ':'
                                - Ref: >-
                                    withoutcontrolpanelstatefuldefinitionB19B8DF2
                        - 'Fn::Select':
                            - 2
                            - 'Fn::Split':
                                - ':'
                                - Ref: >-
                                    withoutcontrolpanelstatefuldefinitionB19B8DF2
                        - 'Fn::Select':
                            - 3
                            - 'Fn::Split':
                                - ':'
                                - Ref: >-
                                    withoutcontrolpanelstatefuldefinitionB19B8DF2
                        - 'Fn::Select':
                            - 4
                            - 'Fn::Split':
                                - ':'
                                - Ref: >-
                                    withoutcontrolpanelstatefuldefinitionB19B8DF2
                        - 'Fn::Select':
                            - 5
                            - 'Fn::Split':
                                - ':'
                                - Ref: >-
                                    withoutcontrolpanelstatefuldefinitionB19B8DF2
                  - ':*'
            Sid: RunTask
          - Action: 'iam:PassRole'
            Condition:
              StringEquals:
                'iam:PassedToService': ecs-tasks.amazonaws.com
            Effect: Allow
            Resource:
              - 'Fn::GetAtt':
                  - withoutcontrolpanelrestatetaskroleFF8DB8FE
                  - Arn
              - 'Fn::GetAtt':
                  - withoutcontrolpanelrestateexecutionrole1993D09B
                  - Arn
            Sid: RunTaskPassRole
          - Action:
              - 's3:GetObject'
              - 's3:PutObject'
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'Fn::GetAtt':
                      - withoutcontrolpanelbucketEE1CBB8F
                      - Arn
                  - /*
            Sid: ReadWriteBucket
          - Action: 's3:ListBucket'
            Effect: Allow
            Resource:
              'Fn::GetAtt':
                - withoutcontrolpanelbucketEE1CBB8F
                - Arn
            Sid: ListBucket
        Version: '2012-10-17'
      PolicyName: withoutcontrolpanelcontrollertaskroleDefaultPolicy88E6453A
      Roles:
        - Ref: withoutcontrolpanelcontrollertaskroleC014A25C
  withoutcontrolpanelcontrollerexecutionrole5AE0337C:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
        Version: '2012-10-17'
  withoutcontrolpanelcontrollerexecutionroleDefaultPolicyB0DD980D:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 'logs:CreateLogStream'
              - 'logs:PutLogEvents'
            Effect: Allow
            Resource:
              'Fn::GetAtt':
                - >-
                  withoutcontrolpanelcontrollerdefinitioncontrollerLogGroup01AA3C71
                - Arn
        Version: '2012-10-17'
      PolicyName: withoutcontrolpanelcontrollerexecutionroleDefaultPolicyB0DD980D
      Roles:
        - Ref: withoutcontrolpanelcontrollerexecutionrole5AE0337C
  withoutcontrolpanelcontrollerdefinitionCE2F2D7E:
    Type: 'AWS::ECS::TaskDefinition'
    Properties:
      ContainerDefinitions:
        - Cpu: 1024
          Environment:
            - Name: RUST_LOG
              Value: 'info,restate_fargate_controller=debug'
            - Name: CONTROLLER_LOG_FORMAT
              Value: json
            - Name: CONTROLLER_METADATA_PATH
              Value:
                'Fn::Join':
                  - ''
                  - - 's3://'
                    - Ref: withoutcontrolpanelbucketEE1CBB8F
                    - /metadata
            - Name: CONTROLLER_RECONCILE_INTERVAL
              Value: 10s
            - Name: CONTROLLER_CLUSTER__CLUSTER_ARN
              Value:
                'Fn::GetAtt':
                  - withoutcontrolpanelcluster0BE3B425
                  - Arn
            - Name: CONTROLLER_LICENSE_ID
              Value: foo
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __REGION
              Value:
                Ref: 'AWS::Region'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __CLUSTER_ARN
              Value:
                'Fn::GetAtt':
                  - withoutcontrolpanelcluster0BE3B425
                  - Arn
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __TASK_PREFIX
              Value:
                'Fn::Join':
                  - /
                  - - 'Fn::Join':
                        - ':'
                        - - 'Fn::Select':
                              - 0
                              - 'Fn::Split':
                                  - ':'
                                  - 'Fn::Select':
                                      - 0
                                      - 'Fn::Split':
                                          - /
                                          - 'Fn::GetAtt':
                                              - withoutcontrolpanelcluster0BE3B425
                                              - Arn
                          - 'Fn::Select':
                              - 1
                              - 'Fn::Split':
                                  - ':'
                                  - 'Fn::Select':
                                      - 0
                                      - 'Fn::Split':
                                          - /
                                          - 'Fn::GetAtt':
                                              - withoutcontrolpanelcluster0BE3B425
                                              - Arn
                          - 'Fn::Select':
                              - 2
                              - 'Fn::Split':
                                  - ':'
                                  - 'Fn::Select':
                                      - 0
                                      - 'Fn::Split':
                                          - /
                                          - 'Fn::GetAtt':
                                              - withoutcontrolpanelcluster0BE3B425
                                              - Arn
                          - 'Fn::Select':
                              - 3
                              - 'Fn::Split':
                                  - ':'
                                  - 'Fn::Select':
                                      - 0
                                      - 'Fn::Split':
                                          - /
                                          - 'Fn::GetAtt':
                                              - withoutcontrolpanelcluster0BE3B425
                                              - Arn
                          - 'Fn::Select':
                              - 4
                              - 'Fn::Split':
                                  - ':'
                                  - 'Fn::Select':
                                      - 0
                                      - 'Fn::Split':
                                          - /
                                          - 'Fn::GetAtt':
                                              - withoutcontrolpanelcluster0BE3B425
                                              - Arn
                          - task
                    - 'Fn::Select':
                        - 1
                        - 'Fn::Split':
                            - /
                            - 'Fn::GetAtt':
                                - withoutcontrolpanelcluster0BE3B425
                                - Arn
                    - ''
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1a__ENABLE_EXECUTE_COMMAND
              Value: 'false'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1a__SECURITY_GROUPS
              Value:
                'Fn::Join':
                  - ''
                  - - '["'
                    - 'Fn::GetAtt':
                        - withoutcontrolpanelsecuritygroup442A1897
                        - GroupId
                    - '"]'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1a__SUBNETS
              Value:
                'Fn::Join':
                  - ''
                  - - '["'
                    - 'Fn::ImportValue': >-
                        VPCStack:ExportsOutputRefvpcPrivateSubnet1Subnet934893E8236E2271
                    - '"]'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1a__TASK_DEFINITION_ARN
              Value:
                Ref: withoutcontrolpanelstatefuldefinitionB19B8DF2
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1a__COUNT
              Value: '1'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1b__ENABLE_EXECUTE_COMMAND
              Value: 'false'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1b__SECURITY_GROUPS
              Value:
                'Fn::Join':
                  - ''
                  - - '["'
                    - 'Fn::GetAtt':
                        - withoutcontrolpanelsecuritygroup442A1897
                        - GroupId
                    - '"]'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1b__SUBNETS
              Value:
                'Fn::Join':
                  - ''
                  - - '["'
                    - 'Fn::ImportValue': >-
                        VPCStack:ExportsOutputRefvpcPrivateSubnet2Subnet7031C2BA60DCB1EE
                    - '"]'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1b__TASK_DEFINITION_ARN
              Value:
                Ref: withoutcontrolpanelstatefuldefinitionB19B8DF2
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1b__COUNT
              Value: '1'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1c__ENABLE_EXECUTE_COMMAND
              Value: 'false'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1c__SECURITY_GROUPS
              Value:
                'Fn::Join':
                  - ''
                  - - '["'
                    - 'Fn::GetAtt':
                        - withoutcontrolpanelsecuritygroup442A1897
                        - GroupId
                    - '"]'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1c__SUBNETS
              Value:
                'Fn::Join':
                  - ''
                  - - '["'
                    - 'Fn::ImportValue': >-
                        VPCStack:ExportsOutputRefvpcPrivateSubnet3Subnet985AC459F9514491
                    - '"]'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1c__TASK_DEFINITION_ARN
              Value:
                Ref: withoutcontrolpanelstatefuldefinitionB19B8DF2
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1c__COUNT
              Value: '1'
          Essential: true
          HealthCheck:
            Command:
              - CMD
              - curl
              - '--fail'
              - 'http://127.0.0.1:8080/health'
            Interval: 30
            Retries: 10
            StartPeriod: 300
            Timeout: 5
          Image: Any<Object>
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group:
                Ref: >-
                  withoutcontrolpanelcontrollerdefinitioncontrollerLogGroup01AA3C71
              awslogs-stream-prefix: controller
              awslogs-region: region
          Memory: 2048
          Name: controller
          StopTimeout: 120
      Cpu: '1024'
      ExecutionRoleArn:
        'Fn::GetAtt':
          - withoutcontrolpanelcontrollerexecutionrole5AE0337C
          - Arn
      Family: RestateBYOCwithoutcontrolpanelcontrollerdefinition8B477303
      Memory: '2048'
      NetworkMode: awsvpc
      RequiresCompatibilities:
        - FARGATE
      RuntimePlatform:
        CpuArchitecture: ARM64
        OperatingSystemFamily: LINUX
      Tags:
        - Key: Name
          Value: RestateBYOC/without-control-panel/controller-definition
      TaskRoleArn:
        'Fn::GetAtt':
          - withoutcontrolpanelcontrollertaskroleC014A25C
          - Arn
  withoutcontrolpanelcontrollerdefinitioncontrollerLogGroup01AA3C71:
    Type: 'AWS::Logs::LogGroup'
    Properties:
      Tags:
        - Key: Name
          Value: RestateBYOC/without-control-panel/controller-definition
    UpdateReplacePolicy: Retain
    DeletionPolicy: Retain
  withoutcontrolpanelcontrollerserviceService3FEE3A64:
    Type: 'AWS::ECS::Service'
    Properties:
      Cluster:
        Ref: withoutcontrolpanelcluster0BE3B425
      DeploymentConfiguration:
        Alarms:
          AlarmNames: []
          Enable: false
          Rollback: false
        MaximumPercent: 100
        MinimumHealthyPercent: 0
      DesiredCount: 1
      EnableECSManagedTags: false
      EnableExecuteCommand: false
      LaunchType: FARGATE
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: DISABLED
          SecurityGroups:
            - 'Fn::GetAtt':
                - withoutcontrolpanelsecuritygroup442A1897
                - GroupId
          Subnets:
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet1Subnet934893E8236E2271'
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet2Subnet7031C2BA60DCB1EE'
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet3Subnet985AC459F9514491'
      Tags:
        - Key: Name
          Value: RestateBYOC/without-control-panel/controller-service
      TaskDefinition:
        Ref: withoutcontrolpanelcontrollerdefinitionCE2F2D7E
    DependsOn:
      - withoutcontrolpanelcontrollertaskroleDefaultPolicy88E6453A
      - withoutcontrolpanelcontrollertaskroleC014A25C
  withoutcontrolpanelrestatectllambdaexecutionrole386454C4:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
        Version: '2012-10-17'
  withoutcontrolpanelrestatectllambdaexecutionroleDefaultPolicy955C5223:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 'logs:CreateLogGroup'
              - 'logs:CreateLogStream'
              - 'logs:PutLogEvents'
              - 'ec2:CreateNetworkInterface'
              - 'ec2:DescribeNetworkInterfaces'
              - 'ec2:DescribeSubnets'
              - 'ec2:DeleteNetworkInterface'
              - 'ec2:AssignPrivateIpAddresses'
              - 'ec2:UnassignPrivateIpAddresses'
            Effect: Allow
            Resource: '*'
            Sid: AWSLambdaVPCAccessExecutionPermissions
        Version: '2012-10-17'
      PolicyName: withoutcontrolpanelrestatectllambdaexecutionroleDefaultPolicy955C5223
      Roles:
        - Ref: withoutcontrolpanelrestatectllambdaexecutionrole386454C4
  withoutcontrolpanelrestatectllambda043A6A30:
    Type: 'AWS::Lambda::Function'
    Properties:
      Architectures:
        - arm64
      Code: Any<Object>
      Environment:
        Variables:
          RESTATECTL_ADDRESS:
            'Fn::Join':
              - ''
              - - 'http://'
                - 'Fn::GetAtt':
                    - withoutcontrolpanelsharednlb68A27AF0
                    - DNSName
                - ':5122'
      Handler: restatectl
      Role:
        'Fn::GetAtt':
          - withoutcontrolpanelrestatectllambdaexecutionrole386454C4
          - Arn
      Runtime: provided.al2023
      Tags:
        - Key: Name
          Value: RestateBYOC/without-control-panel/restatectl-lambda
      Timeout: 10
      VpcConfig:
        SecurityGroupIds:
          - 'Fn::GetAtt':
              - withoutcontrolpanelsecuritygroup442A1897
              - GroupId
        SubnetIds:
          - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet1Subnet934893E8236E2271'
          - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet2Subnet7031C2BA60DCB1EE'
          - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet3Subnet985AC459F9514491'
    DependsOn:
      - withoutcontrolpanelrestatectllambdaexecutionroleDefaultPolicy955C5223
      - withoutcontrolpanelrestatectllambdaexecutionrole386454C4
  withoutcontrolpanelretirementwatcherlambdaexecutionrole9DA580C7:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
        Version: '2012-10-17'
  withoutcontrolpanelretirementwatcherlambdaexecutionroleDefaultPolicy22F23EB8:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 'logs:CreateLogGroup'
              - 'logs:CreateLogStream'
              - 'logs:PutLogEvents'
            Effect: Allow
            Resource: '*'
            Sid: AWSLambdaBasicExecutionPermissions
          - Action: 'ecs:TagResource'
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'Fn::Join':
                      - /
                      - - 'Fn::Join':
                            - ':'
                            - - 'Fn::Select':
                                  - 0
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - withoutcontrolpanelcluster0BE3B425
                                                  - Arn
                              - 'Fn::Select':
                                  - 1
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - withoutcontrolpanelcluster0BE3B425
                                                  - Arn
                              - 'Fn::Select':
                                  - 2
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - withoutcontrolpanelcluster0BE3B425
                                                  - Arn
                              - 'Fn::Select':
                                  - 3
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - withoutcontrolpanelcluster0BE3B425
                                                  - Arn
                              - 'Fn::Select':
                                  - 4
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - withoutcontrolpanelcluster0BE3B425
                                                  - Arn
                              - task
                        - 'Fn::Select':
                            - 1
                            - 'Fn::Split':
                                - /
                                - 'Fn::GetAtt':
                                    - withoutcontrolpanelcluster0BE3B425
                                    - Arn
                        - ''
                  - '*'
            Sid: TagTasks
          - Action:
              - 'sqs:ReceiveMessage'
              - 'sqs:ChangeMessageVisibility'
              - 'sqs:GetQueueUrl'
              - 'sqs:DeleteMessage'
              - 'sqs:GetQueueAttributes'
            Effect: Allow
            Resource:
              'Fn::GetAtt':
                - withoutcontrolpanelretirementwatcherqueueBD75939D
                - Arn
        Version: '2012-10-17'
      PolicyName: >-
        withoutcontrolpanelretirementwatcherlambdaexecutionroleDefaultPolicy22F23EB8
      Roles:
        - Ref: withoutcontrolpanelretirementwatcherlambdaexecutionrole9DA580C7
  withoutcontrolpanelretirementwatcherlambdaD19E1F91:
    Type: 'AWS::Lambda::Function'
    Properties:
      Architectures:
        - arm64
      Code: Any<Object>
      Handler: index.handler
      Role:
        'Fn::GetAtt':
          - withoutcontrolpanelretirementwatcherlambdaexecutionrole9DA580C7
          - Arn
      Runtime: nodejs22.x
      Tags:
        - Key: Name
          Value: RestateBYOC/without-control-panel/retirement-watcher-lambda
      Timeout: 60
    DependsOn:
      - >-
        withoutcontrolpanelretirementwatcherlambdaexecutionroleDefaultPolicy22F23EB8
      - withoutcontrolpanelretirementwatcherlambdaexecutionrole9DA580C7
  withoutcontrolpanelretirementwatcherlambdaSqsEventSourceRestateBYOCwithoutcontrolpanelretirementwatcherqueueB3332F8AF175E476:
    Type: 'AWS::Lambda::EventSourceMapping'
    Properties:
      BatchSize: 1
      EventSourceArn:
        'Fn::GetAtt':
          - withoutcontrolpanelretirementwatcherqueueBD75939D
          - Arn
      FunctionName:
        Ref: withoutcontrolpanelretirementwatcherlambdaD19E1F91
      Tags:
        - Key: Name
          Value: RestateBYOC/without-control-panel/retirement-watcher-lambda
  withoutcontrolpanelretirementwatcherqueueBD75939D:
    Type: 'AWS::SQS::Queue'
    Properties:
      Tags:
        - Key: Name
          Value: RestateBYOC/without-control-panel/retirement-watcher-queue
      VisibilityTimeout: 60
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  withoutcontrolpanelretirementwatcherqueuePolicy1F70707B:
    Type: 'AWS::SQS::QueuePolicy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 'sqs:SendMessage'
              - 'sqs:GetQueueAttributes'
              - 'sqs:GetQueueUrl'
            Condition:
              ArnEquals:
                'aws:SourceArn':
                  'Fn::GetAtt':
                    - withoutcontrolpanelretirementwatcherruleA41BA6E8
                    - Arn
            Effect: Allow
            Principal:
              Service: events.amazonaws.com
            Resource:
              'Fn::GetAtt':
                - withoutcontrolpanelretirementwatcherqueueBD75939D
                - Arn
        Version: '2012-10-17'
      Queues:
        - Ref: withoutcontrolpanelretirementwatcherqueueBD75939D
  withoutcontrolpanelretirementwatcherruleA41BA6E8:
    Type: 'AWS::Events::Rule'
    Properties:
      EventPattern:
        detail:
          eventTypeCode:
            - equals-ignore-case: AWS_ECS_TASK_PATCHING_RETIREMENT
          service:
            - equals-ignore-case: ecs
        resources:
          - prefix:
              'Fn::Join':
                - /
                - - 'Fn::Join':
                      - ':'
                      - - 'Fn::Select':
                            - 0
                            - 'Fn::Split':
                                - ':'
                                - 'Fn::Select':
                                    - 0
                                    - 'Fn::Split':
                                        - /
                                        - 'Fn::GetAtt':
                                            - withoutcontrolpanelcluster0BE3B425
                                            - Arn
                        - 'Fn::Select':
                            - 1
                            - 'Fn::Split':
                                - ':'
                                - 'Fn::Select':
                                    - 0
                                    - 'Fn::Split':
                                        - /
                                        - 'Fn::GetAtt':
                                            - withoutcontrolpanelcluster0BE3B425
                                            - Arn
                        - 'Fn::Select':
                            - 2
                            - 'Fn::Split':
                                - ':'
                                - 'Fn::Select':
                                    - 0
                                    - 'Fn::Split':
                                        - /
                                        - 'Fn::GetAtt':
                                            - withoutcontrolpanelcluster0BE3B425
                                            - Arn
                        - 'Fn::Select':
                            - 3
                            - 'Fn::Split':
                                - ':'
                                - 'Fn::Select':
                                    - 0
                                    - 'Fn::Split':
                                        - /
                                        - 'Fn::GetAtt':
                                            - withoutcontrolpanelcluster0BE3B425
                                            - Arn
                        - 'Fn::Select':
                            - 4
                            - 'Fn::Split':
                                - ':'
                                - 'Fn::Select':
                                    - 0
                                    - 'Fn::Split':
                                        - /
                                        - 'Fn::GetAtt':
                                            - withoutcontrolpanelcluster0BE3B425
                                            - Arn
                        - task
                  - 'Fn::Select':
                      - 1
                      - 'Fn::Split':
                          - /
                          - 'Fn::GetAtt':
                              - withoutcontrolpanelcluster0BE3B425
                              - Arn
                  - ''
        detail-type:
          - equals-ignore-case: AWS Health Event
      State: ENABLED
      Targets:
        - Arn:
            'Fn::GetAtt':
              - withoutcontrolpanelretirementwatcherqueueBD75939D
              - Arn
          Id: Target0
  withoutcontrolpanelcloudwatchcustomwidgetexecutionrole8A8BA07A:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
        Version: '2012-10-17'
  withoutcontrolpanelcloudwatchcustomwidgetexecutionroleDefaultPolicyED9B7BED:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 'logs:CreateLogGroup'
              - 'logs:CreateLogStream'
              - 'logs:PutLogEvents'
            Effect: Allow
            Resource: '*'
            Sid: AWSLambdaBasicExecutionPermissions
          - Action: 'lambda:InvokeFunction'
            Effect: Allow
            Resource:
              'Fn::GetAtt':
                - withoutcontrolpanelrestatectllambda043A6A30
                - Arn
            Sid: InvokeRestatectl
          - Action:
              - 'ec2:DescribeVolumes'
              - 'ec2:DescribeVolumeStatus'
            Effect: Allow
            Resource: '*'
            Sid: EC2ReadActions
          - Action: 'ecs:DescribeTaskDefinition'
            Effect: Allow
            Resource: '*'
            Sid: ECSReadActions
          - Action: 'ecs:ListTasks'
            Condition:
              StringEquals:
                'ecs:cluster':
                  'Fn::GetAtt':
                    - withoutcontrolpanelcluster0BE3B425
                    - Arn
            Effect: Allow
            Resource: '*'
            Sid: ECSListTasks
          - Action: 'ecs:DescribeTasks'
            Condition:
              StringEquals:
                'ecs:cluster':
                  'Fn::GetAtt':
                    - withoutcontrolpanelcluster0BE3B425
                    - Arn
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'arn:'
                  - Ref: 'AWS::Partition'
                  - ':ecs:'
                  - Ref: 'AWS::Region'
                  - ':'
                  - Ref: 'AWS::AccountId'
                  - ':task/'
                  - Ref: withoutcontrolpanelcluster0BE3B425
                  - /*
            Sid: ECSDescribeTasks
          - Action: 'ecs:DescribeServices'
            Condition:
              StringEquals:
                'ecs:cluster':
                  'Fn::GetAtt':
                    - withoutcontrolpanelcluster0BE3B425
                    - Arn
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'arn:'
                  - Ref: 'AWS::Partition'
                  - ':ecs:'
                  - Ref: 'AWS::Region'
                  - ':'
                  - Ref: 'AWS::AccountId'
                  - ':service/'
                  - Ref: withoutcontrolpanelcluster0BE3B425
                  - /*
            Sid: ECSDescribeServices
          - Action: 'cloudwatch:GetMetricData'
            Effect: Allow
            Resource: '*'
            Sid: CloudWatchReadActions
        Version: '2012-10-17'
      PolicyName: >-
        withoutcontrolpanelcloudwatchcustomwidgetexecutionroleDefaultPolicyED9B7BED
      Roles:
        - Ref: withoutcontrolpanelcloudwatchcustomwidgetexecutionrole8A8BA07A
  withoutcontrolpanelcloudwatchcustomwidgetlambda99C7D1B8:
    Type: 'AWS::Lambda::Function'
    Properties:
      Architectures:
        - arm64
      Code: Any<Object>
      Handler: index.handler
      MemorySize: 1024
      Role:
        'Fn::GetAtt':
          - withoutcontrolpanelcloudwatchcustomwidgetexecutionrole8A8BA07A
          - Arn
      Runtime: nodejs22.x
      Tags:
        - Key: Name
          Value: RestateBYOC/without-control-panel/cloudwatch-custom-widget-lambda
      Timeout: 60
    DependsOn:
      - >-
        withoutcontrolpanelcloudwatchcustomwidgetexecutionroleDefaultPolicyED9B7BED
      - withoutcontrolpanelcloudwatchcustomwidgetexecutionrole8A8BA07A
  withoutcontrolpanelcloudwatchcustomwidgetlambdacloudwatchcustomwidgetlambdaallowdatasourceBF129BC8:
    Type: 'AWS::Lambda::Permission'
    Properties:
      Action: 'lambda:InvokeFunction'
      FunctionName:
        'Fn::GetAtt':
          - withoutcontrolpanelcloudwatchcustomwidgetlambda99C7D1B8
          - Arn
      Principal: lambda.datasource.cloudwatch.amazonaws.com
  withoutcontrolpanelmetrics7FC56984:
    Type: 'AWS::CloudWatch::Dashboard'
    Properties:
      DashboardBody:
        'Fn::Join':
          - ''
          - - >-
              {"widgets":[{"type":"metric","width":12,"height":6,"x":0,"y":0,"properties":{"view":"timeSeries","title":"Stateless
              CPU","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"CPU","expression":"cpu /
              1024"}],[{"expression":"SELECT AVG(CpuUtilized) FROM
              SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOCwithoutcontrolpanelstatelessdefinition80E3064F' GROUP
              BY
              TaskId","visible":false,"id":"cpu"}]],"annotations":{"horizontal":[{"value":16,"label":"Limit","yAxis":"left"}]},"yAxis":{"left":{"label":"vCPUs","showUnits":false}}}},{"type":"metric","width":12,"height":6,"x":12,"y":0,"properties":{"view":"timeSeries","title":"Stateless
              Memory","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Memory","expression":"memory /
              1024"}],[{"expression":"SELECT AVG(MemoryUtilized) FROM
              SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOCwithoutcontrolpanelstatelessdefinition80E3064F' GROUP
              BY
              TaskId","visible":false,"id":"memory"}]],"annotations":{"horizontal":[{"value":32,"label":"Limit","yAxis":"left"}]},"yAxis":{"left":{"label":"GiB","showUnits":false}}}},{"type":"metric","width":12,"height":6,"x":0,"y":6,"properties":{"view":"timeSeries","title":"Stateless
              Network Tx","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Tx","expression":"SELECT
              AVG(NetworkTxBytes) FROM SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOCwithoutcontrolpanelstatelessdefinition80E3064F' GROUP
              BY
              TaskId"}]],"yAxis":{"left":{"label":"Bytes/sec","showUnits":false}}}},{"type":"metric","width":12,"height":6,"x":12,"y":6,"properties":{"view":"timeSeries","title":"Stateless
              Network Rx","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Rx","expression":"SELECT
              AVG(NetworkRxBytes) FROM SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOCwithoutcontrolpanelstatelessdefinition80E3064F' GROUP
              BY
              TaskId"}]],"yAxis":{"left":{"label":"Bytes/sec","showUnits":false}}}},{"type":"log","width":24,"height":6,"x":0,"y":12,"properties":{"view":"table","title":"Stateless
              Logs","region":"region","query":"SOURCE '
            - Ref: withoutcontrolpanelstatelessdefinitionrestateLogGroupA8E6F021
            - >-
              ' | fields @logStream, @timestamp, level, fields.message,
              target\\n          | sort @timestamp desc\\n          | limit
              500"}},{"type":"metric","width":12,"height":6,"x":0,"y":18,"properties":{"view":"timeSeries","title":"Stateful
              CPU","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"CPU","expression":"cpu /
              1024"}],[{"expression":"SELECT AVG(CpuUtilized) FROM
              SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOCwithoutcontrolpanelstatefuldefinitionC1D30D6E' GROUP
              BY
              TaskId","visible":false,"id":"cpu"}]],"annotations":{"horizontal":[{"value":16,"label":"Limit","yAxis":"left"}]},"yAxis":{"left":{"label":"vCPUs","showUnits":false}}}},{"type":"metric","width":12,"height":6,"x":12,"y":18,"properties":{"view":"timeSeries","title":"Stateful
              Memory","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Memory","expression":"memory /
              1024"}],[{"expression":"SELECT AVG(MemoryUtilized) FROM
              SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOCwithoutcontrolpanelstatefuldefinitionC1D30D6E' GROUP
              BY
              TaskId","visible":false,"id":"memory"}]],"annotations":{"horizontal":[{"value":32,"label":"Limit","yAxis":"left"}]},"yAxis":{"left":{"label":"GiB","showUnits":false}}}},{"type":"metric","width":12,"height":6,"x":0,"y":24,"properties":{"view":"timeSeries","title":"Stateful
              Network Tx","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Tx","expression":"SELECT
              AVG(NetworkTxBytes) FROM SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOCwithoutcontrolpanelstatefuldefinitionC1D30D6E' GROUP
              BY
              TaskId"}]],"yAxis":{"left":{"label":"Bytes/sec","showUnits":false}}}},{"type":"metric","width":12,"height":6,"x":12,"y":24,"properties":{"view":"timeSeries","title":"Stateful
              Network Rx","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Rx","expression":"SELECT
              AVG(NetworkRxBytes) FROM SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOCwithoutcontrolpanelstatefuldefinitionC1D30D6E' GROUP
              BY
              TaskId"}]],"yAxis":{"left":{"label":"Bytes/sec","showUnits":false}}}},{"type":"log","width":24,"height":6,"x":0,"y":30,"properties":{"view":"table","title":"Stateful
              Logs","region":"region","query":"SOURCE '
            - Ref: withoutcontrolpanelstatefuldefinitionrestateLogGroupCCD0E826
            - >-
              ' | fields @logStream, @timestamp, level, fields.message,
              target\\n          | sort @timestamp desc\\n          | limit
              500"}},{"type":"metric","width":8,"height":6,"x":0,"y":36,"properties":{"view":"timeSeries","title":"Ephemeral
              Volume Usage (Total size 200GiB)","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Usage","expression":"SELECT
              MAX(EphemeralStorageUtilized) FROM
              SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily) WHERE TaskDefinitionFamily =
              'RestateBYOCwithoutcontrolpanelstatefuldefinitionC1D30D6E'"}]],"annotations":{"horizontal":[{"value":200,"label":"Volume
              size","visible":false,"yAxis":"left"}]},"yAxis":{"left":{"label":"GiB","showUnits":false}},"liveData":false}},{"type":"metric","width":8,"height":6,"x":8,"y":36,"properties":{"view":"timeSeries","title":"Volume
              Write Throughput (Limited to 150 MiB/sec)","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Write","expression":"RATE(count) /
              1048576"}],[{"expression":"SELECT MAX(StorageWriteBytes) FROM
              SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOCwithoutcontrolpanelstatefuldefinitionC1D30D6E' GROUP
              BY
              TaskId","visible":false,"id":"count"}]],"annotations":{"horizontal":[{"value":150,"label":"Limit","visible":false,"yAxis":"left"}]},"yAxis":{"left":{"label":"MiB/sec","showUnits":false}}}},{"type":"metric","width":8,"height":6,"x":16,"y":36,"properties":{"view":"timeSeries","title":"Volume
              Read Throughput (Limited to 150 MiB/sec)","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Read","expression":"RATE(count) /
              1048576"}],[{"expression":"SELECT MAX(StorageReadBytes) FROM
              SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOCwithoutcontrolpanelstatefuldefinitionC1D30D6E' GROUP
              BY
              TaskId","visible":false,"id":"count"}]],"annotations":{"horizontal":[{"value":150,"label":"Limit","visible":false,"yAxis":"left"}]},"yAxis":{"left":{"label":"MiB/sec","showUnits":false}}}},{"type":"log","width":24,"height":6,"x":0,"y":42,"properties":{"view":"table","title":"Controller
              Logs","region":"region","query":"SOURCE '
            - Ref: >-
                withoutcontrolpanelcontrollerdefinitioncontrollerLogGroup01AA3C71
            - >-
              ' | fields @logStream, @timestamp, level, fields.message,
              target\\n          | sort @timestamp desc\\n          | limit
              500"}}]}
      DashboardName: RestateBYOC_without-control-panel_metrics
  withoutcontrolpanelservicedeployerlambdaexecutionroleDF352819:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
        Version: '2012-10-17'
  withoutcontrolpanelservicedeployerlambdaexecutionroleDefaultPolicy6C7E48F1:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 'logs:CreateLogGroup'
              - 'logs:CreateLogStream'
              - 'logs:PutLogEvents'
              - 'ec2:CreateNetworkInterface'
              - 'ec2:DescribeNetworkInterfaces'
              - 'ec2:DescribeSubnets'
              - 'ec2:DeleteNetworkInterface'
              - 'ec2:AssignPrivateIpAddresses'
              - 'ec2:UnassignPrivateIpAddresses'
            Effect: Allow
            Resource: '*'
            Sid: AWSLambdaVPCAccessExecutionPermissions
        Version: '2012-10-17'
      PolicyName: >-
        withoutcontrolpanelservicedeployerlambdaexecutionroleDefaultPolicy6C7E48F1
      Roles:
        - Ref: withoutcontrolpanelservicedeployerlambdaexecutionroleDF352819
  withoutcontrolpanelservicedeployerEventHandler07AAAD8B:
    Type: 'AWS::Lambda::Function'
    Properties:
      Architectures:
        - arm64
      Code: Any<Object>
      Description: Restate custom registration handler
      Environment:
        Variables:
          NODE_OPTIONS: '--enable-source-maps'
      Handler: entrypoint.handler
      MemorySize: 128
      Role:
        'Fn::GetAtt':
          - withoutcontrolpanelservicedeployerlambdaexecutionroleDF352819
          - Arn
      Runtime: nodejs22.x
      Timeout: 180
      VpcConfig:
        SecurityGroupIds:
          - 'Fn::GetAtt':
              - withoutcontrolpanelsecuritygroup442A1897
              - GroupId
        SubnetIds:
          - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet1Subnet934893E8236E2271'
          - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet2Subnet7031C2BA60DCB1EE'
          - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet3Subnet985AC459F9514491'
    DependsOn:
      - >-
        withoutcontrolpanelservicedeployerlambdaexecutionroleDefaultPolicy6C7E48F1
      - withoutcontrolpanelservicedeployerlambdaexecutionroleDF352819
  withoutcontrolpanelservicedeployerDeploymentLogs005D410A:
    Type: 'AWS::Logs::LogGroup'
    Properties:
      LogGroupName:
        'Fn::Join':
          - ''
          - - /aws/lambda/
            - Ref: withoutcontrolpanelservicedeployerEventHandler07AAAD8B
      RetentionInDays: 30
    UpdateReplacePolicy: Retain
    DeletionPolicy: RetainExceptOnCreate
"
`;

exports[`BYOC Without custom widget lambda 1`] = `
"Resources:
  withoutcustomwidgetlambdasecuritygroup059AA659:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      GroupDescription: RestateBYOC/without-custom-widget-lambda/security-group
      SecurityGroupEgress:
        - CidrIp: 0.0.0.0/0
          Description: Allow all outbound traffic by default
          IpProtocol: '-1'
      Tags:
        - Key: Name
          Value: RestateBYOC/without-custom-widget-lambda/security-group
      VpcId:
        'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcA2121C384D1B3CDE'
  withoutcustomwidgetlambdasecuritygroupfromRestateBYOCwithoutcustomwidgetlambdasecuritygroupE9ED55208080A192DFD6:
    Type: 'AWS::EC2::SecurityGroupIngress'
    Properties:
      Description: 'from RestateBYOCwithoutcustomwidgetlambdasecuritygroupE9ED5520:8080'
      FromPort: 8080
      GroupId:
        'Fn::GetAtt':
          - withoutcustomwidgetlambdasecuritygroup059AA659
          - GroupId
      IpProtocol: tcp
      SourceSecurityGroupId:
        'Fn::GetAtt':
          - withoutcustomwidgetlambdasecuritygroup059AA659
          - GroupId
      ToPort: 8080
  withoutcustomwidgetlambdasecuritygroupfromRestateBYOCwithoutcustomwidgetlambdasecuritygroupE9ED552090701E0B2AA1:
    Type: 'AWS::EC2::SecurityGroupIngress'
    Properties:
      Description: 'from RestateBYOCwithoutcustomwidgetlambdasecuritygroupE9ED5520:9070'
      FromPort: 9070
      GroupId:
        'Fn::GetAtt':
          - withoutcustomwidgetlambdasecuritygroup059AA659
          - GroupId
      IpProtocol: tcp
      SourceSecurityGroupId:
        'Fn::GetAtt':
          - withoutcustomwidgetlambdasecuritygroup059AA659
          - GroupId
      ToPort: 9070
  withoutcustomwidgetlambdasecuritygroupfromRestateBYOCwithoutcustomwidgetlambdasecuritygroupE9ED552051229E548E9B:
    Type: 'AWS::EC2::SecurityGroupIngress'
    Properties:
      Description: 'from RestateBYOCwithoutcustomwidgetlambdasecuritygroupE9ED5520:5122'
      FromPort: 5122
      GroupId:
        'Fn::GetAtt':
          - withoutcustomwidgetlambdasecuritygroup059AA659
          - GroupId
      IpProtocol: tcp
      SourceSecurityGroupId:
        'Fn::GetAtt':
          - withoutcustomwidgetlambdasecuritygroup059AA659
          - GroupId
      ToPort: 5122
  withoutcustomwidgetlambdabucketE1197358:
    Type: 'AWS::S3::Bucket'
    Properties:
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
    UpdateReplacePolicy: Retain
    DeletionPolicy: Retain
  withoutcustomwidgetlambdabucketPolicy195D4A8C:
    Type: 'AWS::S3::BucketPolicy'
    Properties:
      Bucket:
        Ref: withoutcustomwidgetlambdabucketE1197358
      PolicyDocument:
        Statement:
          - Action: 's3:*'
            Condition:
              Bool:
                'aws:SecureTransport': 'false'
            Effect: Deny
            Principal:
              AWS: '*'
            Resource:
              - 'Fn::GetAtt':
                  - withoutcustomwidgetlambdabucketE1197358
                  - Arn
              - 'Fn::Join':
                  - ''
                  - - 'Fn::GetAtt':
                        - withoutcustomwidgetlambdabucketE1197358
                        - Arn
                    - /*
        Version: '2012-10-17'
  withoutcustomwidgetlambdacluster7C821260:
    Type: 'AWS::ECS::Cluster'
    Properties:
      ClusterSettings:
        - Name: containerInsights
          Value: enhanced
      Tags:
        - Key: Name
          Value: RestateBYOC/without-custom-widget-lambda/cluster
  withoutcustomwidgetlambdarestatetaskroleB95E12D3:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
        Version: '2012-10-17'
  withoutcustomwidgetlambdarestatetaskroleDefaultPolicyF03DC3AE:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 's3:GetObject'
              - 's3:PutObject'
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'Fn::GetAtt':
                      - withoutcustomwidgetlambdabucketE1197358
                      - Arn
                  - /*
            Sid: ReadWriteBucket
          - Action: 's3:ListBucket'
            Effect: Allow
            Resource:
              'Fn::GetAtt':
                - withoutcustomwidgetlambdabucketE1197358
                - Arn
            Sid: ListBucket
        Version: '2012-10-17'
      PolicyName: withoutcustomwidgetlambdarestatetaskroleDefaultPolicyF03DC3AE
      Roles:
        - Ref: withoutcustomwidgetlambdarestatetaskroleB95E12D3
  withoutcustomwidgetlambdarestateexecutionrole210C2BC1:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
        Version: '2012-10-17'
  withoutcustomwidgetlambdarestateexecutionroleDefaultPolicyABDF74CE:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 'logs:CreateLogStream'
              - 'logs:PutLogEvents'
            Effect: Allow
            Resource:
              'Fn::GetAtt':
                - >-
                  withoutcustomwidgetlambdastatelessdefinitionrestateLogGroupDB7E974E
                - Arn
          - Action:
              - 'logs:CreateLogStream'
              - 'logs:PutLogEvents'
            Effect: Allow
            Resource:
              'Fn::GetAtt':
                - >-
                  withoutcustomwidgetlambdastatefuldefinitionrestateLogGroup5C58F0AC
                - Arn
        Version: '2012-10-17'
      PolicyName: withoutcustomwidgetlambdarestateexecutionroleDefaultPolicyABDF74CE
      Roles:
        - Ref: withoutcustomwidgetlambdarestateexecutionrole210C2BC1
  withoutcustomwidgetlambdasharednlbB2365ABF:
    Type: 'AWS::ElasticLoadBalancingV2::LoadBalancer'
    Properties:
      LoadBalancerAttributes:
        - Key: deletion_protection.enabled
          Value: 'false'
        - Key: load_balancing.cross_zone.enabled
          Value: 'false'
        - Key: dns_record.client_routing_policy
          Value: availability_zone_affinity
      Scheme: internal
      SecurityGroups:
        - 'Fn::GetAtt':
            - withoutcustomwidgetlambdasecuritygroup059AA659
            - GroupId
      Subnets:
        - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet1Subnet934893E8236E2271'
        - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet2Subnet7031C2BA60DCB1EE'
        - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet3Subnet985AC459F9514491'
      Tags:
        - Key: Name
          Value: RestateBYOC/without-custom-widget-lambda/shared-nlb
      Type: network
  withoutcustomwidgetlambdaingresssharedlistener1C15A3B8:
    Type: 'AWS::ElasticLoadBalancingV2::Listener'
    Properties:
      DefaultActions:
        - TargetGroupArn:
            Ref: withoutcustomwidgetlambdaingresssharedtarget4513DA2B
          Type: forward
      LoadBalancerArn:
        Ref: withoutcustomwidgetlambdasharednlbB2365ABF
      Port: 8080
      Protocol: TCP
  withoutcustomwidgetlambdaadminsharedlistener7B0C99C3:
    Type: 'AWS::ElasticLoadBalancingV2::Listener'
    Properties:
      DefaultActions:
        - TargetGroupArn:
            Ref: withoutcustomwidgetlambdaadminsharedtargetA08818F7
          Type: forward
      LoadBalancerArn:
        Ref: withoutcustomwidgetlambdasharednlbB2365ABF
      Port: 9070
      Protocol: TCP
  withoutcustomwidgetlambdanodesharedlistener49377192:
    Type: 'AWS::ElasticLoadBalancingV2::Listener'
    Properties:
      DefaultActions:
        - TargetGroupArn:
            Ref: withoutcustomwidgetlambdanodesharedtargetEA761A0C
          Type: forward
      LoadBalancerArn:
        Ref: withoutcustomwidgetlambdasharednlbB2365ABF
      Port: 5122
      Protocol: TCP
  withoutcustomwidgetlambdastatelessdefinition36FD513C:
    Type: 'AWS::ECS::TaskDefinition'
    Properties:
      ContainerDefinitions:
        - Cpu: 16384
          EntryPoint:
            - bash
            - '-c'
            - >

              curl --no-progress-meter $ECS_CONTAINER_METADATA_URI_V4/task -o
              task-metadata && \\

              export \\
                RESTATE_NODE_NAME=$(jq -r '.TaskARN' task-metadata) \\
                RESTATE_LOCATION="$AWS_REGION.$(jq -r '.AvailabilityZone' task-metadata)" \\
                RESTATE_ADVERTISED_ADDRESS="http://$(jq -r '.Containers[0].Networks[0].IPv4Addresses[0]' task-metadata):5122"
              exec restate-server
          Environment:
            - Name: RESTATE_LOG_FORMAT
              Value: json
            - Name: RESTATE_CLUSTER_NAME
              Value: RestateBYOC/without-custom-widget-lambda
            - Name: RESTATE_ROLES
              Value: '["admin","http-ingress"]'
            - Name: RESTATE_AUTO_PROVISION
              Value: 'true'
            - Name: RESTATE_SHUTDOWN_TIMEOUT
              Value: 100s
            - Name: RESTATE_DEFAULT_NUM_PARTITIONS
              Value: '128'
            - Name: RESTATE_DEFAULT_REPLICATION
              Value: '{zone: 2}'
            - Name: RESTATE_METADATA_CLIENT__TYPE
              Value: object-store
            - Name: RESTATE_METADATA_CLIENT__PATH
              Value:
                'Fn::Join':
                  - ''
                  - - 's3://'
                    - Ref: withoutcustomwidgetlambdabucketE1197358
                    - /metadata
            - Name: RESTATE_BIFROST__DEFAULT_PROVIDER
              Value: replicated
            - Name: >-
                RESTATE_INGRESS__EXPERIMENTAL_FEATURE_ENABLE_SEPARATE_INGRESS_ROLE
              Value: 'true'
            - Name: RESTATE_INGRESS__ADVERTISED_INGRESS_ENDPOINT
              Value:
                'Fn::Join':
                  - ''
                  - - 'http://'
                    - 'Fn::GetAtt':
                        - withoutcustomwidgetlambdasharednlbB2365ABF
                        - DNSName
                    - ':8080'
            - Name: RESTATE_WORKER__SNAPSHOTS__DESTINATION
              Value:
                'Fn::Join':
                  - ''
                  - - 's3://'
                    - Ref: withoutcustomwidgetlambdabucketE1197358
                    - /snapshots
          Essential: true
          HealthCheck:
            Command:
              - CMD
              - curl
              - '--fail'
              - 'http://127.0.0.1:8080/restate/health'
            Interval: 30
            Retries: 3
            Timeout: 5
          Image: Any<Object>
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group:
                Ref: >-
                  withoutcustomwidgetlambdastatelessdefinitionrestateLogGroupDB7E974E
              awslogs-stream-prefix: restate
              awslogs-region: region
          Memory: 32768
          Name: restate
          PortMappings:
            - ContainerPort: 8080
              Name: ingress
              Protocol: tcp
            - ContainerPort: 9070
              Name: admin
              Protocol: tcp
            - ContainerPort: 5122
              Name: node
              Protocol: tcp
          StopTimeout: 120
      Cpu: '16384'
      ExecutionRoleArn:
        'Fn::GetAtt':
          - withoutcustomwidgetlambdarestateexecutionrole210C2BC1
          - Arn
      Family: RestateBYOCwithoutcustomwidgetlambdastatelessdefinition87FC0137
      Memory: '32768'
      NetworkMode: awsvpc
      RequiresCompatibilities:
        - FARGATE
      RuntimePlatform:
        CpuArchitecture: ARM64
        OperatingSystemFamily: LINUX
      Tags:
        - Key: Name
          Value: RestateBYOC/without-custom-widget-lambda/stateless-definition
      TaskRoleArn:
        'Fn::GetAtt':
          - withoutcustomwidgetlambdarestatetaskroleB95E12D3
          - Arn
  withoutcustomwidgetlambdastatelessdefinitionrestateLogGroupDB7E974E:
    Type: 'AWS::Logs::LogGroup'
    Properties:
      Tags:
        - Key: Name
          Value: RestateBYOC/without-custom-widget-lambda/stateless-definition
    UpdateReplacePolicy: Retain
    DeletionPolicy: Retain
  withoutcustomwidgetlambdastatelessserviceService0766D47F:
    Type: 'AWS::ECS::Service'
    Properties:
      Cluster:
        Ref: withoutcustomwidgetlambdacluster7C821260
      DeploymentConfiguration:
        Alarms:
          AlarmNames: []
          Enable: false
          Rollback: false
        MaximumPercent: 200
        MinimumHealthyPercent: 100
      DesiredCount: 3
      EnableECSManagedTags: false
      EnableExecuteCommand: false
      HealthCheckGracePeriodSeconds: 60
      LaunchType: FARGATE
      LoadBalancers:
        - ContainerName: restate
          ContainerPort: 8080
          TargetGroupArn:
            Ref: withoutcustomwidgetlambdaingresssharedtarget4513DA2B
        - ContainerName: restate
          ContainerPort: 9070
          TargetGroupArn:
            Ref: withoutcustomwidgetlambdaadminsharedtargetA08818F7
        - ContainerName: restate
          ContainerPort: 5122
          TargetGroupArn:
            Ref: withoutcustomwidgetlambdanodesharedtargetEA761A0C
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: DISABLED
          SecurityGroups:
            - 'Fn::GetAtt':
                - withoutcustomwidgetlambdasecuritygroup059AA659
                - GroupId
          Subnets:
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet1Subnet934893E8236E2271'
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet2Subnet7031C2BA60DCB1EE'
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet3Subnet985AC459F9514491'
      PropagateTags: SERVICE
      Tags:
        - Key: Name
          Value: RestateBYOC/without-custom-widget-lambda/stateless-service
      TaskDefinition:
        Ref: withoutcustomwidgetlambdastatelessdefinition36FD513C
    DependsOn:
      - withoutcustomwidgetlambdaadminsharedlistener7B0C99C3
      - withoutcustomwidgetlambdaingresssharedlistener1C15A3B8
      - withoutcustomwidgetlambdanodesharedlistener49377192
      - withoutcustomwidgetlambdarestatetaskroleDefaultPolicyF03DC3AE
      - withoutcustomwidgetlambdarestatetaskroleB95E12D3
  withoutcustomwidgetlambdastatefuldefinition0381E003:
    Type: 'AWS::ECS::TaskDefinition'
    Properties:
      ContainerDefinitions:
        - Cpu: 16384
          EntryPoint:
            - bash
            - '-c'
            - >

              curl --no-progress-meter $ECS_CONTAINER_METADATA_URI_V4/task -o
              task-metadata && \\

              export \\
                RESTATE_NODE_NAME=$(jq -r '.TaskARN' task-metadata) \\
                RESTATE_LOCATION="$AWS_REGION.$(jq -r '.AvailabilityZone' task-metadata)" \\
                RESTATE_ADVERTISED_ADDRESS="http://$(jq -r '.Containers[0].Networks[0].IPv4Addresses[0]' task-metadata):5122"
              exec restate-server
          Environment:
            - Name: RESTATE_LOG_FORMAT
              Value: json
            - Name: RESTATE_CLUSTER_NAME
              Value: RestateBYOC/without-custom-widget-lambda
            - Name: RESTATE_ROLES
              Value: '["log-server", "worker"]'
            - Name: RESTATE_AUTO_PROVISION
              Value: 'false'
            - Name: RESTATE_SHUTDOWN_TIMEOUT
              Value: 100s
            - Name: RESTATE_ROCKSDB_TOTAL_MEMORY_SIZE
              Value: 24576MiB
            - Name: RESTATE_METADATA_CLIENT__TYPE
              Value: object-store
            - Name: RESTATE_METADATA_CLIENT__PATH
              Value:
                'Fn::Join':
                  - ''
                  - - 's3://'
                    - Ref: withoutcustomwidgetlambdabucketE1197358
                    - /metadata
            - Name: RESTATE_WORKER__SNAPSHOTS__DESTINATION
              Value:
                'Fn::Join':
                  - ''
                  - - 's3://'
                    - Ref: withoutcustomwidgetlambdabucketE1197358
                    - /snapshots
            - Name: RESTATE_WORKER__SNAPSHOTS__SNAPSHOT_INTERVAL_NUM_RECORDS
              Value: '1000000'
            - Name: RESTATE_WORKER__STORAGE__ROCKSDB_DISABLE_DIRECT_IO_FOR_READS
              Value: 'true'
            - Name: RESTATE_WORKER__STORAGE__ROCKSDB_DISABLE_WAL_FSYNC
              Value: 'true'
            - Name: RESTATE_LOG_SERVER__ROCKSDB_DISABLE_WAL_FSYNC
              Value: 'true'
            - Name: RESTATE_LOG_SERVER__ROCKSDB_DISABLE_DIRECT_IO_FOR_READS
              Value: 'true'
            - Name: >-
                RESTATE_INGRESS__EXPERIMENTAL_FEATURE_ENABLE_SEPARATE_INGRESS_ROLE
              Value: 'true'
          Essential: true
          HealthCheck:
            Command:
              - CMD
              - curl
              - '--fail'
              - 'http://127.0.0.1:5122/health'
            Interval: 30
            Retries: 3
            Timeout: 5
          Image: Any<Object>
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group:
                Ref: >-
                  withoutcustomwidgetlambdastatefuldefinitionrestateLogGroup5C58F0AC
              awslogs-stream-prefix: restate
              awslogs-region: region
          Memory: 32768
          MountPoints:
            - ContainerPath: /restate-data
              ReadOnly: false
              SourceVolume: restate-data
          Name: restate
          PortMappings:
            - ContainerPort: 5122
              Name: node
              Protocol: tcp
          RestartPolicy:
            Enabled: true
            RestartAttemptPeriod: 60
          StopTimeout: 120
      Cpu: '16384'
      EphemeralStorage:
        SizeInGiB: 200
      ExecutionRoleArn:
        'Fn::GetAtt':
          - withoutcustomwidgetlambdarestateexecutionrole210C2BC1
          - Arn
      Family: RestateBYOCwithoutcustomwidgetlambdastatefuldefinition5F6BAEB6
      Memory: '32768'
      NetworkMode: awsvpc
      RequiresCompatibilities:
        - FARGATE
      RuntimePlatform:
        CpuArchitecture: ARM64
        OperatingSystemFamily: LINUX
      Tags:
        - Key: Name
          Value: RestateBYOC/without-custom-widget-lambda/stateful-definition
      TaskRoleArn:
        'Fn::GetAtt':
          - withoutcustomwidgetlambdarestatetaskroleB95E12D3
          - Arn
      Volumes:
        - ConfiguredAtLaunch: false
          Name: restate-data
  withoutcustomwidgetlambdastatefuldefinitionrestateLogGroup5C58F0AC:
    Type: 'AWS::Logs::LogGroup'
    Properties:
      Tags:
        - Key: Name
          Value: RestateBYOC/without-custom-widget-lambda/stateful-definition
    UpdateReplacePolicy: Retain
    DeletionPolicy: Retain
  withoutcustomwidgetlambdaingresssharedtarget4513DA2B:
    Type: 'AWS::ElasticLoadBalancingV2::TargetGroup'
    Properties:
      HealthCheckEnabled: true
      HealthCheckIntervalSeconds: 5
      HealthCheckPath: /restate/health
      HealthCheckProtocol: HTTP
      HealthCheckTimeoutSeconds: 2
      Port: 8080
      Protocol: TCP
      Tags:
        - Key: Name
          Value: RestateBYOC/without-custom-widget-lambda/ingress-shared-target
      TargetType: ip
      VpcId:
        'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcA2121C384D1B3CDE'
  withoutcustomwidgetlambdaadminsharedtargetA08818F7:
    Type: 'AWS::ElasticLoadBalancingV2::TargetGroup'
    Properties:
      HealthCheckEnabled: true
      HealthCheckIntervalSeconds: 5
      HealthCheckPath: /health
      HealthCheckPort: '9070'
      HealthCheckProtocol: HTTP
      HealthCheckTimeoutSeconds: 2
      Port: 9070
      Protocol: TCP
      Tags:
        - Key: Name
          Value: RestateBYOC/without-custom-widget-lambda/admin-shared-target
      TargetType: ip
      VpcId:
        'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcA2121C384D1B3CDE'
  withoutcustomwidgetlambdanodesharedtargetEA761A0C:
    Type: 'AWS::ElasticLoadBalancingV2::TargetGroup'
    Properties:
      HealthCheckEnabled: true
      HealthCheckIntervalSeconds: 5
      HealthCheckPath: /health
      HealthCheckPort: '5122'
      HealthCheckProtocol: HTTP
      HealthCheckTimeoutSeconds: 2
      Port: 5122
      Protocol: TCP
      Tags:
        - Key: Name
          Value: RestateBYOC/without-custom-widget-lambda/node-shared-target
      TargetType: ip
      VpcId:
        'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcA2121C384D1B3CDE'
  withoutcustomwidgetlambdacontrollertaskroleDAFDD428:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
        Version: '2012-10-17'
  withoutcustomwidgetlambdacontrollertaskroleDefaultPolicyB4762FC8:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 'ecs:ListTasks'
              - 'ecs:DescribeTasks'
              - 'ecs:StopTask'
            Condition:
              ArnEquals:
                'ecs:cluster':
                  'Fn::GetAtt':
                    - withoutcustomwidgetlambdacluster7C821260
                    - Arn
            Effect: Allow
            Resource: '*'
            Sid: TaskActions
          - Action: 'ecs:TagResource'
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'Fn::Join':
                      - /
                      - - 'Fn::Join':
                            - ':'
                            - - 'Fn::Select':
                                  - 0
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - withoutcustomwidgetlambdacluster7C821260
                                                  - Arn
                              - 'Fn::Select':
                                  - 1
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - withoutcustomwidgetlambdacluster7C821260
                                                  - Arn
                              - 'Fn::Select':
                                  - 2
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - withoutcustomwidgetlambdacluster7C821260
                                                  - Arn
                              - 'Fn::Select':
                                  - 3
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - withoutcustomwidgetlambdacluster7C821260
                                                  - Arn
                              - 'Fn::Select':
                                  - 4
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - withoutcustomwidgetlambdacluster7C821260
                                                  - Arn
                              - task
                        - 'Fn::Select':
                            - 1
                            - 'Fn::Split':
                                - /
                                - 'Fn::GetAtt':
                                    - withoutcustomwidgetlambdacluster7C821260
                                    - Arn
                        - ''
                  - '*'
            Sid: TagTasks
          - Action: 'ecs:RunTask'
            Condition:
              ArnEquals:
                'ecs:cluster':
                  'Fn::GetAtt':
                    - withoutcustomwidgetlambdacluster7C821260
                    - Arn
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'Fn::Join':
                      - ':'
                      - - 'Fn::Select':
                            - 0
                            - 'Fn::Split':
                                - ':'
                                - Ref: >-
                                    withoutcustomwidgetlambdastatefuldefinition0381E003
                        - 'Fn::Select':
                            - 1
                            - 'Fn::Split':
                                - ':'
                                - Ref: >-
                                    withoutcustomwidgetlambdastatefuldefinition0381E003
                        - 'Fn::Select':
                            - 2
                            - 'Fn::Split':
                                - ':'
                                - Ref: >-
                                    withoutcustomwidgetlambdastatefuldefinition0381E003
                        - 'Fn::Select':
                            - 3
                            - 'Fn::Split':
                                - ':'
                                - Ref: >-
                                    withoutcustomwidgetlambdastatefuldefinition0381E003
                        - 'Fn::Select':
                            - 4
                            - 'Fn::Split':
                                - ':'
                                - Ref: >-
                                    withoutcustomwidgetlambdastatefuldefinition0381E003
                        - 'Fn::Select':
                            - 5
                            - 'Fn::Split':
                                - ':'
                                - Ref: >-
                                    withoutcustomwidgetlambdastatefuldefinition0381E003
                  - ':*'
            Sid: RunTask
          - Action: 'iam:PassRole'
            Condition:
              StringEquals:
                'iam:PassedToService': ecs-tasks.amazonaws.com
            Effect: Allow
            Resource:
              - 'Fn::GetAtt':
                  - withoutcustomwidgetlambdarestatetaskroleB95E12D3
                  - Arn
              - 'Fn::GetAtt':
                  - withoutcustomwidgetlambdarestateexecutionrole210C2BC1
                  - Arn
            Sid: RunTaskPassRole
          - Action:
              - 's3:GetObject'
              - 's3:PutObject'
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'Fn::GetAtt':
                      - withoutcustomwidgetlambdabucketE1197358
                      - Arn
                  - /*
            Sid: ReadWriteBucket
          - Action: 's3:ListBucket'
            Effect: Allow
            Resource:
              'Fn::GetAtt':
                - withoutcustomwidgetlambdabucketE1197358
                - Arn
            Sid: ListBucket
        Version: '2012-10-17'
      PolicyName: withoutcustomwidgetlambdacontrollertaskroleDefaultPolicyB4762FC8
      Roles:
        - Ref: withoutcustomwidgetlambdacontrollertaskroleDAFDD428
  withoutcustomwidgetlambdacontrollerexecutionrole59813F9F:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
        Version: '2012-10-17'
  withoutcustomwidgetlambdacontrollerexecutionroleDefaultPolicyBF00E7FF:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 'logs:CreateLogStream'
              - 'logs:PutLogEvents'
            Effect: Allow
            Resource:
              'Fn::GetAtt':
                - >-
                  withoutcustomwidgetlambdacontrollerdefinitioncontrollerLogGroup0EA5E86D
                - Arn
        Version: '2012-10-17'
      PolicyName: withoutcustomwidgetlambdacontrollerexecutionroleDefaultPolicyBF00E7FF
      Roles:
        - Ref: withoutcustomwidgetlambdacontrollerexecutionrole59813F9F
  withoutcustomwidgetlambdacontrollerdefinition9A68C57D:
    Type: 'AWS::ECS::TaskDefinition'
    Properties:
      ContainerDefinitions:
        - Cpu: 1024
          Environment:
            - Name: RUST_LOG
              Value: 'info,restate_fargate_controller=debug'
            - Name: CONTROLLER_LOG_FORMAT
              Value: json
            - Name: CONTROLLER_METADATA_PATH
              Value:
                'Fn::Join':
                  - ''
                  - - 's3://'
                    - Ref: withoutcustomwidgetlambdabucketE1197358
                    - /metadata
            - Name: CONTROLLER_RECONCILE_INTERVAL
              Value: 10s
            - Name: CONTROLLER_CLUSTER__CLUSTER_ARN
              Value:
                'Fn::GetAtt':
                  - withoutcustomwidgetlambdacluster7C821260
                  - Arn
            - Name: CONTROLLER_LICENSE_ID
              Value: foo
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __REGION
              Value:
                Ref: 'AWS::Region'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __CLUSTER_ARN
              Value:
                'Fn::GetAtt':
                  - withoutcustomwidgetlambdacluster7C821260
                  - Arn
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __TASK_PREFIX
              Value:
                'Fn::Join':
                  - /
                  - - 'Fn::Join':
                        - ':'
                        - - 'Fn::Select':
                              - 0
                              - 'Fn::Split':
                                  - ':'
                                  - 'Fn::Select':
                                      - 0
                                      - 'Fn::Split':
                                          - /
                                          - 'Fn::GetAtt':
                                              - withoutcustomwidgetlambdacluster7C821260
                                              - Arn
                          - 'Fn::Select':
                              - 1
                              - 'Fn::Split':
                                  - ':'
                                  - 'Fn::Select':
                                      - 0
                                      - 'Fn::Split':
                                          - /
                                          - 'Fn::GetAtt':
                                              - withoutcustomwidgetlambdacluster7C821260
                                              - Arn
                          - 'Fn::Select':
                              - 2
                              - 'Fn::Split':
                                  - ':'
                                  - 'Fn::Select':
                                      - 0
                                      - 'Fn::Split':
                                          - /
                                          - 'Fn::GetAtt':
                                              - withoutcustomwidgetlambdacluster7C821260
                                              - Arn
                          - 'Fn::Select':
                              - 3
                              - 'Fn::Split':
                                  - ':'
                                  - 'Fn::Select':
                                      - 0
                                      - 'Fn::Split':
                                          - /
                                          - 'Fn::GetAtt':
                                              - withoutcustomwidgetlambdacluster7C821260
                                              - Arn
                          - 'Fn::Select':
                              - 4
                              - 'Fn::Split':
                                  - ':'
                                  - 'Fn::Select':
                                      - 0
                                      - 'Fn::Split':
                                          - /
                                          - 'Fn::GetAtt':
                                              - withoutcustomwidgetlambdacluster7C821260
                                              - Arn
                          - task
                    - 'Fn::Select':
                        - 1
                        - 'Fn::Split':
                            - /
                            - 'Fn::GetAtt':
                                - withoutcustomwidgetlambdacluster7C821260
                                - Arn
                    - ''
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1a__ENABLE_EXECUTE_COMMAND
              Value: 'false'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1a__SECURITY_GROUPS
              Value:
                'Fn::Join':
                  - ''
                  - - '["'
                    - 'Fn::GetAtt':
                        - withoutcustomwidgetlambdasecuritygroup059AA659
                        - GroupId
                    - '"]'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1a__SUBNETS
              Value:
                'Fn::Join':
                  - ''
                  - - '["'
                    - 'Fn::ImportValue': >-
                        VPCStack:ExportsOutputRefvpcPrivateSubnet1Subnet934893E8236E2271
                    - '"]'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1a__TASK_DEFINITION_ARN
              Value:
                Ref: withoutcustomwidgetlambdastatefuldefinition0381E003
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1a__COUNT
              Value: '1'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1b__ENABLE_EXECUTE_COMMAND
              Value: 'false'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1b__SECURITY_GROUPS
              Value:
                'Fn::Join':
                  - ''
                  - - '["'
                    - 'Fn::GetAtt':
                        - withoutcustomwidgetlambdasecuritygroup059AA659
                        - GroupId
                    - '"]'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1b__SUBNETS
              Value:
                'Fn::Join':
                  - ''
                  - - '["'
                    - 'Fn::ImportValue': >-
                        VPCStack:ExportsOutputRefvpcPrivateSubnet2Subnet7031C2BA60DCB1EE
                    - '"]'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1b__TASK_DEFINITION_ARN
              Value:
                Ref: withoutcustomwidgetlambdastatefuldefinition0381E003
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1b__COUNT
              Value: '1'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1c__ENABLE_EXECUTE_COMMAND
              Value: 'false'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1c__SECURITY_GROUPS
              Value:
                'Fn::Join':
                  - ''
                  - - '["'
                    - 'Fn::GetAtt':
                        - withoutcustomwidgetlambdasecuritygroup059AA659
                        - GroupId
                    - '"]'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1c__SUBNETS
              Value:
                'Fn::Join':
                  - ''
                  - - '["'
                    - 'Fn::ImportValue': >-
                        VPCStack:ExportsOutputRefvpcPrivateSubnet3Subnet985AC459F9514491
                    - '"]'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1c__TASK_DEFINITION_ARN
              Value:
                Ref: withoutcustomwidgetlambdastatefuldefinition0381E003
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1c__COUNT
              Value: '1'
          Essential: true
          HealthCheck:
            Command:
              - CMD
              - curl
              - '--fail'
              - 'http://127.0.0.1:8080/health'
            Interval: 30
            Retries: 10
            StartPeriod: 300
            Timeout: 5
          Image: Any<Object>
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group:
                Ref: >-
                  withoutcustomwidgetlambdacontrollerdefinitioncontrollerLogGroup0EA5E86D
              awslogs-stream-prefix: controller
              awslogs-region: region
          Memory: 2048
          Name: controller
          StopTimeout: 120
      Cpu: '1024'
      ExecutionRoleArn:
        'Fn::GetAtt':
          - withoutcustomwidgetlambdacontrollerexecutionrole59813F9F
          - Arn
      Family: RestateBYOCwithoutcustomwidgetlambdacontrollerdefinition5D356644
      Memory: '2048'
      NetworkMode: awsvpc
      RequiresCompatibilities:
        - FARGATE
      RuntimePlatform:
        CpuArchitecture: ARM64
        OperatingSystemFamily: LINUX
      Tags:
        - Key: Name
          Value: RestateBYOC/without-custom-widget-lambda/controller-definition
      TaskRoleArn:
        'Fn::GetAtt':
          - withoutcustomwidgetlambdacontrollertaskroleDAFDD428
          - Arn
  withoutcustomwidgetlambdacontrollerdefinitioncontrollerLogGroup0EA5E86D:
    Type: 'AWS::Logs::LogGroup'
    Properties:
      Tags:
        - Key: Name
          Value: RestateBYOC/without-custom-widget-lambda/controller-definition
    UpdateReplacePolicy: Retain
    DeletionPolicy: Retain
  withoutcustomwidgetlambdacontrollerserviceServiceBF61F210:
    Type: 'AWS::ECS::Service'
    Properties:
      Cluster:
        Ref: withoutcustomwidgetlambdacluster7C821260
      DeploymentConfiguration:
        Alarms:
          AlarmNames: []
          Enable: false
          Rollback: false
        MaximumPercent: 100
        MinimumHealthyPercent: 0
      DesiredCount: 1
      EnableECSManagedTags: false
      EnableExecuteCommand: false
      LaunchType: FARGATE
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: DISABLED
          SecurityGroups:
            - 'Fn::GetAtt':
                - withoutcustomwidgetlambdasecuritygroup059AA659
                - GroupId
          Subnets:
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet1Subnet934893E8236E2271'
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet2Subnet7031C2BA60DCB1EE'
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet3Subnet985AC459F9514491'
      Tags:
        - Key: Name
          Value: RestateBYOC/without-custom-widget-lambda/controller-service
      TaskDefinition:
        Ref: withoutcustomwidgetlambdacontrollerdefinition9A68C57D
    DependsOn:
      - withoutcustomwidgetlambdacontrollertaskroleDefaultPolicyB4762FC8
      - withoutcustomwidgetlambdacontrollertaskroleDAFDD428
  withoutcustomwidgetlambdarestatectllambdaexecutionrole500BC62A:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
        Version: '2012-10-17'
  withoutcustomwidgetlambdarestatectllambdaexecutionroleDefaultPolicy10F8274D:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 'logs:CreateLogGroup'
              - 'logs:CreateLogStream'
              - 'logs:PutLogEvents'
              - 'ec2:CreateNetworkInterface'
              - 'ec2:DescribeNetworkInterfaces'
              - 'ec2:DescribeSubnets'
              - 'ec2:DeleteNetworkInterface'
              - 'ec2:AssignPrivateIpAddresses'
              - 'ec2:UnassignPrivateIpAddresses'
            Effect: Allow
            Resource: '*'
            Sid: AWSLambdaVPCAccessExecutionPermissions
        Version: '2012-10-17'
      PolicyName: >-
        withoutcustomwidgetlambdarestatectllambdaexecutionroleDefaultPolicy10F8274D
      Roles:
        - Ref: withoutcustomwidgetlambdarestatectllambdaexecutionrole500BC62A
  withoutcustomwidgetlambdarestatectllambdaFFD77DC1:
    Type: 'AWS::Lambda::Function'
    Properties:
      Architectures:
        - arm64
      Code: Any<Object>
      Environment:
        Variables:
          RESTATECTL_ADDRESS:
            'Fn::Join':
              - ''
              - - 'http://'
                - 'Fn::GetAtt':
                    - withoutcustomwidgetlambdasharednlbB2365ABF
                    - DNSName
                - ':5122'
      Handler: restatectl
      Role:
        'Fn::GetAtt':
          - withoutcustomwidgetlambdarestatectllambdaexecutionrole500BC62A
          - Arn
      Runtime: provided.al2023
      Tags:
        - Key: Name
          Value: RestateBYOC/without-custom-widget-lambda/restatectl-lambda
      Timeout: 10
      VpcConfig:
        SecurityGroupIds:
          - 'Fn::GetAtt':
              - withoutcustomwidgetlambdasecuritygroup059AA659
              - GroupId
        SubnetIds:
          - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet1Subnet934893E8236E2271'
          - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet2Subnet7031C2BA60DCB1EE'
          - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet3Subnet985AC459F9514491'
    DependsOn:
      - >-
        withoutcustomwidgetlambdarestatectllambdaexecutionroleDefaultPolicy10F8274D
      - withoutcustomwidgetlambdarestatectllambdaexecutionrole500BC62A
  withoutcustomwidgetlambdaretirementwatcherlambdaexecutionrole3A4078A7:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
        Version: '2012-10-17'
  withoutcustomwidgetlambdaretirementwatcherlambdaexecutionroleDefaultPolicyFB07B1C2:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 'logs:CreateLogGroup'
              - 'logs:CreateLogStream'
              - 'logs:PutLogEvents'
            Effect: Allow
            Resource: '*'
            Sid: AWSLambdaBasicExecutionPermissions
          - Action: 'ecs:TagResource'
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'Fn::Join':
                      - /
                      - - 'Fn::Join':
                            - ':'
                            - - 'Fn::Select':
                                  - 0
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - withoutcustomwidgetlambdacluster7C821260
                                                  - Arn
                              - 'Fn::Select':
                                  - 1
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - withoutcustomwidgetlambdacluster7C821260
                                                  - Arn
                              - 'Fn::Select':
                                  - 2
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - withoutcustomwidgetlambdacluster7C821260
                                                  - Arn
                              - 'Fn::Select':
                                  - 3
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - withoutcustomwidgetlambdacluster7C821260
                                                  - Arn
                              - 'Fn::Select':
                                  - 4
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - withoutcustomwidgetlambdacluster7C821260
                                                  - Arn
                              - task
                        - 'Fn::Select':
                            - 1
                            - 'Fn::Split':
                                - /
                                - 'Fn::GetAtt':
                                    - withoutcustomwidgetlambdacluster7C821260
                                    - Arn
                        - ''
                  - '*'
            Sid: TagTasks
          - Action:
              - 'sqs:ReceiveMessage'
              - 'sqs:ChangeMessageVisibility'
              - 'sqs:GetQueueUrl'
              - 'sqs:DeleteMessage'
              - 'sqs:GetQueueAttributes'
            Effect: Allow
            Resource:
              'Fn::GetAtt':
                - withoutcustomwidgetlambdaretirementwatcherqueue5A47873B
                - Arn
        Version: '2012-10-17'
      PolicyName: >-
        withoutcustomwidgetlambdaretirementwatcherlambdaexecutionroleDefaultPolicyFB07B1C2
      Roles:
        - Ref: >-
            withoutcustomwidgetlambdaretirementwatcherlambdaexecutionrole3A4078A7
  withoutcustomwidgetlambdaretirementwatcherlambdaECA07B7F:
    Type: 'AWS::Lambda::Function'
    Properties:
      Architectures:
        - arm64
      Code: Any<Object>
      Handler: index.handler
      Role:
        'Fn::GetAtt':
          - >-
            withoutcustomwidgetlambdaretirementwatcherlambdaexecutionrole3A4078A7
          - Arn
      Runtime: nodejs22.x
      Tags:
        - Key: Name
          Value: RestateBYOC/without-custom-widget-lambda/retirement-watcher-lambda
      Timeout: 60
    DependsOn:
      - >-
        withoutcustomwidgetlambdaretirementwatcherlambdaexecutionroleDefaultPolicyFB07B1C2
      - withoutcustomwidgetlambdaretirementwatcherlambdaexecutionrole3A4078A7
  withoutcustomwidgetlambdaretirementwatcherlambdaSqsEventSourceRestateBYOCwithoutcustomwidgetlambdaretirementwatcherqueue47EABDE5991BB55E:
    Type: 'AWS::Lambda::EventSourceMapping'
    Properties:
      BatchSize: 1
      EventSourceArn:
        'Fn::GetAtt':
          - withoutcustomwidgetlambdaretirementwatcherqueue5A47873B
          - Arn
      FunctionName:
        Ref: withoutcustomwidgetlambdaretirementwatcherlambdaECA07B7F
      Tags:
        - Key: Name
          Value: RestateBYOC/without-custom-widget-lambda/retirement-watcher-lambda
  withoutcustomwidgetlambdaretirementwatcherqueue5A47873B:
    Type: 'AWS::SQS::Queue'
    Properties:
      Tags:
        - Key: Name
          Value: RestateBYOC/without-custom-widget-lambda/retirement-watcher-queue
      VisibilityTimeout: 60
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  withoutcustomwidgetlambdaretirementwatcherqueuePolicy66E04590:
    Type: 'AWS::SQS::QueuePolicy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 'sqs:SendMessage'
              - 'sqs:GetQueueAttributes'
              - 'sqs:GetQueueUrl'
            Condition:
              ArnEquals:
                'aws:SourceArn':
                  'Fn::GetAtt':
                    - withoutcustomwidgetlambdaretirementwatcherrule22C5DADD
                    - Arn
            Effect: Allow
            Principal:
              Service: events.amazonaws.com
            Resource:
              'Fn::GetAtt':
                - withoutcustomwidgetlambdaretirementwatcherqueue5A47873B
                - Arn
        Version: '2012-10-17'
      Queues:
        - Ref: withoutcustomwidgetlambdaretirementwatcherqueue5A47873B
  withoutcustomwidgetlambdaretirementwatcherrule22C5DADD:
    Type: 'AWS::Events::Rule'
    Properties:
      EventPattern:
        detail:
          eventTypeCode:
            - equals-ignore-case: AWS_ECS_TASK_PATCHING_RETIREMENT
          service:
            - equals-ignore-case: ecs
        resources:
          - prefix:
              'Fn::Join':
                - /
                - - 'Fn::Join':
                      - ':'
                      - - 'Fn::Select':
                            - 0
                            - 'Fn::Split':
                                - ':'
                                - 'Fn::Select':
                                    - 0
                                    - 'Fn::Split':
                                        - /
                                        - 'Fn::GetAtt':
                                            - withoutcustomwidgetlambdacluster7C821260
                                            - Arn
                        - 'Fn::Select':
                            - 1
                            - 'Fn::Split':
                                - ':'
                                - 'Fn::Select':
                                    - 0
                                    - 'Fn::Split':
                                        - /
                                        - 'Fn::GetAtt':
                                            - withoutcustomwidgetlambdacluster7C821260
                                            - Arn
                        - 'Fn::Select':
                            - 2
                            - 'Fn::Split':
                                - ':'
                                - 'Fn::Select':
                                    - 0
                                    - 'Fn::Split':
                                        - /
                                        - 'Fn::GetAtt':
                                            - withoutcustomwidgetlambdacluster7C821260
                                            - Arn
                        - 'Fn::Select':
                            - 3
                            - 'Fn::Split':
                                - ':'
                                - 'Fn::Select':
                                    - 0
                                    - 'Fn::Split':
                                        - /
                                        - 'Fn::GetAtt':
                                            - withoutcustomwidgetlambdacluster7C821260
                                            - Arn
                        - 'Fn::Select':
                            - 4
                            - 'Fn::Split':
                                - ':'
                                - 'Fn::Select':
                                    - 0
                                    - 'Fn::Split':
                                        - /
                                        - 'Fn::GetAtt':
                                            - withoutcustomwidgetlambdacluster7C821260
                                            - Arn
                        - task
                  - 'Fn::Select':
                      - 1
                      - 'Fn::Split':
                          - /
                          - 'Fn::GetAtt':
                              - withoutcustomwidgetlambdacluster7C821260
                              - Arn
                  - ''
        detail-type:
          - equals-ignore-case: AWS Health Event
      State: ENABLED
      Targets:
        - Arn:
            'Fn::GetAtt':
              - withoutcustomwidgetlambdaretirementwatcherqueue5A47873B
              - Arn
          Id: Target0
  withoutcustomwidgetlambdametricsF1DE3D4C:
    Type: 'AWS::CloudWatch::Dashboard'
    Properties:
      DashboardBody:
        'Fn::Join':
          - ''
          - - >-
              {"widgets":[{"type":"metric","width":12,"height":6,"x":0,"y":0,"properties":{"view":"timeSeries","title":"Stateless
              CPU","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"CPU","expression":"cpu /
              1024"}],[{"expression":"SELECT AVG(CpuUtilized) FROM
              SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOCwithoutcustomwidgetlambdastatelessdefinition87FC0137'
              GROUP BY
              TaskId","visible":false,"id":"cpu"}]],"annotations":{"horizontal":[{"value":16,"label":"Limit","yAxis":"left"}]},"yAxis":{"left":{"label":"vCPUs","showUnits":false}}}},{"type":"metric","width":12,"height":6,"x":12,"y":0,"properties":{"view":"timeSeries","title":"Stateless
              Memory","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Memory","expression":"memory /
              1024"}],[{"expression":"SELECT AVG(MemoryUtilized) FROM
              SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOCwithoutcustomwidgetlambdastatelessdefinition87FC0137'
              GROUP BY
              TaskId","visible":false,"id":"memory"}]],"annotations":{"horizontal":[{"value":32,"label":"Limit","yAxis":"left"}]},"yAxis":{"left":{"label":"GiB","showUnits":false}}}},{"type":"metric","width":12,"height":6,"x":0,"y":6,"properties":{"view":"timeSeries","title":"Stateless
              Network Tx","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Tx","expression":"SELECT
              AVG(NetworkTxBytes) FROM SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOCwithoutcustomwidgetlambdastatelessdefinition87FC0137'
              GROUP BY
              TaskId"}]],"yAxis":{"left":{"label":"Bytes/sec","showUnits":false}}}},{"type":"metric","width":12,"height":6,"x":12,"y":6,"properties":{"view":"timeSeries","title":"Stateless
              Network Rx","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Rx","expression":"SELECT
              AVG(NetworkRxBytes) FROM SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOCwithoutcustomwidgetlambdastatelessdefinition87FC0137'
              GROUP BY
              TaskId"}]],"yAxis":{"left":{"label":"Bytes/sec","showUnits":false}}}},{"type":"log","width":24,"height":6,"x":0,"y":12,"properties":{"view":"table","title":"Stateless
              Logs","region":"region","query":"SOURCE '
            - Ref: >-
                withoutcustomwidgetlambdastatelessdefinitionrestateLogGroupDB7E974E
            - >-
              ' | fields @logStream, @timestamp, level, fields.message,
              target\\n          | sort @timestamp desc\\n          | limit
              500"}},{"type":"metric","width":12,"height":6,"x":0,"y":18,"properties":{"view":"timeSeries","title":"Stateful
              CPU","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"CPU","expression":"cpu /
              1024"}],[{"expression":"SELECT AVG(CpuUtilized) FROM
              SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOCwithoutcustomwidgetlambdastatefuldefinition5F6BAEB6'
              GROUP BY
              TaskId","visible":false,"id":"cpu"}]],"annotations":{"horizontal":[{"value":16,"label":"Limit","yAxis":"left"}]},"yAxis":{"left":{"label":"vCPUs","showUnits":false}}}},{"type":"metric","width":12,"height":6,"x":12,"y":18,"properties":{"view":"timeSeries","title":"Stateful
              Memory","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Memory","expression":"memory /
              1024"}],[{"expression":"SELECT AVG(MemoryUtilized) FROM
              SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOCwithoutcustomwidgetlambdastatefuldefinition5F6BAEB6'
              GROUP BY
              TaskId","visible":false,"id":"memory"}]],"annotations":{"horizontal":[{"value":32,"label":"Limit","yAxis":"left"}]},"yAxis":{"left":{"label":"GiB","showUnits":false}}}},{"type":"metric","width":12,"height":6,"x":0,"y":24,"properties":{"view":"timeSeries","title":"Stateful
              Network Tx","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Tx","expression":"SELECT
              AVG(NetworkTxBytes) FROM SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOCwithoutcustomwidgetlambdastatefuldefinition5F6BAEB6'
              GROUP BY
              TaskId"}]],"yAxis":{"left":{"label":"Bytes/sec","showUnits":false}}}},{"type":"metric","width":12,"height":6,"x":12,"y":24,"properties":{"view":"timeSeries","title":"Stateful
              Network Rx","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Rx","expression":"SELECT
              AVG(NetworkRxBytes) FROM SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOCwithoutcustomwidgetlambdastatefuldefinition5F6BAEB6'
              GROUP BY
              TaskId"}]],"yAxis":{"left":{"label":"Bytes/sec","showUnits":false}}}},{"type":"log","width":24,"height":6,"x":0,"y":30,"properties":{"view":"table","title":"Stateful
              Logs","region":"region","query":"SOURCE '
            - Ref: >-
                withoutcustomwidgetlambdastatefuldefinitionrestateLogGroup5C58F0AC
            - >-
              ' | fields @logStream, @timestamp, level, fields.message,
              target\\n          | sort @timestamp desc\\n          | limit
              500"}},{"type":"metric","width":8,"height":6,"x":0,"y":36,"properties":{"view":"timeSeries","title":"Ephemeral
              Volume Usage (Total size 200GiB)","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Usage","expression":"SELECT
              MAX(EphemeralStorageUtilized) FROM
              SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily) WHERE TaskDefinitionFamily =
              'RestateBYOCwithoutcustomwidgetlambdastatefuldefinition5F6BAEB6'"}]],"annotations":{"horizontal":[{"value":200,"label":"Volume
              size","visible":false,"yAxis":"left"}]},"yAxis":{"left":{"label":"GiB","showUnits":false}},"liveData":false}},{"type":"metric","width":8,"height":6,"x":8,"y":36,"properties":{"view":"timeSeries","title":"Volume
              Write Throughput (Limited to 150 MiB/sec)","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Write","expression":"RATE(count) /
              1048576"}],[{"expression":"SELECT MAX(StorageWriteBytes) FROM
              SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOCwithoutcustomwidgetlambdastatefuldefinition5F6BAEB6'
              GROUP BY
              TaskId","visible":false,"id":"count"}]],"annotations":{"horizontal":[{"value":150,"label":"Limit","visible":false,"yAxis":"left"}]},"yAxis":{"left":{"label":"MiB/sec","showUnits":false}}}},{"type":"metric","width":8,"height":6,"x":16,"y":36,"properties":{"view":"timeSeries","title":"Volume
              Read Throughput (Limited to 150 MiB/sec)","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Read","expression":"RATE(count) /
              1048576"}],[{"expression":"SELECT MAX(StorageReadBytes) FROM
              SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOCwithoutcustomwidgetlambdastatefuldefinition5F6BAEB6'
              GROUP BY
              TaskId","visible":false,"id":"count"}]],"annotations":{"horizontal":[{"value":150,"label":"Limit","visible":false,"yAxis":"left"}]},"yAxis":{"left":{"label":"MiB/sec","showUnits":false}}}},{"type":"log","width":24,"height":6,"x":0,"y":42,"properties":{"view":"table","title":"Controller
              Logs","region":"region","query":"SOURCE '
            - Ref: >-
                withoutcustomwidgetlambdacontrollerdefinitioncontrollerLogGroup0EA5E86D
            - >-
              ' | fields @logStream, @timestamp, level, fields.message,
              target\\n          | sort @timestamp desc\\n          | limit
              500"}}]}
      DashboardName: RestateBYOC_without-custom-widget-lambda_metrics
  withoutcustomwidgetlambdaservicedeployerlambdaexecutionroleEF56C011:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
        Version: '2012-10-17'
  withoutcustomwidgetlambdaservicedeployerlambdaexecutionroleDefaultPolicy2F421E33:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 'logs:CreateLogGroup'
              - 'logs:CreateLogStream'
              - 'logs:PutLogEvents'
              - 'ec2:CreateNetworkInterface'
              - 'ec2:DescribeNetworkInterfaces'
              - 'ec2:DescribeSubnets'
              - 'ec2:DeleteNetworkInterface'
              - 'ec2:AssignPrivateIpAddresses'
              - 'ec2:UnassignPrivateIpAddresses'
            Effect: Allow
            Resource: '*'
            Sid: AWSLambdaVPCAccessExecutionPermissions
        Version: '2012-10-17'
      PolicyName: >-
        withoutcustomwidgetlambdaservicedeployerlambdaexecutionroleDefaultPolicy2F421E33
      Roles:
        - Ref: withoutcustomwidgetlambdaservicedeployerlambdaexecutionroleEF56C011
  withoutcustomwidgetlambdaservicedeployerEventHandler7DBAD3F6:
    Type: 'AWS::Lambda::Function'
    Properties:
      Architectures:
        - arm64
      Code: Any<Object>
      Description: Restate custom registration handler
      Environment:
        Variables:
          NODE_OPTIONS: '--enable-source-maps'
      Handler: entrypoint.handler
      MemorySize: 128
      Role:
        'Fn::GetAtt':
          - withoutcustomwidgetlambdaservicedeployerlambdaexecutionroleEF56C011
          - Arn
      Runtime: nodejs22.x
      Timeout: 180
      VpcConfig:
        SecurityGroupIds:
          - 'Fn::GetAtt':
              - withoutcustomwidgetlambdasecuritygroup059AA659
              - GroupId
        SubnetIds:
          - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet1Subnet934893E8236E2271'
          - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet2Subnet7031C2BA60DCB1EE'
          - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet3Subnet985AC459F9514491'
    DependsOn:
      - >-
        withoutcustomwidgetlambdaservicedeployerlambdaexecutionroleDefaultPolicy2F421E33
      - withoutcustomwidgetlambdaservicedeployerlambdaexecutionroleEF56C011
  withoutcustomwidgetlambdaservicedeployerDeploymentLogsB7AC0067:
    Type: 'AWS::Logs::LogGroup'
    Properties:
      LogGroupName:
        'Fn::Join':
          - ''
          - - /aws/lambda/
            - Ref: withoutcustomwidgetlambdaservicedeployerEventHandler7DBAD3F6
      RetentionInDays: 30
    UpdateReplacePolicy: Retain
    DeletionPolicy: RetainExceptOnCreate
"
`;

exports[`BYOC Without metrics dashboard 1`] = `
"Resources:
  withoutmetricsdashboardsecuritygroup2805E007:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      GroupDescription: RestateBYOC/without-metrics-dashboard/security-group
      SecurityGroupEgress:
        - CidrIp: 0.0.0.0/0
          Description: Allow all outbound traffic by default
          IpProtocol: '-1'
      Tags:
        - Key: Name
          Value: RestateBYOC/without-metrics-dashboard/security-group
      VpcId:
        'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcA2121C384D1B3CDE'
  withoutmetricsdashboardsecuritygroupfromRestateBYOCwithoutmetricsdashboardsecuritygroup6DE53A42808013BCEE27:
    Type: 'AWS::EC2::SecurityGroupIngress'
    Properties:
      Description: 'from RestateBYOCwithoutmetricsdashboardsecuritygroup6DE53A42:8080'
      FromPort: 8080
      GroupId:
        'Fn::GetAtt':
          - withoutmetricsdashboardsecuritygroup2805E007
          - GroupId
      IpProtocol: tcp
      SourceSecurityGroupId:
        'Fn::GetAtt':
          - withoutmetricsdashboardsecuritygroup2805E007
          - GroupId
      ToPort: 8080
  withoutmetricsdashboardsecuritygroupfromRestateBYOCwithoutmetricsdashboardsecuritygroup6DE53A429070EC0521D8:
    Type: 'AWS::EC2::SecurityGroupIngress'
    Properties:
      Description: 'from RestateBYOCwithoutmetricsdashboardsecuritygroup6DE53A42:9070'
      FromPort: 9070
      GroupId:
        'Fn::GetAtt':
          - withoutmetricsdashboardsecuritygroup2805E007
          - GroupId
      IpProtocol: tcp
      SourceSecurityGroupId:
        'Fn::GetAtt':
          - withoutmetricsdashboardsecuritygroup2805E007
          - GroupId
      ToPort: 9070
  withoutmetricsdashboardsecuritygroupfromRestateBYOCwithoutmetricsdashboardsecuritygroup6DE53A425122C2676B10:
    Type: 'AWS::EC2::SecurityGroupIngress'
    Properties:
      Description: 'from RestateBYOCwithoutmetricsdashboardsecuritygroup6DE53A42:5122'
      FromPort: 5122
      GroupId:
        'Fn::GetAtt':
          - withoutmetricsdashboardsecuritygroup2805E007
          - GroupId
      IpProtocol: tcp
      SourceSecurityGroupId:
        'Fn::GetAtt':
          - withoutmetricsdashboardsecuritygroup2805E007
          - GroupId
      ToPort: 5122
  withoutmetricsdashboardbucketDCB2C70A:
    Type: 'AWS::S3::Bucket'
    Properties:
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
    UpdateReplacePolicy: Retain
    DeletionPolicy: Retain
  withoutmetricsdashboardbucketPolicy59930ACA:
    Type: 'AWS::S3::BucketPolicy'
    Properties:
      Bucket:
        Ref: withoutmetricsdashboardbucketDCB2C70A
      PolicyDocument:
        Statement:
          - Action: 's3:*'
            Condition:
              Bool:
                'aws:SecureTransport': 'false'
            Effect: Deny
            Principal:
              AWS: '*'
            Resource:
              - 'Fn::GetAtt':
                  - withoutmetricsdashboardbucketDCB2C70A
                  - Arn
              - 'Fn::Join':
                  - ''
                  - - 'Fn::GetAtt':
                        - withoutmetricsdashboardbucketDCB2C70A
                        - Arn
                    - /*
        Version: '2012-10-17'
  withoutmetricsdashboardcluster465CA89C:
    Type: 'AWS::ECS::Cluster'
    Properties:
      ClusterSettings:
        - Name: containerInsights
          Value: enhanced
      Tags:
        - Key: Name
          Value: RestateBYOC/without-metrics-dashboard/cluster
  withoutmetricsdashboardrestatetaskroleFB91830E:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
        Version: '2012-10-17'
  withoutmetricsdashboardrestatetaskroleDefaultPolicy6A5DFCD8:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 's3:GetObject'
              - 's3:PutObject'
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'Fn::GetAtt':
                      - withoutmetricsdashboardbucketDCB2C70A
                      - Arn
                  - /*
            Sid: ReadWriteBucket
          - Action: 's3:ListBucket'
            Effect: Allow
            Resource:
              'Fn::GetAtt':
                - withoutmetricsdashboardbucketDCB2C70A
                - Arn
            Sid: ListBucket
        Version: '2012-10-17'
      PolicyName: withoutmetricsdashboardrestatetaskroleDefaultPolicy6A5DFCD8
      Roles:
        - Ref: withoutmetricsdashboardrestatetaskroleFB91830E
  withoutmetricsdashboardrestateexecutionrole968D2B2C:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
        Version: '2012-10-17'
  withoutmetricsdashboardrestateexecutionroleDefaultPolicy8E7580FD:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 'logs:CreateLogStream'
              - 'logs:PutLogEvents'
            Effect: Allow
            Resource:
              'Fn::GetAtt':
                - >-
                  withoutmetricsdashboardstatelessdefinitionrestateLogGroup53F0D043
                - Arn
          - Action:
              - 'logs:CreateLogStream'
              - 'logs:PutLogEvents'
            Effect: Allow
            Resource:
              'Fn::GetAtt':
                - >-
                  withoutmetricsdashboardstatefuldefinitionrestateLogGroupAAEB7F69
                - Arn
        Version: '2012-10-17'
      PolicyName: withoutmetricsdashboardrestateexecutionroleDefaultPolicy8E7580FD
      Roles:
        - Ref: withoutmetricsdashboardrestateexecutionrole968D2B2C
  withoutmetricsdashboardsharednlbA8403BAA:
    Type: 'AWS::ElasticLoadBalancingV2::LoadBalancer'
    Properties:
      LoadBalancerAttributes:
        - Key: deletion_protection.enabled
          Value: 'false'
        - Key: load_balancing.cross_zone.enabled
          Value: 'false'
        - Key: dns_record.client_routing_policy
          Value: availability_zone_affinity
      Scheme: internal
      SecurityGroups:
        - 'Fn::GetAtt':
            - withoutmetricsdashboardsecuritygroup2805E007
            - GroupId
      Subnets:
        - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet1Subnet934893E8236E2271'
        - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet2Subnet7031C2BA60DCB1EE'
        - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet3Subnet985AC459F9514491'
      Tags:
        - Key: Name
          Value: RestateBYOC/without-metrics-dashboard/shared-nlb
      Type: network
  withoutmetricsdashboardingresssharedlistener7EA4B060:
    Type: 'AWS::ElasticLoadBalancingV2::Listener'
    Properties:
      DefaultActions:
        - TargetGroupArn:
            Ref: withoutmetricsdashboardingresssharedtarget582A9DEB
          Type: forward
      LoadBalancerArn:
        Ref: withoutmetricsdashboardsharednlbA8403BAA
      Port: 8080
      Protocol: TCP
  withoutmetricsdashboardadminsharedlistener76E9B915:
    Type: 'AWS::ElasticLoadBalancingV2::Listener'
    Properties:
      DefaultActions:
        - TargetGroupArn:
            Ref: withoutmetricsdashboardadminsharedtarget330B6CB5
          Type: forward
      LoadBalancerArn:
        Ref: withoutmetricsdashboardsharednlbA8403BAA
      Port: 9070
      Protocol: TCP
  withoutmetricsdashboardnodesharedlistener2C23C08C:
    Type: 'AWS::ElasticLoadBalancingV2::Listener'
    Properties:
      DefaultActions:
        - TargetGroupArn:
            Ref: withoutmetricsdashboardnodesharedtarget841653BD
          Type: forward
      LoadBalancerArn:
        Ref: withoutmetricsdashboardsharednlbA8403BAA
      Port: 5122
      Protocol: TCP
  withoutmetricsdashboardstatelessdefinition39D9FF8E:
    Type: 'AWS::ECS::TaskDefinition'
    Properties:
      ContainerDefinitions:
        - Cpu: 16384
          EntryPoint:
            - bash
            - '-c'
            - >

              curl --no-progress-meter $ECS_CONTAINER_METADATA_URI_V4/task -o
              task-metadata && \\

              export \\
                RESTATE_NODE_NAME=$(jq -r '.TaskARN' task-metadata) \\
                RESTATE_LOCATION="$AWS_REGION.$(jq -r '.AvailabilityZone' task-metadata)" \\
                RESTATE_ADVERTISED_ADDRESS="http://$(jq -r '.Containers[0].Networks[0].IPv4Addresses[0]' task-metadata):5122"
              exec restate-server
          Environment:
            - Name: RESTATE_LOG_FORMAT
              Value: json
            - Name: RESTATE_CLUSTER_NAME
              Value: RestateBYOC/without-metrics-dashboard
            - Name: RESTATE_ROLES
              Value: '["admin","http-ingress"]'
            - Name: RESTATE_AUTO_PROVISION
              Value: 'true'
            - Name: RESTATE_SHUTDOWN_TIMEOUT
              Value: 100s
            - Name: RESTATE_DEFAULT_NUM_PARTITIONS
              Value: '128'
            - Name: RESTATE_DEFAULT_REPLICATION
              Value: '{zone: 2}'
            - Name: RESTATE_METADATA_CLIENT__TYPE
              Value: object-store
            - Name: RESTATE_METADATA_CLIENT__PATH
              Value:
                'Fn::Join':
                  - ''
                  - - 's3://'
                    - Ref: withoutmetricsdashboardbucketDCB2C70A
                    - /metadata
            - Name: RESTATE_BIFROST__DEFAULT_PROVIDER
              Value: replicated
            - Name: >-
                RESTATE_INGRESS__EXPERIMENTAL_FEATURE_ENABLE_SEPARATE_INGRESS_ROLE
              Value: 'true'
            - Name: RESTATE_INGRESS__ADVERTISED_INGRESS_ENDPOINT
              Value:
                'Fn::Join':
                  - ''
                  - - 'http://'
                    - 'Fn::GetAtt':
                        - withoutmetricsdashboardsharednlbA8403BAA
                        - DNSName
                    - ':8080'
            - Name: RESTATE_WORKER__SNAPSHOTS__DESTINATION
              Value:
                'Fn::Join':
                  - ''
                  - - 's3://'
                    - Ref: withoutmetricsdashboardbucketDCB2C70A
                    - /snapshots
          Essential: true
          HealthCheck:
            Command:
              - CMD
              - curl
              - '--fail'
              - 'http://127.0.0.1:8080/restate/health'
            Interval: 30
            Retries: 3
            Timeout: 5
          Image: Any<Object>
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group:
                Ref: >-
                  withoutmetricsdashboardstatelessdefinitionrestateLogGroup53F0D043
              awslogs-stream-prefix: restate
              awslogs-region: region
          Memory: 32768
          Name: restate
          PortMappings:
            - ContainerPort: 8080
              Name: ingress
              Protocol: tcp
            - ContainerPort: 9070
              Name: admin
              Protocol: tcp
            - ContainerPort: 5122
              Name: node
              Protocol: tcp
          StopTimeout: 120
      Cpu: '16384'
      ExecutionRoleArn:
        'Fn::GetAtt':
          - withoutmetricsdashboardrestateexecutionrole968D2B2C
          - Arn
      Family: RestateBYOCwithoutmetricsdashboardstatelessdefinition3FF2C540
      Memory: '32768'
      NetworkMode: awsvpc
      RequiresCompatibilities:
        - FARGATE
      RuntimePlatform:
        CpuArchitecture: ARM64
        OperatingSystemFamily: LINUX
      Tags:
        - Key: Name
          Value: RestateBYOC/without-metrics-dashboard/stateless-definition
      TaskRoleArn:
        'Fn::GetAtt':
          - withoutmetricsdashboardrestatetaskroleFB91830E
          - Arn
  withoutmetricsdashboardstatelessdefinitionrestateLogGroup53F0D043:
    Type: 'AWS::Logs::LogGroup'
    Properties:
      Tags:
        - Key: Name
          Value: RestateBYOC/without-metrics-dashboard/stateless-definition
    UpdateReplacePolicy: Retain
    DeletionPolicy: Retain
  withoutmetricsdashboardstatelessserviceServiceA5D262A7:
    Type: 'AWS::ECS::Service'
    Properties:
      Cluster:
        Ref: withoutmetricsdashboardcluster465CA89C
      DeploymentConfiguration:
        Alarms:
          AlarmNames: []
          Enable: false
          Rollback: false
        MaximumPercent: 200
        MinimumHealthyPercent: 100
      DesiredCount: 3
      EnableECSManagedTags: false
      EnableExecuteCommand: false
      HealthCheckGracePeriodSeconds: 60
      LaunchType: FARGATE
      LoadBalancers:
        - ContainerName: restate
          ContainerPort: 8080
          TargetGroupArn:
            Ref: withoutmetricsdashboardingresssharedtarget582A9DEB
        - ContainerName: restate
          ContainerPort: 9070
          TargetGroupArn:
            Ref: withoutmetricsdashboardadminsharedtarget330B6CB5
        - ContainerName: restate
          ContainerPort: 5122
          TargetGroupArn:
            Ref: withoutmetricsdashboardnodesharedtarget841653BD
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: DISABLED
          SecurityGroups:
            - 'Fn::GetAtt':
                - withoutmetricsdashboardsecuritygroup2805E007
                - GroupId
          Subnets:
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet1Subnet934893E8236E2271'
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet2Subnet7031C2BA60DCB1EE'
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet3Subnet985AC459F9514491'
      PropagateTags: SERVICE
      Tags:
        - Key: Name
          Value: RestateBYOC/without-metrics-dashboard/stateless-service
      TaskDefinition:
        Ref: withoutmetricsdashboardstatelessdefinition39D9FF8E
    DependsOn:
      - withoutmetricsdashboardadminsharedlistener76E9B915
      - withoutmetricsdashboardingresssharedlistener7EA4B060
      - withoutmetricsdashboardnodesharedlistener2C23C08C
      - withoutmetricsdashboardrestatetaskroleDefaultPolicy6A5DFCD8
      - withoutmetricsdashboardrestatetaskroleFB91830E
  withoutmetricsdashboardstatefuldefinition42DF14D8:
    Type: 'AWS::ECS::TaskDefinition'
    Properties:
      ContainerDefinitions:
        - Cpu: 16384
          EntryPoint:
            - bash
            - '-c'
            - >

              curl --no-progress-meter $ECS_CONTAINER_METADATA_URI_V4/task -o
              task-metadata && \\

              export \\
                RESTATE_NODE_NAME=$(jq -r '.TaskARN' task-metadata) \\
                RESTATE_LOCATION="$AWS_REGION.$(jq -r '.AvailabilityZone' task-metadata)" \\
                RESTATE_ADVERTISED_ADDRESS="http://$(jq -r '.Containers[0].Networks[0].IPv4Addresses[0]' task-metadata):5122"
              exec restate-server
          Environment:
            - Name: RESTATE_LOG_FORMAT
              Value: json
            - Name: RESTATE_CLUSTER_NAME
              Value: RestateBYOC/without-metrics-dashboard
            - Name: RESTATE_ROLES
              Value: '["log-server", "worker"]'
            - Name: RESTATE_AUTO_PROVISION
              Value: 'false'
            - Name: RESTATE_SHUTDOWN_TIMEOUT
              Value: 100s
            - Name: RESTATE_ROCKSDB_TOTAL_MEMORY_SIZE
              Value: 24576MiB
            - Name: RESTATE_METADATA_CLIENT__TYPE
              Value: object-store
            - Name: RESTATE_METADATA_CLIENT__PATH
              Value:
                'Fn::Join':
                  - ''
                  - - 's3://'
                    - Ref: withoutmetricsdashboardbucketDCB2C70A
                    - /metadata
            - Name: RESTATE_WORKER__SNAPSHOTS__DESTINATION
              Value:
                'Fn::Join':
                  - ''
                  - - 's3://'
                    - Ref: withoutmetricsdashboardbucketDCB2C70A
                    - /snapshots
            - Name: RESTATE_WORKER__SNAPSHOTS__SNAPSHOT_INTERVAL_NUM_RECORDS
              Value: '1000000'
            - Name: RESTATE_WORKER__STORAGE__ROCKSDB_DISABLE_DIRECT_IO_FOR_READS
              Value: 'true'
            - Name: RESTATE_WORKER__STORAGE__ROCKSDB_DISABLE_WAL_FSYNC
              Value: 'true'
            - Name: RESTATE_LOG_SERVER__ROCKSDB_DISABLE_WAL_FSYNC
              Value: 'true'
            - Name: RESTATE_LOG_SERVER__ROCKSDB_DISABLE_DIRECT_IO_FOR_READS
              Value: 'true'
            - Name: >-
                RESTATE_INGRESS__EXPERIMENTAL_FEATURE_ENABLE_SEPARATE_INGRESS_ROLE
              Value: 'true'
          Essential: true
          HealthCheck:
            Command:
              - CMD
              - curl
              - '--fail'
              - 'http://127.0.0.1:5122/health'
            Interval: 30
            Retries: 3
            Timeout: 5
          Image: Any<Object>
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group:
                Ref: >-
                  withoutmetricsdashboardstatefuldefinitionrestateLogGroupAAEB7F69
              awslogs-stream-prefix: restate
              awslogs-region: region
          Memory: 32768
          MountPoints:
            - ContainerPath: /restate-data
              ReadOnly: false
              SourceVolume: restate-data
          Name: restate
          PortMappings:
            - ContainerPort: 5122
              Name: node
              Protocol: tcp
          RestartPolicy:
            Enabled: true
            RestartAttemptPeriod: 60
          StopTimeout: 120
      Cpu: '16384'
      EphemeralStorage:
        SizeInGiB: 200
      ExecutionRoleArn:
        'Fn::GetAtt':
          - withoutmetricsdashboardrestateexecutionrole968D2B2C
          - Arn
      Family: RestateBYOCwithoutmetricsdashboardstatefuldefinitionBAC8DA68
      Memory: '32768'
      NetworkMode: awsvpc
      RequiresCompatibilities:
        - FARGATE
      RuntimePlatform:
        CpuArchitecture: ARM64
        OperatingSystemFamily: LINUX
      Tags:
        - Key: Name
          Value: RestateBYOC/without-metrics-dashboard/stateful-definition
      TaskRoleArn:
        'Fn::GetAtt':
          - withoutmetricsdashboardrestatetaskroleFB91830E
          - Arn
      Volumes:
        - ConfiguredAtLaunch: false
          Name: restate-data
  withoutmetricsdashboardstatefuldefinitionrestateLogGroupAAEB7F69:
    Type: 'AWS::Logs::LogGroup'
    Properties:
      Tags:
        - Key: Name
          Value: RestateBYOC/without-metrics-dashboard/stateful-definition
    UpdateReplacePolicy: Retain
    DeletionPolicy: Retain
  withoutmetricsdashboardingresssharedtarget582A9DEB:
    Type: 'AWS::ElasticLoadBalancingV2::TargetGroup'
    Properties:
      HealthCheckEnabled: true
      HealthCheckIntervalSeconds: 5
      HealthCheckPath: /restate/health
      HealthCheckProtocol: HTTP
      HealthCheckTimeoutSeconds: 2
      Port: 8080
      Protocol: TCP
      Tags:
        - Key: Name
          Value: RestateBYOC/without-metrics-dashboard/ingress-shared-target
      TargetType: ip
      VpcId:
        'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcA2121C384D1B3CDE'
  withoutmetricsdashboardadminsharedtarget330B6CB5:
    Type: 'AWS::ElasticLoadBalancingV2::TargetGroup'
    Properties:
      HealthCheckEnabled: true
      HealthCheckIntervalSeconds: 5
      HealthCheckPath: /health
      HealthCheckPort: '9070'
      HealthCheckProtocol: HTTP
      HealthCheckTimeoutSeconds: 2
      Port: 9070
      Protocol: TCP
      Tags:
        - Key: Name
          Value: RestateBYOC/without-metrics-dashboard/admin-shared-target
      TargetType: ip
      VpcId:
        'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcA2121C384D1B3CDE'
  withoutmetricsdashboardnodesharedtarget841653BD:
    Type: 'AWS::ElasticLoadBalancingV2::TargetGroup'
    Properties:
      HealthCheckEnabled: true
      HealthCheckIntervalSeconds: 5
      HealthCheckPath: /health
      HealthCheckPort: '5122'
      HealthCheckProtocol: HTTP
      HealthCheckTimeoutSeconds: 2
      Port: 5122
      Protocol: TCP
      Tags:
        - Key: Name
          Value: RestateBYOC/without-metrics-dashboard/node-shared-target
      TargetType: ip
      VpcId:
        'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcA2121C384D1B3CDE'
  withoutmetricsdashboardcontrollertaskrole0EE1D813:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
        Version: '2012-10-17'
  withoutmetricsdashboardcontrollertaskroleDefaultPolicy574C2B83:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 'ecs:ListTasks'
              - 'ecs:DescribeTasks'
              - 'ecs:StopTask'
            Condition:
              ArnEquals:
                'ecs:cluster':
                  'Fn::GetAtt':
                    - withoutmetricsdashboardcluster465CA89C
                    - Arn
            Effect: Allow
            Resource: '*'
            Sid: TaskActions
          - Action: 'ecs:TagResource'
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'Fn::Join':
                      - /
                      - - 'Fn::Join':
                            - ':'
                            - - 'Fn::Select':
                                  - 0
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - withoutmetricsdashboardcluster465CA89C
                                                  - Arn
                              - 'Fn::Select':
                                  - 1
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - withoutmetricsdashboardcluster465CA89C
                                                  - Arn
                              - 'Fn::Select':
                                  - 2
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - withoutmetricsdashboardcluster465CA89C
                                                  - Arn
                              - 'Fn::Select':
                                  - 3
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - withoutmetricsdashboardcluster465CA89C
                                                  - Arn
                              - 'Fn::Select':
                                  - 4
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - withoutmetricsdashboardcluster465CA89C
                                                  - Arn
                              - task
                        - 'Fn::Select':
                            - 1
                            - 'Fn::Split':
                                - /
                                - 'Fn::GetAtt':
                                    - withoutmetricsdashboardcluster465CA89C
                                    - Arn
                        - ''
                  - '*'
            Sid: TagTasks
          - Action: 'ecs:RunTask'
            Condition:
              ArnEquals:
                'ecs:cluster':
                  'Fn::GetAtt':
                    - withoutmetricsdashboardcluster465CA89C
                    - Arn
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'Fn::Join':
                      - ':'
                      - - 'Fn::Select':
                            - 0
                            - 'Fn::Split':
                                - ':'
                                - Ref: >-
                                    withoutmetricsdashboardstatefuldefinition42DF14D8
                        - 'Fn::Select':
                            - 1
                            - 'Fn::Split':
                                - ':'
                                - Ref: >-
                                    withoutmetricsdashboardstatefuldefinition42DF14D8
                        - 'Fn::Select':
                            - 2
                            - 'Fn::Split':
                                - ':'
                                - Ref: >-
                                    withoutmetricsdashboardstatefuldefinition42DF14D8
                        - 'Fn::Select':
                            - 3
                            - 'Fn::Split':
                                - ':'
                                - Ref: >-
                                    withoutmetricsdashboardstatefuldefinition42DF14D8
                        - 'Fn::Select':
                            - 4
                            - 'Fn::Split':
                                - ':'
                                - Ref: >-
                                    withoutmetricsdashboardstatefuldefinition42DF14D8
                        - 'Fn::Select':
                            - 5
                            - 'Fn::Split':
                                - ':'
                                - Ref: >-
                                    withoutmetricsdashboardstatefuldefinition42DF14D8
                  - ':*'
            Sid: RunTask
          - Action: 'iam:PassRole'
            Condition:
              StringEquals:
                'iam:PassedToService': ecs-tasks.amazonaws.com
            Effect: Allow
            Resource:
              - 'Fn::GetAtt':
                  - withoutmetricsdashboardrestatetaskroleFB91830E
                  - Arn
              - 'Fn::GetAtt':
                  - withoutmetricsdashboardrestateexecutionrole968D2B2C
                  - Arn
            Sid: RunTaskPassRole
          - Action:
              - 's3:GetObject'
              - 's3:PutObject'
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'Fn::GetAtt':
                      - withoutmetricsdashboardbucketDCB2C70A
                      - Arn
                  - /*
            Sid: ReadWriteBucket
          - Action: 's3:ListBucket'
            Effect: Allow
            Resource:
              'Fn::GetAtt':
                - withoutmetricsdashboardbucketDCB2C70A
                - Arn
            Sid: ListBucket
        Version: '2012-10-17'
      PolicyName: withoutmetricsdashboardcontrollertaskroleDefaultPolicy574C2B83
      Roles:
        - Ref: withoutmetricsdashboardcontrollertaskrole0EE1D813
  withoutmetricsdashboardcontrollerexecutionroleA4230FE5:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
        Version: '2012-10-17'
  withoutmetricsdashboardcontrollerexecutionroleDefaultPolicy5A3DCDCD:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 'logs:CreateLogStream'
              - 'logs:PutLogEvents'
            Effect: Allow
            Resource:
              'Fn::GetAtt':
                - >-
                  withoutmetricsdashboardcontrollerdefinitioncontrollerLogGroupAC1AF1F7
                - Arn
        Version: '2012-10-17'
      PolicyName: withoutmetricsdashboardcontrollerexecutionroleDefaultPolicy5A3DCDCD
      Roles:
        - Ref: withoutmetricsdashboardcontrollerexecutionroleA4230FE5
  withoutmetricsdashboardcontrollerdefinition195450AF:
    Type: 'AWS::ECS::TaskDefinition'
    Properties:
      ContainerDefinitions:
        - Cpu: 1024
          Environment:
            - Name: RUST_LOG
              Value: 'info,restate_fargate_controller=debug'
            - Name: CONTROLLER_LOG_FORMAT
              Value: json
            - Name: CONTROLLER_METADATA_PATH
              Value:
                'Fn::Join':
                  - ''
                  - - 's3://'
                    - Ref: withoutmetricsdashboardbucketDCB2C70A
                    - /metadata
            - Name: CONTROLLER_RECONCILE_INTERVAL
              Value: 10s
            - Name: CONTROLLER_CLUSTER__CLUSTER_ARN
              Value:
                'Fn::GetAtt':
                  - withoutmetricsdashboardcluster465CA89C
                  - Arn
            - Name: CONTROLLER_LICENSE_ID
              Value: foo
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __REGION
              Value:
                Ref: 'AWS::Region'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __CLUSTER_ARN
              Value:
                'Fn::GetAtt':
                  - withoutmetricsdashboardcluster465CA89C
                  - Arn
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __TASK_PREFIX
              Value:
                'Fn::Join':
                  - /
                  - - 'Fn::Join':
                        - ':'
                        - - 'Fn::Select':
                              - 0
                              - 'Fn::Split':
                                  - ':'
                                  - 'Fn::Select':
                                      - 0
                                      - 'Fn::Split':
                                          - /
                                          - 'Fn::GetAtt':
                                              - withoutmetricsdashboardcluster465CA89C
                                              - Arn
                          - 'Fn::Select':
                              - 1
                              - 'Fn::Split':
                                  - ':'
                                  - 'Fn::Select':
                                      - 0
                                      - 'Fn::Split':
                                          - /
                                          - 'Fn::GetAtt':
                                              - withoutmetricsdashboardcluster465CA89C
                                              - Arn
                          - 'Fn::Select':
                              - 2
                              - 'Fn::Split':
                                  - ':'
                                  - 'Fn::Select':
                                      - 0
                                      - 'Fn::Split':
                                          - /
                                          - 'Fn::GetAtt':
                                              - withoutmetricsdashboardcluster465CA89C
                                              - Arn
                          - 'Fn::Select':
                              - 3
                              - 'Fn::Split':
                                  - ':'
                                  - 'Fn::Select':
                                      - 0
                                      - 'Fn::Split':
                                          - /
                                          - 'Fn::GetAtt':
                                              - withoutmetricsdashboardcluster465CA89C
                                              - Arn
                          - 'Fn::Select':
                              - 4
                              - 'Fn::Split':
                                  - ':'
                                  - 'Fn::Select':
                                      - 0
                                      - 'Fn::Split':
                                          - /
                                          - 'Fn::GetAtt':
                                              - withoutmetricsdashboardcluster465CA89C
                                              - Arn
                          - task
                    - 'Fn::Select':
                        - 1
                        - 'Fn::Split':
                            - /
                            - 'Fn::GetAtt':
                                - withoutmetricsdashboardcluster465CA89C
                                - Arn
                    - ''
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1a__ENABLE_EXECUTE_COMMAND
              Value: 'false'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1a__SECURITY_GROUPS
              Value:
                'Fn::Join':
                  - ''
                  - - '["'
                    - 'Fn::GetAtt':
                        - withoutmetricsdashboardsecuritygroup2805E007
                        - GroupId
                    - '"]'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1a__SUBNETS
              Value:
                'Fn::Join':
                  - ''
                  - - '["'
                    - 'Fn::ImportValue': >-
                        VPCStack:ExportsOutputRefvpcPrivateSubnet1Subnet934893E8236E2271
                    - '"]'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1a__TASK_DEFINITION_ARN
              Value:
                Ref: withoutmetricsdashboardstatefuldefinition42DF14D8
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1a__COUNT
              Value: '1'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1b__ENABLE_EXECUTE_COMMAND
              Value: 'false'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1b__SECURITY_GROUPS
              Value:
                'Fn::Join':
                  - ''
                  - - '["'
                    - 'Fn::GetAtt':
                        - withoutmetricsdashboardsecuritygroup2805E007
                        - GroupId
                    - '"]'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1b__SUBNETS
              Value:
                'Fn::Join':
                  - ''
                  - - '["'
                    - 'Fn::ImportValue': >-
                        VPCStack:ExportsOutputRefvpcPrivateSubnet2Subnet7031C2BA60DCB1EE
                    - '"]'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1b__TASK_DEFINITION_ARN
              Value:
                Ref: withoutmetricsdashboardstatefuldefinition42DF14D8
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1b__COUNT
              Value: '1'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1c__ENABLE_EXECUTE_COMMAND
              Value: 'false'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1c__SECURITY_GROUPS
              Value:
                'Fn::Join':
                  - ''
                  - - '["'
                    - 'Fn::GetAtt':
                        - withoutmetricsdashboardsecuritygroup2805E007
                        - GroupId
                    - '"]'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1c__SUBNETS
              Value:
                'Fn::Join':
                  - ''
                  - - '["'
                    - 'Fn::ImportValue': >-
                        VPCStack:ExportsOutputRefvpcPrivateSubnet3Subnet985AC459F9514491
                    - '"]'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1c__TASK_DEFINITION_ARN
              Value:
                Ref: withoutmetricsdashboardstatefuldefinition42DF14D8
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1c__COUNT
              Value: '1'
          Essential: true
          HealthCheck:
            Command:
              - CMD
              - curl
              - '--fail'
              - 'http://127.0.0.1:8080/health'
            Interval: 30
            Retries: 10
            StartPeriod: 300
            Timeout: 5
          Image: Any<Object>
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group:
                Ref: >-
                  withoutmetricsdashboardcontrollerdefinitioncontrollerLogGroupAC1AF1F7
              awslogs-stream-prefix: controller
              awslogs-region: region
          Memory: 2048
          Name: controller
          StopTimeout: 120
      Cpu: '1024'
      ExecutionRoleArn:
        'Fn::GetAtt':
          - withoutmetricsdashboardcontrollerexecutionroleA4230FE5
          - Arn
      Family: RestateBYOCwithoutmetricsdashboardcontrollerdefinitionCC1C3B2A
      Memory: '2048'
      NetworkMode: awsvpc
      RequiresCompatibilities:
        - FARGATE
      RuntimePlatform:
        CpuArchitecture: ARM64
        OperatingSystemFamily: LINUX
      Tags:
        - Key: Name
          Value: RestateBYOC/without-metrics-dashboard/controller-definition
      TaskRoleArn:
        'Fn::GetAtt':
          - withoutmetricsdashboardcontrollertaskrole0EE1D813
          - Arn
  withoutmetricsdashboardcontrollerdefinitioncontrollerLogGroupAC1AF1F7:
    Type: 'AWS::Logs::LogGroup'
    Properties:
      Tags:
        - Key: Name
          Value: RestateBYOC/without-metrics-dashboard/controller-definition
    UpdateReplacePolicy: Retain
    DeletionPolicy: Retain
  withoutmetricsdashboardcontrollerserviceService573302DD:
    Type: 'AWS::ECS::Service'
    Properties:
      Cluster:
        Ref: withoutmetricsdashboardcluster465CA89C
      DeploymentConfiguration:
        Alarms:
          AlarmNames: []
          Enable: false
          Rollback: false
        MaximumPercent: 100
        MinimumHealthyPercent: 0
      DesiredCount: 1
      EnableECSManagedTags: false
      EnableExecuteCommand: false
      LaunchType: FARGATE
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: DISABLED
          SecurityGroups:
            - 'Fn::GetAtt':
                - withoutmetricsdashboardsecuritygroup2805E007
                - GroupId
          Subnets:
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet1Subnet934893E8236E2271'
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet2Subnet7031C2BA60DCB1EE'
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet3Subnet985AC459F9514491'
      Tags:
        - Key: Name
          Value: RestateBYOC/without-metrics-dashboard/controller-service
      TaskDefinition:
        Ref: withoutmetricsdashboardcontrollerdefinition195450AF
    DependsOn:
      - withoutmetricsdashboardcontrollertaskroleDefaultPolicy574C2B83
      - withoutmetricsdashboardcontrollertaskrole0EE1D813
  withoutmetricsdashboardrestatectllambdaexecutionroleBD2539D3:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
        Version: '2012-10-17'
  withoutmetricsdashboardrestatectllambdaexecutionroleDefaultPolicy5FF5DAF5:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 'logs:CreateLogGroup'
              - 'logs:CreateLogStream'
              - 'logs:PutLogEvents'
              - 'ec2:CreateNetworkInterface'
              - 'ec2:DescribeNetworkInterfaces'
              - 'ec2:DescribeSubnets'
              - 'ec2:DeleteNetworkInterface'
              - 'ec2:AssignPrivateIpAddresses'
              - 'ec2:UnassignPrivateIpAddresses'
            Effect: Allow
            Resource: '*'
            Sid: AWSLambdaVPCAccessExecutionPermissions
        Version: '2012-10-17'
      PolicyName: >-
        withoutmetricsdashboardrestatectllambdaexecutionroleDefaultPolicy5FF5DAF5
      Roles:
        - Ref: withoutmetricsdashboardrestatectllambdaexecutionroleBD2539D3
  withoutmetricsdashboardrestatectllambda65A0E1E2:
    Type: 'AWS::Lambda::Function'
    Properties:
      Architectures:
        - arm64
      Code: Any<Object>
      Environment:
        Variables:
          RESTATECTL_ADDRESS:
            'Fn::Join':
              - ''
              - - 'http://'
                - 'Fn::GetAtt':
                    - withoutmetricsdashboardsharednlbA8403BAA
                    - DNSName
                - ':5122'
      Handler: restatectl
      Role:
        'Fn::GetAtt':
          - withoutmetricsdashboardrestatectllambdaexecutionroleBD2539D3
          - Arn
      Runtime: provided.al2023
      Tags:
        - Key: Name
          Value: RestateBYOC/without-metrics-dashboard/restatectl-lambda
      Timeout: 10
      VpcConfig:
        SecurityGroupIds:
          - 'Fn::GetAtt':
              - withoutmetricsdashboardsecuritygroup2805E007
              - GroupId
        SubnetIds:
          - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet1Subnet934893E8236E2271'
          - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet2Subnet7031C2BA60DCB1EE'
          - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet3Subnet985AC459F9514491'
    DependsOn:
      - >-
        withoutmetricsdashboardrestatectllambdaexecutionroleDefaultPolicy5FF5DAF5
      - withoutmetricsdashboardrestatectllambdaexecutionroleBD2539D3
  withoutmetricsdashboardretirementwatcherlambdaexecutionrole63EAB09C:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
        Version: '2012-10-17'
  withoutmetricsdashboardretirementwatcherlambdaexecutionroleDefaultPolicyC81BF06A:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 'logs:CreateLogGroup'
              - 'logs:CreateLogStream'
              - 'logs:PutLogEvents'
            Effect: Allow
            Resource: '*'
            Sid: AWSLambdaBasicExecutionPermissions
          - Action: 'ecs:TagResource'
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'Fn::Join':
                      - /
                      - - 'Fn::Join':
                            - ':'
                            - - 'Fn::Select':
                                  - 0
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - withoutmetricsdashboardcluster465CA89C
                                                  - Arn
                              - 'Fn::Select':
                                  - 1
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - withoutmetricsdashboardcluster465CA89C
                                                  - Arn
                              - 'Fn::Select':
                                  - 2
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - withoutmetricsdashboardcluster465CA89C
                                                  - Arn
                              - 'Fn::Select':
                                  - 3
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - withoutmetricsdashboardcluster465CA89C
                                                  - Arn
                              - 'Fn::Select':
                                  - 4
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - withoutmetricsdashboardcluster465CA89C
                                                  - Arn
                              - task
                        - 'Fn::Select':
                            - 1
                            - 'Fn::Split':
                                - /
                                - 'Fn::GetAtt':
                                    - withoutmetricsdashboardcluster465CA89C
                                    - Arn
                        - ''
                  - '*'
            Sid: TagTasks
          - Action:
              - 'sqs:ReceiveMessage'
              - 'sqs:ChangeMessageVisibility'
              - 'sqs:GetQueueUrl'
              - 'sqs:DeleteMessage'
              - 'sqs:GetQueueAttributes'
            Effect: Allow
            Resource:
              'Fn::GetAtt':
                - withoutmetricsdashboardretirementwatcherqueueBDFF2271
                - Arn
        Version: '2012-10-17'
      PolicyName: >-
        withoutmetricsdashboardretirementwatcherlambdaexecutionroleDefaultPolicyC81BF06A
      Roles:
        - Ref: withoutmetricsdashboardretirementwatcherlambdaexecutionrole63EAB09C
  withoutmetricsdashboardretirementwatcherlambdaBD1EB353:
    Type: 'AWS::Lambda::Function'
    Properties:
      Architectures:
        - arm64
      Code: Any<Object>
      Handler: index.handler
      Role:
        'Fn::GetAtt':
          - withoutmetricsdashboardretirementwatcherlambdaexecutionrole63EAB09C
          - Arn
      Runtime: nodejs22.x
      Tags:
        - Key: Name
          Value: RestateBYOC/without-metrics-dashboard/retirement-watcher-lambda
      Timeout: 60
    DependsOn:
      - >-
        withoutmetricsdashboardretirementwatcherlambdaexecutionroleDefaultPolicyC81BF06A
      - withoutmetricsdashboardretirementwatcherlambdaexecutionrole63EAB09C
  withoutmetricsdashboardretirementwatcherlambdaSqsEventSourceRestateBYOCwithoutmetricsdashboardretirementwatcherqueue79F32C7066A23ACE:
    Type: 'AWS::Lambda::EventSourceMapping'
    Properties:
      BatchSize: 1
      EventSourceArn:
        'Fn::GetAtt':
          - withoutmetricsdashboardretirementwatcherqueueBDFF2271
          - Arn
      FunctionName:
        Ref: withoutmetricsdashboardretirementwatcherlambdaBD1EB353
      Tags:
        - Key: Name
          Value: RestateBYOC/without-metrics-dashboard/retirement-watcher-lambda
  withoutmetricsdashboardretirementwatcherqueueBDFF2271:
    Type: 'AWS::SQS::Queue'
    Properties:
      Tags:
        - Key: Name
          Value: RestateBYOC/without-metrics-dashboard/retirement-watcher-queue
      VisibilityTimeout: 60
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  withoutmetricsdashboardretirementwatcherqueuePolicyB82D0C25:
    Type: 'AWS::SQS::QueuePolicy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 'sqs:SendMessage'
              - 'sqs:GetQueueAttributes'
              - 'sqs:GetQueueUrl'
            Condition:
              ArnEquals:
                'aws:SourceArn':
                  'Fn::GetAtt':
                    - withoutmetricsdashboardretirementwatcherrule1D4F9214
                    - Arn
            Effect: Allow
            Principal:
              Service: events.amazonaws.com
            Resource:
              'Fn::GetAtt':
                - withoutmetricsdashboardretirementwatcherqueueBDFF2271
                - Arn
        Version: '2012-10-17'
      Queues:
        - Ref: withoutmetricsdashboardretirementwatcherqueueBDFF2271
  withoutmetricsdashboardretirementwatcherrule1D4F9214:
    Type: 'AWS::Events::Rule'
    Properties:
      EventPattern:
        detail:
          eventTypeCode:
            - equals-ignore-case: AWS_ECS_TASK_PATCHING_RETIREMENT
          service:
            - equals-ignore-case: ecs
        resources:
          - prefix:
              'Fn::Join':
                - /
                - - 'Fn::Join':
                      - ':'
                      - - 'Fn::Select':
                            - 0
                            - 'Fn::Split':
                                - ':'
                                - 'Fn::Select':
                                    - 0
                                    - 'Fn::Split':
                                        - /
                                        - 'Fn::GetAtt':
                                            - withoutmetricsdashboardcluster465CA89C
                                            - Arn
                        - 'Fn::Select':
                            - 1
                            - 'Fn::Split':
                                - ':'
                                - 'Fn::Select':
                                    - 0
                                    - 'Fn::Split':
                                        - /
                                        - 'Fn::GetAtt':
                                            - withoutmetricsdashboardcluster465CA89C
                                            - Arn
                        - 'Fn::Select':
                            - 2
                            - 'Fn::Split':
                                - ':'
                                - 'Fn::Select':
                                    - 0
                                    - 'Fn::Split':
                                        - /
                                        - 'Fn::GetAtt':
                                            - withoutmetricsdashboardcluster465CA89C
                                            - Arn
                        - 'Fn::Select':
                            - 3
                            - 'Fn::Split':
                                - ':'
                                - 'Fn::Select':
                                    - 0
                                    - 'Fn::Split':
                                        - /
                                        - 'Fn::GetAtt':
                                            - withoutmetricsdashboardcluster465CA89C
                                            - Arn
                        - 'Fn::Select':
                            - 4
                            - 'Fn::Split':
                                - ':'
                                - 'Fn::Select':
                                    - 0
                                    - 'Fn::Split':
                                        - /
                                        - 'Fn::GetAtt':
                                            - withoutmetricsdashboardcluster465CA89C
                                            - Arn
                        - task
                  - 'Fn::Select':
                      - 1
                      - 'Fn::Split':
                          - /
                          - 'Fn::GetAtt':
                              - withoutmetricsdashboardcluster465CA89C
                              - Arn
                  - ''
        detail-type:
          - equals-ignore-case: AWS Health Event
      State: ENABLED
      Targets:
        - Arn:
            'Fn::GetAtt':
              - withoutmetricsdashboardretirementwatcherqueueBDFF2271
              - Arn
          Id: Target0
  withoutmetricsdashboardcloudwatchcustomwidgetexecutionroleD5E15156:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
        Version: '2012-10-17'
  withoutmetricsdashboardcloudwatchcustomwidgetexecutionroleDefaultPolicyC130BE41:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 'logs:CreateLogGroup'
              - 'logs:CreateLogStream'
              - 'logs:PutLogEvents'
            Effect: Allow
            Resource: '*'
            Sid: AWSLambdaBasicExecutionPermissions
          - Action: 'lambda:InvokeFunction'
            Effect: Allow
            Resource:
              'Fn::GetAtt':
                - withoutmetricsdashboardrestatectllambda65A0E1E2
                - Arn
            Sid: InvokeRestatectl
          - Action:
              - 'ec2:DescribeVolumes'
              - 'ec2:DescribeVolumeStatus'
            Effect: Allow
            Resource: '*'
            Sid: EC2ReadActions
          - Action: 'ecs:DescribeTaskDefinition'
            Effect: Allow
            Resource: '*'
            Sid: ECSReadActions
          - Action: 'ecs:ListTasks'
            Condition:
              StringEquals:
                'ecs:cluster':
                  'Fn::GetAtt':
                    - withoutmetricsdashboardcluster465CA89C
                    - Arn
            Effect: Allow
            Resource: '*'
            Sid: ECSListTasks
          - Action: 'ecs:DescribeTasks'
            Condition:
              StringEquals:
                'ecs:cluster':
                  'Fn::GetAtt':
                    - withoutmetricsdashboardcluster465CA89C
                    - Arn
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'arn:'
                  - Ref: 'AWS::Partition'
                  - ':ecs:'
                  - Ref: 'AWS::Region'
                  - ':'
                  - Ref: 'AWS::AccountId'
                  - ':task/'
                  - Ref: withoutmetricsdashboardcluster465CA89C
                  - /*
            Sid: ECSDescribeTasks
          - Action: 'ecs:DescribeServices'
            Condition:
              StringEquals:
                'ecs:cluster':
                  'Fn::GetAtt':
                    - withoutmetricsdashboardcluster465CA89C
                    - Arn
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'arn:'
                  - Ref: 'AWS::Partition'
                  - ':ecs:'
                  - Ref: 'AWS::Region'
                  - ':'
                  - Ref: 'AWS::AccountId'
                  - ':service/'
                  - Ref: withoutmetricsdashboardcluster465CA89C
                  - /*
            Sid: ECSDescribeServices
          - Action: 'cloudwatch:GetMetricData'
            Effect: Allow
            Resource: '*'
            Sid: CloudWatchReadActions
        Version: '2012-10-17'
      PolicyName: >-
        withoutmetricsdashboardcloudwatchcustomwidgetexecutionroleDefaultPolicyC130BE41
      Roles:
        - Ref: withoutmetricsdashboardcloudwatchcustomwidgetexecutionroleD5E15156
  withoutmetricsdashboardcloudwatchcustomwidgetlambda3189B37C:
    Type: 'AWS::Lambda::Function'
    Properties:
      Architectures:
        - arm64
      Code: Any<Object>
      Handler: index.handler
      MemorySize: 1024
      Role:
        'Fn::GetAtt':
          - withoutmetricsdashboardcloudwatchcustomwidgetexecutionroleD5E15156
          - Arn
      Runtime: nodejs22.x
      Tags:
        - Key: Name
          Value: >-
            RestateBYOC/without-metrics-dashboard/cloudwatch-custom-widget-lambda
      Timeout: 60
    DependsOn:
      - >-
        withoutmetricsdashboardcloudwatchcustomwidgetexecutionroleDefaultPolicyC130BE41
      - withoutmetricsdashboardcloudwatchcustomwidgetexecutionroleD5E15156
  withoutmetricsdashboardcloudwatchcustomwidgetlambdacloudwatchcustomwidgetlambdaallowdatasourceAB6B00C1:
    Type: 'AWS::Lambda::Permission'
    Properties:
      Action: 'lambda:InvokeFunction'
      FunctionName:
        'Fn::GetAtt':
          - withoutmetricsdashboardcloudwatchcustomwidgetlambda3189B37C
          - Arn
      Principal: lambda.datasource.cloudwatch.amazonaws.com
  withoutmetricsdashboardcontrolpanelC3399C92:
    Type: 'AWS::CloudWatch::Dashboard'
    Properties:
      DashboardBody:
        'Fn::Join':
          - ''
          - - >-
              {"widgets":[{"type":"custom","width":24,"height":26,"x":0,"y":0,"properties":{"endpoint":"
            - 'Fn::GetAtt':
                - withoutmetricsdashboardcloudwatchcustomwidgetlambda3189B37C
                - Arn
            - '","params":{"command":"controlPanel","input":{"region":"'
            - Ref: 'AWS::Region'
            - >-
              ","summary":{"clusterName":"RestateBYOC/without-metrics-dashboard","restateVersion":"1.3","stackVersion":"0.2.0"},"resources":{"ecsClusterArn":"
            - 'Fn::GetAtt':
                - withoutmetricsdashboardcluster465CA89C
                - Arn
            - '","statelessServiceArn":"'
            - Ref: withoutmetricsdashboardstatelessserviceServiceA5D262A7
            - '","controllerServiceArn":"'
            - Ref: withoutmetricsdashboardcontrollerserviceService573302DD
            - '","restatectlLambdaArn":"'
            - 'Fn::GetAtt':
                - withoutmetricsdashboardrestatectllambda65A0E1E2
                - Arn
            - >-
              "},"connectivityAndSecurity":{"connectivity":{"loadBalancerArns":{"ingress":["
            - Ref: withoutmetricsdashboardsharednlbA8403BAA
            - '"],"admin":["'
            - Ref: withoutmetricsdashboardsharednlbA8403BAA
            - '"]},"addresses":{"ingress":"http://'
            - 'Fn::GetAtt':
                - withoutmetricsdashboardsharednlbA8403BAA
                - DNSName
            - ':8080","admin":"http://'
            - 'Fn::GetAtt':
                - withoutmetricsdashboardsharednlbA8403BAA
                - DNSName
            - ':9070","webUI":"http://'
            - 'Fn::GetAtt':
                - withoutmetricsdashboardsharednlbA8403BAA
                - DNSName
            - ':9070/ui"}},"networking":{"vpc":"'
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcA2121C384D1B3CDE'
            - '","availabilityZones":["dummy1a","dummy1b","dummy1c"],"subnets":["'
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet1Subnet934893E8236E2271'
            - '","'
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet2Subnet7031C2BA60DCB1EE'
            - '","'
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet3Subnet985AC459F9514491'
            - '"]},"security":{"securityGroups":["'
            - 'Fn::GetAtt':
                - withoutmetricsdashboardsecuritygroup2805E007
                - GroupId
            - '"]}},"storage":{"s3":{"bucket":"'
            - Ref: withoutmetricsdashboardbucketDCB2C70A
            - >-
              "}}}},"title":"","updateOn":{"refresh":true,"resize":true,"timeRange":true}}}]}
      DashboardName: RestateBYOC_without-metrics-dashboard_control-panel
  withoutmetricsdashboardservicedeployerlambdaexecutionroleEB25789A:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
        Version: '2012-10-17'
  withoutmetricsdashboardservicedeployerlambdaexecutionroleDefaultPolicy6D38CA6D:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 'logs:CreateLogGroup'
              - 'logs:CreateLogStream'
              - 'logs:PutLogEvents'
              - 'ec2:CreateNetworkInterface'
              - 'ec2:DescribeNetworkInterfaces'
              - 'ec2:DescribeSubnets'
              - 'ec2:DeleteNetworkInterface'
              - 'ec2:AssignPrivateIpAddresses'
              - 'ec2:UnassignPrivateIpAddresses'
            Effect: Allow
            Resource: '*'
            Sid: AWSLambdaVPCAccessExecutionPermissions
        Version: '2012-10-17'
      PolicyName: >-
        withoutmetricsdashboardservicedeployerlambdaexecutionroleDefaultPolicy6D38CA6D
      Roles:
        - Ref: withoutmetricsdashboardservicedeployerlambdaexecutionroleEB25789A
  withoutmetricsdashboardservicedeployerEventHandler739C15DE:
    Type: 'AWS::Lambda::Function'
    Properties:
      Architectures:
        - arm64
      Code: Any<Object>
      Description: Restate custom registration handler
      Environment:
        Variables:
          NODE_OPTIONS: '--enable-source-maps'
      Handler: entrypoint.handler
      MemorySize: 128
      Role:
        'Fn::GetAtt':
          - withoutmetricsdashboardservicedeployerlambdaexecutionroleEB25789A
          - Arn
      Runtime: nodejs22.x
      Timeout: 180
      VpcConfig:
        SecurityGroupIds:
          - 'Fn::GetAtt':
              - withoutmetricsdashboardsecuritygroup2805E007
              - GroupId
        SubnetIds:
          - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet1Subnet934893E8236E2271'
          - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet2Subnet7031C2BA60DCB1EE'
          - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet3Subnet985AC459F9514491'
    DependsOn:
      - >-
        withoutmetricsdashboardservicedeployerlambdaexecutionroleDefaultPolicy6D38CA6D
      - withoutmetricsdashboardservicedeployerlambdaexecutionroleEB25789A
  withoutmetricsdashboardservicedeployerDeploymentLogs9FA363C0:
    Type: 'AWS::Logs::LogGroup'
    Properties:
      LogGroupName:
        'Fn::Join':
          - ''
          - - /aws/lambda/
            - Ref: withoutmetricsdashboardservicedeployerEventHandler739C15DE
      RetentionInDays: 30
    UpdateReplacePolicy: Retain
    DeletionPolicy: RetainExceptOnCreate
"
`;

exports[`BYOC Without service deployer 1`] = `
"Resources:
  withoutservicedeployersecuritygroup68EF3063:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      GroupDescription: RestateBYOC/without-service-deployer/security-group
      SecurityGroupEgress:
        - CidrIp: 0.0.0.0/0
          Description: Allow all outbound traffic by default
          IpProtocol: '-1'
      Tags:
        - Key: Name
          Value: RestateBYOC/without-service-deployer/security-group
      VpcId:
        'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcA2121C384D1B3CDE'
  withoutservicedeployersecuritygroupfromRestateBYOCwithoutservicedeployersecuritygroup97B1828F80808A0B9A20:
    Type: 'AWS::EC2::SecurityGroupIngress'
    Properties:
      Description: 'from RestateBYOCwithoutservicedeployersecuritygroup97B1828F:8080'
      FromPort: 8080
      GroupId:
        'Fn::GetAtt':
          - withoutservicedeployersecuritygroup68EF3063
          - GroupId
      IpProtocol: tcp
      SourceSecurityGroupId:
        'Fn::GetAtt':
          - withoutservicedeployersecuritygroup68EF3063
          - GroupId
      ToPort: 8080
  withoutservicedeployersecuritygroupfromRestateBYOCwithoutservicedeployersecuritygroup97B1828F90700E6175C1:
    Type: 'AWS::EC2::SecurityGroupIngress'
    Properties:
      Description: 'from RestateBYOCwithoutservicedeployersecuritygroup97B1828F:9070'
      FromPort: 9070
      GroupId:
        'Fn::GetAtt':
          - withoutservicedeployersecuritygroup68EF3063
          - GroupId
      IpProtocol: tcp
      SourceSecurityGroupId:
        'Fn::GetAtt':
          - withoutservicedeployersecuritygroup68EF3063
          - GroupId
      ToPort: 9070
  withoutservicedeployersecuritygroupfromRestateBYOCwithoutservicedeployersecuritygroup97B1828F512265C056CC:
    Type: 'AWS::EC2::SecurityGroupIngress'
    Properties:
      Description: 'from RestateBYOCwithoutservicedeployersecuritygroup97B1828F:5122'
      FromPort: 5122
      GroupId:
        'Fn::GetAtt':
          - withoutservicedeployersecuritygroup68EF3063
          - GroupId
      IpProtocol: tcp
      SourceSecurityGroupId:
        'Fn::GetAtt':
          - withoutservicedeployersecuritygroup68EF3063
          - GroupId
      ToPort: 5122
  withoutservicedeployerbucketB1987DAB:
    Type: 'AWS::S3::Bucket'
    Properties:
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
    UpdateReplacePolicy: Retain
    DeletionPolicy: Retain
  withoutservicedeployerbucketPolicy95A5DE97:
    Type: 'AWS::S3::BucketPolicy'
    Properties:
      Bucket:
        Ref: withoutservicedeployerbucketB1987DAB
      PolicyDocument:
        Statement:
          - Action: 's3:*'
            Condition:
              Bool:
                'aws:SecureTransport': 'false'
            Effect: Deny
            Principal:
              AWS: '*'
            Resource:
              - 'Fn::GetAtt':
                  - withoutservicedeployerbucketB1987DAB
                  - Arn
              - 'Fn::Join':
                  - ''
                  - - 'Fn::GetAtt':
                        - withoutservicedeployerbucketB1987DAB
                        - Arn
                    - /*
        Version: '2012-10-17'
  withoutservicedeployerclusterC266C783:
    Type: 'AWS::ECS::Cluster'
    Properties:
      ClusterSettings:
        - Name: containerInsights
          Value: enhanced
      Tags:
        - Key: Name
          Value: RestateBYOC/without-service-deployer/cluster
  withoutservicedeployerrestatetaskrole0BA346B5:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
        Version: '2012-10-17'
  withoutservicedeployerrestatetaskroleDefaultPolicy87F6ADA8:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 's3:GetObject'
              - 's3:PutObject'
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'Fn::GetAtt':
                      - withoutservicedeployerbucketB1987DAB
                      - Arn
                  - /*
            Sid: ReadWriteBucket
          - Action: 's3:ListBucket'
            Effect: Allow
            Resource:
              'Fn::GetAtt':
                - withoutservicedeployerbucketB1987DAB
                - Arn
            Sid: ListBucket
        Version: '2012-10-17'
      PolicyName: withoutservicedeployerrestatetaskroleDefaultPolicy87F6ADA8
      Roles:
        - Ref: withoutservicedeployerrestatetaskrole0BA346B5
  withoutservicedeployerrestateexecutionroleC44D4A99:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
        Version: '2012-10-17'
  withoutservicedeployerrestateexecutionroleDefaultPolicy90952A42:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 'logs:CreateLogStream'
              - 'logs:PutLogEvents'
            Effect: Allow
            Resource:
              'Fn::GetAtt':
                - >-
                  withoutservicedeployerstatelessdefinitionrestateLogGroupEC27F989
                - Arn
          - Action:
              - 'logs:CreateLogStream'
              - 'logs:PutLogEvents'
            Effect: Allow
            Resource:
              'Fn::GetAtt':
                - >-
                  withoutservicedeployerstatefuldefinitionrestateLogGroupCE40C5FC
                - Arn
        Version: '2012-10-17'
      PolicyName: withoutservicedeployerrestateexecutionroleDefaultPolicy90952A42
      Roles:
        - Ref: withoutservicedeployerrestateexecutionroleC44D4A99
  withoutservicedeployersharednlb054F9DEE:
    Type: 'AWS::ElasticLoadBalancingV2::LoadBalancer'
    Properties:
      LoadBalancerAttributes:
        - Key: deletion_protection.enabled
          Value: 'false'
        - Key: load_balancing.cross_zone.enabled
          Value: 'false'
        - Key: dns_record.client_routing_policy
          Value: availability_zone_affinity
      Scheme: internal
      SecurityGroups:
        - 'Fn::GetAtt':
            - withoutservicedeployersecuritygroup68EF3063
            - GroupId
      Subnets:
        - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet1Subnet934893E8236E2271'
        - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet2Subnet7031C2BA60DCB1EE'
        - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet3Subnet985AC459F9514491'
      Tags:
        - Key: Name
          Value: RestateBYOC/without-service-deployer/shared-nlb
      Type: network
  withoutservicedeployeringresssharedlistener96F1E3C9:
    Type: 'AWS::ElasticLoadBalancingV2::Listener'
    Properties:
      DefaultActions:
        - TargetGroupArn:
            Ref: withoutservicedeployeringresssharedtarget4F34F9D6
          Type: forward
      LoadBalancerArn:
        Ref: withoutservicedeployersharednlb054F9DEE
      Port: 8080
      Protocol: TCP
  withoutservicedeployeradminsharedlistener510F9C0E:
    Type: 'AWS::ElasticLoadBalancingV2::Listener'
    Properties:
      DefaultActions:
        - TargetGroupArn:
            Ref: withoutservicedeployeradminsharedtarget5AEA9CF6
          Type: forward
      LoadBalancerArn:
        Ref: withoutservicedeployersharednlb054F9DEE
      Port: 9070
      Protocol: TCP
  withoutservicedeployernodesharedlistenerF82C2C12:
    Type: 'AWS::ElasticLoadBalancingV2::Listener'
    Properties:
      DefaultActions:
        - TargetGroupArn:
            Ref: withoutservicedeployernodesharedtarget6F8051A0
          Type: forward
      LoadBalancerArn:
        Ref: withoutservicedeployersharednlb054F9DEE
      Port: 5122
      Protocol: TCP
  withoutservicedeployerstatelessdefinition8A66D938:
    Type: 'AWS::ECS::TaskDefinition'
    Properties:
      ContainerDefinitions:
        - Cpu: 16384
          EntryPoint:
            - bash
            - '-c'
            - >

              curl --no-progress-meter $ECS_CONTAINER_METADATA_URI_V4/task -o
              task-metadata && \\

              export \\
                RESTATE_NODE_NAME=$(jq -r '.TaskARN' task-metadata) \\
                RESTATE_LOCATION="$AWS_REGION.$(jq -r '.AvailabilityZone' task-metadata)" \\
                RESTATE_ADVERTISED_ADDRESS="http://$(jq -r '.Containers[0].Networks[0].IPv4Addresses[0]' task-metadata):5122"
              exec restate-server
          Environment:
            - Name: RESTATE_LOG_FORMAT
              Value: json
            - Name: RESTATE_CLUSTER_NAME
              Value: RestateBYOC/without-service-deployer
            - Name: RESTATE_ROLES
              Value: '["admin","http-ingress"]'
            - Name: RESTATE_AUTO_PROVISION
              Value: 'true'
            - Name: RESTATE_SHUTDOWN_TIMEOUT
              Value: 100s
            - Name: RESTATE_DEFAULT_NUM_PARTITIONS
              Value: '128'
            - Name: RESTATE_DEFAULT_REPLICATION
              Value: '{zone: 2}'
            - Name: RESTATE_METADATA_CLIENT__TYPE
              Value: object-store
            - Name: RESTATE_METADATA_CLIENT__PATH
              Value:
                'Fn::Join':
                  - ''
                  - - 's3://'
                    - Ref: withoutservicedeployerbucketB1987DAB
                    - /metadata
            - Name: RESTATE_BIFROST__DEFAULT_PROVIDER
              Value: replicated
            - Name: >-
                RESTATE_INGRESS__EXPERIMENTAL_FEATURE_ENABLE_SEPARATE_INGRESS_ROLE
              Value: 'true'
            - Name: RESTATE_INGRESS__ADVERTISED_INGRESS_ENDPOINT
              Value:
                'Fn::Join':
                  - ''
                  - - 'http://'
                    - 'Fn::GetAtt':
                        - withoutservicedeployersharednlb054F9DEE
                        - DNSName
                    - ':8080'
            - Name: RESTATE_WORKER__SNAPSHOTS__DESTINATION
              Value:
                'Fn::Join':
                  - ''
                  - - 's3://'
                    - Ref: withoutservicedeployerbucketB1987DAB
                    - /snapshots
          Essential: true
          HealthCheck:
            Command:
              - CMD
              - curl
              - '--fail'
              - 'http://127.0.0.1:8080/restate/health'
            Interval: 30
            Retries: 3
            Timeout: 5
          Image: Any<Object>
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group:
                Ref: >-
                  withoutservicedeployerstatelessdefinitionrestateLogGroupEC27F989
              awslogs-stream-prefix: restate
              awslogs-region: region
          Memory: 32768
          Name: restate
          PortMappings:
            - ContainerPort: 8080
              Name: ingress
              Protocol: tcp
            - ContainerPort: 9070
              Name: admin
              Protocol: tcp
            - ContainerPort: 5122
              Name: node
              Protocol: tcp
          StopTimeout: 120
      Cpu: '16384'
      ExecutionRoleArn:
        'Fn::GetAtt':
          - withoutservicedeployerrestateexecutionroleC44D4A99
          - Arn
      Family: RestateBYOCwithoutservicedeployerstatelessdefinition466C1E01
      Memory: '32768'
      NetworkMode: awsvpc
      RequiresCompatibilities:
        - FARGATE
      RuntimePlatform:
        CpuArchitecture: ARM64
        OperatingSystemFamily: LINUX
      Tags:
        - Key: Name
          Value: RestateBYOC/without-service-deployer/stateless-definition
      TaskRoleArn:
        'Fn::GetAtt':
          - withoutservicedeployerrestatetaskrole0BA346B5
          - Arn
  withoutservicedeployerstatelessdefinitionrestateLogGroupEC27F989:
    Type: 'AWS::Logs::LogGroup'
    Properties:
      Tags:
        - Key: Name
          Value: RestateBYOC/without-service-deployer/stateless-definition
    UpdateReplacePolicy: Retain
    DeletionPolicy: Retain
  withoutservicedeployerstatelessserviceService4B925097:
    Type: 'AWS::ECS::Service'
    Properties:
      Cluster:
        Ref: withoutservicedeployerclusterC266C783
      DeploymentConfiguration:
        Alarms:
          AlarmNames: []
          Enable: false
          Rollback: false
        MaximumPercent: 200
        MinimumHealthyPercent: 100
      DesiredCount: 3
      EnableECSManagedTags: false
      EnableExecuteCommand: false
      HealthCheckGracePeriodSeconds: 60
      LaunchType: FARGATE
      LoadBalancers:
        - ContainerName: restate
          ContainerPort: 8080
          TargetGroupArn:
            Ref: withoutservicedeployeringresssharedtarget4F34F9D6
        - ContainerName: restate
          ContainerPort: 9070
          TargetGroupArn:
            Ref: withoutservicedeployeradminsharedtarget5AEA9CF6
        - ContainerName: restate
          ContainerPort: 5122
          TargetGroupArn:
            Ref: withoutservicedeployernodesharedtarget6F8051A0
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: DISABLED
          SecurityGroups:
            - 'Fn::GetAtt':
                - withoutservicedeployersecuritygroup68EF3063
                - GroupId
          Subnets:
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet1Subnet934893E8236E2271'
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet2Subnet7031C2BA60DCB1EE'
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet3Subnet985AC459F9514491'
      PropagateTags: SERVICE
      Tags:
        - Key: Name
          Value: RestateBYOC/without-service-deployer/stateless-service
      TaskDefinition:
        Ref: withoutservicedeployerstatelessdefinition8A66D938
    DependsOn:
      - withoutservicedeployeradminsharedlistener510F9C0E
      - withoutservicedeployeringresssharedlistener96F1E3C9
      - withoutservicedeployernodesharedlistenerF82C2C12
      - withoutservicedeployerrestatetaskroleDefaultPolicy87F6ADA8
      - withoutservicedeployerrestatetaskrole0BA346B5
  withoutservicedeployerstatefuldefinition9743572A:
    Type: 'AWS::ECS::TaskDefinition'
    Properties:
      ContainerDefinitions:
        - Cpu: 16384
          EntryPoint:
            - bash
            - '-c'
            - >

              curl --no-progress-meter $ECS_CONTAINER_METADATA_URI_V4/task -o
              task-metadata && \\

              export \\
                RESTATE_NODE_NAME=$(jq -r '.TaskARN' task-metadata) \\
                RESTATE_LOCATION="$AWS_REGION.$(jq -r '.AvailabilityZone' task-metadata)" \\
                RESTATE_ADVERTISED_ADDRESS="http://$(jq -r '.Containers[0].Networks[0].IPv4Addresses[0]' task-metadata):5122"
              exec restate-server
          Environment:
            - Name: RESTATE_LOG_FORMAT
              Value: json
            - Name: RESTATE_CLUSTER_NAME
              Value: RestateBYOC/without-service-deployer
            - Name: RESTATE_ROLES
              Value: '["log-server", "worker"]'
            - Name: RESTATE_AUTO_PROVISION
              Value: 'false'
            - Name: RESTATE_SHUTDOWN_TIMEOUT
              Value: 100s
            - Name: RESTATE_ROCKSDB_TOTAL_MEMORY_SIZE
              Value: 24576MiB
            - Name: RESTATE_METADATA_CLIENT__TYPE
              Value: object-store
            - Name: RESTATE_METADATA_CLIENT__PATH
              Value:
                'Fn::Join':
                  - ''
                  - - 's3://'
                    - Ref: withoutservicedeployerbucketB1987DAB
                    - /metadata
            - Name: RESTATE_WORKER__SNAPSHOTS__DESTINATION
              Value:
                'Fn::Join':
                  - ''
                  - - 's3://'
                    - Ref: withoutservicedeployerbucketB1987DAB
                    - /snapshots
            - Name: RESTATE_WORKER__SNAPSHOTS__SNAPSHOT_INTERVAL_NUM_RECORDS
              Value: '1000000'
            - Name: RESTATE_WORKER__STORAGE__ROCKSDB_DISABLE_DIRECT_IO_FOR_READS
              Value: 'true'
            - Name: RESTATE_WORKER__STORAGE__ROCKSDB_DISABLE_WAL_FSYNC
              Value: 'true'
            - Name: RESTATE_LOG_SERVER__ROCKSDB_DISABLE_WAL_FSYNC
              Value: 'true'
            - Name: RESTATE_LOG_SERVER__ROCKSDB_DISABLE_DIRECT_IO_FOR_READS
              Value: 'true'
            - Name: >-
                RESTATE_INGRESS__EXPERIMENTAL_FEATURE_ENABLE_SEPARATE_INGRESS_ROLE
              Value: 'true'
          Essential: true
          HealthCheck:
            Command:
              - CMD
              - curl
              - '--fail'
              - 'http://127.0.0.1:5122/health'
            Interval: 30
            Retries: 3
            Timeout: 5
          Image: Any<Object>
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group:
                Ref: >-
                  withoutservicedeployerstatefuldefinitionrestateLogGroupCE40C5FC
              awslogs-stream-prefix: restate
              awslogs-region: region
          Memory: 32768
          MountPoints:
            - ContainerPath: /restate-data
              ReadOnly: false
              SourceVolume: restate-data
          Name: restate
          PortMappings:
            - ContainerPort: 5122
              Name: node
              Protocol: tcp
          RestartPolicy:
            Enabled: true
            RestartAttemptPeriod: 60
          StopTimeout: 120
      Cpu: '16384'
      EphemeralStorage:
        SizeInGiB: 200
      ExecutionRoleArn:
        'Fn::GetAtt':
          - withoutservicedeployerrestateexecutionroleC44D4A99
          - Arn
      Family: RestateBYOCwithoutservicedeployerstatefuldefinition55E65D66
      Memory: '32768'
      NetworkMode: awsvpc
      RequiresCompatibilities:
        - FARGATE
      RuntimePlatform:
        CpuArchitecture: ARM64
        OperatingSystemFamily: LINUX
      Tags:
        - Key: Name
          Value: RestateBYOC/without-service-deployer/stateful-definition
      TaskRoleArn:
        'Fn::GetAtt':
          - withoutservicedeployerrestatetaskrole0BA346B5
          - Arn
      Volumes:
        - ConfiguredAtLaunch: false
          Name: restate-data
  withoutservicedeployerstatefuldefinitionrestateLogGroupCE40C5FC:
    Type: 'AWS::Logs::LogGroup'
    Properties:
      Tags:
        - Key: Name
          Value: RestateBYOC/without-service-deployer/stateful-definition
    UpdateReplacePolicy: Retain
    DeletionPolicy: Retain
  withoutservicedeployeringresssharedtarget4F34F9D6:
    Type: 'AWS::ElasticLoadBalancingV2::TargetGroup'
    Properties:
      HealthCheckEnabled: true
      HealthCheckIntervalSeconds: 5
      HealthCheckPath: /restate/health
      HealthCheckProtocol: HTTP
      HealthCheckTimeoutSeconds: 2
      Port: 8080
      Protocol: TCP
      Tags:
        - Key: Name
          Value: RestateBYOC/without-service-deployer/ingress-shared-target
      TargetType: ip
      VpcId:
        'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcA2121C384D1B3CDE'
  withoutservicedeployeradminsharedtarget5AEA9CF6:
    Type: 'AWS::ElasticLoadBalancingV2::TargetGroup'
    Properties:
      HealthCheckEnabled: true
      HealthCheckIntervalSeconds: 5
      HealthCheckPath: /health
      HealthCheckPort: '9070'
      HealthCheckProtocol: HTTP
      HealthCheckTimeoutSeconds: 2
      Port: 9070
      Protocol: TCP
      Tags:
        - Key: Name
          Value: RestateBYOC/without-service-deployer/admin-shared-target
      TargetType: ip
      VpcId:
        'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcA2121C384D1B3CDE'
  withoutservicedeployernodesharedtarget6F8051A0:
    Type: 'AWS::ElasticLoadBalancingV2::TargetGroup'
    Properties:
      HealthCheckEnabled: true
      HealthCheckIntervalSeconds: 5
      HealthCheckPath: /health
      HealthCheckPort: '5122'
      HealthCheckProtocol: HTTP
      HealthCheckTimeoutSeconds: 2
      Port: 5122
      Protocol: TCP
      Tags:
        - Key: Name
          Value: RestateBYOC/without-service-deployer/node-shared-target
      TargetType: ip
      VpcId:
        'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcA2121C384D1B3CDE'
  withoutservicedeployercontrollertaskrole618DDFFF:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
        Version: '2012-10-17'
  withoutservicedeployercontrollertaskroleDefaultPolicy23DA16F5:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 'ecs:ListTasks'
              - 'ecs:DescribeTasks'
              - 'ecs:StopTask'
            Condition:
              ArnEquals:
                'ecs:cluster':
                  'Fn::GetAtt':
                    - withoutservicedeployerclusterC266C783
                    - Arn
            Effect: Allow
            Resource: '*'
            Sid: TaskActions
          - Action: 'ecs:TagResource'
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'Fn::Join':
                      - /
                      - - 'Fn::Join':
                            - ':'
                            - - 'Fn::Select':
                                  - 0
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - withoutservicedeployerclusterC266C783
                                                  - Arn
                              - 'Fn::Select':
                                  - 1
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - withoutservicedeployerclusterC266C783
                                                  - Arn
                              - 'Fn::Select':
                                  - 2
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - withoutservicedeployerclusterC266C783
                                                  - Arn
                              - 'Fn::Select':
                                  - 3
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - withoutservicedeployerclusterC266C783
                                                  - Arn
                              - 'Fn::Select':
                                  - 4
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - withoutservicedeployerclusterC266C783
                                                  - Arn
                              - task
                        - 'Fn::Select':
                            - 1
                            - 'Fn::Split':
                                - /
                                - 'Fn::GetAtt':
                                    - withoutservicedeployerclusterC266C783
                                    - Arn
                        - ''
                  - '*'
            Sid: TagTasks
          - Action: 'ecs:RunTask'
            Condition:
              ArnEquals:
                'ecs:cluster':
                  'Fn::GetAtt':
                    - withoutservicedeployerclusterC266C783
                    - Arn
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'Fn::Join':
                      - ':'
                      - - 'Fn::Select':
                            - 0
                            - 'Fn::Split':
                                - ':'
                                - Ref: >-
                                    withoutservicedeployerstatefuldefinition9743572A
                        - 'Fn::Select':
                            - 1
                            - 'Fn::Split':
                                - ':'
                                - Ref: >-
                                    withoutservicedeployerstatefuldefinition9743572A
                        - 'Fn::Select':
                            - 2
                            - 'Fn::Split':
                                - ':'
                                - Ref: >-
                                    withoutservicedeployerstatefuldefinition9743572A
                        - 'Fn::Select':
                            - 3
                            - 'Fn::Split':
                                - ':'
                                - Ref: >-
                                    withoutservicedeployerstatefuldefinition9743572A
                        - 'Fn::Select':
                            - 4
                            - 'Fn::Split':
                                - ':'
                                - Ref: >-
                                    withoutservicedeployerstatefuldefinition9743572A
                        - 'Fn::Select':
                            - 5
                            - 'Fn::Split':
                                - ':'
                                - Ref: >-
                                    withoutservicedeployerstatefuldefinition9743572A
                  - ':*'
            Sid: RunTask
          - Action: 'iam:PassRole'
            Condition:
              StringEquals:
                'iam:PassedToService': ecs-tasks.amazonaws.com
            Effect: Allow
            Resource:
              - 'Fn::GetAtt':
                  - withoutservicedeployerrestatetaskrole0BA346B5
                  - Arn
              - 'Fn::GetAtt':
                  - withoutservicedeployerrestateexecutionroleC44D4A99
                  - Arn
            Sid: RunTaskPassRole
          - Action:
              - 's3:GetObject'
              - 's3:PutObject'
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'Fn::GetAtt':
                      - withoutservicedeployerbucketB1987DAB
                      - Arn
                  - /*
            Sid: ReadWriteBucket
          - Action: 's3:ListBucket'
            Effect: Allow
            Resource:
              'Fn::GetAtt':
                - withoutservicedeployerbucketB1987DAB
                - Arn
            Sid: ListBucket
        Version: '2012-10-17'
      PolicyName: withoutservicedeployercontrollertaskroleDefaultPolicy23DA16F5
      Roles:
        - Ref: withoutservicedeployercontrollertaskrole618DDFFF
  withoutservicedeployercontrollerexecutionroleEED6FF08:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
        Version: '2012-10-17'
  withoutservicedeployercontrollerexecutionroleDefaultPolicyB2F6A3F9:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 'logs:CreateLogStream'
              - 'logs:PutLogEvents'
            Effect: Allow
            Resource:
              'Fn::GetAtt':
                - >-
                  withoutservicedeployercontrollerdefinitioncontrollerLogGroupC38FCA92
                - Arn
        Version: '2012-10-17'
      PolicyName: withoutservicedeployercontrollerexecutionroleDefaultPolicyB2F6A3F9
      Roles:
        - Ref: withoutservicedeployercontrollerexecutionroleEED6FF08
  withoutservicedeployercontrollerdefinition0FA6B55C:
    Type: 'AWS::ECS::TaskDefinition'
    Properties:
      ContainerDefinitions:
        - Cpu: 1024
          Environment:
            - Name: RUST_LOG
              Value: 'info,restate_fargate_controller=debug'
            - Name: CONTROLLER_LOG_FORMAT
              Value: json
            - Name: CONTROLLER_METADATA_PATH
              Value:
                'Fn::Join':
                  - ''
                  - - 's3://'
                    - Ref: withoutservicedeployerbucketB1987DAB
                    - /metadata
            - Name: CONTROLLER_RECONCILE_INTERVAL
              Value: 10s
            - Name: CONTROLLER_CLUSTER__CLUSTER_ARN
              Value:
                'Fn::GetAtt':
                  - withoutservicedeployerclusterC266C783
                  - Arn
            - Name: CONTROLLER_LICENSE_ID
              Value: foo
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __REGION
              Value:
                Ref: 'AWS::Region'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __CLUSTER_ARN
              Value:
                'Fn::GetAtt':
                  - withoutservicedeployerclusterC266C783
                  - Arn
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __TASK_PREFIX
              Value:
                'Fn::Join':
                  - /
                  - - 'Fn::Join':
                        - ':'
                        - - 'Fn::Select':
                              - 0
                              - 'Fn::Split':
                                  - ':'
                                  - 'Fn::Select':
                                      - 0
                                      - 'Fn::Split':
                                          - /
                                          - 'Fn::GetAtt':
                                              - withoutservicedeployerclusterC266C783
                                              - Arn
                          - 'Fn::Select':
                              - 1
                              - 'Fn::Split':
                                  - ':'
                                  - 'Fn::Select':
                                      - 0
                                      - 'Fn::Split':
                                          - /
                                          - 'Fn::GetAtt':
                                              - withoutservicedeployerclusterC266C783
                                              - Arn
                          - 'Fn::Select':
                              - 2
                              - 'Fn::Split':
                                  - ':'
                                  - 'Fn::Select':
                                      - 0
                                      - 'Fn::Split':
                                          - /
                                          - 'Fn::GetAtt':
                                              - withoutservicedeployerclusterC266C783
                                              - Arn
                          - 'Fn::Select':
                              - 3
                              - 'Fn::Split':
                                  - ':'
                                  - 'Fn::Select':
                                      - 0
                                      - 'Fn::Split':
                                          - /
                                          - 'Fn::GetAtt':
                                              - withoutservicedeployerclusterC266C783
                                              - Arn
                          - 'Fn::Select':
                              - 4
                              - 'Fn::Split':
                                  - ':'
                                  - 'Fn::Select':
                                      - 0
                                      - 'Fn::Split':
                                          - /
                                          - 'Fn::GetAtt':
                                              - withoutservicedeployerclusterC266C783
                                              - Arn
                          - task
                    - 'Fn::Select':
                        - 1
                        - 'Fn::Split':
                            - /
                            - 'Fn::GetAtt':
                                - withoutservicedeployerclusterC266C783
                                - Arn
                    - ''
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1a__ENABLE_EXECUTE_COMMAND
              Value: 'false'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1a__SECURITY_GROUPS
              Value:
                'Fn::Join':
                  - ''
                  - - '["'
                    - 'Fn::GetAtt':
                        - withoutservicedeployersecuritygroup68EF3063
                        - GroupId
                    - '"]'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1a__SUBNETS
              Value:
                'Fn::Join':
                  - ''
                  - - '["'
                    - 'Fn::ImportValue': >-
                        VPCStack:ExportsOutputRefvpcPrivateSubnet1Subnet934893E8236E2271
                    - '"]'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1a__TASK_DEFINITION_ARN
              Value:
                Ref: withoutservicedeployerstatefuldefinition9743572A
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1a__COUNT
              Value: '1'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1b__ENABLE_EXECUTE_COMMAND
              Value: 'false'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1b__SECURITY_GROUPS
              Value:
                'Fn::Join':
                  - ''
                  - - '["'
                    - 'Fn::GetAtt':
                        - withoutservicedeployersecuritygroup68EF3063
                        - GroupId
                    - '"]'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1b__SUBNETS
              Value:
                'Fn::Join':
                  - ''
                  - - '["'
                    - 'Fn::ImportValue': >-
                        VPCStack:ExportsOutputRefvpcPrivateSubnet2Subnet7031C2BA60DCB1EE
                    - '"]'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1b__TASK_DEFINITION_ARN
              Value:
                Ref: withoutservicedeployerstatefuldefinition9743572A
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1b__COUNT
              Value: '1'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1c__ENABLE_EXECUTE_COMMAND
              Value: 'false'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1c__SECURITY_GROUPS
              Value:
                'Fn::Join':
                  - ''
                  - - '["'
                    - 'Fn::GetAtt':
                        - withoutservicedeployersecuritygroup68EF3063
                        - GroupId
                    - '"]'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1c__SUBNETS
              Value:
                'Fn::Join':
                  - ''
                  - - '["'
                    - 'Fn::ImportValue': >-
                        VPCStack:ExportsOutputRefvpcPrivateSubnet3Subnet985AC459F9514491
                    - '"]'
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1c__TASK_DEFINITION_ARN
              Value:
                Ref: withoutservicedeployerstatefuldefinition9743572A
            - Name:
                'Fn::Join':
                  - ''
                  - - CONTROLLER_ECS_CLUSTERS__
                    - Ref: 'AWS::Region'
                    - __ZONES__dummy1c__COUNT
              Value: '1'
          Essential: true
          HealthCheck:
            Command:
              - CMD
              - curl
              - '--fail'
              - 'http://127.0.0.1:8080/health'
            Interval: 30
            Retries: 10
            StartPeriod: 300
            Timeout: 5
          Image: Any<Object>
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group:
                Ref: >-
                  withoutservicedeployercontrollerdefinitioncontrollerLogGroupC38FCA92
              awslogs-stream-prefix: controller
              awslogs-region: region
          Memory: 2048
          Name: controller
          StopTimeout: 120
      Cpu: '1024'
      ExecutionRoleArn:
        'Fn::GetAtt':
          - withoutservicedeployercontrollerexecutionroleEED6FF08
          - Arn
      Family: RestateBYOCwithoutservicedeployercontrollerdefinitionFE9E7EDD
      Memory: '2048'
      NetworkMode: awsvpc
      RequiresCompatibilities:
        - FARGATE
      RuntimePlatform:
        CpuArchitecture: ARM64
        OperatingSystemFamily: LINUX
      Tags:
        - Key: Name
          Value: RestateBYOC/without-service-deployer/controller-definition
      TaskRoleArn:
        'Fn::GetAtt':
          - withoutservicedeployercontrollertaskrole618DDFFF
          - Arn
  withoutservicedeployercontrollerdefinitioncontrollerLogGroupC38FCA92:
    Type: 'AWS::Logs::LogGroup'
    Properties:
      Tags:
        - Key: Name
          Value: RestateBYOC/without-service-deployer/controller-definition
    UpdateReplacePolicy: Retain
    DeletionPolicy: Retain
  withoutservicedeployercontrollerserviceService53E53874:
    Type: 'AWS::ECS::Service'
    Properties:
      Cluster:
        Ref: withoutservicedeployerclusterC266C783
      DeploymentConfiguration:
        Alarms:
          AlarmNames: []
          Enable: false
          Rollback: false
        MaximumPercent: 100
        MinimumHealthyPercent: 0
      DesiredCount: 1
      EnableECSManagedTags: false
      EnableExecuteCommand: false
      LaunchType: FARGATE
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: DISABLED
          SecurityGroups:
            - 'Fn::GetAtt':
                - withoutservicedeployersecuritygroup68EF3063
                - GroupId
          Subnets:
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet1Subnet934893E8236E2271'
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet2Subnet7031C2BA60DCB1EE'
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet3Subnet985AC459F9514491'
      Tags:
        - Key: Name
          Value: RestateBYOC/without-service-deployer/controller-service
      TaskDefinition:
        Ref: withoutservicedeployercontrollerdefinition0FA6B55C
    DependsOn:
      - withoutservicedeployercontrollertaskroleDefaultPolicy23DA16F5
      - withoutservicedeployercontrollertaskrole618DDFFF
  withoutservicedeployerrestatectllambdaexecutionrole17BB387E:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
        Version: '2012-10-17'
  withoutservicedeployerrestatectllambdaexecutionroleDefaultPolicy3BEF6BA1:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 'logs:CreateLogGroup'
              - 'logs:CreateLogStream'
              - 'logs:PutLogEvents'
              - 'ec2:CreateNetworkInterface'
              - 'ec2:DescribeNetworkInterfaces'
              - 'ec2:DescribeSubnets'
              - 'ec2:DeleteNetworkInterface'
              - 'ec2:AssignPrivateIpAddresses'
              - 'ec2:UnassignPrivateIpAddresses'
            Effect: Allow
            Resource: '*'
            Sid: AWSLambdaVPCAccessExecutionPermissions
        Version: '2012-10-17'
      PolicyName: withoutservicedeployerrestatectllambdaexecutionroleDefaultPolicy3BEF6BA1
      Roles:
        - Ref: withoutservicedeployerrestatectllambdaexecutionrole17BB387E
  withoutservicedeployerrestatectllambda9B5C28C5:
    Type: 'AWS::Lambda::Function'
    Properties:
      Architectures:
        - arm64
      Code: Any<Object>
      Environment:
        Variables:
          RESTATECTL_ADDRESS:
            'Fn::Join':
              - ''
              - - 'http://'
                - 'Fn::GetAtt':
                    - withoutservicedeployersharednlb054F9DEE
                    - DNSName
                - ':5122'
      Handler: restatectl
      Role:
        'Fn::GetAtt':
          - withoutservicedeployerrestatectllambdaexecutionrole17BB387E
          - Arn
      Runtime: provided.al2023
      Tags:
        - Key: Name
          Value: RestateBYOC/without-service-deployer/restatectl-lambda
      Timeout: 10
      VpcConfig:
        SecurityGroupIds:
          - 'Fn::GetAtt':
              - withoutservicedeployersecuritygroup68EF3063
              - GroupId
        SubnetIds:
          - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet1Subnet934893E8236E2271'
          - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet2Subnet7031C2BA60DCB1EE'
          - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet3Subnet985AC459F9514491'
    DependsOn:
      - withoutservicedeployerrestatectllambdaexecutionroleDefaultPolicy3BEF6BA1
      - withoutservicedeployerrestatectllambdaexecutionrole17BB387E
  withoutservicedeployerretirementwatcherlambdaexecutionrole1D0DEF51:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
        Version: '2012-10-17'
  withoutservicedeployerretirementwatcherlambdaexecutionroleDefaultPolicyBC949A2F:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 'logs:CreateLogGroup'
              - 'logs:CreateLogStream'
              - 'logs:PutLogEvents'
            Effect: Allow
            Resource: '*'
            Sid: AWSLambdaBasicExecutionPermissions
          - Action: 'ecs:TagResource'
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'Fn::Join':
                      - /
                      - - 'Fn::Join':
                            - ':'
                            - - 'Fn::Select':
                                  - 0
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - withoutservicedeployerclusterC266C783
                                                  - Arn
                              - 'Fn::Select':
                                  - 1
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - withoutservicedeployerclusterC266C783
                                                  - Arn
                              - 'Fn::Select':
                                  - 2
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - withoutservicedeployerclusterC266C783
                                                  - Arn
                              - 'Fn::Select':
                                  - 3
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - withoutservicedeployerclusterC266C783
                                                  - Arn
                              - 'Fn::Select':
                                  - 4
                                  - 'Fn::Split':
                                      - ':'
                                      - 'Fn::Select':
                                          - 0
                                          - 'Fn::Split':
                                              - /
                                              - 'Fn::GetAtt':
                                                  - withoutservicedeployerclusterC266C783
                                                  - Arn
                              - task
                        - 'Fn::Select':
                            - 1
                            - 'Fn::Split':
                                - /
                                - 'Fn::GetAtt':
                                    - withoutservicedeployerclusterC266C783
                                    - Arn
                        - ''
                  - '*'
            Sid: TagTasks
          - Action:
              - 'sqs:ReceiveMessage'
              - 'sqs:ChangeMessageVisibility'
              - 'sqs:GetQueueUrl'
              - 'sqs:DeleteMessage'
              - 'sqs:GetQueueAttributes'
            Effect: Allow
            Resource:
              'Fn::GetAtt':
                - withoutservicedeployerretirementwatcherqueue22A5702A
                - Arn
        Version: '2012-10-17'
      PolicyName: >-
        withoutservicedeployerretirementwatcherlambdaexecutionroleDefaultPolicyBC949A2F
      Roles:
        - Ref: withoutservicedeployerretirementwatcherlambdaexecutionrole1D0DEF51
  withoutservicedeployerretirementwatcherlambdaA642DDE8:
    Type: 'AWS::Lambda::Function'
    Properties:
      Architectures:
        - arm64
      Code: Any<Object>
      Handler: index.handler
      Role:
        'Fn::GetAtt':
          - withoutservicedeployerretirementwatcherlambdaexecutionrole1D0DEF51
          - Arn
      Runtime: nodejs22.x
      Tags:
        - Key: Name
          Value: RestateBYOC/without-service-deployer/retirement-watcher-lambda
      Timeout: 60
    DependsOn:
      - >-
        withoutservicedeployerretirementwatcherlambdaexecutionroleDefaultPolicyBC949A2F
      - withoutservicedeployerretirementwatcherlambdaexecutionrole1D0DEF51
  withoutservicedeployerretirementwatcherlambdaSqsEventSourceRestateBYOCwithoutservicedeployerretirementwatcherqueue4D9552904A54187C:
    Type: 'AWS::Lambda::EventSourceMapping'
    Properties:
      BatchSize: 1
      EventSourceArn:
        'Fn::GetAtt':
          - withoutservicedeployerretirementwatcherqueue22A5702A
          - Arn
      FunctionName:
        Ref: withoutservicedeployerretirementwatcherlambdaA642DDE8
      Tags:
        - Key: Name
          Value: RestateBYOC/without-service-deployer/retirement-watcher-lambda
  withoutservicedeployerretirementwatcherqueue22A5702A:
    Type: 'AWS::SQS::Queue'
    Properties:
      Tags:
        - Key: Name
          Value: RestateBYOC/without-service-deployer/retirement-watcher-queue
      VisibilityTimeout: 60
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  withoutservicedeployerretirementwatcherqueuePolicy82BEDBF6:
    Type: 'AWS::SQS::QueuePolicy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 'sqs:SendMessage'
              - 'sqs:GetQueueAttributes'
              - 'sqs:GetQueueUrl'
            Condition:
              ArnEquals:
                'aws:SourceArn':
                  'Fn::GetAtt':
                    - withoutservicedeployerretirementwatcherruleDFB1BB47
                    - Arn
            Effect: Allow
            Principal:
              Service: events.amazonaws.com
            Resource:
              'Fn::GetAtt':
                - withoutservicedeployerretirementwatcherqueue22A5702A
                - Arn
        Version: '2012-10-17'
      Queues:
        - Ref: withoutservicedeployerretirementwatcherqueue22A5702A
  withoutservicedeployerretirementwatcherruleDFB1BB47:
    Type: 'AWS::Events::Rule'
    Properties:
      EventPattern:
        detail:
          eventTypeCode:
            - equals-ignore-case: AWS_ECS_TASK_PATCHING_RETIREMENT
          service:
            - equals-ignore-case: ecs
        resources:
          - prefix:
              'Fn::Join':
                - /
                - - 'Fn::Join':
                      - ':'
                      - - 'Fn::Select':
                            - 0
                            - 'Fn::Split':
                                - ':'
                                - 'Fn::Select':
                                    - 0
                                    - 'Fn::Split':
                                        - /
                                        - 'Fn::GetAtt':
                                            - withoutservicedeployerclusterC266C783
                                            - Arn
                        - 'Fn::Select':
                            - 1
                            - 'Fn::Split':
                                - ':'
                                - 'Fn::Select':
                                    - 0
                                    - 'Fn::Split':
                                        - /
                                        - 'Fn::GetAtt':
                                            - withoutservicedeployerclusterC266C783
                                            - Arn
                        - 'Fn::Select':
                            - 2
                            - 'Fn::Split':
                                - ':'
                                - 'Fn::Select':
                                    - 0
                                    - 'Fn::Split':
                                        - /
                                        - 'Fn::GetAtt':
                                            - withoutservicedeployerclusterC266C783
                                            - Arn
                        - 'Fn::Select':
                            - 3
                            - 'Fn::Split':
                                - ':'
                                - 'Fn::Select':
                                    - 0
                                    - 'Fn::Split':
                                        - /
                                        - 'Fn::GetAtt':
                                            - withoutservicedeployerclusterC266C783
                                            - Arn
                        - 'Fn::Select':
                            - 4
                            - 'Fn::Split':
                                - ':'
                                - 'Fn::Select':
                                    - 0
                                    - 'Fn::Split':
                                        - /
                                        - 'Fn::GetAtt':
                                            - withoutservicedeployerclusterC266C783
                                            - Arn
                        - task
                  - 'Fn::Select':
                      - 1
                      - 'Fn::Split':
                          - /
                          - 'Fn::GetAtt':
                              - withoutservicedeployerclusterC266C783
                              - Arn
                  - ''
        detail-type:
          - equals-ignore-case: AWS Health Event
      State: ENABLED
      Targets:
        - Arn:
            'Fn::GetAtt':
              - withoutservicedeployerretirementwatcherqueue22A5702A
              - Arn
          Id: Target0
  withoutservicedeployercloudwatchcustomwidgetexecutionrole63498CC5:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
        Version: '2012-10-17'
  withoutservicedeployercloudwatchcustomwidgetexecutionroleDefaultPolicyB278087E:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - 'logs:CreateLogGroup'
              - 'logs:CreateLogStream'
              - 'logs:PutLogEvents'
            Effect: Allow
            Resource: '*'
            Sid: AWSLambdaBasicExecutionPermissions
          - Action: 'lambda:InvokeFunction'
            Effect: Allow
            Resource:
              'Fn::GetAtt':
                - withoutservicedeployerrestatectllambda9B5C28C5
                - Arn
            Sid: InvokeRestatectl
          - Action:
              - 'ec2:DescribeVolumes'
              - 'ec2:DescribeVolumeStatus'
            Effect: Allow
            Resource: '*'
            Sid: EC2ReadActions
          - Action: 'ecs:DescribeTaskDefinition'
            Effect: Allow
            Resource: '*'
            Sid: ECSReadActions
          - Action: 'ecs:ListTasks'
            Condition:
              StringEquals:
                'ecs:cluster':
                  'Fn::GetAtt':
                    - withoutservicedeployerclusterC266C783
                    - Arn
            Effect: Allow
            Resource: '*'
            Sid: ECSListTasks
          - Action: 'ecs:DescribeTasks'
            Condition:
              StringEquals:
                'ecs:cluster':
                  'Fn::GetAtt':
                    - withoutservicedeployerclusterC266C783
                    - Arn
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'arn:'
                  - Ref: 'AWS::Partition'
                  - ':ecs:'
                  - Ref: 'AWS::Region'
                  - ':'
                  - Ref: 'AWS::AccountId'
                  - ':task/'
                  - Ref: withoutservicedeployerclusterC266C783
                  - /*
            Sid: ECSDescribeTasks
          - Action: 'ecs:DescribeServices'
            Condition:
              StringEquals:
                'ecs:cluster':
                  'Fn::GetAtt':
                    - withoutservicedeployerclusterC266C783
                    - Arn
            Effect: Allow
            Resource:
              'Fn::Join':
                - ''
                - - 'arn:'
                  - Ref: 'AWS::Partition'
                  - ':ecs:'
                  - Ref: 'AWS::Region'
                  - ':'
                  - Ref: 'AWS::AccountId'
                  - ':service/'
                  - Ref: withoutservicedeployerclusterC266C783
                  - /*
            Sid: ECSDescribeServices
          - Action: 'cloudwatch:GetMetricData'
            Effect: Allow
            Resource: '*'
            Sid: CloudWatchReadActions
        Version: '2012-10-17'
      PolicyName: >-
        withoutservicedeployercloudwatchcustomwidgetexecutionroleDefaultPolicyB278087E
      Roles:
        - Ref: withoutservicedeployercloudwatchcustomwidgetexecutionrole63498CC5
  withoutservicedeployercloudwatchcustomwidgetlambda09DF3572:
    Type: 'AWS::Lambda::Function'
    Properties:
      Architectures:
        - arm64
      Code: Any<Object>
      Handler: index.handler
      MemorySize: 1024
      Role:
        'Fn::GetAtt':
          - withoutservicedeployercloudwatchcustomwidgetexecutionrole63498CC5
          - Arn
      Runtime: nodejs22.x
      Tags:
        - Key: Name
          Value: RestateBYOC/without-service-deployer/cloudwatch-custom-widget-lambda
      Timeout: 60
    DependsOn:
      - >-
        withoutservicedeployercloudwatchcustomwidgetexecutionroleDefaultPolicyB278087E
      - withoutservicedeployercloudwatchcustomwidgetexecutionrole63498CC5
  withoutservicedeployercloudwatchcustomwidgetlambdacloudwatchcustomwidgetlambdaallowdatasource0EE93412:
    Type: 'AWS::Lambda::Permission'
    Properties:
      Action: 'lambda:InvokeFunction'
      FunctionName:
        'Fn::GetAtt':
          - withoutservicedeployercloudwatchcustomwidgetlambda09DF3572
          - Arn
      Principal: lambda.datasource.cloudwatch.amazonaws.com
  withoutservicedeployermetrics12A2B44C:
    Type: 'AWS::CloudWatch::Dashboard'
    Properties:
      DashboardBody:
        'Fn::Join':
          - ''
          - - >-
              {"widgets":[{"type":"metric","width":12,"height":6,"x":0,"y":0,"properties":{"view":"timeSeries","title":"Stateless
              CPU","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"CPU","expression":"cpu /
              1024"}],[{"expression":"SELECT AVG(CpuUtilized) FROM
              SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOCwithoutservicedeployerstatelessdefinition466C1E01'
              GROUP BY
              TaskId","visible":false,"id":"cpu"}]],"annotations":{"horizontal":[{"value":16,"label":"Limit","yAxis":"left"}]},"yAxis":{"left":{"label":"vCPUs","showUnits":false}}}},{"type":"metric","width":12,"height":6,"x":12,"y":0,"properties":{"view":"timeSeries","title":"Stateless
              Memory","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Memory","expression":"memory /
              1024"}],[{"expression":"SELECT AVG(MemoryUtilized) FROM
              SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOCwithoutservicedeployerstatelessdefinition466C1E01'
              GROUP BY
              TaskId","visible":false,"id":"memory"}]],"annotations":{"horizontal":[{"value":32,"label":"Limit","yAxis":"left"}]},"yAxis":{"left":{"label":"GiB","showUnits":false}}}},{"type":"metric","width":12,"height":6,"x":0,"y":6,"properties":{"view":"timeSeries","title":"Stateless
              Network Tx","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Tx","expression":"SELECT
              AVG(NetworkTxBytes) FROM SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOCwithoutservicedeployerstatelessdefinition466C1E01'
              GROUP BY
              TaskId"}]],"yAxis":{"left":{"label":"Bytes/sec","showUnits":false}}}},{"type":"metric","width":12,"height":6,"x":12,"y":6,"properties":{"view":"timeSeries","title":"Stateless
              Network Rx","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Rx","expression":"SELECT
              AVG(NetworkRxBytes) FROM SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOCwithoutservicedeployerstatelessdefinition466C1E01'
              GROUP BY
              TaskId"}]],"yAxis":{"left":{"label":"Bytes/sec","showUnits":false}}}},{"type":"log","width":24,"height":6,"x":0,"y":12,"properties":{"view":"table","title":"Stateless
              Logs","region":"region","query":"SOURCE '
            - Ref: withoutservicedeployerstatelessdefinitionrestateLogGroupEC27F989
            - >-
              ' | fields @logStream, @timestamp, level, fields.message,
              target\\n          | sort @timestamp desc\\n          | limit
              500"}},{"type":"metric","width":12,"height":6,"x":0,"y":18,"properties":{"view":"timeSeries","title":"Stateful
              CPU","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"CPU","expression":"cpu /
              1024"}],[{"expression":"SELECT AVG(CpuUtilized) FROM
              SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOCwithoutservicedeployerstatefuldefinition55E65D66'
              GROUP BY
              TaskId","visible":false,"id":"cpu"}]],"annotations":{"horizontal":[{"value":16,"label":"Limit","yAxis":"left"}]},"yAxis":{"left":{"label":"vCPUs","showUnits":false}}}},{"type":"metric","width":12,"height":6,"x":12,"y":18,"properties":{"view":"timeSeries","title":"Stateful
              Memory","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Memory","expression":"memory /
              1024"}],[{"expression":"SELECT AVG(MemoryUtilized) FROM
              SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOCwithoutservicedeployerstatefuldefinition55E65D66'
              GROUP BY
              TaskId","visible":false,"id":"memory"}]],"annotations":{"horizontal":[{"value":32,"label":"Limit","yAxis":"left"}]},"yAxis":{"left":{"label":"GiB","showUnits":false}}}},{"type":"metric","width":12,"height":6,"x":0,"y":24,"properties":{"view":"timeSeries","title":"Stateful
              Network Tx","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Tx","expression":"SELECT
              AVG(NetworkTxBytes) FROM SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOCwithoutservicedeployerstatefuldefinition55E65D66'
              GROUP BY
              TaskId"}]],"yAxis":{"left":{"label":"Bytes/sec","showUnits":false}}}},{"type":"metric","width":12,"height":6,"x":12,"y":24,"properties":{"view":"timeSeries","title":"Stateful
              Network Rx","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Rx","expression":"SELECT
              AVG(NetworkRxBytes) FROM SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOCwithoutservicedeployerstatefuldefinition55E65D66'
              GROUP BY
              TaskId"}]],"yAxis":{"left":{"label":"Bytes/sec","showUnits":false}}}},{"type":"log","width":24,"height":6,"x":0,"y":30,"properties":{"view":"table","title":"Stateful
              Logs","region":"region","query":"SOURCE '
            - Ref: withoutservicedeployerstatefuldefinitionrestateLogGroupCE40C5FC
            - >-
              ' | fields @logStream, @timestamp, level, fields.message,
              target\\n          | sort @timestamp desc\\n          | limit
              500"}},{"type":"metric","width":8,"height":6,"x":0,"y":36,"properties":{"view":"timeSeries","title":"Ephemeral
              Volume Usage (Total size 200GiB)","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Usage","expression":"SELECT
              MAX(EphemeralStorageUtilized) FROM
              SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily) WHERE TaskDefinitionFamily =
              'RestateBYOCwithoutservicedeployerstatefuldefinition55E65D66'"}]],"annotations":{"horizontal":[{"value":200,"label":"Volume
              size","visible":false,"yAxis":"left"}]},"yAxis":{"left":{"label":"GiB","showUnits":false}},"liveData":false}},{"type":"metric","width":8,"height":6,"x":8,"y":36,"properties":{"view":"timeSeries","title":"Volume
              Write Throughput (Limited to 150 MiB/sec)","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Write","expression":"RATE(count) /
              1048576"}],[{"expression":"SELECT MAX(StorageWriteBytes) FROM
              SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOCwithoutservicedeployerstatefuldefinition55E65D66'
              GROUP BY
              TaskId","visible":false,"id":"count"}]],"annotations":{"horizontal":[{"value":150,"label":"Limit","visible":false,"yAxis":"left"}]},"yAxis":{"left":{"label":"MiB/sec","showUnits":false}}}},{"type":"metric","width":8,"height":6,"x":16,"y":36,"properties":{"view":"timeSeries","title":"Volume
              Read Throughput (Limited to 150 MiB/sec)","region":"
            - Ref: 'AWS::Region'
            - >-
              ","metrics":[[{"label":"Read","expression":"RATE(count) /
              1048576"}],[{"expression":"SELECT MAX(StorageReadBytes) FROM
              SCHEMA(\\"ECS/ContainerInsights\\",
              ClusterName,TaskDefinitionFamily,TaskId) WHERE
              TaskDefinitionFamily =
              'RestateBYOCwithoutservicedeployerstatefuldefinition55E65D66'
              GROUP BY
              TaskId","visible":false,"id":"count"}]],"annotations":{"horizontal":[{"value":150,"label":"Limit","visible":false,"yAxis":"left"}]},"yAxis":{"left":{"label":"MiB/sec","showUnits":false}}}},{"type":"log","width":24,"height":6,"x":0,"y":42,"properties":{"view":"table","title":"Controller
              Logs","region":"region","query":"SOURCE '
            - Ref: >-
                withoutservicedeployercontrollerdefinitioncontrollerLogGroupC38FCA92
            - >-
              ' | fields @logStream, @timestamp, level, fields.message,
              target\\n          | sort @timestamp desc\\n          | limit
              500"}}]}
      DashboardName: RestateBYOC_without-service-deployer_metrics
  withoutservicedeployercontrolpanelDE1386C7:
    Type: 'AWS::CloudWatch::Dashboard'
    Properties:
      DashboardBody:
        'Fn::Join':
          - ''
          - - >-
              {"widgets":[{"type":"custom","width":24,"height":26,"x":0,"y":0,"properties":{"endpoint":"
            - 'Fn::GetAtt':
                - withoutservicedeployercloudwatchcustomwidgetlambda09DF3572
                - Arn
            - '","params":{"command":"controlPanel","input":{"region":"'
            - Ref: 'AWS::Region'
            - >-
              ","summary":{"clusterName":"RestateBYOC/without-service-deployer","restateVersion":"1.3","stackVersion":"0.2.0","metricsDashboardName":"
            - Ref: withoutservicedeployermetrics12A2B44C
            - '"},"resources":{"ecsClusterArn":"'
            - 'Fn::GetAtt':
                - withoutservicedeployerclusterC266C783
                - Arn
            - '","statelessServiceArn":"'
            - Ref: withoutservicedeployerstatelessserviceService4B925097
            - '","controllerServiceArn":"'
            - Ref: withoutservicedeployercontrollerserviceService53E53874
            - '","restatectlLambdaArn":"'
            - 'Fn::GetAtt':
                - withoutservicedeployerrestatectllambda9B5C28C5
                - Arn
            - >-
              "},"connectivityAndSecurity":{"connectivity":{"loadBalancerArns":{"ingress":["
            - Ref: withoutservicedeployersharednlb054F9DEE
            - '"],"admin":["'
            - Ref: withoutservicedeployersharednlb054F9DEE
            - '"]},"addresses":{"ingress":"http://'
            - 'Fn::GetAtt':
                - withoutservicedeployersharednlb054F9DEE
                - DNSName
            - ':8080","admin":"http://'
            - 'Fn::GetAtt':
                - withoutservicedeployersharednlb054F9DEE
                - DNSName
            - ':9070","webUI":"http://'
            - 'Fn::GetAtt':
                - withoutservicedeployersharednlb054F9DEE
                - DNSName
            - ':9070/ui"}},"networking":{"vpc":"'
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcA2121C384D1B3CDE'
            - '","availabilityZones":["dummy1a","dummy1b","dummy1c"],"subnets":["'
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet1Subnet934893E8236E2271'
            - '","'
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet2Subnet7031C2BA60DCB1EE'
            - '","'
            - 'Fn::ImportValue': 'VPCStack:ExportsOutputRefvpcPrivateSubnet3Subnet985AC459F9514491'
            - '"]},"security":{"securityGroups":["'
            - 'Fn::GetAtt':
                - withoutservicedeployersecuritygroup68EF3063
                - GroupId
            - '"]}},"storage":{"s3":{"bucket":"'
            - Ref: withoutservicedeployerbucketB1987DAB
            - >-
              "}}}},"title":"","updateOn":{"refresh":true,"resize":true,"timeRange":true}}}]}
      DashboardName: RestateBYOC_without-service-deployer_control-panel
"
`;

exports[`BYOC Without service deployer 2`] = `"props.serviceDeployer.disabled must not be set to use deployService"`;

exports[`BYOC Without service deployer 3`] = `"props.serviceDeployer.disabled must not be set to use register"`;
